# Mediation Analysis 

```{r librariesBis,echo=FALSE,message=FALSE,error=FALSE,warning=FALSE}
# library(MASS)
# library(RColorBrewer)
# library(gplots)
# library(ggplot2)
# library(snowfall)
# library(cowplot)
# library(sandwich)
# library(ggpubr)
# library(dplyr)
# library(metafor)
# library(stats)
# library(tmvtnorm)
# library(AER)
# library(stargazer)
# library(plm)
# library(lfe)
# library(fixest)
# library(tidyr)
# library(purrr)
# library(stringr)
# library(did)
# library(DIDmultiplegt)
# library(didimputation)
# library(did2s)
# library(recipes)
# library(tidyverse)
# library(ggthemes)
# library(fastDummies)
```

When we have estimated the treatment effect of a program, we sometimes wonder by which channels the program impact has been obtained.
For example, has a Job Training Program been successful because it has increases the human capital of an agent, or simply by signalling to employers her motivation?
The question of separating between the various channels into which a program impact can be decomposed becomes especially important when a program has several components, and we wish to ascertain which one is the more important. 
Another reason why we might be interested in which channel precisely is responsible for the program impact is because which channel dominates might give us indications about which theoretical mechanism is at play.

In this chapter, I am going to first delineate the general framework for mediation analysis and the way mediation analysis can be undertaken in the ideal case of a Randomized Controlled Trial.
Then, I am going to present the fundamental problem of mediation analysis (which turns out to be one version of the confounders problem we know all too well) and the various techniques that have been developed in order to solve for it.

## Mediation analysis: a framework

Mediation analysis posits the existence of a mediator, $M_i$, which is driving part or the totality of the effect of the treatment on outcome $Y_i$. 
Let's start with a binary mediator, in order to keep things simple: $M_i\in\left\{0,1\right\}$.
We can thus define four potential outcomes $Y_i^{d,d'}$, $(d,d')\in\left\{0,1\right\}^2$.
We can also define two potential outcomes for the mediator: $M^d_i$, $d\in\left\{0,1\right\}$.

The switching equation can now be written as follows:

\begin{align*}
  Y_i & = 
    \begin{cases}
    Y_i^{1,1} & \text{if } D_i=1 \text{ and }M_i=1\\
    Y_i^{1,0} & \text{if } D_i=1 \text{ and }M_i=0\\
    Y_i^{0,1} & \text{if } D_i=0 \text{ and }M_i=1\\
    Y_i^{0,0} & \text{if } D_i=0 \text{ and }M_i=0
    \end{cases} \\
    & = Y_i^{1,1}D_iM_i + Y_i^{0,1}(1-D_i)M_i  + Y_i^{1,0}D_i(1-M_i)+ Y_i^{0,0}(1-D_i)(1-M_i).
\end{align*}

We are now equipped to define two sets of causal mediation effects: the indirect (or mediated) effect and the direct (or unmediated) effect (we follow [Imai, Keene and Tingley (2010)](https://doi.org/10.1037/a0020761)):

\begin{align*}
  \Delta^{Y_{m(d)}}_{i} & = Y_i^{d,M_i^1}-Y_i^{d,M_i^0}\\
  \Delta^{Y_{u(d)}}_{i} & = Y_i^{1,M_i^d}-Y_i^{0,M_i^d}.
\end{align*}

$\Delta^{Y_{m(d)}}_{i}$ is the causal effect of the treatment on the outcome acting through the mediator only, while keeping the value of the treatment status fixed at $d$.
$\Delta^{Y_{u(m)}}_{i}$ is the causal effect of the treatment on the outcome acting through the treatment only, while keeping the value of the mediator fixed at $M_i(d)$.
In the absence of interaction effects between the treatment and the mediator, we have $\Delta^{Y_{m(0)}}_{i}=\Delta^{Y_{m(1)}}_{i}=\Delta^{Y_{m}}_{i}$ and $\Delta^{Y_{u(0)}}_{i}=\Delta^{Y_{u(1)}}_{i}=\Delta^{Y_{u}}_{i}$.

The individual effect of the treatment can be decomposed in two components:

\begin{align*}
  \Delta^Y_{i} & = Y_i^{1,M_i^1}-Y_i^{0,M_i^0}\\
                 & = Y_i^{1,M_i^1}-Y_i^{1,M_i^0}+Y_i^{1,M_i^0}-Y_i^{0,M_i^0}=\Delta^{Y_{m(1)}}_{i}+\Delta^{Y_{u(0)}}_{i}\\
                 & = Y_i^{1,M_i^1}-Y_i^{0,M_i^1}+Y_i^{0,M_i^1}-Y_i^{0,M_i^0}=\Delta^{Y_{u(1)}}_{i}+\Delta^{Y_{m(0)}}_{i}.
\end{align*}

In the absence of interaction effects between the mediator and the treatment, this decomposition is unique.
The decomposition can also be applied to the TT parameter:

\begin{align*}
  \Delta^Y_{TT} & = \esp{Y_i^{1,M_i^1}-Y_i^{0,M_i^0}|D_i=1}\\
             & = \Delta^{Y_{m(1)}}_{TT}+\Delta^{Y_{u(0)}}_{TT}\\
            & = \Delta^{Y_{u(1)}}_{TT}+\Delta^{Y_{m(0)}}_{TT},
\end{align*}

with:

\begin{align*}
  \Delta^{Y_{m(d)}}_{TT} & = \esp{\Delta^{Y_{m(d)}}_{i}|D_i=1}\\
  \Delta^{Y_{u(d)}}_{TT} & = \esp{\Delta^{Y_{u(d)}}_{i}|D_i=1}.
\end{align*}

Here again, the decomposition will be unique if there are no interactions between the treatment and the mediator variable. 

```{example}
Let's see how this works in our example.
```

The first order of business is to set up a model:

\begin{align*}
    y_i^{1,1} & = y_i^0+\bar{\alpha}+ \tau_1 +\theta\mu_i+\eta_i \\
    y_i^{1,0} & = y_i^0+\bar{\alpha}+\theta\mu_i+\eta_i \\
    y_i^{0,1} & = \mu_i+\delta + \tau_0+U_i^0 \\
    y_i^{0,0} & = \mu_i+\delta+U_i^0 \\
    U_i^0 & = \rho U_i^B+\epsilon_i \\
    y_i^B & =\mu_i+U_i^B \\
    U_i^B & \sim\mathcal{N}(0,\sigma^2_{U}) \\
    M_i   & = \uns{\xi y_i^B + \psi D_i+ V^M_i\leq\bar{y}_M} \\
    V^M_i & = \gamma_M(\mu_i-\bar{\mu}) + \omega^M_i \\
    D_i   & = \uns{y_i^B+ V_i\leq\bar{y}} \\
    V_i   & = \gamma(\mu_i-\bar{\mu}) + \omega_i \\
    (\eta_i,\omega_i,\omega^M_i) & \sim\mathcal{N}(0,0,0,\sigma^2_{\eta},\sigma^2_{\omega},\sigma^2_{\omega_M},\rho_{\eta,\omega},\rho_{\eta,\omega_M},\rho_{\omega,\omega_M}) 
\end{align*}

Let us choose some parameter values and simulate the model.

```{r param.Mediation,eval=TRUE,echo=TRUE,results='hide'}
param <- c(8,.5,.28,1500,1500,0.9,0.01,0.05,0.05,0.05,0.1,0.2,0.1,1,-0.25,0.1,0.05,7.98,0.28,1,0,0,0)
names(param) <- c("barmu","sigma2mu","sigma2U","barY","barYM","rho","theta","sigma2epsilon","sigma2eta","delta","baralpha","tau1","tau0","xi","psi","gamma","gammaM","baryB","sigma2omega","sigma2omegaM","rhoetaomega","rhoetaomegaM","rhoomegaomegaM")
```

Let us now simulate the data:

```{r simul.Mediation,eval=TRUE,echo=TRUE,results='hide'}
set.seed(1234)
N <-1000
cov.eta.omega.omegaM <- matrix(c(param["sigma2eta"],param["rhoetaomega"]*sqrt(param["sigma2eta"]*param["sigma2omega"]),param["rhoetaomegaM"]*sqrt(param["sigma2eta"]*param["sigma2omegaM"]),
                                 param["rhoetaomega"]*sqrt(param["sigma2eta"]*param["sigma2omega"]),param["sigma2omega"],param["rhoomegaomegaM"]*sqrt(param["sigma2omega"]*param["sigma2omegaM"]),
                                 param["rhoetaomegaM"]*sqrt(param["sigma2eta"]*param["sigma2omegaM"]),param["rhoomegaomegaM"]*sqrt(param["sigma2omega"]*param["sigma2omegaM"]),param["sigma2omegaM"]),ncol=3,nrow=3)
eta.omega <- as.data.frame(mvrnorm(N,c(0,0,0),cov.eta.omega.omegaM))
colnames(eta.omega) <- c('eta','omega','omegaM')
mu <- rnorm(N,param["barmu"],sqrt(param["sigma2mu"]))
UB <- rnorm(N,0,sqrt(param["sigma2U"]))
yB <- mu + UB 
YB <- exp(yB)
Ds <- rep(0,N)
V <- param["gamma"]*(mu-param["barmu"])+eta.omega$omega
Ds[yB+V<=log(param["barY"])] <- 1 
VM <- param["gammaM"]*(mu-param["barmu"])+eta.omega$omegaM
M <- rep(0,N)
M[param['xi']*yB+param['psi']*Ds+VM<=log(param["barYM"])] <- 1 
M1 <- rep(0,N)
M1[param['xi']*yB+param['psi']+VM<=log(param["barYM"])] <- 1 
M0 <- rep(0,N)
M0[param['xi']*yB+VM<=log(param["barYM"])] <- 1 
epsilon <- rnorm(N,0,sqrt(param["sigma2epsilon"]))
U0 <- param["rho"]*UB + epsilon
alpha <- param["baralpha"]+  param["theta"]*mu + eta.omega$eta
y00 <- mu +  U0 + param["delta"]
y01 <- mu +  U0 + param['tau0']+ param["delta"]
y10 <- y00+alpha
y11 <- y00+alpha+param['tau1']
y1 <- y11*M+y10*(1-M)
y0 <- y01*M+y00*(1-M)
y1M1 <- y00+alpha+param['tau1']*M1
y1M0 <- y00+alpha+param['tau1']*M0
y0M1 <- y00 + param['tau0']*M1
y0M0 <- y00 + param['tau0']*M0
y <- y11*Ds*M+y10*Ds*(1-M)+y01*(1-Ds)*M+y00*(1-Ds)*(1-M)
```

Let us finally compute the values of TT and of the mediated and unmediated average treatment effects on the treated in the sample.

```{r simul.Mediation.TT,eval=TRUE,echo=TRUE,results='hide'}
# treatment on the treated
TT <- mean(y1[Ds==1]-y0[Ds==1])
# mediated treatment effects
TTm1 <- mean(y1M1[Ds==1]-y1M0[Ds==1])
TTm0 <- mean(y0M1[Ds==1]-y0M0[Ds==1])
# unmediated treatment effects
TTu1 <- mean(y1M1[Ds==1]-y0M1[Ds==1])
TTu0 <- mean(y1M0[Ds==1]-y0M0[Ds==1])
```

Pb here with mediation.

## The Fundamental Problem of Mediation Analysis

## Mediation analysis under unconfoundedness

## Mediation analysis with panel data

## Mediation analysis with instruments
