<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 16 Stratification | Statistical Tools for Causal Inference</title>
  <meta name="description" content="This is an open source collaborative book." />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 16 Stratification | Statistical Tools for Causal Inference" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is an open source collaborative book." />
  <meta name="github-repo" content="chabefer/STCI" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 16 Stratification | Statistical Tools for Causal Inference" />
  
  <meta name="twitter:description" content="This is an open source collaborative book." />
  

<meta name="author" content="Sylvain Chabé-Ferret" />


<meta name="date" content="2024-03-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="mediation-analysis.html"/>
<link rel="next" href="proofs.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
$$
\newcommand{\uns}[1]{\mathbf{1}[#1]}
\newcommand{\esp}[1]{\mathbf{E}[#1]}
\newcommand{\hatesp}[1]{\hat{\mathbf{E}}[ #1 ]}
\newcommand{\espE}{\mathbf{E}}
\newcommand{\Ind}{\perp\kern-5pt\perp}
\newcommand{\var}[1]{\mathbf{V}[ #1 ]}
\newcommand{\hatvar}[1]{\hat{\mathbf{V}}[ #1 ]}
\newcommand{\cov}[1]{\mathbf{C}[ #1 ]}
\newcommand{\plim}[1]{\text{plim}_{ #1 \rightarrow \infty}}
\newcommand{\plims}{\text{plim}}
\newcommand{\distr}{\stackrel{d}{\rightarrow}}
\newcommand{\partder}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\partdersq}[2]{\frac{\partial^2 #1}{\partial #2^2}}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\asym}{Asym}
$$


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Statistical Tools for Causal Inference</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>I Fundamental Problems of Inference</b></span></li>
<li class="chapter" data-level="" data-path="introduction-the-two-fundamental-problems-of-inference.html"><a href="introduction-the-two-fundamental-problems-of-inference.html"><i class="fa fa-check"></i>Introduction: the Two Fundamental Problems of Inference</a></li>
<li class="chapter" data-level="1" data-path="FPCI.html"><a href="FPCI.html"><i class="fa fa-check"></i><b>1</b> Fundamental Problem of Causal Inference</a>
<ul>
<li class="chapter" data-level="1.1" data-path="FPCI.html"><a href="FPCI.html#rubin-causal-model"><i class="fa fa-check"></i><b>1.1</b> Rubin Causal Model</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="FPCI.html"><a href="FPCI.html#treatment-allocation-rule"><i class="fa fa-check"></i><b>1.1.1</b> Treatment allocation rule</a></li>
<li class="chapter" data-level="1.1.2" data-path="FPCI.html"><a href="FPCI.html#potential-outcomes"><i class="fa fa-check"></i><b>1.1.2</b> Potential outcomes</a></li>
<li class="chapter" data-level="1.1.3" data-path="FPCI.html"><a href="FPCI.html#switching-equation"><i class="fa fa-check"></i><b>1.1.3</b> Switching equation</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="FPCI.html"><a href="FPCI.html#treatment-effects"><i class="fa fa-check"></i><b>1.2</b> Treatment effects</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="FPCI.html"><a href="FPCI.html#individual-level-treatment-effects"><i class="fa fa-check"></i><b>1.2.1</b> Individual level treatment effects</a></li>
<li class="chapter" data-level="1.2.2" data-path="FPCI.html"><a href="FPCI.html#average-treatment-effect-on-the-treated"><i class="fa fa-check"></i><b>1.2.2</b> Average treatment effect on the treated</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="FPCI.html"><a href="FPCI.html#fundamental-problem-of-causal-inference"><i class="fa fa-check"></i><b>1.3</b> Fundamental problem of causal inference</a></li>
<li class="chapter" data-level="1.4" data-path="FPCI.html"><a href="FPCI.html#intuitive-estimators-confounding-factors-and-selection-bias"><i class="fa fa-check"></i><b>1.4</b> Intuitive estimators, confounding factors and selection bias</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="FPCI.html"><a href="FPCI.html#withwithout-comparison-selection-bias-and-cross-sectional-confounders"><i class="fa fa-check"></i><b>1.4.1</b> With/Without comparison, selection bias and cross-sectional confounders</a></li>
<li class="chapter" data-level="1.4.2" data-path="FPCI.html"><a href="FPCI.html#the-beforeafter-comparison-temporal-confounders-and-time-trend-bias"><i class="fa fa-check"></i><b>1.4.2</b> The before/after comparison, temporal confounders and time trend bias</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="FPSI.html"><a href="FPSI.html"><i class="fa fa-check"></i><b>2</b> Fundamental Problem of Statistical Inference</a>
<ul>
<li class="chapter" data-level="2.1" data-path="FPSI.html"><a href="FPSI.html#sec:sampnoise"><i class="fa fa-check"></i><b>2.1</b> What is sampling noise? Definition and illustration</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="FPSI.html"><a href="FPSI.html#sec:definitionnoise"><i class="fa fa-check"></i><b>2.1.1</b> Sampling noise, a definition</a></li>
<li class="chapter" data-level="2.1.2" data-path="FPSI.html"><a href="FPSI.html#sec:illusnoisepop"><i class="fa fa-check"></i><b>2.1.2</b> Sampling noise for the population treatment effect</a></li>
<li class="chapter" data-level="2.1.3" data-path="FPSI.html"><a href="FPSI.html#sec:illusnoisesamp"><i class="fa fa-check"></i><b>2.1.3</b> Sampling noise for the sample treatment effect</a></li>
<li class="chapter" data-level="2.1.4" data-path="FPSI.html"><a href="FPSI.html#sec:confinterv"><i class="fa fa-check"></i><b>2.1.4</b> Building confidence intervals from estimates of sampling noise</a></li>
<li class="chapter" data-level="2.1.5" data-path="FPSI.html"><a href="FPSI.html#reporting-sampling-noise-a-proposal"><i class="fa fa-check"></i><b>2.1.5</b> Reporting sampling noise: a proposal</a></li>
<li class="chapter" data-level="2.1.6" data-path="FPSI.html"><a href="FPSI.html#sec:effectsize"><i class="fa fa-check"></i><b>2.1.6</b> Using effect sizes to normalize the reporting of treatment effects and their precision</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="FPSI.html"><a href="FPSI.html#sec:estimsampnoise"><i class="fa fa-check"></i><b>2.2</b> Estimating sampling noise</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="FPSI.html"><a href="FPSI.html#sec:assumptions"><i class="fa fa-check"></i><b>2.2.1</b> Assumptions</a></li>
<li class="chapter" data-level="2.2.2" data-path="FPSI.html"><a href="FPSI.html#sec:cheb"><i class="fa fa-check"></i><b>2.2.2</b> Using Chebyshev’s inequality</a></li>
<li class="chapter" data-level="2.2.3" data-path="FPSI.html"><a href="FPSI.html#sec:CLT"><i class="fa fa-check"></i><b>2.2.3</b> Using the Central Limit Theorem</a></li>
<li class="chapter" data-level="2.2.4" data-path="FPSI.html"><a href="FPSI.html#sec:resamp"><i class="fa fa-check"></i><b>2.2.4</b> Using resampling methods</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Methods of Causal Inference</b></span></li>
<li class="chapter" data-level="3" data-path="RCT.html"><a href="RCT.html"><i class="fa fa-check"></i><b>3</b> Randomized Controlled Trials</a>
<ul>
<li class="chapter" data-level="3.1" data-path="RCT.html"><a href="RCT.html#sec:design1"><i class="fa fa-check"></i><b>3.1</b> Brute Force Design</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="RCT.html"><a href="RCT.html#identification"><i class="fa fa-check"></i><b>3.1.1</b> Identification</a></li>
<li class="chapter" data-level="3.1.2" data-path="RCT.html"><a href="RCT.html#estimating-ate"><i class="fa fa-check"></i><b>3.1.2</b> Estimating ATE</a></li>
<li class="chapter" data-level="3.1.3" data-path="RCT.html"><a href="RCT.html#estimating-sampling-noise"><i class="fa fa-check"></i><b>3.1.3</b> Estimating Sampling Noise</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="RCT.html"><a href="RCT.html#sec:design2"><i class="fa fa-check"></i><b>3.2</b> Self-Selection design</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="RCT.html"><a href="RCT.html#identification-1"><i class="fa fa-check"></i><b>3.2.1</b> Identification</a></li>
<li class="chapter" data-level="3.2.2" data-path="RCT.html"><a href="RCT.html#estimating-tt"><i class="fa fa-check"></i><b>3.2.2</b> Estimating TT</a></li>
<li class="chapter" data-level="3.2.3" data-path="RCT.html"><a href="RCT.html#estimating-sampling-noise-1"><i class="fa fa-check"></i><b>3.2.3</b> Estimating Sampling Noise</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="RCT.html"><a href="RCT.html#sec:design3"><i class="fa fa-check"></i><b>3.3</b> Eligibility design</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="RCT.html"><a href="RCT.html#identification-2"><i class="fa fa-check"></i><b>3.3.1</b> Identification</a></li>
<li class="chapter" data-level="3.3.2" data-path="RCT.html"><a href="RCT.html#estimating-the-ite-and-the-tt"><i class="fa fa-check"></i><b>3.3.2</b> Estimating the ITE and the TT</a></li>
<li class="chapter" data-level="3.3.3" data-path="RCT.html"><a href="RCT.html#estimating-sampling-noise-2"><i class="fa fa-check"></i><b>3.3.3</b> Estimating sampling noise</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="RCT.html"><a href="RCT.html#sec:design4"><i class="fa fa-check"></i><b>3.4</b> Encouragement Design</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="RCT.html"><a href="RCT.html#identification-3"><i class="fa fa-check"></i><b>3.4.1</b> Identification</a></li>
<li class="chapter" data-level="3.4.2" data-path="RCT.html"><a href="RCT.html#IVRCT"><i class="fa fa-check"></i><b>3.4.2</b> Estimating the Local Average Treatment Effect and the Intention to Treat Effect</a></li>
<li class="chapter" data-level="3.4.3" data-path="RCT.html"><a href="RCT.html#estimating-sampling-noise-3"><i class="fa fa-check"></i><b>3.4.3</b> Estimating sampling noise</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="NE.html"><a href="NE.html"><i class="fa fa-check"></i><b>4</b> Natural Experiments</a>
<ul>
<li class="chapter" data-level="4.1" data-path="NE.html"><a href="NE.html#instrumental-variables"><i class="fa fa-check"></i><b>4.1</b> Instrumental Variables</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="NE.html"><a href="NE.html#an-example-where-monotonicity-does-not-hold"><i class="fa fa-check"></i><b>4.1.1</b> An example where Monotonicity does not hold</a></li>
<li class="chapter" data-level="4.1.2" data-path="NE.html"><a href="NE.html#identification-4"><i class="fa fa-check"></i><b>4.1.2</b> Identification</a></li>
<li class="chapter" data-level="4.1.3" data-path="NE.html"><a href="NE.html#estimation"><i class="fa fa-check"></i><b>4.1.3</b> Estimation</a></li>
<li class="chapter" data-level="4.1.4" data-path="NE.html"><a href="NE.html#estimation-of-sampling-noise"><i class="fa fa-check"></i><b>4.1.4</b> Estimation of sampling noise</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="NE.html"><a href="NE.html#regression-discontinuity-designs"><i class="fa fa-check"></i><b>4.2</b> Regression Discontinuity Designs</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="NE.html"><a href="NE.html#sharp-regression-discontinuity-designs"><i class="fa fa-check"></i><b>4.2.1</b> Sharp Regression Discontinuity Designs</a></li>
<li class="chapter" data-level="4.2.2" data-path="NE.html"><a href="NE.html#fuzzy-regression-discontinuity-designs"><i class="fa fa-check"></i><b>4.2.2</b> Fuzzy Regression Discontinuity Designs</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="NE.html"><a href="NE.html#DID"><i class="fa fa-check"></i><b>4.3</b> Difference In Differences</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="NE.html"><a href="NE.html#sec:DIDbasic"><i class="fa fa-check"></i><b>4.3.1</b> Difference In Differences with two time periods</a></li>
<li class="chapter" data-level="4.3.2" data-path="NE.html"><a href="NE.html#sec:DIDr"><i class="fa fa-check"></i><b>4.3.2</b> Reverse Difference In Differences designs with two time periods</a></li>
<li class="chapter" data-level="4.3.3" data-path="NE.html"><a href="NE.html#DIDStaggered"><i class="fa fa-check"></i><b>4.3.3</b> Difference In Differences with multiple time periods</a></li>
<li class="chapter" data-level="4.3.4" data-path="NE.html"><a href="NE.html#difference-in-differences-with-instrumental-variables"><i class="fa fa-check"></i><b>4.3.4</b> Difference In Differences with Instrumental Variables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="OM.html"><a href="OM.html"><i class="fa fa-check"></i><b>5</b> Observational Methods</a>
<ul>
<li class="chapter" data-level="5.1" data-path="OM.html"><a href="OM.html#parametric-methods"><i class="fa fa-check"></i><b>5.1</b> Parametric methods</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="OM.html"><a href="OM.html#assuming-espy_i0x_i-is-known"><i class="fa fa-check"></i><b>5.1.1</b> Assuming <span class="math inline">\(\esp{Y_i^0|X_i}\)</span> is known</a></li>
<li class="chapter" data-level="5.1.2" data-path="OM.html"><a href="OM.html#assuming-espy_i1x_i-is-known"><i class="fa fa-check"></i><b>5.1.2</b> Assuming <span class="math inline">\(\esp{Y_i^1|X_i}\)</span> is known</a></li>
<li class="chapter" data-level="5.1.3" data-path="OM.html"><a href="OM.html#BiasOLS"><i class="fa fa-check"></i><b>5.1.3</b> Properties of the OLS estimator under Conditional Independence</a></li>
<li class="chapter" data-level="5.1.4" data-path="OM.html"><a href="OM.html#problems-with-parametric-methods"><i class="fa fa-check"></i><b>5.1.4</b> Problems with parametric methods</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="OM.html"><a href="OM.html#nonparametric-methods"><i class="fa fa-check"></i><b>5.2</b> Nonparametric methods</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="OM.html"><a href="OM.html#identification-12"><i class="fa fa-check"></i><b>5.2.1</b> Identification</a></li>
<li class="chapter" data-level="5.2.2" data-path="OM.html"><a href="OM.html#estimation-8"><i class="fa fa-check"></i><b>5.2.2</b> Estimation</a></li>
<li class="chapter" data-level="5.2.3" data-path="OM.html"><a href="OM.html#estimating-precision-2"><i class="fa fa-check"></i><b>5.2.3</b> Estimating precision</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="OM.html"><a href="OM.html#imputation-methods"><i class="fa fa-check"></i><b>5.3</b> Imputation methods</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="threats.html"><a href="threats.html"><i class="fa fa-check"></i><b>6</b> Threats to the validity of Causal Inference</a>
<ul>
<li class="chapter" data-level="6.1" data-path="threats.html"><a href="threats.html#threats-to-internal-validity"><i class="fa fa-check"></i><b>6.1</b> Threats to internal validity</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="threats.html"><a href="threats.html#survey-bias"><i class="fa fa-check"></i><b>6.1.1</b> Survey bias</a></li>
<li class="chapter" data-level="6.1.2" data-path="threats.html"><a href="threats.html#experimenter-bias"><i class="fa fa-check"></i><b>6.1.2</b> Experimenter bias</a></li>
<li class="chapter" data-level="6.1.3" data-path="threats.html"><a href="threats.html#substitution-bias"><i class="fa fa-check"></i><b>6.1.3</b> Substitution bias</a></li>
<li class="chapter" data-level="6.1.4" data-path="threats.html"><a href="threats.html#diffusion-bias"><i class="fa fa-check"></i><b>6.1.4</b> Diffusion bias</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="threats.html"><a href="threats.html#threats-to-the-measurement-of-precision"><i class="fa fa-check"></i><b>6.2</b> Threats to the measurement of precision</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="threats.html"><a href="threats.html#insufficient-precision"><i class="fa fa-check"></i><b>6.2.1</b> Insufficient precision</a></li>
<li class="chapter" data-level="6.2.2" data-path="threats.html"><a href="threats.html#clustering"><i class="fa fa-check"></i><b>6.2.2</b> Clustering</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="threats.html"><a href="threats.html#threats-to-external-validity"><i class="fa fa-check"></i><b>6.3</b> Threats to external validity</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="threats.html"><a href="threats.html#randomization-bias"><i class="fa fa-check"></i><b>6.3.1</b> Randomization bias</a></li>
<li class="chapter" data-level="6.3.2" data-path="threats.html"><a href="threats.html#equilibrium-effects"><i class="fa fa-check"></i><b>6.3.2</b> Equilibrium effects</a></li>
<li class="chapter" data-level="6.3.3" data-path="threats.html"><a href="threats.html#context-effects"><i class="fa fa-check"></i><b>6.3.3</b> Context effects</a></li>
<li class="chapter" data-level="6.3.4" data-path="threats.html"><a href="threats.html#site-selection-bias"><i class="fa fa-check"></i><b>6.3.4</b> Site selection bias</a></li>
<li class="chapter" data-level="6.3.5" data-path="threats.html"><a href="threats.html#publication-bias"><i class="fa fa-check"></i><b>6.3.5</b> Publication bias</a></li>
<li class="chapter" data-level="6.3.6" data-path="threats.html"><a href="threats.html#ethical-and-political-issues"><i class="fa fa-check"></i><b>6.3.6</b> Ethical and political issues</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Additional Topics</b></span></li>
<li class="chapter" data-level="7" data-path="Power.html"><a href="Power.html"><i class="fa fa-check"></i><b>7</b> Power Analysis</a>
<ul>
<li class="chapter" data-level="7.1" data-path="Power.html"><a href="Power.html#basics-of-traditional-power-analysis-using-test-statistics"><i class="fa fa-check"></i><b>7.1</b> Basics of traditional power analysis using test statistics</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="Power.html"><a href="Power.html#power"><i class="fa fa-check"></i><b>7.1.1</b> Power</a></li>
<li class="chapter" data-level="7.1.2" data-path="Power.html"><a href="Power.html#minimum-detectable-effect"><i class="fa fa-check"></i><b>7.1.2</b> Minimum Detectable Effect</a></li>
<li class="chapter" data-level="7.1.3" data-path="Power.html"><a href="Power.html#minimum-required-sample-size"><i class="fa fa-check"></i><b>7.1.3</b> Minimum Required Sample Size</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="Power.html"><a href="Power.html#traditional-power-analysis-in-practice"><i class="fa fa-check"></i><b>7.2</b> Traditional power analysis in practice</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="Power.html"><a href="Power.html#power-analysis-for-randomized-controlled-trials"><i class="fa fa-check"></i><b>7.2.1</b> Power Analysis for Randomized Controlled Trials</a></li>
<li class="chapter" data-level="7.2.2" data-path="Power.html"><a href="Power.html#power-analysis-for-natural-experiments"><i class="fa fa-check"></i><b>7.2.2</b> Power Analysis for Natural Experiments</a></li>
<li class="chapter" data-level="7.2.3" data-path="Power.html"><a href="Power.html#power-analysis-for-observational-methods"><i class="fa fa-check"></i><b>7.2.3</b> Power Analysis for Observational Methods</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="Power.html"><a href="Power.html#limitations-of-and-alternatives-to-traditional-power-analysis"><i class="fa fa-check"></i><b>7.3</b> Limitations of and alternatives to traditional power analysis</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="Power.html"><a href="Power.html#limitations-of-traditional-power-analysis"><i class="fa fa-check"></i><b>7.3.1</b> Limitations of traditional power analysis</a></li>
<li class="chapter" data-level="7.3.2" data-path="Power.html"><a href="Power.html#an-alternative-to-traditional-power-analysis"><i class="fa fa-check"></i><b>7.3.2</b> An alternative to traditional power analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="placebo.html"><a href="placebo.html"><i class="fa fa-check"></i><b>8</b> Placebo Tests</a>
<ul>
<li class="chapter" data-level="8.1" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-randomized-controlled-trials"><i class="fa fa-check"></i><b>8.1</b> Placebo tests for randomized controlled trials</a></li>
<li class="chapter" data-level="8.2" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-natural-experiments"><i class="fa fa-check"></i><b>8.2</b> Placebo tests for natural experiments</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-instrumental-variables"><i class="fa fa-check"></i><b>8.2.1</b> Placebo tests for Instrumental Variables</a></li>
<li class="chapter" data-level="8.2.2" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-regression-discontinuity-designs"><i class="fa fa-check"></i><b>8.2.2</b> Placebo tests for Regression Discontinuity Designs</a></li>
<li class="chapter" data-level="8.2.3" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-difference-in-differences"><i class="fa fa-check"></i><b>8.2.3</b> Placebo tests for Difference in Differences</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-observational-methods"><i class="fa fa-check"></i><b>8.3</b> Placebo tests for observational methods</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="cluster.html"><a href="cluster.html"><i class="fa fa-check"></i><b>9</b> Clustering</a>
<ul>
<li class="chapter" data-level="9.1" data-path="cluster.html"><a href="cluster.html#ClusterRCT"><i class="fa fa-check"></i><b>9.1</b> Clustering in Randomized Controlled Trials</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="cluster.html"><a href="cluster.html#an-example"><i class="fa fa-check"></i><b>9.1.1</b> An example</a></li>
<li class="chapter" data-level="9.1.2" data-path="cluster.html"><a href="cluster.html#design-effect"><i class="fa fa-check"></i><b>9.1.2</b> Design effect</a></li>
<li class="chapter" data-level="9.1.3" data-path="cluster.html"><a href="cluster.html#estimating-sampling-noise-accounting-for-clustering"><i class="fa fa-check"></i><b>9.1.3</b> Estimating sampling noise accounting for clustering</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="cluster.html"><a href="cluster.html#clustering-in-panel-data"><i class="fa fa-check"></i><b>9.2</b> Clustering in panel data</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="cluster.html"><a href="cluster.html#an-example-1"><i class="fa fa-check"></i><b>9.2.1</b> An example</a></li>
<li class="chapter" data-level="9.2.2" data-path="cluster.html"><a href="cluster.html#design-effect-in-panel-data"><i class="fa fa-check"></i><b>9.2.2</b> Design effect in panel data</a></li>
<li class="chapter" data-level="9.2.3" data-path="cluster.html"><a href="cluster.html#estimating-sampling-noise-in-panel-data-with-autocorrelated-error-terms"><i class="fa fa-check"></i><b>9.2.3</b> Estimating sampling noise in panel data with autocorrelated error terms</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="cluster.html"><a href="cluster.html#spatial-correlation"><i class="fa fa-check"></i><b>9.3</b> Spatial correlation</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="cluster.html"><a href="cluster.html#an-example-2"><i class="fa fa-check"></i><b>9.3.1</b> An example</a></li>
<li class="chapter" data-level="9.3.2" data-path="cluster.html"><a href="cluster.html#design-effect-in-spatially-autocorrelated-data"><i class="fa fa-check"></i><b>9.3.2</b> Design effect in spatially autocorrelated data</a></li>
<li class="chapter" data-level="9.3.3" data-path="cluster.html"><a href="cluster.html#estimating-sampling-noise-with-spatially-autocorrelated-data"><i class="fa fa-check"></i><b>9.3.3</b> Estimating sampling noise with spatially autocorrelated data</a></li>
<li class="chapter" data-level="9.3.4" data-path="cluster.html"><a href="cluster.html#testing-for-spatial-autocorrelation"><i class="fa fa-check"></i><b>9.3.4</b> Testing for spatial autocorrelation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="cluster.html"><a href="cluster.html#clustering-on-a-network"><i class="fa fa-check"></i><b>9.4</b> Clustering on a network</a></li>
<li class="chapter" data-level="9.5" data-path="cluster.html"><a href="cluster.html#multi-way-clustering"><i class="fa fa-check"></i><b>9.5</b> Multi-way clustering</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="cluster.html"><a href="cluster.html#at-which-level-should-we-cluster"><i class="fa fa-check"></i><b>9.5.1</b> At which level should we cluster?</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="cluster.html"><a href="cluster.html#what-to-do-when-there-are-few-clusters"><i class="fa fa-check"></i><b>9.6</b> What to do when there are few clusters?</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="cluster.html"><a href="cluster.html#aggregation"><i class="fa fa-check"></i><b>9.6.1</b> Aggregation</a></li>
<li class="chapter" data-level="9.6.2" data-path="cluster.html"><a href="cluster.html#permutation-tests"><i class="fa fa-check"></i><b>9.6.2</b> Permutation tests</a></li>
<li class="chapter" data-level="9.6.3" data-path="cluster.html"><a href="cluster.html#wild-bootstrap"><i class="fa fa-check"></i><b>9.6.3</b> Wild bootstrap</a></li>
<li class="chapter" data-level="9.6.4" data-path="cluster.html"><a href="cluster.html#ibragimov-and-muller-2010-group-based-inference"><i class="fa fa-check"></i><b>9.6.4</b> Ibragimov and Muller (2010) group-based inference</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="cluster.html"><a href="cluster.html#CLTDD"><i class="fa fa-check"></i><b>9.7</b> Central Limit Theorems for Dependent Data</a></li>
<li class="chapter" data-level="9.8" data-path="cluster.html"><a href="cluster.html#DesignBasedClusters"><i class="fa fa-check"></i><b>9.8</b> Sampling-based and design-based approaches to clustering</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="LaLonde.html"><a href="LaLonde.html"><i class="fa fa-check"></i><b>10</b> LaLonde Tests</a></li>
<li class="chapter" data-level="11" data-path="Diffusion.html"><a href="Diffusion.html"><i class="fa fa-check"></i><b>11</b> Diffusion effects</a>
<ul>
<li class="chapter" data-level="11.1" data-path="Diffusion.html"><a href="Diffusion.html#allowing-for-diffusion-effects-in-rubin-causal-model"><i class="fa fa-check"></i><b>11.1</b> Allowing for diffusion effects in Rubin Causal Model</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="Diffusion.html"><a href="Diffusion.html#potential-outcomes-and-treatment-effects-with-diffusion-effects"><i class="fa fa-check"></i><b>11.1.1</b> Potential outcomes and treatment effects with diffusion effects</a></li>
<li class="chapter" data-level="11.1.2" data-path="Diffusion.html"><a href="Diffusion.html#encoding-the-absence-of-diffusion-effects"><i class="fa fa-check"></i><b>11.1.2</b> Encoding the absence of diffusion effects</a></li>
<li class="chapter" data-level="11.1.3" data-path="Diffusion.html"><a href="Diffusion.html#treatment-exposure"><i class="fa fa-check"></i><b>11.1.3</b> Treatment exposure</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="Diffusion.html"><a href="Diffusion.html#diffusion-effects-with-coarse-networks"><i class="fa fa-check"></i><b>11.2</b> Diffusion effects with coarse networks</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="Diffusion.html"><a href="Diffusion.html#optimal-treatment-allocation-under-monotone-response"><i class="fa fa-check"></i><b>11.2.1</b> Optimal treatment allocation under monotone response</a></li>
<li class="chapter" data-level="11.2.2" data-path="Diffusion.html"><a href="Diffusion.html#identifying-optimal-treatment-levels"><i class="fa fa-check"></i><b>11.2.2</b> Identifying optimal treatment levels</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="Diffusion.html"><a href="Diffusion.html#diffusion-effects-with-detailed-networks"><i class="fa fa-check"></i><b>11.3</b> Diffusion effects with detailed networks</a></li>
<li class="chapter" data-level="11.4" data-path="Diffusion.html"><a href="Diffusion.html#nonparametric-test-for-the-existence-of-diffusion-effects-based-on-randomization-inference"><i class="fa fa-check"></i><b>11.4</b> Nonparametric test for the existence of diffusion effects based on randomization inference</a></li>
<li class="chapter" data-level="11.5" data-path="Diffusion.html"><a href="Diffusion.html#diffusion-effects-with-did"><i class="fa fa-check"></i><b>11.5</b> Diffusion effects with DID</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="Distribution.html"><a href="Distribution.html"><i class="fa fa-check"></i><b>12</b> Distributional effects</a></li>
<li class="chapter" data-level="13" data-path="meta.html"><a href="meta.html"><i class="fa fa-check"></i><b>13</b> Meta-analysis and Publication Bias</a>
<ul>
<li class="chapter" data-level="13.1" data-path="meta.html"><a href="meta.html#meta-analysis"><i class="fa fa-check"></i><b>13.1</b> Meta-analysis</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="meta.html"><a href="meta.html#basic-setting"><i class="fa fa-check"></i><b>13.1.1</b> Basic setting</a></li>
<li class="chapter" data-level="13.1.2" data-path="meta.html"><a href="meta.html#why-vote-counting-does-not-work"><i class="fa fa-check"></i><b>13.1.2</b> Why vote-counting does not work</a></li>
<li class="chapter" data-level="13.1.3" data-path="meta.html"><a href="meta.html#MetaWA"><i class="fa fa-check"></i><b>13.1.3</b> Meta-analysis when treatment effects are homogeneous: the fixed effects approach</a></li>
<li class="chapter" data-level="13.1.4" data-path="meta.html"><a href="meta.html#meta-analysis-when-treatment-effects-are-heterogeneous-the-random-effects-approach"><i class="fa fa-check"></i><b>13.1.4</b> Meta-analysis when treatment effects are heterogeneous: the random effects approach</a></li>
<li class="chapter" data-level="13.1.5" data-path="meta.html"><a href="meta.html#meta-regression"><i class="fa fa-check"></i><b>13.1.5</b> Meta-regression</a></li>
<li class="chapter" data-level="13.1.6" data-path="meta.html"><a href="meta.html#constantly-updated-meta-analysis"><i class="fa fa-check"></i><b>13.1.6</b> Constantly updated meta-analysis</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="meta.html"><a href="meta.html#publication-bias-and-site-selection-bias"><i class="fa fa-check"></i><b>13.2</b> Publication bias and site selection bias</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="meta.html"><a href="meta.html#sources-of-publication-bias-and-of-site-selection-bias-and-questionable-research-practices"><i class="fa fa-check"></i><b>13.2.1</b> Sources of publication bias and of site selection bias and Questionable Research Practices</a></li>
<li class="chapter" data-level="13.2.2" data-path="meta.html"><a href="meta.html#detection-of-and-correction-for-publication-bias"><i class="fa fa-check"></i><b>13.2.2</b> Detection of and correction for publication bias</a></li>
<li class="chapter" data-level="13.2.3" data-path="meta.html"><a href="meta.html#getting-rid-of-publication-bias-registered-reports-and-pre-analysis-plans"><i class="fa fa-check"></i><b>13.2.3</b> Getting rid of publication bias: registered reports and pre-analysis plans</a></li>
<li class="chapter" data-level="13.2.4" data-path="meta.html"><a href="meta.html#detection-of-and-correction-for-site-selection-bias"><i class="fa fa-check"></i><b>13.2.4</b> Detection of and correction for site selection bias</a></li>
<li class="chapter" data-level="13.2.5" data-path="meta.html"><a href="meta.html#vote-counting-and-publication-bias"><i class="fa fa-check"></i><b>13.2.5</b> Vote counting and publication bias</a></li>
<li class="chapter" data-level="13.2.6" data-path="meta.html"><a href="meta.html#the-value-of-a-statistically-significant-result"><i class="fa fa-check"></i><b>13.2.6</b> The value of a statistically significant result</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="Bounds.html"><a href="Bounds.html"><i class="fa fa-check"></i><b>14</b> Bounds</a></li>
<li class="chapter" data-level="15" data-path="mediation-analysis.html"><a href="mediation-analysis.html"><i class="fa fa-check"></i><b>15</b> Mediation Analysis</a>
<ul>
<li class="chapter" data-level="15.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-a-framework"><i class="fa fa-check"></i><b>15.1</b> Mediation analysis: a framework</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#defining-mediated-and-unmediated-treatment-effects"><i class="fa fa-check"></i><b>15.1.1</b> Defining mediated and unmediated treatment effects</a></li>
<li class="chapter" data-level="15.1.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#decomposing-mediated-and-unmediated-effects"><i class="fa fa-check"></i><b>15.1.2</b> Decomposing mediated and unmediated effects</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#the-fundamental-problem-of-mediation-analysis"><i class="fa fa-check"></i><b>15.2</b> The Fundamental Problem of Mediation Analysis</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#the-fundamental-problem-of-mediation-analysis-1"><i class="fa fa-check"></i><b>15.2.1</b> The Fundamental Problem of Mediation Analysis</a></li>
<li class="chapter" data-level="15.2.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#biases-of-intuitive-comparisons"><i class="fa fa-check"></i><b>15.2.2</b> Biases of Intuitive Comparisons</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-with-experimental-data"><i class="fa fa-check"></i><b>15.3</b> Mediation analysis with experimental data</a>
<ul>
<li class="chapter" data-level="15.3.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-in-the-parallel-design"><i class="fa fa-check"></i><b>15.3.1</b> Mediation analysis in the Parallel design</a></li>
<li class="chapter" data-level="15.3.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-in-the-sequential-self-selection-design"><i class="fa fa-check"></i><b>15.3.2</b> Mediation analysis in the Sequential Self-Selection design</a></li>
<li class="chapter" data-level="15.3.3" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-in-the-crossover-design"><i class="fa fa-check"></i><b>15.3.3</b> Mediation analysis in the Crossover design</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-under-unconfoundedness"><i class="fa fa-check"></i><b>15.4</b> Mediation analysis under unconfoundedness</a>
<ul>
<li class="chapter" data-level="15.4.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#non-parametric-identification-under-sequential-ignorability"><i class="fa fa-check"></i><b>15.4.1</b> Non-parametric identification under sequential ignorability</a></li>
<li class="chapter" data-level="15.4.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-under-sequential-ignorability-in-linear-models"><i class="fa fa-check"></i><b>15.4.2</b> Mediation analysis under sequential ignorability in linear models</a></li>
</ul></li>
<li class="chapter" data-level="15.5" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-with-panel-data"><i class="fa fa-check"></i><b>15.5</b> Mediation analysis with panel data</a></li>
<li class="chapter" data-level="15.6" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-with-instruments"><i class="fa fa-check"></i><b>15.6</b> Mediation analysis with instruments</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="stratification.html"><a href="stratification.html"><i class="fa fa-check"></i><b>16</b> Stratification</a>
<ul>
<li class="chapter" data-level="16.1" data-path="stratification.html"><a href="stratification.html#ClassicalStratification"><i class="fa fa-check"></i><b>16.1</b> Analysis of classical stratified experiments</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="stratification.html"><a href="stratification.html#an-example-3"><i class="fa fa-check"></i><b>16.1.1</b> An example</a></li>
<li class="chapter" data-level="16.1.2" data-path="stratification.html"><a href="stratification.html#estimating-treatment-effects-with-stratified-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.1.2</b> Estimating treatment effects with stratified randomized controlled trials</a></li>
<li class="chapter" data-level="16.1.3" data-path="stratification.html"><a href="stratification.html#estimating-sampling-noise-in-stratified-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.1.3</b> Estimating sampling noise in stratified randomized controlled trials</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="stratification.html"><a href="stratification.html#analysis-of-pairwise-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.2</b> Analysis of pairwise randomized controlled trials</a>
<ul>
<li class="chapter" data-level="16.2.1" data-path="stratification.html"><a href="stratification.html#building-a-sample-of-pairs"><i class="fa fa-check"></i><b>16.2.1</b> Building a sample of pairs</a></li>
<li class="chapter" data-level="16.2.2" data-path="stratification.html"><a href="stratification.html#estimating-treatment-effects-in-pairwise-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.2.2</b> Estimating treatment effects in pairwise randomized controlled trials</a></li>
<li class="chapter" data-level="16.2.3" data-path="stratification.html"><a href="stratification.html#estimating-sampling-noise-in-pairwise-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.2.3</b> Estimating sampling noise in pairwise randomized controlled trials</a></li>
</ul></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="proofs.html"><a href="proofs.html"><i class="fa fa-check"></i><b>A</b> Proofs</a>
<ul>
<li class="chapter" data-level="A.1" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-reffpsi"><i class="fa fa-check"></i><b>A.1</b> Proofs of results in Chapter @ref(FPSI)</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="proofs.html"><a href="proofs.html#proofcheb"><i class="fa fa-check"></i><b>A.1.1</b> Proof of Theorem @ref(thm:uppsampnoise)</a></li>
<li class="chapter" data-level="A.1.2" data-path="proofs.html"><a href="proofs.html#proofCLT"><i class="fa fa-check"></i><b>A.1.2</b> Proof of Theorem @ref(thm:asympnoiseWW)</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refrct"><i class="fa fa-check"></i><b>A.2</b> Proofs of results in Chapter @ref(RCT)</a>
<ul>
<li class="chapter" data-level="A.2.1" data-path="proofs.html"><a href="proofs.html#proofIdentLATE"><i class="fa fa-check"></i><b>A.2.1</b> Proof of Theorem @ref(thm:IdentLATE)</a></li>
<li class="chapter" data-level="A.2.2" data-path="proofs.html"><a href="proofs.html#proofWaldIV"><i class="fa fa-check"></i><b>A.2.2</b> Proof of Theorem @ref(thm:WaldIV)</a></li>
<li class="chapter" data-level="A.2.3" data-path="proofs.html"><a href="proofs.html#ProofAsymWald"><i class="fa fa-check"></i><b>A.2.3</b> Proof of Theorem @ref(thm:asymWald)</a></li>
</ul></li>
<li class="chapter" data-level="A.3" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refne"><i class="fa fa-check"></i><b>A.3</b> Proofs of results in Chapter @ref(NE)</a>
<ul>
<li class="chapter" data-level="A.3.1" data-path="proofs.html"><a href="proofs.html#proofEstimDID"><i class="fa fa-check"></i><b>A.3.1</b> Proof of Theorem @ref(thm:EstimDID)</a></li>
<li class="chapter" data-level="A.3.2" data-path="proofs.html"><a href="proofs.html#proofasympnoiseDIDCross"><i class="fa fa-check"></i><b>A.3.2</b> Proof of Theorem @ref(thm:asympnoiseDIDCross)</a></li>
<li class="chapter" data-level="A.3.3" data-path="proofs.html"><a href="proofs.html#proofEquivDIDSApop"><i class="fa fa-check"></i><b>A.3.3</b> Proof of Theorem @ref(thm:EquivDIDSApop)</a></li>
<li class="chapter" data-level="A.3.4" data-path="proofs.html"><a href="proofs.html#proofEquivDIDSAsamp"><i class="fa fa-check"></i><b>A.3.4</b> Proof of Theorem @ref(thm:EquivDIDSAsamp)</a></li>
<li class="chapter" data-level="A.3.5" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSACross"><i class="fa fa-check"></i><b>A.3.5</b> Proof of Theorem @ref(thm:asympnoiseSACross)</a></li>
<li class="chapter" data-level="A.3.6" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSATTCross"><i class="fa fa-check"></i><b>A.3.6</b> Proof of Theorem @ref(thm:asympnoiseSATTCross)</a></li>
<li class="chapter" data-level="A.3.7" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSAPanel"><i class="fa fa-check"></i><b>A.3.7</b> Proof of Theorem @ref(thm:asympnoiseSAPanel)</a></li>
<li class="chapter" data-level="A.3.8" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSATTPanel"><i class="fa fa-check"></i><b>A.3.8</b> Proof of Theorem @ref(thm:asympnoiseSATTPanel)</a></li>
</ul></li>
<li class="chapter" data-level="A.4" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refom"><i class="fa fa-check"></i><b>A.4</b> Proofs of results in Chapter @ref(OM)</a>
<ul>
<li class="chapter" data-level="A.4.1" data-path="proofs.html"><a href="proofs.html#proofAsympWWOLS10"><i class="fa fa-check"></i><b>A.4.1</b> Proof of Theorem @ref(thm:AsympWWOLS10)</a></li>
</ul></li>
<li class="chapter" data-level="A.5" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refcluster"><i class="fa fa-check"></i><b>A.5</b> Proofs of results in Chapter @ref(cluster)</a>
<ul>
<li class="chapter" data-level="A.5.1" data-path="proofs.html"><a href="proofs.html#proofVarWWClus"><i class="fa fa-check"></i><b>A.5.1</b> Proof of Theorem @ref(thm:VarWWClus)</a></li>
<li class="chapter" data-level="A.5.2" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSATTPanelAR1"><i class="fa fa-check"></i><b>A.5.2</b> Proof of Theorem @ref(thm:asympnoiseSATTPanelAR1)</a></li>
<li class="chapter" data-level="A.5.3" data-path="proofs.html"><a href="proofs.html#proofVarWWSpatial"><i class="fa fa-check"></i><b>A.5.3</b> Proof of Theorem @ref(thm:VarWWSpatial)</a></li>
</ul></li>
<li class="chapter" data-level="A.6" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refdiffusion"><i class="fa fa-check"></i><b>A.6</b> Proofs of results in Chapter @ref(Diffusion)</a>
<ul>
<li class="chapter" data-level="A.6.1" data-path="proofs.html"><a href="proofs.html#proofSmoothSymAlloc"><i class="fa fa-check"></i><b>A.6.1</b> Proof of Theorem @ref(thm:SmoothSymAlloc)</a></li>
</ul></li>
<li class="chapter" data-level="A.7" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refstratification"><i class="fa fa-check"></i><b>A.7</b> Proofs of results in Chapter @ref(stratification)</a>
<ul>
<li class="chapter" data-level="A.7.1" data-path="proofs.html"><a href="proofs.html#proofSFEdecomp"><i class="fa fa-check"></i><b>A.7.1</b> Proof of Theorem @ref(thm:SFEdecomp)</a></li>
<li class="chapter" data-level="A.7.2" data-path="proofs.html"><a href="proofs.html#proofSFEconsistent"><i class="fa fa-check"></i><b>A.7.2</b> Proof of Theorem @ref(thm:SFEconsistent)</a></li>
<li class="chapter" data-level="A.7.3" data-path="proofs.html"><a href="proofs.html#proofSATUnbiasedConsistent"><i class="fa fa-check"></i><b>A.7.3</b> Proof of Theorem @ref(thm:SATUnbiasedConsistent)</a></li>
<li class="chapter" data-level="A.7.4" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSATStrata"><i class="fa fa-check"></i><b>A.7.4</b> Proof of Theorem @ref(thm:asympnoiseSATStrata)</a></li>
<li class="chapter" data-level="A.7.5" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSFEStrata"><i class="fa fa-check"></i><b>A.7.5</b> Proof of Theorem @ref(thm:asympnoiseSFEStrata)</a></li>
<li class="chapter" data-level="A.7.6" data-path="proofs.html"><a href="proofs.html#proofPairUnbiasedConsistent"><i class="fa fa-check"></i><b>A.7.6</b> Proof of Theorem @ref(thm:PairUnbiasedConsistent)</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Statistical Tools for Causal Inference</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="stratification" class="section level1 hasAnchor" number="16">
<h1><span class="header-section-number">Chapter 16</span> Stratification<a href="stratification.html#stratification" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Stratification occurs when we are sampling units in the population of interest within some prespecified categories.
The main goal of stratification is to ensure that the surveyed sample reflects as much as possible the composition of the original population, at least in terms of the categories used to stratify.
In randomized experiments, stratification is used to ensure that the control and treatment groups are as similar as possible.
At least in theory, stratification helps to improve precision, since it decreases the amount of variation in the unobserved confounders that might not be aligned between treatment and control groups and that are the cause of sampling noise.
Stratification is thus a very powerful tool to improve the precision of treatment effect estimates, without having to increase sample size.</p>
<p>There are several key issues around stratification.
The first is how to implement it in practice.
One key issue is which covariates to choose and how to combine them in order not to end up with too many small cells.
A second key issue is how to estimate sampling noise after stratification.
An easy mistake is to stratify and then forget about stratification when estimating sampling noise, thereby inflating sampling noise, and missing the improvements brought about by the stratification process.</p>
<p>One solution to these issues that I particularly like is to conduct a pairwise RCT, that is to have strata of size two.
The main advantage of this solution is that it theoretically solves the problem of combining covariates optimally: just find the pairs of observations that look most alike and randomize the treatment between them.
One difficulty with this approach is that finding the pairs that minimize the overall distance between them is a difficult task.
Until now, it was solved using undirected search algorithms which simply go through all the possible combinations to try to find the optimal one.
This poses two problems: the pairing you find is not ensured to be the best one and finding it might take a lot of time.
In this chapter, I introduce a pairing algorithm that finds the optimal pairs in polynomial (e.g. reasonable) time.</p>
<p>Another approach would be to generate the strata by k-means clustering.
Intuitively, the pairwise RCT approach should minimize residual errors, but a formal proof of that result does not exist.
A full treatment of optimal stratification is still missing, at least to my knowledge, in the literature.</p>
<p>I am going to first examine the analysis of classical stratified experiments (with more than 2 units per strata) first, then I’ll turn to pairwise RCTs and finally I’ll examine how you stratify in practice.</p>
<div id="ClassicalStratification" class="section level2 hasAnchor" number="16.1">
<h2><span class="header-section-number">16.1</span> Analysis of classical stratified experiments<a href="stratification.html#ClassicalStratification" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We are first going to look at an example to see how stratification can help with sampling noise, basically decreasing it by a starkly large factor.
We will then study the estimation of treatment effects under stratified randomization and then the estimation of sampling noise, which is a critical phase in order for our precision estimates to reflect the increase in precision brought about by stratification.</p>
<div id="an-example-3" class="section level3 hasAnchor" number="16.1.1">
<h3><span class="header-section-number">16.1.1</span> An example<a href="stratification.html#an-example-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let us first generate a stratified random sample in order to see what stratification can do for us, and what a naive approach to the analysis of stratified experiments misses.
We are going to study the case of a Brute Forced design, and we will vary the amount of stratification, from none to a lot of strata.
In practice, there are several ways to build strata and to draw observations within each of them.
Here, I am only going to stratify on one pre-treatment variable, pre-treatment outcome.
But, in practice, stratification is done on several variables that we need to interact.
One way to build groups with similar values of these variables is to use <span class="math inline">\(k\)</span>-means clustering.
<span class="math inline">\(k\)</span>-means clustering finds the optimal separation of points in the sample between a pre-specified number of <span class="math inline">\(k\)</span> clusters such that the within-cluster variance is minimized (so that the strata (i.e. <em>clusters</em>) are as homogeneous as possible, which is our goal when stratifying among similar units of observations).
Whether using <span class="math inline">\(k\)</span>-means clustering, or simply by selecting sets of observations which have similar values for their covariates, we end up with a set <span class="math inline">\(\mathcal{S}\)</span> of strata.</p>
<p>Once the strata are built, there are several ways to select the treated units within each strata.
Section 3 in <a href="https://doi.org/10.1080/01621459.2017.1375934">Bugny, Canay and shaikh (2018)</a> gives several examples of stratified assignments.
The one we are going to use here is stratified block randomization.
In this approach we select, in each strata <span class="math inline">\(s\in\mathcal{S}\)</span> of size <span class="math inline">\(N_s\)</span>, a number <span class="math inline">\(N^1_s\)</span> of observations for receiving the treatment, with <span class="math inline">\(N^1_s=\lfloor \pi N_s \rfloor\)</span>, with <span class="math inline">\(\pi\)</span> the target proportion of treated and control units in the sample.</p>
<div class="remark">
<p><span id="unlabeled-div-300" class="remark"><em>Remark</em>. </span>Note that with stratified block randomization and <span class="math inline">\(\pi\)</span> constant with <span class="math inline">\(s\)</span>, each strata will be represented in the sample in proportion to its weight in the population.
Other designs have <span class="math inline">\(\pi\)</span> vary with <span class="math inline">\(s\)</span>, but we are not going to examine them here.
See <a href="https://doi.org/10.1017/CBO9781139025751">Imbens and Rubin (2015)</a> for more details on how to analyze them.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-301" class="remark"><em>Remark</em>. </span>Another point worthy of notice is that stratified block randomization is not what we have used when we have drawn random samples for RCTs in Chapter <a href="RCT.html#RCT">3</a>.
In that chapter, we have used a simple coin design, in which each unit is affected either to the treatment or to the control as a function of an independent coin toss.
As a result, the actual proportion of of treated and control in the sample is not exactly <span class="math inline">\(\pi\)</span>.
But the Law of Large Numbers ensures that the actual proportion is not very far from the target <span class="math inline">\(\pi\)</span>.
Since strata are small, the Law of Large Number does not apply as fast, and imbalances might arise in pratice because of variations in the proportion of treated units across strata.
Hence, we prefer to use stratified block randomization.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-493" class="example"><strong>Example 16.1  </strong></span>Let’s see how this works in our ususal example of a brute force design, with stratification on the pre-treatment outcomes <span class="math inline">\(y^B_i\)</span>.</p>
</div>
<p>Let us first generate a random sample.</p>
<div class="sourceCode" id="cb495"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb495-1"><a href="stratification.html#cb495-1" aria-hidden="true" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>)</span>
<span id="cb495-2"><a href="stratification.html#cb495-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,<span class="st">&quot;theta&quot;</span>,<span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;baralpha&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb496"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb496-1"><a href="stratification.html#cb496-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb496-2"><a href="stratification.html#cb496-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb496-3"><a href="stratification.html#cb496-3" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb496-4"><a href="stratification.html#cb496-4" aria-hidden="true" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb496-5"><a href="stratification.html#cb496-5" aria-hidden="true" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb496-6"><a href="stratification.html#cb496-6" aria-hidden="true" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb496-7"><a href="stratification.html#cb496-7" aria-hidden="true" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb496-8"><a href="stratification.html#cb496-8" aria-hidden="true" tabindex="-1"></a>eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb496-9"><a href="stratification.html#cb496-9" aria-hidden="true" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb496-10"><a href="stratification.html#cb496-10" aria-hidden="true" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb496-11"><a href="stratification.html#cb496-11" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb496-12"><a href="stratification.html#cb496-12" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb496-13"><a href="stratification.html#cb496-13" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb496-14"><a href="stratification.html#cb496-14" aria-hidden="true" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb496-15"><a href="stratification.html#cb496-15" aria-hidden="true" tabindex="-1"></a>data.strata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">yB=</span>yB,<span class="at">y1=</span>y1,<span class="at">y0=</span>y0) <span class="sc">%&gt;%</span></span>
<span id="cb496-16"><a href="stratification.html#cb496-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb496-17"><a href="stratification.html#cb496-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>N</span>
<span id="cb496-18"><a href="stratification.html#cb496-18" aria-hidden="true" tabindex="-1"></a>                )</span></code></pre></div>
<p>Let us now generate several sets of strata using <span class="math inline">\(k\)</span>-means clustering, with the command <code>stats::kmeans</code>.
We are going to vary the number of strata, from <span class="math inline">\(1\)</span> to <span class="math inline">\(100\)</span>.</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb497-1"><a href="stratification.html#cb497-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function generating $k$ strata based on a dataset of pre-treatment variables using k-means clustering</span></span>
<span id="cb497-2"><a href="stratification.html#cb497-2" aria-hidden="true" tabindex="-1"></a><span class="co"># k: number of strata</span></span>
<span id="cb497-3"><a href="stratification.html#cb497-3" aria-hidden="true" tabindex="-1"></a><span class="co"># data: the dataset used for stratification</span></span>
<span id="cb497-4"><a href="stratification.html#cb497-4" aria-hidden="true" tabindex="-1"></a><span class="co"># var: the list of variables used for stratification</span></span>
<span id="cb497-5"><a href="stratification.html#cb497-5" aria-hidden="true" tabindex="-1"></a>stratification <span class="ot">&lt;-</span> <span class="cf">function</span>(k,var,data){</span>
<span id="cb497-6"><a href="stratification.html#cb497-6" aria-hidden="true" tabindex="-1"></a>  data.strat <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb497-7"><a href="stratification.html#cb497-7" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">select</span>(<span class="fu">contains</span>(var))</span>
<span id="cb497-8"><a href="stratification.html#cb497-8" aria-hidden="true" tabindex="-1"></a>  k.means <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">kmeans</span>(data.strat,<span class="at">centers=</span>k,<span class="at">nstart=</span>k)</span>
<span id="cb497-9"><a href="stratification.html#cb497-9" aria-hidden="true" tabindex="-1"></a>  strata.k <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(k.means<span class="sc">$</span>cluster)</span>
<span id="cb497-10"><a href="stratification.html#cb497-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(strata.k) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;strata&quot;</span>,k,<span class="at">sep=</span><span class="st">&#39;_&#39;</span>))</span>
<span id="cb497-11"><a href="stratification.html#cb497-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(strata.k)</span>
<span id="cb497-12"><a href="stratification.html#cb497-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb497-13"><a href="stratification.html#cb497-13" aria-hidden="true" tabindex="-1"></a><span class="co"># test</span></span>
<span id="cb497-14"><a href="stratification.html#cb497-14" aria-hidden="true" tabindex="-1"></a>strata<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">stratification</span>(<span class="at">k=</span><span class="dv">2</span>,<span class="at">var=</span><span class="st">&quot;yB&quot;</span>,<span class="at">data=</span>data.strata)</span>
<span id="cb497-15"><a href="stratification.html#cb497-15" aria-hidden="true" tabindex="-1"></a>strata<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">stratification</span>(<span class="at">k=</span><span class="dv">5</span>,<span class="at">var=</span><span class="st">&quot;yB&quot;</span>,<span class="at">data=</span>data.strata)</span>
<span id="cb497-16"><a href="stratification.html#cb497-16" aria-hidden="true" tabindex="-1"></a><span class="co">#data &lt;- cbind(data,strata=strata.2$cluster)  </span></span>
<span id="cb497-17"><a href="stratification.html#cb497-17" aria-hidden="true" tabindex="-1"></a><span class="co"># let us now map across values of $k$</span></span>
<span id="cb497-18"><a href="stratification.html#cb497-18" aria-hidden="true" tabindex="-1"></a>k.vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">100</span>)</span>
<span id="cb497-19"><a href="stratification.html#cb497-19" aria-hidden="true" tabindex="-1"></a>test.map <span class="ot">&lt;-</span> <span class="fu">map</span>(k.vec,stratification,<span class="at">var=</span><span class="st">&quot;yB&quot;</span>,<span class="at">data=</span>data.strata) <span class="sc">%&gt;%</span></span>
<span id="cb497-20"><a href="stratification.html#cb497-20" aria-hidden="true" tabindex="-1"></a>              <span class="fu">bind_cols</span>()</span>
<span id="cb497-21"><a href="stratification.html#cb497-21" aria-hidden="true" tabindex="-1"></a><span class="co"># final data</span></span>
<span id="cb497-22"><a href="stratification.html#cb497-22" aria-hidden="true" tabindex="-1"></a>data.strata <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data.strata,test.map)</span>
<span id="cb497-23"><a href="stratification.html#cb497-23" aria-hidden="true" tabindex="-1"></a><span class="co"># counting strata size</span></span>
<span id="cb497-24"><a href="stratification.html#cb497-24" aria-hidden="true" tabindex="-1"></a><span class="co">#strata.size &lt;- data.strata %&gt;%</span></span></code></pre></div>
<p>Let us finally visualize the grouping with 5 and 50 strata.</p>
<div class="sourceCode" id="cb498"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb498-1"><a href="stratification.html#cb498-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.strata,<span class="fu">aes</span>(<span class="at">x=</span>yB,<span class="at">y=</span>y0,<span class="at">group=</span><span class="fu">as.factor</span>(strata_5),<span class="at">color=</span><span class="fu">as.factor</span>(strata_5),<span class="at">shape=</span><span class="fu">as.factor</span>(strata_5)))<span class="sc">+</span></span>
<span id="cb498-2"><a href="stratification.html#cb498-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb498-3"><a href="stratification.html#cb498-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb498-4"><a href="stratification.html#cb498-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb498-5"><a href="stratification.html#cb498-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.strata,<span class="fu">aes</span>(<span class="at">x=</span>yB,<span class="at">y=</span>y0,<span class="at">group=</span><span class="fu">as.factor</span>(strata_50),<span class="at">color=</span><span class="fu">as.factor</span>(strata_50)))<span class="sc">+</span></span>
<span id="cb498-6"><a href="stratification.html#cb498-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb498-7"><a href="stratification.html#cb498-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:StrataPlot"></span>
<img src="STCI_files/figure-html/StrataPlot-1.png" alt="Grouping in strata using $k$-means clustering" width="50%" /><img src="STCI_files/figure-html/StrataPlot-2.png" alt="Grouping in strata using $k$-means clustering" width="50%" />
<p class="caption">
Figure 16.1: Grouping in strata using <span class="math inline">\(k\)</span>-means clustering
</p>
</div>
<p>Each strata is defined as an upper and lower bound on the value of <span class="math inline">\(y_i^B\)</span>, so as to be mutually exclusive.
The effectiveness of the strata at increasing precision and power stems from the fact that <span class="math inline">\(y_i^B\)</span> is strongly correlated with <span class="math inline">\(y_i^0\)</span>, thereby decreasing the likelihood that treated and control units have different distributions of potential outcomes.
Because of that property, we would like the number of strata to be as big as possible.
But this generates one problem: we might end up with strata that only have one unit.
In that case, we cannot randomly allocate the treatment within the strata, and we have to exclude it from our sample, thereby losing its representativity.
This problem is even more serious if we have several treatments that we want to test against our control.
As a consequence, we cannot increase the number of strata indefinitely.
Let’s see how the strata are composed in our example.</p>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb499-1"><a href="stratification.html#cb499-1" aria-hidden="true" tabindex="-1"></a>StrataSize <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb499-2"><a href="stratification.html#cb499-2" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>),<span class="at">names_to =</span> <span class="st">&quot;strata_type&quot;</span>,<span class="at">values_to=</span><span class="st">&quot;strata_value&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb499-3"><a href="stratification.html#cb499-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type,strata_value) <span class="sc">%&gt;%</span></span>
<span id="cb499-4"><a href="stratification.html#cb499-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarise</span>(</span>
<span id="cb499-5"><a href="stratification.html#cb499-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ns =</span> <span class="fu">n</span>()</span>
<span id="cb499-6"><a href="stratification.html#cb499-6" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb499-7"><a href="stratification.html#cb499-7" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb499-8"><a href="stratification.html#cb499-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata_N =</span> <span class="fu">str_split_fixed</span>(strata_type,<span class="st">&#39;_&#39;</span>,<span class="dv">2</span>)[,<span class="dv">2</span>],</span>
<span id="cb499-9"><a href="stratification.html#cb499-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata_N =</span> <span class="fu">factor</span>(strata_N,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;5&#39;</span>,<span class="st">&#39;10&#39;</span>,<span class="st">&#39;25&#39;</span>,<span class="st">&#39;50&#39;</span>,<span class="st">&#39;100&#39;</span>)),</span>
<span id="cb499-10"><a href="stratification.html#cb499-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata_value =</span> <span class="fu">as.factor</span>(strata_value)</span>
<span id="cb499-11"><a href="stratification.html#cb499-11" aria-hidden="true" tabindex="-1"></a>                ) </span>
<span id="cb499-12"><a href="stratification.html#cb499-12" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb499-13"><a href="stratification.html#cb499-13" aria-hidden="true" tabindex="-1"></a>StrataSizeMinMedMax <span class="ot">&lt;-</span> StrataSize <span class="sc">%&gt;%</span></span>
<span id="cb499-14"><a href="stratification.html#cb499-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type,strata_N) <span class="sc">%&gt;%</span></span>
<span id="cb499-15"><a href="stratification.html#cb499-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarise</span>(</span>
<span id="cb499-16"><a href="stratification.html#cb499-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Min =</span> <span class="fu">min</span>(Ns),</span>
<span id="cb499-17"><a href="stratification.html#cb499-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Max =</span> <span class="fu">max</span>(Ns),</span>
<span id="cb499-18"><a href="stratification.html#cb499-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Mean =</span> <span class="fu">mean</span>(Ns)</span>
<span id="cb499-19"><a href="stratification.html#cb499-19" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb499-20"><a href="stratification.html#cb499-20" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pivot_longer</span>(<span class="at">cols=</span> Min<span class="sc">:</span>Mean,<span class="at">names_to =</span> <span class="st">&quot;Type&quot;</span>,<span class="at">values_to =</span> <span class="st">&quot;Stat&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb499-21"><a href="stratification.html#cb499-21" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb499-22"><a href="stratification.html#cb499-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Type =</span> <span class="fu">factor</span>(Type,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;Min&#39;</span>,<span class="st">&#39;Mean&#39;</span>,<span class="st">&#39;Max&#39;</span>))</span>
<span id="cb499-23"><a href="stratification.html#cb499-23" aria-hidden="true" tabindex="-1"></a>                )</span></code></pre></div>
<p>Let us plot the resulting minimum value of strata size:</p>
<div class="sourceCode" id="cb500"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb500-1"><a href="stratification.html#cb500-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(StrataSize <span class="sc">%&gt;%</span> <span class="fu">filter</span>(strata_N<span class="sc">!=</span><span class="st">&#39;1&#39;</span>),<span class="fu">aes</span>(<span class="at">x=</span>strata_value,<span class="at">y=</span>Ns,<span class="at">fill=</span>strata_value)) <span class="sc">+</span></span>
<span id="cb500-2"><a href="stratification.html#cb500-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&#39;identity&#39;</span>) <span class="sc">+</span></span>
<span id="cb500-3"><a href="stratification.html#cb500-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept=</span><span class="dv">1</span>),<span class="at">color=</span><span class="st">&#39;red&#39;</span>,<span class="at">linetype=</span><span class="st">&#39;dotted&#39;</span>) <span class="sc">+</span></span>
<span id="cb500-4"><a href="stratification.html#cb500-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#scale_y_continuous(trans=log_trans(),breaks=c(1,10,100))+</span></span>
<span id="cb500-5"><a href="stratification.html#cb500-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#expand_limits(y=0) +</span></span>
<span id="cb500-6"><a href="stratification.html#cb500-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_discrete</span>(<span class="at">name=</span><span class="st">&#39;Strata&#39;</span>) <span class="sc">+</span></span>
<span id="cb500-7"><a href="stratification.html#cb500-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&#39;Strata&#39;</span>)<span class="sc">+</span></span>
<span id="cb500-8"><a href="stratification.html#cb500-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&#39;Strata size&#39;</span>)<span class="sc">+</span></span>
<span id="cb500-9"><a href="stratification.html#cb500-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb500-10"><a href="stratification.html#cb500-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(strata_N<span class="sc">~</span>.)</span>
<span id="cb500-11"><a href="stratification.html#cb500-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb500-12"><a href="stratification.html#cb500-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(StrataSizeMinMedMax,<span class="fu">aes</span>(<span class="at">x=</span>strata_N,<span class="at">y=</span>Stat,<span class="at">fill=</span>Type,<span class="at">group=</span>Type)) <span class="sc">+</span></span>
<span id="cb500-13"><a href="stratification.html#cb500-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&#39;identity&#39;</span>,<span class="at">position=</span><span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="cb500-14"><a href="stratification.html#cb500-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept=</span><span class="dv">1</span>),<span class="at">color=</span><span class="st">&#39;red&#39;</span>,<span class="at">linetype=</span><span class="st">&#39;dotted&#39;</span>) <span class="sc">+</span></span>
<span id="cb500-15"><a href="stratification.html#cb500-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#scale_y_continuous(trans=log_trans(),breaks=c(1,10,100))+</span></span>
<span id="cb500-16"><a href="stratification.html#cb500-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#expand_limits(y=0) +</span></span>
<span id="cb500-17"><a href="stratification.html#cb500-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#scale_fill_discrete(name=&#39;Strata&#39;) +</span></span>
<span id="cb500-18"><a href="stratification.html#cb500-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&#39;Number of strata&#39;</span>)<span class="sc">+</span></span>
<span id="cb500-19"><a href="stratification.html#cb500-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&#39;Strata size&#39;</span>)<span class="sc">+</span></span>
<span id="cb500-20"><a href="stratification.html#cb500-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="co">#+</span></span>
<span id="cb500-21"><a href="stratification.html#cb500-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#facet_grid(Type~.)</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:StrataSizePlot"></span>
<img src="STCI_files/figure-html/StrataSizePlot-1.png" alt="Number of strata and strata size" width="95%" /><img src="STCI_files/figure-html/StrataSizePlot-2.png" alt="Number of strata and strata size" width="75%" />
<p class="caption">
Figure 16.2: Number of strata and strata size
</p>
</div>
<p>Let us now randomly allocate the treatment among strata using block randomization.
The way I am going to do that is by randomly allocating a uniform random variable, compute its median in each strata and allocate everyone strictly below the median to the treatment, and everyone equal or above to the control.
Let’s see how this works.</p>
<div class="sourceCode" id="cb501"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb501-1"><a href="stratification.html#cb501-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of strata types</span></span>
<span id="cb501-2"><a href="stratification.html#cb501-2" aria-hidden="true" tabindex="-1"></a>NStrataTypes <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>(.) <span class="sc">%&gt;%</span> <span class="fu">length</span>(.)</span>
<span id="cb501-3"><a href="stratification.html#cb501-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb501-4"><a href="stratification.html#cb501-4" aria-hidden="true" tabindex="-1"></a>data.strata <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb501-5"><a href="stratification.html#cb501-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>),<span class="at">names_to =</span> <span class="st">&quot;strata_type&quot;</span>,<span class="at">values_to=</span><span class="st">&quot;strata_value&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb501-6"><a href="stratification.html#cb501-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb501-7"><a href="stratification.html#cb501-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata_type_value =</span> <span class="fu">str_c</span>(strata_type,strata_value,<span class="at">sep=</span><span class="st">&#39;_&#39;</span>),</span>
<span id="cb501-8"><a href="stratification.html#cb501-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata_value =</span> <span class="fu">as.factor</span>(strata_value),</span>
<span id="cb501-9"><a href="stratification.html#cb501-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata_type =</span> <span class="fu">as.factor</span>(strata_type)</span>
<span id="cb501-10"><a href="stratification.html#cb501-10" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span>               </span>
<span id="cb501-11"><a href="stratification.html#cb501-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb501-12"><a href="stratification.html#cb501-12" aria-hidden="true" tabindex="-1"></a>                  <span class="at">randU =</span> <span class="fu">runif</span>(N<span class="sc">*</span>NStrataTypes)</span>
<span id="cb501-13"><a href="stratification.html#cb501-13" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb501-14"><a href="stratification.html#cb501-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb501-15"><a href="stratification.html#cb501-15" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb501-16"><a href="stratification.html#cb501-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">randUMedStrata =</span> stats<span class="sc">::</span><span class="fu">median</span>(randU),</span>
<span id="cb501-17"><a href="stratification.html#cb501-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ds =</span> <span class="fu">case_when</span>(</span>
<span id="cb501-18"><a href="stratification.html#cb501-18" aria-hidden="true" tabindex="-1"></a>                    randU<span class="sc">&lt;</span>randUMedStrata <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb501-19"><a href="stratification.html#cb501-19" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb501-20"><a href="stratification.html#cb501-20" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb501-21"><a href="stratification.html#cb501-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>(<span class="dv">1</span><span class="sc">-</span>Ds)<span class="sc">*</span>y0,</span>
<span id="cb501-22"><a href="stratification.html#cb501-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ns =</span> <span class="fu">n</span>(),</span>
<span id="cb501-23"><a href="stratification.html#cb501-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">pis =</span> <span class="fu">mean</span>(Ds)</span>
<span id="cb501-24"><a href="stratification.html#cb501-24" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb501-25"><a href="stratification.html#cb501-25" aria-hidden="true" tabindex="-1"></a>                <span class="fu">arrange</span>(strata_type,Ns,strata_value,randU)</span></code></pre></div>
<p>Let us now examine how to estimate the treatment effect in this sample.
One key question here is how to compute the treatment effect estimate.
There are at least four different ways:</p>
<ol style="list-style-type: decimal">
<li>Use the simple with/without estimator.</li>
<li>Use a weighted average of the treatment effects in each strata, with weights proportionnal to the inverse of their variance.</li>
<li>Use an OLS regression with the treatment dummy and a set of strata fixed effects.</li>
<li>Use an OLS regression with the treatment dummy and a set of strata fixed effects interacted with the treatment indicator (this is a fully saturated model).</li>
</ol>
<p>We will examine later the rationale for each of these estimators.
For now, I am going to compute the distribution of the simple with/without estimator and of the strata fixed effects estimator.</p>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb502-1"><a href="stratification.html#cb502-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WW</span></span>
<span id="cb502-2"><a href="stratification.html#cb502-2" aria-hidden="true" tabindex="-1"></a>regWW <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb502-3"><a href="stratification.html#cb502-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(strata_type) <span class="sc">%&gt;%</span></span>
<span id="cb502-4"><a href="stratification.html#cb502-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb502-5"><a href="stratification.html#cb502-5" aria-hidden="true" tabindex="-1"></a>       <span class="co"># rowwise(.) %&gt;%</span></span>
<span id="cb502-6"><a href="stratification.html#cb502-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb502-7"><a href="stratification.html#cb502-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">reg =</span> <span class="fu">map</span>(data,<span class="sc">~</span><span class="fu">lm</span>(y<span class="sc">~</span>Ds,<span class="at">data=</span>.)),</span>
<span id="cb502-8"><a href="stratification.html#cb502-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">tidied =</span> <span class="fu">map</span>(reg,tidy)</span>
<span id="cb502-9"><a href="stratification.html#cb502-9" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb502-10"><a href="stratification.html#cb502-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span></span>
<span id="cb502-11"><a href="stratification.html#cb502-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&#39;Ds&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-12"><a href="stratification.html#cb502-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(</span>
<span id="cb502-13"><a href="stratification.html#cb502-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">Coef =</span> estimate,</span>
<span id="cb502-14"><a href="stratification.html#cb502-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">Se =</span> std.error</span>
<span id="cb502-15"><a href="stratification.html#cb502-15" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb502-16"><a href="stratification.html#cb502-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(strata_type,Coef,Se)<span class="sc">%&gt;%</span></span>
<span id="cb502-17"><a href="stratification.html#cb502-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Type=</span><span class="st">&#39;WW&#39;</span>)</span>
<span id="cb502-18"><a href="stratification.html#cb502-18" aria-hidden="true" tabindex="-1"></a><span class="co"># strata fixed effects</span></span>
<span id="cb502-19"><a href="stratification.html#cb502-19" aria-hidden="true" tabindex="-1"></a>regSFE <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb502-20"><a href="stratification.html#cb502-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(strata_type<span class="sc">!=</span><span class="st">&#39;strata_1&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-21"><a href="stratification.html#cb502-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(strata_type) <span class="sc">%&gt;%</span></span>
<span id="cb502-22"><a href="stratification.html#cb502-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb502-23"><a href="stratification.html#cb502-23" aria-hidden="true" tabindex="-1"></a>       <span class="co"># rowwise(.) %&gt;%</span></span>
<span id="cb502-24"><a href="stratification.html#cb502-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb502-25"><a href="stratification.html#cb502-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">reg =</span> <span class="fu">map</span>(data,<span class="sc">~</span><span class="fu">feols</span>(y<span class="sc">~</span>Ds<span class="sc">|</span>strata_value,<span class="at">vcov=</span><span class="st">&quot;HC1&quot;</span>,<span class="at">data=</span>.)),</span>
<span id="cb502-26"><a href="stratification.html#cb502-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">tidied =</span> <span class="fu">map</span>(reg,tidy)</span>
<span id="cb502-27"><a href="stratification.html#cb502-27" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb502-28"><a href="stratification.html#cb502-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span></span>
<span id="cb502-29"><a href="stratification.html#cb502-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&#39;Ds&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-30"><a href="stratification.html#cb502-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(</span>
<span id="cb502-31"><a href="stratification.html#cb502-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">Coef =</span> estimate,</span>
<span id="cb502-32"><a href="stratification.html#cb502-32" aria-hidden="true" tabindex="-1"></a>          <span class="at">Se =</span> std.error</span>
<span id="cb502-33"><a href="stratification.html#cb502-33" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb502-34"><a href="stratification.html#cb502-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(strata_type,Coef,Se) <span class="sc">%&gt;%</span></span>
<span id="cb502-35"><a href="stratification.html#cb502-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">Type=</span><span class="st">&#39;SFE&#39;</span>)</span>
<span id="cb502-36"><a href="stratification.html#cb502-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-37"><a href="stratification.html#cb502-37" aria-hidden="true" tabindex="-1"></a><span class="co"># fully staturated model </span></span>
<span id="cb502-38"><a href="stratification.html#cb502-38" aria-hidden="true" tabindex="-1"></a><span class="co"># run a regression in each strata</span></span>
<span id="cb502-39"><a href="stratification.html#cb502-39" aria-hidden="true" tabindex="-1"></a>regSAT <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb502-40"><a href="stratification.html#cb502-40" aria-hidden="true" tabindex="-1"></a><span class="co">#          filter(strata_type!=&#39;strata_1&#39;) %&gt;%</span></span>
<span id="cb502-41"><a href="stratification.html#cb502-41" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb502-42"><a href="stratification.html#cb502-42" aria-hidden="true" tabindex="-1"></a>          <span class="co"># generating the number of treated observations in each strata</span></span>
<span id="cb502-43"><a href="stratification.html#cb502-43" aria-hidden="true" tabindex="-1"></a>          <span class="co"># and the proportion of observations in each strata</span></span>
<span id="cb502-44"><a href="stratification.html#cb502-44" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb502-45"><a href="stratification.html#cb502-45" aria-hidden="true" tabindex="-1"></a>            <span class="at">Ns1 =</span> <span class="fu">sum</span>(Ds),</span>
<span id="cb502-46"><a href="stratification.html#cb502-46" aria-hidden="true" tabindex="-1"></a>            <span class="at">qs =</span> Ns<span class="sc">/</span>N</span>
<span id="cb502-47"><a href="stratification.html#cb502-47" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb502-48"><a href="stratification.html#cb502-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Ns1<span class="sc">&gt;</span><span class="dv">1</span>,N<span class="sc">-</span>Ns1<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-49"><a href="stratification.html#cb502-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb502-50"><a href="stratification.html#cb502-50" aria-hidden="true" tabindex="-1"></a>       <span class="co"># rowwise(.) %&gt;%</span></span>
<span id="cb502-51"><a href="stratification.html#cb502-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb502-52"><a href="stratification.html#cb502-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">reg =</span> <span class="fu">map</span>(data,<span class="sc">~</span><span class="fu">feols</span>(y<span class="sc">~</span>Ds<span class="sc">|</span><span class="dv">1</span>,<span class="at">vcov=</span><span class="st">&quot;HC1&quot;</span>,<span class="at">data=</span>.)),</span>
<span id="cb502-53"><a href="stratification.html#cb502-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">tidied =</span> <span class="fu">map</span>(reg,tidy)</span>
<span id="cb502-54"><a href="stratification.html#cb502-54" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb502-55"><a href="stratification.html#cb502-55" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span></span>
<span id="cb502-56"><a href="stratification.html#cb502-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&#39;Ds&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-57"><a href="stratification.html#cb502-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(</span>
<span id="cb502-58"><a href="stratification.html#cb502-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">Coef =</span> estimate,</span>
<span id="cb502-59"><a href="stratification.html#cb502-59" aria-hidden="true" tabindex="-1"></a>          <span class="at">Se =</span> std.error</span>
<span id="cb502-60"><a href="stratification.html#cb502-60" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb502-61"><a href="stratification.html#cb502-61" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(strata_type_value,Coef,Se) </span>
<span id="cb502-62"><a href="stratification.html#cb502-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-63"><a href="stratification.html#cb502-63" aria-hidden="true" tabindex="-1"></a><span class="co"># weighted mean function over a dataset with a formula for use in nest</span></span>
<span id="cb502-64"><a href="stratification.html#cb502-64" aria-hidden="true" tabindex="-1"></a><span class="co"># formula: formula with outcome as regressand and weigths as regressors</span></span>
<span id="cb502-65"><a href="stratification.html#cb502-65" aria-hidden="true" tabindex="-1"></a><span class="co"># data: the dataset used</span></span>
<span id="cb502-66"><a href="stratification.html#cb502-66" aria-hidden="true" tabindex="-1"></a>weighted.mean.nest <span class="ot">&lt;-</span> <span class="cf">function</span>(form,data,...){</span>
<span id="cb502-67"><a href="stratification.html#cb502-67" aria-hidden="true" tabindex="-1"></a>  name.y <span class="ot">&lt;-</span> <span class="fu">as.character</span>(form[[<span class="dv">2</span>]])</span>
<span id="cb502-68"><a href="stratification.html#cb502-68" aria-hidden="true" tabindex="-1"></a>  name.w <span class="ot">&lt;-</span> <span class="fu">as.character</span>(form[[<span class="dv">3</span>]])</span>
<span id="cb502-69"><a href="stratification.html#cb502-69" aria-hidden="true" tabindex="-1"></a>  w.mean <span class="ot">&lt;-</span> <span class="fu">weighted.mean</span>(<span class="at">x=</span>data[name.y],<span class="at">w=</span>data[name.w],...) </span>
<span id="cb502-70"><a href="stratification.html#cb502-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(w.mean)</span>
<span id="cb502-71"><a href="stratification.html#cb502-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb502-72"><a href="stratification.html#cb502-72" aria-hidden="true" tabindex="-1"></a><span class="co"># testing</span></span>
<span id="cb502-73"><a href="stratification.html#cb502-73" aria-hidden="true" tabindex="-1"></a>test.wmean <span class="ot">&lt;-</span> <span class="fu">weighted.mean.nest</span>(Coef<span class="sc">~</span>Se,<span class="at">data=</span>regSAT,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb502-74"><a href="stratification.html#cb502-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-75"><a href="stratification.html#cb502-75" aria-hidden="true" tabindex="-1"></a><span class="co"># averaging back using strata proportions</span></span>
<span id="cb502-76"><a href="stratification.html#cb502-76" aria-hidden="true" tabindex="-1"></a>regSAT.inter <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb502-77"><a href="stratification.html#cb502-77" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type,strata_value,strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb502-78"><a href="stratification.html#cb502-78" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarize</span>(</span>
<span id="cb502-79"><a href="stratification.html#cb502-79" aria-hidden="true" tabindex="-1"></a>                  <span class="at">qs =</span> <span class="fu">mean</span>(Ns<span class="sc">/</span>N),</span>
<span id="cb502-80"><a href="stratification.html#cb502-80" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ns=</span><span class="fu">mean</span>(Ns),</span>
<span id="cb502-81"><a href="stratification.html#cb502-81" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ns1 =</span> <span class="fu">sum</span>(Ds)</span>
<span id="cb502-82"><a href="stratification.html#cb502-82" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb502-83"><a href="stratification.html#cb502-83" aria-hidden="true" tabindex="-1"></a>                <span class="co"># joigning with regression estimates</span></span>
<span id="cb502-84"><a href="stratification.html#cb502-84" aria-hidden="true" tabindex="-1"></a>                <span class="fu">left_join</span>(regSAT,<span class="at">by=</span><span class="st">&#39;strata_type_value&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-85"><a href="stratification.html#cb502-85" aria-hidden="true" tabindex="-1"></a>                <span class="co"># creating variance terms</span></span>
<span id="cb502-86"><a href="stratification.html#cb502-86" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb502-87"><a href="stratification.html#cb502-87" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Var =</span> Ns<span class="sc">*</span>Se<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb502-88"><a href="stratification.html#cb502-88" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb502-89"><a href="stratification.html#cb502-89" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type) <span class="sc">%&gt;%</span></span>
<span id="cb502-90"><a href="stratification.html#cb502-90" aria-hidden="true" tabindex="-1"></a>                <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb502-91"><a href="stratification.html#cb502-91" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb502-92"><a href="stratification.html#cb502-92" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Coef =</span> <span class="fu">map_dbl</span>(data,<span class="sc">~</span><span class="fu">weighted.mean.nest</span>(Coef<span class="sc">~</span>qs,<span class="at">data=</span>.,<span class="at">na.rm=</span><span class="cn">TRUE</span>)),</span>
<span id="cb502-93"><a href="stratification.html#cb502-93" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Var =</span> <span class="fu">map_dbl</span>(data,<span class="sc">~</span><span class="fu">weighted.mean.nest</span>(Var<span class="sc">~</span>qs,<span class="at">data=</span>.,<span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb502-94"><a href="stratification.html#cb502-94" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb502-95"><a href="stratification.html#cb502-95" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb502-96"><a href="stratification.html#cb502-96" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Se =</span> <span class="fu">sqrt</span>(Var<span class="sc">/</span>N)</span>
<span id="cb502-97"><a href="stratification.html#cb502-97" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb502-98"><a href="stratification.html#cb502-98" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(strata_type,Coef,Se) <span class="sc">%&gt;%</span></span>
<span id="cb502-99"><a href="stratification.html#cb502-99" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">Type=</span><span class="st">&#39;SAT&#39;</span>)</span>
<span id="cb502-100"><a href="stratification.html#cb502-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-101"><a href="stratification.html#cb502-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Bugni, Canay and Shaikh correction (adding VH)</span></span>
<span id="cb502-102"><a href="stratification.html#cb502-102" aria-hidden="true" tabindex="-1"></a>regSAT.BCS <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb502-103"><a href="stratification.html#cb502-103" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type,strata_value,strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb502-104"><a href="stratification.html#cb502-104" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarize</span>(</span>
<span id="cb502-105"><a href="stratification.html#cb502-105" aria-hidden="true" tabindex="-1"></a>                  <span class="at">qs =</span> <span class="fu">mean</span>(Ns<span class="sc">/</span>N),</span>
<span id="cb502-106"><a href="stratification.html#cb502-106" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ns=</span><span class="fu">mean</span>(Ns),</span>
<span id="cb502-107"><a href="stratification.html#cb502-107" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ns1 =</span> <span class="fu">sum</span>(Ds)</span>
<span id="cb502-108"><a href="stratification.html#cb502-108" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb502-109"><a href="stratification.html#cb502-109" aria-hidden="true" tabindex="-1"></a>                <span class="co"># joigning with regression estimates</span></span>
<span id="cb502-110"><a href="stratification.html#cb502-110" aria-hidden="true" tabindex="-1"></a>                <span class="fu">left_join</span>(regSAT,<span class="at">by=</span><span class="st">&#39;strata_type_value&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-111"><a href="stratification.html#cb502-111" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>),qs,Coef) <span class="sc">%&gt;%</span></span>
<span id="cb502-112"><a href="stratification.html#cb502-112" aria-hidden="true" tabindex="-1"></a>                <span class="fu">rename</span>(<span class="at">WW=</span>Coef) <span class="sc">%&gt;%</span></span>
<span id="cb502-113"><a href="stratification.html#cb502-113" aria-hidden="true" tabindex="-1"></a>                <span class="fu">left_join</span>(regWW,<span class="at">by=</span><span class="st">&#39;strata_type&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-114"><a href="stratification.html#cb502-114" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>),qs,Coef,WW) <span class="sc">%&gt;%</span></span>
<span id="cb502-115"><a href="stratification.html#cb502-115" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb502-116"><a href="stratification.html#cb502-116" aria-hidden="true" tabindex="-1"></a>                  <span class="at">diffCoefSq =</span> (Coef<span class="sc">-</span>WW)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb502-117"><a href="stratification.html#cb502-117" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb502-118"><a href="stratification.html#cb502-118" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type) <span class="sc">%&gt;%</span></span>
<span id="cb502-119"><a href="stratification.html#cb502-119" aria-hidden="true" tabindex="-1"></a>                <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb502-120"><a href="stratification.html#cb502-120" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb502-121"><a href="stratification.html#cb502-121" aria-hidden="true" tabindex="-1"></a>                  <span class="at">VH =</span> <span class="fu">map_dbl</span>(data,<span class="sc">~</span><span class="fu">weighted.mean.nest</span>(diffCoefSq<span class="sc">~</span>qs,<span class="at">data=</span>.,<span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb502-122"><a href="stratification.html#cb502-122" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb502-123"><a href="stratification.html#cb502-123" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb502-124"><a href="stratification.html#cb502-124" aria-hidden="true" tabindex="-1"></a>                <span class="fu">left_join</span>(regSAT.inter,<span class="at">by=</span><span class="st">&#39;strata_type&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb502-125"><a href="stratification.html#cb502-125" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb502-126"><a href="stratification.html#cb502-126" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Se =</span> <span class="fu">sqrt</span>(Se<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>VH<span class="sc">/</span>N),</span>
<span id="cb502-127"><a href="stratification.html#cb502-127" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Type =</span> <span class="st">&quot;SAT.BCS&quot;</span></span>
<span id="cb502-128"><a href="stratification.html#cb502-128" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb502-129"><a href="stratification.html#cb502-129" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="sc">-</span>VH)</span>
<span id="cb502-130"><a href="stratification.html#cb502-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-131"><a href="stratification.html#cb502-131" aria-hidden="true" tabindex="-1"></a><span class="co"># regrouping</span></span>
<span id="cb502-132"><a href="stratification.html#cb502-132" aria-hidden="true" tabindex="-1"></a>reg <span class="ot">&lt;-</span> <span class="fu">rbind</span>(regWW,regSFE,regSAT.inter,regSAT.BCS)</span></code></pre></div>
<p>Let us now write a function to parallelize these simulations.</p>
<div class="sourceCode" id="cb503"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb503-1"><a href="stratification.html#cb503-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function generating one set of simulated estimates of the WW and SFE estimator under stratification</span></span>
<span id="cb503-2"><a href="stratification.html#cb503-2" aria-hidden="true" tabindex="-1"></a><span class="co"># s: random seed</span></span>
<span id="cb503-3"><a href="stratification.html#cb503-3" aria-hidden="true" tabindex="-1"></a><span class="co"># N: sample size</span></span>
<span id="cb503-4"><a href="stratification.html#cb503-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Nstrata: number of strata (can be a vector)</span></span>
<span id="cb503-5"><a href="stratification.html#cb503-5" aria-hidden="true" tabindex="-1"></a><span class="co"># param: parameter to generate sample</span></span>
<span id="cb503-6"><a href="stratification.html#cb503-6" aria-hidden="true" tabindex="-1"></a>monte.carlo.brute.force.ww.yB.strata <span class="ot">&lt;-</span> <span class="cf">function</span>(s,N,Nstrata,param){</span>
<span id="cb503-7"><a href="stratification.html#cb503-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generating random sample</span></span>
<span id="cb503-8"><a href="stratification.html#cb503-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb503-9"><a href="stratification.html#cb503-9" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb503-10"><a href="stratification.html#cb503-10" aria-hidden="true" tabindex="-1"></a>  UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb503-11"><a href="stratification.html#cb503-11" aria-hidden="true" tabindex="-1"></a>  yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb503-12"><a href="stratification.html#cb503-12" aria-hidden="true" tabindex="-1"></a>  YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb503-13"><a href="stratification.html#cb503-13" aria-hidden="true" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb503-14"><a href="stratification.html#cb503-14" aria-hidden="true" tabindex="-1"></a>  eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb503-15"><a href="stratification.html#cb503-15" aria-hidden="true" tabindex="-1"></a>  U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb503-16"><a href="stratification.html#cb503-16" aria-hidden="true" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb503-17"><a href="stratification.html#cb503-17" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb503-18"><a href="stratification.html#cb503-18" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb503-19"><a href="stratification.html#cb503-19" aria-hidden="true" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb503-20"><a href="stratification.html#cb503-20" aria-hidden="true" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb503-21"><a href="stratification.html#cb503-21" aria-hidden="true" tabindex="-1"></a>  data.strata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">yB=</span>yB,<span class="at">y1=</span>y1,<span class="at">y0=</span>y0) <span class="sc">%&gt;%</span></span>
<span id="cb503-22"><a href="stratification.html#cb503-22" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb503-23"><a href="stratification.html#cb503-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>N</span>
<span id="cb503-24"><a href="stratification.html#cb503-24" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb503-25"><a href="stratification.html#cb503-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generating strata</span></span>
<span id="cb503-26"><a href="stratification.html#cb503-26" aria-hidden="true" tabindex="-1"></a>  strata <span class="ot">&lt;-</span> <span class="fu">map</span>(Nstrata,stratification,<span class="at">var=</span><span class="st">&quot;yB&quot;</span>,<span class="at">data=</span>data.strata) <span class="sc">%&gt;%</span></span>
<span id="cb503-27"><a href="stratification.html#cb503-27" aria-hidden="true" tabindex="-1"></a>              <span class="fu">bind_cols</span>()</span>
<span id="cb503-28"><a href="stratification.html#cb503-28" aria-hidden="true" tabindex="-1"></a>  data.strata <span class="ot">&lt;-</span> <span class="fu">cbind</span>(data.strata,strata)</span>
<span id="cb503-29"><a href="stratification.html#cb503-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># allocating the treatment</span></span>
<span id="cb503-30"><a href="stratification.html#cb503-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># number of strata types</span></span>
<span id="cb503-31"><a href="stratification.html#cb503-31" aria-hidden="true" tabindex="-1"></a>  NStrataTypes <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>)) <span class="sc">%&gt;%</span> <span class="fu">colnames</span>(.) <span class="sc">%&gt;%</span> <span class="fu">length</span>(.)</span>
<span id="cb503-32"><a href="stratification.html#cb503-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb503-33"><a href="stratification.html#cb503-33" aria-hidden="true" tabindex="-1"></a>  data.strata <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb503-34"><a href="stratification.html#cb503-34" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>),<span class="at">names_to =</span> <span class="st">&quot;strata_type&quot;</span>,<span class="at">values_to=</span><span class="st">&quot;strata_value&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-35"><a href="stratification.html#cb503-35" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb503-36"><a href="stratification.html#cb503-36" aria-hidden="true" tabindex="-1"></a>                    <span class="at">strata_type_value =</span> <span class="fu">str_c</span>(strata_type,strata_value,<span class="at">sep=</span><span class="st">&#39;_&#39;</span>),</span>
<span id="cb503-37"><a href="stratification.html#cb503-37" aria-hidden="true" tabindex="-1"></a>                    <span class="at">strata_value =</span> <span class="fu">as.factor</span>(strata_value),</span>
<span id="cb503-38"><a href="stratification.html#cb503-38" aria-hidden="true" tabindex="-1"></a>                    <span class="at">strata_type =</span> <span class="fu">as.factor</span>(strata_type)</span>
<span id="cb503-39"><a href="stratification.html#cb503-39" aria-hidden="true" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span>               </span>
<span id="cb503-40"><a href="stratification.html#cb503-40" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb503-41"><a href="stratification.html#cb503-41" aria-hidden="true" tabindex="-1"></a>                    <span class="at">randU =</span> <span class="fu">runif</span>(N<span class="sc">*</span>NStrataTypes)</span>
<span id="cb503-42"><a href="stratification.html#cb503-42" aria-hidden="true" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb503-43"><a href="stratification.html#cb503-43" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">group_by</span>(strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb503-44"><a href="stratification.html#cb503-44" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb503-45"><a href="stratification.html#cb503-45" aria-hidden="true" tabindex="-1"></a>                    <span class="at">randUMedStrata =</span> stats<span class="sc">::</span><span class="fu">median</span>(randU),</span>
<span id="cb503-46"><a href="stratification.html#cb503-46" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Ds =</span> <span class="fu">case_when</span>(</span>
<span id="cb503-47"><a href="stratification.html#cb503-47" aria-hidden="true" tabindex="-1"></a>                      randU<span class="sc">&lt;</span>randUMedStrata <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb503-48"><a href="stratification.html#cb503-48" aria-hidden="true" tabindex="-1"></a>                      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb503-49"><a href="stratification.html#cb503-49" aria-hidden="true" tabindex="-1"></a>                    ),</span>
<span id="cb503-50"><a href="stratification.html#cb503-50" aria-hidden="true" tabindex="-1"></a>                    <span class="at">y =</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>(<span class="dv">1</span><span class="sc">-</span>Ds)<span class="sc">*</span>y0,</span>
<span id="cb503-51"><a href="stratification.html#cb503-51" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Ns =</span> <span class="fu">n</span>(),</span>
<span id="cb503-52"><a href="stratification.html#cb503-52" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pis =</span> <span class="fu">mean</span>(Ds)</span>
<span id="cb503-53"><a href="stratification.html#cb503-53" aria-hidden="true" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb503-54"><a href="stratification.html#cb503-54" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">arrange</span>(strata_type,Ns,strata_value,randU)</span>
<span id="cb503-55"><a href="stratification.html#cb503-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># estimating the treatment effects</span></span>
<span id="cb503-56"><a href="stratification.html#cb503-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># WW</span></span>
<span id="cb503-57"><a href="stratification.html#cb503-57" aria-hidden="true" tabindex="-1"></a>  regWW <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb503-58"><a href="stratification.html#cb503-58" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(strata_type) <span class="sc">%&gt;%</span></span>
<span id="cb503-59"><a href="stratification.html#cb503-59" aria-hidden="true" tabindex="-1"></a>          <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb503-60"><a href="stratification.html#cb503-60" aria-hidden="true" tabindex="-1"></a>         <span class="co"># rowwise(.) %&gt;%</span></span>
<span id="cb503-61"><a href="stratification.html#cb503-61" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb503-62"><a href="stratification.html#cb503-62" aria-hidden="true" tabindex="-1"></a>            <span class="at">reg =</span> <span class="fu">map</span>(data,<span class="sc">~</span><span class="fu">feols</span>(y<span class="sc">~</span>Ds<span class="sc">|</span><span class="dv">1</span>,<span class="at">vcov=</span><span class="st">&quot;HC1&quot;</span>,<span class="at">data=</span>.)),</span>
<span id="cb503-63"><a href="stratification.html#cb503-63" aria-hidden="true" tabindex="-1"></a>            <span class="at">tidied =</span> <span class="fu">map</span>(reg,tidy)</span>
<span id="cb503-64"><a href="stratification.html#cb503-64" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb503-65"><a href="stratification.html#cb503-65" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span></span>
<span id="cb503-66"><a href="stratification.html#cb503-66" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&#39;Ds&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-67"><a href="stratification.html#cb503-67" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(</span>
<span id="cb503-68"><a href="stratification.html#cb503-68" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coef =</span> estimate,</span>
<span id="cb503-69"><a href="stratification.html#cb503-69" aria-hidden="true" tabindex="-1"></a>            <span class="at">Se =</span> std.error</span>
<span id="cb503-70"><a href="stratification.html#cb503-70" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb503-71"><a href="stratification.html#cb503-71" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(strata_type,Coef,Se)<span class="sc">%&gt;%</span></span>
<span id="cb503-72"><a href="stratification.html#cb503-72" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">Type=</span><span class="st">&#39;WW&#39;</span>)</span>
<span id="cb503-73"><a href="stratification.html#cb503-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># strata fixed effects</span></span>
<span id="cb503-74"><a href="stratification.html#cb503-74" aria-hidden="true" tabindex="-1"></a>  regSFE <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb503-75"><a href="stratification.html#cb503-75" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(strata_type<span class="sc">!=</span><span class="st">&#39;strata_1&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-76"><a href="stratification.html#cb503-76" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(strata_type) <span class="sc">%&gt;%</span></span>
<span id="cb503-77"><a href="stratification.html#cb503-77" aria-hidden="true" tabindex="-1"></a>          <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb503-78"><a href="stratification.html#cb503-78" aria-hidden="true" tabindex="-1"></a>         <span class="co"># rowwise(.) %&gt;%</span></span>
<span id="cb503-79"><a href="stratification.html#cb503-79" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb503-80"><a href="stratification.html#cb503-80" aria-hidden="true" tabindex="-1"></a>            <span class="at">reg =</span> <span class="fu">map</span>(data,<span class="sc">~</span><span class="fu">feols</span>(y<span class="sc">~</span>Ds<span class="sc">|</span>strata_value,<span class="at">vcov=</span><span class="st">&quot;HC1&quot;</span>,<span class="at">data=</span>.)),</span>
<span id="cb503-81"><a href="stratification.html#cb503-81" aria-hidden="true" tabindex="-1"></a>            <span class="at">tidied =</span> <span class="fu">map</span>(reg,tidy)</span>
<span id="cb503-82"><a href="stratification.html#cb503-82" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb503-83"><a href="stratification.html#cb503-83" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span></span>
<span id="cb503-84"><a href="stratification.html#cb503-84" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&#39;Ds&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-85"><a href="stratification.html#cb503-85" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(</span>
<span id="cb503-86"><a href="stratification.html#cb503-86" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coef =</span> estimate,</span>
<span id="cb503-87"><a href="stratification.html#cb503-87" aria-hidden="true" tabindex="-1"></a>            <span class="at">Se =</span> std.error</span>
<span id="cb503-88"><a href="stratification.html#cb503-88" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb503-89"><a href="stratification.html#cb503-89" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(strata_type,Coef,Se) <span class="sc">%&gt;%</span></span>
<span id="cb503-90"><a href="stratification.html#cb503-90" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">Type=</span><span class="st">&#39;SFE&#39;</span>)</span>
<span id="cb503-91"><a href="stratification.html#cb503-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb503-92"><a href="stratification.html#cb503-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fully staturated model </span></span>
<span id="cb503-93"><a href="stratification.html#cb503-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run a regression in each strata</span></span>
<span id="cb503-94"><a href="stratification.html#cb503-94" aria-hidden="true" tabindex="-1"></a>  regSAT <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb503-95"><a href="stratification.html#cb503-95" aria-hidden="true" tabindex="-1"></a>  <span class="co">#          filter(strata_type!=&#39;strata_1&#39;) %&gt;%</span></span>
<span id="cb503-96"><a href="stratification.html#cb503-96" aria-hidden="true" tabindex="-1"></a>            <span class="fu">group_by</span>(strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb503-97"><a href="stratification.html#cb503-97" aria-hidden="true" tabindex="-1"></a>            <span class="co"># generating the number of treated observations in each strata</span></span>
<span id="cb503-98"><a href="stratification.html#cb503-98" aria-hidden="true" tabindex="-1"></a>            <span class="co"># and the proportion of observations in each strata</span></span>
<span id="cb503-99"><a href="stratification.html#cb503-99" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb503-100"><a href="stratification.html#cb503-100" aria-hidden="true" tabindex="-1"></a>              <span class="at">Ns1 =</span> <span class="fu">sum</span>(Ds),</span>
<span id="cb503-101"><a href="stratification.html#cb503-101" aria-hidden="true" tabindex="-1"></a>              <span class="at">qs =</span> Ns<span class="sc">/</span>N</span>
<span id="cb503-102"><a href="stratification.html#cb503-102" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb503-103"><a href="stratification.html#cb503-103" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(Ns1<span class="sc">&gt;</span><span class="dv">1</span>,N<span class="sc">-</span>Ns1<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-104"><a href="stratification.html#cb503-104" aria-hidden="true" tabindex="-1"></a>          <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb503-105"><a href="stratification.html#cb503-105" aria-hidden="true" tabindex="-1"></a>         <span class="co"># rowwise(.) %&gt;%</span></span>
<span id="cb503-106"><a href="stratification.html#cb503-106" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb503-107"><a href="stratification.html#cb503-107" aria-hidden="true" tabindex="-1"></a>           <span class="at">reg =</span> <span class="fu">map</span>(data,<span class="sc">~</span><span class="fu">feols</span>(y<span class="sc">~</span>Ds<span class="sc">|</span><span class="dv">1</span>,<span class="at">vcov=</span><span class="st">&quot;HC1&quot;</span>,<span class="at">data=</span>.)),</span>
<span id="cb503-108"><a href="stratification.html#cb503-108" aria-hidden="true" tabindex="-1"></a>           <span class="at">tidied =</span> <span class="fu">map</span>(reg,tidy)</span>
<span id="cb503-109"><a href="stratification.html#cb503-109" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb503-110"><a href="stratification.html#cb503-110" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span></span>
<span id="cb503-111"><a href="stratification.html#cb503-111" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&#39;Ds&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-112"><a href="stratification.html#cb503-112" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(</span>
<span id="cb503-113"><a href="stratification.html#cb503-113" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coef =</span> estimate,</span>
<span id="cb503-114"><a href="stratification.html#cb503-114" aria-hidden="true" tabindex="-1"></a>            <span class="at">Se =</span> std.error</span>
<span id="cb503-115"><a href="stratification.html#cb503-115" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb503-116"><a href="stratification.html#cb503-116" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(strata_type_value,Coef,Se) </span>
<span id="cb503-117"><a href="stratification.html#cb503-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb503-118"><a href="stratification.html#cb503-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># averaging back using strata proportions</span></span>
<span id="cb503-119"><a href="stratification.html#cb503-119" aria-hidden="true" tabindex="-1"></a>  regSAT.inter <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb503-120"><a href="stratification.html#cb503-120" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">group_by</span>(strata_type,strata_value,strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb503-121"><a href="stratification.html#cb503-121" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">summarize</span>(</span>
<span id="cb503-122"><a href="stratification.html#cb503-122" aria-hidden="true" tabindex="-1"></a>                    <span class="at">qs =</span> <span class="fu">mean</span>(Ns<span class="sc">/</span>N),</span>
<span id="cb503-123"><a href="stratification.html#cb503-123" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Ns=</span><span class="fu">mean</span>(Ns),</span>
<span id="cb503-124"><a href="stratification.html#cb503-124" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Ns1 =</span> <span class="fu">sum</span>(Ds)</span>
<span id="cb503-125"><a href="stratification.html#cb503-125" aria-hidden="true" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb503-126"><a href="stratification.html#cb503-126" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># joigning with regression estimates</span></span>
<span id="cb503-127"><a href="stratification.html#cb503-127" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">left_join</span>(regSAT,<span class="at">by=</span><span class="st">&#39;strata_type_value&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-128"><a href="stratification.html#cb503-128" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># creating variance</span></span>
<span id="cb503-129"><a href="stratification.html#cb503-129" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb503-130"><a href="stratification.html#cb503-130" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Var =</span> Se<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>Ns</span>
<span id="cb503-131"><a href="stratification.html#cb503-131" aria-hidden="true" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb503-132"><a href="stratification.html#cb503-132" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">group_by</span>(strata_type) <span class="sc">%&gt;%</span></span>
<span id="cb503-133"><a href="stratification.html#cb503-133" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb503-134"><a href="stratification.html#cb503-134" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb503-135"><a href="stratification.html#cb503-135" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Coef =</span> <span class="fu">map_dbl</span>(data,<span class="sc">~</span><span class="fu">weighted.mean.nest</span>(Coef<span class="sc">~</span>qs,<span class="at">data=</span>.,<span class="at">na.rm=</span><span class="cn">TRUE</span>)),</span>
<span id="cb503-136"><a href="stratification.html#cb503-136" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Var =</span> <span class="fu">map_dbl</span>(data,<span class="sc">~</span><span class="fu">weighted.mean.nest</span>(Var<span class="sc">~</span>qs,<span class="at">data=</span>.,<span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb503-137"><a href="stratification.html#cb503-137" aria-hidden="true" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb503-138"><a href="stratification.html#cb503-138" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb503-139"><a href="stratification.html#cb503-139" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Se =</span> <span class="fu">sqrt</span>(Var<span class="sc">/</span>N)</span>
<span id="cb503-140"><a href="stratification.html#cb503-140" aria-hidden="true" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb503-141"><a href="stratification.html#cb503-141" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">select</span>(strata_type,Coef,Se) <span class="sc">%&gt;%</span></span>
<span id="cb503-142"><a href="stratification.html#cb503-142" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">Type=</span><span class="st">&#39;SAT&#39;</span>)</span>
<span id="cb503-143"><a href="stratification.html#cb503-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb503-144"><a href="stratification.html#cb503-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bugni, Canay and Shaikh correction (adding VH)</span></span>
<span id="cb503-145"><a href="stratification.html#cb503-145" aria-hidden="true" tabindex="-1"></a>  regSAT.BCS <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb503-146"><a href="stratification.html#cb503-146" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type,strata_value,strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb503-147"><a href="stratification.html#cb503-147" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarize</span>(</span>
<span id="cb503-148"><a href="stratification.html#cb503-148" aria-hidden="true" tabindex="-1"></a>                  <span class="at">qs =</span> <span class="fu">mean</span>(Ns<span class="sc">/</span>N),</span>
<span id="cb503-149"><a href="stratification.html#cb503-149" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ns=</span><span class="fu">mean</span>(Ns),</span>
<span id="cb503-150"><a href="stratification.html#cb503-150" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ns1 =</span> <span class="fu">sum</span>(Ds)</span>
<span id="cb503-151"><a href="stratification.html#cb503-151" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb503-152"><a href="stratification.html#cb503-152" aria-hidden="true" tabindex="-1"></a>                <span class="co"># joigning with regression estimates</span></span>
<span id="cb503-153"><a href="stratification.html#cb503-153" aria-hidden="true" tabindex="-1"></a>                <span class="fu">left_join</span>(regSAT,<span class="at">by=</span><span class="st">&#39;strata_type_value&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-154"><a href="stratification.html#cb503-154" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>),qs,Coef) <span class="sc">%&gt;%</span></span>
<span id="cb503-155"><a href="stratification.html#cb503-155" aria-hidden="true" tabindex="-1"></a>                <span class="fu">rename</span>(<span class="at">WW=</span>Coef) <span class="sc">%&gt;%</span></span>
<span id="cb503-156"><a href="stratification.html#cb503-156" aria-hidden="true" tabindex="-1"></a>                <span class="fu">left_join</span>(regWW,<span class="at">by=</span><span class="st">&#39;strata_type&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-157"><a href="stratification.html#cb503-157" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>),qs,Coef,WW) <span class="sc">%&gt;%</span></span>
<span id="cb503-158"><a href="stratification.html#cb503-158" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb503-159"><a href="stratification.html#cb503-159" aria-hidden="true" tabindex="-1"></a>                  <span class="at">diffCoefSq =</span> (Coef<span class="sc">-</span>WW)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb503-160"><a href="stratification.html#cb503-160" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb503-161"><a href="stratification.html#cb503-161" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata_type) <span class="sc">%&gt;%</span></span>
<span id="cb503-162"><a href="stratification.html#cb503-162" aria-hidden="true" tabindex="-1"></a>                <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb503-163"><a href="stratification.html#cb503-163" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb503-164"><a href="stratification.html#cb503-164" aria-hidden="true" tabindex="-1"></a>                  <span class="at">VH =</span> <span class="fu">map_dbl</span>(data,<span class="sc">~</span><span class="fu">weighted.mean.nest</span>(diffCoefSq<span class="sc">~</span>qs,<span class="at">data=</span>.,<span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb503-165"><a href="stratification.html#cb503-165" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb503-166"><a href="stratification.html#cb503-166" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="sc">-</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb503-167"><a href="stratification.html#cb503-167" aria-hidden="true" tabindex="-1"></a>                <span class="fu">left_join</span>(regSAT.inter,<span class="at">by=</span><span class="st">&#39;strata_type&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-168"><a href="stratification.html#cb503-168" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb503-169"><a href="stratification.html#cb503-169" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Se =</span> <span class="fu">sqrt</span>(Se<span class="sc">^</span><span class="dv">2</span><span class="sc">+</span>VH<span class="sc">/</span>N),</span>
<span id="cb503-170"><a href="stratification.html#cb503-170" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Type =</span> <span class="st">&quot;SAT.BCS&quot;</span></span>
<span id="cb503-171"><a href="stratification.html#cb503-171" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb503-172"><a href="stratification.html#cb503-172" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="sc">-</span>VH)</span>
<span id="cb503-173"><a href="stratification.html#cb503-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-174"><a href="stratification.html#cb503-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># regrouping</span></span>
<span id="cb503-175"><a href="stratification.html#cb503-175" aria-hidden="true" tabindex="-1"></a>  reg <span class="ot">&lt;-</span> <span class="fu">rbind</span>(regWW,regSFE,regSAT.inter,regSAT.BCS)</span>
<span id="cb503-176"><a href="stratification.html#cb503-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># adding the SFE estimator for strata 1</span></span>
<span id="cb503-177"><a href="stratification.html#cb503-177" aria-hidden="true" tabindex="-1"></a>  regStrata1 <span class="ot">&lt;-</span> reg <span class="sc">%&gt;%</span></span>
<span id="cb503-178"><a href="stratification.html#cb503-178" aria-hidden="true" tabindex="-1"></a>                <span class="fu">filter</span>(strata_type<span class="sc">==</span><span class="st">&#39;strata_1&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb503-179"><a href="stratification.html#cb503-179" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb503-180"><a href="stratification.html#cb503-180" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Type=</span><span class="st">&quot;SFE&quot;</span></span>
<span id="cb503-181"><a href="stratification.html#cb503-181" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb503-182"><a href="stratification.html#cb503-182" aria-hidden="true" tabindex="-1"></a>  reg <span class="ot">&lt;-</span> <span class="fu">rbind</span>(reg,regStrata1) <span class="sc">%&gt;%</span></span>
<span id="cb503-183"><a href="stratification.html#cb503-183" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mutate</span>(</span>
<span id="cb503-184"><a href="stratification.html#cb503-184" aria-hidden="true" tabindex="-1"></a>           <span class="at">IdSim=</span>s</span>
<span id="cb503-185"><a href="stratification.html#cb503-185" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb503-186"><a href="stratification.html#cb503-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(reg)</span>
<span id="cb503-187"><a href="stratification.html#cb503-187" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb503-188"><a href="stratification.html#cb503-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-189"><a href="stratification.html#cb503-189" aria-hidden="true" tabindex="-1"></a>simuls.brute.force.ww.yB.N.strata <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,Nstrata,param){</span>
<span id="cb503-190"><a href="stratification.html#cb503-190" aria-hidden="true" tabindex="-1"></a><span class="co">#  simuls.brute.force.ww.yB.N.strata &lt;- as.data.frame(matrix(unlist(lapply(1:Nsim,monte.carlo.brute.force.ww.yB.strata,N=N,param=param,Nstrata=Nstrata)),nrow=2*length(Nstrata)*Nsim,ncol=5,byrow=TRUE))</span></span>
<span id="cb503-191"><a href="stratification.html#cb503-191" aria-hidden="true" tabindex="-1"></a>  simuls.brute.force.ww.yB.N.strata <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.brute.force.ww.yB.strata,<span class="at">N=</span>N,<span class="at">param=</span>param,<span class="at">Nstrata=</span>Nstrata) <span class="sc">%&gt;%</span></span>
<span id="cb503-192"><a href="stratification.html#cb503-192" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">bind_rows</span>(.)</span>
<span id="cb503-193"><a href="stratification.html#cb503-193" aria-hidden="true" tabindex="-1"></a><span class="co">#  colnames(simuls.brute.force.ww.yB.N.strata) &lt;- c(&#39;strata_type&#39;,&#39;Coef&#39;,&#39;Se&#39;,&#39;Type&#39;,&#39;IdSim&#39;)</span></span>
<span id="cb503-194"><a href="stratification.html#cb503-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(simuls.brute.force.ww.yB.N.strata)</span>
<span id="cb503-195"><a href="stratification.html#cb503-195" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb503-196"><a href="stratification.html#cb503-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-197"><a href="stratification.html#cb503-197" aria-hidden="true" tabindex="-1"></a>sf.simuls.brute.force.ww.yB.N.strata <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,Nstrata,param,ncpus){</span>
<span id="cb503-198"><a href="stratification.html#cb503-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span>ncpus)</span>
<span id="cb503-199"><a href="stratification.html#cb503-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sfExport</span>(<span class="st">&#39;stratification&#39;</span>)</span>
<span id="cb503-200"><a href="stratification.html#cb503-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sfExport</span>(<span class="st">&#39;weighted.mean.nest&#39;</span>)</span>
<span id="cb503-201"><a href="stratification.html#cb503-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(tidyverse)</span>
<span id="cb503-202"><a href="stratification.html#cb503-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(stats)</span>
<span id="cb503-203"><a href="stratification.html#cb503-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(fixest)</span>
<span id="cb503-204"><a href="stratification.html#cb503-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(broom)</span>
<span id="cb503-205"><a href="stratification.html#cb503-205" aria-hidden="true" tabindex="-1"></a><span class="co">#  sim &lt;- as.data.frame(matrix(unlist(sfLapply(1:Nsim,monte.carlo.brute.force.ww.yB.strata,N=N,param=param,Nstrata=Nstrata)),nrow=2*length(Nstrata)*Nsim,ncol=5,byrow=TRUE))</span></span>
<span id="cb503-206"><a href="stratification.html#cb503-206" aria-hidden="true" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.brute.force.ww.yB.strata,<span class="at">N=</span>N,<span class="at">param=</span>param,<span class="at">Nstrata=</span>Nstrata) <span class="sc">%&gt;%</span></span>
<span id="cb503-207"><a href="stratification.html#cb503-207" aria-hidden="true" tabindex="-1"></a>         <span class="fu">bind_rows</span>(.)</span>
<span id="cb503-208"><a href="stratification.html#cb503-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb503-209"><a href="stratification.html#cb503-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb503-210"><a href="stratification.html#cb503-210" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb503-211"><a href="stratification.html#cb503-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-212"><a href="stratification.html#cb503-212" aria-hidden="true" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb503-213"><a href="stratification.html#cb503-213" aria-hidden="true" tabindex="-1"></a><span class="co">#Nsim &lt;- 10</span></span>
<span id="cb503-214"><a href="stratification.html#cb503-214" aria-hidden="true" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000,100000)</span></span>
<span id="cb503-215"><a href="stratification.html#cb503-215" aria-hidden="true" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000)</span></span>
<span id="cb503-216"><a href="stratification.html#cb503-216" aria-hidden="true" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000)</span></span>
<span id="cb503-217"><a href="stratification.html#cb503-217" aria-hidden="true" tabindex="-1"></a>N.sample <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1000</span>)</span>
<span id="cb503-218"><a href="stratification.html#cb503-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-219"><a href="stratification.html#cb503-219" aria-hidden="true" tabindex="-1"></a>Nstrata <span class="ot">&lt;-</span> k.vec</span>
<span id="cb503-220"><a href="stratification.html#cb503-220" aria-hidden="true" tabindex="-1"></a><span class="co">#test &lt;- simuls.brute.force.ww.yB.N.strata(N=N.sample,Nsim=Nsim,Nstrata=Nstrata,param=param)</span></span>
<span id="cb503-221"><a href="stratification.html#cb503-221" aria-hidden="true" tabindex="-1"></a>simuls.brute.force.ww.yB.strata <span class="ot">&lt;-</span> <span class="fu">lapply</span>(N.sample,sf.simuls.brute.force.ww.yB.N.strata,<span class="at">Nsim=</span>Nsim,<span class="at">Nstrata=</span>Nstrata,<span class="at">param=</span>param,<span class="at">ncpus=</span><span class="dv">2</span><span class="sc">*</span>ncpus)</span></code></pre></div>
<pre><code>## Library tidyverse loaded.
## Library stats loaded.
## Library fixest loaded.
## Library broom loaded.</code></pre>
<div class="sourceCode" id="cb505"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb505-1"><a href="stratification.html#cb505-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(simuls.brute.force.ww.yB.strata) <span class="ot">&lt;-</span> N.sample</span></code></pre></div>
<p>Let us now check the results.</p>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb506-1"><a href="stratification.html#cb506-1" aria-hidden="true" tabindex="-1"></a>SummaryStrata <span class="ot">&lt;-</span> simuls.brute.force.ww.yB.strata[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb506-2"><a href="stratification.html#cb506-2" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">group_by</span>(strata_type,Type) <span class="sc">%&gt;%</span></span>
<span id="cb506-3"><a href="stratification.html#cb506-3" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">summarize</span>(</span>
<span id="cb506-4"><a href="stratification.html#cb506-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">MeanCoef =</span> <span class="fu">mean</span>(Coef,<span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb506-5"><a href="stratification.html#cb506-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">SdCoef =</span> <span class="fu">sd</span>(Coef,<span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb506-6"><a href="stratification.html#cb506-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">MeanSe =</span> <span class="fu">mean</span>(Se,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb506-7"><a href="stratification.html#cb506-7" aria-hidden="true" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb506-8"><a href="stratification.html#cb506-8" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb506-9"><a href="stratification.html#cb506-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">strata_size =</span> <span class="fu">str_split_fixed</span>(strata_type,<span class="st">&#39;</span><span class="sc">\\</span><span class="st">_&#39;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">2</span>],</span>
<span id="cb506-10"><a href="stratification.html#cb506-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">strata_size =</span> <span class="fu">factor</span>(strata_size,<span class="at">levels=</span>k.vec),</span>
<span id="cb506-11"><a href="stratification.html#cb506-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">strata_type =</span> <span class="fu">factor</span>(strata_type,<span class="at">levels=</span><span class="fu">paste</span>(<span class="st">&#39;strata&#39;</span>,k.vec,<span class="at">sep=</span><span class="st">&#39;_&#39;</span>)),</span>
<span id="cb506-12"><a href="stratification.html#cb506-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ATE =</span> <span class="fu">delta.y.ate</span>(param),</span>
<span id="cb506-13"><a href="stratification.html#cb506-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Type =</span> <span class="fu">factor</span>(Type,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;WW&#39;</span>,<span class="st">&#39;SFE&#39;</span>,<span class="st">&#39;SAT&#39;</span>,<span class="st">&#39;SAT.BCS&#39;</span>))</span>
<span id="cb506-14"><a href="stratification.html#cb506-14" aria-hidden="true" tabindex="-1"></a>                  )</span></code></pre></div>
<div class="sourceCode" id="cb507"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb507-1"><a href="stratification.html#cb507-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(SummaryStrata <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Type<span class="sc">!=</span><span class="st">&#39;SAT.BCS&#39;</span>),<span class="fu">aes</span>(<span class="at">x=</span>strata_size,<span class="at">y=</span>MeanCoef,<span class="at">color=</span>Type,<span class="at">shape=</span>Type))<span class="sc">+</span></span>
<span id="cb507-2"><a href="stratification.html#cb507-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(binwidth=.01, alpha=0.5,position=&#39;identity&#39;) +</span></span>
<span id="cb507-3"><a href="stratification.html#cb507-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_density(alpha=0.3)+</span></span>
<span id="cb507-4"><a href="stratification.html#cb507-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_bar(stat=&#39;identity&#39;,position=position_dodge())+</span></span>
<span id="cb507-5"><a href="stratification.html#cb507-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>MeanCoef<span class="fl">-1.96</span><span class="sc">*</span>SdCoef,<span class="at">ymax=</span>MeanCoef<span class="fl">+1.96</span><span class="sc">*</span>SdCoef,<span class="at">color=</span>Type,<span class="at">shape=</span>Type),<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.2</span>))<span class="sc">+</span></span>
<span id="cb507-6"><a href="stratification.html#cb507-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept=</span>ATE),<span class="at">color=</span><span class="st">&#39;red&#39;</span>,<span class="at">linetype=</span><span class="st">&#39;dotted&#39;</span>) <span class="sc">+</span></span>
<span id="cb507-7"><a href="stratification.html#cb507-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb507-8"><a href="stratification.html#cb507-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;Number of strata&#39;</span>)<span class="sc">+</span></span>
<span id="cb507-9"><a href="stratification.html#cb507-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:montecarlobruteforcewwyBStrataPlot"></span>
<img src="STCI_files/figure-html/montecarlobruteforcewwyBStrataPlot-1.png" alt="Distribution of estimators under various levels of stratification" width="60%" />
<p class="caption">
Figure 16.3: Distribution of estimators under various levels of stratification
</p>
</div>
<p>Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataPlot">16.3</a> clearly shows that stratification can increase precision.
For the <span class="math inline">\(WW\)</span> estimator, 99% sampling noise moves from 0.29 with one strata to 0.1 with 50 strata.</p>
</div>
<div id="estimating-treatment-effects-with-stratified-randomized-controlled-trials" class="section level3 hasAnchor" number="16.1.2">
<h3><span class="header-section-number">16.1.2</span> Estimating treatment effects with stratified randomized controlled trials<a href="stratification.html#estimating-treatment-effects-with-stratified-randomized-controlled-trials" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>There are several ways to estimate average treatment effects under stratification.
We have seen two un our example: the simple <span class="math inline">\(WW\)</span> estimator and the strata fixed effects estimator.
We are going to see that we could also use a fully saturated model, that in general, is not necessary, except when the target proportion of treated individuals changes with strata.
Finally, we will study the precision weighted estimator, which is an instance of a meta-analytic estimator.</p>
<div id="using-the-ww-estimator-3" class="section level4 hasAnchor" number="16.1.2.1">
<h4><span class="header-section-number">16.1.2.1</span> Using the <span class="math inline">\(WW\)</span> estimator<a href="stratification.html#using-the-ww-estimator-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The <span class="math inline">\(WW\)</span> estimator simply compares the mean outcome of the treated and untreated individuals.
As we have already seen in Chapter <a href="RCT.html#RCT">3</a>, this estimator can be computed using a simple OLS regression.
We know thanks to Theorem <a href="RCT.html#thm:BFATE">3.1</a> that the <span class="math inline">\(WW\)</span> estimator is consistent under randomization, whatever the randomization device.</p>
<div class="remark">
<p><span id="unlabeled-div-302" class="remark"><em>Remark</em>. </span>There is confusion as to whether this estimator will reflect the increase in precision brought about by stratification.
Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataPlot">16.3</a> shows that it is indeed the case: the precision of the <span class="math inline">\(WW\)</span> estimator increases with the number of strata (up to 25 to 50 strata at least).
Intuitively, this makes sense since the sample on which the <span class="math inline">\(WW\)</span> estimator is estimated is already balanced on the observed characteristics used for stratification, and therefore its distribution is less affected by imbalances in these observed factors.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-303" class="remark"><em>Remark</em>. </span>A different question is whether the default estimators of sampling noise of the <span class="math inline">\(WW\)</span> estimator reflect the true extent of sampling noise, and especially are able to reflect the increase in precision due to stratification.
The answer is in general no, and we will study estimators of sampling noise in the next section.</p>
</div>
</div>
<div id="using-the-strata-fixed-effects-estimator" class="section level4 hasAnchor" number="16.1.2.2">
<h4><span class="header-section-number">16.1.2.2</span> Using the strata fixed effects estimator<a href="stratification.html#using-the-strata-fixed-effects-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The strata fixed effects estimator is defined as the OLS estimate of <span class="math inline">\(\beta^{SFE}\)</span> in the following regression:</p>
<p><span class="math display">\[\begin{align*}
  Y_i &amp; = \sum_{s\in\mathcal{S}}\alpha^{SFE}_s\uns{\mathbf{s}(i)=s}+\beta^{SFE}R_i + \epsilon^{SFE}_i,
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\mathbf{s}(i)\)</span> associates to each observation <span class="math inline">\(i\)</span> in the sample the strata <span class="math inline">\(s\)</span> to which it belongs.
Conversely, and for later uses, <span class="math inline">\(\mathcal{I}_s\)</span> is the set of units that belong to strata <span class="math inline">\(s\)</span>.</p>
<p>What does <span class="math inline">\(\beta^{SFE}\)</span> estimate?
We can first show that it is a weighted average of strata-level <span class="math inline">\(WW\)</span> comparisons.
For that, we need a slightly stronger assumption as the usual full rank assumption we have been using to analyze RCTs:</p>
<div class="hypothesis">
<p><span id="hyp:fullrankStrata" class="hypothesis"><strong>Hypothesis 16.1  (Full rank within strata) </strong></span>We assume that there is at least one observation in each strata that receives the treatment and one observation that does not receive it:
<span class="math display">\[\begin{align*}
\forall s \in \mathcal{S}, \exists i,j\in \mathcal{I}_s \text{ such that } &amp; D_i=1 \&amp; D_j=0.
\end{align*}\]</span></p>
</div>
<div class="theorem">
<p><span id="thm:SFEdecomp" class="theorem"><strong>Theorem 16.1  (Decomposing the strata fixed effects estimator) </strong></span>Under Assumption <a href="stratification.html#hyp:fullrankStrata">16.1</a>, the strata fixed effects estimator is a weighted average of strata-level <span class="math inline">\(WW\)</span> estimators:</p>
<p><span class="math display">\[\begin{align*}
    \hat{\beta}^{SFE}  &amp; = \sum_{s\in\mathcal{S}}w^{SFE}_s\hat{\Delta}^Y_{WW_s}\\
    \hat{\Delta}^Y_{WW_s} &amp; =\frac{\sum_{i:\mathbf{s}(i)=s}R_iY_i}{\sum_{i:\mathbf{s}(i)=s}R_i}-\frac{\sum_{i:\mathbf{s}(i)=s}(1-R_i)Y_i}{1-\sum_{i:\mathbf{s}(i)=s}R_i}\\
    w^{SFE}_s &amp; = \frac{N_s\bar{R}_s(1-\bar{R}_s)}{\sum_{s\in\mathcal{S}}N_s\bar{R}_s(1-\bar{R}_s)} 
  \end{align*}\]</span></p>
<p>with <span class="math inline">\(\bar{R}_s=\frac{1}{N_s}\sum_{i:\mathbf{s}(i)=s}R_i\)</span> and <span class="math inline">\(N_s\)</span> is the size of strata <span class="math inline">\(s\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-304" class="proof"><em>Proof</em>. </span>See in Appendix <a href="proofs.html#proofSFEdecomp">A.7.1</a>.</p>
</div>
<p>In order to prove the consistency of the strata fixed effects estimator, we need to slightly alter the usual independence assumption so that it reflects the fact that randomization occurs within each strata:</p>
<div class="hypothesis">
<p><span id="hyp:independenceStrata" class="hypothesis"><strong>Hypothesis 16.2  (Independence within strata) </strong></span>We assume that the allocation of the program is independent of potential outcomes within each strata:
<span class="math display">\[\begin{align*}
  R_i\Ind(Y_i^0,Y_i^1)|\mathbf{s}(i).
\end{align*}\]</span></p>
</div>
<p>We can now prove the consistency of the strata fixed effects estimator:</p>
<div class="theorem">
<p><span id="thm:SFEconsistent" class="theorem"><strong>Theorem 16.2  (Consistency of the strata fixed effects estimator) </strong></span>Under Assumptions <a href="stratification.html#hyp:independenceStrata">16.2</a>, <a href="RCT.html#def:BF">3.2</a> and <a href="stratification.html#hyp:fullrankStrata">16.1</a>, the strata fixed effects estimator is a consistent estimator of the Average Treatment Effect:</p>
<p><span class="math display">\[\begin{align*}
    \plims\hat{\beta}^{SFE} &amp; = \Delta^Y_{ATE}.
  \end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-305" class="proof"><em>Proof</em>. </span>See in Appendix <a href="proofs.html#proofSFEconsistent">A.7.2</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-306" class="remark"><em>Remark</em>. </span>Note that Theorem <a href="stratification.html#thm:SFEconsistent">16.2</a> does not prove that the strata fixed effects estimator is unbiased.
I am very close to proving that using an approach similar to the one developed in the proof of Lemma <a href="proofs.html#lem:unbiasww">A.1</a>.
One thing that makes me fail in completing the proof is that the weights <span class="math inline">\(w_s\)</span> are not independent of each other, neither is the numerator and denominator of each of them (because they share one strata in the denominator).
Assuming this away (because each strata is small relative to the others) enables to prove unbiasedness.
I am not aware of a general proof of unbiasedness for the strata fixed effects estimator.
Let me know if you can find one.</p>
</div>
</div>
<div id="using-the-fully-saturated-estimator" class="section level4 hasAnchor" number="16.1.2.3">
<h4><span class="header-section-number">16.1.2.3</span> Using the fully saturated estimator<a href="stratification.html#using-the-fully-saturated-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A natural approach, similar to the one we used with DID with staggered designs in Section <a href="NE.html#DIDStaggered">4.3.3</a>, is to estimate a treatment effect within each strata, and then to take a weighted average of these estimates with the appropriate weights in order to recover an adequate average treatment effect.
This approach is akin to estimating a fully saturated model, since each strata has its own separate set of intercept and slope.
The way we implement this estimator is by estimating the following model by OLS:</p>
<p><span class="math display">\[\begin{align*}
  Y_i &amp; = \sum_{s\in\mathcal{S}}\alpha^{SAT}_s\uns{\mathbf{s}(i)=s}+\sum_{s\in\mathcal{S}}\beta_s^{SAT}\uns{\mathbf{s}(i)=s}R_i + \epsilon^{SAT}_i,
\end{align*}\]</span></p>
<p>and then to reaggregate the individual strata estimates using the proportion of the observations that lie in each strata:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{SAT} &amp; = \sum_{s\in\mathcal{S}}w^{SAT}_s\beta_s^{SAT}\\
  w^{SAT}_s &amp; = \frac{N_s}{N}.
\end{align*}\]</span></p>
<p>We can prove the following result:</p>
<div class="theorem">
<p><span id="thm:SATUnbiasedConsistent" class="theorem"><strong>Theorem 16.3  (Unbiasedness and consistency of the fully saturated model) </strong></span>Under Assumptions <a href="RCT.html#def:independence">3.1</a>, <a href="RCT.html#def:BF">3.2</a> and <a href="stratification.html#hyp:fullrankStrata">16.1</a>, the fully saturated model is an unbiased and consistent estimator of the Average Treatment Effect:</p>
<p><span class="math display">\[\begin{align*}
    \esp{\hat{\Delta}^{Y}_{SAT}} &amp; = \Delta^Y_{ATE}\\
    \plims\hat{\Delta}^{Y}_{SAT} &amp; = \Delta^Y_{ATE}.
  \end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-307" class="proof"><em>Proof</em>. </span>See in Appendix <a href="proofs.html#proofSATUnbiasedConsistent">A.7.3</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-308" class="remark"><em>Remark</em>. </span><a href="https://www.cambridge.org/core/books/causal-inference-for-statistics-social-and-biomedical-sciences/71126BE90C58F1A431FE9B2DD07938AB">Imbens and Rubin (2015)</a> define the fully saturated model as follows:</p>
<p><span class="math display">\[\begin{align*}
  Y_i &amp; = \sum_{s\in\mathcal{S}}\alpha^{SAT}_s\uns{\mathbf{s}(i)=s}+\sum_{s\in\mathcal{S}\setminus{S}}\gamma^{SAT}_sR_i\left(\uns{\mathbf{s}(i)=s}-\uns{\mathbf{s}(i)=S}\frac{N_s}{N_S}\right)\\
      &amp; \phantom{=} +\beta^{SAT}R_i\frac{\uns{\mathbf{s}(i)=S}}{\frac{N_S}{N}} + \epsilon^{SAT}_i.
\end{align*}\]</span></p>
<p>Their Theorem 9.2 shows that this definition is numerically equivalent to that in Theorem <a href="stratification.html#thm:SATUnbiasedConsistent">16.3</a>.
I prefer using the OLS estimator in each strata and then averaging rather than building the complex estimator that Imbens and Rubin use.</p>
</div>
</div>
</div>
<div id="estimating-sampling-noise-in-stratified-randomized-controlled-trials" class="section level3 hasAnchor" number="16.1.3">
<h3><span class="header-section-number">16.1.3</span> Estimating sampling noise in stratified randomized controlled trials<a href="stratification.html#estimating-sampling-noise-in-stratified-randomized-controlled-trials" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We now have consistent (and even sometimes unbiased) estimators of the average treatment effect in a stratified experiment.
Can we now estimate the sampling noise around these estimators?</p>
<div class="remark">
<p><span id="unlabeled-div-309" class="remark"><em>Remark</em>. </span>One especially important question is whether we can form estimates of sampling noise that reflect the fact that stratification decreases sampling noise (if the stratification variables are correlated with potential outcomes).
For example, the usual CLT-based estimator that we derived in Theorem <a href="FPSI.html#thm:asympnoiseWW">2.5</a> does not take into account that some stratification occurred.
It will give an estimate of sampling noise that is correct for the case of one unique strata, but it fail at delivering estimates reflecting the increases in precision that occur after stratification.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-310" class="remark"><em>Remark</em>. </span>Note that stratification improvemes precision also for the simple WW estimator, as Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataPlot">16.3</a> shows.
This means that even if the simple OLS estimator is consistent for the average treatment effect, its standard error will not.
In general, it will be too big, and therefore confidence intervals based on it will be too large, which is a shame.
That is why using consistent estimators of sampling noise matters.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-311" class="remark"><em>Remark</em>. </span>A second concern is whether the default (heteroskedasticity robust) standard errors of the strata fixed effects estimator (SFE) provides an accurate estimate of the sampling noise of that estimator.
<a href="https://www.cambridge.org/core/books/causal-inference-for-statistics-social-and-biomedical-sciences/71126BE90C58F1A431FE9B2DD07938AB">Imbens and Rubin (2015)</a> argue that it is the case while <a href="https://doi.org/10.1080/01621459.2017.1375934">Bugny, Canay and shaikh (2018)</a> and <a href="https://doi.org/10.3982/QE1150">Bugny, Canay and shaikh (2019)</a> disagree.
As <a href="https://doi.org/10.3982/QE1150">Bugny, Canay and shaikh (2019)</a> explain in their Remark 5.1, the main difference between their approaches is whether you assume that your sampling scheme can be characterized by <span class="math inline">\(\frac{N_s}{N}\)</span> being constant with <span class="math inline">\(N\)</span>.
One way in which this might be true is that, each time we draw a new sample, we do not increase the number strata with sample size, and we keep the same definition for each strata and the same proportion of observations in each strata (up to rounding errors).
Otherwise, if we either increase the number of strate with sample size, or if we cannot keep the relative size of each strata constant as sample size grows (for example if we change the definition of strata with each sample), we might have a problem.
In what follows, I will present estimators of sampling noise under the simpler assumption of <span class="math inline">\(\frac{N_s}{N}\)</span> being constant with <span class="math inline">\(N\)</span> and I will then explain what relaxing that assumption does to our estimates.</p>
</div>
<div id="estimating-sampling-noise-under-constant-strata-proportions" class="section level4 hasAnchor" number="16.1.3.1">
<h4><span class="header-section-number">16.1.3.1</span> Estimating sampling noise under constant strata proportions<a href="stratification.html#estimating-sampling-noise-under-constant-strata-proportions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div id="estimating-sampling-noise-of-the-fully-saturated-estimator" class="section level5 hasAnchor" number="16.1.3.1.1">
<h5><span class="header-section-number">16.1.3.1.1</span> Estimating sampling noise of the fully saturated estimator<a href="stratification.html#estimating-sampling-noise-of-the-fully-saturated-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>To estimate the distribution of the fully saturated estimator under stratification, we need to slightly alter our basic assumptions:</p>
<div class="hypothesis">
<p><span id="hyp:iidStrata" class="hypothesis"><strong>Hypothesis 16.3  (i.i.d. sampling with strata) </strong></span>We assume that the observations in the sample are identically and independently distributed within and across strata:
<span class="math display">\[\begin{align*}
\forall i,j\leq N\text{, }i\neq j\text{, } &amp; (Y_i,R_i,\mathbf{s}(i))\Ind(Y_j,R_j,\mathbf{s}(j)),\\
                                           &amp; (Y_i,R_i,\mathbf{s}(i))\&amp;(Y_j,R_j,\mathbf{s}(j))\sim F_{Y,R,\mathbf{s}}.
\end{align*}\]</span></p>
</div>
<div class="hypothesis">
<p><span id="hyp:finitevarStrata" class="hypothesis"><strong>Hypothesis 16.4  (Finite variance of potential outcomes within strata) </strong></span>We assume that <span class="math inline">\(\var{Y^1|R_i=1,\mathbf{s}(i)=s}\)</span> and <span class="math inline">\(\var{Y^0|R_i=0,\mathbf{s}(i)=s}\)</span> are finite, <span class="math inline">\(\forall s\in\mathcal{S}\)</span>.</p>
</div>
<p>Finally, we are going to make an additional strong assumption that the proportion of observations in each strata in the sample is equal to the proportion of observations in each strata in the population:</p>
<div class="hypothesis">
<p><span id="hyp:cstStrataProportion" class="hypothesis"><strong>Hypothesis 16.5  (Constant strata proportions) </strong></span>We assume that <span class="math inline">\(\frac{N_s}{N}=p_s\)</span>, where <span class="math inline">\(p_s\)</span> is the proportion of units of strata <span class="math inline">\(s\)</span> in the population.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-312" class="remark"><em>Remark</em>. </span>Assumption <a href="stratification.html#hyp:cstStrataProportion">16.5</a> holds when you choose the proportion of each strata before collecting the data based on some additional information (for example, the full census of units you are going to survey).
If you know for example the actual proportions of men and women in your target population from administrative data counting all of these observations, Assumption <a href="stratification.html#hyp:cstStrataProportion">16.5</a> is very close to holding.
The only issue is that the total population is actually one sample from a super population where the actual proportion of each strata might be slightly different, but for all purposes, this is not operating here, at least as long as the actual strata proportions are the ones that are relevant for your full census.
Things are different when you build the strata once the sample has been collected and you use the sample data to compute the strata proportions.
In that case, your estimates of the strata proportions are not equal to the population ones, and Assumption <a href="stratification.html#hyp:cstStrataProportion">16.5</a> does not hold.
Note that in our numerical example, Assumption <a href="stratification.html#hyp:cstStrataProportion">16.5</a> does not hold.</p>
</div>
<p>Equipped with our assumptions, we can now prove the following result:</p>
<div class="theorem">
<p><span id="thm:asympnoiseSATStrata" class="theorem"><strong>Theorem 16.4  (Asymptotic estimate of sampling noise of the fully saturated estimator under stratification) </strong></span>Under Assumptions <a href="stratification.html#hyp:fullrankStrata">16.1</a>, <a href="stratification.html#hyp:independenceStrata">16.2</a>, <a href="stratification.html#hyp:iidStrata">16.3</a>, <a href="stratification.html#hyp:finitevarStrata">16.4</a> and <a href="stratification.html#hyp:cstStrataProportion">16.5</a>, the asymptotic distribution of the fully saturated estimator can be approximated as follows:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}\left(\hat{\Delta}^{Y}_{SAT}-\Delta^{Y}_{ATE}\right) &amp; \distr \mathcal{N}\left(0,\sum_{s\in\mathcal{S}}p_s\left(\frac{\var{Y_i^1|R_i=1,\mathbf{s}(i)=s}}{\Pr(R_i=1)}+\frac{\var{Y_i^0|R_i=0,\mathbf{s}(i)=s}}{1-\Pr(R_i=1)}\right)\right).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-313" class="proof"><em>Proof</em>. </span>See in Appendix <a href="proofs.html#proofasympnoiseSATStrata">A.7.4</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-314" class="remark"><em>Remark</em>. </span>The shape of the sampling noise estimate stemming from Theorem <a href="stratification.html#thm:asympnoiseSATStrata">16.4</a> is very close to the one we have developed for observational estimators.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-315" class="remark"><em>Remark</em>. </span>How to form an estimator of sampling noise based on Theorem <a href="stratification.html#thm:asympnoiseSATStrata">16.4</a>?
One way to do it is to recover the heteroskedasticity-robust estimate of sampling noise within each strata, to multiply it by the strata size, to average the resulting terms across strata using <span class="math inline">\(p_s\)</span> as weights and to divide the resulting estimate by the total sample size and tehn to take the square root to obtain the estimated standard error.
Note that the estimator of teh stanbdard error within each strata can only be formed when there are at least 2 treated and 2 untreated observations in each strata, otherwise the variance of the outcomes for each group in each strata cannot be computed.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-508" class="example"><strong>Example 16.2  </strong></span>We have already ran this estimator in our numerical example using the <code>feols</code> command with the <code>vcov='HC1'</code> option.
Here are the results:</p>
</div>
<div class="sourceCode" id="cb508"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb508-1"><a href="stratification.html#cb508-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(SummaryStrata,<span class="fu">aes</span>(<span class="at">x=</span>strata_size,<span class="at">y=</span>MeanCoef,<span class="at">color=</span>Type,<span class="at">shape=</span>Type))<span class="sc">+</span></span>
<span id="cb508-2"><a href="stratification.html#cb508-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(binwidth=.01, alpha=0.5,position=&#39;identity&#39;) +</span></span>
<span id="cb508-3"><a href="stratification.html#cb508-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_density(alpha=0.3)+</span></span>
<span id="cb508-4"><a href="stratification.html#cb508-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_bar(stat=&#39;identity&#39;,position=position_dodge())+</span></span>
<span id="cb508-5"><a href="stratification.html#cb508-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>MeanCoef<span class="fl">-1.96</span><span class="sc">*</span>SdCoef,<span class="at">ymax=</span>MeanCoef<span class="fl">+1.96</span><span class="sc">*</span>SdCoef,<span class="at">color=</span>Type,<span class="at">shape=</span>Type),<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.2</span>))<span class="sc">+</span></span>
<span id="cb508-6"><a href="stratification.html#cb508-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>MeanCoef<span class="fl">-1.96</span><span class="sc">*</span>MeanSe,<span class="at">ymax=</span>MeanCoef<span class="fl">+1.96</span><span class="sc">*</span>MeanSe,<span class="at">color=</span>Type,<span class="at">shape=</span>Type),<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.2</span>),<span class="at">linetype=</span><span class="st">&#39;dashed&#39;</span>,<span class="at">width=</span><span class="fl">0.2</span>)<span class="sc">+</span></span>
<span id="cb508-7"><a href="stratification.html#cb508-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept=</span>ATE),<span class="at">color=</span><span class="st">&#39;red&#39;</span>,<span class="at">linetype=</span><span class="st">&#39;dotted&#39;</span>) <span class="sc">+</span></span>
<span id="cb508-8"><a href="stratification.html#cb508-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>)<span class="sc">+</span></span>
<span id="cb508-9"><a href="stratification.html#cb508-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;Number of strata&#39;</span>)<span class="sc">+</span></span>
<span id="cb508-10"><a href="stratification.html#cb508-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:montecarlobruteforcewwyBStrataEstimSePlot"></span>
<img src="STCI_files/figure-html/montecarlobruteforcewwyBStrataEstimSePlot-1.png" alt="Distribution of estimators under various levels of stratification and estimated sampling noise (dashed lines)" width="60%" />
<p class="caption">
Figure 16.4: Distribution of estimators under various levels of stratification and estimated sampling noise (dashed lines)
</p>
</div>
<p>As expected, the fully saturated model performs very well at estimating the actual level of sampling noise.
Note that the default OLS estimator of sampling noise completely fails to reflect the precision gains due to stratification.</p>
</div>
<div id="estimating-sampling-noise-of-the-strata-fixed-effects-estimator" class="section level5 hasAnchor" number="16.1.3.1.2">
<h5><span class="header-section-number">16.1.3.1.2</span> Estimating sampling noise of the strata fixed effects estimator<a href="stratification.html#estimating-sampling-noise-of-the-strata-fixed-effects-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The strata fixed effects estimator is very similar to the fully saturated estimator, as Theorem <a href="stratification.html#thm:SFEdecomp">16.1</a> shows.
They former differs only by having the proportion of treated and untreated in each strata appear in the formula for the weights.
There are two key questions that one can then ask:</p>
<ol style="list-style-type: decimal">
<li>What is the heteroskedasticity-consistent CLT-based approximation to the distribution of the strata fixed effects estimator?</li>
<li>Does this distribution differ from the one of the fully saturated estimator and if yes how?</li>
</ol>
<p>The following theorem answers the first question:</p>
<div class="theorem">
<p><span id="thm:asympnoiseSFEStrata" class="theorem"><strong>Theorem 16.5  (Asymptotic estimate of sampling noise of the strata fixed effects estimator) </strong></span>Under Assumptions <a href="stratification.html#hyp:fullrankStrata">16.1</a>, <a href="stratification.html#hyp:independenceStrata">16.2</a>, <a href="stratification.html#hyp:iidStrata">16.3</a>, <a href="stratification.html#hyp:finitevarStrata">16.4</a> and <a href="stratification.html#hyp:cstStrataProportion">16.5</a>, the asymptotic distribution of the fully saturated estimator can be approximated as follows:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}\left(\hat{\beta}^{SFE}-\Delta^{Y}_{ATE}\right) &amp; \distr \mathcal{N}\left(0,\sum_{s\in\mathcal{S}}\frac{(w^{SFE}_s)^2}{p_s}\left(\frac{\var{Y_i^1|R_i=1,\mathbf{s}(i)=s}}{\Pr(R_i=1|\mathbf{s}(i)=s)}+\frac{\var{Y_i^0|R_i=0,\mathbf{s}(i)=s}}{1-\Pr(R_i=1|\mathbf{s}(i)=s)}\right)\right).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-316" class="proof"><em>Proof</em>. </span>See in Appendix <a href="proofs.html#proofasympnoiseSFEStrata">A.7.5</a>.</p>
</div>
<p>The following corollary answers the second question:</p>
<div class="corollary">
<p><span id="cor:asympnoiseSFEStrataCor" class="corollary"><strong>Corollary 16.1  (Equality of sampling noise for the strata fixed effects estimator and the fully saturated estimator) </strong></span>Under Assumptions <a href="stratification.html#hyp:fullrankStrata">16.1</a>, <a href="stratification.html#hyp:independenceStrata">16.2</a>, <a href="stratification.html#hyp:iidStrata">16.3</a>, <a href="stratification.html#hyp:finitevarStrata">16.4</a> and <a href="stratification.html#hyp:cstStrataProportion">16.5</a>, and assuming that the proportion of treated units is equal to <span class="math inline">\(\pi\)</span> in each strata, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}\left(\hat{\beta}^{SFE}-\Delta^{Y}_{ATE}\right) &amp; \distr \mathcal{N}\left(0,\sum_{s\in\mathcal{S}}p_s\left(\frac{\var{Y_i^1|R_i=1,\mathbf{s}(i)=s}}{\Pr(R_i=1)}+\frac{\var{Y_i^0|R_i=0,\mathbf{s}(i)=s}}{1-\Pr(R_i=1)}\right)\right).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-317" class="proof"><em>Proof</em>. </span>If <span class="math inline">\(\bar{R}_s=\pi\)</span>, we have <span class="math inline">\(w^{SFE}_s=p^s\)</span> and <span class="math inline">\(\Pr(R_i=1|\mathbf{s}(i)=s)=\Pr(R_i=1)\)</span>, under Assumption <a href="stratification.html#hyp:cstStrataProportion">16.5</a>.
Using Theorem <a href="stratification.html#thm:asympnoiseSFEStrata">16.5</a> proves the result.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-318" class="remark"><em>Remark</em>. </span>As a consequence, if the proportion of treated in each strata is roughly constant, both the strata fixed effect estimator and the fully saturated estimator will have similar sampling noise.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-319" class="remark"><em>Remark</em>. </span>How to estimate the sampling noise of the strata fixed effect estimator?
Simply using the heteroskedasticity-robust estimator, for example the <code>vcov="HC1"</code> in <code>feols</code>, as we did in the numerical example above.
The estimates in Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataEstimSePlot">16.4</a> suggest that this approach performs very well indeed.</p>
</div>
</div>
<div id="estimating-sampling-noise-of-the-withwithout-estimator" class="section level5 hasAnchor" number="16.1.3.1.3">
<h5><span class="header-section-number">16.1.3.1.3</span> Estimating sampling noise of the with/without estimator<a href="stratification.html#estimating-sampling-noise-of-the-withwithout-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>What is the sampling noise of the WW estimator?
How can we estimate it in practice?
I leave the answers to these questions as an exercise.
The OLS estimator is probably some weighted average of the <span class="math inline">\(\hat{\Delta}^Y_{WW_s}\)</span> parameters, with weights that are going to drive the asymptotic distribution.
Under plausible assumptions (constant strata poportions and constant proportion of treated), we probably get that its asymptotic distribution should be equal to that of the other two estimators.
This is what Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataEstimSePlot">16.4</a> suggests.</p>
<div class="remark">
<p><span id="unlabeled-div-320" class="remark"><em>Remark</em>. </span>The default (even heteroskedasticity robust) standard error of the WW estimator estimated by OLS is NOT an adequate measure of sampling noise under stratification, since it does not account for the fact that stratification has reduced sampling noise by capturing part of the vaariation in potential outcomes.
This appears clearly on Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataEstimSePlot">16.4</a>, where the estimated sampling noise of the WW estimator is always equal to the one without stratification.
Ignoring stratification when estimating precision might leave a lot of precision on the table.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-321" class="remark"><em>Remark</em>. </span>Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataEstimSePlot">16.4</a> also shows another problem with the WW estimator: its precision starts decreasing when we increase the number of strata above 25. What is happening is that some strata start having no treated or no untreated units.
The SAT and SFE estimators exclude these strata from the estimation (thereby biasing the final estimate) whereas the WW estimator do not exclude them and ends up using an unbalanced, noisier sample.
Note that the standard errors that we used so far do not reflect that risk.</p>
</div>
</div>
</div>
<div id="estimating-sampling-noise-under-varying-strata-proportions" class="section level4 hasAnchor" number="16.1.3.2">
<h4><span class="header-section-number">16.1.3.2</span> Estimating sampling noise under varying strata proportions<a href="stratification.html#estimating-sampling-noise-under-varying-strata-proportions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>What happens when we relax Assumption <a href="stratification.html#hyp:cstStrataProportion">16.5</a>, that is when we acknowledge that the proportion of observations in each strata might vary with <span class="math inline">\(N\)</span>?
The reason why this might happen is first because, in small samples, and with small strata, rounding errors might make the actual strata proportions far away from their theoretical values, even with stratified block randomization.
Another reason is that we might use a stratification procedure that does not have the property of keeping strata proportions constant.
A final reason is that we might be delimiting strata in a first step from a given sample, a thus strata are an estimated, whose true proportion in the population are unkwnown objects around which we can at best form a noisy estimator.
This is for example the case when delimiting strata using <span class="math inline">\(k-\)</span>means clustering as we did in our example.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-515" class="example"><strong>Example 16.3  </strong></span>In order to illustrate the first source of failure of Assumption <a href="stratification.html#hyp:cstStrataProportion">16.5</a>, let us plot the proportion of each strata in our samples, along with their theoretical values.</p>
</div>
<div class="sourceCode" id="cb509"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb509-1"><a href="stratification.html#cb509-1" aria-hidden="true" tabindex="-1"></a>data.strata.prop <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span></span>
<span id="cb509-2"><a href="stratification.html#cb509-2" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">mutate</span>(</span>
<span id="cb509-3"><a href="stratification.html#cb509-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">qs =</span> Ns<span class="sc">/</span>N</span>
<span id="cb509-4"><a href="stratification.html#cb509-4" aria-hidden="true" tabindex="-1"></a>                    ) <span class="sc">%&gt;%</span></span>
<span id="cb509-5"><a href="stratification.html#cb509-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">group_by</span>(strata_type,strata_value,strata_type_value) <span class="sc">%&gt;%</span></span>
<span id="cb509-6"><a href="stratification.html#cb509-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">summarize</span>(</span>
<span id="cb509-7"><a href="stratification.html#cb509-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">qs =</span> <span class="fu">mean</span>(qs)</span>
<span id="cb509-8"><a href="stratification.html#cb509-8" aria-hidden="true" tabindex="-1"></a>                    ) <span class="sc">%&gt;%</span></span>
<span id="cb509-9"><a href="stratification.html#cb509-9" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">mutate</span>(</span>
<span id="cb509-10"><a href="stratification.html#cb509-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">strata_type=</span><span class="fu">factor</span>(strata_type,<span class="at">levels=</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;strata&quot;</span>,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">100</span>),<span class="at">sep=</span><span class="st">&#39;_&#39;</span>))),</span>
<span id="cb509-11"><a href="stratification.html#cb509-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Nstrata =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(strata_type,<span class="st">&#39;</span><span class="sc">\\</span><span class="st">_&#39;</span>,<span class="dv">2</span>)[,<span class="dv">2</span>]),</span>
<span id="cb509-12"><a href="stratification.html#cb509-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">qsstar =</span> <span class="dv">1</span><span class="sc">/</span>Nstrata</span>
<span id="cb509-13"><a href="stratification.html#cb509-13" aria-hidden="true" tabindex="-1"></a>                    )</span></code></pre></div>
<p>Let us plot the result:</p>
<div class="sourceCode" id="cb510"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb510-1"><a href="stratification.html#cb510-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data.strata.prop <span class="sc">%&gt;%</span> <span class="fu">filter</span>(strata_type<span class="sc">!=</span><span class="st">&quot;strata_1&quot;</span>,strata_type<span class="sc">!=</span><span class="st">&quot;strata_2&quot;</span>),<span class="fu">aes</span>(<span class="at">x=</span>qs))<span class="sc">+</span></span>
<span id="cb510-2"><a href="stratification.html#cb510-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth=</span><span class="fl">0.01</span>,<span class="at">color=</span><span class="st">&#39;black&#39;</span>,<span class="at">fill=</span><span class="st">&#39;white&#39;</span>)<span class="sc">+</span></span>
<span id="cb510-3"><a href="stratification.html#cb510-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span>qsstar),<span class="at">color=</span><span class="st">&#39;red&#39;</span>,<span class="at">linetype=</span><span class="st">&#39;dashed&#39;</span>)<span class="sc">+</span></span>
<span id="cb510-4"><a href="stratification.html#cb510-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="fl">0.35</span>)<span class="sc">+</span></span>
<span id="cb510-5"><a href="stratification.html#cb510-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb510-6"><a href="stratification.html#cb510-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.<span class="sc">~</span>strata_type)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:StrataPropPlot"></span>
<img src="STCI_files/figure-html/StrataPropPlot-1.png" alt="Strata proportions" width="50%" />
<p class="caption">
Figure 16.5: Strata proportions
</p>
</div>
<p>As Figure <a href="stratification.html#fig:StrataPropPlot">16.5</a> shows, there is substantial variation in a given sample around the theoretical strata proportion.</p>
<div class="remark">
<p><span id="unlabeled-div-322" class="remark"><em>Remark</em>. </span>Note that it is not clear whether we would expect strata proportions to be constant at <span class="math inline">\(\frac{1}{S}\)</span> with strata defined by <span class="math inline">\(k\)</span>-means clustering.
A more rigorous check would define strata as based on a finite set of threshold values on the support of <span class="math inline">\(\ln y_b\)</span> and would derive the strata proportions in the population before checking the actual distribution of the proportion of these strata in each sample.
We expect a substantial amount of variation.
This is left as an exercise.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-323" class="remark"><em>Remark</em>. </span>An even more difficult exercise would be to compute the strata proportions under <span class="math inline">\(k\)</span>-means clustering.
This is left as an exercise.</p>
</div>
<p>We are going to relax Assumption <a href="stratification.html#hyp:cstStrataProportion">16.5</a> by using instead the following assumption, suggested by <a href="https://doi.org/10.1080/01621459.2017.1375934">Bugny, Canay and shaikh (2018)</a>:</p>
<div class="hypothesis">
<p><span id="hyp:StrongBalance" class="hypothesis"><strong>Hypothesis 16.6  (Strong balance) </strong></span>We assume that</p>
<p><span class="math display">\[\begin{align*}
  \plims\frac{1}{\sqrt{N}}\sum_{i=1}^N(R_i-\pi)\uns{\mathbf{s}(i)=s}=0, \forall s\in\mathcal{S}.
\end{align*}\]</span></p>
</div>
<p>Assumption of <a href="stratification.html#hyp:StrongBalance">16.6</a> imposes that the discrepancy between the proportion of treated in each strata and the target proportion <span class="math inline">\(\pi\)</span> goes to zero faster than <span class="math inline">\(\sqrt{N}\)</span>.
Assumption of <a href="stratification.html#hyp:StrongBalance">16.6</a> is satisfied with stratified block randomization, if the number of strata does not increase with <span class="math inline">\(N\)</span>.
We can now state the following result:</p>
<div class="theorem">
<p><span id="thm:asympnoiseSFEStrataBalance" class="theorem"><strong>Theorem 16.6  (Sampling noise under strong balance) </strong></span>Under Assumptions <a href="stratification.html#hyp:fullrankStrata">16.1</a>, <a href="stratification.html#hyp:independenceStrata">16.2</a>, <a href="stratification.html#hyp:iidStrata">16.3</a>, <a href="stratification.html#hyp:finitevarStrata">16.4</a> and <a href="stratification.html#hyp:StrongBalance">16.6</a>, the asymptotic distribution of the fully saturated estimator of the strata fixed effects estimator can be approximated as follows:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}\left(\hat{\Delta}^Y_{SAT}-\Delta^{Y}_{ATE}\right) &amp; \distr \mathcal{N}\left(0,
\begin{array}{c}
\sum_{s\in\mathcal{S}}p_s\left(\frac{\var{Y_i^1|R_i=1,\mathbf{s}(i)=s}}{\Pr(R_i=1|\mathbf{s}(i)=s)}+\frac{\var{Y_i^0|R_i=0,\mathbf{s}(i)=s}}{1-\Pr(R_i=1|\mathbf{s}(i)=s)}\right) \\
+
\sum_{s\in\mathcal{S}}p_s\left(\esp{\esp{Y^1_i-Y^0_i|Z_i}-\esp{Y_i^1-Y^0_i}|\mathbf{s}(i)=s}\right)^2
\end{array}
\right),
\end{align*}\]</span>
where <span class="math inline">\(Z_i\)</span> are the observed baseline covariates used to generate the strata.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-324" class="proof"><em>Proof</em>. </span>See <a href="https://onlinelibrary.wiley.com/doi/abs/10.3982/QE1150">Bugni, Canay and Shaikh (2019)</a> Theorems 3.1 and 3.2 applied to a single treatment (Section 5).</p>
</div>
<p>Theorem <a href="stratification.html#thm:asympnoiseSFEStrataBalance">16.6</a> shows that the asymptotic variance of the strata fixed effects and fully saturated estimators has two components: the first one is the one we are already familiar with under constant strata proportions, and the second one is a new component.
This new component stems from the variance in treatment effects across strata.
It can be estimated as follows:</p>
<p><span class="math display">\[\begin{align*}
  \hat{\mathbf{V}}_H &amp; = \sum_{s=1}^S\frac{N_s}{N}(\hat{\beta}^{SAT}_s-\hat{\Delta}^Y_{WW})^2.
\end{align*}\]</span></p>
<p><span class="math inline">\(\hat{\mathbf{V}}_H\)</span> estimates the variance in treatment effects across strata.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-519" class="example"><strong>Example 16.4  </strong></span>Let’s see how the <a href="https://onlinelibrary.wiley.com/doi/abs/10.3982/QE1150">Bugni, Canay and Shaikh (2019)</a> correction (adding <span class="math inline">\(\hat{\mathbf{V}}_H\)</span> to our estimate of the asymptotic variance) changes our variance estimates.
We have already implemented it in the Monte Carlo simulations.
Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataEstimSePlot">16.4</a> suggests that the correction does not make much of a difference in our example.
It seems though that, with 100 strata, the standard errors without the correction are too tight and that the correction enables to recover correct estimates of sampling noise.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-325" class="remark"><em>Remark</em>. </span><a href="https://onlinelibrary.wiley.com/doi/abs/10.3982/QE1150">Bugni, Canay and Shaikh (2019)</a> present simulations where their correction term makes an even greater difference.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-326" class="remark"><em>Remark</em>. </span><a href="https://onlinelibrary.wiley.com/doi/abs/10.3982/QE1150">Bugni, Canay and Shaikh (2019)</a> also provide derivations for the case of multiple treatments.</p>
</div>
</div>
<div id="randomization-inference-for-stratified-experiments" class="section level4 hasAnchor" number="16.1.3.3">
<h4><span class="header-section-number">16.1.3.3</span> Randomization inference for stratified experiments<a href="stratification.html#randomization-inference-for-stratified-experiments" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="remark">
<p><span id="unlabeled-div-327" class="remark"><em>Remark</em>. </span><a href="https://doi.org/10.1080/01621459.2017.1375934">Bugny, Canay and shaikh (2018)</a> show in their Theorems 4.5 and 4.6 that randomization inference can recover adequate measures of precision under Assumption <a href="stratification.html#hyp:StrongBalance">16.6</a>.
Using randomization inference based on the t-stat build using the distribution in Theorem <a href="stratification.html#thm:asympnoiseSFEStrataBalance">16.6</a> is always consistent under Assumption <a href="stratification.html#hyp:StrongBalance">16.6</a>.
Using randomization inference based on the t-stat build using the distribution in Theorem <a href="stratification.html#thm:asympnoiseSATStrata">16.4</a> is consistent under Assumption <a href="stratification.html#hyp:StrongBalance">16.6</a> and with the additional requirement that <span class="math inline">\(\pi=0.5\)</span>.</p>
</div>
</div>
</div>
</div>
<div id="analysis-of-pairwise-randomized-controlled-trials" class="section level2 hasAnchor" number="16.2">
<h2><span class="header-section-number">16.2</span> Analysis of pairwise randomized controlled trials<a href="stratification.html#analysis-of-pairwise-randomized-controlled-trials" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>With pairwise stratification, all strata are of size <span class="math inline">\(N_s=2\)</span>.
There are several advantages to using paurwise stratification.
With classical stratification, <em>i.e.</em> defining strata ex-ante, some strata might end up empty, populated by one unit of observation, etc.
One solution to that issue is to use <span class="math inline">\(k\)</span>-means clustering as we have done in the previous section, but that requires abandoning the constant strata proportion approach.
But having strata that are of size superior to two suggests that we could increase precision by more by decreasing the size of the strata, trying to make units more and more similar.
The limit of that process is to have strata of size two, with only one treated and one control observation in each.
Of course, that reasoning probably puts under the carpet the classical bias/variance trade-off, and we will come back to that in the end of the section.</p>
<p>There are several challenges to implementing and analyzing a pairwise randomized controlled trial.
The first of these challenges is the choice of the sample pairs.
How do we choose the units that are closest to each other in the sample, so that some measure of the total discrepancy between pairs is minimized?
This is actually not an easy problem to solve.
In this section, I use recent results in operational research to help build the pairs, which tremendously decrease the time required to generate an adequate sample for randomization and make this approach much more feasible and usable than what it is now.
The second challenge is the estimation of sampling noise.
We indeed cannot use the formula in Theorem <a href="stratification.html#thm:asympnoiseSATStrata">16.4</a> and Theorem <a href="stratification.html#thm:asympnoiseSFEStrata">16.5</a> because the variance of each potential outcome is not identified under within pairs (since we only have one observation of each potential outcome within the pair).
A solution to that issue is to simply analyze the sample using pair fixed effects or pairwise differences.</p>
<div id="building-a-sample-of-pairs" class="section level3 hasAnchor" number="16.2.1">
<h3><span class="header-section-number">16.2.1</span> Building a sample of pairs<a href="stratification.html#building-a-sample-of-pairs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A key difficulty in pairwise stratification is to build an adequate sample of pairs.
It is so difficult that applied researchers in economics generally resort to a greedy approach: go through a large random sample of pairs and keep the one that is most satisfactory.
One problem is that we do not know what satisfactory means: we need to choose a metric to measure of close all pairs are to each other.
Here, I am going to use Euclidean or Mahalanobis distance, a measure of how different two observations are based on their observed covariates.</p>
<p>A second problem is that we do not know whether the resulting sample is actually the optimal one.
It might not be.
A third problem is that this approach is greedy: it takes time, so much time, and the time it requires increase exponentially with sample size (it is an NP-hard type of problem).</p>
<p>These last two issues can be solved in polynomial time using recent results in operations research.
The problem and how it has been solved are described on <a href="http://jorisvr.nl/article/maximum-matching">Joris van Rantwijk’s webpage</a>.
The classical algorithm is Edmond’s <a href="https://en.wikipedia.org/wiki/Blossom_algorithm">Blossom algorithm</a>.
Fortunately, Cole Beck recently imported the Blossom algorithm to <code>R</code> within the <code>nbpMatching</code> package.</p>
<p>In order to implement the pairing, we need a distance matrix between all possible pairs of units in the data.
The <code>gendistance</code> function of the <code>nbpMatching</code> package computes this matrix using the Mahalanobis distance.
Then, the <strong>Blossom</strong> algorithm is called using the <code>nonbimatch</code> command, after adequately transforming the matrix into a suitable input format using the <code>distancematrix</code> command.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-523" class="example"><strong>Example 16.5  </strong></span>Let’s see how this all works in our example.</p>
</div>
<div class="sourceCode" id="cb511"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb511-1"><a href="stratification.html#cb511-1" aria-hidden="true" tabindex="-1"></a><span class="co">#N &lt;- 6</span></span>
<span id="cb511-2"><a href="stratification.html#cb511-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb511-3"><a href="stratification.html#cb511-3" aria-hidden="true" tabindex="-1"></a><span class="co"># restrict to original dataset</span></span>
<span id="cb511-4"><a href="stratification.html#cb511-4" aria-hidden="true" tabindex="-1"></a>data.strata.original <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span> </span>
<span id="cb511-5"><a href="stratification.html#cb511-5" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">filter</span>(strata_type<span class="sc">==</span><span class="st">&quot;strata_1&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>(.) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">id=</span><span class="fu">as.character</span>(id))</span>
<span id="cb511-6"><a href="stratification.html#cb511-6" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the distance matrix</span></span>
<span id="cb511-7"><a href="stratification.html#cb511-7" aria-hidden="true" tabindex="-1"></a><span class="co">#distance &lt;- gendistance(data.strata.original %&gt;% select(id,yB,y0),idcol=1)</span></span></code></pre></div>
<div class="remark">
<p><span id="unlabeled-div-328" class="remark"><em>Remark</em>. </span>Unfortunately, I’ve ran into some technical issues with the implementation of the algorithm that I cannot solve right now.</p>
</div>
<p>Instead of using the Blossom algorithm to form the pair, I am going to order all observations by pre-treatment income, and form alternating pairs.
With several treatment variables, one would have to build a score for all the variables (their weighted mean) and before ordering.
Let’s go.</p>
<div class="sourceCode" id="cb512"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb512-1"><a href="stratification.html#cb512-1" aria-hidden="true" tabindex="-1"></a><span class="co"># random seed</span></span>
<span id="cb512-2"><a href="stratification.html#cb512-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb512-3"><a href="stratification.html#cb512-3" aria-hidden="true" tabindex="-1"></a><span class="co"># restrict to original dataset</span></span>
<span id="cb512-4"><a href="stratification.html#cb512-4" aria-hidden="true" tabindex="-1"></a>data.strata.original <span class="ot">&lt;-</span> data.strata <span class="sc">%&gt;%</span> </span>
<span id="cb512-5"><a href="stratification.html#cb512-5" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">filter</span>(strata_type<span class="sc">==</span><span class="st">&quot;strata_1&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb512-6"><a href="stratification.html#cb512-6" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">ungroup</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb512-7"><a href="stratification.html#cb512-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">&#39;strata&#39;</span>),<span class="sc">-</span><span class="fu">contains</span>(<span class="st">&#39;rand&#39;</span>),<span class="sc">-</span>Ds,<span class="sc">-</span>y,<span class="sc">-</span>Ns,<span class="sc">-</span>pis) <span class="sc">%&gt;%</span></span>
<span id="cb512-8"><a href="stratification.html#cb512-8" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">arrange</span>(yB) <span class="sc">%&gt;%</span></span>
<span id="cb512-9"><a href="stratification.html#cb512-9" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">mutate</span>(</span>
<span id="cb512-10"><a href="stratification.html#cb512-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">strata =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">/</span><span class="dv">2</span>),<span class="dv">2</span>)[<span class="fu">order</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">/</span><span class="dv">2</span>),<span class="dv">2</span>))],</span>
<span id="cb512-11"><a href="stratification.html#cb512-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">randU =</span> <span class="fu">runif</span>(N)</span>
<span id="cb512-12"><a href="stratification.html#cb512-12" aria-hidden="true" tabindex="-1"></a>                 )  <span class="sc">%&gt;%</span></span>
<span id="cb512-13"><a href="stratification.html#cb512-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">group_by</span>(strata) <span class="sc">%&gt;%</span></span>
<span id="cb512-14"><a href="stratification.html#cb512-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb512-15"><a href="stratification.html#cb512-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">randUMedStrata =</span> stats<span class="sc">::</span><span class="fu">median</span>(randU),</span>
<span id="cb512-16"><a href="stratification.html#cb512-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Ds =</span> <span class="fu">case_when</span>(</span>
<span id="cb512-17"><a href="stratification.html#cb512-17" aria-hidden="true" tabindex="-1"></a>                    randU<span class="sc">&lt;</span>randUMedStrata <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb512-18"><a href="stratification.html#cb512-18" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb512-19"><a href="stratification.html#cb512-19" aria-hidden="true" tabindex="-1"></a>                  ),</span>
<span id="cb512-20"><a href="stratification.html#cb512-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>(<span class="dv">1</span><span class="sc">-</span>Ds)<span class="sc">*</span>y0</span>
<span id="cb512-21"><a href="stratification.html#cb512-21" aria-hidden="true" tabindex="-1"></a>                ) </span></code></pre></div>
<p>We now have a sample of 500 pairs, where each pair is composed of observations with similar <span class="math inline">\(y^B_i\)</span>.</p>
</div>
<div id="estimating-treatment-effects-in-pairwise-randomized-controlled-trials" class="section level3 hasAnchor" number="16.2.2">
<h3><span class="header-section-number">16.2.2</span> Estimating treatment effects in pairwise randomized controlled trials<a href="stratification.html#estimating-treatment-effects-in-pairwise-randomized-controlled-trials" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In order to estimate treatment effects in pairwise randomized controlled trials, we can use either the <span class="math inline">\(WW\)</span> estimator, the strata fixed effects estimator or the fully saturated estimator.
We also have that the last two estimators are actually identical (it follows from Theorems <a href="stratification.html#thm:SFEdecomp">16.1</a> and <a href="stratification.html#thm:SATUnbiasedConsistent">16.3</a> with <span class="math inline">\(\bar{R}_s=\frac{1}{2}\)</span>, <span class="math inline">\(\forall s\)</span>).
There is actually another estimator that we might prefer to use, since it will give the correct estimator of sampling noise: the pairwise difference estimator.</p>
<p>The pairwise difference estimator works as follows.
First we form the pairwise difference in outcomes: <span class="math inline">\(\Delta_s^Y=Y_{i\in\mathcal{I}(s)\land D_i=1}-Y_{j\in\mathcal{I}(s)\land D_j=0}\)</span>.
Now, we simply regress the pairwise difference on a constant and estimate using OLS to obtain the estimated treatment effect:</p>
<p><span class="math display">\[\begin{align*}
  \Delta_s^Y &amp; = \alpha^{PD} +\epsilon^{PD}_s.
\end{align*}\]</span></p>
<p>We can prove the following theorem:</p>
<div class="theorem">
<p><span id="thm:PairUnbiasedConsistent" class="theorem"><strong>Theorem 16.7  (Unbiasedness and consistency of the pairwise difference estimator) </strong></span>Under Assumptions <a href="RCT.html#def:independence">3.1</a>, <a href="RCT.html#def:BF">3.2</a> and <a href="stratification.html#hyp:fullrankStrata">16.1</a>, the pairwise difference estimator is an unbiased and consistent estimator of the Average Treatment Effect:</p>
<p><span class="math display">\[\begin{align*}
    \esp{\hat{\alpha}^{PD}} &amp; = \Delta^Y_{ATE}\\
    \plims\hat{\alpha}^{PD} &amp; = \Delta^Y_{ATE}.
  \end{align*}\]</span></p>
<p>We also have that the pairwise difference estimator is numericalluy equivalent to the WW, SAT, and SFE estimators.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-329" class="proof"><em>Proof</em>. </span>See in Appendix <a href="proofs.html#proofPairUnbiasedConsistent">A.7.6</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-330" class="remark"><em>Remark</em>. </span>It is also true that <span class="math inline">\(\hat\alpha^{WSD}=\frac{1}{\frac{N}{2}}\sum_{s=1}^S\Delta_s^Y\)</span>, the across-strata mean of the within strata differences.
What is nice with the regression-based formulation is that it opens up the possibility of adding control variables:</p>
<p><span class="math display">\[\begin{align*}
  \Delta_s^Y &amp; = \alpha^{WSD(X)} +\beta^{WSD(X)}\Delta_s^X +\gamma^{WSD(X)}(\bar{X}_s-\bar{X}) +\epsilon^{WSD(X)}_s,
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\bar{X}_s\)</span> is the within strata mean of the covariates and <span class="math inline">\(\bar{X}\)</span> is their overall sample mean.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-527" class="example"><strong>Example 16.6  </strong></span>Let’s see how this works in our example.
Let us first form the pairwise difference estimator and see how it compares to the other ones.</p>
</div>
<div class="sourceCode" id="cb513"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb513-1"><a href="stratification.html#cb513-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PD</span></span>
<span id="cb513-2"><a href="stratification.html#cb513-2" aria-hidden="true" tabindex="-1"></a>regPD <span class="ot">&lt;-</span> data.strata.original <span class="sc">%&gt;%</span></span>
<span id="cb513-3"><a href="stratification.html#cb513-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(strata,Ds,y) <span class="sc">%&gt;%</span></span>
<span id="cb513-4"><a href="stratification.html#cb513-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_wider</span>(<span class="at">names_from=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">values_from =</span>  <span class="st">&#39;y&#39;</span>,<span class="at">names_prefix=</span><span class="st">&#39;y&#39;</span>,<span class="at">names_sep=</span><span class="st">&#39;&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb513-5"><a href="stratification.html#cb513-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb513-6"><a href="stratification.html#cb513-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">Deltay =</span> y1<span class="sc">-</span>y0</span>
<span id="cb513-7"><a href="stratification.html#cb513-7" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb513-8"><a href="stratification.html#cb513-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lm</span>(Deltay<span class="sc">~</span><span class="dv">1</span>,<span class="at">data=</span>.) <span class="sc">%&gt;%</span></span>
<span id="cb513-9"><a href="stratification.html#cb513-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coef</span>(.) </span>
<span id="cb513-10"><a href="stratification.html#cb513-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb513-11"><a href="stratification.html#cb513-11" aria-hidden="true" tabindex="-1"></a><span class="co"># WW</span></span>
<span id="cb513-12"><a href="stratification.html#cb513-12" aria-hidden="true" tabindex="-1"></a>regWW <span class="ot">&lt;-</span> data.strata.original <span class="sc">%&gt;%</span></span>
<span id="cb513-13"><a href="stratification.html#cb513-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lm</span>(y<span class="sc">~</span>Ds,<span class="at">data=</span>.)<span class="sc">%&gt;%</span></span>
<span id="cb513-14"><a href="stratification.html#cb513-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coef</span>(.) </span>
<span id="cb513-15"><a href="stratification.html#cb513-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb513-16"><a href="stratification.html#cb513-16" aria-hidden="true" tabindex="-1"></a><span class="co"># strata fixed effects</span></span>
<span id="cb513-17"><a href="stratification.html#cb513-17" aria-hidden="true" tabindex="-1"></a>regSFE <span class="ot">&lt;-</span> data.strata.original <span class="sc">%&gt;%</span></span>
<span id="cb513-18"><a href="stratification.html#cb513-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">feols</span>(y<span class="sc">~</span>Ds<span class="sc">|</span>strata,<span class="at">vcov=</span><span class="st">&quot;HC1&quot;</span>,<span class="at">data=</span>.)<span class="sc">%&gt;%</span></span>
<span id="cb513-19"><a href="stratification.html#cb513-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coef</span>(.) </span>
<span id="cb513-20"><a href="stratification.html#cb513-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb513-21"><a href="stratification.html#cb513-21" aria-hidden="true" tabindex="-1"></a><span class="co"># fully staturated model </span></span>
<span id="cb513-22"><a href="stratification.html#cb513-22" aria-hidden="true" tabindex="-1"></a><span class="co"># run a regression in each strata</span></span>
<span id="cb513-23"><a href="stratification.html#cb513-23" aria-hidden="true" tabindex="-1"></a>regSAT <span class="ot">&lt;-</span> data.strata.original <span class="sc">%&gt;%</span></span>
<span id="cb513-24"><a href="stratification.html#cb513-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(strata) <span class="sc">%&gt;%</span></span>
<span id="cb513-25"><a href="stratification.html#cb513-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">nest</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb513-26"><a href="stratification.html#cb513-26" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb513-27"><a href="stratification.html#cb513-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">reg =</span> <span class="fu">map</span>(data,<span class="sc">~</span><span class="fu">feols</span>(y<span class="sc">~</span>Ds<span class="sc">|</span><span class="dv">1</span>,<span class="at">vcov=</span><span class="st">&quot;HC1&quot;</span>,<span class="at">data=</span>.)),</span>
<span id="cb513-28"><a href="stratification.html#cb513-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">tidied =</span> <span class="fu">map</span>(reg,tidy)</span>
<span id="cb513-29"><a href="stratification.html#cb513-29" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb513-30"><a href="stratification.html#cb513-30" aria-hidden="true" tabindex="-1"></a>          <span class="fu">unnest</span>(tidied) <span class="sc">%&gt;%</span></span>
<span id="cb513-31"><a href="stratification.html#cb513-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&#39;Ds&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb513-32"><a href="stratification.html#cb513-32" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(</span>
<span id="cb513-33"><a href="stratification.html#cb513-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">Coef =</span> estimate,</span>
<span id="cb513-34"><a href="stratification.html#cb513-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">Se =</span> std.error</span>
<span id="cb513-35"><a href="stratification.html#cb513-35" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb513-36"><a href="stratification.html#cb513-36" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb513-37"><a href="stratification.html#cb513-37" aria-hidden="true" tabindex="-1"></a>            <span class="at">qs =</span> <span class="dv">2</span><span class="sc">/</span>N</span>
<span id="cb513-38"><a href="stratification.html#cb513-38" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb513-39"><a href="stratification.html#cb513-39" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(strata,Coef,qs) <span class="sc">%&gt;%</span></span>
<span id="cb513-40"><a href="stratification.html#cb513-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">ungroup</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb513-41"><a href="stratification.html#cb513-41" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(</span>
<span id="cb513-42"><a href="stratification.html#cb513-42" aria-hidden="true" tabindex="-1"></a>           <span class="at">Coef =</span> <span class="fu">weighted.mean.nest</span>(Coef<span class="sc">~</span>qs,<span class="at">data=</span>.,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb513-43"><a href="stratification.html#cb513-43" aria-hidden="true" tabindex="-1"></a>          )</span></code></pre></div>
<p>As expected, we have the pairwise difference estimator which is equal to 0.165, the WW estimator which is equal to 0.165, the SFE estimator which is equal to 0.165 and the SAT estimator which is equal to 0.165.</p>
</div>
<div id="estimating-sampling-noise-in-pairwise-randomized-controlled-trials" class="section level3 hasAnchor" number="16.2.3">
<h3><span class="header-section-number">16.2.3</span> Estimating sampling noise in pairwise randomized controlled trials<a href="stratification.html#estimating-sampling-noise-in-pairwise-randomized-controlled-trials" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The key question now is how to estimate sampling noise for the pairwise difference estimator.
One way to look at this issue would be to use results from Section <a href="stratification.html#ClassicalStratification">16.1</a>, and especially Theorems <a href="stratification.html#thm:asympnoiseSATStrata">16.4</a> and <a href="stratification.html#thm:asympnoiseSFEStrataBalance">16.6</a>.
We thus have the classical result that sampling noise is the weighted average of the sum of variances of the potential outcomes in each strata plus, in the absence of constant strata proportions, the variance of treatment effects across strata.
The problem we have is that, with only one treated and one untreated observation per strata, we cannot estimate the variance of the potential outcomes in each strata.
We might be willing to use the default variance of the pairwise difference estimator, or the one of the strata fixed effects estimator, but without any knwoledge of whether they indeed work.
So we seem stuck.</p>
<p>Fortunately, <a href="https://doi.org/10.1080/01621459.2021.1883437">Bai, Romano and Shaikh (2021)</a> have recently examined that issue in detail and have given us guidance.
<a href="https://doi.org/10.1080/01621459.2021.1883437">Bai, Romano and Shaikh (2021)</a> require several assumptions to provide an answer to our problem.
Before stating these assumptions, it is useful to reframe the pairing procedure as the <span class="math inline">\(\lfloor\frac{N}{2}\rfloor\)</span> pairs such that <span class="math inline">\(\left\{\pi(2j-1),\pi(2j)\right\}\)</span> for <span class="math inline">\(j\in\left\{1,\dots,\lfloor\frac{N}{2}\rfloor\right\}\)</span>, where <span class="math inline">\(\pi\)</span> is a permutation of the <span class="math inline">\(N\)</span> units in the sample based on <span class="math inline">\(\mathbf{X}\)</span>, the whole matrix of covariates in the sample.
In a sense, we simply have ordered the observations in the sample so that consecutive observations are in the same pair.
We are going to impose some restrictions on this permutation so that it is optimal in some sense:</p>
<div class="hypothesis">
<p><span id="hyp:ClosenessPairs" class="hypothesis"><strong>Hypothesis 16.7  (Members of Each Pairs are Close) </strong></span>We assume that the members of the pairs generated by the pairing algorithm are close:
<span class="math display">\[\begin{align*}
  \plims\frac{1}{\lfloor\frac{N}{2}\rfloor}\sum_{j=1}^{\lfloor\frac{N}{2}\rfloor}\left|X_{\pi(2j)}-X_{\pi(2j-1)}\right|^r=0\text{, for }r=1\text{ and }r=2.
\end{align*}\]</span></p>
</div>
<p>For estimating the variance, we will also use the fact that consecutive pairs are also close:</p>
<div class="hypothesis">
<p><span id="hyp:ClosenessConsecutivePairs" class="hypothesis"><strong>Hypothesis 16.8  (Consecutive Pairs are Close) </strong></span>We assume that the consecutive pairs generated by the pairing algorithm are close:
<span class="math display">\[\begin{align*}
  \plims\frac{1}{\lfloor\frac{N}{2}\rfloor}\sum_{j=1}^{\lfloor\frac{N}{4}\rfloor}\left|X_{\pi(4j-k)}-X_{\pi(4j-l)}\right|^2=0\text{, for any }k\in\left\{2,3\right\}\text{ and }l\in\left\{0,1\right\}.
\end{align*}\]</span></p>
</div>
<p>We also need to formally assume that the allocation is random within pairs:</p>
<div class="hypothesis">
<p><span id="hyp:iidPairs" class="hypothesis"><strong>Hypothesis 16.9  (Randomized Allocation Within Pairs) </strong></span>We assume that treatment assignement is such that <span class="math inline">\((\mathbf{Y^1},\mathbf{Y^0})\Ind\mathbf{D}|\mathbf{X}\)</span> and that, conditional on <span class="math inline">\(\mathbf{X}\)</span>, <span class="math inline">\(\left\{(D_{\pi(2j-1)},D_{\pi(2j))}\right\}_{j\in\left\{1,\dots,\lfloor\frac{N}{2}\rfloor\right\}}\)</span> are i.i.d. and uniformly distributed over <span class="math inline">\(\left\{(0,1),(1,0)\right\}\)</span>.</p>
</div>
<p>Finally, we also need some to assume some restrictions on the potential outcomes:</p>
<div class="hypothesis">
<p><span id="hyp:FiniteVarStrata" class="hypothesis"><strong>Hypothesis 16.10  (Finite variance of potential outcomes) </strong></span>We assume that the distribution of potential outcomes in the population is such that:</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(\esp{\var{Y_i^d|X_i}}&gt;0\)</span>, for <span class="math inline">\(d\in\left\{0,1\right\}\)</span></li>
<li><span class="math inline">\(\esp{(Y^d_i)^2}&lt;\infty\)</span>, for <span class="math inline">\(d\in\left\{0,1\right\}\)</span></li>
<li><span class="math inline">\(\esp{Y^d_i|X_i=x}\)</span> and <span class="math inline">\(\esp{(Y^d_i)^2|X_i=x}\)</span> are Lipschitz for <span class="math inline">\(d\in\left\{0,1\right\}\)</span></li>
</ol>
</div>
<p>We can now state the following theorem:</p>
<div class="theorem">
<p><span id="thm:asympnoisePair" class="theorem"><strong>Theorem 16.8  (Sampling noise under pairwise randomization) </strong></span>Under Assumptions <a href="stratification.html#hyp:ClosenessPairs">16.7</a>, <a href="stratification.html#hyp:iidPairs">16.9</a> and <a href="stratification.html#hyp:FiniteVarStrata">16.10</a>, the asymptotic distribution of pairwise difference estimator can be approximated as follows:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}\left(\hat{\alpha}^{PD}-\Delta^{Y}_{ATE}\right) &amp; \distr \mathcal{N}\left(0,
\begin{array}{c}
\frac{\esp{\var{Y_i^1|X_i}}}{\frac{1}{2}}+\frac{\esp{\var{Y_i^0|X_i}}}{\frac{1}{2}}\\
+
\esp{\left(\esp{Y^1_i-Y^0_i|X_i}-\esp{Y_i^1-Y^0_i}\right)^2}
\end{array}
\right).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-331" class="proof"><em>Proof</em>. </span>See <a href="https://doi.org/10.1080/01621459.2021.1883437">Bai, Romano and Shaikh (2021)</a> Lemma S.1.4 in the Supplementary Appendix.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-332" class="remark"><em>Remark</em>. </span>We recognize the first two elements of the variance formula in Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a>: they are the usual variances of the potential outcomes, net of the impavct of the covariates used to build the pairs.
The last element takes into account of the fact that each time we take a new sample, we build new pairs, which generates variation in the average treatment effect that we estimate.</p>
</div>
<p>We now need to find estimators for the elements of the variance in Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a>.
<a href="https://doi.org/10.1080/01621459.2021.1883437">Bai, Romano and Shaikh (2021)</a> propose several estimators, but the most closely linked to the theoretical result is the following:</p>
<p><span class="math display">\[\begin{align*}
  \hat\nu^2 &amp; = \hat\varsigma^2+\hat\tau^2 \\
  \hat\varsigma^2 &amp; =\frac{1}{\lfloor\frac{N}{2}\rfloor}\sum_{l=1}^{\lfloor\frac{S}{2}\rfloor}\left(\Delta^Y_{\pi(2l)}-\Delta^Y_{\pi(2l-1)}\right)^2 \\
  \hat\tau^2 &amp; = \frac{1}{\lfloor\frac{N}{2}\rfloor}\sum_{s=1}^{S}\left(\Delta^Y_s-\hat\alpha^{PD}\right)^2
\end{align*}\]</span></p>
<p><span class="math inline">\(\hat\varsigma^2\)</span> is the average squared difference in pairwise treatment effects between consecutive pairs (note that the division is by <span class="math inline">\(\lfloor\frac{N}{2}\rfloor=S\)</span> the total number of consecutive pairs, not by <span class="math inline">\(\lfloor\frac{N}{4}\rfloor=\lfloor\frac{S}{2}\rfloor\)</span>, the actual number of consecutive pairs of pairs.
This component estimates the variance in treatment effects that is only due to unobserved covariates beyond <span class="math inline">\(X_i\)</span>, since consecutive pairs have very similar sets of observed covariates.
<span class="math inline">\(\hat\tau^2\)</span> measures the overall variance in treatment effects around the mean, again with the total sample size taken to normalize variances and not the number of pairs.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-530" class="example"><strong>Example 16.7  </strong></span>Let’s see how this works in our example.</p>
</div>
<p>Let us first compute the second component estimating the variance due to the treatment effect varying with covariates <span class="math inline">\(\hat\tau^2\)</span>.</p>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb514-1"><a href="stratification.html#cb514-1" aria-hidden="true" tabindex="-1"></a>hattau2 <span class="ot">&lt;-</span> data.strata.original <span class="sc">%&gt;%</span></span>
<span id="cb514-2"><a href="stratification.html#cb514-2" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(strata,Ds,y) <span class="sc">%&gt;%</span></span>
<span id="cb514-3"><a href="stratification.html#cb514-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pivot_wider</span>(<span class="at">names_from=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">values_from =</span>  <span class="st">&#39;y&#39;</span>,<span class="at">names_prefix=</span><span class="st">&#39;y&#39;</span>,<span class="at">names_sep=</span><span class="st">&#39;&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb514-4"><a href="stratification.html#cb514-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb514-5"><a href="stratification.html#cb514-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Deltay =</span> y1<span class="sc">-</span>y0</span>
<span id="cb514-6"><a href="stratification.html#cb514-6" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb514-7"><a href="stratification.html#cb514-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ungroup</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb514-8"><a href="stratification.html#cb514-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarize</span>(</span>
<span id="cb514-9"><a href="stratification.html#cb514-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">hattau2 =</span> <span class="fu">var</span>(Deltay)</span>
<span id="cb514-10"><a href="stratification.html#cb514-10" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb514-11"><a href="stratification.html#cb514-11" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pull</span>(hattau2)</span></code></pre></div>
<p>Let us now compute the value of <span class="math inline">\(\hat\varsigma^2\)</span>, the component of the variance due to variations in treatment effects triggered by unobserved covariates:</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb515-1"><a href="stratification.html#cb515-1" aria-hidden="true" tabindex="-1"></a>hatvarsigma2 <span class="ot">&lt;-</span> data.strata.original <span class="sc">%&gt;%</span></span>
<span id="cb515-2"><a href="stratification.html#cb515-2" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(strata,Ds,y) <span class="sc">%&gt;%</span></span>
<span id="cb515-3"><a href="stratification.html#cb515-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pivot_wider</span>(<span class="at">names_from=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">values_from =</span>  <span class="st">&#39;y&#39;</span>,<span class="at">names_prefix=</span><span class="st">&#39;y&#39;</span>,<span class="at">names_sep=</span><span class="st">&#39;&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb515-4"><a href="stratification.html#cb515-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb515-5"><a href="stratification.html#cb515-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Deltay =</span> y1<span class="sc">-</span>y0</span>
<span id="cb515-6"><a href="stratification.html#cb515-6" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb515-7"><a href="stratification.html#cb515-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ungroup</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb515-8"><a href="stratification.html#cb515-8" aria-hidden="true" tabindex="-1"></a>                <span class="co"># pairs of close pairs</span></span>
<span id="cb515-9"><a href="stratification.html#cb515-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb515-10"><a href="stratification.html#cb515-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">strata =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">/</span><span class="dv">4</span>),<span class="dv">2</span>)[<span class="fu">order</span>(<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">/</span><span class="dv">4</span>),<span class="dv">2</span>))]</span>
<span id="cb515-11"><a href="stratification.html#cb515-11" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb515-12"><a href="stratification.html#cb515-12" aria-hidden="true" tabindex="-1"></a>                <span class="co"># choose the first one as being untreated and the second one treated, that does not change anything since difference is then squared</span></span>
<span id="cb515-13"><a href="stratification.html#cb515-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb515-14"><a href="stratification.html#cb515-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Ds =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),N<span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb515-15"><a href="stratification.html#cb515-15" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb515-16"><a href="stratification.html#cb515-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="sc">-</span>y1,<span class="sc">-</span>y0) <span class="sc">%&gt;%</span></span>
<span id="cb515-17"><a href="stratification.html#cb515-17" aria-hidden="true" tabindex="-1"></a>                <span class="co"># pivoting to take pairwise differences in treatment effects</span></span>
<span id="cb515-18"><a href="stratification.html#cb515-18" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pivot_wider</span>(<span class="at">names_from=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">values_from =</span>  <span class="st">&#39;Deltay&#39;</span>,<span class="at">names_prefix=</span><span class="st">&#39;Deltay&#39;</span>,<span class="at">names_sep=</span><span class="st">&#39;&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb515-19"><a href="stratification.html#cb515-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb515-20"><a href="stratification.html#cb515-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">DeltaDeltay =</span> Deltay1<span class="sc">-</span>Deltay0</span>
<span id="cb515-21"><a href="stratification.html#cb515-21" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb515-22"><a href="stratification.html#cb515-22" aria-hidden="true" tabindex="-1"></a>                <span class="fu">summarize</span>(</span>
<span id="cb515-23"><a href="stratification.html#cb515-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">RSS =</span> <span class="fu">sum</span>(DeltaDeltay<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb515-24"><a href="stratification.html#cb515-24" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb515-25"><a href="stratification.html#cb515-25" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb515-26"><a href="stratification.html#cb515-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">hatvarsigma2=</span>RSS<span class="sc">/</span>(N<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb515-27"><a href="stratification.html#cb515-27" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb515-28"><a href="stratification.html#cb515-28" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pull</span>(hatvarsigma2)</span></code></pre></div>
<p>Let us now sum the two components and take their square root to extract the estimated standard error for our pairwise difference estimator:</p>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb516-1"><a href="stratification.html#cb516-1" aria-hidden="true" tabindex="-1"></a>hatnu2 <span class="ot">&lt;-</span> hatvarsigma2<span class="sc">+</span>hattau2</span>
<span id="cb516-2"><a href="stratification.html#cb516-2" aria-hidden="true" tabindex="-1"></a>hatsealphaPD <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(hatnu2<span class="sc">/</span>N)</span></code></pre></div>
<p>With 95% confidence, our estimate of the treatment effect using the pairwise design is therefore 0.17 <span class="math inline">\(\pm\)</span> 0.03.
99% estimated sampling noise is therefore 0.09.
This is very close to the level of sampling noise that remains when analyzing a classical stratified randomized controlled trial with 100 strata using the saturated model, as Figure <a href="stratification.html#fig:montecarlobruteforcewwyBStrataPlot">16.3</a> shows: 99% sampling noise is equal to 0.09 with 100 strata.
Since pairwise randomization is the limit of taking an increasing number of strata, and sampling noise seems to level off at around 25 strata, this results makes a lot of sense.
I leave running Monte Carlo simulations to check that the CLT approximation .</p>
<div class="remark">
<p><span id="unlabeled-div-333" class="remark"><em>Remark</em>. </span>Estimating sampling noise using the formula in Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a> is slightly more involved than reading the result of a regression.
While I’m not aware that these estimators have been programmed in any software for now, <a href="https://doi.org/10.1080/01621459.2021.1883437">Bai, Romano and Shaikh (2021)</a>’s Theorem 3.2 shows that we can use a simpler estimator for sampling noise.
Indeed, the default standard error of the simple pairwise difference OLS estimator (under homoskedasticity) provides a conservative estimate of the sampling noise of the pairwise difference estimator.
It is conservative in the sense that it is larger than the true level of sampling noise, unless the covariates used for stratification do not matter for treatment effect heterogeneity (for example because the treatment effect is constant of your covariates are crappy at capturing variations in treatment effect heterogeneity).
In that case, the default OLS standard error is a consistent estimator of the standard error of the pairwise difference estimator.
Actually, the default standard error of the simple pairwise difference OLS estimator is equal to <span class="math inline">\(\sqrt{2\frac{\hat\tau^2}{N}}\)</span>.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-532" class="example"><strong>Example 16.8  </strong></span>Let’s see how that works in our example.</p>
</div>
<div class="sourceCode" id="cb517"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb517-1"><a href="stratification.html#cb517-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PD</span></span>
<span id="cb517-2"><a href="stratification.html#cb517-2" aria-hidden="true" tabindex="-1"></a>regPDSummary <span class="ot">&lt;-</span> data.strata.original <span class="sc">%&gt;%</span></span>
<span id="cb517-3"><a href="stratification.html#cb517-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(strata,Ds,y) <span class="sc">%&gt;%</span></span>
<span id="cb517-4"><a href="stratification.html#cb517-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_wider</span>(<span class="at">names_from=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">values_from =</span>  <span class="st">&#39;y&#39;</span>,<span class="at">names_prefix=</span><span class="st">&#39;y&#39;</span>,<span class="at">names_sep=</span><span class="st">&#39;&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb517-5"><a href="stratification.html#cb517-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb517-6"><a href="stratification.html#cb517-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">Deltay =</span> y1<span class="sc">-</span>y0</span>
<span id="cb517-7"><a href="stratification.html#cb517-7" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb517-8"><a href="stratification.html#cb517-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lm</span>(Deltay<span class="sc">~</span><span class="dv">1</span>,<span class="at">data=</span>.) </span></code></pre></div>
<p>The fully OLS based pairwise difference estimate is equal to 0.17 <span class="math inline">\(\pm\)</span> 0.03.
99% estimated sampling noise using the default OLS standard error in the pairwise regression is therefore 0.09.
As we can see, in our application, using the default OLS standard errors or the more refined ones stemming from Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a> deliver almost undistinguishable results (you have to go far into the digits to actually start finding a difference).
That result starts making sense when you look at the formula for <span class="math inline">\(\hat\varsigma^2\)</span>: if treatment effects are not predicted well by covariates, it simply provides another estimator for half the variance of the treatment effect (all variation in treatment effects between similar pairs comes from variance in <span class="math inline">\(Y^1_i\)</span> and <span class="math inline">\(Y_i^0\)</span> that is not accounted for by covariates).</p>
<div class="remark">
<p><span id="unlabeled-div-334" class="remark"><em>Remark</em>. </span><a href="https://www.jstor.org/stable/27917244">Abadie and Angrist (2008)</a> show that <span class="math inline">\(\sqrt{2\frac{\hat\varsigma^2}{N}}\)</span> provides an estimate of the standard error of the sample average treatment effect in pairwise randomized experiments.
This estimate can be much smaller than the actual default OLS standard error, and even than the correct standard error based on Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a>.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-534" class="example"><strong>Example 16.9  </strong></span>Let’s see how this works in our example.</p>
</div>
<p>We have <span class="math inline">\(\sqrt{\frac{2\hat\varsigma^2}{N}}=\)</span> 0.02, which is almost identical to the default OLS-based estimate and to the correct estimate stemming from Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a>.
We also have that <span class="math inline">\(\sqrt{\frac{2\hat\tau^2}{N}}=\)</span> 0.02 which is exactly equal to the default OLS-based estimate, as expected.</p>
<div class="remark">
<p><span id="unlabeled-div-335" class="remark"><em>Remark</em>. </span><a href="https://doi.org/10.1080/01621459.2021.1883437">Bai, Romano and Shaikh (2021)</a> show in simulations and applications that you sometimes lose considerable precision by using the default standard errors of the OLS-based pairwise difference estimator.
Things are not always as rosy as in our application.
As a consequence, I would urge everyone to use the results of Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a> instead of the default OLS standard errors.
The default OLS ones will capture the gains in power due to reduction in the variance of outcomes, while the corrected ones from Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a> will capture both these improvements and the ones due to a decrease in sampling noise stemming from variations in treatment effects over samples.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-336" class="remark"><em>Remark</em>. </span>Randomization inference is also a possible way to estimate standard errors and obtain confidence intervals in pairwise randomized experiments.
Theorem 3.5 in <a href="https://doi.org/10.1080/01621459.2021.1883437">Bai, Romano and Shaikh (2021)</a> shows that using the t-statistic based on Theorem <a href="stratification.html#thm:asympnoisePair">16.8</a> offers correct coverage.
Inverting the test-statistic of repeated randomization inference under various assumptions for the value of the treatment effect as done in Section <a href="cluster.html#RI">9.1.3.5</a> is one way to obtain confidence intervals using randomization inference.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-337" class="remark"><em>Remark</em>. </span>Randomization inference might yield imprecise confidence intervals because of the lumpyness of the choice of the grid for the hypothetized value of the treatment effect.
In order to avoid that issue, the best approach is to solve numerically for the two bounds of the confidence interval using the fact that they are defined as solutions to nonlinear equations, as remarked by <a href="https://www.tandfonline.com/doi/abs/10.1198/016214505000001258">Ho and Imai (2006)</a>.</p>
</div>
<p>The nonlinear equation defining <span class="math inline">\(C_g^U\)</span> and <span class="math inline">\(C_g^L\)</span>, the upper and lower bounds of the confidence interval, are defined as follows:</p>
<p><span class="math display">\[\begin{align*}
  f(C_g) &amp; = \hat p(C_g)-0.05 =0,
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\hat p(C_g)=\Pr(\hat T_{RI}(C_g)\geq \hat T(C_g))\)</span>, <span class="math inline">\(\hat T_{RI}(C_g)\)</span> is the distribution of the t-statistic under the null estimated by randomization inference, <span class="math inline">\(\hat T(C_g)\)</span> is the true value of the test statistic under the null in the sample, and <span class="math inline">\(C_g^U\leq \hat \delta \leq C_g^L\)</span>.
In order to solve <span class="math inline">\(f(C_g)=0\)</span> for <span class="math inline">\(C_g^U\)</span> and <span class="math inline">\(C_g^L\)</span>, we can use either the bisection method or Newton’s method adapted for when <span class="math inline">\(f&#39;\)</span> is unknown (<em>i.e.</em> the secant method) (see <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/j.1467-6435.1999.tb02815.x%5D">Judd (1998)</a>).</p>
<p>For the Newton/secant method, we need to find two starting points, <span class="math inline">\(C_g^{L}(0)\)</span> and <span class="math inline">\(C_g^{U}(0)\)</span>.
I propose to use the extremities of the confidence intervals estimated using the OLS standard errors based on the Central Limit Theorem.
We then compute <span class="math inline">\(C_g(k+1)=C_g(k)-f(C_g(k))\frac{C_g(k)-C_g(k-1)}{f(C_g(k))-f(C_g(k-1))}\)</span>, where <span class="math inline">\(C_g(-1)=\hat\alpha^{PD}\)</span>.
We stop when <span class="math inline">\(|C_g(k)-C_g(k+1)|\leq\epsilon(1+|C_g(k+1)|)\)</span>.
If <span class="math inline">\(|f(C_g(k+1))|\leq\psi\)</span>, we report <span class="math inline">\(C_g(k+1)\)</span> as the result, otherwise, we report failure of convergence.</p>
<p>For the bisection method, we need to find four starting values <span class="math inline">\(C_g^{L,l}(0)\)</span> and <span class="math inline">\(C_g^{L,u}(0)\)</span> and <span class="math inline">\(C_g^{U,l}(0)\)</span> and <span class="math inline">\(C_g^{U,u}(0)\)</span> such that <span class="math inline">\(f(C_g^{L,l}(0))&lt;0\)</span> and <span class="math inline">\(f(C_g^{L,u}(0))&gt;0\)</span> and <span class="math inline">\(f(C_g^{U,l}(0))&lt;0\)</span> and <span class="math inline">\(f(C_g^{U,u}(0))&gt;0\)</span>.
I propose to start with <span class="math inline">\(C_g^{L,u}(0)=C_g^{U,l}(0)=\hat\alpha^{PD}\)</span> and <span class="math inline">\(C_g^{L,l}(0)=\hat\alpha^{PD}-k\hat\sigma_{\hat\alpha^{PD}}\)</span> and <span class="math inline">\(C_g^{U,lu}(0)=\hat\alpha^{PD}+k\hat\sigma_{\hat\alpha^{PD}}\)</span>, with <span class="math inline">\(k\)</span> an appropriately big enough quantile of the standard normal, for example the 0.9995 quantile which is equal to 3.29 and <span class="math inline">\(\hat\sigma_{\hat\alpha^{PD}}\)</span> an initial estimate of the standard error of the treatment effect, for example the default OLS one.
Once we have the interval, we compute its mid-point, <span class="math inline">\(C_g^M(0)\)</span> and we calculate <span class="math inline">\(f(C_g^M(0))\)</span>.
We refine the bounds by replacing the bound with the same sign as the one of <span class="math inline">\(f(C_g^M)\)</span> by <span class="math inline">\(C_g^M\)</span>.
The other bound stays unchanged.
We obtain <span class="math inline">\(C_g^{l}(1)\)</span> and <span class="math inline">\(C_g^{u}(1)\)</span>.
We keep updating until <span class="math inline">\(C_g^{u}(k)-C_g^{l}(k)\leq\epsilon(1+|C_g^{l}(k)|+|C_g^{u}(k)|)\)</span> or <span class="math inline">\(f(C_g^{M}(k))\leq\psi\)</span>, with <span class="math inline">\(\epsilon\)</span> and <span class="math inline">\(\psi\)</span> pre-specified precision levels.</p>
<p>I leave the implementation of these methods as an exercise.
In my own applications, I have found that the bisection method is more robust and always converges.</p>
<div class="remark">
<p><span id="unlabeled-div-338" class="remark"><em>Remark</em>. </span>A key remaining question is whether we should use classical stratified designs or pairwise designs.
Recently, <a href="10.1257/aer.20201856">Bai (2022)</a> has shown that the pairwise design achieves maximum precision among the set of stratified designs where the probability of assignment is one half.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-339" class="remark"><em>Remark</em>. </span>Another important question is how to optimally include covariates when analyzing stratified experiments.
<a href="https://doi.org/10.48550/arXiv.2302.03687">Cytrynbaum (2023a)</a> shows how to make this choice optimally.
In the pairwise randomized experiment, including covariates is optimal.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-340" class="remark"><em>Remark</em>. </span>Another important question is how to optimally build our strata: which covariates to use, how to use pilot data to build the strata, for example.
These key questions are examined by <a href="https://doi.org/10.48550/arXiv.2111.08157">Cytrynbaum (2023b)</a>.
<a href="https://doi.org/10.48550/arXiv.2111.08157">Cytrynbaum (2023b)</a> also provides estimators for the precision of treatment effects estimated after covariate adjusted selection of pairs and strata relfecting the full gain in precision due to stratification.</p>
</div>

</div>
</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="mediation-analysis.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="proofs.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/chabefer/STCI/blob/master/15_stratification.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["STCI.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"toc_depth": 1
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
