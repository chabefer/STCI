<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Natural Experiments | Statistical Tools for Causal Inference</title>
  <meta name="description" content="This is an open source collaborative book." />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Natural Experiments | Statistical Tools for Causal Inference" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is an open source collaborative book." />
  <meta name="github-repo" content="chabefer/STCI" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Natural Experiments | Statistical Tools for Causal Inference" />
  
  <meta name="twitter:description" content="This is an open source collaborative book." />
  

<meta name="author" content="Sylvain Chabé-Ferret" />


<meta name="date" content="2025-03-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="RCT.html"/>
<link rel="next" href="OM.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
$$
\newcommand{\uns}[1]{\mathbf{1}[#1]}
\newcommand{\unsi}[2]{\mathbf{1}_{#1}(#2)}
\newcommand{\N}{\mathbf{N}}
\newcommand{\R}{\mathbf{R}}
\newcommand{\esp}[1]{\mathbf{E}[#1]}
\newcommand{\espsub}[2]{\mathbf{E}_{#2}[#1]}
\newcommand{\hatesp}[1]{\hat{\mathbf{E}}[ #1 ]}
\newcommand{\espE}{\mathbf{E}}
\newcommand{\Ind}{\perp\kern-5pt\perp}
\newcommand{\var}[1]{\mathbf{V}[ #1 ]}
\newcommand{\hatvar}[1]{\hat{\mathbf{V}}[ #1 ]}
\newcommand{\cov}[1]{\mathbf{C}[ #1 ]}
\newcommand{\plim}[1]{\text{plim}_{ #1 \rightarrow \infty}}
\newcommand{\plims}{\text{plim}}
\newcommand{\distr}{\stackrel{d}{\rightarrow}}
\newcommand{\probconv}{\stackrel{p}{\rightarrow}}
\newcommand{\partder}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\partdersq}[2]{\frac{\partial^2 #1}{\partial #2^2}}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\asym}{Asym}
$$


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Statistical Tools for Causal Inference</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="part"><span><b>I Fundamental Problems of Inference</b></span></li>
<li class="chapter" data-level="" data-path="introduction-the-two-fundamental-problems-of-inference.html"><a href="introduction-the-two-fundamental-problems-of-inference.html"><i class="fa fa-check"></i>Introduction: the Two Fundamental Problems of Inference</a></li>
<li class="chapter" data-level="1" data-path="FPCI.html"><a href="FPCI.html"><i class="fa fa-check"></i><b>1</b> Fundamental Problem of Causal Inference</a>
<ul>
<li class="chapter" data-level="1.1" data-path="FPCI.html"><a href="FPCI.html#rubin-causal-model"><i class="fa fa-check"></i><b>1.1</b> Rubin Causal Model</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="FPCI.html"><a href="FPCI.html#treatment-allocation-rule"><i class="fa fa-check"></i><b>1.1.1</b> Treatment allocation rule</a></li>
<li class="chapter" data-level="1.1.2" data-path="FPCI.html"><a href="FPCI.html#potential-outcomes"><i class="fa fa-check"></i><b>1.1.2</b> Potential outcomes</a></li>
<li class="chapter" data-level="1.1.3" data-path="FPCI.html"><a href="FPCI.html#switching-equation"><i class="fa fa-check"></i><b>1.1.3</b> Switching equation</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="FPCI.html"><a href="FPCI.html#treatment-effects"><i class="fa fa-check"></i><b>1.2</b> Treatment effects</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="FPCI.html"><a href="FPCI.html#individual-level-treatment-effects"><i class="fa fa-check"></i><b>1.2.1</b> Individual level treatment effects</a></li>
<li class="chapter" data-level="1.2.2" data-path="FPCI.html"><a href="FPCI.html#average-treatment-effect-on-the-treated"><i class="fa fa-check"></i><b>1.2.2</b> Average treatment effect on the treated</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="FPCI.html"><a href="FPCI.html#fundamental-problem-of-causal-inference"><i class="fa fa-check"></i><b>1.3</b> Fundamental problem of causal inference</a></li>
<li class="chapter" data-level="1.4" data-path="FPCI.html"><a href="FPCI.html#intuitive-estimators-confounding-factors-and-selection-bias"><i class="fa fa-check"></i><b>1.4</b> Intuitive estimators, confounding factors and selection bias</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="FPCI.html"><a href="FPCI.html#withwithout-comparison-selection-bias-and-cross-sectional-confounders"><i class="fa fa-check"></i><b>1.4.1</b> With/Without comparison, selection bias and cross-sectional confounders</a></li>
<li class="chapter" data-level="1.4.2" data-path="FPCI.html"><a href="FPCI.html#the-beforeafter-comparison-temporal-confounders-and-time-trend-bias"><i class="fa fa-check"></i><b>1.4.2</b> The before/after comparison, temporal confounders and time trend bias</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="FPSI.html"><a href="FPSI.html"><i class="fa fa-check"></i><b>2</b> Fundamental Problem of Statistical Inference</a>
<ul>
<li class="chapter" data-level="2.1" data-path="FPSI.html"><a href="FPSI.html#sec:sampnoise"><i class="fa fa-check"></i><b>2.1</b> What is sampling noise? Definition and illustration</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="FPSI.html"><a href="FPSI.html#sec:definitionnoise"><i class="fa fa-check"></i><b>2.1.1</b> Sampling noise, a definition</a></li>
<li class="chapter" data-level="2.1.2" data-path="FPSI.html"><a href="FPSI.html#sec:illusnoisepop"><i class="fa fa-check"></i><b>2.1.2</b> Sampling noise for the population treatment effect</a></li>
<li class="chapter" data-level="2.1.3" data-path="FPSI.html"><a href="FPSI.html#sec:illusnoisesamp"><i class="fa fa-check"></i><b>2.1.3</b> Sampling noise for the sample treatment effect</a></li>
<li class="chapter" data-level="2.1.4" data-path="FPSI.html"><a href="FPSI.html#sec:confinterv"><i class="fa fa-check"></i><b>2.1.4</b> Building confidence intervals from estimates of sampling noise</a></li>
<li class="chapter" data-level="2.1.5" data-path="FPSI.html"><a href="FPSI.html#reporting-sampling-noise-a-proposal"><i class="fa fa-check"></i><b>2.1.5</b> Reporting sampling noise: a proposal</a></li>
<li class="chapter" data-level="2.1.6" data-path="FPSI.html"><a href="FPSI.html#sec:effectsize"><i class="fa fa-check"></i><b>2.1.6</b> Using effect sizes to normalize the reporting of treatment effects and their precision</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="FPSI.html"><a href="FPSI.html#sec:estimsampnoise"><i class="fa fa-check"></i><b>2.2</b> Estimating sampling noise</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="FPSI.html"><a href="FPSI.html#sec:assumptions"><i class="fa fa-check"></i><b>2.2.1</b> Assumptions</a></li>
<li class="chapter" data-level="2.2.2" data-path="FPSI.html"><a href="FPSI.html#sec:cheb"><i class="fa fa-check"></i><b>2.2.2</b> Using Chebyshev’s inequality</a></li>
<li class="chapter" data-level="2.2.3" data-path="FPSI.html"><a href="FPSI.html#sec:CLT"><i class="fa fa-check"></i><b>2.2.3</b> Using the Central Limit Theorem</a></li>
<li class="chapter" data-level="2.2.4" data-path="FPSI.html"><a href="FPSI.html#sec:resamp"><i class="fa fa-check"></i><b>2.2.4</b> Using resampling methods</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Methods of Causal Inference</b></span></li>
<li class="chapter" data-level="3" data-path="RCT.html"><a href="RCT.html"><i class="fa fa-check"></i><b>3</b> Randomized Controlled Trials</a>
<ul>
<li class="chapter" data-level="3.1" data-path="RCT.html"><a href="RCT.html#sec:design1"><i class="fa fa-check"></i><b>3.1</b> Brute Force Design</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="RCT.html"><a href="RCT.html#identification"><i class="fa fa-check"></i><b>3.1.1</b> Identification</a></li>
<li class="chapter" data-level="3.1.2" data-path="RCT.html"><a href="RCT.html#estimating-ate"><i class="fa fa-check"></i><b>3.1.2</b> Estimating ATE</a></li>
<li class="chapter" data-level="3.1.3" data-path="RCT.html"><a href="RCT.html#estimating-sampling-noise"><i class="fa fa-check"></i><b>3.1.3</b> Estimating Sampling Noise</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="RCT.html"><a href="RCT.html#sec:design2"><i class="fa fa-check"></i><b>3.2</b> Self-Selection design</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="RCT.html"><a href="RCT.html#identification-1"><i class="fa fa-check"></i><b>3.2.1</b> Identification</a></li>
<li class="chapter" data-level="3.2.2" data-path="RCT.html"><a href="RCT.html#estimating-tt"><i class="fa fa-check"></i><b>3.2.2</b> Estimating TT</a></li>
<li class="chapter" data-level="3.2.3" data-path="RCT.html"><a href="RCT.html#estimating-sampling-noise-1"><i class="fa fa-check"></i><b>3.2.3</b> Estimating Sampling Noise</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="RCT.html"><a href="RCT.html#sec:design3"><i class="fa fa-check"></i><b>3.3</b> Eligibility design</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="RCT.html"><a href="RCT.html#identification-2"><i class="fa fa-check"></i><b>3.3.1</b> Identification</a></li>
<li class="chapter" data-level="3.3.2" data-path="RCT.html"><a href="RCT.html#estimating-the-ite-and-the-tt"><i class="fa fa-check"></i><b>3.3.2</b> Estimating the ITE and the TT</a></li>
<li class="chapter" data-level="3.3.3" data-path="RCT.html"><a href="RCT.html#estimating-sampling-noise-2"><i class="fa fa-check"></i><b>3.3.3</b> Estimating sampling noise</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="RCT.html"><a href="RCT.html#sec:design4"><i class="fa fa-check"></i><b>3.4</b> Encouragement Design</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="RCT.html"><a href="RCT.html#identification-3"><i class="fa fa-check"></i><b>3.4.1</b> Identification</a></li>
<li class="chapter" data-level="3.4.2" data-path="RCT.html"><a href="RCT.html#IVRCT"><i class="fa fa-check"></i><b>3.4.2</b> Estimating the Local Average Treatment Effect and the Intention to Treat Effect</a></li>
<li class="chapter" data-level="3.4.3" data-path="RCT.html"><a href="RCT.html#estimating-sampling-noise-3"><i class="fa fa-check"></i><b>3.4.3</b> Estimating sampling noise</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="NE.html"><a href="NE.html"><i class="fa fa-check"></i><b>4</b> Natural Experiments</a>
<ul>
<li class="chapter" data-level="4.1" data-path="NE.html"><a href="NE.html#instrumental-variables"><i class="fa fa-check"></i><b>4.1</b> Instrumental Variables</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="NE.html"><a href="NE.html#an-example-where-monotonicity-does-not-hold"><i class="fa fa-check"></i><b>4.1.1</b> An example where Monotonicity does not hold</a></li>
<li class="chapter" data-level="4.1.2" data-path="NE.html"><a href="NE.html#identification-4"><i class="fa fa-check"></i><b>4.1.2</b> Identification</a></li>
<li class="chapter" data-level="4.1.3" data-path="NE.html"><a href="NE.html#estimation"><i class="fa fa-check"></i><b>4.1.3</b> Estimation</a></li>
<li class="chapter" data-level="4.1.4" data-path="NE.html"><a href="NE.html#estimation-of-sampling-noise"><i class="fa fa-check"></i><b>4.1.4</b> Estimation of sampling noise</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="NE.html"><a href="NE.html#regression-discontinuity-designs"><i class="fa fa-check"></i><b>4.2</b> Regression Discontinuity Designs</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="NE.html"><a href="NE.html#sharp-regression-discontinuity-designs"><i class="fa fa-check"></i><b>4.2.1</b> Sharp Regression Discontinuity Designs</a></li>
<li class="chapter" data-level="4.2.2" data-path="NE.html"><a href="NE.html#fuzzy-regression-discontinuity-designs"><i class="fa fa-check"></i><b>4.2.2</b> Fuzzy Regression Discontinuity Designs</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="NE.html"><a href="NE.html#DID"><i class="fa fa-check"></i><b>4.3</b> Difference In Differences</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="NE.html"><a href="NE.html#sec:DIDbasic"><i class="fa fa-check"></i><b>4.3.1</b> Difference In Differences with two time periods</a></li>
<li class="chapter" data-level="4.3.2" data-path="NE.html"><a href="NE.html#sec:DIDr"><i class="fa fa-check"></i><b>4.3.2</b> Reverse Difference In Differences designs with two time periods</a></li>
<li class="chapter" data-level="4.3.3" data-path="NE.html"><a href="NE.html#DIDStaggered"><i class="fa fa-check"></i><b>4.3.3</b> Difference In Differences with multiple time periods</a></li>
<li class="chapter" data-level="4.3.4" data-path="NE.html"><a href="NE.html#difference-in-differences-with-instrumental-variables"><i class="fa fa-check"></i><b>4.3.4</b> Difference In Differences with Instrumental Variables</a></li>
<li class="chapter" data-level="4.3.5" data-path="NE.html"><a href="NE.html#difference-in-differences-with-continuous-treatment-variables-and-staggered-adoption"><i class="fa fa-check"></i><b>4.3.5</b> Difference In Differences with Continuous Treatment Variables and Staggered Adoption</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="OM.html"><a href="OM.html"><i class="fa fa-check"></i><b>5</b> Observational Methods</a>
<ul>
<li class="chapter" data-level="5.1" data-path="OM.html"><a href="OM.html#parametric-methods"><i class="fa fa-check"></i><b>5.1</b> Parametric methods</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="OM.html"><a href="OM.html#assuming-espy_i0x_i-is-known"><i class="fa fa-check"></i><b>5.1.1</b> Assuming <span class="math inline">\(\esp{Y_i^0|X_i}\)</span> is known</a></li>
<li class="chapter" data-level="5.1.2" data-path="OM.html"><a href="OM.html#assuming-espy_i1x_i-is-known"><i class="fa fa-check"></i><b>5.1.2</b> Assuming <span class="math inline">\(\esp{Y_i^1|X_i}\)</span> is known</a></li>
<li class="chapter" data-level="5.1.3" data-path="OM.html"><a href="OM.html#BiasOLS"><i class="fa fa-check"></i><b>5.1.3</b> Properties of the OLS estimator under Conditional Independence</a></li>
<li class="chapter" data-level="5.1.4" data-path="OM.html"><a href="OM.html#problems-with-parametric-methods"><i class="fa fa-check"></i><b>5.1.4</b> Problems with parametric methods</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="OM.html"><a href="OM.html#nonparametric-methods"><i class="fa fa-check"></i><b>5.2</b> Nonparametric methods</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="OM.html"><a href="OM.html#identification-13"><i class="fa fa-check"></i><b>5.2.1</b> Identification</a></li>
<li class="chapter" data-level="5.2.2" data-path="OM.html"><a href="OM.html#estimation-9"><i class="fa fa-check"></i><b>5.2.2</b> Estimation</a></li>
<li class="chapter" data-level="5.2.3" data-path="OM.html"><a href="OM.html#estimating-precision-2"><i class="fa fa-check"></i><b>5.2.3</b> Estimating precision</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="OM.html"><a href="OM.html#imputation-methods"><i class="fa fa-check"></i><b>5.3</b> Imputation methods</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="threats.html"><a href="threats.html"><i class="fa fa-check"></i><b>6</b> Threats to the validity of Causal Inference</a>
<ul>
<li class="chapter" data-level="6.1" data-path="threats.html"><a href="threats.html#threats-to-internal-validity"><i class="fa fa-check"></i><b>6.1</b> Threats to internal validity</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="threats.html"><a href="threats.html#survey-bias"><i class="fa fa-check"></i><b>6.1.1</b> Survey bias</a></li>
<li class="chapter" data-level="6.1.2" data-path="threats.html"><a href="threats.html#experimenter-bias"><i class="fa fa-check"></i><b>6.1.2</b> Experimenter bias</a></li>
<li class="chapter" data-level="6.1.3" data-path="threats.html"><a href="threats.html#substitution-bias"><i class="fa fa-check"></i><b>6.1.3</b> Substitution bias</a></li>
<li class="chapter" data-level="6.1.4" data-path="threats.html"><a href="threats.html#diffusion-bias"><i class="fa fa-check"></i><b>6.1.4</b> Diffusion bias</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="threats.html"><a href="threats.html#threats-to-the-measurement-of-precision"><i class="fa fa-check"></i><b>6.2</b> Threats to the measurement of precision</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="threats.html"><a href="threats.html#insufficient-precision"><i class="fa fa-check"></i><b>6.2.1</b> Insufficient precision</a></li>
<li class="chapter" data-level="6.2.2" data-path="threats.html"><a href="threats.html#clustering"><i class="fa fa-check"></i><b>6.2.2</b> Clustering</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="threats.html"><a href="threats.html#threats-to-external-validity"><i class="fa fa-check"></i><b>6.3</b> Threats to external validity</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="threats.html"><a href="threats.html#randomization-bias"><i class="fa fa-check"></i><b>6.3.1</b> Randomization bias</a></li>
<li class="chapter" data-level="6.3.2" data-path="threats.html"><a href="threats.html#equilibrium-effects"><i class="fa fa-check"></i><b>6.3.2</b> Equilibrium effects</a></li>
<li class="chapter" data-level="6.3.3" data-path="threats.html"><a href="threats.html#context-effects"><i class="fa fa-check"></i><b>6.3.3</b> Context effects</a></li>
<li class="chapter" data-level="6.3.4" data-path="threats.html"><a href="threats.html#site-selection-bias"><i class="fa fa-check"></i><b>6.3.4</b> Site selection bias</a></li>
<li class="chapter" data-level="6.3.5" data-path="threats.html"><a href="threats.html#publication-bias"><i class="fa fa-check"></i><b>6.3.5</b> Publication bias</a></li>
<li class="chapter" data-level="6.3.6" data-path="threats.html"><a href="threats.html#ethical-and-political-issues"><i class="fa fa-check"></i><b>6.3.6</b> Ethical and political issues</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Additional Topics</b></span></li>
<li class="chapter" data-level="7" data-path="Power.html"><a href="Power.html"><i class="fa fa-check"></i><b>7</b> Power Analysis</a>
<ul>
<li class="chapter" data-level="7.1" data-path="Power.html"><a href="Power.html#basics-of-traditional-power-analysis-using-test-statistics"><i class="fa fa-check"></i><b>7.1</b> Basics of traditional power analysis using test statistics</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="Power.html"><a href="Power.html#power"><i class="fa fa-check"></i><b>7.1.1</b> Power</a></li>
<li class="chapter" data-level="7.1.2" data-path="Power.html"><a href="Power.html#minimum-detectable-effect"><i class="fa fa-check"></i><b>7.1.2</b> Minimum Detectable Effect</a></li>
<li class="chapter" data-level="7.1.3" data-path="Power.html"><a href="Power.html#minimum-required-sample-size"><i class="fa fa-check"></i><b>7.1.3</b> Minimum Required Sample Size</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="Power.html"><a href="Power.html#traditional-power-analysis-in-practice"><i class="fa fa-check"></i><b>7.2</b> Traditional power analysis in practice</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="Power.html"><a href="Power.html#power-analysis-for-randomized-controlled-trials"><i class="fa fa-check"></i><b>7.2.1</b> Power Analysis for Randomized Controlled Trials</a></li>
<li class="chapter" data-level="7.2.2" data-path="Power.html"><a href="Power.html#power-analysis-for-natural-experiments"><i class="fa fa-check"></i><b>7.2.2</b> Power Analysis for Natural Experiments</a></li>
<li class="chapter" data-level="7.2.3" data-path="Power.html"><a href="Power.html#power-analysis-for-observational-methods"><i class="fa fa-check"></i><b>7.2.3</b> Power Analysis for Observational Methods</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="Power.html"><a href="Power.html#limitations-of-and-alternatives-to-traditional-power-analysis"><i class="fa fa-check"></i><b>7.3</b> Limitations of and alternatives to traditional power analysis</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="Power.html"><a href="Power.html#limitations-of-traditional-power-analysis"><i class="fa fa-check"></i><b>7.3.1</b> Limitations of traditional power analysis</a></li>
<li class="chapter" data-level="7.3.2" data-path="Power.html"><a href="Power.html#an-alternative-to-traditional-power-analysis"><i class="fa fa-check"></i><b>7.3.2</b> An alternative to traditional power analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="placebo.html"><a href="placebo.html"><i class="fa fa-check"></i><b>8</b> Placebo Tests</a>
<ul>
<li class="chapter" data-level="8.1" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-randomized-controlled-trials"><i class="fa fa-check"></i><b>8.1</b> Placebo tests for randomized controlled trials</a></li>
<li class="chapter" data-level="8.2" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-natural-experiments"><i class="fa fa-check"></i><b>8.2</b> Placebo tests for natural experiments</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-instrumental-variables"><i class="fa fa-check"></i><b>8.2.1</b> Placebo tests for Instrumental Variables</a></li>
<li class="chapter" data-level="8.2.2" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-regression-discontinuity-designs"><i class="fa fa-check"></i><b>8.2.2</b> Placebo tests for Regression Discontinuity Designs</a></li>
<li class="chapter" data-level="8.2.3" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-difference-in-differences"><i class="fa fa-check"></i><b>8.2.3</b> Placebo tests for Difference in Differences</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="placebo.html"><a href="placebo.html#placebo-tests-for-observational-methods"><i class="fa fa-check"></i><b>8.3</b> Placebo tests for observational methods</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="cluster.html"><a href="cluster.html"><i class="fa fa-check"></i><b>9</b> Clustering</a>
<ul>
<li class="chapter" data-level="9.1" data-path="cluster.html"><a href="cluster.html#ClusterRCT"><i class="fa fa-check"></i><b>9.1</b> Clustering in Randomized Controlled Trials</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="cluster.html"><a href="cluster.html#an-example"><i class="fa fa-check"></i><b>9.1.1</b> An example</a></li>
<li class="chapter" data-level="9.1.2" data-path="cluster.html"><a href="cluster.html#design-effect"><i class="fa fa-check"></i><b>9.1.2</b> Design effect</a></li>
<li class="chapter" data-level="9.1.3" data-path="cluster.html"><a href="cluster.html#estimating-sampling-noise-accounting-for-clustering"><i class="fa fa-check"></i><b>9.1.3</b> Estimating sampling noise accounting for clustering</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="cluster.html"><a href="cluster.html#clustering-in-panel-data"><i class="fa fa-check"></i><b>9.2</b> Clustering in panel data</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="cluster.html"><a href="cluster.html#an-example-1"><i class="fa fa-check"></i><b>9.2.1</b> An example</a></li>
<li class="chapter" data-level="9.2.2" data-path="cluster.html"><a href="cluster.html#design-effect-in-panel-data"><i class="fa fa-check"></i><b>9.2.2</b> Design effect in panel data</a></li>
<li class="chapter" data-level="9.2.3" data-path="cluster.html"><a href="cluster.html#estimating-sampling-noise-in-panel-data-with-autocorrelated-error-terms"><i class="fa fa-check"></i><b>9.2.3</b> Estimating sampling noise in panel data with autocorrelated error terms</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="cluster.html"><a href="cluster.html#spatial-correlation"><i class="fa fa-check"></i><b>9.3</b> Spatial correlation</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="cluster.html"><a href="cluster.html#an-example-2"><i class="fa fa-check"></i><b>9.3.1</b> An example</a></li>
<li class="chapter" data-level="9.3.2" data-path="cluster.html"><a href="cluster.html#design-effect-in-spatially-autocorrelated-data"><i class="fa fa-check"></i><b>9.3.2</b> Design effect in spatially autocorrelated data</a></li>
<li class="chapter" data-level="9.3.3" data-path="cluster.html"><a href="cluster.html#estimating-sampling-noise-with-spatially-autocorrelated-data"><i class="fa fa-check"></i><b>9.3.3</b> Estimating sampling noise with spatially autocorrelated data</a></li>
<li class="chapter" data-level="9.3.4" data-path="cluster.html"><a href="cluster.html#testing-for-spatial-autocorrelation"><i class="fa fa-check"></i><b>9.3.4</b> Testing for spatial autocorrelation</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="cluster.html"><a href="cluster.html#clustering-on-a-network"><i class="fa fa-check"></i><b>9.4</b> Clustering on a network</a></li>
<li class="chapter" data-level="9.5" data-path="cluster.html"><a href="cluster.html#multi-way-clustering"><i class="fa fa-check"></i><b>9.5</b> Multi-way clustering</a>
<ul>
<li class="chapter" data-level="9.5.1" data-path="cluster.html"><a href="cluster.html#at-which-level-should-we-cluster"><i class="fa fa-check"></i><b>9.5.1</b> At which level should we cluster?</a></li>
</ul></li>
<li class="chapter" data-level="9.6" data-path="cluster.html"><a href="cluster.html#what-to-do-when-there-are-few-clusters"><i class="fa fa-check"></i><b>9.6</b> What to do when there are few clusters?</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="cluster.html"><a href="cluster.html#aggregation"><i class="fa fa-check"></i><b>9.6.1</b> Aggregation</a></li>
<li class="chapter" data-level="9.6.2" data-path="cluster.html"><a href="cluster.html#permutation-tests"><i class="fa fa-check"></i><b>9.6.2</b> Permutation tests</a></li>
<li class="chapter" data-level="9.6.3" data-path="cluster.html"><a href="cluster.html#wild-bootstrap"><i class="fa fa-check"></i><b>9.6.3</b> Wild bootstrap</a></li>
<li class="chapter" data-level="9.6.4" data-path="cluster.html"><a href="cluster.html#ibragimov-and-muller-2010-group-based-inference"><i class="fa fa-check"></i><b>9.6.4</b> Ibragimov and Muller (2010) group-based inference</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="cluster.html"><a href="cluster.html#CLTDD"><i class="fa fa-check"></i><b>9.7</b> Central Limit Theorems for Dependent Data</a></li>
<li class="chapter" data-level="9.8" data-path="cluster.html"><a href="cluster.html#DesignBasedClusters"><i class="fa fa-check"></i><b>9.8</b> Sampling-based and design-based approaches to clustering</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="LaLonde.html"><a href="LaLonde.html"><i class="fa fa-check"></i><b>10</b> LaLonde Tests</a></li>
<li class="chapter" data-level="11" data-path="Diffusion.html"><a href="Diffusion.html"><i class="fa fa-check"></i><b>11</b> Diffusion effects</a>
<ul>
<li class="chapter" data-level="11.1" data-path="Diffusion.html"><a href="Diffusion.html#allowing-for-diffusion-effects-in-rubin-causal-model"><i class="fa fa-check"></i><b>11.1</b> Allowing for diffusion effects in Rubin Causal Model</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="Diffusion.html"><a href="Diffusion.html#potential-outcomes-and-treatment-effects-with-diffusion-effects"><i class="fa fa-check"></i><b>11.1.1</b> Potential outcomes and treatment effects with diffusion effects</a></li>
<li class="chapter" data-level="11.1.2" data-path="Diffusion.html"><a href="Diffusion.html#encoding-the-absence-of-diffusion-effects"><i class="fa fa-check"></i><b>11.1.2</b> Encoding the absence of diffusion effects</a></li>
<li class="chapter" data-level="11.1.3" data-path="Diffusion.html"><a href="Diffusion.html#TreatmentExposure"><i class="fa fa-check"></i><b>11.1.3</b> Treatment exposure</a></li>
<li class="chapter" data-level="11.1.4" data-path="Diffusion.html"><a href="Diffusion.html#fundamental-problem-of-causal-inference-for-diffusion-effects"><i class="fa fa-check"></i><b>11.1.4</b> Fundamental problem of causal inference for diffusion effects</a></li>
<li class="chapter" data-level="11.1.5" data-path="Diffusion.html"><a href="Diffusion.html#bias-of-one-step-randomized-controlled-trials"><i class="fa fa-check"></i><b>11.1.5</b> Bias of one-step randomized controlled trials</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="Diffusion.html"><a href="Diffusion.html#diffusion-effects-with-coarse-networks"><i class="fa fa-check"></i><b>11.2</b> Diffusion effects with coarse networks</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="Diffusion.html"><a href="Diffusion.html#optimal-treatment-allocation-under-monotone-response"><i class="fa fa-check"></i><b>11.2.1</b> Optimal treatment allocation under monotone response</a></li>
<li class="chapter" data-level="11.2.2" data-path="Diffusion.html"><a href="Diffusion.html#identifying-optimal-treatment-levels"><i class="fa fa-check"></i><b>11.2.2</b> Identifying optimal treatment levels</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="Diffusion.html"><a href="Diffusion.html#diffusion-effects-with-detailed-networks"><i class="fa fa-check"></i><b>11.3</b> Diffusion effects with detailed networks</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="Diffusion.html"><a href="Diffusion.html#setting"><i class="fa fa-check"></i><b>11.3.1</b> Setting</a></li>
<li class="chapter" data-level="11.3.2" data-path="Diffusion.html"><a href="Diffusion.html#identification-of-causal-effects"><i class="fa fa-check"></i><b>11.3.2</b> Identification of causal effects</a></li>
<li class="chapter" data-level="11.3.3" data-path="Diffusion.html"><a href="Diffusion.html#estimation-of-causal-effects"><i class="fa fa-check"></i><b>11.3.3</b> Estimation of causal effects</a></li>
<li class="chapter" data-level="11.3.4" data-path="Diffusion.html"><a href="Diffusion.html#estimation-of-sampling-noise-6"><i class="fa fa-check"></i><b>11.3.4</b> Estimation of sampling noise</a></li>
<li class="chapter" data-level="11.3.5" data-path="Diffusion.html"><a href="Diffusion.html#nonparametric-tests-for-the-existence-of-diffusion-effects-based-on-randomization-inference"><i class="fa fa-check"></i><b>11.3.5</b> Nonparametric tests for the existence of diffusion effects based on randomization inference</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="Diffusion.html"><a href="Diffusion.html#diffusion-effects-with-did"><i class="fa fa-check"></i><b>11.4</b> Diffusion effects with DID</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="Distribution.html"><a href="Distribution.html"><i class="fa fa-check"></i><b>12</b> Distributional effects</a></li>
<li class="chapter" data-level="13" data-path="meta.html"><a href="meta.html"><i class="fa fa-check"></i><b>13</b> Meta-analysis and Publication Bias</a>
<ul>
<li class="chapter" data-level="13.1" data-path="meta.html"><a href="meta.html#meta-analysis"><i class="fa fa-check"></i><b>13.1</b> Meta-analysis</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="meta.html"><a href="meta.html#basic-setting"><i class="fa fa-check"></i><b>13.1.1</b> Basic setting</a></li>
<li class="chapter" data-level="13.1.2" data-path="meta.html"><a href="meta.html#why-vote-counting-does-not-work"><i class="fa fa-check"></i><b>13.1.2</b> Why vote-counting does not work</a></li>
<li class="chapter" data-level="13.1.3" data-path="meta.html"><a href="meta.html#MetaWA"><i class="fa fa-check"></i><b>13.1.3</b> Meta-analysis when treatment effects are homogeneous: the fixed effects approach</a></li>
<li class="chapter" data-level="13.1.4" data-path="meta.html"><a href="meta.html#meta-analysis-when-treatment-effects-are-heterogeneous-the-random-effects-approach"><i class="fa fa-check"></i><b>13.1.4</b> Meta-analysis when treatment effects are heterogeneous: the random effects approach</a></li>
<li class="chapter" data-level="13.1.5" data-path="meta.html"><a href="meta.html#meta-regression"><i class="fa fa-check"></i><b>13.1.5</b> Meta-regression</a></li>
<li class="chapter" data-level="13.1.6" data-path="meta.html"><a href="meta.html#constantly-updated-meta-analysis"><i class="fa fa-check"></i><b>13.1.6</b> Constantly updated meta-analysis</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="meta.html"><a href="meta.html#publication-bias-and-site-selection-bias"><i class="fa fa-check"></i><b>13.2</b> Publication bias and site selection bias</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="meta.html"><a href="meta.html#sources-of-publication-bias-and-of-site-selection-bias-and-questionable-research-practices"><i class="fa fa-check"></i><b>13.2.1</b> Sources of publication bias and of site selection bias and Questionable Research Practices</a></li>
<li class="chapter" data-level="13.2.2" data-path="meta.html"><a href="meta.html#detection-of-and-correction-for-publication-bias"><i class="fa fa-check"></i><b>13.2.2</b> Detection of and correction for publication bias</a></li>
<li class="chapter" data-level="13.2.3" data-path="meta.html"><a href="meta.html#getting-rid-of-publication-bias-registered-reports-and-pre-analysis-plans"><i class="fa fa-check"></i><b>13.2.3</b> Getting rid of publication bias: registered reports and pre-analysis plans</a></li>
<li class="chapter" data-level="13.2.4" data-path="meta.html"><a href="meta.html#detection-of-and-correction-for-site-selection-bias"><i class="fa fa-check"></i><b>13.2.4</b> Detection of and correction for site selection bias</a></li>
<li class="chapter" data-level="13.2.5" data-path="meta.html"><a href="meta.html#vote-counting-and-publication-bias"><i class="fa fa-check"></i><b>13.2.5</b> Vote counting and publication bias</a></li>
<li class="chapter" data-level="13.2.6" data-path="meta.html"><a href="meta.html#the-value-of-a-statistically-significant-result"><i class="fa fa-check"></i><b>13.2.6</b> The value of a statistically significant result</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="Bounds.html"><a href="Bounds.html"><i class="fa fa-check"></i><b>14</b> Bounds</a></li>
<li class="chapter" data-level="15" data-path="mediation-analysis.html"><a href="mediation-analysis.html"><i class="fa fa-check"></i><b>15</b> Mediation Analysis</a>
<ul>
<li class="chapter" data-level="15.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-a-framework"><i class="fa fa-check"></i><b>15.1</b> Mediation analysis: a framework</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#defining-mediated-and-unmediated-treatment-effects"><i class="fa fa-check"></i><b>15.1.1</b> Defining mediated and unmediated treatment effects</a></li>
<li class="chapter" data-level="15.1.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#decomposing-mediated-and-unmediated-effects"><i class="fa fa-check"></i><b>15.1.2</b> Decomposing mediated and unmediated effects</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#the-fundamental-problem-of-mediation-analysis"><i class="fa fa-check"></i><b>15.2</b> The Fundamental Problem of Mediation Analysis</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#the-fundamental-problem-of-mediation-analysis-1"><i class="fa fa-check"></i><b>15.2.1</b> The Fundamental Problem of Mediation Analysis</a></li>
<li class="chapter" data-level="15.2.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#biases-of-intuitive-comparisons"><i class="fa fa-check"></i><b>15.2.2</b> Biases of Intuitive Comparisons</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-with-experimental-data"><i class="fa fa-check"></i><b>15.3</b> Mediation analysis with experimental data</a>
<ul>
<li class="chapter" data-level="15.3.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-in-the-parallel-design"><i class="fa fa-check"></i><b>15.3.1</b> Mediation analysis in the Parallel design</a></li>
<li class="chapter" data-level="15.3.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-in-the-sequential-self-selection-design"><i class="fa fa-check"></i><b>15.3.2</b> Mediation analysis in the Sequential Self-Selection design</a></li>
<li class="chapter" data-level="15.3.3" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-in-the-crossover-design"><i class="fa fa-check"></i><b>15.3.3</b> Mediation analysis in the Crossover design</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-under-unconfoundedness"><i class="fa fa-check"></i><b>15.4</b> Mediation analysis under unconfoundedness</a>
<ul>
<li class="chapter" data-level="15.4.1" data-path="mediation-analysis.html"><a href="mediation-analysis.html#non-parametric-identification-under-sequential-ignorability"><i class="fa fa-check"></i><b>15.4.1</b> Non-parametric identification under sequential ignorability</a></li>
<li class="chapter" data-level="15.4.2" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-under-sequential-ignorability-in-linear-models"><i class="fa fa-check"></i><b>15.4.2</b> Mediation analysis under sequential ignorability in linear models</a></li>
</ul></li>
<li class="chapter" data-level="15.5" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-with-panel-data"><i class="fa fa-check"></i><b>15.5</b> Mediation analysis with panel data</a></li>
<li class="chapter" data-level="15.6" data-path="mediation-analysis.html"><a href="mediation-analysis.html#mediation-analysis-with-instruments"><i class="fa fa-check"></i><b>15.6</b> Mediation analysis with instruments</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="stratification.html"><a href="stratification.html"><i class="fa fa-check"></i><b>16</b> Stratification</a>
<ul>
<li class="chapter" data-level="16.1" data-path="stratification.html"><a href="stratification.html#ClassicalStratification"><i class="fa fa-check"></i><b>16.1</b> Analysis of classical stratified experiments</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="stratification.html"><a href="stratification.html#an-example-3"><i class="fa fa-check"></i><b>16.1.1</b> An example</a></li>
<li class="chapter" data-level="16.1.2" data-path="stratification.html"><a href="stratification.html#estimating-treatment-effects-with-stratified-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.1.2</b> Estimating treatment effects with stratified randomized controlled trials</a></li>
<li class="chapter" data-level="16.1.3" data-path="stratification.html"><a href="stratification.html#estimating-sampling-noise-in-stratified-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.1.3</b> Estimating sampling noise in stratified randomized controlled trials</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="stratification.html"><a href="stratification.html#PairRCT"><i class="fa fa-check"></i><b>16.2</b> Analysis of pairwise randomized controlled trials</a>
<ul>
<li class="chapter" data-level="16.2.1" data-path="stratification.html"><a href="stratification.html#building-a-sample-of-pairs"><i class="fa fa-check"></i><b>16.2.1</b> Building a sample of pairs</a></li>
<li class="chapter" data-level="16.2.2" data-path="stratification.html"><a href="stratification.html#estimating-treatment-effects-in-pairwise-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.2.2</b> Estimating treatment effects in pairwise randomized controlled trials</a></li>
<li class="chapter" data-level="16.2.3" data-path="stratification.html"><a href="stratification.html#estimating-sampling-noise-in-pairwise-randomized-controlled-trials"><i class="fa fa-check"></i><b>16.2.3</b> Estimating sampling noise in pairwise randomized controlled trials</a></li>
</ul></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="proofs.html"><a href="proofs.html"><i class="fa fa-check"></i><b>A</b> Proofs</a>
<ul>
<li class="chapter" data-level="A.1" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-reffpsi"><i class="fa fa-check"></i><b>A.1</b> Proofs of results in Chapter @ref(FPSI)</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="proofs.html"><a href="proofs.html#proofcheb"><i class="fa fa-check"></i><b>A.1.1</b> Proof of Theorem @ref(thm:uppsampnoise)</a></li>
<li class="chapter" data-level="A.1.2" data-path="proofs.html"><a href="proofs.html#proofCLT"><i class="fa fa-check"></i><b>A.1.2</b> Proof of Theorem @ref(thm:asympnoiseWW)</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refrct"><i class="fa fa-check"></i><b>A.2</b> Proofs of results in Chapter @ref(RCT)</a>
<ul>
<li class="chapter" data-level="A.2.1" data-path="proofs.html"><a href="proofs.html#proofIdentLATE"><i class="fa fa-check"></i><b>A.2.1</b> Proof of Theorem @ref(thm:IdentLATE)</a></li>
<li class="chapter" data-level="A.2.2" data-path="proofs.html"><a href="proofs.html#proofWaldIV"><i class="fa fa-check"></i><b>A.2.2</b> Proof of Theorem @ref(thm:WaldIV)</a></li>
<li class="chapter" data-level="A.2.3" data-path="proofs.html"><a href="proofs.html#ProofAsymWald"><i class="fa fa-check"></i><b>A.2.3</b> Proof of Theorem @ref(thm:asymWald)</a></li>
</ul></li>
<li class="chapter" data-level="A.3" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refne"><i class="fa fa-check"></i><b>A.3</b> Proofs of results in Chapter @ref(NE)</a>
<ul>
<li class="chapter" data-level="A.3.1" data-path="proofs.html"><a href="proofs.html#proofEstimDID"><i class="fa fa-check"></i><b>A.3.1</b> Proof of Theorem @ref(thm:EstimDID)</a></li>
<li class="chapter" data-level="A.3.2" data-path="proofs.html"><a href="proofs.html#proofasympnoiseDIDCross"><i class="fa fa-check"></i><b>A.3.2</b> Proof of Theorem @ref(thm:asympnoiseDIDCross)</a></li>
<li class="chapter" data-level="A.3.3" data-path="proofs.html"><a href="proofs.html#proofEquivDIDSApop"><i class="fa fa-check"></i><b>A.3.3</b> Proof of Theorem @ref(thm:EquivDIDSApop)</a></li>
<li class="chapter" data-level="A.3.4" data-path="proofs.html"><a href="proofs.html#proofEquivDIDSAsamp"><i class="fa fa-check"></i><b>A.3.4</b> Proof of Theorem @ref(thm:EquivDIDSAsamp)</a></li>
<li class="chapter" data-level="A.3.5" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSACross"><i class="fa fa-check"></i><b>A.3.5</b> Proof of Theorem @ref(thm:asympnoiseSACross)</a></li>
<li class="chapter" data-level="A.3.6" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSATTCross"><i class="fa fa-check"></i><b>A.3.6</b> Proof of Theorem @ref(thm:asympnoiseSATTCross)</a></li>
<li class="chapter" data-level="A.3.7" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSAPanel"><i class="fa fa-check"></i><b>A.3.7</b> Proof of Theorem @ref(thm:asympnoiseSAPanel)</a></li>
<li class="chapter" data-level="A.3.8" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSATTPanel"><i class="fa fa-check"></i><b>A.3.8</b> Proof of Theorem @ref(thm:asympnoiseSATTPanel)</a></li>
</ul></li>
<li class="chapter" data-level="A.4" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refom"><i class="fa fa-check"></i><b>A.4</b> Proofs of results in Chapter @ref(OM)</a>
<ul>
<li class="chapter" data-level="A.4.1" data-path="proofs.html"><a href="proofs.html#proofAsympWWOLS10"><i class="fa fa-check"></i><b>A.4.1</b> Proof of Theorem @ref(thm:AsympWWOLS10)</a></li>
</ul></li>
<li class="chapter" data-level="A.5" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refcluster"><i class="fa fa-check"></i><b>A.5</b> Proofs of results in Chapter @ref(cluster)</a>
<ul>
<li class="chapter" data-level="A.5.1" data-path="proofs.html"><a href="proofs.html#proofVarWWClus"><i class="fa fa-check"></i><b>A.5.1</b> Proof of Theorem @ref(thm:VarWWClus)</a></li>
<li class="chapter" data-level="A.5.2" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSATTPanelAR1"><i class="fa fa-check"></i><b>A.5.2</b> Proof of Theorem @ref(thm:asympnoiseSATTPanelAR1)</a></li>
<li class="chapter" data-level="A.5.3" data-path="proofs.html"><a href="proofs.html#proofVarWWSpatial"><i class="fa fa-check"></i><b>A.5.3</b> Proof of Theorem @ref(thm:VarWWSpatial)</a></li>
</ul></li>
<li class="chapter" data-level="A.6" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refdiffusion"><i class="fa fa-check"></i><b>A.6</b> Proofs of results in Chapter @ref(Diffusion)</a>
<ul>
<li class="chapter" data-level="A.6.1" data-path="proofs.html"><a href="proofs.html#proofSmoothSymAlloc"><i class="fa fa-check"></i><b>A.6.1</b> Proof of Theorem @ref(thm:SmoothSymAlloc)</a></li>
<li class="chapter" data-level="A.6.2" data-path="proofs.html"><a href="proofs.html#proofIdentSmoothSymAlloc"><i class="fa fa-check"></i><b>A.6.2</b> Proof of Theorem @ref(thm:IdentSmoothSymAlloc)</a></li>
<li class="chapter" data-level="A.6.3" data-path="proofs.html"><a href="proofs.html#proofContagionDiffusionSmoothSymAlloc"><i class="fa fa-check"></i><b>A.6.3</b> Proof of Theorem @ref(thm:ContagionDiffusionSmoothSymAlloc)</a></li>
</ul></li>
<li class="chapter" data-level="A.7" data-path="proofs.html"><a href="proofs.html#proofs-of-results-in-chapter-refstratification"><i class="fa fa-check"></i><b>A.7</b> Proofs of results in Chapter @ref(stratification)</a>
<ul>
<li class="chapter" data-level="A.7.1" data-path="proofs.html"><a href="proofs.html#proofSFEdecomp"><i class="fa fa-check"></i><b>A.7.1</b> Proof of Theorem @ref(thm:SFEdecomp)</a></li>
<li class="chapter" data-level="A.7.2" data-path="proofs.html"><a href="proofs.html#proofSFEconsistent"><i class="fa fa-check"></i><b>A.7.2</b> Proof of Theorem @ref(thm:SFEconsistent)</a></li>
<li class="chapter" data-level="A.7.3" data-path="proofs.html"><a href="proofs.html#proofSATUnbiasedConsistent"><i class="fa fa-check"></i><b>A.7.3</b> Proof of Theorem @ref(thm:SATUnbiasedConsistent)</a></li>
<li class="chapter" data-level="A.7.4" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSATStrata"><i class="fa fa-check"></i><b>A.7.4</b> Proof of Theorem @ref(thm:asympnoiseSATStrata)</a></li>
<li class="chapter" data-level="A.7.5" data-path="proofs.html"><a href="proofs.html#proofasympnoiseSFEStrata"><i class="fa fa-check"></i><b>A.7.5</b> Proof of Theorem @ref(thm:asympnoiseSFEStrata)</a></li>
<li class="chapter" data-level="A.7.6" data-path="proofs.html"><a href="proofs.html#proofPairUnbiasedConsistent"><i class="fa fa-check"></i><b>A.7.6</b> Proof of Theorem @ref(thm:PairUnbiasedConsistent)</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Statistical Tools for Causal Inference</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="NE" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Chapter 4</span> Natural Experiments<a href="NE.html#NE" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Natural Experiments are situations due to the natural course of events that approximate the conditions of a randomized controlled trial.
In the economists’ toolkit, we generally make a distinction between:</p>
<ol style="list-style-type: decimal">
<li>Instrumental variables (IV), that rely on finding a plausibly exogeneous source of variation in treatment intake.</li>
<li>Regression Discontinuity Designs (RDD), that exploit a discontinuity in the eligibility to the treatment.</li>
<li>Difference In Differences (DID), that make use of the differential exposure of some groups to the treatment of interest over time.</li>
</ol>
<div class="remark">
<p><span id="unlabeled-div-72" class="remark"><em>Remark</em>. </span>The term <em>Natural Experiments</em> seems to be mostly used by economists.
It dates back to Haavelmo (1944)’s paper on the Probability Approach to Econometrics, where he makes a distinction between the experiments we’d like to make as social scientists and the experiments that Nature provides us with, that are in general a subset of the experiments we’d like to make.
This raises the question of our ability to <strong>identify</strong> the relationships of interest from the variation that is present in the data, a traditional problem in classical econometrics that has echoes in treatment effect estimation, where we also try to <em>identify</em> treatment effect parameters.
At the time of Haavelmo, and until the beginning of the 1990s, there was no real discussion of the plausibility of the <em>identifying assumptions</em> (or restrictions) required for identification of certain relations, outside of a discussion of their theoretical plausiblility.
With the credibility revolution brought about by Angrist (1990)’s paper and summarized in Angrist and Krueger (2001)’s review paper, the notion of natural experiment made a come back, with the idea that we might be able to look for specific set of events produced by Nature that more credibly identify a relationship of interest, <em>i.e.</em> that closely approximate true experimental conditions.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-73" class="remark"><em>Remark</em>. </span>Outside of economics, Natural Experiments have also flourished, but without the term, and were compiled in the early textbook on research methods by Campbell (1966).
Both Difference In Differences and Regression Discontinuity Designs have been actually developed outside of economics, mostly in education research.
Instrumental Variables have had a separate history in economics and in genetics, were it is called the method of path coefficients.</p>
</div>
<div id="instrumental-variables" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Instrumental Variables<a href="NE.html#instrumental-variables" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Instrumental Variables rely on finding a plausibly exogeneous source of variation in treatment intake.
In the simple case of a binary instrument, the identification and estimation parts are actually identical to Encouragements designs in RCTs, that we have already studied in Section <a href="RCT.html#sec:design4">3.4</a>.
As a consequence, unless we make very strong assumptions, an IV design is going to recover a Local Average Treatment Effect.
Our classical assumptions are going to show up again: Independence, Exclusion Restriction, Monotonicity.</p>
<div class="remark">
<p><span id="unlabeled-div-74" class="remark"><em>Remark</em>. </span>Examples of Instrumental Variables are:</p>
</div>
<ul>
<li>Distance to college or to school for studying the impact of college or school enrollement on education, earnings and other outcomes.</li>
<li>Random draft lottery number for investigating the impact of military experience on earnings and other outcomes.</li>
<li>Randomized encouragement to participate in order to study the impact of a program.</li>
</ul>
<div class="remark">
<p><span id="unlabeled-div-75" class="remark"><em>Remark</em>. </span>The crucial part of an IV design is to justify the credibility of the exclusion restriction and independence assumptions.
It is in general very difficult to justify these assumptions, especially the exclusion restriction assumption.
In the examples above, one could argue that schools or colleges might be built where they are necessary, i.e. close to destitute populations, or, on the contrary, that they are built far from difficult neighbourhoods.
As soon as distance to school becomes correlated with other determinants of schooling, such as parental income and education, the independence assumption is violated.</p>
<p>Even if school placement is truly independent of potential education and earnings outcomes at first, parents, by choosing where to live, will sort themselves such as the parents that pay more attention to education end up located closer to school.
As a consequence, the independence assumption might be violated again.</p>
<p>Even when the instrument is truly random, such as a draft lottery number, and thus the independence assumption seems fine, the instrument may directly affect the outcomes by other ways than the treatment of interest.
For example, receiving a low draft lottery number makes one more likely to be drafted.
In response, one might decide to increase their length of stay in college in order to use the waiver for the draft reserved for students.
If receiving a low draft lottery number increases the number of years of education, and in turn subsequent earnings, then the exclusion restriction assumption is violated.</p>
</div>
<p>In this section, I’m going to denote <span class="math inline">\(Z_i\)</span> a binary instrument that can either take value <span class="math inline">\(0\)</span> or <span class="math inline">\(1\)</span>.
In general, we try to reserve the value <span class="math inline">\(1\)</span> for the instrument value that increases participation in the treatment of interest.
In our examples, that would be when for example, the distance to college is low, the draft lottery number is low, or someone receives an encouragement to enter a program.</p>
<div id="an-example-where-monotonicity-does-not-hold" class="section level3 hasAnchor" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> An example where Monotonicity does not hold<a href="NE.html#an-example-where-monotonicity-does-not-hold" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Since Monotonicity is going to play such a particular role, and since we have already explored this assumption a little in Chapter <a href="RCT.html#RCT">3</a>, I am going to use as an example a model where the Monotonicity assumption actually does not hold.
It will, I hope, help us understand better the way Monotonicity works and how it interacts with the other assumptions.
The key component of the model that makes Monotonicity necessary is the fact that treatment effects are heterogeneous and correlated with participation in the treatment.
We’ll see later that Monotonicity is unnecessary when treatment effects are orthogonal to take up.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-139" class="example"><strong>Example 4.1  </strong></span>Let’s see how we can generate a model without Monotonicity:</p>
</div>
<p><span class="math display">\[\begin{align*}
y_i^1 &amp; = y_i^0+\bar{\alpha}+\theta\mu_i+\eta_i \\
y_i^0 &amp; = \mu_i+\delta+U_i^0 \\
U_i^0 &amp; = \rho U_i^B+\epsilon_i \\
y_i^B &amp; =\mu_i+U_i^B \\
U_i^B &amp; \sim\mathcal{N}(0,\sigma^2_{U}) \\
D_i   &amp; = \uns{y_i^B+\kappa_i Z_i + V_i\leq\bar{y}} \\
\kappa_i &amp; =
\begin{cases}
-\bar{\kappa} &amp; \text{ if } \xi_i = 1 \\
\underline{\kappa} &amp; \text{ if } \xi_i = 0
\end{cases} \\
\xi &amp; \sim\mathcal{B}(p_{\xi}) \\
V_i   &amp; = \gamma(\mu_i-\bar{\mu}) + \omega_i \\
(\eta_i,\omega_i) &amp; \sim\mathcal{N}(0,0,\sigma^2_{\eta},\sigma^2_{\omega},\rho_{\eta,\omega}) \\
Z_i   &amp; \sim\mathcal{B}(p_Z) \\
Z_i   &amp; \Ind (y_i^0,y_i^1,y_i^B,V_i) \\
\xi_i &amp; \Ind (y_i^0,y_i^1,y_i^B,V_i,Z_i)
\end{align*}\]</span></p>
<p>The key component of the model that generates a failure of Monotonicity is the coefficient <span class="math inline">\(\kappa_i\)</span>, that determines how individuals’ participation into the program reacts to the instrument <span class="math inline">\(Z_i\)</span>.
<span class="math inline">\(\kappa_i\)</span> is a coefficient whose value varies accross the population.
In my simplified model, <span class="math inline">\(\kappa_i\)</span> can take only two values, <span class="math inline">\(-\bar{\kappa}\)</span> or <span class="math inline">\(\underline{\kappa}\)</span>.
When <span class="math inline">\(-\bar{\kappa}\)</span> and <span class="math inline">\(\underline{\kappa}\)</span> have opposite signs (let’s say <span class="math inline">\(-\bar{\kappa}&lt;0\)</span> and <span class="math inline">\(\underline{\kappa}&gt;0\)</span>), then individuals with <span class="math inline">\(\kappa_i=-\bar{\kappa}\)</span> are going to be more likely to enter the program when they receive an encouragement (when <span class="math inline">\(Z_i=1\)</span>) while individuals with <span class="math inline">\(\kappa_i=\underline{\kappa}\)</span> will be less likely to enter the program when <span class="math inline">\(Z_i=1\)</span>.
When <span class="math inline">\(-\bar{\kappa}\)</span> and <span class="math inline">\(\underline{\kappa}\)</span> have different signs, we have four types of reactions when the instrumental variable moves from <span class="math inline">\(Z_i=0\)</span> to <span class="math inline">\(Z_i=1\)</span>, holding everything else constant.
These four types of reactions define four types of individuals:</p>
<ul>
<li><strong>Always takers</strong> (<span class="math inline">\(T_i=a\)</span>): individuals that participate in the program both when <span class="math inline">\(Z_i=0\)</span> and <span class="math inline">\(Z_i=1\)</span>.</li>
<li><strong>Never takers</strong> (<span class="math inline">\(T_i=n\)</span>): individuals that do not participate in the program both when <span class="math inline">\(Z_i=0\)</span> and <span class="math inline">\(Z_i=1\)</span>.</li>
<li><strong>Compliers</strong> (<span class="math inline">\(T_i=c\)</span>): individuals that do not participate in the program when <span class="math inline">\(Z_i=0\)</span> but that participate in the program when <span class="math inline">\(Z_i=1\)</span> .</li>
<li><strong>Defiers</strong> (<span class="math inline">\(T_i=d\)</span>): individuals that participate in the program when <span class="math inline">\(Z_i=0\)</span> but that do not participate in the program when <span class="math inline">\(Z_i=1\)</span> .</li>
</ul>
<p>In our model, these four types are a function of <span class="math inline">\(y_i^B+V_i\)</span> and <span class="math inline">\(\kappa_i\)</span>.
In order to see this let’s define, as in Section <a href="RCT.html#sec:design4">3.4</a>, <span class="math inline">\(D^z_i\)</span> the participation decision of individual <span class="math inline">\(i\)</span> when the instrument is exogenously set to <span class="math inline">\(Z_i=z\)</span>, with <span class="math inline">\(z\in\left\{0,1\right\}\)</span>.
When <span class="math inline">\(\kappa_i=-\bar{\kappa}&lt;0\)</span>, we have three types of reactions to the instrument.
It turns out that each of type can be defined by where <span class="math inline">\(y_i^B+V_i\)</span> lies with respect to a series of thresholds:</p>
<ul>
<li><strong>Always takers</strong> (<span class="math inline">\(T_i=a\)</span>) are such that <span class="math inline">\(D^1_i=\uns{y_i^B-\bar{\kappa} + V_i\leq\bar{y}}=1\)</span> and <span class="math inline">\(D^0_i=\uns{y_i^B + V_i\leq\bar{y}}=1\)</span>, so that they actually are such that: <span class="math inline">\(y_i^B+V_i\leq\bar{y}\)</span>.
This is because <span class="math inline">\(y_i^B+V_i\leq\bar{y} \Rightarrow y_i^B+V_i\leq\bar{y}+\bar{\kappa}\)</span>, when <span class="math inline">\(\bar{\kappa}&gt;0\)</span>.</li>
<li><strong>Never takers</strong> (<span class="math inline">\(T_i=n\)</span>) are such that <span class="math inline">\(D^1_i=\uns{y_i^B-\bar{\kappa} + V_i\leq\bar{y}}=0\)</span> and <span class="math inline">\(D^0_i=\uns{y_i^B + V_i\leq\bar{y}}=0\)</span>, so that they actually are such that: <span class="math inline">\(y_i^B+V_i&gt;\bar{y}+\bar{\kappa}\)</span>.
This is because <span class="math inline">\(y_i^B+V_i&gt;\bar{y}+\bar{\kappa} \Rightarrow y_i^B+V_i&gt;\bar{y}\)</span>, when <span class="math inline">\(\bar{\kappa}&gt;0\)</span>.</li>
<li><strong>Compliers</strong> (<span class="math inline">\(T_i=c\)</span>) are such that <span class="math inline">\(D^1_i=\uns{y_i^B-\bar{\kappa} + V_i\leq\bar{y}}=1\)</span> and <span class="math inline">\(D^0_i=\uns{y_i^B + V_i\leq\bar{y}}=0\)</span>, so that they actually are such that: <span class="math inline">\(\bar{y}&lt;y_i^B+V_i\leq\bar{y}+\bar{\kappa}\)</span>.</li>
</ul>
<p>When <span class="math inline">\(\kappa_i=\underline{\kappa}&gt;0\)</span>, we have three types defined by where <span class="math inline">\(V_i\)</span> lies with respect to a series of thresholds:</p>
<ul>
<li><strong>Always takers</strong> (<span class="math inline">\(T_i=a\)</span>) are such that <span class="math inline">\(D^1_i=\uns{y_i^B+\underline{\kappa} + V_i\leq\bar{y}}=1\)</span> and <span class="math inline">\(D^0_i=\uns{y_i^B + V_i\leq\bar{y}}=1\)</span>, so that they actually are such that: <span class="math inline">\(y_i^B+V_i\leq\bar{y}-\underline{\kappa}\)</span>.
This is because <span class="math inline">\(y_i^B+V_i\leq\bar{y}-\underline{\kappa} \Rightarrow y_i^B+V_i\leq\bar{y}\)</span>, when <span class="math inline">\(\underline{\kappa}&gt;0\)</span>.</li>
<li><strong>Never takers</strong> (<span class="math inline">\(T_i=n\)</span>) are such that <span class="math inline">\(D^1_i=\uns{y_i^B-\bar{\kappa} + V_i\leq\bar{y}}=0\)</span> and <span class="math inline">\(D^0_i=\uns{y_i^B + V_i\leq\bar{y}}=0\)</span>, so that they actually are such that: <span class="math inline">\(y_i^B+V_i&gt;\bar{y}\)</span>.
This is because <span class="math inline">\(y_i^B+V_i&gt;\bar{y} \Rightarrow y_i^B+V_i\leq\bar{y}-\underline{\kappa}\)</span>, when <span class="math inline">\(\underline{\kappa}&gt;0\)</span>.</li>
<li><strong>Defiers</strong> (<span class="math inline">\(T_i=d\)</span>) are such that <span class="math inline">\(D^1_i=\uns{y_i^B+\underline{\kappa} + V_i\leq\bar{y}}=0\)</span> and <span class="math inline">\(D^0_i=\uns{y_i^B + V_i\leq\bar{y}}=1\)</span>, so that they actually are such that: <span class="math inline">\(\bar{y}-\underline{\kappa}&lt;V_i+y_i^B\leq\bar{y}\)</span>.</li>
</ul>
<p>Let’s visualize how this works in a plot.
Before that, let’s generate some data according to this process.
For that, let’s choose values for the new parameters.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="NE.html#cb125-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">7.98</span>,<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="fl">0.5</span>,<span class="fl">0.9</span>,<span class="fl">0.28</span>,<span class="dv">0</span>)</span>
<span id="cb125-2"><a href="NE.html#cb125-2" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,<span class="st">&quot;theta&quot;</span>,<span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;baralpha&quot;</span>,<span class="st">&quot;gamma&quot;</span>,<span class="st">&quot;baryB&quot;</span>,<span class="st">&quot;pZ&quot;</span>,<span class="st">&quot;barkappa&quot;</span>,<span class="st">&quot;underbarkappa&quot;</span>,<span class="st">&quot;pxi&quot;</span>,<span class="st">&quot;sigma2omega&quot;</span>,<span class="st">&quot;rhoetaomega&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="NE.html#cb126-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb126-2"><a href="NE.html#cb126-2" tabindex="-1"></a>N <span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb126-3"><a href="NE.html#cb126-3" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb126-4"><a href="NE.html#cb126-4" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb126-5"><a href="NE.html#cb126-5" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;eta&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb126-6"><a href="NE.html#cb126-6" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb126-7"><a href="NE.html#cb126-7" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb126-8"><a href="NE.html#cb126-8" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb126-9"><a href="NE.html#cb126-9" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb126-10"><a href="NE.html#cb126-10" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb126-11"><a href="NE.html#cb126-11" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N,<span class="dv">1</span>,param[<span class="st">&quot;pZ&quot;</span>])</span>
<span id="cb126-12"><a href="NE.html#cb126-12" tabindex="-1"></a>xi <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N,<span class="dv">1</span>,param[<span class="st">&quot;pxi&quot;</span>]) </span>
<span id="cb126-13"><a href="NE.html#cb126-13" tabindex="-1"></a>kappa <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(xi<span class="sc">==</span><span class="dv">1</span>,<span class="sc">-</span>param[<span class="st">&quot;barkappa&quot;</span>],param[<span class="st">&quot;underbarkappa&quot;</span>])</span>
<span id="cb126-14"><a href="NE.html#cb126-14" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb126-15"><a href="NE.html#cb126-15" tabindex="-1"></a>Ds[yB<span class="sc">+</span>kappa<span class="sc">*</span>Z<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb126-16"><a href="NE.html#cb126-16" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb126-17"><a href="NE.html#cb126-17" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb126-18"><a href="NE.html#cb126-18" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb126-19"><a href="NE.html#cb126-19" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>eta</span>
<span id="cb126-20"><a href="NE.html#cb126-20" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb126-21"><a href="NE.html#cb126-21" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb126-22"><a href="NE.html#cb126-22" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb126-23"><a href="NE.html#cb126-23" tabindex="-1"></a>y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb126-24"><a href="NE.html#cb126-24" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span></code></pre></div>
<p>We can now define the types variable <span class="math inline">\(T_i\)</span>:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="NE.html#cb127-1" tabindex="-1"></a>D1 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(yB<span class="sc">+</span>kappa<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb127-2"><a href="NE.html#cb127-2" tabindex="-1"></a>D0 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(yB<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb127-3"><a href="NE.html#cb127-3" tabindex="-1"></a>AT <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> D0<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb127-4"><a href="NE.html#cb127-4" tabindex="-1"></a>NT <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> D0<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb127-5"><a href="NE.html#cb127-5" tabindex="-1"></a>C <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> D0<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb127-6"><a href="NE.html#cb127-6" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> D0<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb127-7"><a href="NE.html#cb127-7" tabindex="-1"></a>Type <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(AT<span class="sc">==</span><span class="dv">1</span>,<span class="st">&#39;a&#39;</span>,</span>
<span id="cb127-8"><a href="NE.html#cb127-8" tabindex="-1"></a>            <span class="fu">ifelse</span>(NT<span class="sc">==</span><span class="dv">1</span>,<span class="st">&#39;n&#39;</span>,</span>
<span id="cb127-9"><a href="NE.html#cb127-9" tabindex="-1"></a>                   <span class="fu">ifelse</span>(C<span class="sc">==</span><span class="dv">1</span>,<span class="st">&#39;c&#39;</span>,</span>
<span id="cb127-10"><a href="NE.html#cb127-10" tabindex="-1"></a>                          <span class="fu">ifelse</span>(D<span class="sc">==</span><span class="dv">1</span>,<span class="st">&#39;d&#39;</span>,<span class="st">&quot;&quot;</span>))))</span>
<span id="cb127-11"><a href="NE.html#cb127-11" tabindex="-1"></a></span>
<span id="cb127-12"><a href="NE.html#cb127-12" tabindex="-1"></a>data.non.mono <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(Type,C,NT,AT,D1,D0,Y,y,Y1,Y0,y0,y1,yB,alpha,U0,eta.omega<span class="sc">$</span>eta,epsilon,Ds,kappa,xi,Z,mu,UB))</span></code></pre></div>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="NE.html#cb128-1" tabindex="-1"></a><span class="co">#ggplot(data.non.mono, aes(x=V, y=yB),color(as.factor(Type))) +</span></span>
<span id="cb128-2"><a href="NE.html#cb128-2" tabindex="-1"></a><span class="co">#    geom_point(shape=1)+</span></span>
<span id="cb128-3"><a href="NE.html#cb128-3" tabindex="-1"></a><span class="co">#    facet_grid(.~ as.factor(kappa))</span></span>
<span id="cb128-4"><a href="NE.html#cb128-4" tabindex="-1"></a></span>
<span id="cb128-5"><a href="NE.html#cb128-5" tabindex="-1"></a><span class="fu">plot</span>(yB[AT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]]<span class="sc">+</span>V[AT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]],y[AT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&#39;yB+V&#39;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb128-6"><a href="NE.html#cb128-6" tabindex="-1"></a><span class="fu">points</span>(yB[NT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]]<span class="sc">+</span>V[NT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]],y[NT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb128-7"><a href="NE.html#cb128-7" tabindex="-1"></a><span class="fu">points</span>(yB[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]]<span class="sc">+</span>V[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]],y[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb128-8"><a href="NE.html#cb128-8" tabindex="-1"></a><span class="fu">points</span>(yB[D<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]]<span class="sc">+</span>V[D<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]],y[D<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==-</span>param[<span class="st">&quot;barkappa&quot;</span>]],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;green&#39;</span>)</span>
<span id="cb128-9"><a href="NE.html#cb128-9" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb128-10"><a href="NE.html#cb128-10" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>],<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb128-11"><a href="NE.html#cb128-11" tabindex="-1"></a><span class="co">#abline(v=log(param[&quot;barY&quot;])-param[&#39;underbarkappa&#39;],col=&#39;red&#39;)</span></span>
<span id="cb128-12"><a href="NE.html#cb128-12" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>]),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">5</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>)),<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>)<span class="sc">+</span><span class="fu">bar</span>(kappa))),<span class="at">pos=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;red&#39;</span>,<span class="st">&#39;red&#39;</span>),<span class="at">lty=</span><span class="fu">c</span>(<span class="st">&#39;solid&#39;</span>,<span class="st">&#39;solid&#39;</span>))</span>
<span id="cb128-13"><a href="NE.html#cb128-13" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="fl">10.5</span>,<span class="fu">c</span>(<span class="st">&#39;AT&#39;</span>,<span class="st">&#39;NT&#39;</span>,<span class="st">&#39;C&#39;</span>,<span class="st">&#39;D&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;blue&#39;</span>,<span class="st">&#39;red&#39;</span>,<span class="st">&#39;green&#39;</span>),<span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb128-14"><a href="NE.html#cb128-14" tabindex="-1"></a><span class="fu">title</span>(<span class="fu">expression</span>(<span class="at">kappa=</span><span class="fu">bar</span>(kappa)))</span>
<span id="cb128-15"><a href="NE.html#cb128-15" tabindex="-1"></a></span>
<span id="cb128-16"><a href="NE.html#cb128-16" tabindex="-1"></a><span class="fu">plot</span>(yB[AT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]]<span class="sc">+</span>V[AT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]],y[AT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&#39;yB+V&#39;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb128-17"><a href="NE.html#cb128-17" tabindex="-1"></a><span class="fu">points</span>(yB[NT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]]<span class="sc">+</span>V[NT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]],y[NT<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb128-18"><a href="NE.html#cb128-18" tabindex="-1"></a><span class="fu">points</span>(yB[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]]<span class="sc">+</span>V[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]],y[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb128-19"><a href="NE.html#cb128-19" tabindex="-1"></a><span class="fu">points</span>(yB[D<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]]<span class="sc">+</span>V[D<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]],y[D<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> kappa<span class="sc">==</span>param[<span class="st">&quot;underbarkappa&quot;</span>]],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;green&#39;</span>)</span>
<span id="cb128-20"><a href="NE.html#cb128-20" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb128-21"><a href="NE.html#cb128-21" tabindex="-1"></a><span class="co">#abline(v=log(param[&quot;barY&quot;])-param[&#39;barkappa&#39;],col=&#39;red&#39;)</span></span>
<span id="cb128-22"><a href="NE.html#cb128-22" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>param[<span class="st">&#39;underbarkappa&#39;</span>],<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb128-23"><a href="NE.html#cb128-23" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>param[<span class="st">&#39;underbarkappa&#39;</span>]),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">5</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>)),<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>)<span class="sc">-</span><span class="fu">underbar</span>(kappa))),<span class="at">pos=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;red&#39;</span>,<span class="st">&#39;red&#39;</span>),<span class="at">lty=</span><span class="fu">c</span>(<span class="st">&#39;solid&#39;</span>,<span class="st">&#39;solid&#39;</span>))</span>
<span id="cb128-24"><a href="NE.html#cb128-24" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="fl">10.5</span>,<span class="fu">c</span>(<span class="st">&#39;AT&#39;</span>,<span class="st">&#39;NT&#39;</span>,<span class="st">&#39;C&#39;</span>,<span class="st">&#39;D&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;blue&#39;</span>,<span class="st">&#39;red&#39;</span>,<span class="st">&#39;green&#39;</span>),<span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb128-25"><a href="NE.html#cb128-25" tabindex="-1"></a><span class="fu">title</span>(<span class="fu">expression</span>(<span class="at">kappa=</span><span class="fu">underbar</span>(kappa)))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plottypes"></span>
<img src="STCI_files/figure-html/plottypes-1.png" alt="Types" width="50%" /><img src="STCI_files/figure-html/plottypes-2.png" alt="Types" width="50%" />
<p class="caption">
Figure 4.1: Types
</p>
</div>
<p>As Figure <a href="NE.html#fig:plottypes">4.1</a> shows how the different types interact with <span class="math inline">\(\kappa_i\)</span>.
When <span class="math inline">\(\kappa_i=-\bar{\kappa}\)</span>, individuals with <span class="math inline">\(y_i^B+V_i\)</span> below <span class="math inline">\(\bar{y}\)</span> always take the program.
Even when <span class="math inline">\(Z_i=1\)</span> and <span class="math inline">\(\bar{\kappa}\)</span> is subtracted from their index, it is still low enough so that they get to participate.
When <span class="math inline">\(y_i^B+V_i\)</span> is in between <span class="math inline">\(\bar{y}\)</span> and <span class="math inline">\(\bar{y}+\bar{\kappa}\)</span>, the individuals are such that their index without subtracting <span class="math inline">\(\bar{\kappa}\)</span> is above <span class="math inline">\(\bar{y}\)</span>, but it is below <span class="math inline">\(\bar{y}\)</span> when <span class="math inline">\(\bar{\kappa}\)</span> is subtracted from it.
These individuals participate when <span class="math inline">\(Z_i=1\)</span> and do not participate when <span class="math inline">\(Z_i=0\)</span>: they are compliers.
Individuals such that <span class="math inline">\(y_i^B+V_i\)</span> is above <span class="math inline">\(\bar{y}+\bar{\kappa}\)</span> will have an index above <span class="math inline">\(\bar{y}\)</span> whether we substract <span class="math inline">\(\bar{\kappa}\)</span> from it or not.
They are never takers.</p>
<p>When <span class="math inline">\(\kappa_i=\underline{\kappa}\)</span>, individuals with <span class="math inline">\(y_i^B+V_i\)</span> below <span class="math inline">\(\bar{y}-\underline{\kappa}\)</span> always take the program.
Even when <span class="math inline">\(Z_i=0\)</span> and <span class="math inline">\(\underline{\kappa}\)</span> is not subtracted from their index, it is still low enough so that they get to participate.
When <span class="math inline">\(y_i^B+V_i\)</span> is in between <span class="math inline">\(\bar{y}-\underline{\kappa}\)</span> and <span class="math inline">\(\bar{y}\)</span>, the individuals are such that their index without adding <span class="math inline">\(\underline{\kappa}\)</span> is below <span class="math inline">\(\bar{y}\)</span>, but it is above <span class="math inline">\(\bar{y}\)</span> when <span class="math inline">\(\underline{\kappa}\)</span> is added to it.
These individuals participate when <span class="math inline">\(Z_i=0\)</span> and do not participate when <span class="math inline">\(Z_i=1\)</span>: they are defiers.
Individuals such that <span class="math inline">\(y_i^B+V_i\)</span> is above <span class="math inline">\(\bar{y}\)</span> will have an index above <span class="math inline">\(\bar{y}\)</span> whether we add <span class="math inline">\(\underline{\kappa}\)</span> from it or not.
They are never takers.</p>
</div>
<div id="identification-4" class="section level3 hasAnchor" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> Identification<a href="NE.html#identification-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We need several assumptions for identification in an Instrumental Variable framework.
We are going to explore two sets of assumption that secure the identification of two different parameters:</p>
<ul>
<li>The Average Treatment Effect on the Treated (<span class="math inline">\(TT\)</span>): identification will happen through the assumption of independence of treatment effects from potential treatment choice</li>
<li>The Local Average Treatment Effect (<span class="math inline">\(LATE\)</span>)</li>
</ul>
<div class="hypothesis">
<p><span id="hyp:FirstStage" class="hypothesis"><strong>Hypothesis 4.1  (First Stage Full Rank) </strong></span>We assume that the instrument <span class="math inline">\(Z_i\)</span> has a direct effect on treatment participation:</p>
<p><span class="math display">\[\begin{align*}
\Pr(D_i=1|Z_i=1)\neq\Pr(D_i=1|Z_i=0).
\end{align*}\]</span></p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-140" class="example"><strong>Example 4.2  </strong></span>Let’s see how this assumption works in our example.
Let’s first compute the average values of <span class="math inline">\(Y_i\)</span> and <span class="math inline">\(D_i\)</span> as a function of <span class="math inline">\(Z_i\)</span>, for later use.</p>
</div>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="NE.html#cb129-1" tabindex="-1"></a>means.IV <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y0[Z<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y0[Z<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">1</span>]),<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb129-2"><a href="NE.html#cb129-2" tabindex="-1"></a>means.IV <span class="ot">&lt;-</span> <span class="fu">matrix</span>(means.IV,<span class="at">nrow=</span><span class="dv">2</span>,<span class="at">ncol=</span><span class="dv">4</span>,<span class="at">byrow=</span><span class="cn">FALSE</span>,<span class="at">dimnames=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;Z=0&#39;</span>,<span class="st">&#39;Z=1&#39;</span>),<span class="fu">c</span>(<span class="st">&#39;D&#39;</span>,<span class="st">&#39;y0&#39;</span>,<span class="st">&#39;y&#39;</span>,<span class="st">&#39;Z&#39;</span>)))</span>
<span id="cb129-3"><a href="NE.html#cb129-3" tabindex="-1"></a>means.IV <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(means.IV)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:IVFirstStage"></span>
<img src="STCI_files/figure-html/IVFirstStage-1.png" alt="Proportion of participants as a function of $Z_i$" width="65%" />
<p class="caption">
Figure 4.2: Proportion of participants as a function of <span class="math inline">\(Z_i\)</span>
</p>
</div>
<p>Figure <a href="NE.html#fig:IVFirstStage">4.2</a> shows that the proportion of treated when <span class="math inline">\(Z_i=1\)</span> in our sample is equal to 0.53 while the proportion of treated when <span class="math inline">\(Z_i=0\)</span> is equal to 0.28, in accordance with Assumption <a href="NE.html#hyp:FirstStage">4.1</a>.
In the population, the proportion of treated when <span class="math inline">\(Z_i=1\)</span> depends on the value of <span class="math inline">\(\kappa_i\)</span>.
Let’s derive its value:</p>
<p><span class="math display">\[\begin{align*}
  \Pr(D_i=1|Z_i=1) &amp; = \Pr(y_i^B+\kappa_i Z_i + V_i\leq\bar{y}|Z_i=1) \\
                  &amp; =  \Pr(y_i^B+\kappa_i + V_i\leq\bar{y}) \\
                  &amp; =  \Pr(y_i^B+ V_i\leq\bar{y}+\bar{\kappa}|\xi_i=1)\Pr(\xi_i=1) + \Pr(y_i^B+V_i\leq\bar{y}-\underline{\kappa}|\xi_i=0)\Pr(\xi_i=0) \\
                                    &amp; =  \Pr(y_i^B+ V_i\leq\bar{y}+\bar{\kappa})p_{\xi} + \Pr(y_i^B+ V_i\leq\bar{y}-\underline{\kappa})(1-p_{\xi}) \\
                  &amp; =  p_{\xi}\Phi\left(\frac{\bar{y}+\bar{\kappa}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_{U}+\sigma^2_{\omega}}}\right) + (1-p_{\xi})\Phi\left(\frac{\bar{y}-\underline{\kappa}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_{U}+\sigma^2_{\omega}}}\right)
\end{align*}\]</span></p>
<p>where the second equality follows from <span class="math inline">\(Z_i\)</span> being independent of <span class="math inline">\((y_i^0,y_i^1,y_i^B,V_i)\)</span>, the third equality follows from <span class="math inline">\(\xi_i\)</span> being independent from <span class="math inline">\((y_i^0,y_i^1,y_i^B,V_i,Z_i)\)</span> and the last equality follows from the formula for the cumulative of a normal distribution.
The formula for <span class="math inline">\(\Pr(D_i=1|Z_i=0)\)</span> is the same except for <span class="math inline">\(\bar{\kappa}\)</span> and <span class="math inline">\(\underline{\kappa}\)</span> that are set to zero.</p>
<p>Let’s write two functions to compute these probabilities:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="NE.html#cb130-1" tabindex="-1"></a>prob.D.Z<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(param){</span>
<span id="cb130-2"><a href="NE.html#cb130-2" tabindex="-1"></a>  part<span class="fl">.1</span> <span class="ot">&lt;-</span> param[<span class="st">&#39;pxi&#39;</span>]<span class="sc">*</span><span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>]<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span><span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>]))</span>
<span id="cb130-3"><a href="NE.html#cb130-3" tabindex="-1"></a>  part<span class="fl">.2</span> <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>param[<span class="st">&#39;pxi&#39;</span>])<span class="sc">*</span><span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>param[<span class="st">&#39;underbarkappa&#39;</span>]<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span><span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>]))</span>
<span id="cb130-4"><a href="NE.html#cb130-4" tabindex="-1"></a>  <span class="fu">return</span>(part<span class="fl">.1</span><span class="sc">+</span>part<span class="fl">.2</span>)</span>
<span id="cb130-5"><a href="NE.html#cb130-5" tabindex="-1"></a>}</span>
<span id="cb130-6"><a href="NE.html#cb130-6" tabindex="-1"></a>prob.D.Z<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(param){</span>
<span id="cb130-7"><a href="NE.html#cb130-7" tabindex="-1"></a>  part<span class="fl">.1</span> <span class="ot">&lt;-</span> param[<span class="st">&#39;pxi&#39;</span>]<span class="sc">*</span><span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span><span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>]))</span>
<span id="cb130-8"><a href="NE.html#cb130-8" tabindex="-1"></a>  part<span class="fl">.2</span> <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>param[<span class="st">&#39;pxi&#39;</span>])<span class="sc">*</span><span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span><span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>]))</span>
<span id="cb130-9"><a href="NE.html#cb130-9" tabindex="-1"></a>  <span class="fu">return</span>(part<span class="fl">.1</span><span class="sc">+</span>part<span class="fl">.2</span>)</span>
<span id="cb130-10"><a href="NE.html#cb130-10" tabindex="-1"></a>}</span></code></pre></div>
<p>With these functions, we know that, in the population, <span class="math inline">\(\Pr(D_i=1|Z_i=1)=\)</span> 0.57 and <span class="math inline">\(\Pr(D_i=1|Z_i=0)=\)</span> 0.25, which is not far from what we have found in our sample.</p>
<p>Our next set of assumptions imposes that the instrument has no direct effect on the outcome and that it is not correlated with all the potential outcomes.
Let’s start with the exclusion restriction:</p>
<div class="hypothesis">
<p><span id="hyp:ExclusionRestriction" class="hypothesis"><strong>Hypothesis 4.2  (Exclusion Restriction) </strong></span>We assume that there is no direct effect of <span class="math inline">\(Z_i\)</span> on outcomes:</p>
<p><span class="math display">\[\begin{align*}
\forall d,z \in \left\{0,1\right\}\text{, } Y_i^{d,z} = Y_i^d.
\end{align*}\]</span></p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-141" class="example"><strong>Example 4.3  </strong></span>In our example, this assumption is automatically satisfied.</p>
</div>
<p>Indeed, <span class="math inline">\(y_i^{d,z}=y_i^0 + d(y_i^1-y_i^0)\)</span> which is parameterized as <span class="math inline">\(y_i^{d,z}=\mu_i+\delta+U_i^0+d(\bar{\alpha}+\theta\mu_i+\eta_i)\)</span>.
Since <span class="math inline">\(y_i^{d,z}\)</span> does not depend on <span class="math inline">\(z\)</span>, we have <span class="math inline">\(y_i^{d,z} = y_i^d\)</span>, <span class="math inline">\(\forall d,z \in \left\{0,1\right\}\)</span>.
The assumption would not be satisfied if <span class="math inline">\(Z_i\)</span> entered the equations for <span class="math inline">\(y_i^0\)</span> or <span class="math inline">\(y_i^1\)</span>.
For example, if <span class="math inline">\(Z_i\)</span> is the Vietnam draft lottery number (high or low) used by Angrist to study the impact of army experience on earnings, the exclusion restriction would not work if <span class="math inline">\(Z_i\)</span> was directly influencing outcomes, independent of miitary experience, by example by generating a higher education level.
In that case, we could have <span class="math inline">\(E_i=\alpha+\beta Z_i + v_i\)</span>, where <span class="math inline">\(E_i\)</span> is education, and, for example, <span class="math inline">\(y_i^0=\mu_i+\delta+\lambda E_i+U_i^0\)</span>.
We then have <span class="math inline">\(y_i^{d,z}=\mu_i+\delta +\lambda(\alpha+\beta z + v_i) +U_i^0+d(\bar{\alpha}+\theta\mu_i+\eta_i)\)</span> which depends on <span class="math inline">\(z\)</span> and thus the exclusion restriction does not hold any more.</p>
<p>Let us now state the independence assumption:</p>
<div class="hypothesis">
<p><span id="hyp:Independence" class="hypothesis"><strong>Hypothesis 4.3  (Independence) </strong></span>We assume that <span class="math inline">\(Z_i\)</span> is independent from the other determinants of <span class="math inline">\(Y_i\)</span> and <span class="math inline">\(D_i\)</span>:</p>
<p><span class="math display">\[\begin{align*}
(Y_i^1,Y_i^0,D_i^1,D_i^0)\Ind Z_i.
\end{align*}\]</span></p>
</div>
<div class="remark">
<p><span id="unlabeled-div-76" class="remark"><em>Remark</em>. </span>Why do we say that independence from the potential outcomes is the same as independence from the other determinants of <span class="math inline">\(Y_i\)</span> and <span class="math inline">\(D_i\)</span>?
Because the only sources of variation that remain in <span class="math inline">\(Y_i^d\)</span> and <span class="math inline">\(D_i^z\)</span> are the other sources of variations (that is not the treatment <span class="math inline">\(D_i=d\)</span> nor the instrument variable <span class="math inline">\(Z_i=z\)</span>).</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-143" class="example"><strong>Example 4.4  </strong></span>In our example, this assumption is also satisfied.</p>
</div>
<p>If we assumed that unobserved determinants of earnings contained in <span class="math inline">\(U^0_i\)</span> are correlated with the instrument value, then we would have a problem.
For example, if children that leave close to college have also rich parents, or parents that spend a lot of time with them, or parents with large networks, there probably is a correlation between distance to college and earnings in the absence of the program.
For the draft lottery example, you might have that people with a high draft lottery number who have well-connected parents obtain discharges on special medical grounds.
Is that a violation of the independence assumption?
Actually no.
Indeed, these individuals are simply going to become never takers (they avoid the draft whatever their lottery number).
But <span class="math inline">\(Z_i\)</span> is still independent from the level of connections of the parents.
For the independence assumption to fail in the draft lottery number example, you would need that children of well-connected parents obtain lower lottery numbers because the lottery is rigged.
In that case, since well-connected individuals would have had higher earnings even absent the lottery, there is a negative correlation between <span class="math inline">\(y_i^0\)</span> and having a high draft lottery number (<span class="math inline">\(Z_i\)</span>).</p>
<p>The last assumption we need in order to identify the Local Average Treatment Effect is that of Monotonicity.
We already know this assumption:</p>
<div class="hypothesis">
<p><span id="hyp:MonotonicityIV" class="hypothesis"><strong>Hypothesis 4.4  (Monotonicity) </strong></span>We assume that the instrument moves everyone in the population in the same direction:</p>
<p><span class="math display">\[\begin{align*}
\forall i\text{, either } D^1_i\geq D_i^0 \text{ or } D^1_i\leq D_i^0.
\end{align*}\]</span></p>
</div>
<p>Without loss of generality, we generally assume that <span class="math inline">\(\forall i\)</span>, <span class="math inline">\(D^1_i\geq D_i^0\)</span>.
As a consequence, there are no defiers.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-144" class="example"><strong>Example 4.5  </strong></span>In our example, this assumption is not satisfied.</p>
</div>
<p>There are defiers, as Figure <a href="NE.html#fig:plottypes">4.1</a> shows, when <span class="math inline">\(\xi_i = 0\)</span> and thus <span class="math inline">\(\kappa_i=\underline{\kappa}\)</span>.
Indeed, in that case, for the individuals who are such that <span class="math inline">\(\bar{y}-\underline{\kappa}&lt;y_i^B+V_i\leq\bar{y}\)</span>, we have <span class="math inline">\(D^1_i=\uns{y_i^B+\underline{\kappa} + V_i\leq\bar{y}}=0\)</span> and <span class="math inline">\(D^0_i=\uns{y_i^B + V_i\leq\bar{y}}=1\)</span>.
This would happen for example if some people would go to college less if their house is located closer to the college, maybe for example because they have a preference not to stay at their parents’ house.</p>
<div class="remark">
<p><span id="unlabeled-div-77" class="remark"><em>Remark</em>. </span>Why are defiers a problem for the instrumental variable strategy?
Because the Intention to Treat Effect that measures the difference in expected outcomes at the two levels of the instrument is going to be characterized by two-way flows in and out of the program, as we have already seen with Theorem <a href="RCT.html#thm:ITELATE">3.10</a>.
This means that some treatment effects will have negative weights in the ITE formula.
In that case, you might have a negative Intention to Treat Effect despite the treatment having positive effects for everyone, or you might under estimate the true effect of the treatment.
This matters only when the treatment effects are heterogeneous.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-146" class="example"><strong>Example 4.6  </strong></span>Let us detail how non-monotonicity and the existence defiers act on the ITE in our example, since we now have defiers.
The first very important thing to understand is that all the problems we have happend because treatment effects are heterogeneous <strong>AND</strong> they are correlated with the type of individuals: defiers and compliers do not have the same distribution of treatment effects and, case in point, they do not have the same average treatment effects.
The average effects of the treatment on compliers and defiers are not the same.
Let us first look at the distribution of treatment effects among compliers and defiers in the sample and in the population.</p>
</div>
<p>In order to derive the distribution of <span class="math inline">\(\alpha_i\)</span> conditional on Type in the population, we need to derive the joint distribution of <span class="math inline">\(\alpha_i\)</span> and <span class="math inline">\(y_i^B+V_i\)</span> and use the <strong>trmtvnorm</strong> package to recover its density when it is truncated.
This distribution is normal and fully characterized by its mean and covariance matrix.</p>
<p><span class="math display">\[\begin{align*}
  (\alpha_i,y_i^B+V_i) &amp; \sim \mathcal{N}\left(\bar{\alpha}+\theta\bar{\mu},\bar{\mu},
                                        \left(\begin{array}{cc}
                                              \theta^2\sigma^2_{\mu}+\sigma^2_{\eta} &amp; (\theta+\gamma)\sigma^2_{\mu}+\rho_{\eta,\omega}\sigma^2_{\eta}\sigma^2_{\omega}\\
                                              (\theta+\gamma)\sigma^2_{\mu}+\rho_{\eta,\omega}\sigma^2_{\eta}\sigma^2_{\omega} &amp;  (1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}\\
                                              \end{array}
                                        \right)
                                      \right)
\end{align*}\]</span></p>
<p>Let us write a function to generate them.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="NE.html#cb131-1" tabindex="-1"></a>mean.alpha.yBV <span class="ot">&lt;-</span> <span class="fu">c</span>(param[<span class="st">&#39;baralpha&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;theta&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;barmu&#39;</span>],param[<span class="st">&#39;barmu&#39;</span>])</span>
<span id="cb131-2"><a href="NE.html#cb131-2" tabindex="-1"></a>cov.alpha.yBV <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>((param[<span class="st">&#39;theta&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2eta&#39;</span>],</span>
<span id="cb131-3"><a href="NE.html#cb131-3" tabindex="-1"></a>                          (param[<span class="st">&#39;theta&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rhoetaomega&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2eta&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2omega&#39;</span>],</span>
<span id="cb131-4"><a href="NE.html#cb131-4" tabindex="-1"></a>                            (param[<span class="st">&#39;theta&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rhoetaomega&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2eta&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2omega&#39;</span>],</span>
<span id="cb131-5"><a href="NE.html#cb131-5" tabindex="-1"></a>                            (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>]),<span class="dv">2</span>,<span class="dv">2</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb131-6"><a href="NE.html#cb131-6" tabindex="-1"></a><span class="co"># density of alpha for compliers</span></span>
<span id="cb131-7"><a href="NE.html#cb131-7" tabindex="-1"></a>lower.cut.comp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))</span>
<span id="cb131-8"><a href="NE.html#cb131-8" tabindex="-1"></a>upper.cut.comp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>])</span>
<span id="cb131-9"><a href="NE.html#cb131-9" tabindex="-1"></a>d.alpha.compliers <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb131-10"><a href="NE.html#cb131-10" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">dtmvnorm.marginal</span>(<span class="at">xn=</span>x,<span class="at">n=</span><span class="dv">1</span>,<span class="at">mean=</span>mean.alpha.yBV,<span class="at">sigma=</span>cov.alpha.yBV,<span class="at">lower=</span>lower.cut.comp,<span class="at">upper=</span>upper.cut.comp))</span>
<span id="cb131-11"><a href="NE.html#cb131-11" tabindex="-1"></a>}</span>
<span id="cb131-12"><a href="NE.html#cb131-12" tabindex="-1"></a><span class="co"># density of alpha for defiers</span></span>
<span id="cb131-13"><a href="NE.html#cb131-13" tabindex="-1"></a>lower.cut.def <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]<span class="sc">-</span>param[<span class="st">&#39;underbarkappa&#39;</span>]))</span>
<span id="cb131-14"><a href="NE.html#cb131-14" tabindex="-1"></a>upper.cut.def <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))</span>
<span id="cb131-15"><a href="NE.html#cb131-15" tabindex="-1"></a>d.alpha.defiers <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb131-16"><a href="NE.html#cb131-16" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">dtmvnorm.marginal</span>(<span class="at">xn=</span>x,<span class="at">n=</span><span class="dv">1</span>,<span class="at">mean=</span>mean.alpha.yBV,<span class="at">sigma=</span>cov.alpha.yBV,<span class="at">lower=</span>lower.cut.def,<span class="at">upper=</span>upper.cut.def))</span>
<span id="cb131-17"><a href="NE.html#cb131-17" tabindex="-1"></a>}</span></code></pre></div>
<p>Let us now plot the empirical and theoretical distributions of the treatment effects for compliers and defiers.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="NE.html#cb132-1" tabindex="-1"></a><span class="co"># building the data frame</span></span>
<span id="cb132-2"><a href="NE.html#cb132-2" tabindex="-1"></a>alpha.types <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(alpha,C,D,AT,NT)) <span class="sc">%&gt;%</span></span>
<span id="cb132-3"><a href="NE.html#cb132-3" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb132-4"><a href="NE.html#cb132-4" tabindex="-1"></a>                  <span class="at">Type =</span> <span class="fu">ifelse</span>(AT<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Always Takers&quot;</span>,</span>
<span id="cb132-5"><a href="NE.html#cb132-5" tabindex="-1"></a>                                <span class="fu">ifelse</span>(NT<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Never Takers&quot;</span>,</span>
<span id="cb132-6"><a href="NE.html#cb132-6" tabindex="-1"></a>                                       <span class="fu">ifelse</span>(C<span class="sc">==</span><span class="dv">1</span>,<span class="st">&quot;Compliers&quot;</span>,<span class="st">&quot;Defiers&quot;</span>)))</span>
<span id="cb132-7"><a href="NE.html#cb132-7" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb132-8"><a href="NE.html#cb132-8" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">Type =</span> <span class="fu">as.factor</span>(Type))</span>
<span id="cb132-9"><a href="NE.html#cb132-9" tabindex="-1"></a></span>
<span id="cb132-10"><a href="NE.html#cb132-10" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">filter</span>(alpha.types,Type<span class="sc">==</span><span class="st">&quot;Compliers&quot;</span> <span class="sc">|</span> Type<span class="sc">==</span><span class="st">&quot;Defiers&quot;</span>), <span class="fu">aes</span>(<span class="at">x=</span>alpha, <span class="at">colour=</span>Type)) <span class="sc">+</span> </span>
<span id="cb132-11"><a href="NE.html#cb132-11" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb132-12"><a href="NE.html#cb132-12" tabindex="-1"></a>  <span class="fu">geom_function</span>(<span class="at">fun =</span> d.alpha.compliers, <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb132-13"><a href="NE.html#cb132-13" tabindex="-1"></a>  <span class="fu">geom_function</span>(<span class="at">fun =</span> d.alpha.defiers, <span class="at">colour =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb132-14"><a href="NE.html#cb132-14" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;density&#39;</span>) <span class="sc">+</span></span>
<span id="cb132-15"><a href="NE.html#cb132-15" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:AlphaTypesPlot"></span>
<img src="STCI_files/figure-html/AlphaTypesPlot-1.png" alt="Distribution of treatment effects by Type in the sample (dashed line) and in the population (full line)" width="50%" />
<p class="caption">
Figure 4.3: Distribution of treatment effects by Type in the sample (dashed line) and in the population (full line)
</p>
</div>
<p>Figure <a href="NE.html#fig:AlphaTypesPlot">4.3</a> shows that the two distributions are actually very similar in our example.
The distribution for the compliers is slightly above that for the defiers, meaning that the defiers should have lower expected outcomes in the population.
Let us check that by computing the average outcomes of compliers and defiers both in the sample and in the population.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="NE.html#cb133-1" tabindex="-1"></a><span class="co"># sample means</span></span>
<span id="cb133-2"><a href="NE.html#cb133-2" tabindex="-1"></a>mean.alpha.compliers.samp <span class="ot">&lt;-</span> <span class="fu">mean</span>(alpha[C<span class="sc">==</span><span class="dv">1</span>]) </span>
<span id="cb133-3"><a href="NE.html#cb133-3" tabindex="-1"></a>mean.alpha.defiers.samp <span class="ot">&lt;-</span> <span class="fu">mean</span>(alpha[D<span class="sc">==</span><span class="dv">1</span>]) </span>
<span id="cb133-4"><a href="NE.html#cb133-4" tabindex="-1"></a></span>
<span id="cb133-5"><a href="NE.html#cb133-5" tabindex="-1"></a><span class="co"># population means</span></span>
<span id="cb133-6"><a href="NE.html#cb133-6" tabindex="-1"></a>mean.alpha.compliers.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.alpha.yBV,<span class="at">sigma=</span>cov.alpha.yBV,<span class="at">lower=</span>lower.cut.comp,<span class="at">upper=</span>upper.cut.comp,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb133-7"><a href="NE.html#cb133-7" tabindex="-1"></a>mean.alpha.defiers.pop <span class="ot">&lt;-</span>  <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.alpha.yBV,<span class="at">sigma=</span>cov.alpha.yBV,<span class="at">lower=</span>lower.cut.def,<span class="at">upper=</span>upper.cut.def,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span></code></pre></div>
<p>In the population, the average treatment effect for compliers is equal to 0.17 and the average treatment effect for defiers is equal to 0.14.
In the sample, the average treatment effect for compliers is equal to 0.2 and the average treatment effect for defiers is equal to 0.16.</p>
<p>The difference between the treatment effect for compliers and defiers is a problem for the Wald estimator.
Let’s look at how the Wald estimator behaves in the population (in order to avoid considerations due to sampling noise).
By Theorem <a href="RCT.html#thm:ITELATE">3.10</a>, the numerator of the Wald estimator is equal to the difference between the average treatment on compliers and the average treatment effect on defiers weighted by their respective proportions in the population.
In order to be able to compute the Wald estimator, we need to compute the proportion of compliers and of defiers in the population.
These proportions are equal to:</p>
<p><span class="math display">\[\begin{align*}
  \Pr(T_i=c) &amp; = \Pr(\bar{y}&lt; y_i^B+V_i\leq\bar{y}+\bar{\kappa}\cap\kappa_i=-\bar{\kappa}) \\
              &amp; = \Pr(\bar{y}&lt; y_i^B+V_i\leq\bar{y}+\bar{\kappa})p_{\xi} \\
  \Pr(T_i=d) &amp; = \Pr(\bar{y}-\underline{\kappa}&lt; y_i^B+V_i\leq\bar{y}\cap\kappa_i=\underline{\kappa}) \\
              &amp; = \Pr(\bar{y}-\underline{\kappa}&lt; y_i^B+V_i\leq\bar{y})(1-p_{\xi}),
\end{align*}\]</span></p>
<p>where the second equality follows from the fact that <span class="math inline">\(\xi\)</span> is independent from <span class="math inline">\(y_i^B+V_i\)</span> and uses the fact that <span class="math inline">\(\Pr(A\cap B)=\Pr(A|B)\Pr(B)\)</span>.
Since <span class="math inline">\(y_i^B+V_i\)</span> is normally distributed and we know its mean and variance, these proportions can be computed as:</p>
<p><span class="math display">\[\begin{align*}
  \Pr(T_i=c) &amp; = p_{\xi}\left(\Phi\left(\frac{\bar{y}+\bar{\kappa}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}}\right)
                  -\Phi\left(\frac{\bar{y}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}}\right)\right) \\
  \Pr(T_i=d) &amp; = (1-p_{\xi})\left(\Phi\left(\frac{\bar{y}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}}\right)
                  -\Phi\left(\frac{\bar{y}-\underline{\kappa}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}}\right)\right).
\end{align*}\]</span></p>
<p>Let’s write functions to compute these objects:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="NE.html#cb134-1" tabindex="-1"></a><span class="co"># proportion compliers</span></span>
<span id="cb134-2"><a href="NE.html#cb134-2" tabindex="-1"></a>Prop.Comp <span class="ot">&lt;-</span> <span class="cf">function</span>(param){</span>
<span id="cb134-3"><a href="NE.html#cb134-3" tabindex="-1"></a>  first <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>]<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>])))</span>
<span id="cb134-4"><a href="NE.html#cb134-4" tabindex="-1"></a>  second <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>])))</span>
<span id="cb134-5"><a href="NE.html#cb134-5" tabindex="-1"></a>  <span class="fu">return</span>(param[<span class="st">&#39;pxi&#39;</span>]<span class="sc">*</span>(first <span class="sc">-</span> second))  </span>
<span id="cb134-6"><a href="NE.html#cb134-6" tabindex="-1"></a>}</span>
<span id="cb134-7"><a href="NE.html#cb134-7" tabindex="-1"></a></span>
<span id="cb134-8"><a href="NE.html#cb134-8" tabindex="-1"></a><span class="co"># proportion defiers</span></span>
<span id="cb134-9"><a href="NE.html#cb134-9" tabindex="-1"></a>Prop.Def <span class="ot">&lt;-</span> <span class="cf">function</span>(param){</span>
<span id="cb134-10"><a href="NE.html#cb134-10" tabindex="-1"></a>  first <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>])))</span>
<span id="cb134-11"><a href="NE.html#cb134-11" tabindex="-1"></a>  second <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>param[<span class="st">&#39;underbarkappa&#39;</span>]<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>])))</span>
<span id="cb134-12"><a href="NE.html#cb134-12" tabindex="-1"></a>  <span class="fu">return</span>((<span class="dv">1</span><span class="sc">-</span>param[<span class="st">&#39;pxi&#39;</span>])<span class="sc">*</span>(first <span class="sc">-</span> second))  </span>
<span id="cb134-13"><a href="NE.html#cb134-13" tabindex="-1"></a>}</span></code></pre></div>
<p>In our example, the proportion of compliers is equal to 0.33 and the proportion of defiers is equal to 0.01.
As a consequence, the population value of the numerator of the Wald estimator is equal to 0.05.
In the Wald estimator, this quantity is divided by the difference between the proportion of participants when <span class="math inline">\(Z_i=1\)</span> and when <span class="math inline">\(Z_i=0\)</span>.
We have already computed this quantity earlier, but it is nice to try to compute it in a different way using the types.
The difference in the proportion of participants when <span class="math inline">\(Z_i=1\)</span> and when <span class="math inline">\(Z_i=0\)</span> is indeed equal to the difference in the proportion of compliers and the proportion of defiers.
The difference between the proportion of compliers and the proportion of defiers is equal to 0.32, while the difference between the proportion of participants when <span class="math inline">\(Z_i=1\)</span> and when <span class="math inline">\(Z_i=0\)</span> is equal to 0.32.
It is reassuring that we find the same thing (actually, full disclosure, I did not find the same thing at first, and this help me spot a mistake in the formulas for the proportions of participants: mistakes are normal and natural and that is how we learn and grow).</p>
<p>So we are now equipped to compute the value of the Wald estimator in the population in our model without monotonicity.
It is equal to 0.172.
In practice, the bias of the Wald estimator is rather small for the average treatment effect on the compliers (remember that it is equal to 0.171).
In order to understand why, it is useful to see that the bias of the Wald estimator for the average treatment effect on the compliers is equal to:</p>
<p><span class="math display">\[\begin{align*}
  \esp{\Delta_i^Y|T_i=c}-\Delta^Y_{Wald} &amp; = \esp{\Delta_i^Y|T_i=c} + (\esp{\Delta_i^Y|T_i=c}-\esp{\Delta_i^Y|T_i=d})\frac{\Pr(T_i=d)}{\Pr(T_i=c)-\Pr(T_i=d)},
\end{align*}\]</span></p>
<p>where the equality follows from Theorem <a href="RCT.html#thm:ITELATE">3.10</a> and some algebra.
In the absence of Monotonicity, when the impact on defiers is smaller than the impact of compliers, the Wald estimator is baised upward for the effect on the compliers (as it happens in our example).
In a model in which the effect of the treatment is larger on defiers than on compliers, the Wald estimator is biased downwards for the effect on compliers because defiers make the outcome of the control group seem too good.
In the extreme, when <span class="math inline">\(\esp{\Delta_i^Y|T_i=d}&gt;\esp{\Delta_i^Y|T_i=c}(1+\frac{\Pr(T_i=c)-\Pr(T_i=d)}{\Pr(T_i=d)})\)</span>, the Wald estimator can be negative whereas the effects on compliers and on defiers are both positive.
This happens when the effect on defiers is <span class="math inline">\(1+\frac{\Pr(T_i=c)-\Pr(T_i=d)}{\Pr(T_i=d)}\)</span> times larger than the effect on compliers.
In our case, that means that the effect on defiers should be 26 times larger than the effect on compliers for the Wald estimator to be negative, that is to say the effect on defiers should be equal to 4.41, really much much much larger than the effect on compliers.</p>
<p>From there, we are going to explore three strategies in order to identify some true effect of the treatment using the Wald estimator:</p>
<ul>
<li>The first strategy has been recently proposed by <a href="https://drive.google.com/file/d/16XWlDECIvreM7l_NHe-JkXgyuPhFT1QG/view">de Chaisemartin (2017)</a>.
It is valid in a model without monotonicity.</li>
<li>The second strategy assumes that the heterogeneity in treatment effects is uncorrelated to the treatment.</li>
<li>The last strategy is due to Imbens and Angrist (1994) and assumes that Monotonicity holds.</li>
</ul>
<p>Let’s review these solutions in turn.</p>
<div id="identification-without-monotonicity" class="section level4 hasAnchor" number="4.1.2.1">
<h4><span class="header-section-number">4.1.2.1</span> Identification without Monotonicity<a href="NE.html#identification-without-monotonicity" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The approach delineated by <a href="https://drive.google.com/file/d/16XWlDECIvreM7l_NHe-JkXgyuPhFT1QG/view">de Chaisemartin (2017)</a> does not assume away non-monotonicity.
Clement instead assumes that we can divide the population of compliers in two-subpopulations: the <strong>compliers-defiers</strong> (<span class="math inline">\(T_i=cd\)</span>) and the <strong>surviving-compliers</strong> (<span class="math inline">\(T_i=sc\)</span>).
The main assumption in Clement’s approach is that <em>(i)</em> the compliers-defiers are in the same proportion as the defiers and <em>(ii)</em> that the average effect of the treatment on the compliers defiers is equal as the average effect of the treatment on the defiers.
These two assumptions can be formalized as follows:</p>
<div class="hypothesis">
<p><span id="hyp:CD" class="hypothesis"><strong>Hypothesis 4.5  (Compliers-defiers) </strong></span>We assume that there exists as subpopulation of compliers that are in the same proportion as the defiers and for whom the average effect of the treatment is equal as the average effect of the treatment on the defiers:</p>
<p><span class="math display">\[\begin{align*}
(T_i=c) &amp; = (T_i=cd)\cup (T_i=sc) \\
\Pr(T_i=cd) &amp; = \Pr(T_i=d) \\
\esp{Y^1_i-Y^0_i|T_i=cd} &amp; = \esp{Y^1_i-Y^0_i|T_i=d}.
\end{align*}\]</span></p>
</div>
<p>The first equation in Assumption <a href="NE.html#hyp:CD">4.5</a> imposes that the compliers-defiers and the surviving-compliers are a partition of the population of compliers.
From Assumption <a href="NE.html#hyp:CD">4.5</a>, we can prove the following theorem:</p>
<div class="theorem">
<p><span id="thm:deChaise" class="theorem"><strong>Theorem 4.1  (Identification of the effect on the surviving-compliers) </strong></span>Under Assumptions <a href="NE.html#hyp:FirstStage">4.1</a>, <a href="NE.html#hyp:ExclusionRestriction">4.2</a>, <a href="NE.html#hyp:Independence">4.3</a> and <a href="NE.html#hyp:CD">4.5</a>, the Wald estimator identifies the effect of the treatment on the surviving-compliers:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{Wald} &amp; = \Delta^Y_{sc},
\end{align*}\]</span></p>
</div>
<p>with:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{Wald} &amp; = \frac{\esp{Y_i|Z_i=1} - \esp{Y_i|Z_i=0}}{\Pr(D_i=1|Z_i=1)-\Pr(D_i=1|Z_i=0)}\\
  \Delta^Y_{sc} &amp; = \esp{Y^1_i-Y^0_i|T_i=sc}.
\end{align*}\]</span></p>
<div class="proof">
<p><span id="unlabeled-div-78" class="proof"><em>Proof</em>. </span>Under Assumptions <a href="NE.html#hyp:ExclusionRestriction">4.2</a> and <a href="NE.html#hyp:Independence">4.3</a>, Theorems <a href="RCT.html#thm:ITELATE">3.10</a> and <a href="RCT.html#thm:ITEEncourag">3.12</a> imply that the numerator of the Wald estimator is equal to <span class="math inline">\(\Delta^Y_{ITE}\)</span> with:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{ITE}  &amp; = \esp{Y_i^{1}-Y_i^{0}|T_i=c}\Pr(T_i=c)-\esp{Y_i^{1}-Y_i^{0}|T_i=d}\Pr(T_i=d).
\end{align*}\]</span></p>
<p>Now, we have that the effect on compliers can be decomposed in the effect on surviving-compliers and the effect on compliers-defiers using the Law of Iterated Expectations and the fact that <span class="math inline">\(T_i=sc \Rightarrow T_i=c\)</span> and <span class="math inline">\(T_i=cd \Rightarrow T_i=c\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\Delta^Y_{c} &amp; = \esp{Y_i^{1}-Y_i^{0}|T_i=sc}\Pr(T_i=sc|T_i=c)+\esp{Y_i^{1}-Y_i^{0}|T_i=cd}\Pr(T_i=cd|T_i=c),
\end{align*}\]</span></p>
<p>Now, using the fact that <span class="math inline">\(\Pr(T_i=sc|T_i=c)\Pr(T_i=c)=\Pr(T_i=sc)\)</span> and <span class="math inline">\(\Pr(T_i=cd|T_i=c)\Pr(T_i=c)=\Pr(T_i=cd)\)</span> (because <span class="math inline">\(\Pr(A|B)\Pr(B)=\Pr(A\cap B)\)</span> and <span class="math inline">\(\Pr(A\cap B)=\Pr(A)\)</span> if <span class="math inline">\(A \Rightarrow B\)</span>), we have:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{ITE} &amp; = \esp{Y_i^{1}-Y_i^{0}|T_i=sc}\Pr(T_i=sc)\\
                &amp; \phantom{=}+\esp{Y_i^{1}-Y_i^{0}|T_i=cd}\Pr(T_i=cd)-\esp{Y_i^{1}-Y_i^{0}|T_i=d}\Pr(T_i=d).
\end{align*}\]</span></p>
<p>The second part of the right-hand side of the above equation is equal to zero by virtue of Assumption <a href="NE.html#hyp:CD">4.5</a>.
Now, under Assumptions <a href="NE.html#hyp:FirstStage">4.1</a>, <a href="NE.html#hyp:ExclusionRestriction">4.2</a> and <a href="NE.html#hyp:Independence">4.3</a>, we know, from the proof of Theorem <a href="RCT.html#thm:IdentLATE">3.9</a>, that <span class="math inline">\(\Pr(D_i=1|Z_i=1)-\Pr(D_i=1|Z_i=0)=\Pr(T_i=c)-\Pr(T_i=d)\)</span>.
Under Assumption <a href="NE.html#hyp:CD">4.5</a>, we have <span class="math inline">\(\Pr(T_i=c)=\Pr((T_i=cd)\cup(T_i=sc))=\Pr(T_i=cd)+\Pr(T_i=sc)\)</span>.
Replacing <span class="math inline">\(\Pr(T_i=c)\)</span> gives <span class="math inline">\(\Pr(D_i=1|Z_i=1)-\Pr(D_i=1|Z_i=0)=\Pr(T_i=sc)\)</span>.
Dividing <span class="math inline">\(\Delta^Y_{ITE}\)</span> by <span class="math inline">\(\Pr(T_i=sc)\)</span> gives the result.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-79" class="remark"><em>Remark</em>. </span><a href="https://drive.google.com/file/d/16XWlDECIvreM7l_NHe-JkXgyuPhFT1QG/view">de Chaisemartin (2017)</a> shows in his Theorem 2.1 that the reciprocal of Theorem <a href="NE.html#thm:deChaise">4.1</a> is actually valid: if there exists surviving-compliers such that their effect is estimated by the Wald estimator and their proportion is equal to the denominator of the Wald estimator, then it has to be that there exists a sub-population of compliers-defiers that are in the same proportion as the defiers and have the same average treatment effect.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-149" class="example"><strong>Example 4.7  </strong></span>Let us now see if the conditions in <a href="https://drive.google.com/file/d/16XWlDECIvreM7l_NHe-JkXgyuPhFT1QG/view">de Chaisemartin (2017)</a> are verified in our numerical example.</p>
</div>
<p>I have bad news: they are not.
It is not super easy to see why, but an intuitive explanation is that the average effect on the defiers in our model is taken conditional on <span class="math inline">\(y^B_i+V_i\in]\bar{y}-\underline{\kappa},\bar{y}]\)</span> while the effect on compliers is taken conditional on <span class="math inline">\(y^B_i+V_i\in]\bar{y},\bar{y}+\bar{\kappa}]\)</span>.
These two intervals do not overlap.
Since the expected value of the treatment effect conditional on <span class="math inline">\(y^B_i+V_i=v\)</span> is monotonous in <span class="math inline">\(v\)</span> (because both variables come from a bivariate normal distribution), then all the effects on the defiers interval are either smaller or larger than all the effects on the compliers interval, making it impossible to find a sub-population of compliers that have the same average effect of the treatment as the defiers.</p>
<p>More formally, it is possible to prove this result by using the concept of Marginal Treatment Effect developed by <a href="https://www.pnas.org/content/pnas/96/8/4730.full.pdf">Heckman and Vytlacil (1999)</a>.
I might devote a specific section of the book to the MTE and its derivations.
For now, I let it as a possibility.</p>
<p>What can we do then?
Probably the best that we can do is to find <span class="math inline">\(\kappa^*\)</span> such that <span class="math inline">\(\Pr(\bar{y}&lt;y_i^B+V\leq\bar{y}+\kappa^*)p_{\xi}=\Pr(T_i=d)\)</span>, that is the value such that the interval of values of <span class="math inline">\(y_i^B+V\)</span> that are for compliers and closest to the interval for defiers and that contains the same proportion of compliers as there are defiers.
This value is going to produce an average effect for compliers-defiers as close as possible to the average effect on defiers.
It can be computed as follows:</p>
<p><span class="math display">\[\begin{align*}
  \kappa^* &amp; = \bar{\mu}-\bar{y}+\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}
                                  \Phi^{-1}\Bigg(\Phi\left(\frac{\bar{y}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}}\right)\\
           &amp; \phantom{=}+\frac{1-p_{\xi}}{p_{\xi}}\left(\Phi\left(\frac{\bar{y}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}}\right)-\Phi\left(\frac{\bar{y}-\underline{\kappa}-\bar{\mu}}{\sqrt{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}}\right)\right)\Bigg)
\end{align*}\]</span></p>
<p>Let’s write functions to compute <span class="math inline">\(\kappa^*\)</span>, the implied proportion of compliers-defiers and the average effect of the treatment on compliers-defiers and on surviving-compliers:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="NE.html#cb135-1" tabindex="-1"></a><span class="co"># kappa star</span></span>
<span id="cb135-2"><a href="NE.html#cb135-2" tabindex="-1"></a>KappaStar <span class="ot">&lt;-</span> <span class="cf">function</span>(param){</span>
<span id="cb135-3"><a href="NE.html#cb135-3" tabindex="-1"></a>  prop.def <span class="ot">&lt;-</span> <span class="fu">Prop.Def</span>(param)</span>
<span id="cb135-4"><a href="NE.html#cb135-4" tabindex="-1"></a>  prop.below.bary <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>])))</span>
<span id="cb135-5"><a href="NE.html#cb135-5" tabindex="-1"></a>  st.dev.yB.V <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>])</span>
<span id="cb135-6"><a href="NE.html#cb135-6" tabindex="-1"></a>  <span class="fu">return</span>(param[<span class="st">&#39;barmu&#39;</span>]<span class="sc">-</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>st.dev.yB.V<span class="sc">*</span><span class="fu">qnorm</span>(prop.below.bary<span class="sc">+</span>prop.def<span class="sc">/</span>param[<span class="st">&#39;pxi&#39;</span>]))</span>
<span id="cb135-7"><a href="NE.html#cb135-7" tabindex="-1"></a>}</span>
<span id="cb135-8"><a href="NE.html#cb135-8" tabindex="-1"></a></span>
<span id="cb135-9"><a href="NE.html#cb135-9" tabindex="-1"></a><span class="co"># proportion of compliers-defiers</span></span>
<span id="cb135-10"><a href="NE.html#cb135-10" tabindex="-1"></a>Prop.Comp.Def <span class="ot">&lt;-</span> <span class="cf">function</span>(param){</span>
<span id="cb135-11"><a href="NE.html#cb135-11" tabindex="-1"></a>  first <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span><span class="fu">KappaStar</span>(param)<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>])))</span>
<span id="cb135-12"><a href="NE.html#cb135-12" tabindex="-1"></a>  second <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>param[<span class="st">&#39;barmu&#39;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>((<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>])))</span>
<span id="cb135-13"><a href="NE.html#cb135-13" tabindex="-1"></a>  <span class="fu">return</span>(param[<span class="st">&#39;pxi&#39;</span>]<span class="sc">*</span>(first <span class="sc">-</span> second))  </span>
<span id="cb135-14"><a href="NE.html#cb135-14" tabindex="-1"></a>}</span>
<span id="cb135-15"><a href="NE.html#cb135-15" tabindex="-1"></a></span>
<span id="cb135-16"><a href="NE.html#cb135-16" tabindex="-1"></a><span class="co"># mean impact on compliers-defiers</span></span>
<span id="cb135-17"><a href="NE.html#cb135-17" tabindex="-1"></a>lower.cut.comp.def <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))</span>
<span id="cb135-18"><a href="NE.html#cb135-18" tabindex="-1"></a>upper.cut.comp.def <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span><span class="fu">KappaStar</span>(param))</span>
<span id="cb135-19"><a href="NE.html#cb135-19" tabindex="-1"></a>mean.alpha.comp.def.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.alpha.yBV,<span class="at">sigma=</span>cov.alpha.yBV,<span class="at">lower=</span>lower.cut.comp.def,<span class="at">upper=</span>upper.cut.comp.def,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span>
<span id="cb135-20"><a href="NE.html#cb135-20" tabindex="-1"></a></span>
<span id="cb135-21"><a href="NE.html#cb135-21" tabindex="-1"></a><span class="co"># mean impact on surviving compliers</span></span>
<span id="cb135-22"><a href="NE.html#cb135-22" tabindex="-1"></a>lower.cut.surv.comp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span><span class="fu">KappaStar</span>(param))</span>
<span id="cb135-23"><a href="NE.html#cb135-23" tabindex="-1"></a>upper.cut.surv.comp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>])</span>
<span id="cb135-24"><a href="NE.html#cb135-24" tabindex="-1"></a></span>
<span id="cb135-25"><a href="NE.html#cb135-25" tabindex="-1"></a>mean.alpha.surv.comp.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.alpha.yBV,<span class="at">sigma=</span>cov.alpha.yBV,<span class="at">lower=</span>lower.cut.surv.comp,<span class="at">upper=</span>upper.cut.surv.comp,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]]</span></code></pre></div>
<p>The first have that <span class="math inline">\(\kappa^*=\)</span> 0.0452.
For this value of <span class="math inline">\(\kappa^*\)</span>, we have that <span class="math inline">\(\Pr(T_i=cd)=\)</span> 0.0128.
As expected, this is very close to the proportion of compliers in the population: <span class="math inline">\(\Pr(T_i=d)=\)</span> 0.0128.
Finally, the average treatment effect on the compliers-defiers is equal to: <span class="math inline">\(\Delta^y_{cd}=\)</span> 0.1457.
As expected, but luckily enough, since it was absolutely not sure, it is very close to the to the average treatment effect on the defiers: <span class="math inline">\(\Delta^y_{d}=\)</span> 0.1445.
So, in our model, Assumption <a href="NE.html#hyp:CD">4.5</a> is almost satisfied, and so does Theorem <a href="NE.html#thm:deChaise">4.1</a>.
As a consequence, the Wald estimator is very close to the effect on the surviving-compliers.
Indeed, the Wald estimator, in the population, is equal to <span class="math inline">\(\Delta^y_{Wald}=\)</span> 0.172156, while the average effect on surviving-compliers is equal to <span class="math inline">\(\Delta^y_{sc}=\)</span> 0.172108.</p>
</div>
<div id="identification-under-independence-of-treatment-effects" class="section level4 hasAnchor" number="4.1.2.2">
<h4><span class="header-section-number">4.1.2.2</span> Identification under Independence of treatment effects<a href="NE.html#identification-under-independence-of-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Another way to get around the issue of Non-Monotonicity is simply to assume away any meaningful role for treatment effect heterogeneity.
One approach to that would simply be to assume that treatment effects are constant across individuals.
I leave to the reader to prove that in that case, the Wald estimator would recover the treatment effect under only Independence and Exclusion Restriction.
We are going to use a slightly more general approach here by assuming that treatment effect heterogeneity is unrelated to the reaction to the instrument:</p>
<div class="hypothesis">
<p><span id="hyp:IndepTreatEffect" class="hypothesis"><strong>Hypothesis 4.6  (Independent Treatment Effects) </strong></span>We assume that the treatment effect is independent from potential reactions to the instrument:</p>
<p><span class="math display">\[\begin{align*}
\Delta^Y_i\Ind (D^1_i,D^0_i).
\end{align*}\]</span></p>
</div>
<p>We can now prove that, under Assumption <a href="NE.html#hyp:IndepTreatEffect">4.6</a>, the Wald estimator identifies the Average Treatment Effect (ATE), the average effect of the Treatment on the Treated (TT) and the average effect on compliers and on defiers.
The first thing to know before we state the result is that, under Assumption <a href="NE.html#hyp:IndepTreatEffect">4.6</a>, all these average treatment effects are equal to each other.
This is a direct implication of the following lemma:</p>
<div class="lemma">
<p><span id="lem:IndepTreatEffectType" class="lemma"><strong>Lemma 4.1  (Independence of Treatment Effects from Types) </strong></span>Under Assumption <a href="NE.html#hyp:IndepTreatEffect">4.6</a>, the treatment effect is independent from types:</p>
<p><span class="math display">\[\begin{align*}
\Delta^Y_i\Ind T_i.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-80" class="proof"><em>Proof</em>. </span>Lemma (4.2) in <a href="https://rss.onlinelibrary.wiley.com/doi/10.1111/j.2517-6161.1979.tb01052.x">Dawid (1979)</a> states that if <span class="math inline">\(X \Ind Y|Z\)</span> and <span class="math inline">\(U\)</span> is a function of <span class="math inline">\(X\)</span>, then <span class="math inline">\(U \Ind Y|Z\)</span>.
Since <span class="math inline">\(T_i\)</span> is a function of <span class="math inline">\((D^1_i,D^0_i)\)</span> under Assumption <a href="NE.html#hyp:IndepTreatEffect">4.6</a>, Lemma <a href="NE.html#lem:IndepTreatEffectType">4.1</a> follows.</p>
</div>
<p>A direct corollary of Lemma <a href="NE.html#lem:IndepTreatEffectType">4.1</a> is:</p>
<div class="corollary">
<p><span id="cor:IndepTreatEffectAve" class="corollary"><strong>Corollary 4.1  (Independence of Treatment Effects and Average Effects) </strong></span>Under Assumption <a href="NE.html#hyp:IndepTreatEffect">4.6</a>, the Average Treatment Effect (ATE), the average effect of the Treatment on the Treated (TT) and the average effect on compliers and on defiers are all equal:</p>
<p><span class="math display">\[\begin{align*}
\Delta^Y_{ATE} = \Delta^Y_{TT(1)} = \Delta^Y_{TT(0)} = \Delta^Y_{c} = \Delta^Y_{d}.
\end{align*}\]</span></p>
</div>
<p>with:
<span class="math display">\[\begin{align*}
\Delta^Y_{TT(z)} = \esp{Y_i^1-Y_i^0|D_i=1,Z_i=z}.
\end{align*}\]</span></p>
<div class="proof">
<p><span id="unlabeled-div-81" class="proof"><em>Proof</em>. </span>Using Lemma <a href="NE.html#lem:IndepTreatEffectType">4.1</a>, we have that:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{c} = \Delta^Y_{d} = \Delta^Y_{at} =\Delta^Y_{nt}.
\end{align*}\]</span></p>
<p>Because <span class="math inline">\(T_i\)</span> is a partition, we have <span class="math inline">\(\Delta^Y_{ATE}=\Delta^Y_{c}\Pr(T_i=c)+\Delta^Y_{d}\Pr(T_i=d)+\Delta^Y_{at}\Pr(T_i=at)+\Delta^Y_{nt}\Pr(T_i=nt)=\Delta^Y_{c}\)</span> (since <span class="math inline">\(\Pr(T_i=c)+\Pr(T_i=d)+\Pr(T_i=at)+\Pr(T_i=nt)=1\)</span>).
Finally, we also have that <span class="math inline">\(\Delta^Y_{TT(1)}=\Delta^Y_{c}\Pr(T_i=c|D_i=1,Z_i=1)+\Delta^Y_{at}\Pr(T_i=at|D_i=1,Z_i=1)=\Delta^Y_{c}\)</span> and <span class="math inline">\(\Delta^Y_{TT(0)}=\Delta^Y_{d}\Pr(T_i=d|D_i=1,Z_i=0)+\Delta^Y_{at}\Pr(T_i=at|D_i=1,Z_i=0)=\Delta^Y_{c}\)</span>, since <span class="math inline">\((D_i=1)\cap(Z_i=1)\Rightarrow (T_i=c)\cup(T_i=at)\)</span> and <span class="math inline">\((D_i=1)\cap(Z_i=0)\Rightarrow (T_i=d)\cup(T_i=at)\)</span>.</p>
</div>
<p>We are now equipped to state the final result of this section:</p>
<div class="theorem">
<p><span id="thm:IdentIndepTreatEffect" class="theorem"><strong>Theorem 4.2  (Identification under Independent Treatment Effect) </strong></span>Under Assumptions <a href="NE.html#hyp:FirstStage">4.1</a>, <a href="NE.html#hyp:ExclusionRestriction">4.2</a>, <a href="NE.html#hyp:Independence">4.3</a> and <a href="NE.html#hyp:IndepTreatEffect">4.6</a>, the Wald estimator identifies the average effect of the Treatment on the Treated:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{Wald} &amp; = \Delta^Y_{TT}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-82" class="proof"><em>Proof</em>. </span>Using the formula for the Wald estimator, we have, for the two components of its numerator:</p>
<p><span class="math display">\[\begin{align*}
\esp{Y_i|Z_i=1} &amp; = \esp{Y_i^0+(Y_i^1-Y_i^0)D_i|Z_i=1} \\
                &amp; = \esp{Y_i^0|Z_i=1}+\esp{\Delta^Y_i|D_i=1,Z_i=1}\Pr(D_i=1|Z_i=1)\\
                &amp; = \esp{Y_i^0|Z_i=1}+\Delta^Y_{TT(1)}\Pr(D_i=1|Z_i=1)\\
\esp{Y_i|Z_i=0} &amp; = \esp{Y_i^0+(Y_i^1-Y_i^0)D_i|Z_i=0} \\
                &amp; = \esp{Y_i^0|Z_i=0}+\esp{\Delta^Y_i|D_i=0,Z_i=1}\Pr(D_i=1|Z_i=0)\\
                &amp; = \esp{Y_i^0|Z_i=0}+\Delta^Y_{TT(0)}\Pr(D_i=1|Z_i=0),\\
\end{align*}\]</span></p>
<p>where the first equalities use Assumption <a href="NE.html#hyp:ExclusionRestriction">4.2</a>.
Now, under Assumption <a href="NE.html#hyp:IndepTreatEffect">4.6</a>, Corollary <a href="NE.html#cor:IndepTreatEffectAve">4.1</a> implies that <span class="math inline">\(\Delta^Y_{TT(0)}=\Delta^Y_{TT(1)}=\Delta^Y_{TT}\)</span>.
We thus have that the numerator of the Wald estimator is equal to:</p>
<p><span class="math display">\[\begin{align*}
\esp{Y_i|Z_i=1}-\esp{Y_i|Z_i=0} &amp; = \Delta^Y_{TT}(\Pr(D_i=1|Z_i=1)-\Pr(D_i=1|Z_i=0))\\
                                &amp; \phantom{=}+\esp{Y_i^0|Z_i=1}-\esp{Y_i^0|Z_i=0}.
\end{align*}\]</span></p>
<p>Assumption <a href="NE.html#hyp:Independence">4.3</a> implies that <span class="math inline">\(\esp{Y_i^0|Z_i=1}=\esp{Y_i^0|Z_i=0}\)</span>.
Using Assumption <a href="NE.html#hyp:FirstStage">4.1</a> proves the result.</p>
</div>
</div>
<div id="IVMONO" class="section level4 hasAnchor" number="4.1.2.3">
<h4><span class="header-section-number">4.1.2.3</span> Identification under Monotonicity<a href="NE.html#IVMONO" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The classical approach to identification using instrumental variables is due to <a href="https://www.jstor.org/stable/2951620">Imbens and Angrist (1994)</a> and <a href="https://www.jstor.org/stable/2291629">Angrist, Imbens and Rubin (1996)</a>.
It rests on Assumption <a href="NE.html#hyp:MonotonicityIV">4.4</a> or Monotonicity that we are now familiar with, that requires that the effect of the instrument on treatment participation moves everyone in the same direction.</p>
<div class="remark">
<p><span id="unlabeled-div-83" class="remark"><em>Remark</em>. </span>For the rest of the section, we will assume that <span class="math inline">\(\forall i\)</span>, <span class="math inline">\(D^1_i\geq D_i^0\)</span>.
It is without loss of generality, since if the initial treatment does not comply with this requirement, you can simply redefine a new treatment equal to <span class="math inline">\(-D_i\)</span>.</p>
</div>
<p>Under Monotonicity, there are no defiers.
This is what the following lemma shows:</p>
<div class="lemma">
<p><span id="lem:NoDefiers" class="lemma"><strong>Lemma 4.2  </strong></span>Under Assumption <a href="NE.html#hyp:MonotonicityIV">4.4</a>, there are no defiers a.s.:</p>
<p><span class="math display">\[\begin{align*}
  \Pr(T_i=c) &amp; = 0.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-84" class="proof"><em>Proof</em>. </span>Under Assumption <a href="NE.html#hyp:MonotonicityIV">4.4</a>, <span class="math inline">\(\forall i\)</span>, <span class="math inline">\(D^1_i\geq D_i^0\)</span>.
As a consequence, <span class="math inline">\(\Pr(D^1_i &lt; D_i^0)=0\)</span>.
Since defiers are defined as <span class="math inline">\(D^1_i &lt; D_i^0\)</span>, the result follows.</p>
</div>
<p>In the absence of defiers, the Wald estimator identifies the average effect of the treatment on the compliers, also called the Local Average Treatment Effect:</p>
<div class="theorem">
<p><span id="thm:IdentLATEIV" class="theorem"><strong>Theorem 4.3  </strong></span>Under Assumptions <a href="NE.html#hyp:FirstStage">4.1</a>, <a href="NE.html#hyp:ExclusionRestriction">4.2</a>, <a href="NE.html#hyp:Independence">4.3</a> and <a href="NE.html#hyp:MonotonicityIV">4.4</a>, the Wald estimator identifies the average effect of the treatment on the compliers, also called the Local Average Treatment Effect:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{Wald}&amp; = \Delta^Y_{LATE}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-85" class="proof"><em>Proof</em>. </span>Using Theorem <a href="RCT.html#thm:IdentLATE">3.9</a> directly proves the result.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-86" class="remark"><em>Remark</em>. </span>The magic of the instrumental variables setting applies again.
By moving the instrument, we are able to learn something about the causal effect of the treatment.
Monotonicity is a very strong assumption though, as are Independence and Exclusion Restriction.
They are very rarely met in practice.
Even the case of RCTs with encouragement design, where Independence holds by design, might be affected by failures of Exclusion Restriction and/or Monotonicity.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-157" class="example"><strong>Example 4.8  </strong></span>Let’s see how monotonicity works in our example.</p>
</div>
<p>First, we have to generate a model in which monotonicity holds.
For that, we need to shut down heterogeneous reactions to the instrument.
In practice, we are going to replace the participation equation in our model, which was characterized by a random coefficient, by the following one, which has a constant coefficient:</p>
<p><span class="math display">\[\begin{align*}
  D_i &amp; = \uns{y_i^B-\bar{\kappa} Z_i + V_i\leq\bar{y}}
\end{align*}\]</span></p>
<p>As a consequence, we have no more defiers and monotonicity holds.
Let us now generate the data from the model with monotonicity:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="NE.html#cb136-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb136-2"><a href="NE.html#cb136-2" tabindex="-1"></a>N <span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb136-3"><a href="NE.html#cb136-3" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb136-4"><a href="NE.html#cb136-4" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb136-5"><a href="NE.html#cb136-5" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;eta&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb136-6"><a href="NE.html#cb136-6" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb136-7"><a href="NE.html#cb136-7" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb136-8"><a href="NE.html#cb136-8" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb136-9"><a href="NE.html#cb136-9" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb136-10"><a href="NE.html#cb136-10" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb136-11"><a href="NE.html#cb136-11" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N,<span class="dv">1</span>,param[<span class="st">&quot;pZ&quot;</span>])</span>
<span id="cb136-12"><a href="NE.html#cb136-12" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb136-13"><a href="NE.html#cb136-13" tabindex="-1"></a>Ds[yB<span class="sc">-</span>param[<span class="st">&quot;barkappa&quot;</span>]<span class="sc">*</span>Z<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb136-14"><a href="NE.html#cb136-14" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb136-15"><a href="NE.html#cb136-15" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb136-16"><a href="NE.html#cb136-16" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb136-17"><a href="NE.html#cb136-17" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>eta</span>
<span id="cb136-18"><a href="NE.html#cb136-18" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb136-19"><a href="NE.html#cb136-19" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb136-20"><a href="NE.html#cb136-20" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb136-21"><a href="NE.html#cb136-21" tabindex="-1"></a>y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb136-22"><a href="NE.html#cb136-22" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span></code></pre></div>
<p>We can now define the types variable <span class="math inline">\(T_i\)</span>:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="NE.html#cb137-1" tabindex="-1"></a>D1 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(yB<span class="sc">-</span>param[<span class="st">&quot;barkappa&quot;</span>]<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb137-2"><a href="NE.html#cb137-2" tabindex="-1"></a>D0 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(yB<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb137-3"><a href="NE.html#cb137-3" tabindex="-1"></a>AT <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> D0<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb137-4"><a href="NE.html#cb137-4" tabindex="-1"></a>NT <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> D0<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb137-5"><a href="NE.html#cb137-5" tabindex="-1"></a>C <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> D0<span class="sc">==</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb137-6"><a href="NE.html#cb137-6" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> D0<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb137-7"><a href="NE.html#cb137-7" tabindex="-1"></a>Type <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(AT<span class="sc">==</span><span class="dv">1</span>,<span class="st">&#39;a&#39;</span>,</span>
<span id="cb137-8"><a href="NE.html#cb137-8" tabindex="-1"></a>            <span class="fu">ifelse</span>(NT<span class="sc">==</span><span class="dv">1</span>,<span class="st">&#39;n&#39;</span>,</span>
<span id="cb137-9"><a href="NE.html#cb137-9" tabindex="-1"></a>                   <span class="fu">ifelse</span>(C<span class="sc">==</span><span class="dv">1</span>,<span class="st">&#39;c&#39;</span>,</span>
<span id="cb137-10"><a href="NE.html#cb137-10" tabindex="-1"></a>                          <span class="fu">ifelse</span>(D<span class="sc">==</span><span class="dv">1</span>,<span class="st">&#39;d&#39;</span>,<span class="st">&quot;&quot;</span>))))</span>
<span id="cb137-11"><a href="NE.html#cb137-11" tabindex="-1"></a></span>
<span id="cb137-12"><a href="NE.html#cb137-12" tabindex="-1"></a>data.mono <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(Type,C,NT,AT,D1,D0,Y,y,Y1,Y0,y0,y1,yB,alpha,U0,eta.omega<span class="sc">$</span>eta,epsilon,Ds,Z,mu,UB))</span></code></pre></div>
<p>The first thing we can check is that there are no defiers.
For that, let’s count the number of individuals who have <span class="math inline">\(T_i=1\)</span>.
It is equal to 0.</p>
<p>One thing that helped me understand how the IV approach under monotonicity works is the following graph:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="NE.html#cb138-1" tabindex="-1"></a><span class="fu">plot</span>(yB[AT<span class="sc">==</span><span class="dv">1</span>]<span class="sc">+</span>V[AT<span class="sc">==</span><span class="dv">1</span>],y[AT<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&quot;yB+V&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb138-2"><a href="NE.html#cb138-2" tabindex="-1"></a><span class="fu">points</span>(yB[NT<span class="sc">==</span><span class="dv">1</span>]<span class="sc">+</span>V[NT<span class="sc">==</span><span class="dv">1</span>],y[NT<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb138-3"><a href="NE.html#cb138-3" tabindex="-1"></a><span class="fu">points</span>(yB[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> Ds<span class="sc">==</span><span class="dv">1</span>]<span class="sc">+</span>V[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> Ds<span class="sc">==</span><span class="dv">1</span>],y[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb138-4"><a href="NE.html#cb138-4" tabindex="-1"></a><span class="fu">points</span>(yB[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> Ds<span class="sc">==</span><span class="dv">0</span>]<span class="sc">+</span>V[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> Ds<span class="sc">==</span><span class="dv">0</span>],y[C<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;green&#39;</span>)</span>
<span id="cb138-5"><a href="NE.html#cb138-5" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb138-6"><a href="NE.html#cb138-6" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>],<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb138-7"><a href="NE.html#cb138-7" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>]),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">5</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>)),<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>)<span class="sc">+</span><span class="fu">bar</span>(kappa))),<span class="at">pos=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;red&quot;</span>,<span class="st">&quot;red&quot;</span>))</span>
<span id="cb138-8"><a href="NE.html#cb138-8" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="fl">10.5</span>,<span class="fu">c</span>(<span class="st">&#39;AT&#39;</span>,<span class="st">&#39;NT&#39;</span>,<span class="st">&#39;C|D=1&#39;</span>,<span class="st">&#39;C|D=0&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&quot;black&quot;</span>,<span class="st">&#39;blue&#39;</span>,<span class="st">&quot;red&quot;</span>,<span class="st">&#39;green&#39;</span>),<span class="at">ncol=</span><span class="dv">1</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plottypesMono"></span>
<img src="STCI_files/figure-html/plottypesMono-1.png" alt="Types under Monotonicity" width="50%" />
<p class="caption">
Figure 4.4: Types under Monotonicity
</p>
</div>
<p>What <a href="NE.html#fig:plottypesMono">4.4</a> shows is that the IV acts as a randomized controlled trial among compliers.
Within the population of compliers, whether one receives the treatment or not is as good as random.
If we actually knew who the compliers were, we could directly estimate the effect of the treatment by comparing the outcomes of the treated compliers to the outcomes of the untreated compliers.
Actually, this approach, applied in our sample, yields an estimated treatment effect on the compliers of 0.14, whereas the simple comparison of participants and non participants would give an estimate of -0.93.
In our sample, the average effect of the treatment on compliers is actually equal to 0.18.</p>
<p>Let us finally check that Theorem <a href="NE.html#thm:IdentLATEIV">4.3</a> works in the population in our new model.
We need to compute the various parts of the Wald estimator and the average effect of the treatment on the compliers.
The key to understand the Wald estimator is to see that its numerator is composed of the difference between two means, with both means containing the average outcomes of always takers and never takers weighted by their respective proportions in the population, as shown in the proof of Theorem <a href="NE.html#thm:IdentLATEIV">4.3</a>.
These two means cancel out, leaving only the differences in the means of the compliers in and out of the treatment, weighted by their proportion in the population.
The denominator of the Wald estimator simply provides an estimate of the proportion of compliers.
In order to illustrate these intuitions in our example, I am going to use the formula for a truncated multivariate normal variable and the package <code>tmvtnorm</code>.
The most important thing to notice here is that <span class="math inline">\((y^0_i,y^1_i,y_i^B+V_i) \sim \mathcal{N}\left(\bar{\mu}+\delta,\bar{\mu}(1+\theta)+\delta+\bar{\alpha},\bar{\mu},\mathbf{C}\right)\)</span> with:</p>
<p><span class="math display">\[\begin{align*}
  \mathbf{C} &amp;=                    \left(\begin{array}{ccc}
                                              \sigma^2_{\mu}+\rho^2\sigma^2_{U} +\sigma^2_{\epsilon} &amp;
                                              (1+\theta)\sigma^2_{\mu}+\rho^2\sigma^2_U + \sigma^2_{\epsilon} &amp;
                                              (1+\gamma)\sigma^2_{\mu}+\rho\sigma^2_U \\
                                              (1+\theta)\sigma^2_{\mu}+\rho^2\sigma^2_U + \sigma^2_{\epsilon} &amp;
                                              (1+\theta^2)\sigma^2_{\mu}+\rho^2\sigma^2_{U} +\sigma^2_{\epsilon} + \sigma^2_{\eta} &amp;
                                              (1+\theta+\gamma)\sigma^2_{\mu}+\rho\sigma^2_U+\rho_{\eta,\omega}\sigma^2_{\eta}\sigma^2_{\omega} \\
                                              (1+\gamma)\sigma^2_{\mu}+\rho\sigma^2_U &amp;
                                              (1+\theta+\gamma)\sigma^2_{\mu}+\rho\sigma^2_U+\rho_{\eta,\omega}\sigma^2_{\eta}\sigma^2_{\omega} &amp;
                                              (1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega} \\
                                              \end{array}
                                        \right)
\end{align*}\]</span></p>
<p>We now simply have to derive the mean outcomes and proportions of each type in the population in order to form the Wald estimator.
Let me first derive the joint distribution of the portential outcomes and the means and proportions of each type in the population.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="NE.html#cb139-1" tabindex="-1"></a>mean.y0.y1.yBV <span class="ot">&lt;-</span> <span class="fu">c</span>(param[<span class="st">&#39;barmu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;delta&#39;</span>],param[<span class="st">&#39;barmu&#39;</span>]<span class="sc">*</span>(<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;theta&#39;</span>])<span class="sc">+</span>param[<span class="st">&#39;delta&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;baralpha&#39;</span>],param[<span class="st">&#39;barmu&#39;</span>])</span>
<span id="cb139-2"><a href="NE.html#cb139-2" tabindex="-1"></a>cov.y0.y1.yBV <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rho&#39;</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2epsilon&#39;</span>],</span>
<span id="cb139-3"><a href="NE.html#cb139-3" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;theta&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rho&#39;</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2epsilon&#39;</span>],</span>
<span id="cb139-4"><a href="NE.html#cb139-4" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rho&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2U&#39;</span>],</span>
<span id="cb139-5"><a href="NE.html#cb139-5" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;theta&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rho&#39;</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2epsilon&#39;</span>],</span>
<span id="cb139-6"><a href="NE.html#cb139-6" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;theta&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rho&#39;</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2epsilon&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2eta&#39;</span>],</span>
<span id="cb139-7"><a href="NE.html#cb139-7" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;theta&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rho&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rhoetaomega&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2eta&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2omega&#39;</span>],</span>
<span id="cb139-8"><a href="NE.html#cb139-8" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rho&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2U&#39;</span>],</span>
<span id="cb139-9"><a href="NE.html#cb139-9" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;theta&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rho&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rhoetaomega&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2eta&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2omega&#39;</span>],</span>
<span id="cb139-10"><a href="NE.html#cb139-10" tabindex="-1"></a>                          (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>]),<span class="dv">3</span>,<span class="dv">3</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb139-11"><a href="NE.html#cb139-11" tabindex="-1"></a></span>
<span id="cb139-12"><a href="NE.html#cb139-12" tabindex="-1"></a><span class="co"># cuts</span></span>
<span id="cb139-13"><a href="NE.html#cb139-13" tabindex="-1"></a><span class="co">#always takers</span></span>
<span id="cb139-14"><a href="NE.html#cb139-14" tabindex="-1"></a>lower.cut.at <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="sc">-</span><span class="cn">Inf</span>,<span class="sc">-</span><span class="cn">Inf</span>)</span>
<span id="cb139-15"><a href="NE.html#cb139-15" tabindex="-1"></a>upper.cut.at <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))</span>
<span id="cb139-16"><a href="NE.html#cb139-16" tabindex="-1"></a><span class="co"># compliers</span></span>
<span id="cb139-17"><a href="NE.html#cb139-17" tabindex="-1"></a>lower.cut.comp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="sc">-</span><span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))</span>
<span id="cb139-18"><a href="NE.html#cb139-18" tabindex="-1"></a>upper.cut.comp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>])</span>
<span id="cb139-19"><a href="NE.html#cb139-19" tabindex="-1"></a><span class="co"># never takers</span></span>
<span id="cb139-20"><a href="NE.html#cb139-20" tabindex="-1"></a>lower.cut.nt <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="sc">-</span><span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>])</span>
<span id="cb139-21"><a href="NE.html#cb139-21" tabindex="-1"></a>upper.cut.nt <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="cn">Inf</span>,<span class="cn">Inf</span>)</span>
<span id="cb139-22"><a href="NE.html#cb139-22" tabindex="-1"></a></span>
<span id="cb139-23"><a href="NE.html#cb139-23" tabindex="-1"></a><span class="co"># means by types</span></span>
<span id="cb139-24"><a href="NE.html#cb139-24" tabindex="-1"></a><span class="co">#always takers</span></span>
<span id="cb139-25"><a href="NE.html#cb139-25" tabindex="-1"></a>mean.y1.at.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV,<span class="at">lower=</span>lower.cut.at,<span class="at">upper=</span>upper.cut.at,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">2</span>]]</span>
<span id="cb139-26"><a href="NE.html#cb139-26" tabindex="-1"></a>mean.y0.at.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV,<span class="at">lower=</span>lower.cut.at,<span class="at">upper=</span>upper.cut.at,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</span>
<span id="cb139-27"><a href="NE.html#cb139-27" tabindex="-1"></a><span class="co"># never takers</span></span>
<span id="cb139-28"><a href="NE.html#cb139-28" tabindex="-1"></a>mean.y1.nt.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV,<span class="at">lower=</span>lower.cut.nt,<span class="at">upper=</span>upper.cut.nt,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">2</span>]]</span>
<span id="cb139-29"><a href="NE.html#cb139-29" tabindex="-1"></a>mean.y0.nt.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV,<span class="at">lower=</span>lower.cut.nt,<span class="at">upper=</span>upper.cut.nt,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</span>
<span id="cb139-30"><a href="NE.html#cb139-30" tabindex="-1"></a><span class="co">#compliers</span></span>
<span id="cb139-31"><a href="NE.html#cb139-31" tabindex="-1"></a>mean.y1.comp.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV,<span class="at">lower=</span>lower.cut.comp,<span class="at">upper=</span>upper.cut.comp,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">2</span>]]</span>
<span id="cb139-32"><a href="NE.html#cb139-32" tabindex="-1"></a>mean.y0.comp.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV,<span class="at">lower=</span>lower.cut.comp,<span class="at">upper=</span>upper.cut.comp,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</span>
<span id="cb139-33"><a href="NE.html#cb139-33" tabindex="-1"></a></span>
<span id="cb139-34"><a href="NE.html#cb139-34" tabindex="-1"></a><span class="co"># Proportion of each types</span></span>
<span id="cb139-35"><a href="NE.html#cb139-35" tabindex="-1"></a><span class="co"># always takers</span></span>
<span id="cb139-36"><a href="NE.html#cb139-36" tabindex="-1"></a>prop.at.pop <span class="ot">&lt;-</span> <span class="fu">ptmvnorm.marginal</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]),<span class="at">n=</span><span class="dv">3</span>,<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV)[[<span class="dv">1</span>]]</span>
<span id="cb139-37"><a href="NE.html#cb139-37" tabindex="-1"></a><span class="co"># never takers</span></span>
<span id="cb139-38"><a href="NE.html#cb139-38" tabindex="-1"></a>prop.nt.pop <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">ptmvnorm.marginal</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>],<span class="at">n=</span><span class="dv">3</span>,<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV)[[<span class="dv">1</span>]]</span>
<span id="cb139-39"><a href="NE.html#cb139-39" tabindex="-1"></a><span class="co"># compliers</span></span>
<span id="cb139-40"><a href="NE.html#cb139-40" tabindex="-1"></a>prop.comp.pop <span class="ot">&lt;-</span> <span class="fu">ptmvnorm.marginal</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>param[<span class="st">&#39;barkappa&#39;</span>],<span class="at">n=</span><span class="dv">3</span>,<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV)[[<span class="dv">1</span>]]<span class="sc">-</span><span class="fu">ptmvnorm.marginal</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]),<span class="at">n=</span><span class="dv">3</span>,<span class="at">mean=</span>mean.y0.y1.yBV,<span class="at">sigma=</span>cov.y0.y1.yBV)[[<span class="dv">1</span>]]</span>
<span id="cb139-41"><a href="NE.html#cb139-41" tabindex="-1"></a></span>
<span id="cb139-42"><a href="NE.html#cb139-42" tabindex="-1"></a><span class="co"># LATE</span></span>
<span id="cb139-43"><a href="NE.html#cb139-43" tabindex="-1"></a>late.pop <span class="ot">&lt;-</span> mean.y1.comp.pop<span class="sc">-</span>mean.y0.comp.pop</span>
<span id="cb139-44"><a href="NE.html#cb139-44" tabindex="-1"></a>late.prop.comp.pop <span class="ot">&lt;-</span> late.pop<span class="sc">*</span>prop.comp.pop</span>
<span id="cb139-45"><a href="NE.html#cb139-45" tabindex="-1"></a><span class="co"># Wald</span></span>
<span id="cb139-46"><a href="NE.html#cb139-46" tabindex="-1"></a>num.Wald.pop <span class="ot">&lt;-</span> (mean.y1.comp.pop<span class="sc">*</span>prop.comp.pop<span class="sc">+</span>mean.y1.at.pop<span class="sc">*</span>prop.at.pop<span class="sc">+</span>mean.y0.nt.pop<span class="sc">*</span>prop.nt.pop<span class="sc">-</span>(mean.y0.comp.pop<span class="sc">*</span>prop.comp.pop<span class="sc">+</span>mean.y1.at.pop<span class="sc">*</span>prop.at.pop<span class="sc">+</span>mean.y0.nt.pop<span class="sc">*</span>prop.nt.pop))</span>
<span id="cb139-47"><a href="NE.html#cb139-47" tabindex="-1"></a>denom.Wald.pop <span class="ot">&lt;-</span> (prop.at.pop<span class="sc">+</span>prop.comp.pop<span class="sc">-</span>prop.at.pop)</span>
<span id="cb139-48"><a href="NE.html#cb139-48" tabindex="-1"></a>Wald.pop <span class="ot">&lt;-</span> num.Wald.pop<span class="sc">/</span>denom.Wald.pop</span></code></pre></div>
<p>We are now equipped to compute the Wald estimator in the population.
Before that, let us compute the LATE.
We have <span class="math inline">\(\Delta^Y_{LATE} =\)</span> 0.179.
The Wald estimator is equal to <span class="math inline">\(\Delta^Y_{Wald} =\)</span> 0.179.
They are obviously equal.
This is because the numerator of the Wald is equal to the product of the LATE multiplied by the proportion of compliers (which is equal to 0.066).
This is because the outcomes of never takers and always takers cancel out on each separate term of the numerator of the Wald estimator.
Indeed, we have that the numerator of the Wald estimator is equal to: 0.066.</p>
</div>
</div>
<div id="estimation" class="section level3 hasAnchor" number="4.1.3">
<h3><span class="header-section-number">4.1.3</span> Estimation<a href="NE.html#estimation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Estimation of the LATE under the IV assumptions closely follows the same steps that we have delineated in Section <a href="RCT.html#IVRCT">3.4.2</a>:</p>
<ol style="list-style-type: decimal">
<li><strong>First stage</strong> regression of <span class="math inline">\(D_i\)</span> on <span class="math inline">\(Z_i\)</span>: this estimates the impact of the instrument on participation into the program and estimates the proportion of compliers.</li>
<li><strong>Reduced form</strong> regression of <span class="math inline">\(Y_i\)</span> on <span class="math inline">\(Z_i\)</span>: this estimates the impact of the instrument on outcomes, <em>a.k.a</em> the ITE.</li>
<li><strong>Structural</strong> regression of <span class="math inline">\(Y_i\)</span> on <span class="math inline">\(D_i\)</span> using <span class="math inline">\(Z_i\)</span> as an instrument, which estimates the LATE.</li>
</ol>
<p>Let’s take these three steps in turn.</p>
<div id="first-stage-regression" class="section level4 hasAnchor" number="4.1.3.1">
<h4><span class="header-section-number">4.1.3.1</span> First stage regression<a href="NE.html#first-stage-regression" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The first stage regression regresses <span class="math inline">\(D_i\)</span> on <span class="math inline">\(Z_i\)</span> and thus estimates the impact of the instrument on treatment participation, which is equal to the proportion of compliers.
It can be run using the With/Without estimator or OLS (both are numerically equivalent as Lemma <a href="proofs.html#lem:WWOLS">A.3</a> shows) or OLS conditioning on observed covariates.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-158" class="example"><strong>Example 4.9  </strong></span>Let’s see how these three approaches fare in our example.</p>
</div>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="NE.html#cb140-1" tabindex="-1"></a><span class="co"># WW first stage</span></span>
<span id="cb140-2"><a href="NE.html#cb140-2" tabindex="-1"></a>WW.First.Stage.IV <span class="ot">&lt;-</span> <span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb140-3"><a href="NE.html#cb140-3" tabindex="-1"></a><span class="co"># Simple OLS</span></span>
<span id="cb140-4"><a href="NE.html#cb140-4" tabindex="-1"></a>OLS.D.Z.IV <span class="ot">&lt;-</span> <span class="fu">lm</span>(Ds<span class="sc">~</span>Z)</span>
<span id="cb140-5"><a href="NE.html#cb140-5" tabindex="-1"></a>OLS.First.Stage.IV <span class="ot">&lt;-</span> <span class="fu">coef</span>(OLS.D.Z.IV)[[<span class="dv">2</span>]]</span>
<span id="cb140-6"><a href="NE.html#cb140-6" tabindex="-1"></a><span class="co"># OLS conditioning on yB</span></span>
<span id="cb140-7"><a href="NE.html#cb140-7" tabindex="-1"></a>OLS.D.Z.yB.IV <span class="ot">&lt;-</span> <span class="fu">lm</span>(Ds<span class="sc">~</span>Z<span class="sc">+</span>yB)</span>
<span id="cb140-8"><a href="NE.html#cb140-8" tabindex="-1"></a>OLSX.First.Stage.IV <span class="ot">&lt;-</span> <span class="fu">coef</span>(OLS.D.Z.yB.IV)[[<span class="dv">2</span>]]</span></code></pre></div>
<p>The WW estimator of the first stage impact of <span class="math inline">\(Z_i\)</span> on <span class="math inline">\(D_i\)</span> is equal to 0.374.
The OLS estimator of the first stage impact of <span class="math inline">\(Z_i\)</span> on <span class="math inline">\(D_i\)</span> is equal to 0.374.
The OLS estimator of the first stage impact of <span class="math inline">\(Z_i\)</span> on <span class="math inline">\(D_i\)</span> conditioning on <span class="math inline">\(y^B_i\)</span> is equal to 0.339.
Remember that the true proportion of compliers in the population in our model is equal to 0.366.</p>
</div>
<div id="reduced-form-regression-1" class="section level4 hasAnchor" number="4.1.3.2">
<h4><span class="header-section-number">4.1.3.2</span> Reduced form regression<a href="NE.html#reduced-form-regression-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The reduced form regression regresses <span class="math inline">\(Y_i\)</span> on <span class="math inline">\(Z_i\)</span> and thus estimates the impact of the instrument on outcomes, which is equal to the ITE.
It can be run using the With/Without estimator or OLS (both are numerically equivalent as Lemma <a href="proofs.html#lem:WWOLS">A.3</a> shows) or OLS conditioning on observed covariates.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-159" class="example"><strong>Example 4.10  </strong></span>Let’s see how these three approaches fare in our example.</p>
</div>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="NE.html#cb141-1" tabindex="-1"></a><span class="co"># WW reduced form</span></span>
<span id="cb141-2"><a href="NE.html#cb141-2" tabindex="-1"></a>WW.Reduced.Form.IV <span class="ot">&lt;-</span> <span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb141-3"><a href="NE.html#cb141-3" tabindex="-1"></a><span class="co"># Simple OLS</span></span>
<span id="cb141-4"><a href="NE.html#cb141-4" tabindex="-1"></a>OLS.y.Z.IV <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>Z)</span>
<span id="cb141-5"><a href="NE.html#cb141-5" tabindex="-1"></a>OLS.Reduced.Form.IV <span class="ot">&lt;-</span> <span class="fu">coef</span>(OLS.y.Z.IV)[[<span class="dv">2</span>]]</span>
<span id="cb141-6"><a href="NE.html#cb141-6" tabindex="-1"></a><span class="co"># OLS conditioning on yB</span></span>
<span id="cb141-7"><a href="NE.html#cb141-7" tabindex="-1"></a>OLS.y.Z.yB.IV <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>Z<span class="sc">+</span>yB)</span>
<span id="cb141-8"><a href="NE.html#cb141-8" tabindex="-1"></a>OLSX.Reduced.Form.IV <span class="ot">&lt;-</span> <span class="fu">coef</span>(OLS.y.Z.yB.IV)[[<span class="dv">2</span>]]</span></code></pre></div>
<p>The WW estimator of the reduced form impact of <span class="math inline">\(Z_i\)</span> on <span class="math inline">\(y_i\)</span> is equal to -0.029.
The OLS estimator of the reduced form impact of <span class="math inline">\(Z_i\)</span> on <span class="math inline">\(y_i\)</span> is equal to -0.029.
The OLS estimator of the reduced form impact of <span class="math inline">\(Z_i\)</span> on <span class="math inline">\(y_i\)</span> conditioning on <span class="math inline">\(y^B_i\)</span> is equal to 0.058.
Remember that the true ITE in the population in our model is equal to 0.066.</p>
</div>
<div id="structural-regression-1" class="section level4 hasAnchor" number="4.1.3.3">
<h4><span class="header-section-number">4.1.3.3</span> Structural regression<a href="NE.html#structural-regression-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The final step of the analysis is to estimate the impact of <span class="math inline">\(D_i\)</span> on <span class="math inline">\(Y_i\)</span> using <span class="math inline">\(Z_i\)</span> as an instrument.
This can be done either by directly using the Wald estimator, by dividing the estimate of the reduced form by the result of the first stage, or by directly using the IV estimator (which is equivalent to the Wald estimator as Theorem <a href="RCT.html#thm:WaldIV">3.15</a> shows) or the IV estimator conditional on covariates.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-160" class="example"><strong>Example 4.11  </strong></span>Let’s see how these four approaches fare in our example.</p>
</div>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="NE.html#cb142-1" tabindex="-1"></a><span class="co"># Wald structural form</span></span>
<span id="cb142-2"><a href="NE.html#cb142-2" tabindex="-1"></a>Wald.Structural.Form.IV <span class="ot">&lt;-</span> (<span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">0</span>]))<span class="sc">/</span>(<span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb142-3"><a href="NE.html#cb142-3" tabindex="-1"></a><span class="co"># Simple IV</span></span>
<span id="cb142-4"><a href="NE.html#cb142-4" tabindex="-1"></a>TSLS.y.D.Z.IV <span class="ot">&lt;-</span> <span class="fu">ivreg</span>(y<span class="sc">~</span>Ds<span class="sc">|</span>Z)</span>
<span id="cb142-5"><a href="NE.html#cb142-5" tabindex="-1"></a>TSLS.Structural.Form.IV <span class="ot">&lt;-</span> <span class="fu">coef</span>(TSLS.y.D.Z.IV)[[<span class="dv">2</span>]]</span>
<span id="cb142-6"><a href="NE.html#cb142-6" tabindex="-1"></a><span class="co"># IV conditioning on yB</span></span>
<span id="cb142-7"><a href="NE.html#cb142-7" tabindex="-1"></a>TSLS.y.D.Z.yB.IV <span class="ot">&lt;-</span> <span class="fu">ivreg</span>(y<span class="sc">~</span>Ds<span class="sc">+</span>yB<span class="sc">|</span>Z<span class="sc">+</span>yB)</span>
<span id="cb142-8"><a href="NE.html#cb142-8" tabindex="-1"></a>TSLSX.Structural.Form.IV <span class="ot">&lt;-</span> <span class="fu">coef</span>(TSLS.y.D.Z.yB.IV)[[<span class="dv">2</span>]]</span></code></pre></div>
<p>The Wald estimator of the LATE is equal to <span class="math inline">\(\hat{\Delta}_{Wald}^{y}=\)</span> -0.078.
The IV estimator of the LATE is equal to <span class="math inline">\(\hat{\Delta}_{IV}^{y}=\)</span> -0.078, and is numerically identical to the Wald estimator, as expected.
The IV estimator of the LATE conditioning on <span class="math inline">\(y_i^B\)</span> is equal to 0.172.
Remember that the true LATE in the population in our model is equal to 0.179.</p>
<div class="remark">
<p><span id="unlabeled-div-87" class="remark"><em>Remark</em>. </span>The last thing we might want to check is what the sampling noise of the IV estimator looks like and whether it is reduced by conditioning on observed covariates.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-162" class="example"><strong>Example 4.12  </strong></span>Let’s see how sampling noise moves in our example.</p>
</div>
<p><strong>Do it</strong></p>
</div>
</div>
<div id="estimation-of-sampling-noise" class="section level3 hasAnchor" number="4.1.4">
<h3><span class="header-section-number">4.1.4</span> Estimation of sampling noise<a href="NE.html#estimation-of-sampling-noise" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="remark">
<p><span id="unlabeled-div-88" class="remark"><em>Remark</em>. </span>The framework we have seen here as been extended to multivalued instruments or treatments by several papers.
<a href="https://www.jstor.org/stable/2951620">Imbens and Angrist (1994)</a> extend the framework to an ordered instrument.
They show that the 2SLS estimator is a weighted average of LATEs for each values of the instrument, with positive weights summing to one.
<a href="https://www.tandfonline.com/doi/abs/10.1080/01621459.1995.10476535">Angrist and Imbens (1995)</a> extend the framework to he case where the treatment is an ordered discrete variable and there are multiple dichotomous instruments.
They again show that the 2SLS estimator is a weighted average of LATEs with positive weights summing to one.
<a href="https://www.pnas.org/content/96/8/4730">Heckman and Vytlacil (1999)</a> extend the framework to a case with a continuous instrument and show that one can the define a Marginal Treatment Effect (or MTE) that is equal to the effect of the treatment on individuals that have the same unobserved propensity to take the treatment.
They show that the MTE can be identified by a limiting form of Wald estimator that they call a Local Instrumental Variable estimator.
They also show that average treatment effect parameters such as TT, ATE and LATE are all weighted averages of the MTE, with positive weights summing to one.
Under strong support conditions on the side of the instrument, one can thus in principle recover all treatment effect parameters with a continuous instrument.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-89" class="remark"><em>Remark</em>. </span>One important concern with the first stage regression is that of weak instruments.
When Assumption <a href="NE.html#hyp:FirstStage">4.1</a> does not hold and the impact on the instrument on take up is actually zero in the population, the Wald estimator is not well-defined.</p>
</div>
<p><strong>Expand</strong></p>
</div>
</div>
<div id="regression-discontinuity-designs" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Regression Discontinuity Designs<a href="NE.html#regression-discontinuity-designs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Regression Discontinuity Designs emerge in situations where there is a discontinuity in the probability of receiving the treatment.
If there is also a discontinuity in outcomes, it is interpreted as the effect of the treatment.
We distinguish two RD Designs:</p>
<ul>
<li>Sharp Designs (the probability of receiving the treatment moves from 0 to 1 at the discontinuity,</li>
<li>Fuzzy Designs (the probability of receiving the treatment moves from values strictly between 0 and 1 at the discontinuity.</li>
</ul>
<p>Let’s examine both of these configurations in turn.</p>
<div id="sharp-regression-discontinuity-designs" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Sharp Regression Discontinuity Designs<a href="NE.html#sharp-regression-discontinuity-designs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In Sharp Regression Discontinuity Designs, the following condition holds:</p>
<div class="hypothesis">
<p><span id="hyp:SharpRDD" class="hypothesis"><strong>Hypothesis 4.7  (Sharp RDD Design) </strong></span>There exists a running variable <span class="math inline">\(Z_i\)</span> and a threshold <span class="math inline">\(\bar{z}\)</span> such that:</p>
<p><span class="math display">\[\begin{align*}
  D_i=\uns{Z_i\leq\bar{z}}.
\end{align*}\]</span></p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-165" class="example"><strong>Example 4.13  </strong></span>Let us illustrate this assumption in our example (it is easy since our basic selection rule has a discontinuous feature).</p>
</div>
<p>Let’s first choose parameter values and compute a function for the TT parameter:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="NE.html#cb143-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>)</span>
<span id="cb143-2"><a href="NE.html#cb143-2" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,<span class="st">&quot;theta&quot;</span>,<span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;baralpha&quot;</span>)</span>
<span id="cb143-3"><a href="NE.html#cb143-3" tabindex="-1"></a>delta.y.tt <span class="ot">&lt;-</span> <span class="cf">function</span>(param){</span>
<span id="cb143-4"><a href="NE.html#cb143-4" tabindex="-1"></a>  <span class="fu">return</span>(param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;barmu&quot;</span>]<span class="sc">-</span>param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>((param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">*</span><span class="fu">dnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]))))<span class="sc">/</span>(<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>])<span class="sc">*</span><span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">/</span>(<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]))))))</span>
<span id="cb143-5"><a href="NE.html#cb143-5" tabindex="-1"></a>}</span></code></pre></div>
<p>Let us now simulate the data:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="NE.html#cb144-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb144-2"><a href="NE.html#cb144-2" tabindex="-1"></a>N <span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb144-3"><a href="NE.html#cb144-3" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb144-4"><a href="NE.html#cb144-4" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb144-5"><a href="NE.html#cb144-5" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb144-6"><a href="NE.html#cb144-6" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb144-7"><a href="NE.html#cb144-7" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb144-8"><a href="NE.html#cb144-8" tabindex="-1"></a>Ds[YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb144-9"><a href="NE.html#cb144-9" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb144-10"><a href="NE.html#cb144-10" tabindex="-1"></a>eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb144-11"><a href="NE.html#cb144-11" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb144-12"><a href="NE.html#cb144-12" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb144-13"><a href="NE.html#cb144-13" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb144-14"><a href="NE.html#cb144-14" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb144-15"><a href="NE.html#cb144-15" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb144-16"><a href="NE.html#cb144-16" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb144-17"><a href="NE.html#cb144-17" tabindex="-1"></a>y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb144-18"><a href="NE.html#cb144-18" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span></code></pre></div>
<p>Let us now illustrate the resulting dataset:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="NE.html#cb145-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">5</span>))</span>
<span id="cb145-2"><a href="NE.html#cb145-2" tabindex="-1"></a><span class="fu">plot</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y0[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&quot;yB&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb145-3"><a href="NE.html#cb145-3" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">3</span>,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>)</span>
<span id="cb145-4"><a href="NE.html#cb145-4" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb145-5"><a href="NE.html#cb145-5" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">5</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>))),<span class="at">pos=</span><span class="fu">c</span>(<span class="dv">2</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;red&#39;</span>))</span>
<span id="cb145-6"><a href="NE.html#cb145-6" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="fl">10.5</span>,<span class="fu">c</span>(<span class="st">&#39;y0|D=0&#39;</span>,<span class="st">&#39;y1|D=1&#39;</span>,<span class="st">&#39;D&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;blue&#39;</span>,<span class="st">&#39;red&#39;</span>),<span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb145-7"><a href="NE.html#cb145-7" tabindex="-1"></a><span class="fu">par</span>(<span class="at">new=</span><span class="cn">TRUE</span>)</span>
<span id="cb145-8"><a href="NE.html#cb145-8" tabindex="-1"></a><span class="fu">plot</span>(yB,Ds,<span class="at">pch=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">&#39;red&#39;</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xaxt=</span><span class="st">&quot;n&quot;</span>,<span class="at">yaxt=</span><span class="st">&quot;n&quot;</span>,<span class="at">xlab=</span><span class="st">&quot;&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb145-9"><a href="NE.html#cb145-9" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">4</span>)</span>
<span id="cb145-10"><a href="NE.html#cb145-10" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">&quot;D&quot;</span>,<span class="at">side=</span><span class="dv">4</span>,<span class="at">line=</span><span class="dv">3</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotSharpRDD"></span>
<img src="STCI_files/figure-html/PlotSharpRDD-1.png" alt="Sharp RDD Design" width="65%" />
<p class="caption">
Figure 4.5: Sharp RDD Design
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotSharpRDD">4.5</a> shows that there is a sharp decrease in treatment intake when moving above <span class="math inline">\(y_i^B=\bar{y}\)</span>.</p>
<div id="identification-5" class="section level4 hasAnchor" number="4.2.1.1">
<h4><span class="header-section-number">4.2.1.1</span> Identification<a href="NE.html#identification-5" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The main assumption we need on top of Assumption <a href="NE.html#hyp:SharpRDD">4.7</a> is that outcomes are continuous around the threshold:</p>
<div class="hypothesis">
<p><span id="hyp:ContinuousOutcomes" class="hypothesis"><strong>Hypothesis 4.8  (Continuity of Expected Potential Outcomes) </strong></span>For <span class="math inline">\(d\in\left\{0,1\right\}\)</span>,</p>
<p><span class="math display">\[\begin{align*}
  \lim_{e\rightarrow 0^{+}}\esp{Y_i^d|Z_i=\bar{z}-e} &amp; = \lim_{e\rightarrow 0^{+}}\esp{Y_i^d|Z_i=\bar{z}+e}.
\end{align*}\]</span></p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-166" class="example"><strong>Example 4.14  </strong></span>Let us see how this assumption works in our example.</p>
</div>
<p>We are going to use a linear conditional expectation to link <span class="math inline">\(y^d_i\)</span> and <span class="math inline">\(y_i^B\)</span>, which is consistent since they are jointly normally distributed in our example.
We fit the linear conditional expectation using OLS.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="NE.html#cb146-1" tabindex="-1"></a>reg.ols<span class="fl">.00</span> <span class="ot">&lt;-</span> <span class="fu">lm</span>(y0[Ds<span class="sc">==</span><span class="dv">0</span>]<span class="sc">~</span>yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb146-2"><a href="NE.html#cb146-2" tabindex="-1"></a>reg.ols<span class="fl">.01</span> <span class="ot">&lt;-</span> <span class="fu">lm</span>(y0[Ds<span class="sc">==</span><span class="dv">1</span>]<span class="sc">~</span>yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb146-3"><a href="NE.html#cb146-3" tabindex="-1"></a>reg.ols<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">lm</span>(y1[Ds<span class="sc">==</span><span class="dv">0</span>]<span class="sc">~</span>yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb146-4"><a href="NE.html#cb146-4" tabindex="-1"></a>reg.ols<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">lm</span>(y1[Ds<span class="sc">==</span><span class="dv">1</span>]<span class="sc">~</span>yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span></code></pre></div>
<p>Let us now illustrate how these expectations look.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="NE.html#cb147-1" tabindex="-1"></a><span class="co"># plot for y1</span></span>
<span id="cb147-2"><a href="NE.html#cb147-2" tabindex="-1"></a><span class="fu">plot</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y1[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">3</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">col=</span><span class="st">&#39;red&#39;</span>,<span class="at">xlab=</span><span class="st">&quot;yB&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb147-3"><a href="NE.html#cb147-3" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y1[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb147-4"><a href="NE.html#cb147-4" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],reg.ols<span class="fl">.10</span><span class="sc">$</span>fitted.values,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb147-5"><a href="NE.html#cb147-5" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],reg.ols<span class="fl">.11</span><span class="sc">$</span>fitted.values,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb147-6"><a href="NE.html#cb147-6" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb147-7"><a href="NE.html#cb147-7" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">5</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>))),<span class="at">pos=</span><span class="fu">c</span>(<span class="dv">2</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;red&#39;</span>))</span>
<span id="cb147-8"><a href="NE.html#cb147-8" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="dv">11</span>,<span class="fu">c</span>(<span class="st">&#39;y1|D=0&#39;</span>,<span class="st">&#39;y1|D=1&#39;</span>,<span class="st">&#39;E[y1|yB]&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;red&#39;</span>,<span class="st">&#39;black&#39;</span>,<span class="st">&#39;blue&#39;</span>),<span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb147-9"><a href="NE.html#cb147-9" tabindex="-1"></a></span>
<span id="cb147-10"><a href="NE.html#cb147-10" tabindex="-1"></a><span class="co"># plot for y0</span></span>
<span id="cb147-11"><a href="NE.html#cb147-11" tabindex="-1"></a><span class="fu">plot</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y0[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">col=</span><span class="st">&#39;black&#39;</span>,<span class="at">xlab=</span><span class="st">&quot;yB&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb147-12"><a href="NE.html#cb147-12" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y0[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb147-13"><a href="NE.html#cb147-13" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],reg.ols<span class="fl">.00</span><span class="sc">$</span>fitted.values,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">1</span>)</span>
<span id="cb147-14"><a href="NE.html#cb147-14" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],reg.ols<span class="fl">.01</span><span class="sc">$</span>fitted.values,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">1</span>)</span>
<span id="cb147-15"><a href="NE.html#cb147-15" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb147-16"><a href="NE.html#cb147-16" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">5</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>))),<span class="at">pos=</span><span class="fu">c</span>(<span class="dv">2</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;red&#39;</span>))</span>
<span id="cb147-17"><a href="NE.html#cb147-17" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="dv">11</span>,<span class="fu">c</span>(<span class="st">&#39;y0|D=0&#39;</span>,<span class="st">&#39;y0|D=1&#39;</span>,<span class="st">&#39;E[y0|yB]&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;red&#39;</span>,<span class="st">&#39;blue&#39;</span>),<span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotContinuousRDD"></span>
<img src="STCI_files/figure-html/PlotContinuousRDD-1.png" alt="Continuity of potential outcomes" width="45%" /><img src="STCI_files/figure-html/PlotContinuousRDD-2.png" alt="Continuity of potential outcomes" width="45%" />
<p class="caption">
Figure 4.6: Continuity of potential outcomes
</p>
</div>
<p>As we can see on Figure <a href="NE.html#fig:PlotContinuousRDD">4.6</a>, at <span class="math inline">\(\bar{y}\)</span>, both <span class="math inline">\(\esp{y_i^1|y_i^B=y}\)</span> and <span class="math inline">\(\esp{y_i^0|y_i^B=y}\)</span> are continuous.</p>
<p>Under Assumptions <a href="NE.html#hyp:SharpRDD">4.7</a> and <a href="NE.html#hyp:ContinuousOutcomes">4.8</a>, we can prove identification of a local versino of the Treatment on the Treated parameter:</p>
<div class="theorem">
<p><span id="thm:IdentSharpRDD" class="theorem"><strong>Theorem 4.4  (Identification in a Sharp RDD Design) </strong></span>Under Assumptions <a href="NE.html#hyp:SharpRDD">4.7</a> and <a href="NE.html#hyp:ContinuousOutcomes">4.8</a>, the Treatment Effect on the Treated is identified at <span class="math inline">\(Z_i=\bar{z}\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\Delta^Y_{TT}(\bar{z}) &amp; = \lim_{e\rightarrow 0^{+}}\esp{Y_i|Z_i=\bar{z}-e}-\lim_{e\rightarrow 0^{+}}\esp{Y_i|Z_i=\bar{z}+e},
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\Delta^Y_{TT}(\bar{z})=\esp{\Delta^Y_i|Z_i=\bar{z}}\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-90" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
\lim_{e\rightarrow 0^{+}}\esp{Y_i|Z_i=\bar{z}-e} -\lim_{e\rightarrow 0^{+}}\esp{Y_i|Z_i=\bar{z}+e}
  &amp; = \lim_{e\rightarrow 0^{+}}\esp{Y^1_i|Z_i=\bar{z}-e} -\lim_{e\rightarrow 0^{+}}\esp{Y^0_i|Z_i=\bar{z}+e} \\
  &amp; = \esp{Y^1_i|Z_i=\bar{z}} - \esp{Y^0_i|Z_i=\bar{z}} \\
  &amp; = \esp{Y^1_i-Y^0_i|Z_i=\bar{z}} \\
  &amp; = \Delta^Y_{TT}(\bar{z}),
\end{align*}\]</span></p>
<p>where the first equality uses Assumption <a href="NE.html#hyp:SharpRDD">4.7</a> and the second equality uses Assumption <a href="NE.html#hyp:ContinuousOutcomes">4.8</a>.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-168" class="example"><strong>Example 4.15  </strong></span>Let us try to illustrate how identification works in our numerical example.</p>
</div>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="NE.html#cb148-1" tabindex="-1"></a><span class="fu">plot</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&quot;yB&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb148-2"><a href="NE.html#cb148-2" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb148-3"><a href="NE.html#cb148-3" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],reg.ols<span class="fl">.00</span><span class="sc">$</span>fitted.values,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">1</span>)</span>
<span id="cb148-4"><a href="NE.html#cb148-4" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],reg.ols<span class="fl">.11</span><span class="sc">$</span>fitted.values,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb148-5"><a href="NE.html#cb148-5" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb148-6"><a href="NE.html#cb148-6" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">5</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>))),<span class="at">pos=</span><span class="fu">c</span>(<span class="dv">2</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>))</span>
<span id="cb148-7"><a href="NE.html#cb148-7" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="dv">11</span>,<span class="fu">c</span>(<span class="st">&#39;y0|D=0&#39;</span>,<span class="st">&#39;y1|D=1&#39;</span>,<span class="fu">expression</span>(<span class="fu">hat</span>(<span class="st">&#39;y0&#39;</span>)),<span class="fu">expression</span>(<span class="fu">hat</span>(<span class="st">&#39;y1&#39;</span>))),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;black&#39;</span>,<span class="st">&#39;blue&#39;</span>,<span class="st">&#39;blue&#39;</span>),<span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:IdentificationSharpOLS"></span>
<img src="STCI_files/figure-html/IdentificationSharpOLS-1.png" alt="Identification in a sharp RDD design" width="65%" />
<p class="caption">
Figure 4.7: Identification in a sharp RDD design
</p>
</div>
<p>On Figure <a href="NE.html#fig:IdentificationSharpOLS">4.7</a>, we can see a small decrease in the fitted lines just when we cross <span class="math inline">\(y_i=\bar{y}\)</span>.
This decrease is due to the positive effect of the treatment, since moving from above to below <span class="math inline">\(\bar{y}\)</span> swtiches the treatment on.</p>
</div>
<div id="estimation-in-a-sharp-rd-design" class="section level4 hasAnchor" number="4.2.1.2">
<h4><span class="header-section-number">4.2.1.2</span> Estimation in a Sharp RD Design<a href="NE.html#estimation-in-a-sharp-rd-design" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>For estimating the treatment effect in a Sharp RD Design, we can use OLS, if we are willing to assume that expected potential outcomes are a linear function of the running variable.
This is obviously a huge assumption.
In order to relax it, we can use non-parametric methods, and among them the ones that are unbiased when applied at a boundary of the parameter space.
The best method in that case is the Local Linear Regression.</p>
<div id="estimation-using-ols" class="section level5 hasAnchor" number="4.2.1.2.1">
<h5><span class="header-section-number">4.2.1.2.1</span> Estimation using OLS<a href="NE.html#estimation-using-ols" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Using OLS to estimate the treatment effect in a sharp RD Design works as follows.
We fit two linear models, one on the left and one on the right of the discontinuity:</p>
<p><span class="math display">\[\begin{align*}
  \esp{Y_i|D_i=1,Z_i=z} &amp; = \alpha_1+\beta_1z\\
  \esp{Y_i|D_i=0,Z_i=z} &amp; = \alpha_0+\beta_0z.
\end{align*}\]</span></p>
<p>We then estimate the treatment effect by taking the difference in predicted outcomes at <span class="math inline">\(Z_i=z\)</span>:</p>
<p><span class="math display">\[\begin{align*}
  \hat{\Delta}^Y_{TT}(z) &amp; = \hatesp{Y_i|D_i=1,Z_i=z}-\hatesp{Y_i|D_i=0,Z_i=z}\\
                        &amp; = \hat\alpha_1+\hat\beta_1z-\hat\alpha_0-\hat\beta_0z.
\end{align*}\]</span></p>
<div class="example">
<p><span id="exm:unnamed-chunk-169" class="example"><strong>Example 4.16  </strong></span>Let’s see how this works in our example.</p>
</div>
<p>First, we need to compute the predicted values and the value of our estimated parameter:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="NE.html#cb149-1" tabindex="-1"></a><span class="co"># Predicted values</span></span>
<span id="cb149-2"><a href="NE.html#cb149-2" tabindex="-1"></a>y0.bary.pred <span class="ot">&lt;-</span> reg.ols<span class="fl">.00</span><span class="sc">$</span>coef[[<span class="dv">1</span>]]<span class="sc">+</span>reg.ols<span class="fl">.00</span><span class="sc">$</span>coef[[<span class="dv">2</span>]]<span class="sc">*</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])</span>
<span id="cb149-3"><a href="NE.html#cb149-3" tabindex="-1"></a>y1.bary.pred <span class="ot">&lt;-</span> reg.ols<span class="fl">.11</span><span class="sc">$</span>coef[[<span class="dv">1</span>]]<span class="sc">+</span>reg.ols<span class="fl">.11</span><span class="sc">$</span>coef[[<span class="dv">2</span>]]<span class="sc">*</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])</span>
<span id="cb149-4"><a href="NE.html#cb149-4" tabindex="-1"></a><span class="co"># estimated treatment effect</span></span>
<span id="cb149-5"><a href="NE.html#cb149-5" tabindex="-1"></a>delta.y.rddols <span class="ot">&lt;-</span> y1.bary.pred<span class="sc">-</span>y0.bary.pred</span></code></pre></div>
<p>In order to be able to compare our estimate to the truth, let’s compute the true value of our target parameter:</p>
<p><span class="math display">\[\begin{align*}
\Delta^y_{TT}(\bar{z}) &amp; = \bar{\alpha} + \theta\bar{\mu}+\theta\frac{\sigma^2_{\mu}}{\sigma^2_{\mu}+\sigma^2_{U}}(\bar{y}-\bar{\mu}).
\end{align*}\]</span></p>
<p>Let’s write a function to compute this formula:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="NE.html#cb150-1" tabindex="-1"></a>delta.y.tt.z <span class="ot">&lt;-</span> <span class="cf">function</span>(param){</span>
<span id="cb150-2"><a href="NE.html#cb150-2" tabindex="-1"></a>  <span class="fu">return</span>(param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;barmu&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">*</span>param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">/</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb150-3"><a href="NE.html#cb150-3" tabindex="-1"></a>}</span>
<span id="cb150-4"><a href="NE.html#cb150-4" tabindex="-1"></a>delta.y.tt.z.pop <span class="ot">&lt;-</span> <span class="fu">delta.y.tt.z</span>(param)</span></code></pre></div>
<p>Our estimate of the treatment effect using OLS is thus 0.18 while the true value of our target parameter is 0.18.</p>
</div>
<div id="bias-of-the-ols-rdd-estimator-when-conditional-expectations-are-nonlinear" class="section level5 hasAnchor" number="4.2.1.2.2">
<h5><span class="header-section-number">4.2.1.2.2</span> Bias of the OLS RDD estimator when conditional expectations are nonlinear<a href="NE.html#bias-of-the-ols-rdd-estimator-when-conditional-expectations-are-nonlinear" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The problem with the OLS approach to implement the RDD estimator is that it is highly dependent on the assumption that the conditional expectation functions <span class="math inline">\(\esp{Y_i|D_i=d,Z_i=z}\)</span> are linear.
That might generate a strong functional form bias, as the following example shows.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-170" class="example"><strong>Example 4.17  </strong></span>Let’s simulate some data in order to visualize the issue with OLS when the conditional expectation functions are non linear.
In order to do that, we need to add some non linearity in the way potential outcomes are generated.
We choose to make the equation for <span class="math inline">\(y_i^0\)</span> nonlinear in <span class="math inline">\(y_i^B\)</span>:</p>
</div>
<p><span class="math display">\[\begin{align*}
  y_i^0 &amp; = \mu_i+\delta+U_i^0 +\gamma*(y_i^B-\bar{y_i^B})^2.
\end{align*}\]</span></p>
<p>Let’s choose some parameter values and simulate the data before seeing wht it looks like:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="NE.html#cb151-1" tabindex="-1"></a><span class="co"># parameters</span></span>
<span id="cb151-2"><a href="NE.html#cb151-2" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(param,<span class="fl">0.1</span>,<span class="fl">7.98</span>)</span>
<span id="cb151-3"><a href="NE.html#cb151-3" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,<span class="st">&quot;theta&quot;</span>,<span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;baralpha&quot;</span>,<span class="st">&quot;gamma&quot;</span>,<span class="st">&quot;baryB&quot;</span>)</span>
<span id="cb151-4"><a href="NE.html#cb151-4" tabindex="-1"></a></span>
<span id="cb151-5"><a href="NE.html#cb151-5" tabindex="-1"></a><span class="co"># simulations</span></span>
<span id="cb151-6"><a href="NE.html#cb151-6" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb151-7"><a href="NE.html#cb151-7" tabindex="-1"></a>N <span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb151-8"><a href="NE.html#cb151-8" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb151-9"><a href="NE.html#cb151-9" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb151-10"><a href="NE.html#cb151-10" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb151-11"><a href="NE.html#cb151-11" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb151-12"><a href="NE.html#cb151-12" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb151-13"><a href="NE.html#cb151-13" tabindex="-1"></a>Ds[YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb151-14"><a href="NE.html#cb151-14" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb151-15"><a href="NE.html#cb151-15" tabindex="-1"></a>eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb151-16"><a href="NE.html#cb151-16" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb151-17"><a href="NE.html#cb151-17" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>] <span class="sc">+</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(yB<span class="sc">-</span>param[<span class="st">&quot;baryB&quot;</span>])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb151-18"><a href="NE.html#cb151-18" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb151-19"><a href="NE.html#cb151-19" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb151-20"><a href="NE.html#cb151-20" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb151-21"><a href="NE.html#cb151-21" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb151-22"><a href="NE.html#cb151-22" tabindex="-1"></a>y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb151-23"><a href="NE.html#cb151-23" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb151-24"><a href="NE.html#cb151-24" tabindex="-1"></a></span>
<span id="cb151-25"><a href="NE.html#cb151-25" tabindex="-1"></a><span class="co"># linear regressions</span></span>
<span id="cb151-26"><a href="NE.html#cb151-26" tabindex="-1"></a>reg.ols<span class="fl">.00</span> <span class="ot">&lt;-</span> <span class="fu">lm</span>(y0[Ds<span class="sc">==</span><span class="dv">0</span>]<span class="sc">~</span>yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb151-27"><a href="NE.html#cb151-27" tabindex="-1"></a>reg.ols<span class="fl">.01</span> <span class="ot">&lt;-</span> <span class="fu">lm</span>(y0[Ds<span class="sc">==</span><span class="dv">1</span>]<span class="sc">~</span>yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb151-28"><a href="NE.html#cb151-28" tabindex="-1"></a>reg.ols<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">lm</span>(y1[Ds<span class="sc">==</span><span class="dv">0</span>]<span class="sc">~</span>yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb151-29"><a href="NE.html#cb151-29" tabindex="-1"></a>reg.ols<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">lm</span>(y1[Ds<span class="sc">==</span><span class="dv">1</span>]<span class="sc">~</span>yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb151-30"><a href="NE.html#cb151-30" tabindex="-1"></a></span>
<span id="cb151-31"><a href="NE.html#cb151-31" tabindex="-1"></a><span class="co"># predicted values and estimated treatment effect using lienar OLS</span></span>
<span id="cb151-32"><a href="NE.html#cb151-32" tabindex="-1"></a>y0.bary.pred <span class="ot">&lt;-</span> reg.ols<span class="fl">.00</span><span class="sc">$</span>coef[[<span class="dv">1</span>]]<span class="sc">+</span>reg.ols<span class="fl">.00</span><span class="sc">$</span>coef[[<span class="dv">2</span>]]<span class="sc">*</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])</span>
<span id="cb151-33"><a href="NE.html#cb151-33" tabindex="-1"></a>y1.bary.pred <span class="ot">&lt;-</span> reg.ols<span class="fl">.11</span><span class="sc">$</span>coef[[<span class="dv">1</span>]]<span class="sc">+</span>reg.ols<span class="fl">.11</span><span class="sc">$</span>coef[[<span class="dv">2</span>]]<span class="sc">*</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])</span>
<span id="cb151-34"><a href="NE.html#cb151-34" tabindex="-1"></a>delta.y.rddols <span class="ot">&lt;-</span> y1.bary.pred<span class="sc">-</span>y0.bary.pred</span></code></pre></div>
<p>Let’s take a look at the data now:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="NE.html#cb152-1" tabindex="-1"></a><span class="fu">plot</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y0[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&quot;yB&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb152-2"><a href="NE.html#cb152-2" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y1[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">3</span>,<span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb152-3"><a href="NE.html#cb152-3" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],reg.ols<span class="fl">.00</span><span class="sc">$</span>fitted.values,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">1</span>)</span>
<span id="cb152-4"><a href="NE.html#cb152-4" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],reg.ols<span class="fl">.11</span><span class="sc">$</span>fitted.values,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb152-5"><a href="NE.html#cb152-5" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb152-6"><a href="NE.html#cb152-6" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="dv">11</span>,<span class="fu">c</span>(<span class="st">&#39;y|D=0&#39;</span>,<span class="st">&#39;y|D=1&#39;</span>,<span class="fu">expression</span>(<span class="fu">hat</span>(<span class="st">&#39;y0&#39;</span>)),<span class="fu">expression</span>(<span class="fu">hat</span>(<span class="st">&#39;y1&#39;</span>))),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;black&#39;</span>,<span class="st">&#39;blue&#39;</span>,<span class="st">&#39;blue&#39;</span>),<span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotSharpRDDOLSNonlin"></span>
<img src="STCI_files/figure-html/PlotSharpRDDOLSNonlin-1.png" alt="OLS estimates of sharp RDD with non linear conditional expectations" width="65%" />
<p class="caption">
Figure 4.8: OLS estimates of sharp RDD with non linear conditional expectations
</p>
</div>
<p>Our estimate of the treatment effect using OLS is now 0.25 while the true value of our target parameter is still 0.18.
The reason wy the estimate is too large with respect to the truth is because the linear estimate of the conditional expectation <span class="math inline">\(\hatesp{y_i^0|y_i^B=\bar{y}}\)</span> is biased downwards: it should start curving upwards when approaching <span class="math inline">\(\bar{y}\)</span> but it does not, as we can see on Figure <a href="NE.html#fig:PlotSharpRDDOLSNonlin">4.8</a>.</p>
</div>
<div id="estimation-using-local-linear-regression" class="section level5 hasAnchor" number="4.2.1.2.3">
<h5><span class="header-section-number">4.2.1.2.3</span> Estimation using Local Linear Regression<a href="NE.html#estimation-using-local-linear-regression" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The reason the OLS RDD estimator fails when conditional expectations are nonlinear (as in Figure <a href="NE.html#fig:PlotSharpRDDOLSNonlin">4.8</a>) is because the OLS estimate of the conditional expectation function is mispecified.
What we need to replace OLS is an approach that is going to be well-specified under the assumption of continuous conditional expectations.
We also want an estimator that behaves well (for example, is not biased) when operating at a boundary: note that we try to predict the value of the two conditional expectation functions just at the point after which they stop being defined.
This second requirement is actually pretty harsh.</p>
<p>The most robust estimator that complies with these requirements is the Local Linear Regression estimator, or LLR.
It is a basically just weighted OLS but only applied locally within a tiny window around the prediction point, with weights decreasing as they get further away from the prediction point.
The weigths are generated by a kernel function.
Which exact kernel function is used does not matter much in practice.
What matters much more for LLR is the choice of the bandwidth, the width of the small window around the prediction point.
Cross-validation (a form of leave-one-out assessment of goodness of fit) is generally used to choose the optimal bandwidth.</p>
<p>In short, the LLR RDD estimator works as follows:</p>
<ul>
<li>Estimate <span class="math inline">\(\hatesp{Y^1_i|D_i=1,Z_i=\bar{z}}\)</span> using LLR on the treated side of the threshold.</li>
<li>Estimate <span class="math inline">\(\hatesp{Y_i^0|D_i=0,Z_i=\bar{z}}\)</span> using LLR on the untreated side of the threshold.</li>
<li><span class="math inline">\(\hat\Delta^{y}_{RDDLLR}=\hatesp{Y^1_i|D_i=1,Z_i=\bar{z}}-\hatesp{Y^0_i|D_i=0,Z_i=\bar{z}}\)</span>.</li>
<li>Bandwidth choice: use cross-validation on each side.</li>
</ul>
<div class="example">
<p><span id="exm:unnamed-chunk-171" class="example"><strong>Example 4.18  </strong></span>Let’s see how all of this works in our example.
First, let us code the LLR function and the cross validation function.</p>
</div>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="NE.html#cb153-1" tabindex="-1"></a>llr <span class="ot">&lt;-</span> <span class="cf">function</span>(y,x,gridx,bw,kernel){</span>
<span id="cb153-2"><a href="NE.html#cb153-2" tabindex="-1"></a>  <span class="cf">if</span> (kernel<span class="sc">==</span><span class="st">&#39;uniform&#39;</span>){</span>
<span id="cb153-3"><a href="NE.html#cb153-3" tabindex="-1"></a>    K <span class="ot">&lt;-</span> <span class="cf">function</span>(u){</span>
<span id="cb153-4"><a href="NE.html#cb153-4" tabindex="-1"></a>      K.u <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb153-5"><a href="NE.html#cb153-5" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">abs</span>(u)<span class="sc">&lt;=</span>.<span class="dv">5</span>){K.u <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb153-6"><a href="NE.html#cb153-6" tabindex="-1"></a>      <span class="fu">return</span>(K.u)</span>
<span id="cb153-7"><a href="NE.html#cb153-7" tabindex="-1"></a>    }</span>
<span id="cb153-8"><a href="NE.html#cb153-8" tabindex="-1"></a>  }</span>
<span id="cb153-9"><a href="NE.html#cb153-9" tabindex="-1"></a>  <span class="cf">if</span> (kernel<span class="sc">==</span><span class="st">&#39;triangular&#39;</span>){</span>
<span id="cb153-10"><a href="NE.html#cb153-10" tabindex="-1"></a>    K <span class="ot">&lt;-</span> <span class="cf">function</span>(u){</span>
<span id="cb153-11"><a href="NE.html#cb153-11" tabindex="-1"></a>      K.u <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb153-12"><a href="NE.html#cb153-12" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">abs</span>(u)<span class="sc">&lt;=</span>.<span class="dv">5</span>){K.u <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>(<span class="dv">1-2</span><span class="sc">*</span><span class="fu">abs</span>(u))}</span>
<span id="cb153-13"><a href="NE.html#cb153-13" tabindex="-1"></a>      <span class="fu">return</span>(K.u)</span>
<span id="cb153-14"><a href="NE.html#cb153-14" tabindex="-1"></a>    }</span>
<span id="cb153-15"><a href="NE.html#cb153-15" tabindex="-1"></a>  }</span>
<span id="cb153-16"><a href="NE.html#cb153-16" tabindex="-1"></a>  <span class="cf">if</span> (kernel<span class="sc">==</span><span class="st">&#39;epanechnikov&#39;</span>){</span>
<span id="cb153-17"><a href="NE.html#cb153-17" tabindex="-1"></a>    K <span class="ot">&lt;-</span> <span class="cf">function</span>(u){</span>
<span id="cb153-18"><a href="NE.html#cb153-18" tabindex="-1"></a>      K.u <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb153-19"><a href="NE.html#cb153-19" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">abs</span>(u)<span class="sc">&lt;=</span>.<span class="dv">5</span>){K.u <span class="ot">&lt;-</span> (<span class="dv">3</span><span class="sc">/</span><span class="dv">2</span>)<span class="sc">*</span>(<span class="dv">1-4</span><span class="sc">*</span>u<span class="sc">^</span><span class="dv">2</span>)}</span>
<span id="cb153-20"><a href="NE.html#cb153-20" tabindex="-1"></a>      <span class="fu">return</span>(K.u)</span>
<span id="cb153-21"><a href="NE.html#cb153-21" tabindex="-1"></a>    }</span>
<span id="cb153-22"><a href="NE.html#cb153-22" tabindex="-1"></a>  }</span>
<span id="cb153-23"><a href="NE.html#cb153-23" tabindex="-1"></a>  <span class="cf">if</span> (kernel<span class="sc">==</span><span class="st">&#39;quartic&#39;</span>){</span>
<span id="cb153-24"><a href="NE.html#cb153-24" tabindex="-1"></a>    K <span class="ot">&lt;-</span> <span class="cf">function</span>(u){</span>
<span id="cb153-25"><a href="NE.html#cb153-25" tabindex="-1"></a>      K.u <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb153-26"><a href="NE.html#cb153-26" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">abs</span>(u)<span class="sc">&lt;=</span>.<span class="dv">5</span>){K.u <span class="ot">&lt;-</span> (<span class="dv">15</span><span class="sc">/</span><span class="dv">8</span>)<span class="sc">*</span>(<span class="dv">1-4</span><span class="sc">*</span>u<span class="sc">^</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>}</span>
<span id="cb153-27"><a href="NE.html#cb153-27" tabindex="-1"></a>      <span class="fu">return</span>(K.u)</span>
<span id="cb153-28"><a href="NE.html#cb153-28" tabindex="-1"></a>    }</span>
<span id="cb153-29"><a href="NE.html#cb153-29" tabindex="-1"></a>  }</span>
<span id="cb153-30"><a href="NE.html#cb153-30" tabindex="-1"></a>  <span class="cf">if</span> (kernel<span class="sc">==</span><span class="st">&#39;gaussian&#39;</span>){</span>
<span id="cb153-31"><a href="NE.html#cb153-31" tabindex="-1"></a>    K <span class="ot">&lt;-</span> <span class="cf">function</span>(u){</span>
<span id="cb153-32"><a href="NE.html#cb153-32" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">exp</span>(<span class="sc">-</span><span class="fl">0.5</span><span class="sc">*</span>u<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="fu">sqrt</span>(<span class="dv">2</span><span class="sc">*</span>pi)))</span>
<span id="cb153-33"><a href="NE.html#cb153-33" tabindex="-1"></a>    }</span>
<span id="cb153-34"><a href="NE.html#cb153-34" tabindex="-1"></a>  }</span>
<span id="cb153-35"><a href="NE.html#cb153-35" tabindex="-1"></a>  K.vec <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(K)</span>
<span id="cb153-36"><a href="NE.html#cb153-36" tabindex="-1"></a>  y0.hat <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">length</span>(gridx))  </span>
<span id="cb153-37"><a href="NE.html#cb153-37" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(gridx))){</span>
<span id="cb153-38"><a href="NE.html#cb153-38" tabindex="-1"></a>    x.i <span class="ot">&lt;-</span> gridx[i]<span class="sc">-</span>x</span>
<span id="cb153-39"><a href="NE.html#cb153-39" tabindex="-1"></a>    weights.i <span class="ot">&lt;-</span> <span class="fu">K.vec</span>((x.i)<span class="sc">/</span>bw)</span>
<span id="cb153-40"><a href="NE.html#cb153-40" tabindex="-1"></a>    ols.i <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>x.i,<span class="at">weights=</span>weights.i)</span>
<span id="cb153-41"><a href="NE.html#cb153-41" tabindex="-1"></a>    y0.hat[i] <span class="ot">&lt;-</span> ols.i<span class="sc">$</span>coefficients[<span class="dv">1</span>]</span>
<span id="cb153-42"><a href="NE.html#cb153-42" tabindex="-1"></a>  }</span>
<span id="cb153-43"><a href="NE.html#cb153-43" tabindex="-1"></a>  <span class="fu">return</span>(y0.hat)</span>
<span id="cb153-44"><a href="NE.html#cb153-44" tabindex="-1"></a>}</span>
<span id="cb153-45"><a href="NE.html#cb153-45" tabindex="-1"></a></span>
<span id="cb153-46"><a href="NE.html#cb153-46" tabindex="-1"></a>MSE.llr <span class="ot">&lt;-</span> <span class="cf">function</span>(bw,y,D,x,kernel,d){</span>
<span id="cb153-47"><a href="NE.html#cb153-47" tabindex="-1"></a>  MSE <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb153-48"><a href="NE.html#cb153-48" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(y[D<span class="sc">==</span>d]))){</span>
<span id="cb153-49"><a href="NE.html#cb153-49" tabindex="-1"></a>    MSE <span class="ot">&lt;-</span> MSE <span class="sc">+</span> (y[D<span class="sc">==</span>d][i]<span class="sc">-</span><span class="fu">llr</span>(y[D<span class="sc">==</span>d][<span class="sc">-</span>i],x[D<span class="sc">==</span>d][<span class="sc">-</span>i],x[D<span class="sc">==</span>d][i],<span class="at">bw=</span>bw,<span class="at">kernel=</span>kernel))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb153-50"><a href="NE.html#cb153-50" tabindex="-1"></a>  }</span>
<span id="cb153-51"><a href="NE.html#cb153-51" tabindex="-1"></a>  <span class="fu">return</span>(MSE)</span>
<span id="cb153-52"><a href="NE.html#cb153-52" tabindex="-1"></a>}</span></code></pre></div>
<p>We can now use these two functions to choose the optimal bandwidth on each side of the cut-off point:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="NE.html#cb154-1" tabindex="-1"></a>kernel <span class="ot">&lt;-</span> <span class="st">&#39;gaussian&#39;</span></span>
<span id="cb154-2"><a href="NE.html#cb154-2" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb154-3"><a href="NE.html#cb154-3" tabindex="-1"></a></span>
<span id="cb154-4"><a href="NE.html#cb154-4" tabindex="-1"></a>MSE.grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="at">by=</span>.<span class="dv">1</span>)</span>
<span id="cb154-5"><a href="NE.html#cb154-5" tabindex="-1"></a>MSE.llr<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(MSE.grid,MSE.llr,<span class="at">y=</span>y,<span class="at">D=</span>Ds,<span class="at">x=</span>yB,<span class="at">kernel=</span>kernel,<span class="at">d=</span><span class="dv">0</span>)</span>
<span id="cb154-6"><a href="NE.html#cb154-6" tabindex="-1"></a>MSE.llr<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(MSE.grid,MSE.llr,<span class="at">y=</span>y,<span class="at">D=</span>Ds,<span class="at">x=</span>yB,<span class="at">kernel=</span>kernel,<span class="at">d=</span><span class="dv">1</span>)</span>
<span id="cb154-7"><a href="NE.html#cb154-7" tabindex="-1"></a>bw0 <span class="ot">&lt;-</span> MSE.grid[MSE.llr<span class="fl">.0</span><span class="sc">==</span><span class="fu">min</span>(MSE.llr<span class="fl">.0</span>)]</span>
<span id="cb154-8"><a href="NE.html#cb154-8" tabindex="-1"></a>bw1 <span class="ot">&lt;-</span> MSE.grid[MSE.llr<span class="fl">.1</span><span class="sc">==</span><span class="fu">min</span>(MSE.llr<span class="fl">.1</span>)]</span></code></pre></div>
<p>Let us see what the results of this computation look like:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="NE.html#cb155-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">5</span>))</span>
<span id="cb155-2"><a href="NE.html#cb155-2" tabindex="-1"></a><span class="fu">plot</span>(MSE.grid,MSE.llr<span class="fl">.0</span>,<span class="at">xlab=</span><span class="st">&#39;Bandwidth&#39;</span>,<span class="at">ylab=</span><span class="st">&#39;MSE (y|D=0)&#39;</span>)</span>
<span id="cb155-3"><a href="NE.html#cb155-3" tabindex="-1"></a><span class="fu">legend</span>(<span class="fl">0.8</span>,<span class="dv">50</span>,<span class="fu">c</span>(<span class="st">&#39;y|D=0&#39;</span>,<span class="st">&#39;y|D=1&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;black&#39;</span>),<span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb155-4"><a href="NE.html#cb155-4" tabindex="-1"></a><span class="fu">par</span>(<span class="at">new=</span><span class="cn">TRUE</span>)</span>
<span id="cb155-5"><a href="NE.html#cb155-5" tabindex="-1"></a><span class="fu">plot</span>(MSE.grid,MSE.llr<span class="fl">.1</span>,<span class="at">pch=</span><span class="dv">3</span>,<span class="at">xaxt=</span><span class="st">&quot;n&quot;</span>,<span class="at">yaxt=</span><span class="st">&quot;n&quot;</span>,<span class="at">xlab=</span><span class="st">&quot;&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb155-6"><a href="NE.html#cb155-6" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">4</span>)</span>
<span id="cb155-7"><a href="NE.html#cb155-7" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">&quot;MSE (y|D=1)&quot;</span>,<span class="at">side=</span><span class="dv">4</span>,<span class="at">line=</span><span class="dv">3</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotRDDLLRcv"></span>
<img src="STCI_files/figure-html/PlotRDDLLRcv-1.png" alt="Cross Validation Results" width="65%" />
<p class="caption">
Figure 4.9: Cross Validation Results
</p>
</div>
<p>As Figure <a href="NE.html#fig:PlotRDDLLRcv">4.9</a> shows, the optimal bandwidth is equal to 0.3 on the right of the threshold and to 0.2 on the left.</p>
<p>We can now proceed with the estimation of the whole conditional expectations (in order to visualize them) and the estimated treatment effect using these optimal bandwidth levels:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="NE.html#cb156-1" tabindex="-1"></a><span class="co"># whole conditional expectations at each sample point</span></span>
<span id="cb156-2"><a href="NE.html#cb156-2" tabindex="-1"></a>y0.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[Ds<span class="sc">==</span><span class="dv">0</span>],yB[Ds<span class="sc">==</span><span class="dv">0</span>],yB[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">bw=</span>bw0,<span class="at">kernel=</span>kernel)    </span>
<span id="cb156-3"><a href="NE.html#cb156-3" tabindex="-1"></a>y1.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[Ds<span class="sc">==</span><span class="dv">1</span>],yB[Ds<span class="sc">==</span><span class="dv">1</span>],yB[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">bw=</span>bw1,<span class="at">kernel=</span>kernel)    </span>
<span id="cb156-4"><a href="NE.html#cb156-4" tabindex="-1"></a></span>
<span id="cb156-5"><a href="NE.html#cb156-5" tabindex="-1"></a><span class="co"># estimation of the treatment effect</span></span>
<span id="cb156-6"><a href="NE.html#cb156-6" tabindex="-1"></a>y0.bary.llr.pred <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[Ds<span class="sc">==</span><span class="dv">0</span>],yB[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>bw0,<span class="at">kernel=</span>kernel) </span>
<span id="cb156-7"><a href="NE.html#cb156-7" tabindex="-1"></a>y1.bary.llr.pred <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[Ds<span class="sc">==</span><span class="dv">1</span>],yB[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>bw1,<span class="at">kernel=</span>kernel)</span>
<span id="cb156-8"><a href="NE.html#cb156-8" tabindex="-1"></a>delta.y.rdd.llr <span class="ot">&lt;-</span> y1.bary.llr.pred<span class="sc">-</span>y0.bary.llr.pred</span></code></pre></div>
<p>Let us plot the resulting estimates:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="NE.html#cb157-1" tabindex="-1"></a><span class="fu">plot</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&quot;yB&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb157-2"><a href="NE.html#cb157-2" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb157-3"><a href="NE.html#cb157-3" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y0.llr,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">1</span>)</span>
<span id="cb157-4"><a href="NE.html#cb157-4" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y1.llr,<span class="at">col=</span><span class="st">&#39;blue&#39;</span>,<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb157-5"><a href="NE.html#cb157-5" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb157-6"><a href="NE.html#cb157-6" tabindex="-1"></a><span class="fu">text</span>(<span class="at">x=</span><span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])),<span class="at">y=</span><span class="fu">c</span>(<span class="dv">5</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="fu">expression</span>(<span class="fu">bar</span>(<span class="st">&#39;y&#39;</span>))),<span class="at">pos=</span><span class="fu">c</span>(<span class="dv">2</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>))</span>
<span id="cb157-7"><a href="NE.html#cb157-7" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="dv">11</span>,<span class="fu">c</span>(<span class="st">&#39;y|D=0&#39;</span>,<span class="st">&#39;y|D=1&#39;</span>,<span class="fu">expression</span>(<span class="fu">hat</span>(<span class="st">&#39;y0&#39;</span>)),<span class="fu">expression</span>(<span class="fu">hat</span>(<span class="st">&#39;y1&#39;</span>))),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;black&#39;</span>,<span class="st">&#39;blue&#39;</span>,<span class="st">&#39;blue&#39;</span>),<span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotSharpRDDLLRNonlin"></span>
<img src="STCI_files/figure-html/PlotSharpRDDLLRNonlin-1.png" alt="LLR estimates of sharp RDD with non linear conditional expectations" width="65%" />
<p class="caption">
Figure 4.10: LLR estimates of sharp RDD with non linear conditional expectations
</p>
</div>
<p>Our estimate of the treatment effect using LLR is 0.19 while the true value of our target parameter is still 0.18.
The reason why the LLR estimate is an improvement over the OLS estimate is because the LLR estimate of the conditional expectation <span class="math inline">\(\hatesp{y_i^0|y_i^B=\bar{y}}\)</span> curves upwards when approaching <span class="math inline">\(\bar{y}\)</span> as it should (as Figure <a href="NE.html#fig:PlotSharpRDDLLRNonlin">4.10</a> shows) while the linear prediction using OLS does not (see Figure <a href="NE.html#fig:PlotSharpRDDOLSNonlin">4.8</a>).</p>
<p>Let us finally see how sampling noise moves that estimator around as sample size increases.
I am first going to ignore the noise stemming from estimating the optimal bandwidth, because it increases computation time exponentially.
I am going to stick with the bandwidths optimal for the test sample (<span class="math inline">\(N=1000\)</span>).
They are going to be too large for the large samples, and as a consequence, they are going to generate a biased estimator there.
Let’s see how severe that is:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="NE.html#cb158-1" tabindex="-1"></a>monte.carlo.rdd.llr.bw <span class="ot">&lt;-</span> <span class="cf">function</span>(s,N,param,bw1,bw0,kernel){</span>
<span id="cb158-2"><a href="NE.html#cb158-2" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb158-3"><a href="NE.html#cb158-3" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb158-4"><a href="NE.html#cb158-4" tabindex="-1"></a>  UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb158-5"><a href="NE.html#cb158-5" tabindex="-1"></a>  yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb158-6"><a href="NE.html#cb158-6" tabindex="-1"></a>  YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb158-7"><a href="NE.html#cb158-7" tabindex="-1"></a>  Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb158-8"><a href="NE.html#cb158-8" tabindex="-1"></a>  Ds[YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb158-9"><a href="NE.html#cb158-9" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb158-10"><a href="NE.html#cb158-10" tabindex="-1"></a>  eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb158-11"><a href="NE.html#cb158-11" tabindex="-1"></a>  U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb158-12"><a href="NE.html#cb158-12" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>] <span class="sc">+</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(yB<span class="sc">-</span>param[<span class="st">&quot;baryB&quot;</span>])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb158-13"><a href="NE.html#cb158-13" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb158-14"><a href="NE.html#cb158-14" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb158-15"><a href="NE.html#cb158-15" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb158-16"><a href="NE.html#cb158-16" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb158-17"><a href="NE.html#cb158-17" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb158-18"><a href="NE.html#cb158-18" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb158-19"><a href="NE.html#cb158-19" tabindex="-1"></a>  y0.bary.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[Ds<span class="sc">==</span><span class="dv">0</span>],yB[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>bw0,<span class="at">kernel=</span>kernel)    </span>
<span id="cb158-20"><a href="NE.html#cb158-20" tabindex="-1"></a>  y1.bary.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[Ds<span class="sc">==</span><span class="dv">1</span>],yB[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>bw1,<span class="at">kernel=</span>kernel)    </span>
<span id="cb158-21"><a href="NE.html#cb158-21" tabindex="-1"></a>  delta.y.rdd.llr <span class="ot">&lt;-</span> y1.bary.llr<span class="sc">-</span>y0.bary.llr</span>
<span id="cb158-22"><a href="NE.html#cb158-22" tabindex="-1"></a>  <span class="fu">return</span>(delta.y.rdd.llr)</span>
<span id="cb158-23"><a href="NE.html#cb158-23" tabindex="-1"></a>}</span>
<span id="cb158-24"><a href="NE.html#cb158-24" tabindex="-1"></a></span>
<span id="cb158-25"><a href="NE.html#cb158-25" tabindex="-1"></a>simuls.rdd.llr.bw.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param,bw0,bw1,kernel){</span>
<span id="cb158-26"><a href="NE.html#cb158-26" tabindex="-1"></a>  simuls.rdd.llr.bw <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.rdd.llr.bw,<span class="at">N=</span>N,<span class="at">param=</span>param,<span class="at">bw1=</span>bw1,<span class="at">bw0=</span>bw0,<span class="at">kernel=</span>kernel)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb158-27"><a href="NE.html#cb158-27" tabindex="-1"></a>  <span class="fu">colnames</span>(simuls.rdd.llr.bw) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDD LLR&#39;</span>)</span>
<span id="cb158-28"><a href="NE.html#cb158-28" tabindex="-1"></a>  <span class="fu">return</span>(simuls.rdd.llr.bw)</span>
<span id="cb158-29"><a href="NE.html#cb158-29" tabindex="-1"></a>}</span>
<span id="cb158-30"><a href="NE.html#cb158-30" tabindex="-1"></a></span>
<span id="cb158-31"><a href="NE.html#cb158-31" tabindex="-1"></a>sf.simuls.rdd.llr.bw.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param,bw0,bw1,kernel){</span>
<span id="cb158-32"><a href="NE.html#cb158-32" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span><span class="dv">8</span>)</span>
<span id="cb158-33"><a href="NE.html#cb158-33" tabindex="-1"></a>  <span class="fu">sfExport</span>(<span class="st">&#39;llr&#39;</span>,<span class="st">&#39;MSE.llr&#39;</span>,<span class="st">&#39;param&#39;</span>)</span>
<span id="cb158-34"><a href="NE.html#cb158-34" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.rdd.llr.bw,<span class="at">N=</span>N,<span class="at">param=</span>param,<span class="at">bw1=</span>bw1,<span class="at">bw0=</span>bw0,<span class="at">kernel=</span>kernel)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb158-35"><a href="NE.html#cb158-35" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb158-36"><a href="NE.html#cb158-36" tabindex="-1"></a>  <span class="fu">colnames</span>(sim) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDD LLR&#39;</span>)</span>
<span id="cb158-37"><a href="NE.html#cb158-37" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb158-38"><a href="NE.html#cb158-38" tabindex="-1"></a>}</span>
<span id="cb158-39"><a href="NE.html#cb158-39" tabindex="-1"></a></span>
<span id="cb158-40"><a href="NE.html#cb158-40" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb158-41"><a href="NE.html#cb158-41" tabindex="-1"></a><span class="co">#Nsim &lt;- 10</span></span>
<span id="cb158-42"><a href="NE.html#cb158-42" tabindex="-1"></a>N.sample <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">1000</span>,<span class="dv">10000</span>,<span class="dv">100000</span>)</span>
<span id="cb158-43"><a href="NE.html#cb158-43" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000)</span></span>
<span id="cb158-44"><a href="NE.html#cb158-44" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000)</span></span>
<span id="cb158-45"><a href="NE.html#cb158-45" tabindex="-1"></a><span class="co">#N.sample &lt;- c(1000)</span></span>
<span id="cb158-46"><a href="NE.html#cb158-46" tabindex="-1"></a></span>
<span id="cb158-47"><a href="NE.html#cb158-47" tabindex="-1"></a>simuls.rdd.llr.bw <span class="ot">&lt;-</span> <span class="fu">lapply</span>(N.sample,sf.simuls.rdd.llr.bw.N,<span class="at">Nsim=</span>Nsim,<span class="at">param=</span>param,<span class="at">bw1=</span>bw1,<span class="at">bw0=</span>bw0,<span class="at">kernel=</span>kernel)</span>
<span id="cb158-48"><a href="NE.html#cb158-48" tabindex="-1"></a><span class="fu">names</span>(simuls.rdd.llr.bw) <span class="ot">&lt;-</span> N.sample</span></code></pre></div>
<p>Let us now plot the results:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="NE.html#cb159-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb159-2"><a href="NE.html#cb159-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simuls.rdd.llr.bw)){</span>
<span id="cb159-3"><a href="NE.html#cb159-3" tabindex="-1"></a>  <span class="fu">hist</span>(simuls.rdd.llr.bw[[i]][,<span class="st">&#39;RDD LLR&#39;</span>],<span class="at">breaks=</span><span class="dv">30</span>,<span class="at">main=</span><span class="fu">paste</span>(<span class="st">&#39;N=&#39;</span>,<span class="fu">as.character</span>(N.sample[i])),<span class="at">xlab=</span><span class="fu">expression</span>(<span class="fu">hat</span>(Delta<span class="sc">^</span>yRDDLLR)),<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.15</span>,<span class="fl">0.55</span>))</span>
<span id="cb159-4"><a href="NE.html#cb159-4" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v=</span><span class="fu">delta.y.tt.z</span>(param),<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb159-5"><a href="NE.html#cb159-5" tabindex="-1"></a>}</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:MonteCarloHistRDDLLRbw"></span>
<img src="STCI_files/figure-html/MonteCarloHistRDDLLRbw-1.png" alt="Distribution of the RDD LLR estimator over replications of samples of different sizes" width="65%" />
<p class="caption">
Figure 4.11: Distribution of the RDD LLR estimator over replications of samples of different sizes
</p>
</div>
<p>As expected, there is a small downward bias for the sample sizes.</p>
<p>In order to see how much sampling noise estimates are affected by the computation of the optimal bandwidth, let’s run simulations including optimal bandwidth choice.
Because of computational costs, I only run them for the smallest sample size for now.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="NE.html#cb160-1" tabindex="-1"></a>monte.carlo.rdd.llr <span class="ot">&lt;-</span> <span class="cf">function</span>(s,N,param){</span>
<span id="cb160-2"><a href="NE.html#cb160-2" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb160-3"><a href="NE.html#cb160-3" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb160-4"><a href="NE.html#cb160-4" tabindex="-1"></a>  UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb160-5"><a href="NE.html#cb160-5" tabindex="-1"></a>  yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb160-6"><a href="NE.html#cb160-6" tabindex="-1"></a>  YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb160-7"><a href="NE.html#cb160-7" tabindex="-1"></a>  Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb160-8"><a href="NE.html#cb160-8" tabindex="-1"></a>  Ds[YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb160-9"><a href="NE.html#cb160-9" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb160-10"><a href="NE.html#cb160-10" tabindex="-1"></a>  eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb160-11"><a href="NE.html#cb160-11" tabindex="-1"></a>  U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb160-12"><a href="NE.html#cb160-12" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>] <span class="sc">+</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(yB<span class="sc">-</span>param[<span class="st">&quot;baryB&quot;</span>])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb160-13"><a href="NE.html#cb160-13" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb160-14"><a href="NE.html#cb160-14" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb160-15"><a href="NE.html#cb160-15" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb160-16"><a href="NE.html#cb160-16" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb160-17"><a href="NE.html#cb160-17" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb160-18"><a href="NE.html#cb160-18" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb160-19"><a href="NE.html#cb160-19" tabindex="-1"></a>  MSE.llr<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(MSE.grid,MSE.llr,<span class="at">y=</span>y,<span class="at">D=</span>Ds,<span class="at">x=</span>yB,<span class="at">kernel=</span>kernel,<span class="at">d=</span><span class="dv">0</span>)</span>
<span id="cb160-20"><a href="NE.html#cb160-20" tabindex="-1"></a>  MSE.llr<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(MSE.grid,MSE.llr,<span class="at">y=</span>y,<span class="at">D=</span>Ds,<span class="at">x=</span>yB,<span class="at">kernel=</span>kernel,<span class="at">d=</span><span class="dv">1</span>)</span>
<span id="cb160-21"><a href="NE.html#cb160-21" tabindex="-1"></a>  y0.bary.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[Ds<span class="sc">==</span><span class="dv">0</span>],yB[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>MSE.grid[MSE.llr<span class="fl">.0</span><span class="sc">==</span><span class="fu">min</span>(MSE.llr<span class="fl">.0</span>)],<span class="at">kernel=</span>kernel)    </span>
<span id="cb160-22"><a href="NE.html#cb160-22" tabindex="-1"></a>  y1.bary.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[Ds<span class="sc">==</span><span class="dv">1</span>],yB[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>MSE.grid[MSE.llr<span class="fl">.1</span><span class="sc">==</span><span class="fu">min</span>(MSE.llr<span class="fl">.1</span>)],<span class="at">kernel=</span>kernel)    </span>
<span id="cb160-23"><a href="NE.html#cb160-23" tabindex="-1"></a>  delta.y.rdd.llr <span class="ot">&lt;-</span> y1.bary.llr<span class="sc">-</span>y0.bary.llr</span>
<span id="cb160-24"><a href="NE.html#cb160-24" tabindex="-1"></a>  <span class="fu">return</span>(delta.y.rdd.llr)</span>
<span id="cb160-25"><a href="NE.html#cb160-25" tabindex="-1"></a>}</span>
<span id="cb160-26"><a href="NE.html#cb160-26" tabindex="-1"></a></span>
<span id="cb160-27"><a href="NE.html#cb160-27" tabindex="-1"></a>simuls.rdd.llr.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param){</span>
<span id="cb160-28"><a href="NE.html#cb160-28" tabindex="-1"></a>  simuls.rdd.llr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.rdd.llr,<span class="at">N=</span>N,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-29"><a href="NE.html#cb160-29" tabindex="-1"></a>  <span class="fu">colnames</span>(simuls.rdd.llr) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDD LLR&#39;</span>)</span>
<span id="cb160-30"><a href="NE.html#cb160-30" tabindex="-1"></a>  <span class="fu">return</span>(simuls.rdd.llr)</span>
<span id="cb160-31"><a href="NE.html#cb160-31" tabindex="-1"></a>}</span>
<span id="cb160-32"><a href="NE.html#cb160-32" tabindex="-1"></a></span>
<span id="cb160-33"><a href="NE.html#cb160-33" tabindex="-1"></a>sf.simuls.rdd.llr.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param){</span>
<span id="cb160-34"><a href="NE.html#cb160-34" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span><span class="dv">8</span>)</span>
<span id="cb160-35"><a href="NE.html#cb160-35" tabindex="-1"></a>  <span class="fu">sfExport</span>(<span class="st">&#39;llr&#39;</span>,<span class="st">&#39;MSE.llr&#39;</span>,<span class="st">&#39;param&#39;</span>,<span class="st">&#39;MSE.grid&#39;</span>,<span class="st">&#39;kernel&#39;</span>,<span class="st">&#39;bw&#39;</span>)</span>
<span id="cb160-36"><a href="NE.html#cb160-36" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.rdd.llr,<span class="at">N=</span>N,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb160-37"><a href="NE.html#cb160-37" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb160-38"><a href="NE.html#cb160-38" tabindex="-1"></a>  <span class="fu">colnames</span>(sim) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDD LLR&#39;</span>)</span>
<span id="cb160-39"><a href="NE.html#cb160-39" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb160-40"><a href="NE.html#cb160-40" tabindex="-1"></a>}</span>
<span id="cb160-41"><a href="NE.html#cb160-41" tabindex="-1"></a></span>
<span id="cb160-42"><a href="NE.html#cb160-42" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb160-43"><a href="NE.html#cb160-43" tabindex="-1"></a><span class="co">#Nsim &lt;- 10</span></span>
<span id="cb160-44"><a href="NE.html#cb160-44" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000,100000)</span></span>
<span id="cb160-45"><a href="NE.html#cb160-45" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000)</span></span>
<span id="cb160-46"><a href="NE.html#cb160-46" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000)</span></span>
<span id="cb160-47"><a href="NE.html#cb160-47" tabindex="-1"></a>N.sample <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>)</span>
<span id="cb160-48"><a href="NE.html#cb160-48" tabindex="-1"></a></span>
<span id="cb160-49"><a href="NE.html#cb160-49" tabindex="-1"></a>simuls.rdd.llr <span class="ot">&lt;-</span> <span class="fu">lapply</span>(N.sample,sf.simuls.rdd.llr.N,<span class="at">Nsim=</span>Nsim,<span class="at">param=</span>param)</span>
<span id="cb160-50"><a href="NE.html#cb160-50" tabindex="-1"></a><span class="fu">names</span>(simuls.rdd.llr) <span class="ot">&lt;-</span> N.sample</span></code></pre></div>
<p>Let’s plot the resulting estimate:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:MonteCarloHistRDDLLR"></span>
<img src="STCI_files/figure-html/MonteCarloHistRDDLLR-1.png" alt="Distribution of the RDD LLR estimator over replications of samples of different sizes, with optimal bandwidth choice" width="65%" />
<p class="caption">
Figure 4.12: Distribution of the RDD LLR estimator over replications of samples of different sizes, with optimal bandwidth choice
</p>
</div>
<p>The results are broadly comparable.
For <span class="math inline">\(N=100\)</span>, 99% sampling noise of LLR estimated by Monte Carlo simulations is 0.57 when keeping the bandwidth fixed while it is equal to 0.59 when the bandwidth is optimized at each run.</p>
</div>
<div id="simplified-estimator-of-lee-and-lemieux" class="section level5 hasAnchor" number="4.2.1.2.4">
<h5><span class="header-section-number">4.2.1.2.4</span> Simplified estimator of Lee and Lemieux<a href="NE.html#simplified-estimator-of-lee-and-lemieux" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407607001091">Imbens and Lemieux (2008)</a> propose a simplified version of the RDD LLR estimator.
<span class="math inline">\(\hat{\delta}\)</span> estimated by OLS on the sample of observations such as <span class="math inline">\(\bar{z}-h\leq Z_i\leq\bar{z}+h\)</span> is an estimate of <span class="math inline">\(TT(z)\)</span>:</p>
<p><span class="math display">\[\begin{align*}
  Y_i &amp; = \alpha + \beta (Z_i-\bar{z})(1-D_i) + \gamma(Z_i-\bar{z})D_i + \delta D_i + \epsilon_i
\end{align*}\]</span></p>
<p>It is actually equal to the LLR estimate with uniform kernel and identical bandwidth on each side of the threshold.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-172" class="example"><strong>Example 4.19  </strong></span>Lets run the simplified LLR estimator in our example.</p>
</div>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="NE.html#cb161-1" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb161-2"><a href="NE.html#cb161-2" tabindex="-1"></a>y.h <span class="ot">&lt;-</span> y[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb161-3"><a href="NE.html#cb161-3" tabindex="-1"></a>Ds.h <span class="ot">&lt;-</span> Ds[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb161-4"><a href="NE.html#cb161-4" tabindex="-1"></a>yB.l <span class="ot">&lt;-</span> (yB[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]<span class="sc">-</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))<span class="sc">*</span>Ds[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb161-5"><a href="NE.html#cb161-5" tabindex="-1"></a>yB.r <span class="ot">&lt;-</span> (yB[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]<span class="sc">-</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw])</span>
<span id="cb161-6"><a href="NE.html#cb161-6" tabindex="-1"></a></span>
<span id="cb161-7"><a href="NE.html#cb161-7" tabindex="-1"></a>reg.rdd.local.ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(y.h <span class="sc">~</span> Ds.h <span class="sc">+</span> yB.l <span class="sc">+</span> yB.r)</span>
<span id="cb161-8"><a href="NE.html#cb161-8" tabindex="-1"></a>reg.rdd.local.ols<span class="sc">$</span>coef[<span class="dv">2</span>]</span></code></pre></div>
<p>The estimated value of TT(z) by simplified LLR is 0.11 while the true value of our target parameter is still 0.18.</p>
</div>
</div>
<div id="estimating-sampling-noise-4" class="section level4 hasAnchor" number="4.2.1.3">
<h4><span class="header-section-number">4.2.1.3</span> Estimating sampling noise<a href="NE.html#estimating-sampling-noise-4" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Several approaches are available to estimate sampling noise of the RDD LLR estimator in a sharp design:</p>
<ul>
<li><a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1468-0262.00183">Hahn, Todd and van der Klaauw (2001)</a> derive general CLT results</li>
<li><a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407607001091">Imbens and Lemieux (2008)</a> simplify the CLT results and propose a plug-in estimator</li>
<li><a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407607001091">Imbens and Lemieux (2008)</a> propose to use the robust variance OLS estimator</li>
<li>We can always use the Bootstrap. It should be valid.</li>
</ul>
<p>Let us first look at some CLT results:</p>
<div class="theorem">
<p><span id="thm:CLTSharpRDDLLR" class="theorem"><strong>Theorem 4.5  (Asymptotic Variance of the LLR Estimator in a Sharp RDD) </strong></span>Under standard assumptions, the variance of the simplified LLR Estimator in a Sharp Design can be approximated by:</p>
<p><span class="math display">\[\begin{align*}
\var{\hat{\Delta}_{LLRRDD}} &amp; \approx \frac{1}{Nh}\frac{4}{f_{Z}(\bar{z})}\left(\lim_{e\rightarrow 0^{\text{+}}}\var{Y_i|Z_i=\bar{z}-e}+\lim_{e\rightarrow 0^{\text{+}}}\var{Y_i|Z_i=\bar{z}+e}\right),
\end{align*}\]</span></p>
<p>with <span class="math inline">\(f_{Z}\)</span> the density of <span class="math inline">\(Z_i\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-91" class="proof"><em>Proof</em>. </span>See <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1468-0262.00183">Hahn, Todd and van der Klaauw (2001)</a> and <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407607001091">Imbens and Lemieux (2008)</a>.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-174" class="example"><strong>Example 4.20  </strong></span>Let’s see what happens when using the the robust variance estimator in the simplified LLR estimator proposed by Imbens and Lemieux (2008).</p>
</div>
<p>The estimated 99% sampling noise using this approach is 0.44 while the true 99% sampling noise of LLR estimated by Monte Carlo simulations is equal to 0.57.</p>
</div>
</div>
<div id="fuzzy-regression-discontinuity-designs" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Fuzzy Regression Discontinuity Designs<a href="NE.html#fuzzy-regression-discontinuity-designs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We say that a Regression Discontinuity Design is fuzzy when the probability of obtaining the treatment does not move from <span class="math inline">\(0\)</span> to <span class="math inline">\(1\)</span> when moving across the threshold of the running variable, but moves from some probability to a different one, when both are strictly positive and strictly smaller than one.
This means that there is some event that discontinuously affects the enrollment of some people but not the enrollment of others.
We thus are going to see <strong>compliers</strong>, <strong>always takers</strong> and <strong>never takers</strong>, as we did with Instrumental Variables.
In this section, we are going to study the identification, estimation and estimation of sampling noise of treatment effects in the Fuzzy Regression Discontinuity Design.</p>
<div id="identification-6" class="section level4 hasAnchor" number="4.2.2.1">
<h4><span class="header-section-number">4.2.2.1</span> Identification<a href="NE.html#identification-6" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The first assumption characterizing the Fuzzy Regression Discontinuity Design is the asumption that the probability of receiving treatment is discontinuous:</p>
<div class="hypothesis">
<p><span id="hyp:FuzzyRDD" class="hypothesis"><strong>Hypothesis 4.9  (Fuzzy RDD Design) </strong></span>There exists a running variable <span class="math inline">\(Z_i\)</span> and a threshold <span class="math inline">\(\bar{z}\)</span> such that:</p>
<p><span class="math display">\[\begin{align*}
  \lim_{e\rightarrow 0^{+}}\Pr(D_i=1|Z_i=\bar{z}-e) &amp; \neq \lim_{e\rightarrow 0^{+}}\Pr(D_i=1|Z_i=\bar{z}+e).
\end{align*}\]</span></p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-175" class="example"><strong>Example 4.21  </strong></span>Let’s see how this plays in our example.
Let’s first simulate some data:</p>
</div>
<p><span class="math display">\[\begin{align*}
y_i^1 &amp; = y_i^0+\bar{\alpha}+\theta\mu_i+\eta_i \\
y_i^0 &amp; = \mu_i+\delta+U_i^0+\gamma(y_i^B-\bar{y})^2  \\
U_i^0 &amp; = \rho U_i^B+\epsilon_i \\
y_i^B &amp; =\mu_i+U_i^B \\
U_i^B &amp; \sim\mathcal{N}(0,\sigma^2_{U}) \\
D_i   &amp; = \uns{y_i^B\leq\bar{y} \land V_i\leq\kappa \lor y_i^B&gt;\bar{y} \land V_i&gt;\kappa} \\
(\eta_i,\omega_i,V_i) &amp; \sim\mathcal{N}(0,0,0,\sigma^2_{\eta},\sigma^2_{\omega},\sigma^2_{\mu}+\sigma^2_{U},0,0,0).
\end{align*}\]</span></p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="NE.html#cb162-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(param,<span class="dv">1</span>)</span>
<span id="cb162-2"><a href="NE.html#cb162-2" tabindex="-1"></a><span class="fu">names</span>(param)[[<span class="fu">length</span>(param)]] <span class="ot">&lt;-</span> <span class="st">&quot;kappa&quot;</span></span>
<span id="cb162-3"><a href="NE.html#cb162-3" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb162-4"><a href="NE.html#cb162-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb162-5"><a href="NE.html#cb162-5" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb162-6"><a href="NE.html#cb162-6" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb162-7"><a href="NE.html#cb162-7" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb162-8"><a href="NE.html#cb162-8" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb162-9"><a href="NE.html#cb162-9" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb162-10"><a href="NE.html#cb162-10" tabindex="-1"></a>V <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb162-11"><a href="NE.html#cb162-11" tabindex="-1"></a>Ds[((yB<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])) <span class="sc">&amp;</span> (V<span class="sc">&lt;=</span>param[<span class="st">&quot;kappa&quot;</span>])) <span class="sc">|</span> ((yB<span class="sc">&gt;</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])) <span class="sc">&amp;</span> (V<span class="sc">&gt;</span>param[<span class="st">&quot;kappa&quot;</span>])) ] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb162-12"><a href="NE.html#cb162-12" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb162-13"><a href="NE.html#cb162-13" tabindex="-1"></a>eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb162-14"><a href="NE.html#cb162-14" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb162-15"><a href="NE.html#cb162-15" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>] <span class="sc">+</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(yB<span class="sc">-</span>param[<span class="st">&quot;baryB&quot;</span>])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb162-16"><a href="NE.html#cb162-16" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb162-17"><a href="NE.html#cb162-17" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb162-18"><a href="NE.html#cb162-18" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb162-19"><a href="NE.html#cb162-19" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb162-20"><a href="NE.html#cb162-20" tabindex="-1"></a>y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb162-21"><a href="NE.html#cb162-21" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span></code></pre></div>
<p>Let us now plot the corresponding data:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="NE.html#cb163-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">5</span>))</span>
<span id="cb163-2"><a href="NE.html#cb163-2" tabindex="-1"></a><span class="fu">plot</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y0[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&quot;yB&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb163-3"><a href="NE.html#cb163-3" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">3</span>,<span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb163-4"><a href="NE.html#cb163-4" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb163-5"><a href="NE.html#cb163-5" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="fl">10.5</span>,<span class="fu">c</span>(<span class="st">&#39;y0|D=0&#39;</span>,<span class="st">&#39;y1|D=1&#39;</span>,<span class="st">&#39;D&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;black&#39;</span>,<span class="st">&#39;red&#39;</span>),<span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb163-6"><a href="NE.html#cb163-6" tabindex="-1"></a><span class="fu">par</span>(<span class="at">new=</span><span class="cn">TRUE</span>)</span>
<span id="cb163-7"><a href="NE.html#cb163-7" tabindex="-1"></a><span class="fu">plot</span>(yB,Ds,<span class="at">pch=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">&#39;red&#39;</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xaxt=</span><span class="st">&quot;n&quot;</span>,<span class="at">yaxt=</span><span class="st">&quot;n&quot;</span>,<span class="at">xlab=</span><span class="st">&quot;&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb163-8"><a href="NE.html#cb163-8" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">4</span>)</span>
<span id="cb163-9"><a href="NE.html#cb163-9" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">&quot;D&quot;</span>,<span class="at">side=</span><span class="dv">4</span>,<span class="at">line=</span><span class="dv">3</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotFuzzyRDD"></span>
<img src="STCI_files/figure-html/PlotFuzzyRDD-1.png" alt="Fuzzy RDD" width="65%" />
<p class="caption">
Figure 4.13: Fuzzy RDD
</p>
</div>
<p>As you can see on Figure <a href="NE.html#fig:PlotFuzzyRDD">4.13</a>, there are untreated individuals below <span class="math inline">\(\bar{y}\)</span> and treated individual above <span class="math inline">\(\bar{y}\)</span>.
This is why the design is not sharp.
But Figure <a href="NE.html#fig:PlotFuzzyRDD">4.13</a> fails to convey that the design still exhibits a discontinuity in the proportion of treated.
In order to see it, we need to compute an estimate of the probability of being treated conditional on the running variable (<span class="math inline">\(y_i^B\)</span>): <span class="math inline">\(\Pr(D_i=1|y_i^B=y)\)</span>.
It turns out that this quantity is simply the expected value of <span class="math inline">\(D_i\)</span> conditional on <span class="math inline">\(y_i^B\)</span>.
We’ve just learned a cool way to estimate a conditional expectation: Local Linear Regression.
Let’s put it to work, using <span class="math inline">\(D_i\)</span> as the outcome variable now:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="NE.html#cb164-1" tabindex="-1"></a>kernel <span class="ot">&lt;-</span> <span class="st">&#39;gaussian&#39;</span></span>
<span id="cb164-2"><a href="NE.html#cb164-2" tabindex="-1"></a>MSE.grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="at">by=</span>.<span class="dv">1</span>)</span>
<span id="cb164-3"><a href="NE.html#cb164-3" tabindex="-1"></a><span class="co"># the instrument in our case is the position relative to the threshoold (or side, hence S)</span></span>
<span id="cb164-4"><a href="NE.html#cb164-4" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">length</span>(yB))</span>
<span id="cb164-5"><a href="NE.html#cb164-5" tabindex="-1"></a>S[yB<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb164-6"><a href="NE.html#cb164-6" tabindex="-1"></a></span>
<span id="cb164-7"><a href="NE.html#cb164-7" tabindex="-1"></a><span class="co"># computing optimal bandwidth using Cross Validation</span></span>
<span id="cb164-8"><a href="NE.html#cb164-8" tabindex="-1"></a>MSE.pr.llr<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(MSE.grid,MSE.llr,<span class="at">y=</span>Ds,<span class="at">D=</span>S,<span class="at">x=</span>yB,<span class="at">kernel=</span>kernel,<span class="at">d=</span><span class="dv">0</span>)</span>
<span id="cb164-9"><a href="NE.html#cb164-9" tabindex="-1"></a>MSE.pr.llr<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(MSE.grid,MSE.llr,<span class="at">y=</span>Ds,<span class="at">D=</span>S,<span class="at">x=</span>yB,<span class="at">kernel=</span>kernel,<span class="at">d=</span><span class="dv">1</span>)</span>
<span id="cb164-10"><a href="NE.html#cb164-10" tabindex="-1"></a>bwD0 <span class="ot">&lt;-</span> MSE.grid[MSE.pr.llr<span class="fl">.0</span><span class="sc">==</span><span class="fu">min</span>(MSE.pr.llr<span class="fl">.0</span>)]</span>
<span id="cb164-11"><a href="NE.html#cb164-11" tabindex="-1"></a>bwD1 <span class="ot">&lt;-</span> MSE.grid[MSE.pr.llr<span class="fl">.1</span><span class="sc">==</span><span class="fu">min</span>(MSE.pr.llr<span class="fl">.1</span>)]</span>
<span id="cb164-12"><a href="NE.html#cb164-12" tabindex="-1"></a></span>
<span id="cb164-13"><a href="NE.html#cb164-13" tabindex="-1"></a><span class="co"># LLR estoimate of conditional expectation of D on yB</span></span>
<span id="cb164-14"><a href="NE.html#cb164-14" tabindex="-1"></a>Pr.D0.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(Ds[S<span class="sc">==</span><span class="dv">0</span>],yB[S<span class="sc">==</span><span class="dv">0</span>],yB[S<span class="sc">==</span><span class="dv">0</span>],<span class="at">bw=</span>bwD0,<span class="at">kernel=</span>kernel)    </span>
<span id="cb164-15"><a href="NE.html#cb164-15" tabindex="-1"></a>Pr.D1.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(Ds[S<span class="sc">==</span><span class="dv">1</span>],yB[S<span class="sc">==</span><span class="dv">1</span>],yB[S<span class="sc">==</span><span class="dv">1</span>],<span class="at">bw=</span>bwD1,<span class="at">kernel=</span>kernel)    </span></code></pre></div>
<p>Let’s now plot the resulting estimate:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="NE.html#cb165-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">5</span>))</span>
<span id="cb165-2"><a href="NE.html#cb165-2" tabindex="-1"></a><span class="fu">plot</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>],y0[Ds<span class="sc">==</span><span class="dv">0</span>],<span class="at">pch=</span><span class="dv">1</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xlab=</span><span class="st">&quot;yB&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;Outcomes&quot;</span>)</span>
<span id="cb165-3"><a href="NE.html#cb165-3" tabindex="-1"></a><span class="fu">points</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>],y[Ds<span class="sc">==</span><span class="dv">1</span>],<span class="at">pch=</span><span class="dv">3</span>,<span class="at">col=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb165-4"><a href="NE.html#cb165-4" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb165-5"><a href="NE.html#cb165-5" tabindex="-1"></a><span class="fu">legend</span>(<span class="dv">5</span>,<span class="fl">10.5</span>,<span class="fu">c</span>(<span class="st">&#39;y0|D=0&#39;</span>,<span class="st">&#39;y1|D=1&#39;</span>,<span class="st">&#39;D&#39;</span>,<span class="st">&#39;Pr(D=1|S=1,yB)&#39;</span>,<span class="st">&#39;Pr(D=1|S=0,yB)&#39;</span>),<span class="at">pch=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>),<span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>,<span class="st">&#39;black&#39;</span>,<span class="st">&#39;red&#39;</span>,<span class="st">&#39;red&#39;</span>,<span class="st">&#39;red&#39;</span>),<span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb165-6"><a href="NE.html#cb165-6" tabindex="-1"></a><span class="fu">par</span>(<span class="at">new=</span><span class="cn">TRUE</span>)</span>
<span id="cb165-7"><a href="NE.html#cb165-7" tabindex="-1"></a><span class="fu">plot</span>(yB,Ds,<span class="at">pch=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">&#39;red&#39;</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>),<span class="at">xaxt=</span><span class="st">&quot;n&quot;</span>,<span class="at">yaxt=</span><span class="st">&quot;n&quot;</span>,<span class="at">xlab=</span><span class="st">&quot;&quot;</span>,<span class="at">ylab=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb165-8"><a href="NE.html#cb165-8" tabindex="-1"></a><span class="fu">points</span>(yB[S<span class="sc">==</span><span class="dv">0</span>],Pr.D0.llr,<span class="at">col=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb165-9"><a href="NE.html#cb165-9" tabindex="-1"></a><span class="fu">points</span>(yB[S<span class="sc">==</span><span class="dv">1</span>],Pr.D1.llr,<span class="at">col=</span><span class="st">&#39;red&#39;</span>,<span class="at">pch=</span><span class="dv">3</span>)</span>
<span id="cb165-10"><a href="NE.html#cb165-10" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">4</span>)</span>
<span id="cb165-11"><a href="NE.html#cb165-11" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">&quot;D&quot;</span>,<span class="at">side=</span><span class="dv">4</span>,<span class="at">line=</span><span class="dv">3</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotFuzzyRDDCondExp"></span>
<img src="STCI_files/figure-html/PlotFuzzyRDDCondExp-1.png" alt="Fuzzy RDD with probability of being treated as a function of the running variable" width="65%" />
<p class="caption">
Figure 4.14: Fuzzy RDD with probability of being treated as a function of the running variable
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotFuzzyRDD">4.13</a> now clearly shows that the probability of receiving the treatment decreases discontinuously when crossing the threshold <span class="math inline">\(\bar{y}\)</span>.
The decrease is not a move from <span class="math inline">\(1\)</span> to <span class="math inline">\(0\)</span> and hence is a clear case of a Fuzzy Regression Discontinuity Design.</p>
<p>Identification in a Fuzzy Regression Discontinuity Design proceeds along the same lines as with Instrumental Variables: either we assume that treatment effects are somewhat independent from Types or we impose that there are no defiers (though some more options are feasible, as we saw in the section on Instrumental Variables).</p>
<div id="identification-under-independence-of-treatment-effects-from-types" class="section level5 hasAnchor" number="4.2.2.1.1">
<h5><span class="header-section-number">4.2.2.1.1</span> Identification under Independence of treatment effects from Types<a href="NE.html#identification-under-independence-of-treatment-effects-from-types" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Let us first define the types in a Fuzzy Regression Discontinuity Design.
For that, we define <span class="math inline">\(D_i(z)\)</span> as the potential outcome of individual <span class="math inline">\(i\)</span> when <span class="math inline">\(Z_i=z\)</span>.
We have (as seems natural now) four possible types of individuals depending on how they react when exogenously moved from one side of the threshold to the other:</p>
<ul>
<li><strong>Always takers</strong> (<span class="math inline">\(T^{\bar{z}}_i=a\)</span>) are such that <span class="math inline">\(\lim_{z\rightarrow \bar{z}^+}D_i(z)=\lim_{z\rightarrow \bar{z}^-}D_i(z)=1\)</span>.</li>
<li><strong>Never takers</strong> (<span class="math inline">\(T^{\bar{z}}_i=n\)</span>) are such that <span class="math inline">\(\lim_{z\rightarrow \bar{z}^+}D_i(z)=\lim_{z\rightarrow \bar{z}^-}D_i(z)=0\)</span>.</li>
<li><strong>Compliers</strong> (<span class="math inline">\(T^{\bar{z}}_i=c\)</span>) are such that <span class="math inline">\(\lim_{z\rightarrow \bar{z}^+}D_i(z)-\lim_{z\rightarrow \bar{z}^-}D_i(z)=1\)</span>.</li>
<li><strong>Defiers</strong> (<span class="math inline">\(T^{\bar{z}}_i=d\)</span>) are such that <span class="math inline">\(\lim_{z\rightarrow \bar{z}^+}D_i(z)-\lim_{z\rightarrow \bar{z}^-}D_i(z)=-1\)</span>.</li>
</ul>
<p>We can now encode the assumption of independent treatment effects:</p>
<div class="hypothesis">
<p><span id="hyp:IndTERDD" class="hypothesis"><strong>Hypothesis 4.10  (Independence of Treatment Effects from Types) </strong></span>We assume that treatment effects are independent of Types at the discontinuity:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_i\Ind T^{\bar{z}}_i|Z_i=z.
\end{align*}\]</span></p>
</div>
<p>We are now equipped to prove identification in the Fuzzy Regression Discontinuity Design under Independence of Treatment Effects from Types:</p>
<div class="theorem">
<p><span id="thm:IdentFRDDIndep" class="theorem"><strong>Theorem 4.6  (Identification of TT(z) in Fuzzy RDD under Independence) </strong></span>Under Assumptions <a href="NE.html#hyp:ContinuousOutcomes">4.8</a> and <a href="NE.html#hyp:IndTERDD">4.10</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{RDDWALD} &amp; = \Delta^Y_{TT}(z),
\end{align*}\]</span></p>
<p>with</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{RDDWALD} &amp; = \frac{\lim_{e\rightarrow 0^{+}}\esp{Y_i|Z_i=\bar{z}-e}
                                    - \lim_{e\rightarrow 0^{+}}\esp{Y_i|Z_i=\bar{z}+e}}
                                      {\lim_{e\rightarrow 0^{+}}\Pr(D_i=1|Z_i=\bar{z}-e)
                                      - \lim_{e\rightarrow 0^{+}}\Pr(D_i=1|Z_i=\bar{z}+e)}
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-92" class="proof"><em>Proof</em>. </span>Using the switching equation and Assumption <a href="NE.html#hyp:ContinuousOutcomes">4.8</a>, we can decompose the numerator of the Local Wald estimator as follows:</p>
<p><span class="math display">\[\begin{align*}
  \lim_{z\rightarrow \bar{z}^+}\esp{Y_i|Z_i=z}&amp;=\esp{Y_i^1|Z_i=\bar{z},T^{\bar{z}}_i=a}\Pr(T_i=a|Z_i=\bar{z})\\
            &amp; \phantom{=}+\esp{Y_i^1|Z_i=\bar{z},T^{\bar{z}}_i=c}\Pr(T_i=c|Z_i=\bar{z})\\
                &amp; \phantom{=}+\esp{Y_i^0|Z_i=\bar{z},T^{\bar{z}}_i=d}\Pr(T_i=d|Z_i=\bar{z})\\
                &amp; \phantom{=}+\esp{Y_i^0|Z_i=\bar{z},T^{\bar{z}}_i=n}\Pr(T_i=n|Z_i=\bar{z})\\
  \lim_{z\rightarrow \bar{z}^-}\esp{Y_i|Z_i=z}&amp;=\esp{Y_i^1|Z_i=\bar{z},T^{\bar{z}}_i=a}\Pr(T_i=a|Z_i=\bar{z})\\
                &amp; \phantom{=}+\esp{Y_i^0|Z_i=\bar{z},T^{\bar{z}}_i=c}\Pr(T_i=c|Z_i=\bar{z})\\
                &amp; \phantom{=}+\esp{Y_i^1|Z_i=\bar{z},T^{\bar{z}}_i=d}\Pr(T_i=d|Z_i=\bar{z})\\
                &amp; \phantom{=}+\esp{Y_i^0|Z_i=\bar{z},T^{\bar{z}}_i=n}\Pr(T_i=n|Z_i=\bar{z})\\
  N_{\bar{z}}&amp;= \lim_{e\rightarrow 0^{+}}\esp{Y_i|Z_i=\bar{z}-e}- \lim_{e\rightarrow 0^{+}}\esp{Y_i|Z_i=\bar{z}+e}\\
          &amp; = \esp{Y_i^1-Y_i^0|Z_i=\bar{z},T^{\bar{z}}_i=c}\Pr(T_i=c|Z_i=\bar{z})\\
                    &amp; \phantom{=}-\esp{Y_i^1-Y_i^0|Z_i=\bar{z},T^{\bar{z}}_i=d}\Pr(T_i=d|Z_i=\bar{z})           
\end{align*}\]</span></p>
<p>We also have that the denominator of the Local Wald estimator is equal to:</p>
<p><span class="math display">\[\begin{align*}
  D_{\bar{z}}&amp; =\lim_{z\rightarrow \bar{z}^+}\Pr(D_i=1|Z_i=z)-\lim_{z\rightarrow \bar{z}^-}\Pr(D_i=1|Z_i=z)\\
                    &amp; = \lim_{z\rightarrow \bar{z}^+}\left(\Pr(T_i^z=a|Z_i=z)+\Pr(T_i^z=c|Z_i=z)\right)\\
                    &amp; \phantom{=}-\lim_{z\rightarrow \bar{z}^-}\left(\Pr(T_i^z=a|Z_i=z)+\Pr(T_i^z=d|Z_i=z)\right)\\
                    &amp; = \Pr(T_i^{\bar{z}}=c|Z_i=\bar{z})-\Pr(T_i^{\bar{z}}=d|Z_i=\bar{z})
\end{align*}\]</span></p>
<p>Under Assumption <a href="NE.html#hyp:IndTERDD">4.10</a>, we have that <span class="math inline">\(\esp{Y_i^1-Y_i^0|Z_i=\bar{z},T^{\bar{z}}_i=c}=\esp{Y_i^1-Y_i^0|Z_i=\bar{z},T^{\bar{z}}_i=d}=\esp{Y_i^1-Y_i^0|Z_i=\bar{z}}\)</span>.
This proves the result.</p>
</div>
</div>
<div id="identification-under-monotonicity" class="section level5 hasAnchor" number="4.2.2.1.2">
<h5><span class="header-section-number">4.2.2.1.2</span> Identification under Monotonicity<a href="NE.html#identification-under-monotonicity" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We can weaken Assumption <a href="NE.html#hyp:IndTERDD">4.10</a> and allow for treatment effects correlated with types (which seems highly likely) if we are willing to make stronger assumptions on the distribution of types.
As we have seen before with Instrumental Variables, assuming away defiers enables the identification of a Local Average Treatment Effect.
Let’s see how this works:</p>
<div class="hypothesis">
<p><span id="hyp:MonoRDD" class="hypothesis"><strong>Hypothesis 4.11  (Monotonicity in a Fuzzy Regression Discontinuity Design) </strong></span><span class="math inline">\(D_i(z)\)</span> is non-decreasing at <span class="math inline">\(z=\bar{z}\)</span> (or <span class="math inline">\(\Pr(T^{\bar{z}}_i=d|Z_i=\bar{z})=0\)</span>).</p>
</div>
<p>We can now prove identification of the local average treatment effect:</p>
<div class="theorem">
<p><span id="thm:IdentFRDDMono" class="theorem"><strong>Theorem 4.7  (Identification of TT(z) in Fuzzy RDD under Monotonicity) </strong></span>Under Assumptions <a href="NE.html#hyp:ContinuousOutcomes">4.8</a> and <a href="NE.html#hyp:MonoRDD">4.11</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{RDDWALD} &amp; = \Delta^Y_{LATE}(z),
\end{align*}\]</span></p>
<p>with</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{LATE}(z) &amp; = \esp{y_i^1-Y_i^0|T_i^{\bar{z}}=c,Z_i=\bar{z}}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-93" class="proof"><em>Proof</em>. </span>The proof essentially follows the proof of Theorem <a href="NE.html#thm:IdentFRDDIndep">4.6</a> up to its penultimate step.
Under Assumption <a href="NE.html#hyp:MonoRDD">4.11</a>, we have that <span class="math inline">\(\Pr(T^{\bar{z}}_i=d|Z_i=\bar{z})=0\)</span>.
This proves the result.</p>
</div>
</div>
</div>
<div id="estimation-1" class="section level4 hasAnchor" number="4.2.2.2">
<h4><span class="header-section-number">4.2.2.2</span> Estimation<a href="NE.html#estimation-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>For estimation, we can either use the Local Linear Regression Wald estimator or use a simplified version proposed by Imbens and Lemieux (2008).
Let’s see how both of them work in practice.</p>
<div id="estimation-using-local-linear-regression-1" class="section level5 hasAnchor" number="4.2.2.2.1">
<h5><span class="header-section-number">4.2.2.2.1</span> Estimation using Local Linear Regression<a href="NE.html#estimation-using-local-linear-regression-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The Wald LLR estimator can be formed as follows, with <span class="math inline">\(S_i=1\)</span> when <span class="math inline">\(Z_i\geq\bar{z}\)</span> and <span class="math inline">\(S_i=0\)</span> when <span class="math inline">\(Z_i&lt;\bar{z}\)</span> (in the case where <span class="math inline">\(\lim_{e\rightarrow 0^{+}}\Pr(D_i=1|Z_i=\bar{z}-e) &lt; \lim_{e\rightarrow 0^{+}}\Pr(D_i=1|Z_i=\bar{z}+e))\)</span> (simply revert the values of <span class="math inline">\(S_i\)</span> if the converse is true)):</p>
<ul>
<li>Estimate <span class="math inline">\(\hatesp{Y^1_i|S_i=1,Z_i=\bar{z}}\)</span> and <span class="math inline">\(\hatesp{D_i|S_i=1,Z_i=\bar{z}}\)</span> using LLR on the right of <span class="math inline">\(\bar{z}\)</span>.</li>
<li>Estimate <span class="math inline">\(\hatesp{Y^0_i|S_i=0,Z_i=\bar{z}}\)</span> and <span class="math inline">\(\hatesp{D_i|S_i=0,Z_i=\bar{z}}\)</span> using LLR on the left of <span class="math inline">\(\bar{z}\)</span>.</li>
<li><span class="math inline">\(\hat\Delta^{Y}_{WaldRDDLLR}=\frac{\hatesp{Y^1_i|S_i=1,Z_i=\bar{z}}-\hatesp{Y^0_i|S_i=0,Z_i=\bar{z}}}{\hatesp{D_i|S_i=1,Z_i=\bar{z}}-\hatesp{D_i|S_i=0,Z_i=\bar{z}}}\)</span>.</li>
<li>For bandwidth choice: use cross-validation for each estimation.</li>
</ul>
<div class="example">
<p><span id="exm:unnamed-chunk-178" class="example"><strong>Example 4.22  </strong></span>Let’s see how this works in our example.
Note that we have to revert the definition of <span class="math inline">\(S_i\)</span> since the highest treatment probability is below <span class="math inline">\(\bar{y}\)</span>.</p>
</div>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="NE.html#cb166-1" tabindex="-1"></a><span class="co"># bandwidth choice</span></span>
<span id="cb166-2"><a href="NE.html#cb166-2" tabindex="-1"></a>MSE.llr.S0 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(MSE.grid,MSE.llr,<span class="at">y=</span>y,<span class="at">D=</span>S,<span class="at">x=</span>yB,<span class="at">kernel=</span>kernel,<span class="at">d=</span><span class="dv">0</span>)</span>
<span id="cb166-3"><a href="NE.html#cb166-3" tabindex="-1"></a>MSE.llr.S1 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(MSE.grid,MSE.llr,<span class="at">y=</span>y,<span class="at">D=</span>S,<span class="at">x=</span>yB,<span class="at">kernel=</span>kernel,<span class="at">d=</span><span class="dv">1</span>)</span>
<span id="cb166-4"><a href="NE.html#cb166-4" tabindex="-1"></a>bwyS0 <span class="ot">&lt;-</span> MSE.grid[MSE.llr.S0<span class="sc">==</span><span class="fu">min</span>(MSE.llr.S0)]</span>
<span id="cb166-5"><a href="NE.html#cb166-5" tabindex="-1"></a>bwyS1 <span class="ot">&lt;-</span> MSE.grid[MSE.llr.S1<span class="sc">==</span><span class="fu">min</span>(MSE.llr.S1)]</span>
<span id="cb166-6"><a href="NE.html#cb166-6" tabindex="-1"></a></span>
<span id="cb166-7"><a href="NE.html#cb166-7" tabindex="-1"></a><span class="co"># LLR estimation</span></span>
<span id="cb166-8"><a href="NE.html#cb166-8" tabindex="-1"></a>y.S0.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[S<span class="sc">==</span><span class="dv">0</span>],yB[S<span class="sc">==</span><span class="dv">0</span>],yB[S<span class="sc">==</span><span class="dv">0</span>],<span class="at">bw=</span>bwyS0,<span class="at">kernel=</span>kernel)    </span>
<span id="cb166-9"><a href="NE.html#cb166-9" tabindex="-1"></a>y.S1.llr <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[S<span class="sc">==</span><span class="dv">1</span>],yB[S<span class="sc">==</span><span class="dv">1</span>],yB[S<span class="sc">==</span><span class="dv">1</span>],<span class="at">bw=</span>bwyS1,<span class="at">kernel=</span>kernel)    </span>
<span id="cb166-10"><a href="NE.html#cb166-10" tabindex="-1"></a></span>
<span id="cb166-11"><a href="NE.html#cb166-11" tabindex="-1"></a><span class="co"># Wald estimator</span></span>
<span id="cb166-12"><a href="NE.html#cb166-12" tabindex="-1"></a>Pr.D0.llr.ybar <span class="ot">&lt;-</span> <span class="fu">llr</span>(Ds[S<span class="sc">==</span><span class="dv">0</span>],yB[S<span class="sc">==</span><span class="dv">0</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>bwD0,<span class="at">kernel=</span>kernel)    </span>
<span id="cb166-13"><a href="NE.html#cb166-13" tabindex="-1"></a>Pr.D1.llr.ybar <span class="ot">&lt;-</span> <span class="fu">llr</span>(Ds[S<span class="sc">==</span><span class="dv">1</span>],yB[S<span class="sc">==</span><span class="dv">1</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>bwD1,<span class="at">kernel=</span>kernel)    </span>
<span id="cb166-14"><a href="NE.html#cb166-14" tabindex="-1"></a>y.S0.llr.ybar <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[S<span class="sc">==</span><span class="dv">0</span>],yB[S<span class="sc">==</span><span class="dv">0</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>bwyS0,<span class="at">kernel=</span>kernel)    </span>
<span id="cb166-15"><a href="NE.html#cb166-15" tabindex="-1"></a>y.S1.llr.ybar <span class="ot">&lt;-</span> <span class="fu">llr</span>(y[S<span class="sc">==</span><span class="dv">1</span>],yB[S<span class="sc">==</span><span class="dv">1</span>],<span class="fu">c</span>(<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])),<span class="at">bw=</span>bwyS1,<span class="at">kernel=</span>kernel)    </span>
<span id="cb166-16"><a href="NE.html#cb166-16" tabindex="-1"></a>num.Wald.RDD.llr <span class="ot">&lt;-</span> y.S1.llr.ybar<span class="sc">-</span>y.S0.llr.ybar</span>
<span id="cb166-17"><a href="NE.html#cb166-17" tabindex="-1"></a>denom.Wald.RDD.llr <span class="ot">&lt;-</span> Pr.D1.llr.ybar<span class="sc">-</span>Pr.D0.llr.ybar</span>
<span id="cb166-18"><a href="NE.html#cb166-18" tabindex="-1"></a>wald.rdd.llr <span class="ot">&lt;-</span> (num.Wald.RDD.llr)<span class="sc">/</span>(denom.Wald.RDD.llr)</span></code></pre></div>
<p>Let us now plot the resulting estimate:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotFuzzyRDDYD"></span>
<img src="STCI_files/figure-html/PlotFuzzyRDDYD-1.png" alt="Fuzzy RDD estimation with LLR" width="65%" />
<p class="caption">
Figure 4.15: Fuzzy RDD estimation with LLR
</p>
</div>
<p>It is difficult to see the reduced form estimate on Figure <a href="NE.html#fig:PlotFuzzyRDDYD">4.15</a>.
The numerator of the Wald estimator is equal to 0.1.
The Wald estimator of our local average treatment effect is equal to 0.12.
The true value of our target parameter (the average treatment effect on the complier at <span class="math inline">\(y_i^B=\bar{y}\)</span>) is equal to 0.18, which is the same value as in our example with the Sharp RDD, since the added noise in the participation equation, <span class="math inline">\(V_i\)</span>, is independent from potential outcomes, and thus, Assumption <a href="NE.html#hyp:IndTERDD">4.10</a> holds in our example.</p>
<div class="remark">
<p><span id="unlabeled-div-94" class="remark"><em>Remark</em>. </span>Making <span class="math inline">\(V_i\)</span> correlated with <span class="math inline">\(\eta_i\)</span> or <span class="math inline">\(\mu_i\)</span> in our example would generate a model in which treatment effects are not independent from types (<em>i.e.</em> Assumption <a href="NE.html#hyp:IndTERDD">4.10</a> would not hold).
LATE would be different from the treatment on the treated parameter.
The formula for the LATE would be: <span class="math inline">\(\Delta^Y_{LATE}(z)=\esp{\alpha_i|yi^B=\bar{y},V_i=0}\)</span>.
The proof is left as an exercise.</p>
</div>
</div>
<div id="estimation-using-the-simplified-iv-estimator-of-imbens-and-lemieux" class="section level5 hasAnchor" number="4.2.2.2.2">
<h5><span class="header-section-number">4.2.2.2.2</span> Estimation using the simplified IV estimator of Imbens and Lemieux<a href="NE.html#estimation-using-the-simplified-iv-estimator-of-imbens-and-lemieux" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407607001091">Imbens and Lemieux (2008)</a> propose the following simplified version of the WALD LLR estimator:
<span class="math inline">\(\hat{\delta}\)</span> estimated by 2SLS using <span class="math inline">\(\uns{Z_i\leq\bar{z}}\)</span> as an instrument on the sample of observations such as <span class="math inline">\(\bar{z}-h\leq Z_i\leq\bar{z}+h\)</span> is an estimate of <span class="math inline">\(LATE(z)\)</span>:</p>
<p><span class="math display">\[\begin{align*}
  Y_i &amp; = \alpha + \beta (Z_i-\bar{z})\uns{Z_i\leq\bar{z}} + \gamma(Z_i-\bar{z})\uns{Z_i&gt;\bar{z}} + \delta D_i + \epsilon_i
\end{align*}\]</span></p>
<p>It is actually equal to the Wald LLR estimate with uniform kernel and identical bandwidth on each side of the threshold.
The bandwidth can be chosen as to be the minimum of the four LLR bandwidths.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-180" class="example"><strong>Example 4.23  </strong></span>Let’s see how this works in our example.</p>
</div>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="NE.html#cb167-1" tabindex="-1"></a>bw <span class="ot">&lt;-</span> <span class="fu">min</span>(bwD0,bwD1,bwyS0,bwyS1)</span>
<span id="cb167-2"><a href="NE.html#cb167-2" tabindex="-1"></a><span class="co">#bw &lt;- 0.4</span></span>
<span id="cb167-3"><a href="NE.html#cb167-3" tabindex="-1"></a></span>
<span id="cb167-4"><a href="NE.html#cb167-4" tabindex="-1"></a>y.h <span class="ot">&lt;-</span> y[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb167-5"><a href="NE.html#cb167-5" tabindex="-1"></a>Ds.h <span class="ot">&lt;-</span> Ds[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb167-6"><a href="NE.html#cb167-6" tabindex="-1"></a>yB.l <span class="ot">&lt;-</span> (yB[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]<span class="sc">-</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))<span class="sc">*</span>S[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb167-7"><a href="NE.html#cb167-7" tabindex="-1"></a>yB.r <span class="ot">&lt;-</span> (yB[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]<span class="sc">-</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>S[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw])</span>
<span id="cb167-8"><a href="NE.html#cb167-8" tabindex="-1"></a>S.h <span class="ot">&lt;-</span> S[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb167-9"><a href="NE.html#cb167-9" tabindex="-1"></a></span>
<span id="cb167-10"><a href="NE.html#cb167-10" tabindex="-1"></a>reg.fuzzy.rdd.local.iv <span class="ot">&lt;-</span> <span class="fu">ivreg</span>(y.h  <span class="sc">~</span> Ds.h <span class="sc">+</span> yB.l <span class="sc">+</span> yB.r <span class="sc">|</span> S.h <span class="sc">+</span> yB.l <span class="sc">+</span> yB.r)</span>
<span id="cb167-11"><a href="NE.html#cb167-11" tabindex="-1"></a>delta.rdd.fuzzy.il <span class="ot">&lt;-</span> reg.fuzzy.rdd.local.iv<span class="sc">$</span>coef[<span class="dv">2</span>]</span>
<span id="cb167-12"><a href="NE.html#cb167-12" tabindex="-1"></a>delta.y.tt.rdd.fuzzy <span class="ot">&lt;-</span> <span class="fu">delta.y.tt.z</span>(param)</span></code></pre></div>
<p>With this estimator and using the minimum of the four bandwidths, we estimate the effect of the treatment to be equal to 0.15, while the true effect in the population is equal to 0.18.</p>
<p>Let’s see how this estimator behaves around sampling replications:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="NE.html#cb168-1" tabindex="-1"></a>monte.carlo.fuzzy.rdd.llr.bw <span class="ot">&lt;-</span> <span class="cf">function</span>(s,N,param,bw){</span>
<span id="cb168-2"><a href="NE.html#cb168-2" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb168-3"><a href="NE.html#cb168-3" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb168-4"><a href="NE.html#cb168-4" tabindex="-1"></a>  UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb168-5"><a href="NE.html#cb168-5" tabindex="-1"></a>  yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb168-6"><a href="NE.html#cb168-6" tabindex="-1"></a>  YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb168-7"><a href="NE.html#cb168-7" tabindex="-1"></a>  Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb168-8"><a href="NE.html#cb168-8" tabindex="-1"></a>  V <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">+</span>param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb168-9"><a href="NE.html#cb168-9" tabindex="-1"></a>  Ds[((yB<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])) <span class="sc">&amp;</span> (V<span class="sc">&lt;=</span>param[<span class="st">&quot;kappa&quot;</span>])) <span class="sc">|</span> ((yB<span class="sc">&gt;</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])) <span class="sc">&amp;</span> (V<span class="sc">&gt;</span>param[<span class="st">&quot;kappa&quot;</span>])) ] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb168-10"><a href="NE.html#cb168-10" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb168-11"><a href="NE.html#cb168-11" tabindex="-1"></a>  eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb168-12"><a href="NE.html#cb168-12" tabindex="-1"></a>  U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb168-13"><a href="NE.html#cb168-13" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>] <span class="sc">+</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(yB<span class="sc">-</span>param[<span class="st">&quot;baryB&quot;</span>])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb168-14"><a href="NE.html#cb168-14" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb168-15"><a href="NE.html#cb168-15" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb168-16"><a href="NE.html#cb168-16" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb168-17"><a href="NE.html#cb168-17" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb168-18"><a href="NE.html#cb168-18" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb168-19"><a href="NE.html#cb168-19" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb168-20"><a href="NE.html#cb168-20" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(yB<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb168-21"><a href="NE.html#cb168-21" tabindex="-1"></a>  y.h <span class="ot">&lt;-</span> y[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb168-22"><a href="NE.html#cb168-22" tabindex="-1"></a>  Ds.h <span class="ot">&lt;-</span> Ds[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb168-23"><a href="NE.html#cb168-23" tabindex="-1"></a>  yB.l <span class="ot">&lt;-</span> (yB[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]<span class="sc">-</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))<span class="sc">*</span>Z[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb168-24"><a href="NE.html#cb168-24" tabindex="-1"></a>  yB.r <span class="ot">&lt;-</span> (yB[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]<span class="sc">-</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Z[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw])</span>
<span id="cb168-25"><a href="NE.html#cb168-25" tabindex="-1"></a>  Z.h <span class="ot">&lt;-</span> Z[<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">-</span>bw<span class="sc">&lt;</span>yB <span class="sc">&amp;</span> yB<span class="sc">&lt;</span><span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>])<span class="sc">+</span>bw]</span>
<span id="cb168-26"><a href="NE.html#cb168-26" tabindex="-1"></a>  reg.fuzzy.rdd.local.iv <span class="ot">&lt;-</span> <span class="fu">ivreg</span>(y.h  <span class="sc">~</span> Ds.h <span class="sc">+</span> yB.l <span class="sc">+</span> yB.r <span class="sc">|</span> Z.h <span class="sc">+</span> yB.l <span class="sc">+</span> yB.r)</span>
<span id="cb168-27"><a href="NE.html#cb168-27" tabindex="-1"></a>  delta.rdd.fuzzy.il <span class="ot">&lt;-</span> reg.fuzzy.rdd.local.iv<span class="sc">$</span>coef[<span class="dv">2</span>]</span>
<span id="cb168-28"><a href="NE.html#cb168-28" tabindex="-1"></a>  <span class="fu">return</span>(delta.rdd.fuzzy.il)</span>
<span id="cb168-29"><a href="NE.html#cb168-29" tabindex="-1"></a>}</span>
<span id="cb168-30"><a href="NE.html#cb168-30" tabindex="-1"></a></span>
<span id="cb168-31"><a href="NE.html#cb168-31" tabindex="-1"></a>simuls.fuzzy.rdd.llr.bw.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param,bw){</span>
<span id="cb168-32"><a href="NE.html#cb168-32" tabindex="-1"></a>  simuls.fuzzy.rdd.llr.bw <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.fuzzy.rdd.llr.bw,<span class="at">N=</span>N,<span class="at">param=</span>param,<span class="at">bw=</span>bw)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb168-33"><a href="NE.html#cb168-33" tabindex="-1"></a>  <span class="fu">colnames</span>(simuls.fuzzy.rdd.llr.bw) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDD LLR&#39;</span>)</span>
<span id="cb168-34"><a href="NE.html#cb168-34" tabindex="-1"></a>  <span class="fu">return</span>(simuls.fuzzy.rdd.llr.bw)</span>
<span id="cb168-35"><a href="NE.html#cb168-35" tabindex="-1"></a>}</span>
<span id="cb168-36"><a href="NE.html#cb168-36" tabindex="-1"></a></span>
<span id="cb168-37"><a href="NE.html#cb168-37" tabindex="-1"></a>sf.simuls.fuzzy.rdd.llr.bw.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param,bw){</span>
<span id="cb168-38"><a href="NE.html#cb168-38" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span><span class="dv">8</span>)</span>
<span id="cb168-39"><a href="NE.html#cb168-39" tabindex="-1"></a>  <span class="fu">sfExport</span>(<span class="st">&#39;llr&#39;</span>,<span class="st">&#39;MSE.llr&#39;</span>,<span class="st">&#39;param&#39;</span>)</span>
<span id="cb168-40"><a href="NE.html#cb168-40" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(AER)</span>
<span id="cb168-41"><a href="NE.html#cb168-41" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.fuzzy.rdd.llr.bw,<span class="at">N=</span>N,<span class="at">param=</span>param,<span class="at">bw=</span>bw)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb168-42"><a href="NE.html#cb168-42" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb168-43"><a href="NE.html#cb168-43" tabindex="-1"></a>  <span class="fu">colnames</span>(sim) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;RDD LLR&#39;</span>)</span>
<span id="cb168-44"><a href="NE.html#cb168-44" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb168-45"><a href="NE.html#cb168-45" tabindex="-1"></a>}</span>
<span id="cb168-46"><a href="NE.html#cb168-46" tabindex="-1"></a></span>
<span id="cb168-47"><a href="NE.html#cb168-47" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb168-48"><a href="NE.html#cb168-48" tabindex="-1"></a><span class="co">#Nsim &lt;- 10</span></span>
<span id="cb168-49"><a href="NE.html#cb168-49" tabindex="-1"></a>N.sample <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">1000</span>,<span class="dv">10000</span>,<span class="dv">100000</span>)</span>
<span id="cb168-50"><a href="NE.html#cb168-50" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000)</span></span>
<span id="cb168-51"><a href="NE.html#cb168-51" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000)</span></span>
<span id="cb168-52"><a href="NE.html#cb168-52" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100)</span></span>
<span id="cb168-53"><a href="NE.html#cb168-53" tabindex="-1"></a></span>
<span id="cb168-54"><a href="NE.html#cb168-54" tabindex="-1"></a>simuls.fuzzy.rdd.llr.bw <span class="ot">&lt;-</span> <span class="fu">lapply</span>(N.sample,sf.simuls.fuzzy.rdd.llr.bw.N,<span class="at">Nsim=</span>Nsim,<span class="at">param=</span>param,<span class="at">bw=</span>bw)</span>
<span id="cb168-55"><a href="NE.html#cb168-55" tabindex="-1"></a><span class="fu">names</span>(simuls.fuzzy.rdd.llr.bw) <span class="ot">&lt;-</span> N.sample</span></code></pre></div>
<p>Let’s plot the resulting estimates:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="NE.html#cb169-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb169-2"><a href="NE.html#cb169-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simuls.fuzzy.rdd.llr.bw)){</span>
<span id="cb169-3"><a href="NE.html#cb169-3" tabindex="-1"></a>  <span class="fu">hist</span>(simuls.fuzzy.rdd.llr.bw[[i]][,<span class="st">&#39;RDD LLR&#39;</span>],<span class="at">breaks=</span><span class="dv">30</span>,<span class="at">main=</span><span class="fu">paste</span>(<span class="st">&#39;N=&#39;</span>,<span class="fu">as.character</span>(N.sample[i])),<span class="at">xlab=</span><span class="fu">expression</span>(<span class="fu">hat</span>(Delta<span class="sc">^</span>yIVRDDLLR)),<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.15</span>,<span class="fl">0.55</span>))</span>
<span id="cb169-4"><a href="NE.html#cb169-4" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v=</span><span class="fu">delta.y.tt.z</span>(param),<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb169-5"><a href="NE.html#cb169-5" tabindex="-1"></a>}</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:MCHistWaldLLRRDD"></span>
<img src="STCI_files/figure-html/MCHistWaldLLRRDD-1.png" alt="Distribution of the $IV RDD LLR$ estimator over replications of samples of different sizes" width="65%" />
<p class="caption">
Figure 4.16: Distribution of the <span class="math inline">\(IV RDD LLR\)</span> estimator over replications of samples of different sizes
</p>
</div>
</div>
</div>
<div id="estimation-of-sampling-noise-1" class="section level4 hasAnchor" number="4.2.2.3">
<h4><span class="header-section-number">4.2.2.3</span> Estimation of sampling noise<a href="NE.html#estimation-of-sampling-noise-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We can use several approaches to estimate the sampling noise of the Wald RDDLLR eestimator:</p>
<ul>
<li><a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1468-0262.00183">Hahn, Todd and van der Klaauw (2001)</a> derive general CLT results</li>
<li><a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407607001091">Imbens and Lemieux (2008)</a> simplify the CLT results and propose a plug-in estimator</li>
<li><a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407607001091">Imbens and Lemieux (2008)</a> propose to use the robust variance of the 2SLS estimator</li>
<li>Bootstrap should be valid.</li>
</ul>
<p>The following theorem derives the CLT-based variance of the simplified Wald RDDLLR estimator:</p>
<div class="theorem">
<p><span id="thm:AsymWaldRDDLLR" class="theorem"><strong>Theorem 4.8  (Asymptotic Variance of the LLR-IV Estimator) </strong></span>The variance of the simplified LLR-IV Estimator in a Fuzzy Design can be approximated by:</p>
<p><span class="math display">\[\begin{align*}
\var{\hat{\Delta}_{LLRRDDIV}} &amp; \approx \frac{1}{Nh}\left(\frac{1}{\tau^2_{D}}V_{\tau_Y}+\frac{\tau^2_{Y}}{\tau^4_{D}}V_{\tau_D}-2\frac{\tau_{Y}}{\tau^3_{D}}C_{\tau_Y,\tau_D}\right),
\end{align*}\]</span></p>
<p>with</p>
<p><span class="math display">\[\begin{align*}
\tau_{D} &amp; = \lim_{e\rightarrow 0^{+}}\esp{D_i|Z_i=\bar{z}+e}-\lim_{e\rightarrow 0^{+}}\esp{D_i|Z_i=\bar{z}-e}\\
V_{\tau_Y} &amp; = \frac{4}{f_Z(\bar{z})}\left(\sigma^2_{Y^r}+\sigma^2_{Y^l}\right) \qquad
V_{\tau_D}  = \frac{4}{f_Z(\bar{z})}\left(\sigma^2_{D^r}+\sigma^2_{D^l}\right)\\
C_{\tau_Y,\tau_D}&amp; = \frac{4}{f_Z(\bar{z})}\left(C_{YD^r}+C_{YD^l}\right) \qquad
\sigma^2_{Y^r}  = \lim_{e\rightarrow 0^{+}}\var{Y_i|Z_i=\bar{z}+e} \\
C_{YD^r} &amp; = \lim_{e\rightarrow 0^{+}}\cov{Y_i,D_i|Z_i=\bar{z}+e}
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-95" class="proof"><em>Proof</em>. </span><a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1468-0262.00183">Hahn, Todd and van der Klaauw (2001)</a> and <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407607001091">Imbens and Lemieux (2008)</a>.</p>
</div>
<p>Another way is tu simply use the robust standard errors from the 2SLS estimator.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-182" class="example"><strong>Example 4.24  </strong></span>Let’s see what happens with this estimator of sampling noise in our example.</p>
</div>
<p>The estimated 99% sampling noise the robust standard errors from the 2SLS estimator is 0.37.
The true 99% sampling noise of Wald RDDLLR estimated by Monte Carlo simulations is 0.39.</p>
</div>
</div>
</div>
<div id="DID" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Difference In Differences<a href="NE.html#DID" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In Difference In Differences (a.k.a. DID), the difference between treated and untreated before the treatment is used to approximate selection bias.
As a consequence, DID works by correcting the With/Without comparison after treatment by the With/Without comparison before treatment and hopes that it is enough to recover the TT.
Hence the name Difference in Differences (DID), since the estimator, in its simplest form, is a difference between two differences.
In this section, we are going to look at identification using DID, estimation and estimation of sampling noise.
At first, we are going to assume that we have only access to two time periods.
In that case, estimation and inference are pretty straightforward.
We will then examine the case of several time periods, but we will first allow for only one treatment date.
In that case, we will introduce the standard tools used by applied researchers to analyze these types of designs: the event study graph and the Two-Way Fixed Effects estimator (a.k.a. TWFE).
We will determine which effect is estimated by the TWFE estimator and what are the goals of the event study graph.
We will then look at the most complex case: the staggered design, where we have several time periods (strictly more than two) and the date of treatment differs across units.
In the staggered design, troubles start appearing for the TWFE estimator.
We will survey these problems and the proposed solutions to address them.
Finally, we will look at the combination of DID with instrumental variables (the DID-IV estimator) and see which specific types of problems happen there as well.
Let’s get to it.</p>
<div id="sec:DIDbasic" class="section level3 hasAnchor" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Difference In Differences with two time periods<a href="NE.html#sec:DIDbasic" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before getting into the rigorous derivations, let’s start with a very simple illustration using our workhorse example.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-183" class="example"><strong>Example 4.25  </strong></span>How does DID perform and what does it look like in our example model?</p>
</div>
<p>Let’s first generate a dataset with selection bias.</p>
<p><span class="math display">\[\begin{align*}
y_i^1 &amp; = y_i^0+\bar{\alpha}+\theta\mu_i+\eta_i \\
y_i^0 &amp; = \mu_i+\delta+U_i^0 \\
U_i^0 &amp; = \rho U_i^B+\epsilon_i \\
y_i^B &amp; =\mu_i+U_i^B \\
U_i^B &amp; \sim\mathcal{N}(0,\sigma^2_{U}) \\
\mu_i &amp; \sim\mathcal{N}(\bar{\mu},\sigma^2_{\mu}) \\
D_i   &amp; = \uns{y_i^B+ V_i\leq\bar{y}} \\
V_i   &amp; = \gamma(\mu_i-\bar{\mu}) + \omega_i \\
(\eta_i,\omega_i) &amp; \sim\mathcal{N}(0,0,\sigma^2_{\eta},\sigma^2_{\omega},\rho_{\eta,\omega})
\end{align*}\]</span></p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="NE.html#cb170-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">7.98</span>,<span class="fl">0.28</span>,<span class="dv">0</span>)</span>
<span id="cb170-2"><a href="NE.html#cb170-2" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,<span class="st">&quot;theta&quot;</span>,<span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;baralpha&quot;</span>,<span class="st">&quot;gamma&quot;</span>,<span class="st">&quot;baryB&quot;</span>,<span class="st">&quot;sigma2omega&quot;</span>,<span class="st">&quot;rhoetaomega&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="NE.html#cb171-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb171-2"><a href="NE.html#cb171-2" tabindex="-1"></a>N <span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb171-3"><a href="NE.html#cb171-3" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb171-4"><a href="NE.html#cb171-4" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb171-5"><a href="NE.html#cb171-5" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;eta&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb171-6"><a href="NE.html#cb171-6" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb171-7"><a href="NE.html#cb171-7" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb171-8"><a href="NE.html#cb171-8" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb171-9"><a href="NE.html#cb171-9" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb171-10"><a href="NE.html#cb171-10" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb171-11"><a href="NE.html#cb171-11" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb171-12"><a href="NE.html#cb171-12" tabindex="-1"></a>Ds[yB<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb171-13"><a href="NE.html#cb171-13" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb171-14"><a href="NE.html#cb171-14" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb171-15"><a href="NE.html#cb171-15" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb171-16"><a href="NE.html#cb171-16" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>eta</span>
<span id="cb171-17"><a href="NE.html#cb171-17" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb171-18"><a href="NE.html#cb171-18" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb171-19"><a href="NE.html#cb171-19" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb171-20"><a href="NE.html#cb171-20" tabindex="-1"></a>y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb171-21"><a href="NE.html#cb171-21" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span></code></pre></div>
<p>Let’s see how DID works on this data.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDID"></span>
<img src="STCI_files/figure-html/PlotDID-1.png" alt="Evolution of average outcomes in the treated and control group" width="50%" />
<p class="caption">
Figure 4.17: Evolution of average outcomes in the treated and control group
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDID">4.17</a> shows the evolution of the mean log-outcomes for the treated and untreated groups over time in our simulated dataset.
We can see that in the <strong>Before</strong> period, outcomes (<span class="math inline">\(y_i^B\)</span> in that case) are much higher for the non participants than for the participants, in agreement with the selection rule that makes participation into the program more likely for individuals with lower pre-treatment outcomes.
The With/Without difference in outcomes before the program takes place is <span class="math inline">\(\hat{\Delta}^{y^B}_{WW}=\)</span> -1.361.
Second, we see that the difference between participants and non-participants decreases after receiving the treatment.
This is because the outcomes of the participants increase faster than the outcomes of the non participants.
As a consequence, the With/Without difference in outcomes after the program takes place is <span class="math inline">\(\hat{\Delta}^{y}_{WW}=\)</span> -1.154.
The DID estimator is built by comparing these two differences.
In our example, <span class="math inline">\(\hat{\Delta}^{y}_{DID}=\)</span> 0.206.
It is not too far from the true treatment effect of <span class="math inline">\(\hat{\Delta}^{y}_{TT}=\)</span> 0.165.</p>
<p>Figure <a href="NE.html#fig:PlotDID">4.17</a> also demonstrates that the DID estimator can also be seen as the difference between the Before/After differences in outcomes of the treated and the untreated.
The Before/After difference in outcomes for the non participants is <span class="math inline">\(\hat{\Delta}^{y}_{BA|D=0}=\)</span> 0.046 while the Before/After difference for the participants is <span class="math inline">\(\hat{\Delta}^{y}_{BA|D=1}=\)</span> 0.252, leading to the same DID estimand.
One way to understand the DID estimator is to see it as recreating the counterfactual trajectory of the participants (show as a discontinuous line on Figure <a href="NE.html#fig:PlotDID">4.17</a>) by using the trajectory of the non participants and making it start at the pre-treatment level of the participants.
This estimated counterfactual trajectory is shown as the purple continuous line at the bottom of Figure <a href="NE.html#fig:PlotDID">4.17</a>.
In our example, the true counterfactual trajectory (the discontinuous line) and the estimated counterfactual trajectory almost coincide, making the estimated counterfactual outcome of the participants very close to their true counterfactual outcome (7.046 vs 7.087).
The difference between these two quantities measures the bias of the DID estimator, and we can see that it is very low in our example.
The fact that the Before/After difference in outcomes for the non participants approximates well the counterfactual Before/After difference in outcomes for the participants is <strong>THE</strong> crucial assumption of the DID estimator.
It is called the parallel trends assumption.</p>
<div id="identification-7" class="section level4 hasAnchor" number="4.3.1.1">
<h4><span class="header-section-number">4.3.1.1</span> Identification<a href="NE.html#identification-7" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The formal setting for introducing the DID estimator is to start with two time periods, <strong>Before</strong> and <strong>After</strong> (<span class="math inline">\(t=B\)</span> and <span class="math inline">\(t=A\)</span> respectively).
Outcomes with and without the treatment in both periods are denoted <span class="math inline">\(Y^d_{i,t}\)</span>, for <span class="math inline">\(d\in\left\{0,1\right\}\)</span> and <span class="math inline">\(t\in\left\{B,A\right\}\)</span>.
Treatment participation in both periods is denoted <span class="math inline">\(D_{i,t}\)</span> for <span class="math inline">\(t\in\left\{B,A\right\}\)</span>.
In the Before period, the treatment is unavailable, so that we get to observe the potential outcomes of the agents in the absence of the treatment.
These two very specific requirements of DID are encoded in the following way:</p>
<div class="hypothesis">
<p><span id="hyp:NoTreatmentFirst" class="hypothesis"><strong>Hypothesis 4.12  (No Treatment in the Before Period) </strong></span>We assume that no unit in the population receives the treatment in the Before period: <span class="math inline">\(D_{i,B}=0\)</span>, <span class="math inline">\(\forall i\)</span> and not all units receive the program in the After period, but some units receive it: <span class="math inline">\(0&lt;\Pr(D_{i,A}=1)&lt;1\)</span>.</p>
</div>
<p>Under Assumption <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, and without loss of generality, we are going to write <span class="math inline">\(D_i=D_{i,A}\)</span>.</p>
<div class="hypothesis">
<p><span id="hyp:NoAnticipationEffects" class="hypothesis"><strong>Hypothesis 4.13  (No Anticipation Effects) </strong></span>We assume that, in the Before period, agents cannot anticipate that the program will happen in the After period, or that they do not change their behavior as a consequence: <span class="math inline">\(Y_{i,B}=Y^0_{i,B}\)</span>, <span class="math inline">\(\forall i\)</span>.</p>
</div>
<p>A consequence of Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a> and <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> is that we can write observed outcomes as a function of treatment and potential outcomes using the usual switching equation:</p>
<p><span class="math display">\[\begin{align}\label{eqn:switchDID}
  Y_{i,t} &amp; = Y^1_{i,t}D_{i,t} + Y^0_{i,t}(1-D_{i,t}).
\end{align}\]</span></p>
<p>The final very important assumption that we can make is to assume that the trends in the potential outcomes in the absence the treatment are the same for the treated and the untreated units:</p>
<div class="hypothesis">
<p><span id="hyp:ParallelTrends" class="hypothesis"><strong>Hypothesis 4.14  (Parallel Trends) </strong></span>We assume that the trends in the potential outcomes in the absence the treatment are the same for the treated and the untreated units:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^0_{i,A}|D_i=1} - \esp{Y^0_{i,B}|D_i=1} &amp; =   \esp{Y^0_{i,A}|D_i=0} - \esp{Y^0_{i,B}|D_i=0}.
\end{align*}\]</span></p>
</div>
<p>Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a> is actually equivalent to assuming that selection bias is constant over time.
This is what this very simple lemma shows:</p>
<div class="lemma">
<p><span id="lem:ParallelTrendsCstSelectionBias" class="lemma"><strong>Lemma 4.3  (Parallel Trends is Constant Selection Bias) </strong></span>Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a> is equivalent to assuming that selection bias is constant over time:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^0_{i,A}|D_i=1} - \esp{Y^0_{i,A}|D_i=0} &amp; =   \esp{Y^0_{i,B}|D_i=1} - \esp{Y^0_{i,B}|D_i=0} .
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-96" class="proof"><em>Proof</em>. </span>The proof follows immediately by adding <span class="math inline">\(\esp{Y^0_{i,B}|D_i=1}-\esp{Y^0_{i,A}|D_i=0}\)</span> to both sides of the equation in Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>.</p>
</div>
<p>Under these assumptions, we are ready to state the main identification result of this section:</p>
<div class="theorem">
<p><span id="thm:IdentDID" class="theorem"><strong>Theorem 4.9  (DID identifies TT) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and <a href="NE.html#hyp:ParallelTrends">4.14</a>, the DID estimator identifies the average effect of the Treatment on the Treated after the treatment:</p>
<p><span class="math display">\[\begin{align*}
    \Delta_{DID}^{Y} &amp; =  \Delta^{Y_A}_{TT},
\end{align*}\]</span></p>
</div>
<p>with:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{DID} &amp; = \esp{Y_{i,A}|D_i=1} - \esp{Y_{i,B}|D_i=1} - (\esp{Y_{i,A}|D_i=0} - \esp{Y_{i,B}|D_i=0}),\\
  \Delta^{Y_A}_{TT} &amp; = \esp{Y^1_{i,A}-Y^0_{i,A}|D_{i}=1}.
\end{align*}\]</span></p>
<div class="proof">
<p><span id="unlabeled-div-97" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
  \Delta^Y_{DID} &amp; = \esp{Y_{i,A}|D_i=1}-\esp{Y_{i,B}|D_i=1}-(\esp{Y_{i,A}|D_i=0}-\esp{Y_{i,B}|D_i=0}) \\
                &amp; = \esp{Y^1_{i,A}|D_i=1}-\esp{Y^0_{i,B}|D_i=1}-(\esp{Y^0_{i,A}|D_i=0}-\esp{Y^0_{i,B}|D_i=0})\\
                &amp; = \esp{Y^1_{i,A}|D_i=1}-\left(\esp{Y^0_{i,A}|D_i=0}+(\esp{Y^0_{i,B}|D_i=1}-\esp{Y^0_{i,B}|D_i=0})\right)
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a> and <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and the switching equation, and the third equality follows from Lemma <a href="NE.html#lem:ParallelTrendsCstSelectionBias">4.3</a>.
Under Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
  \esp{Y^0_{i,A}|D_i=1} &amp; = \esp{Y^0_{i,A}|D_i=0} + (\esp{Y^0_{i,B}|D_i=1}-\esp{Y^0_{i,B}|D_i=0})
\end{align*}\]</span></p>
<p>As a consequence, we have:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{DID} &amp; = \esp{Y^1_{i,A}|D_i=1}-\esp{Y^0_{i,A}|D_i=1}\\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=1}\\
                &amp; = \Delta^{Y_A}_{TT}.
\end{align*}\]</span></p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-186" class="example"><strong>Example 4.26  </strong></span>How does the DID estimator behave in our example?</p>
</div>
<p>The Before/After comparison among the participants is equal to <span class="math inline">\(\hat{\Delta}^{y}_{BA|D=1}=\)</span> 0.252.
The Before/After comparison among the non-participants is equal to <span class="math inline">\(\hat{\Delta}^{y}_{BA|D=0}=\)</span> 0.046.
The DID estimator is thus equal to <span class="math inline">\(\hat{\Delta}^{y}_{DID}=\hat{\Delta}^{y}_{BA|D=1}-\hat{\Delta}^{y}_{BA|D=0}=\)</span> 0.252 <span class="math inline">\(-\)</span> 0.046 <span class="math inline">\(=\)</span> 0.206.
It is also equal to the difference between the before and after With/Without estimators.
The Before With/Without estimator is equal to <span class="math inline">\(\hat{\Delta}^{y^B}_{WW}=\)</span> -1.361.
The After With/Without estimator is equal to <span class="math inline">\(\hat{\Delta}^{y}_{WW}=\)</span> -1.154.
The DID estimator is thus equal to <span class="math inline">\(\hat{\Delta}^{y}_{DID}=\hat{\Delta}^{y}_{WW}-\hat{\Delta}^{y^B}_{WW}=\)</span> -1.154 <span class="math inline">\(-(\)</span> -1.361 <span class="math inline">\()=\)</span> 0.206.
This is not too far from the true effect of the treatment in the sample which is equal to <span class="math inline">\(\hat{\Delta}^{y}_{TT}=\)</span> 0.165.</p>
<p>Now, another very important question is whether the DID estimator is consistent, that is whether it is equal to <span class="math inline">\(\Delta^{y}_{TT}\)</span> in our model.
A necessary and sufficient condition for that is for the Parallel Trends Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a> to hold.
Indeed, it can be shown that the bias of the DID estimator is <span class="math inline">\(\Delta^{y}_{B(DID)}=\Delta^{y}_{DID}-\Delta^{y}_{TT}=\)</span> <span class="math inline">\(\esp{y^0_{i}|D_i=1}  - \esp{y^B_{i}|D_i=1}-(\esp{y^0_{i}|D_i=0} - \esp{y^B_{i}|D_i=0})\)</span>.
Let us derive <span class="math inline">\(\Delta^{y}_{B(DID)}\)</span> in our example.
Let us compute the trend in potential outcomes among the treated:</p>
<p><span class="math display">\[\begin{align*}
  \esp{y^0_{i,A}|D_i=1} &amp; - \esp{y^0_{i,B}|D_i=1} \\
  &amp; = \esp{y^0_{i}|D_i=1} - \esp{y^B_{i}|D_i=1} \\
  &amp; = \esp{\mu_i+\delta+U_i^0|D_i=1}-\esp{\mu_i+U_i^B|D_i=1} \\
  &amp; = \esp{\mu_i|D_i=1}+\delta+\esp{U_i^0|D_i=1}\\
  &amp; \phantom{=}-\esp{\mu_i|D_i=1}-\esp{U_i^B|D_i=1} \\
  &amp; = \delta + \esp{\rho U_i^B+\epsilon_i|D_i=1}-\esp{U_i^B|D_i=1}\\
  &amp; = \delta -(1-\rho)\esp{U_i^B|D_i=1}.
\end{align*}\]</span></p>
<p>Following the same line of reasoning, the trend in potential outcomes among the untreated is:</p>
<p><span class="math display">\[\begin{align*}
\esp{y^0_{i}|D_i=0} - \esp{y^B_{i}|D_i=0} &amp; = \delta -(1-\rho)\esp{U_i^B|D_i=0}.
\end{align*}\]</span></p>
<p>As a consequence, the bias of the DID estimator in our model is:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^{y}_{B(DID)} &amp; = -(1-\rho)(\esp{U_i^B|D_i=1}-\esp{U_i^B|D_i=0}) \\
  &amp; = -(1-\rho)(\esp{U_i^B|\mu_i+U_i^B+V_i\leq\bar{y}}-\esp{U_i^B|\mu_i+U_i^B+V_i&gt;\bar{y}})
\end{align*}\]</span></p>
<p>Is this zero?
The answer actually is that it is not.
In order to see why, notice intuitively that the conditional expectation of <span class="math inline">\(U_i^B\)</span> is taken conditional on something correlated with <span class="math inline">\(U_i^B\)</span> being above or below some threshold.
As a consequence, the two values whose difference is taken in the parenthesis cannot be equal.
More formally, let us derive the formula for the bias of the DID estimator in our model, using the formula for the expectation of a truncated bivariate normal distribution:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^{y}_{B(DID)}  &amp; = -(1-\rho)(\esp{U_i^B|\mu_i+U_i^B+V_i\leq\bar{y}}-\esp{U_i^B|\mu_i+U_i^B+V_i&gt;\bar{y}}) \\
                        &amp; = (1-\rho)\left(\frac{\sigma^2_U}{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}\right)
                                         \left(\frac{\phi\left(\frac{\bar{y}-\bar{\mu}}{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}\right)}
                                            {\Phi\left(\frac{\bar{y}-\bar{\mu}}{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}\right)}
                                            +\frac{\phi\left(\frac{\bar{y}-\bar{\mu}}{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}\right)}
                                            {1-\Phi\left(\frac{\bar{y}-\bar{\mu}}{(1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}}\right)}
                                      \right)
\end{align*}\]</span></p>
<p>In order to compute the value of this parameter, and of the average treatment effect, we are going to use the package <code>tmtvnorm</code> which provides the moments from a truncated multivariate normal variable.
Here, we use the distribution of <span class="math inline">\((\alpha_i,U_i^B,\mu_i+U_i^B+V_i)\)</span> which is normal with mean <span class="math inline">\((\bar{\alpha}+\theta\bar{\mu},0,\bar{\mu})\)</span> and covariance matrix <span class="math inline">\(\mathbf{D}\)</span> with:</p>
<p><span class="math display">\[\begin{align*}
  \mathbf{D} &amp;=  \left(\begin{array}{ccc}
                      \theta^2\sigma^2_{\mu}+ \sigma^2_{\eta} &amp; 0 &amp; (\theta+\gamma\theta)\sigma^2_{\mu}+\rho_{\eta,\omega}\sigma_{\eta}\sigma_{\omega}\\
                      0 &amp; \sigma^2_U &amp; \sigma^2_U \\
                      (\theta+\gamma\theta)\sigma^2_{\mu}+\rho_{\eta,\omega}\sigma_{\eta}\sigma_{\omega}&amp; \sigma^2_U &amp; (1+\gamma^2)\sigma^2_{\mu}+\sigma^2_U+\sigma^2_{\omega}
                      \end{array}\right)
\end{align*}\]</span></p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="NE.html#cb172-1" tabindex="-1"></a>mean.alpha.UB.yBV <span class="ot">&lt;-</span> <span class="fu">c</span>(param[<span class="st">&#39;baralpha&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;barmu&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;theta&#39;</span>],<span class="dv">0</span>,param[<span class="st">&#39;barmu&#39;</span>])</span>
<span id="cb172-2"><a href="NE.html#cb172-2" tabindex="-1"></a>cov.alpha.UB.yBV <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&#39;theta&#39;</span>]<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2eta&#39;</span>],</span>
<span id="cb172-3"><a href="NE.html#cb172-3" tabindex="-1"></a>                             <span class="dv">0</span>,</span>
<span id="cb172-4"><a href="NE.html#cb172-4" tabindex="-1"></a>                             (param[<span class="st">&#39;theta&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;theta&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rhoetaomega&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2eta&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2omega&#39;</span>],</span>
<span id="cb172-5"><a href="NE.html#cb172-5" tabindex="-1"></a>                             <span class="dv">0</span>, </span>
<span id="cb172-6"><a href="NE.html#cb172-6" tabindex="-1"></a>                             param[<span class="st">&#39;sigma2U&#39;</span>],</span>
<span id="cb172-7"><a href="NE.html#cb172-7" tabindex="-1"></a>                             param[<span class="st">&#39;sigma2U&#39;</span>],</span>
<span id="cb172-8"><a href="NE.html#cb172-8" tabindex="-1"></a>                             (param[<span class="st">&#39;theta&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;theta&#39;</span>])<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;rhoetaomega&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2eta&#39;</span>]<span class="sc">*</span>param[<span class="st">&#39;sigma2omega&#39;</span>],</span>
<span id="cb172-9"><a href="NE.html#cb172-9" tabindex="-1"></a>                             param[<span class="st">&#39;sigma2U&#39;</span>],</span>
<span id="cb172-10"><a href="NE.html#cb172-10" tabindex="-1"></a>                            (<span class="dv">1</span><span class="sc">+</span>param[<span class="st">&#39;gamma&#39;</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span>param[<span class="st">&#39;sigma2mu&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2U&#39;</span>]<span class="sc">+</span>param[<span class="st">&#39;sigma2omega&#39;</span>]),<span class="dv">3</span>,<span class="dv">3</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb172-11"><a href="NE.html#cb172-11" tabindex="-1"></a></span>
<span id="cb172-12"><a href="NE.html#cb172-12" tabindex="-1"></a><span class="co"># cuts</span></span>
<span id="cb172-13"><a href="NE.html#cb172-13" tabindex="-1"></a><span class="co">#non participants</span></span>
<span id="cb172-14"><a href="NE.html#cb172-14" tabindex="-1"></a>lower.cut.D0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="sc">-</span><span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))</span>
<span id="cb172-15"><a href="NE.html#cb172-15" tabindex="-1"></a>upper.cut.D0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="cn">Inf</span>,<span class="cn">Inf</span>)</span>
<span id="cb172-16"><a href="NE.html#cb172-16" tabindex="-1"></a><span class="co"># participants</span></span>
<span id="cb172-17"><a href="NE.html#cb172-17" tabindex="-1"></a>lower.cut.D1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="cn">Inf</span>,<span class="sc">-</span><span class="cn">Inf</span>,<span class="sc">-</span><span class="cn">Inf</span>)</span>
<span id="cb172-18"><a href="NE.html#cb172-18" tabindex="-1"></a>upper.cut.D1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">Inf</span>,<span class="cn">Inf</span>,<span class="fu">log</span>(param[<span class="st">&#39;barY&#39;</span>]))</span>
<span id="cb172-19"><a href="NE.html#cb172-19" tabindex="-1"></a></span>
<span id="cb172-20"><a href="NE.html#cb172-20" tabindex="-1"></a><span class="co"># means </span></span>
<span id="cb172-21"><a href="NE.html#cb172-21" tabindex="-1"></a>TT.pop <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.alpha.UB.yBV,<span class="at">sigma=</span>cov.alpha.UB.yBV,<span class="at">lower=</span>lower.cut.D1,<span class="at">upper=</span>upper.cut.D1,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</span>
<span id="cb172-22"><a href="NE.html#cb172-22" tabindex="-1"></a>mean.UB.D0 <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.alpha.UB.yBV,<span class="at">sigma=</span>cov.alpha.UB.yBV,<span class="at">lower=</span>lower.cut.D0,<span class="at">upper=</span>upper.cut.D0,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">2</span>]]</span>
<span id="cb172-23"><a href="NE.html#cb172-23" tabindex="-1"></a>mean.UB.D1 <span class="ot">&lt;-</span> <span class="fu">mtmvnorm</span>(<span class="at">mean=</span>mean.alpha.UB.yBV,<span class="at">sigma=</span>cov.alpha.UB.yBV,<span class="at">lower=</span>lower.cut.D1,<span class="at">upper=</span>upper.cut.D1,<span class="at">doComputeVariance=</span><span class="cn">FALSE</span>)[[<span class="dv">1</span>]][[<span class="dv">2</span>]]</span>
<span id="cb172-24"><a href="NE.html#cb172-24" tabindex="-1"></a>B.DID <span class="ot">&lt;-</span> <span class="sc">-</span>(<span class="dv">1</span><span class="sc">-</span>param[<span class="st">&#39;rho&#39;</span>])<span class="sc">*</span>(mean.UB.D1<span class="sc">-</span>mean.UB.D0)</span></code></pre></div>
<p>In our example, the population <span class="math inline">\(TT\)</span> is equal to <span class="math inline">\(\Delta^y_{TT}=\)</span> 0.173.
The DID estimator is equal to <span class="math inline">\(\Delta^y_{DID}=\)</span> 0.211.
As a consequence, the bias of the DID estimator is equal to <span class="math inline">\(\Delta^y_{B(DID)}=\)</span> 0.046.</p>
<p>In order to make the DID estimator consistent for the <span class="math inline">\(TT\)</span> parameter, we need to impose that <span class="math inline">\(\rho=1\)</span>.
When shocks are permanent, their bias remains constant over time and thus DID can estimate it without error.
Let us generate new data that are compatible with that assumption.</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="NE.html#cb173-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb173-2"><a href="NE.html#cb173-2" tabindex="-1"></a>N <span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb173-3"><a href="NE.html#cb173-3" tabindex="-1"></a>param[<span class="st">&quot;rho&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb173-4"><a href="NE.html#cb173-4" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb173-5"><a href="NE.html#cb173-5" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb173-6"><a href="NE.html#cb173-6" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;eta&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb173-7"><a href="NE.html#cb173-7" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb173-8"><a href="NE.html#cb173-8" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb173-9"><a href="NE.html#cb173-9" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb173-10"><a href="NE.html#cb173-10" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb173-11"><a href="NE.html#cb173-11" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb173-12"><a href="NE.html#cb173-12" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb173-13"><a href="NE.html#cb173-13" tabindex="-1"></a>Ds[yB<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb173-14"><a href="NE.html#cb173-14" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb173-15"><a href="NE.html#cb173-15" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb173-16"><a href="NE.html#cb173-16" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb173-17"><a href="NE.html#cb173-17" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>eta</span>
<span id="cb173-18"><a href="NE.html#cb173-18" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb173-19"><a href="NE.html#cb173-19" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb173-20"><a href="NE.html#cb173-20" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb173-21"><a href="NE.html#cb173-21" tabindex="-1"></a>y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb173-22"><a href="NE.html#cb173-22" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span></code></pre></div>
<p>Let’s see how DID works on this data.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDPT"></span>
<img src="STCI_files/figure-html/PlotDIDPT-1.png" alt="Evolution of average outcomes in the treated and control group when the Parallel Trends Assumption holds" width="50%" />
<p class="caption">
Figure 4.18: Evolution of average outcomes in the treated and control group when the Parallel Trends Assumption holds
</p>
</div>
<p>Now, the counterfactual change in outcome for the treated and its approximation using the trend experienced by the untreated are extremely close, as the curves <em>Treated counterfactual</em> and <em>Treated DID</em> show on Figure <a href="NE.html#fig:PlotDIDPT">4.18</a>.</p>
</div>
<div id="estimation-2" class="section level4 hasAnchor" number="4.3.1.2">
<h4><span class="header-section-number">4.3.1.2</span> Estimation<a href="NE.html#estimation-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Estimation of <span class="math inline">\(TT\)</span> under the <span class="math inline">\(DID\)</span> assumptions can be performed in a variety of ways: using directly the DID formula, using OLS with group fixed effects, using OLS with individual and time dummy variables, using first differences and using the within transformation (also known as the Two-Way Fixed Effects or TWFE estimator).
With only two periods of data and a fully balanced panel, all of these estimators are actually numerically equivalent.
Let’s examine them in turn.</p>
<div id="using-the-did-formula" class="section level5 hasAnchor" number="4.3.1.2.1">
<h5><span class="header-section-number">4.3.1.2.1</span> Using the DID formula<a href="NE.html#using-the-did-formula" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>One could go directly and use the DID formula of Theorem <a href="NE.html#thm:IdentDID">4.9</a>.
The sample DID estimator is thus equal to:</p>
<p><span class="math display">\[\begin{align*}
  \hat{\Delta}^Y_{DID} &amp; = \frac{\sum_{i=1}^NY_{i,A}D_i}{\sum_{i=1}^ND_i} -\frac{\sum_{i=1}^NY_{i,B}D_i}{\sum_{i=1}^ND_i} - \left(\frac{\sum_{i=1}^NY_{i,A}(1-D_i)}{\sum_{i=1}^N(1-D_i)} -\frac{\sum_{i=1}^NY_{i,B}(1-D_i)}{\sum_{i=1}^N(1-D_i)}\right).
\end{align*}\]</span></p>
<div class="example">
<p><span id="exm:unnamed-chunk-187" class="example"><strong>Example 4.27  </strong></span>In our example, let’s see how this estimator works.</p>
</div>
<p>The Before/After comparison among the participants is equal to <span class="math inline">\(\hat{\Delta}^{y}_{BA|D=1}=\)</span> 0.218.
The Before/After comparison among the non-participants is equal to <span class="math inline">\(\hat{\Delta}^{y}_{BA|D=0}=\)</span> 0.057.
The DID estimator is thus equal to <span class="math inline">\(\hat{\Delta}^{y}_{DID}=\hat{\Delta}^{y}_{BA|D=1}-\hat{\Delta}^{y}_{BA|D=0}=\)</span> 0.218 <span class="math inline">\(-\)</span> 0.057 <span class="math inline">\(=\)</span> 0.161.
It is also equal to the difference between the before and after With/Without estimators.
The Before With/Without estimator is equal to <span class="math inline">\(\hat{\Delta}^{y^B}_{WW}=\)</span> -1.361.
The After With/Without estimator is equal to <span class="math inline">\(\hat{\Delta}^{y}_{WW}=\)</span> -1.2.
The DID estimator is thus equal to <span class="math inline">\(\hat{\Delta}^{y}_{DID}=\hat{\Delta}^{y}_{WW}-\hat{\Delta}^{y^B}_{WW}=\)</span> -1.2 <span class="math inline">\(-(\)</span> -1.361 <span class="math inline">\()=\)</span> 0.161.
This is not too far from the true effect of the treatment in the sample which is equal to <span class="math inline">\(\hat{\Delta}^{y}_{TT}=\)</span> 0.165.
In the population, the <span class="math inline">\(TT\)</span> parameter has not changed, since its computation does not involve <span class="math inline">\(\rho\)</span>.
We still have <span class="math inline">\(\Delta^y_{TT}=\)</span> 0.173.</p>
</div>
<div id="using-the-least-squares-pooling-did-estimator" class="section level5 hasAnchor" number="4.3.1.2.2">
<h5><span class="header-section-number">4.3.1.2.2</span> Using the Least Squares pooling DID estimator<a href="NE.html#using-the-least-squares-pooling-did-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The most basic regression-based way to implement DID is to run a linear regression of outcomes on a treatment group dummy, a time dummy and their interaction.
The interaction captures the effect of the treatment estimated using DID.
The way it works is as follows: estimate the following equation using OLS and use <span class="math inline">\(\hat{\beta}_{OLS}\)</span> as your DID estimate: <span class="math inline">\(\hat{\beta}_{OLS}=\hat{\Delta}^{Y}_{DID}\)</span>.
<span class="math display">\[\begin{align*}
    Y_i &amp;  = \alpha +  \mu D_i + \delta T_i + \beta D_iT_i + \epsilon_i.
\end{align*}\]</span>
<span class="math inline">\(D_i\)</span> is our usual treatment indicator while <span class="math inline">\(T_i\)</span> takes value one when observation <span class="math inline">\(i\)</span> is observed in the <em>After</em> and zero otherwise.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-188" class="example"><strong>Example 4.28  </strong></span>Let’s see how this works in our example.</p>
</div>
<p>Before estimating the model, we need to build a data frame with all the necessary variables.</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="NE.html#cb174-1" tabindex="-1"></a><span class="co"># building a data frame</span></span>
<span id="cb174-2"><a href="NE.html#cb174-2" tabindex="-1"></a>data.DID <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="fu">c</span>(y,yB),<span class="fu">c</span>(Ds,Ds),<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,N),<span class="fu">rep</span>(<span class="dv">0</span>,N))))</span>
<span id="cb174-3"><a href="NE.html#cb174-3" tabindex="-1"></a><span class="fu">colnames</span>(data.DID) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;y&#39;</span>,<span class="st">&#39;D&#39;</span>,<span class="st">&#39;T&#39;</span>)</span>
<span id="cb174-4"><a href="NE.html#cb174-4" tabindex="-1"></a></span>
<span id="cb174-5"><a href="NE.html#cb174-5" tabindex="-1"></a><span class="co"># running the OLS regression</span></span>
<span id="cb174-6"><a href="NE.html#cb174-6" tabindex="-1"></a>reg.DID <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> D <span class="sc">+</span> T <span class="sc">+</span> D<span class="sc">*</span>T,<span class="at">data =</span> data.DID)</span>
<span id="cb174-7"><a href="NE.html#cb174-7" tabindex="-1"></a></span>
<span id="cb174-8"><a href="NE.html#cb174-8" tabindex="-1"></a><span class="co"># coefficients</span></span>
<span id="cb174-9"><a href="NE.html#cb174-9" tabindex="-1"></a>yB.D0.reg <span class="ot">&lt;-</span>  <span class="fu">coef</span>(reg.DID)[[<span class="dv">1</span>]]</span>
<span id="cb174-10"><a href="NE.html#cb174-10" tabindex="-1"></a>WW.before.reg <span class="ot">&lt;-</span>  <span class="fu">coef</span>(reg.DID)[[<span class="dv">2</span>]]</span>
<span id="cb174-11"><a href="NE.html#cb174-11" tabindex="-1"></a>BA.untreated.reg <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.DID)[[<span class="dv">3</span>]]</span>
<span id="cb174-12"><a href="NE.html#cb174-12" tabindex="-1"></a>DID.est.reg <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.DID)[[<span class="dv">4</span>]]</span>
<span id="cb174-13"><a href="NE.html#cb174-13" tabindex="-1"></a></span>
<span id="cb174-14"><a href="NE.html#cb174-14" tabindex="-1"></a><span class="co"># comparisons</span></span>
<span id="cb174-15"><a href="NE.html#cb174-15" tabindex="-1"></a>yB.D0.sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span></code></pre></div>
<p>The estimate of <span class="math inline">\(\hat{\beta}_{OLS}\)</span> in our sample is equal to 0.161.
It is exactly equal to <span class="math inline">\(\hat{\Delta}^{y}_{DID}\)</span> as estimated just above.
What is interesting with the regression-based DID approach is that the other coefficients in the regression have a direct interpretation.
For example, the constant <span class="math inline">\(\alpha\)</span> estimates the mean outcome in the untreated group before the treatment.
In our case, we have <span class="math inline">\(\hat{\alpha}_OLS=\)</span> 8.36.
Remember that in our sample, the average outcomes of the untreated before the treatment is equal to <span class="math inline">\(\hatesp{y_i^B|D_i=0}=\)</span> 8.36.
<span class="math inline">\(\mu\)</span>, the coefficient in front of the <span class="math inline">\(D_i\)</span> dummy, estimates the With/Without estimator before the treatment.
In our case, we have <span class="math inline">\(\hat{\mu}_{OLS}=\)</span> -1.361.
Remember that in our sample, the With/Without estimator before the treatment is equal to <span class="math inline">\(\hat{\Delta}^{y^B}_{WW}=\)</span> -1.361.
<span class="math inline">\(\delta\)</span>, the coefficient in front of the <span class="math inline">\(T_i\)</span> dummy, estimates the Before/After change in outcomes among the untreated.
In our case, we have <span class="math inline">\(\hat{\delta}_{OLS}=\)</span> 0.057.
Remember that in our sample, the Before/After estimator among the untreated is equal to <span class="math inline">\(\hat{\Delta}^{y}_{BA|D=0}=\)</span> 0.057.</p>
<div class="remark">
<p><span id="unlabeled-div-98" class="remark"><em>Remark</em>. </span>A pretty cool property of the regression-based DID estimator is that is does not require panel data.
It works even with repeated cross sections, <em>i.e.</em> when observations are drawn from the same population in both periods but are not the same.</p>
</div>
</div>
<div id="using-first-differences" class="section level5 hasAnchor" number="4.3.1.2.3">
<h5><span class="header-section-number">4.3.1.2.3</span> Using First Differences<a href="NE.html#using-first-differences" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In the presence of panel data, an alternative to the regression-based DID estimator is the first-difference estimator.
It simply regresses the change over time in outcomes on the treatment dummy:
<span class="math display">\[\begin{align*}
    Y_{i,A}-Y_{i,B} &amp;  = \alpha^{FD} +  \beta^{FD} D_i + \epsilon^{FD}_i.
\end{align*}\]</span>
The coefficient <span class="math inline">\(\beta^{FD}\)</span> estimated by OLS is an estimate of the DID parameter.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-190" class="example"><strong>Example 4.29  </strong></span>Let’s see how this works in our example.</p>
</div>
<p>Before running the model, we need to generate first the differenced estimates.
One very simple way to do that is simply to take the difference between the before and the after outcome vectors.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="NE.html#cb175-1" tabindex="-1"></a><span class="co"># building a data frame</span></span>
<span id="cb175-2"><a href="NE.html#cb175-2" tabindex="-1"></a>data.FD <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(y<span class="sc">-</span>yB,Ds))</span>
<span id="cb175-3"><a href="NE.html#cb175-3" tabindex="-1"></a><span class="fu">colnames</span>(data.FD) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;BAy&#39;</span>,<span class="st">&#39;D&#39;</span>)</span>
<span id="cb175-4"><a href="NE.html#cb175-4" tabindex="-1"></a></span>
<span id="cb175-5"><a href="NE.html#cb175-5" tabindex="-1"></a><span class="co"># running the OLS regression</span></span>
<span id="cb175-6"><a href="NE.html#cb175-6" tabindex="-1"></a>reg.FD <span class="ot">&lt;-</span> <span class="fu">lm</span>(BAy <span class="sc">~</span> D,<span class="at">data =</span> data.FD)</span>
<span id="cb175-7"><a href="NE.html#cb175-7" tabindex="-1"></a></span>
<span id="cb175-8"><a href="NE.html#cb175-8" tabindex="-1"></a><span class="co"># coefficients</span></span>
<span id="cb175-9"><a href="NE.html#cb175-9" tabindex="-1"></a>BA.untreated.FD <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.FD)[[<span class="dv">1</span>]]</span>
<span id="cb175-10"><a href="NE.html#cb175-10" tabindex="-1"></a>DID.est.FD <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.FD)[[<span class="dv">2</span>]]</span></code></pre></div>
<p>The estimate of <span class="math inline">\(\hat{\beta}^{FD}_{OLS}\)</span> in our sample is equal to 0.161.
It is exactly equal to <span class="math inline">\(\hat{\Delta}^{y}_{DID}\)</span> as estimated just above.
Note also that <span class="math inline">\(\alpha^{FD}\)</span> estimates the Before/After change in outcomes among the untreated.
In our case, we have <span class="math inline">\(\hat{\alpha}^{FD}_{OLS}=\)</span> 0.057.
Remember that in our sample, the Before/After estimator among the untreated is equal to <span class="math inline">\(\hat{\Delta}^{y}_{BA|D=0}=\)</span> 0.057.</p>
</div>
<div id="sec:LSDV" class="section level5 hasAnchor" number="4.3.1.2.4">
<h5><span class="header-section-number">4.3.1.2.4</span> Using the Least Squares Dummy Variables estimator<a href="NE.html#sec:LSDV" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>One very computer-intensive way to estimate <span class="math inline">\(TT\)</span> in a DID setting is to use the OLS estimator supplemented with dummies for each observation and for each time period, also called the Least-Squares Dummy Variables estimator.
In practice, the estimator is based on the following regression:
<span class="math display">\[\begin{align*}
    Y_{i,t} &amp;  = \sum_{j=1}^N\mu_j\uns{j=i} + \sum_{l=0}^1\delta_l\uns{l=t} + \beta^{LSDV} D_{i,t} + \epsilon^{LSDV}_{i,t}.
\end{align*}\]</span>
The notation is generally simplified as follows:
<span class="math display">\[\begin{align*}
    Y_{i,t} &amp;  = \mu_i + \delta_t + \beta^{TWFE} D_{i,t} + \epsilon^{TWFE}_{i,t},
\end{align*}\]</span></p>
<p>This last estimator is generally called the Two-Way Fixed Effects estimator, since it has two-sets of so-called fixed effects (individual fixed effects, <span class="math inline">\(\mu_i\)</span>, and time fixed effects <span class="math inline">\(\delta_t\)</span>).
I will write it using this second, more compact, formulation, but I think the first formulation encapsulates better how the Least-Squares Dummy Variables estimator works.
In what follows, we will see other ways of estimating the Two-Way Fixed Effects model, but for now, let us focus on the Least-Squares Dummy Variables estimator.
The way it works is simply by throwing a bunch of dummy variables in the regression.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-191" class="example"><strong>Example 4.30  </strong></span>Let’s see how the Least Squares Dummy Variable works in our example.
For that, we need to generate one dummy variable for each individual <span class="math inline">\(i\)</span> in our sample.
This is made simple by the <code>factor</code> function in <code>R</code>.
We are also going to run the model without a constant, so that all the fixed effects are identified.</p>
</div>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="NE.html#cb176-1" tabindex="-1"></a><span class="co"># adding one column to the DID data frame with the individual index for each observation of the same $i$</span></span>
<span id="cb176-2"><a href="NE.html#cb176-2" tabindex="-1"></a>data.DID<span class="sc">$</span>indiv <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>N,<span class="dv">1</span><span class="sc">:</span>N))</span>
<span id="cb176-3"><a href="NE.html#cb176-3" tabindex="-1"></a><span class="co"># generating Dit (time varying)</span></span>
<span id="cb176-4"><a href="NE.html#cb176-4" tabindex="-1"></a>data.DID<span class="sc">$</span>Dit <span class="ot">&lt;-</span> data.DID<span class="sc">$</span>D<span class="sc">*</span>data.DID<span class="sc">$</span>T</span>
<span id="cb176-5"><a href="NE.html#cb176-5" tabindex="-1"></a><span class="co"># running the LSDV estimator</span></span>
<span id="cb176-6"><a href="NE.html#cb176-6" tabindex="-1"></a>reg.LSDV <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~-</span><span class="dv">1</span> <span class="sc">+</span> Dit <span class="sc">+</span> <span class="fu">as.factor</span>(T) <span class="sc">+</span> indiv,<span class="at">data=</span>data.DID)</span>
<span id="cb176-7"><a href="NE.html#cb176-7" tabindex="-1"></a><span class="co"># result</span></span>
<span id="cb176-8"><a href="NE.html#cb176-8" tabindex="-1"></a>DID.est.LSDV <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.LSDV)[[<span class="dv">1</span>]]</span></code></pre></div>
<p>The Least-Squares Dummy Variables estimate of <span class="math inline">\(TT\)</span> is equal to: <span class="math inline">\(\hat{\beta}^{LSDV}=\)</span> 0.161.</p>
<div class="remark">
<p><span id="unlabeled-div-99" class="remark"><em>Remark</em>. </span>The term <em>fixed effect</em> is specific to the panel data literature in econometrics.
It refers to the fact that both <span class="math inline">\(\mu_i\)</span> and <span class="math inline">\(\delta_t\)</span> are allowed to be correlated with <span class="math inline">\(D_{i,t}\)</span> in this model.
This is in contrast to the <em>random effects model</em> where <span class="math inline">\(\mu_i\)</span> and <span class="math inline">\(\delta_t\)</span> are assumed to be independent of the regressors of interest.</p>
</div>
</div>
<div id="sec:Within" class="section level5 hasAnchor" number="4.3.1.2.5">
<h5><span class="header-section-number">4.3.1.2.5</span> Using the Within estimator<a href="NE.html#sec:Within" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>You might have noticed that the Least-Squares Dummy Variables estimator took some time to compute on your computer.
This is because it requires the inversion of a very large matrix, as large as the number of fixed effects plus one.
The size of this computation increases as the number of observation and time periods increases, meaning that this computation might become practically unfeasible in very large datasets.
Several tricks have been developed to decrease the computational burden of the estimation of the Two-Way Fixed Effects model.
One approach is to use the First Difference estimator.
Another approach is the Within estimator.
The way the Within estimator works is by taking the difference between each observation and its mean over time or over individuals.
More precisely, the Within estimator estimates the following model by OLS:
<span class="math display">\[\begin{align*}
    Y_{i,t}-\frac{1}{2}\sum_{t=0}^1Y_{i,t} &amp;  = \delta^{W}_t + \beta^{W}(D_{i,t}-\frac{1}{2}\sum_{t=0}^1D_{i,t}) + \epsilon^{W}_{i,t}.
\end{align*}\]</span></p>
<p>The reason why this trick works is because of the shape of the Two-Way Fixed Effects model.
Indeed, taking the average of the Two-Way Fixed Effects model over time gives:
<span class="math display">\[\begin{align*}
    \frac{1}{2}\sum_{t=0}^1Y_{i,t} &amp;  = \mu_i + \frac{1}{2}\sum_{t=0}^1\delta_t + \beta^{TWFE}\frac{1}{2}\sum_{t=0}^1D_{i,t} + \frac{1}{2}\sum_{t=0}^1\epsilon^{TWFE}_{i,t}.
\end{align*}\]</span>
Taking the difference between the Two-Way Fixed Effects model and its time-averaged version gives the Within estimator.
The key is that the differencing gets rid of the individual fixed effects parameter <span class="math inline">\(\mu_i\)</span> and thus makes it unnecessary to estimate it.
The set of parameters to estimate is thus much smaller than in the Least-Squares Dummy Variables estimator.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-193" class="example"><strong>Example 4.31  </strong></span>Let’s see how the Within estimator works in our example.
For that, we need to compute the average over time of the outcome and of the treatment for each observation in our dataset.
This is made simple by the <code>summarize</code> function of the <code>dplyr</code> package.</p>
</div>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="NE.html#cb177-1" tabindex="-1"></a><span class="co"># generating the time means of Y and Dit</span></span>
<span id="cb177-2"><a href="NE.html#cb177-2" tabindex="-1"></a>TimeMeansYDit <span class="ot">&lt;-</span> data.DID <span class="sc">%&gt;%</span></span>
<span id="cb177-3"><a href="NE.html#cb177-3" tabindex="-1"></a>                  <span class="fu">group_by</span>(indiv) <span class="sc">%&gt;%</span></span>
<span id="cb177-4"><a href="NE.html#cb177-4" tabindex="-1"></a>                  <span class="fu">summarize</span>(</span>
<span id="cb177-5"><a href="NE.html#cb177-5" tabindex="-1"></a>                    <span class="at">TimeMeanY =</span> <span class="fu">mean</span>(y),</span>
<span id="cb177-6"><a href="NE.html#cb177-6" tabindex="-1"></a>                    <span class="at">TimeMeanDit =</span> <span class="fu">mean</span>(Dit)</span>
<span id="cb177-7"><a href="NE.html#cb177-7" tabindex="-1"></a>                  )</span>
<span id="cb177-8"><a href="NE.html#cb177-8" tabindex="-1"></a><span class="co"># doubling the observations to be able to take the difference in both periods</span></span>
<span id="cb177-9"><a href="NE.html#cb177-9" tabindex="-1"></a>TimeMeansYDit <span class="ot">&lt;-</span> <span class="fu">rbind</span>(TimeMeansYDit,TimeMeansYDit)                  </span>
<span id="cb177-10"><a href="NE.html#cb177-10" tabindex="-1"></a><span class="co"># taking the difference in both periods</span></span>
<span id="cb177-11"><a href="NE.html#cb177-11" tabindex="-1"></a>data.DID<span class="sc">$</span>W.y <span class="ot">&lt;-</span> data.DID<span class="sc">$</span>y<span class="sc">-</span>TimeMeansYDit<span class="sc">$</span>TimeMeanY</span>
<span id="cb177-12"><a href="NE.html#cb177-12" tabindex="-1"></a>data.DID<span class="sc">$</span>W.Dit <span class="ot">&lt;-</span> data.DID<span class="sc">$</span>Dit<span class="sc">-</span>TimeMeansYDit<span class="sc">$</span>TimeMeanDit</span>
<span id="cb177-13"><a href="NE.html#cb177-13" tabindex="-1"></a><span class="co"># running the within estimator</span></span>
<span id="cb177-14"><a href="NE.html#cb177-14" tabindex="-1"></a>reg.W <span class="ot">&lt;-</span> <span class="fu">lm</span>(W.y<span class="sc">~-</span><span class="dv">1</span> <span class="sc">+</span> W.Dit <span class="sc">+</span> <span class="fu">as.factor</span>(T),<span class="at">data=</span>data.DID)</span>
<span id="cb177-15"><a href="NE.html#cb177-15" tabindex="-1"></a><span class="co"># result</span></span>
<span id="cb177-16"><a href="NE.html#cb177-16" tabindex="-1"></a>DID.est.W <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.W)[[<span class="dv">1</span>]]</span></code></pre></div>
<p>The Within estimate of <span class="math inline">\(TT\)</span> is equal to: <span class="math inline">\(\hat{\beta}^{W}=\)</span> 0.161.</p>
<p>The <code>plm</code> package directly implements the Within transformation.
The same package also estimates the First Difference model and the Least Squares pooling DID estimator.
Let’s see how this works.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="NE.html#cb178-1" tabindex="-1"></a><span class="co"># running the within estimator</span></span>
<span id="cb178-2"><a href="NE.html#cb178-2" tabindex="-1"></a>reg.W.plm <span class="ot">&lt;-</span> <span class="fu">plm</span>(y <span class="sc">~</span>  Dit <span class="sc">+</span> <span class="fu">as.factor</span>(T) , <span class="at">data =</span> data.DID, <span class="at">index=</span> <span class="fu">c</span>(<span class="st">&quot;indiv&quot;</span>, <span class="st">&quot;T&quot;</span>), <span class="at">model =</span> <span class="st">&quot;within&quot;</span>)</span>
<span id="cb178-3"><a href="NE.html#cb178-3" tabindex="-1"></a><span class="co"># result</span></span>
<span id="cb178-4"><a href="NE.html#cb178-4" tabindex="-1"></a>DID.est.W.plm <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.W.plm)[[<span class="dv">1</span>]]</span>
<span id="cb178-5"><a href="NE.html#cb178-5" tabindex="-1"></a></span>
<span id="cb178-6"><a href="NE.html#cb178-6" tabindex="-1"></a><span class="co"># running the first difference estimator</span></span>
<span id="cb178-7"><a href="NE.html#cb178-7" tabindex="-1"></a>reg.FD.plm <span class="ot">&lt;-</span> <span class="fu">plm</span>(y <span class="sc">~</span>  Dit <span class="sc">+</span> <span class="fu">as.factor</span>(T) , <span class="at">data =</span> data.DID, <span class="at">index=</span> <span class="fu">c</span>(<span class="st">&quot;indiv&quot;</span>, <span class="st">&quot;T&quot;</span>), <span class="at">model =</span> <span class="st">&quot;fd&quot;</span>)</span>
<span id="cb178-8"><a href="NE.html#cb178-8" tabindex="-1"></a><span class="co"># result</span></span>
<span id="cb178-9"><a href="NE.html#cb178-9" tabindex="-1"></a>DID.est.FD.plm <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.FD.plm)[[<span class="dv">2</span>]]</span>
<span id="cb178-10"><a href="NE.html#cb178-10" tabindex="-1"></a></span>
<span id="cb178-11"><a href="NE.html#cb178-11" tabindex="-1"></a><span class="co"># running the OLS pooling DID estimator</span></span>
<span id="cb178-12"><a href="NE.html#cb178-12" tabindex="-1"></a>reg.OLS.plm <span class="ot">&lt;-</span> <span class="fu">plm</span>(y <span class="sc">~</span> <span class="fu">as.factor</span>(T) <span class="sc">+</span> D <span class="sc">+</span> Dit , <span class="at">data =</span> data.DID, <span class="at">index=</span> <span class="fu">c</span>(<span class="st">&quot;indiv&quot;</span>, <span class="st">&quot;T&quot;</span>), <span class="at">model =</span> <span class="st">&quot;pooling&quot;</span>)</span>
<span id="cb178-13"><a href="NE.html#cb178-13" tabindex="-1"></a><span class="co"># result</span></span>
<span id="cb178-14"><a href="NE.html#cb178-14" tabindex="-1"></a>DID.est.OLS.plm <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.OLS.plm)[[<span class="dv">4</span>]]</span></code></pre></div>
<p>As expected, <code>plm</code> gives the following estimates for <span class="math inline">\(TT\)</span>: <span class="math inline">\(\hat{\beta}^{W}=\)</span> 0.161, <span class="math inline">\(\hat{\beta}^{FD}=\)</span> 0.161 and <span class="math inline">\(\hat{\beta}^{OLS}=\)</span> 0.161.</p>
</div>
<div id="sec:FastTWFE" class="section level5 hasAnchor" number="4.3.1.2.6">
<h5><span class="header-section-number">4.3.1.2.6</span> Using fast estimators of the Two-Way Fixed Effects model<a href="NE.html#sec:FastTWFE" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>All the estimators of the TWFE model that we have seen so far have issues.
The OLS pooling DID estimator does not account for the panel structure of the data when it exists.
It does not alter the precision of the estimator but it makes it mode difficult to account for more dimensions of fixed effects than two.
The First Difference estimator, similarly, cannot easily account for more than two sets of fixed effects.
The Least Squares Dummy variable is slow because of the very large matrix inversion problem.
Therefore, applied econometricians tend to prefer using the Within estimator in practice.
The Within estimtor of the Two-Way Fixed Effects model is not without problems as well.
As the sample size grows large, or the number of fixed effects increases, it becomes more and more difficult to compute the within transformation.
As a consequence, recent packages have proposed to optimize the computation of the TWFE model using various computational tricks.
Let’s examine two in turn.</p>
<div id="the-alternating-projections-method" class="section level6 hasAnchor" number="4.3.1.2.6.1">
<h6><span class="header-section-number">4.3.1.2.6.1</span> The Alternating Projections method<a href="NE.html#the-alternating-projections-method" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The <code>lfe</code> package in <code>R</code> implements an alternating projections method to estimate the <span class="math inline">\(N\)</span>-Way Fixed effects model.
It is based on an algorithm proposed by <a href="https://doi.org/10.1016/j.csda.2013.03.024">Gaure (2013)</a>.
The basic idea of <a href="https://www.econstor.eu/bitstream/10419/47280/1/637363027.pdf">Gaure (2013)</a> is to repeat centering on the means of the fixed effects (the within operation) in an alternating manner between the various fixed effects dimensions until convergence.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-194" class="example"><strong>Example 4.32  </strong></span>Let’s see how the <code>lfe</code> estimator works in our example.</p>
</div>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="NE.html#cb179-1" tabindex="-1"></a><span class="co"># running the within estimator</span></span>
<span id="cb179-2"><a href="NE.html#cb179-2" tabindex="-1"></a>reg.W.lfe <span class="ot">&lt;-</span> <span class="fu">felm</span>(y <span class="sc">~</span>  Dit <span class="sc">+</span> <span class="fu">as.factor</span>(T) <span class="sc">|</span> indiv , <span class="at">data =</span> data.DID)</span>
<span id="cb179-3"><a href="NE.html#cb179-3" tabindex="-1"></a><span class="co"># result</span></span>
<span id="cb179-4"><a href="NE.html#cb179-4" tabindex="-1"></a>DID.est.W.lfe <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.W.lfe)[[<span class="dv">1</span>]]</span></code></pre></div>
<p>As expected, <code>lfe</code> gives the following estimate for <span class="math inline">\(TT\)</span>: <span class="math inline">\(\hat{\beta}^{AP}=\)</span> 0.161.</p>
</div>
<div id="the-likelihood-concentration-method" class="section level6 hasAnchor" number="4.3.1.2.6.2">
<h6><span class="header-section-number">4.3.1.2.6.2</span> The Likelihood Concentration method<a href="NE.html#the-likelihood-concentration-method" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>One problem with the <code>lfe</code> package is that it works only for linear models.
The <a href="https://cran.r-project.org/web/packages/fixest/vignettes/fixest_walkthrough.html"><code>fixest</code></a> package in <code>R</code> proposes a solution for estimating fixed effects models in non-linear cases as well.
The solution is based on the concentrated likelihood as explained in <a href="https://wwwen.uni.lu/content/download/110162/1299525/file/2018_13">Berge (2018)</a>.
The intuition is as follows.
We first postulate a value for the treatment effect and the coefficient on the time dummies and we estimate each of the individual fixed effects using maximum likelihood.
We then use maximum likelihood to find the treatment effect using the values of the fixed effects estimated in the previous step.
This seems complicated but the key idea is to separate the estimation of the fixed effects from the estimation of the parameters of interest.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-195" class="example"><strong>Example 4.33  </strong></span>Let’s see how the <code>fixest</code> estimator works in our example.</p>
</div>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="NE.html#cb180-1" tabindex="-1"></a><span class="co"># running the within estimator</span></span>
<span id="cb180-2"><a href="NE.html#cb180-2" tabindex="-1"></a>reg.W.fixest <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span>  Dit <span class="sc">+</span> <span class="fu">as.factor</span>(T) <span class="sc">|</span> indiv , <span class="at">data =</span> data.DID)</span>
<span id="cb180-3"><a href="NE.html#cb180-3" tabindex="-1"></a><span class="co"># result</span></span>
<span id="cb180-4"><a href="NE.html#cb180-4" tabindex="-1"></a>DID.est.W.fixest <span class="ot">&lt;-</span> <span class="fu">coef</span>(reg.W.fixest)[[<span class="dv">1</span>]]</span></code></pre></div>
<p>As expected, <code>fixest</code> gives the following estimate for <span class="math inline">\(TT\)</span>: <span class="math inline">\(\hat{\beta}^{LC}=\)</span> 0.161.</p>
</div>
</div>
<div id="equivalence-between-the-various-did-methods-with-two-time-periods" class="section level5 hasAnchor" number="4.3.1.2.7">
<h5><span class="header-section-number">4.3.1.2.7</span> Equivalence between the various DID methods with two time periods<a href="NE.html#equivalence-between-the-various-did-methods-with-two-time-periods" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The above results suggest that all DID estimators are equivalent when working with two time periods.
The following theorem actually states this result rigorously:</p>
<div class="theorem">
<p><span id="thm:EstimDID" class="theorem"><strong>Theorem 4.10  (All DID estimators are numerically equivalent with two time periods) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and <a href="NE.html#hyp:ParallelTrends">4.14</a>, in a panel with only two periods of data, all the DID estimators are numerically equivalent: <span class="math inline">\(\hat{\beta}^{OLS}=\hat{\beta}^{FD}=\hat{\beta}^{W}=\hat{\beta}^{LSDV}=\hat{\beta}^{AP}=\hat{\beta}^{LC}=\hat{\Delta}^Y_{DID}\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-100" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofEstimDID">A.3.1</a>.</p>
</div>
<p>A corollary to Theorem <a href="NE.html#thm:EstimDID">4.10</a> shows that the coefficients in the Least Squares Pooling DID estimator all estimate some relevant parameters that help make sense of the DID estimator:</p>
<div class="corollary">
<p><span id="cor:OLSDIDCoefs" class="corollary"><strong>Corollary 4.2  (Coefficients in the OLS DID model) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and <a href="NE.html#hyp:ParallelTrends">4.14</a>, in a panel with only two periods of data, the coefficients of the Least Squares pooling DID estimator are:</p>
</div>
<p><span class="math display">\[\begin{align*}
  \hat{\alpha}^{OLS} &amp; = \bar{Y}^0_B \\
  \hat{\mu}^{OLS} &amp;  = \bar{Y}^1_B-\bar{Y}^0_B\\
  \hat{\delta}^{OLS} &amp; = \bar{Y}^0_A-\bar{Y}^0_B \\
  \hat{\beta}^{OLS} &amp; = \bar{Y}^1_A-\bar{Y}^1_B-(\bar{Y}^0_A-\bar{Y}^0_B),
\end{align*}\]</span>
with <span class="math inline">\(\bar{Y}^d_t=\frac{\sum_{i=1}^NY_{i,t}\uns{D_i=d}}{\sum_{i=1}^N\uns{D_i=d}}\)</span>.</p>
<div class="proof">
<p><span id="unlabeled-div-101" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofEstimDID">A.3.1</a>, the proof for the OLS DID estimator.</p>
</div>
<p>Corollary <a href="NE.html#cor:OLSDIDCoefs">4.2</a> shows that the constant in the OLS DID model <span class="math inline">\(\hat{\alpha}^{OLS}\)</span> estimates the average outcome for the untreated group in the period before the treatment date; the coefficient on the group dummy <span class="math inline">\(D_i\)</span> <span class="math inline">\(\hat{\mu}^{OLS}\)</span> estimates the difference between the average outcome for the treated group and the average outcome in the untreated group in the period before the treatment takes place; the coefficient on the time dummy <span class="math inline">\(T_i\)</span> <span class="math inline">\(\hat{\delta}^{OLS}\)</span> estimates the difference in average outcomes in the untreated group before and after the treatment takes place.
These coefficients are useful to udenrstand how the DID estimator is formed.
They can also be used to plot the trajectory of the mean outcomes in each group over time to make a visual impression of how DID works.</p>
<p>Finally, let’s see how our estimator varies across sampling replications.
A key difference is whether we have access to panel data or not.
Indeed, estimates from a repeated cross section are going to be more noisy since they are going to sample different people in different periods and thus are going to be affected by sampling noise stemming from the fixed effects.
This is not going to be the case with panel data, since all the estimators based on the TWFE estimator differentiate out the individual fixed effects.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-198" class="example"><strong>Example 4.34  </strong></span>Let’s first start with the case of panel data:</p>
</div>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="NE.html#cb181-1" tabindex="-1"></a><span class="co"># let us write a function that generates a DID estimate out of each sample of a given size</span></span>
<span id="cb181-2"><a href="NE.html#cb181-2" tabindex="-1"></a>monte.carlo.did.panel <span class="ot">&lt;-</span> <span class="cf">function</span>(s,N,param){</span>
<span id="cb181-3"><a href="NE.html#cb181-3" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb181-4"><a href="NE.html#cb181-4" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb181-5"><a href="NE.html#cb181-5" tabindex="-1"></a>  UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb181-6"><a href="NE.html#cb181-6" tabindex="-1"></a>  yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb181-7"><a href="NE.html#cb181-7" tabindex="-1"></a>  YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb181-8"><a href="NE.html#cb181-8" tabindex="-1"></a>  Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb181-9"><a href="NE.html#cb181-9" tabindex="-1"></a>  Ds[YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb181-10"><a href="NE.html#cb181-10" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb181-11"><a href="NE.html#cb181-11" tabindex="-1"></a>  eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb181-12"><a href="NE.html#cb181-12" tabindex="-1"></a>  U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb181-13"><a href="NE.html#cb181-13" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb181-14"><a href="NE.html#cb181-14" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb181-15"><a href="NE.html#cb181-15" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb181-16"><a href="NE.html#cb181-16" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb181-17"><a href="NE.html#cb181-17" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb181-18"><a href="NE.html#cb181-18" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb181-19"><a href="NE.html#cb181-19" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb181-20"><a href="NE.html#cb181-20" tabindex="-1"></a>  delta.y.did <span class="ot">&lt;-</span> <span class="fu">mean</span>(y[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb181-21"><a href="NE.html#cb181-21" tabindex="-1"></a>  <span class="fu">return</span>(delta.y.did)</span>
<span id="cb181-22"><a href="NE.html#cb181-22" tabindex="-1"></a>}</span>
<span id="cb181-23"><a href="NE.html#cb181-23" tabindex="-1"></a></span>
<span id="cb181-24"><a href="NE.html#cb181-24" tabindex="-1"></a>simuls.did.panel.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param){</span>
<span id="cb181-25"><a href="NE.html#cb181-25" tabindex="-1"></a>  simuls.did.panel <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.did.panel,<span class="at">N=</span>N,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb181-26"><a href="NE.html#cb181-26" tabindex="-1"></a>  <span class="fu">colnames</span>(simuls.did.panel) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;DID&#39;</span>)</span>
<span id="cb181-27"><a href="NE.html#cb181-27" tabindex="-1"></a>  <span class="fu">return</span>(simuls.did.panel)</span>
<span id="cb181-28"><a href="NE.html#cb181-28" tabindex="-1"></a>}</span>
<span id="cb181-29"><a href="NE.html#cb181-29" tabindex="-1"></a></span>
<span id="cb181-30"><a href="NE.html#cb181-30" tabindex="-1"></a>sf.simuls.did.panel.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param){</span>
<span id="cb181-31"><a href="NE.html#cb181-31" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span><span class="dv">8</span>)</span>
<span id="cb181-32"><a href="NE.html#cb181-32" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.did.panel,<span class="at">N=</span>N,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb181-33"><a href="NE.html#cb181-33" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb181-34"><a href="NE.html#cb181-34" tabindex="-1"></a>  <span class="fu">colnames</span>(sim) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;DID&#39;</span>)</span>
<span id="cb181-35"><a href="NE.html#cb181-35" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb181-36"><a href="NE.html#cb181-36" tabindex="-1"></a>}</span>
<span id="cb181-37"><a href="NE.html#cb181-37" tabindex="-1"></a></span>
<span id="cb181-38"><a href="NE.html#cb181-38" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb181-39"><a href="NE.html#cb181-39" tabindex="-1"></a><span class="co">#Nsim &lt;- 10</span></span>
<span id="cb181-40"><a href="NE.html#cb181-40" tabindex="-1"></a>N.sample <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">1000</span>,<span class="dv">10000</span>,<span class="dv">100000</span>)</span>
<span id="cb181-41"><a href="NE.html#cb181-41" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000)</span></span>
<span id="cb181-42"><a href="NE.html#cb181-42" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000)</span></span>
<span id="cb181-43"><a href="NE.html#cb181-43" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100)</span></span>
<span id="cb181-44"><a href="NE.html#cb181-44" tabindex="-1"></a></span>
<span id="cb181-45"><a href="NE.html#cb181-45" tabindex="-1"></a>simuls.did.panel <span class="ot">&lt;-</span> <span class="fu">lapply</span>(N.sample,sf.simuls.did.panel.N,<span class="at">Nsim=</span>Nsim,<span class="at">param=</span>param)</span>
<span id="cb181-46"><a href="NE.html#cb181-46" tabindex="-1"></a><span class="fu">names</span>(simuls.did.panel) <span class="ot">&lt;-</span> N.sample</span></code></pre></div>
<p>Let us now plot the results of the simulations:</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="NE.html#cb182-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb182-2"><a href="NE.html#cb182-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simuls.did.panel)){</span>
<span id="cb182-3"><a href="NE.html#cb182-3" tabindex="-1"></a>  <span class="fu">hist</span>(simuls.did.panel[[i]][,<span class="st">&#39;DID&#39;</span>],<span class="at">breaks=</span><span class="dv">30</span>,<span class="at">main=</span><span class="fu">paste</span>(<span class="st">&#39;N=&#39;</span>,<span class="fu">as.character</span>(N.sample[i])),<span class="at">xlab=</span><span class="fu">expression</span>(<span class="fu">hat</span>(Delta<span class="sc">^</span>yDID)),<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.15</span>,<span class="fl">0.55</span>))</span>
<span id="cb182-4"><a href="NE.html#cb182-4" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v=</span>TT.pop,<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb182-5"><a href="NE.html#cb182-5" tabindex="-1"></a>}</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:DIDPanelSimulPlot"></span>
<img src="STCI_files/figure-html/DIDPanelSimulPlot-1.png" alt="Distribution of the DID estimator over replications of panels of different sizes" width="50%" />
<p class="caption">
Figure 4.19: Distribution of the DID estimator over replications of panels of different sizes
</p>
</div>
<p>Figure <a href="NE.html#fig:DIDPanelSimulPlot">4.19</a> shows that the DID estimator converges pretty fast to the true treatment effect as sample size grows large.
Let us now wee what happens with a repeated cross section:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="NE.html#cb183-1" tabindex="-1"></a>monte.carlo.did.cross <span class="ot">&lt;-</span> <span class="cf">function</span>(s,N,param){</span>
<span id="cb183-2"><a href="NE.html#cb183-2" tabindex="-1"></a>  N.tot <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>N</span>
<span id="cb183-3"><a href="NE.html#cb183-3" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb183-4"><a href="NE.html#cb183-4" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N.tot,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb183-5"><a href="NE.html#cb183-5" tabindex="-1"></a>  UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N.tot,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb183-6"><a href="NE.html#cb183-6" tabindex="-1"></a>  yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb183-7"><a href="NE.html#cb183-7" tabindex="-1"></a>  YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb183-8"><a href="NE.html#cb183-8" tabindex="-1"></a>  Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N.tot)</span>
<span id="cb183-9"><a href="NE.html#cb183-9" tabindex="-1"></a>  Ds[YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb183-10"><a href="NE.html#cb183-10" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N.tot,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb183-11"><a href="NE.html#cb183-11" tabindex="-1"></a>  eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N.tot,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb183-12"><a href="NE.html#cb183-12" tabindex="-1"></a>  U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb183-13"><a href="NE.html#cb183-13" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb183-14"><a href="NE.html#cb183-14" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb183-15"><a href="NE.html#cb183-15" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb183-16"><a href="NE.html#cb183-16" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb183-17"><a href="NE.html#cb183-17" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb183-18"><a href="NE.html#cb183-18" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb183-19"><a href="NE.html#cb183-19" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb183-20"><a href="NE.html#cb183-20" tabindex="-1"></a>  <span class="co"># first cross section: 1-N</span></span>
<span id="cb183-21"><a href="NE.html#cb183-21" tabindex="-1"></a>  first <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>,N)</span>
<span id="cb183-22"><a href="NE.html#cb183-22" tabindex="-1"></a>  <span class="co"># second cross section: 1001-2000</span></span>
<span id="cb183-23"><a href="NE.html#cb183-23" tabindex="-1"></a>  second <span class="ot">&lt;-</span> <span class="fu">seq</span>(N<span class="sc">+</span><span class="dv">1</span>,N.tot)</span>
<span id="cb183-24"><a href="NE.html#cb183-24" tabindex="-1"></a>  <span class="co"># repeated cross section DID</span></span>
<span id="cb183-25"><a href="NE.html#cb183-25" tabindex="-1"></a>  delta.y.did.cross <span class="ot">&lt;-</span> <span class="fu">mean</span>(y[second][Ds[second]<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y[second][Ds[second]<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yB[first][Ds[first]<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[first][Ds[first]<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb183-26"><a href="NE.html#cb183-26" tabindex="-1"></a>  <span class="fu">return</span>(delta.y.did.cross)</span>
<span id="cb183-27"><a href="NE.html#cb183-27" tabindex="-1"></a>}</span>
<span id="cb183-28"><a href="NE.html#cb183-28" tabindex="-1"></a></span>
<span id="cb183-29"><a href="NE.html#cb183-29" tabindex="-1"></a>simuls.did.cross.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param){</span>
<span id="cb183-30"><a href="NE.html#cb183-30" tabindex="-1"></a>  simuls.did.cross <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.did.cross,<span class="at">N=</span>N,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb183-31"><a href="NE.html#cb183-31" tabindex="-1"></a>  <span class="fu">colnames</span>(simuls.did.cross) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;DID&#39;</span>)</span>
<span id="cb183-32"><a href="NE.html#cb183-32" tabindex="-1"></a>  <span class="fu">return</span>(simuls.did.cross)</span>
<span id="cb183-33"><a href="NE.html#cb183-33" tabindex="-1"></a>}</span>
<span id="cb183-34"><a href="NE.html#cb183-34" tabindex="-1"></a></span>
<span id="cb183-35"><a href="NE.html#cb183-35" tabindex="-1"></a>sf.simuls.did.cross.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nsim,param){</span>
<span id="cb183-36"><a href="NE.html#cb183-36" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span><span class="dv">8</span>)</span>
<span id="cb183-37"><a href="NE.html#cb183-37" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.did.cross,<span class="at">N=</span>N,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb183-38"><a href="NE.html#cb183-38" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb183-39"><a href="NE.html#cb183-39" tabindex="-1"></a>  <span class="fu">colnames</span>(sim) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;DID&#39;</span>)</span>
<span id="cb183-40"><a href="NE.html#cb183-40" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb183-41"><a href="NE.html#cb183-41" tabindex="-1"></a>}</span>
<span id="cb183-42"><a href="NE.html#cb183-42" tabindex="-1"></a></span>
<span id="cb183-43"><a href="NE.html#cb183-43" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb183-44"><a href="NE.html#cb183-44" tabindex="-1"></a><span class="co">#Nsim &lt;- 10</span></span>
<span id="cb183-45"><a href="NE.html#cb183-45" tabindex="-1"></a>N.sample <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">1000</span>,<span class="dv">10000</span>,<span class="dv">100000</span>)</span>
<span id="cb183-46"><a href="NE.html#cb183-46" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000)</span></span>
<span id="cb183-47"><a href="NE.html#cb183-47" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000)</span></span>
<span id="cb183-48"><a href="NE.html#cb183-48" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100)</span></span>
<span id="cb183-49"><a href="NE.html#cb183-49" tabindex="-1"></a></span>
<span id="cb183-50"><a href="NE.html#cb183-50" tabindex="-1"></a>simuls.did.cross <span class="ot">&lt;-</span> <span class="fu">lapply</span>(N.sample,sf.simuls.did.cross.N,<span class="at">Nsim=</span>Nsim,<span class="at">param=</span>param)</span>
<span id="cb183-51"><a href="NE.html#cb183-51" tabindex="-1"></a><span class="fu">names</span>(simuls.did.cross) <span class="ot">&lt;-</span> N.sample</span></code></pre></div>
<p>Let us now plot the results:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="NE.html#cb184-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb184-2"><a href="NE.html#cb184-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(simuls.did.cross)){</span>
<span id="cb184-3"><a href="NE.html#cb184-3" tabindex="-1"></a>  <span class="fu">hist</span>(simuls.did.cross[[i]][,<span class="st">&#39;DID&#39;</span>],<span class="at">breaks=</span><span class="dv">30</span>,<span class="at">main=</span><span class="fu">paste</span>(<span class="st">&#39;N=&#39;</span>,<span class="fu">as.character</span>(N.sample[i])),<span class="at">xlab=</span><span class="fu">expression</span>(<span class="fu">hat</span>(Delta<span class="sc">^</span>yDID)),<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.15</span>,<span class="fl">0.55</span>))</span>
<span id="cb184-4"><a href="NE.html#cb184-4" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">v=</span>TT.pop,<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb184-5"><a href="NE.html#cb184-5" tabindex="-1"></a>}</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:DIDCrossSectionSimulPlot"></span>
<img src="STCI_files/figure-html/DIDCrossSectionSimulPlot-1.png" alt="Distribution of the DID estimator over replications of repeated cross sections of different sizes" width="50%" />
<p class="caption">
Figure 4.20: Distribution of the DID estimator over replications of repeated cross sections of different sizes
</p>
</div>
<p>Relative to Figure <a href="NE.html#fig:DIDPanelSimulPlot">4.19</a>, Figure <a href="NE.html#fig:DIDCrossSectionSimulPlot">4.20</a> shows that sampling noise is larger at each sample size with a repeated cross section estimator.
Let’s see how we can estimate these below using the Central Limit Theorem.</p>
</div>
</div>
<div id="estimation-of-sampling-noise-2" class="section level4 hasAnchor" number="4.3.1.3">
<h4><span class="header-section-number">4.3.1.3</span> Estimation of sampling noise<a href="NE.html#estimation-of-sampling-noise-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>It is especially important to understand the properties of sampling noise for treatment effect estimators in DID designs because it can serve as a basis for power analysis, but also to understand the sources of improvements or loss of precision when moving from the simple with/without comparison to the DID estimator.
Let us first look at the sampling noise of the simpler <span class="math inline">\(2\times 2\)</span> DID estimator in a panel data with only two time periods.
We will then move to the sampling noise of the simpler <span class="math inline">\(2\times 2\)</span> DID estimator in a repeated cross section.</p>
<div id="estimating-sampling-noise-in-panel-settings" class="section level5 hasAnchor" number="4.3.1.3.1">
<h5><span class="header-section-number">4.3.1.3.1</span> Estimating sampling noise in panel settings<a href="NE.html#estimating-sampling-noise-in-panel-settings" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>When we estimate DID in a panel of two time periods, Theorem <a href="NE.html#thm:EstimDID">4.10</a> shows that all possible DID estimators are equivalent.
We can thus use the most convenient one in order to derive the Central Limit Theorem-based approximation to its distribution, and use it to estimate sampling noise.
The most convenient estimator, to me, is the First Difference estimator.
We indeed know that it is formulated as an OLS estimator, regressing the change in outcomes over time to the treatment dummy.
The First Difference estimator is thus simply a With/Without estimator where the outcomes are replaced by the changes in outcomes over time.
And we already know how to derive an Central Limit Theorem-based estimate of the sampling noise of the With/Without estimator.
In order to use these results, we need some assumptions:</p>
<div class="hypothesis">
<p><span id="hyp:iidDID" class="hypothesis"><strong>Hypothesis 4.15  (i.i.d. sampling in First Difference) </strong></span>We assume that the observations in the sample are identically and independently distributed in First Differences:
<span class="math display">\[\begin{align*}
\forall i,j\leq N\text{, }i\neq j\text{, } &amp; (Y_{i,A}-Y_{i,B},D_i)\Ind(Y_{j,A}-Y_{j,B},D_j),\\
                                           &amp; (Y_{i,A}-Y_{i,B},D_i)\&amp;(Y_{j,A}-Y_{j,B},D_j)\sim F_{Y_A-Y_B,D}.
\end{align*}\]</span></p>
</div>
<p>Assumption <a href="NE.html#hyp:iidDID">4.15</a> imposes that the changes in outcome over time are not correlated across units.
This is not a strong assumption.
It is actually much weaker than imposing that the levels of outcomes are distributed i.i.d. in the sample.
That would require that the outcomes of the same unit are not correlated over time, which is wrong if there are unit fixed effects <span class="math inline">\(\mu_i\)</span> or if the error terms are correlated across time (which is possible if shocks are persistent).
Assumption <a href="NE.html#hyp:iidDID">4.15</a> rules out spatial correlation between units, be it in the changes in outcomes or in receiving the treatment.
This is very restrictive.</p>
<p>We also need to assume that the changes in outcomes in both groups have finite variances:</p>
<div class="hypothesis">
<p><span id="hyp:finitevarDID" class="hypothesis"><strong>Hypothesis 4.16  (Finite variance of $\hat{\Delta^Y_{WW}}$) </strong></span>We assume that <span class="math inline">\(\var{Y^1_A-Y^0_B|D_i=1}\)</span> and <span class="math inline">\(\var{Y^0_A-Y^0_B|D_i=0}\)</span> are finite.</p>
</div>
<p>We now can state the following theorem:</p>
<div class="theorem">
<p><span id="thm:asympnoiseDID" class="theorem"><strong>Theorem 4.11  (Asymptotic Distribution of the DID Estimator in Panel Data) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrends">4.14</a>, <a href="NE.html#hyp:iidDID">4.15</a> and <a href="NE.html#hyp:finitevarDID">4.16</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}(\hat{\Delta}^Y_{DID}-\Delta^Y_{DID}) &amp; \stackrel{d}{\rightarrow}
  \mathcal{N}\left(0,\frac{\var{Y_{i,A}^1-Y_{i,B}^0|D_i=1}}{\Pr(D_i=1)}+\frac{\var{Y_{i,A}^0-Y_{i,B}^0|D_i=0}}{1-\Pr(D_i=1)}\right).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-102" class="proof"><em>Proof</em>. </span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrends">4.14</a>, Theorem <a href="NE.html#thm:EstimDID">4.10</a> proves that <span class="math inline">\(\hat{\Delta}^Y_{DID}=\hat{\beta}^{FD}\)</span>.
<span class="math inline">\(\hat{\beta}^{FD}\)</span> is obtained as the OLS estimator of the coefficient in front of <span class="math inline">\(D_i\)</span> in a regression of <span class="math inline">\(Y_{i,A}-Y_{i,B}\)</span> on <span class="math inline">\(D_i\)</span> and a constant.
Lemma <a href="proofs.html#lem:WWOLS">A.3</a> shows that, in such a regression, this coefficient is also a WW estimator, so that <span class="math inline">\(\hat{\beta}^{FD}=\hat{\Delta}^{Y_{A}-Y_{B}}_{WW}\)</span>.
Using Theorem <a href="FPSI.html#thm:asympnoiseWW">2.5</a> proves the result.</p>
</div>
<p>Theorem <a href="NE.html#thm:asympnoiseDID">4.11</a> shows that the precision of the DID estimator in panel settings depends on the variance of the changes in outcomes over time in the treated and control group.
Since outcomes for a given individual are generally correlated over time, the variance of the DID estimator will in general be lower than the variance of the WW estimator.
A case in point is when there are individual fixed effects in the equation generating outcomes: in that case, differencing outcomes over time gets rid of the individual fixed effects and thus the variance of the differences out outcomes is lower than the variance of outcomes in levels, since it misses the part due to the individual fixed effects.
So, in most cases (but not all of them), we can expect an increase in precision when moving from WW to DID.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-200" class="example"><strong>Example 4.35  </strong></span>Let’s see how our estimator of sampling noise performs in the data.</p>
</div>
<p>The true level of 99% sampling noise in the <span class="math inline">\(N=\)</span> 1000 sample is estimated from the simulations to be equal to 0.12, while the estimated level of 99% sampling noise using the formula from Theorem <a href="NE.html#thm:asympnoiseDID">4.11</a> is equal to 0.1.
The estimated level of 99% sampling noise obtained using the heteroskedasticity robust standard errors from the First Difference regression using OLS is equal to 0.11.
The estimated level of 99% sampling noise obtained using the heteroskedasticity robust standard errors from the DID regression using OLS is equal to 0.34.
It is much larger, because it assumes that we only have access to a repeated cross section, and thus it does not take into account the fact that we have more precision thanks to the panel data.
The estimated level of 99% sampling noise obtained using the heteroskedasticity robust standard errors from the Within regression using OLS is equal to 0.08.
The <code>plm</code> package corrects all standard errors for the panel nature of the data (irrespective of the type of estimator), and thus returns an estimate of 99% sampling noise equal to 0.11 for the Within estimator, 0.11 for the First Difference estimator and 0.11 for the pooled DID estimator.
Neither <code>lfe</code> nor <code>fixest</code> seem compatible with <code>vcovHC</code>, which enables the estimation of heteroskedasticity-robust standard errors.
The <code>lfe</code> package seems not to take into account heteroskedasticity by default: its estimate of 99% sampling noise is equal to 0.1.
The <code>fixest</code> package seems to take into account heteroskedasticity by default: its estimate of 99% sampling noise is equal to 0.11.</p>
</div>
<div id="estimating-sampling-noise-in-repeated-cross-sections" class="section level5 hasAnchor" number="4.3.1.3.2">
<h5><span class="header-section-number">4.3.1.3.2</span> Estimating sampling noise in repeated cross sections<a href="NE.html#estimating-sampling-noise-in-repeated-cross-sections" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>When we do not have access to panel data, a lot of the estimators we have studied here are infeasible.
This is the case of the First Difference estimator (we cannot build the difference in out comes over time for the same unit since we observe each unit only once).
The Within estimator is also compromised (we cannot build the average outcome over time for each observation, since, again, we only observe each observation only once).
The Least Squares Dummy Variables estimator is also infeasible, for the same reason: we need to observe each observation at least twice in order for the treatment dummy to not be collinear with the unit and time fixed effects.</p>
<p>But, both the basic DID formula and the Least Squares pooling estimator can still be computed with repeated cross sections.
As Figure <a href="NE.html#fig:DIDCrossSectionSimulPlot">4.20</a> has shown, the DID estimator is much more variable in repeated cross section: the level of 99% sampling noise in the <span class="math inline">\(N=\)</span> 1000 sample is estimated from the simulations to be equal to 0.28, while it is of 0.12 with panel data of the same size.
Let’s see how the Central-Limit Theorem can help us estimate this variance and shed some light on why we lose so much precision when moving from panel to cross section estimators.
It is unfortunately much more work to derive the CLT-based estimate of sampling noise with repeated cross-sections than with panel data.
We first need to respecify an i.i.d. assumption adapted to repeated cross sections:</p>
<div class="hypothesis">
<p><span id="hyp:iidDIDCross" class="hypothesis"><strong>Hypothesis 4.17  (i.i.d. sampling in Repeated Cross Sections) </strong></span>We assume that the observations in the sample are identically and independently distributed:
<span class="math display">\[\begin{align*}
\forall i,j\leq N_t\text{, }i\neq j\text{, }, \forall t,t&#39;\in\{A,B\}\text{, }t\neq t&#39;\text{, } &amp; (Y_{i,t},D_i)\Ind(Y_{j,t&#39;},D_j),\\
                                           &amp; (Y_{i,t},D_i)\&amp;(Y_{j,t&#39;},D_j)\sim F_{Y,D}.
\end{align*}\]</span></p>
</div>
<p>Assumption <a href="NE.html#hyp:iidDIDCross">4.17</a> imposes that outcomes are not correlated across units nor across time.
This is not a strong assumption in a repeated cross section, as long as the same units are not observed at both periods.
We now can state the following theorem:</p>
<div class="theorem">
<p><span id="thm:asympnoiseDIDCross" class="theorem"><strong>Theorem 4.12  (Asymptotic Distribution of the DID Estimator in Repeated Cross Sections) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrends">4.14</a>, <a href="NE.html#hyp:iidDIDCross">4.17</a> and <a href="FPSI.html#hyp:finitevar">2.3</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}(\hat{\Delta}^Y_{DID}-\Delta^Y_{DID}) &amp; \stackrel{d}{\rightarrow}
  \mathcal{N}\left(0,\frac{\var{Y^0_{i,B}|D_i=0}}{(1-p)(1-p_A)}
                            +\frac{\var{Y^0_{i,B}|D_i=1}}{p(1-p_A)}\right.\\
                &amp; \phantom{\stackrel{d}{\rightarrow}\mathcal{N}\left(0,\right.} \left.
                            +\frac{\var{Y^0_{i,A}|D_i=0}}{(1-p)p_A}
                            +\frac{\var{Y^1_{i,A}|D_i=1}}{pp_A}\right).
\end{align*}\]</span></p>
<p>where <span class="math inline">\(p=\Pr(D_i=1)\)</span> and <span class="math inline">\(p_A\)</span> is the proportion of observations belonging to the After period.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-103" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofasympnoiseDIDCross">A.3.2</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-104" class="remark"><em>Remark</em>. </span>Note that the difference between the amount of sampling noise of the DID estimator in panel data in repeated cross sections is present whatever the estimator (in panel data, all the estimators are equivalent).
It is not differencing or taking the within transformation that gets rid of sampling noise, it is collecting data on the same observations twice.
Differencing only helps the OLS estimator of the standard errors to understand that we have panel data and to reflect it in its estimate of precision.
The DID estimator is always more precise in panel data (in our example).
The CLT-based estimator of precision does not always reflect that fact, because we have not correctly specified it.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-203" class="example"><strong>Example 4.36  </strong></span>Let’s see how our estimator of sampling noise performs in the data.</p>
</div>
<p>The true level of 99% sampling noise in the <span class="math inline">\(N=\)</span> 1000 sample is estimated from the simulations to be equal to 0.28, while the estimated level of 99% sampling noise using the formula from Theorem <a href="NE.html#thm:asympnoiseDIDCross">4.12</a> is equal to 0.34.
The estimated level of 99% sampling noise obtained using the heteroskedasticity robust standard errors from the DID regression using OLS is equal to 0.34.</p>
</div>
</div>
</div>
<div id="sec:DIDr" class="section level3 hasAnchor" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> Reverse Difference In Differences designs with two time periods<a href="NE.html#sec:DIDr" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before getting into the general case of DID with several time periods and several treatment dates, it is useful to quickly look at identification in the case of reverse DID designs.
We are going to look at two such designs.
In the first type, some units are exposed to the treatment in the first period and the rest of the units enter the treatment in the second period.
In the second type of reverse DID design, all units receive the treatment in the first period and some units exit the treatment in the second period.</p>
<div id="sec:DIDr2" class="section level4 hasAnchor" number="4.3.2.1">
<h4><span class="header-section-number">4.3.2.1</span> Reverse DID designs where everyone enters the treatment at the second period<a href="NE.html#sec:DIDr2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Compared to the setting in the previous section, the main change is to Assumption <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>:</p>
<div class="hypothesis">
<p><span id="hyp:AllTreatmentSecond" class="hypothesis"><strong>Hypothesis 4.18  (Everyone Receives Treatment in the Second Period) </strong></span>We assume that every unit in the population receives the treatment in the second period: <span class="math inline">\(D_{i,A}=1\)</span>, <span class="math inline">\(\forall i\)</span>.</p>
</div>
<p>Under Assumption <a href="NE.html#hyp:AllTreatmentSecond">4.18</a>, and without loss of generality, we can write <span class="math inline">\(D_i=D_{i,B}\)</span>, <span class="math inline">\(\forall i\)</span>.
We are going to call the units which stay in the treatment during the two periods <em>always takers</em> and the units who enter the treatment in the second period <em>switchers</em>.
<em>Always takers</em> are defined by <span class="math inline">\(D_i=1\)</span> while <em>switchers</em> are defined by <span class="math inline">\(D_i=0\)</span>.</p>
<p>In this new setting, we have to redefine the DID estimator.
We are going to choose an estimator that compares the change in outcomes among individuals who have changed treatment status (<em>switchers</em>) to the change in outcome among individuals who have not changed treatment status (<em>always takers</em>):</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{DID^r} &amp; = \esp{Y_{i,A}|D_i=0} - \esp{Y_{i,B}|D_i=0} - (\esp{Y_{i,A}|D_i=1} - \esp{Y_{i,B}|D_i=1}).\\
\end{align*}\]</span></p>
<p>Note that <span class="math inline">\(\Delta^Y_{DID^r}\)</span> is the opposite of the more usual DID estimator <span class="math inline">\(\Delta^Y_{DID}\)</span>, hence the name of reverse DID.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-204" class="example"><strong>Example 4.37  </strong></span>Let us generate data in our example model that complies with Assumption <a href="NE.html#hyp:AllTreatmentSecond">4.18</a>.</p>
</div>
<p><span class="math display">\[\begin{align*}
y^1_{i,A} &amp; = y_{i,A}^0+\bar{\alpha}_A+\bar{\alpha}_{AT}D_{i,B}+\theta_A\mu_i+\eta_{i,A} \\
y^0_{i,A} &amp; = \mu_i+\delta+U^0_{i,A} \\
U^0_{i,A} &amp; = \rho U_{i,B}+\epsilon_{i,A} \\
y^1_{i,B} &amp; =y^0_{i,B} + \bar{\alpha}_B+\theta_B\mu_i+\eta_{i,B} \\
y^0_{i,B} &amp; =\mu_i+U_{i,B} \\
U_{i,B} &amp; \sim\mathcal{N}(0,\sigma^2_{U}) \\
D_{i,B}   &amp; = \uns{y^0_{i,B}+ V_i\leq\bar{y}} \\
V_i   &amp; = \gamma(\mu_i-\bar{\mu}) + \omega_i \\
(\eta_{i,A},\eta_{i,B},\omega_i) &amp; \sim\mathcal{N}(0,0,0,\sigma^2_{\eta},\sigma^2_{\eta},\sigma^2_{\omega},0,\rho_{\eta,\omega})
\end{align*}\]</span></p>
<p>Note that in this model we first have imposed that some people enter the treatment in the first period (period <span class="math inline">\(B\)</span>).
We also have added other important features, such as the fact that the effect of the treatment varies over time.
The most important component of this variation is the constant parameter <span class="math inline">\(\bar{\alpha}\)</span> which now differs from period to period (<span class="math inline">\(\bar{\alpha}_A\neq\bar{\alpha}_B\)</span>).
The treatment effect also varies over group and over time, with the <em>always treated</em> group (characterized by <span class="math inline">\(D_{i,B}=1\)</span>) having an additional increase in treatment effects of <span class="math inline">\(\bar{\alpha}_{AT}\)</span> in period <span class="math inline">\(A\)</span>.
Let’s encode new parameter values.</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="NE.html#cb185-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,<span class="fl">0.01</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.2</span>,<span class="fl">0.1</span>,<span class="fl">0.3</span>,<span class="fl">0.1</span>,<span class="fl">0.28</span>,<span class="dv">0</span>)</span>
<span id="cb185-2"><a href="NE.html#cb185-2" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,<span class="st">&quot;thetaA&quot;</span>,<span class="st">&quot;thetaB&quot;</span>,<span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;baralphaA&quot;</span>,<span class="st">&quot;baralphaB&quot;</span>,<span class="st">&quot;baralphaAT&quot;</span>,<span class="st">&quot;gamma&quot;</span>,<span class="st">&quot;sigma2omega&quot;</span>,<span class="st">&quot;rhoetaomega&quot;</span>)</span></code></pre></div>
<p>Let’s now simulate a dataset according to these new equations.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="NE.html#cb186-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb186-2"><a href="NE.html#cb186-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb186-3"><a href="NE.html#cb186-3" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],<span class="dv">0</span>,param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb186-4"><a href="NE.html#cb186-4" tabindex="-1"></a>                          <span class="dv">0</span>,param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb186-5"><a href="NE.html#cb186-5" tabindex="-1"></a>                          param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">byrow=</span>T)</span>
<span id="cb186-6"><a href="NE.html#cb186-6" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb186-7"><a href="NE.html#cb186-7" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;etaA&#39;</span>,<span class="st">&#39;etaB&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb186-8"><a href="NE.html#cb186-8" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb186-9"><a href="NE.html#cb186-9" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb186-10"><a href="NE.html#cb186-10" tabindex="-1"></a>y0B <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb186-11"><a href="NE.html#cb186-11" tabindex="-1"></a>Y0B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0B)</span>
<span id="cb186-12"><a href="NE.html#cb186-12" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb186-13"><a href="NE.html#cb186-13" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb186-14"><a href="NE.html#cb186-14" tabindex="-1"></a>Ds[y0B<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb186-15"><a href="NE.html#cb186-15" tabindex="-1"></a>alphaB <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaB&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;thetaB&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaB</span>
<span id="cb186-16"><a href="NE.html#cb186-16" tabindex="-1"></a>y1B <span class="ot">&lt;-</span> y0B<span class="sc">+</span>alphaB</span>
<span id="cb186-17"><a href="NE.html#cb186-17" tabindex="-1"></a>Y1B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1B)</span>
<span id="cb186-18"><a href="NE.html#cb186-18" tabindex="-1"></a>epsilonA <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb186-19"><a href="NE.html#cb186-19" tabindex="-1"></a>U0A <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilonA</span>
<span id="cb186-20"><a href="NE.html#cb186-20" tabindex="-1"></a>y0A <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0A <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb186-21"><a href="NE.html#cb186-21" tabindex="-1"></a>alphaA <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaA&quot;</span>]<span class="sc">+</span> param[<span class="st">&quot;baralphaAT&quot;</span>]<span class="sc">*</span>Ds<span class="sc">+</span> param[<span class="st">&quot;thetaA&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaA</span>
<span id="cb186-22"><a href="NE.html#cb186-22" tabindex="-1"></a>y1A <span class="ot">&lt;-</span> y0A<span class="sc">+</span>alphaA</span>
<span id="cb186-23"><a href="NE.html#cb186-23" tabindex="-1"></a>Y0A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0A)</span>
<span id="cb186-24"><a href="NE.html#cb186-24" tabindex="-1"></a>Y1A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1A)</span>
<span id="cb186-25"><a href="NE.html#cb186-25" tabindex="-1"></a>yB <span class="ot">&lt;-</span> y1B<span class="sc">*</span>Ds<span class="sc">+</span>y0B<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb186-26"><a href="NE.html#cb186-26" tabindex="-1"></a>YB <span class="ot">&lt;-</span> Y1B<span class="sc">*</span>Ds<span class="sc">+</span>Y0B<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb186-27"><a href="NE.html#cb186-27" tabindex="-1"></a>yA <span class="ot">&lt;-</span> y1A</span>
<span id="cb186-28"><a href="NE.html#cb186-28" tabindex="-1"></a>YA <span class="ot">&lt;-</span> Y1A</span></code></pre></div>
<p>Let’s see how DID works on this data.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="NE.html#cb187-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>)</span>
<span id="cb187-2"><a href="NE.html#cb187-2" tabindex="-1"></a>y.AT <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb187-3"><a href="NE.html#cb187-3" tabindex="-1"></a>y.AT.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb187-4"><a href="NE.html#cb187-4" tabindex="-1"></a>y.Switchers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb187-5"><a href="NE.html#cb187-5" tabindex="-1"></a>y.Switchers.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb187-6"><a href="NE.html#cb187-6" tabindex="-1"></a>y.Switchers.counterfactual<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y1B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y1A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb187-7"><a href="NE.html#cb187-7" tabindex="-1"></a>y.Switchers.DID <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb187-8"><a href="NE.html#cb187-8" tabindex="-1"></a>y.Switchers.DID<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb187-9"><a href="NE.html#cb187-9" tabindex="-1"></a>data.DID.plot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">c</span>(y.AT,y.AT.counterfactual,y.Switchers,y.Switchers.counterfactual,y.Switchers.counterfactual<span class="fl">.1</span>,y.Switchers.DID,y.Switchers.DID<span class="fl">.1</span>))</span>
<span id="cb187-10"><a href="NE.html#cb187-10" tabindex="-1"></a><span class="fu">colnames</span>(data.DID.plot) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Outcome&quot;</span>) </span>
<span id="cb187-11"><a href="NE.html#cb187-11" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Period <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(x,<span class="dv">7</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>))</span>
<span id="cb187-12"><a href="NE.html#cb187-12" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>))</span>
<span id="cb187-13"><a href="NE.html#cb187-13" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Observed <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>))</span>
<span id="cb187-14"><a href="NE.html#cb187-14" tabindex="-1"></a></span>
<span id="cb187-15"><a href="NE.html#cb187-15" tabindex="-1"></a>WW.before <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb187-16"><a href="NE.html#cb187-16" tabindex="-1"></a>WW.after <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb187-17"><a href="NE.html#cb187-17" tabindex="-1"></a>BA.AT <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb187-18"><a href="NE.html#cb187-18" tabindex="-1"></a>BA.Switchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb187-19"><a href="NE.html#cb187-19" tabindex="-1"></a>Counterfactual.after <span class="ot">&lt;-</span> <span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span>BA.AT</span>
<span id="cb187-20"><a href="NE.html#cb187-20" tabindex="-1"></a>DIDr <span class="ot">&lt;-</span> BA.Switchers <span class="sc">-</span> BA.AT </span>
<span id="cb187-21"><a href="NE.html#cb187-21" tabindex="-1"></a>TTASwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb187-22"><a href="NE.html#cb187-22" tabindex="-1"></a>TTBSwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb187-23"><a href="NE.html#cb187-23" tabindex="-1"></a>TTAAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb187-24"><a href="NE.html#cb187-24" tabindex="-1"></a>TTBAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb187-25"><a href="NE.html#cb187-25" tabindex="-1"></a></span>
<span id="cb187-26"><a href="NE.html#cb187-26" tabindex="-1"></a><span class="fu">ggplot</span>(data.DID.plot,<span class="fu">aes</span>(<span class="at">x=</span>Period,<span class="at">y=</span>Outcome,<span class="at">group=</span>Group,<span class="at">color=</span>Group,<span class="at">shape=</span>Group,<span class="at">linetype=</span>Observed))<span class="sc">+</span></span>
<span id="cb187-27"><a href="NE.html#cb187-27" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb187-28"><a href="NE.html#cb187-28" tabindex="-1"></a>    <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb187-29"><a href="NE.html#cb187-29" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">guide=</span><span class="st">&#39;none&#39;</span>) <span class="sc">+</span></span>
<span id="cb187-30"><a href="NE.html#cb187-30" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDRev2nd"></span>
<img src="STCI_files/figure-html/PlotDIDRev2nd-1.png" alt="Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the second period" width="50%" />
<p class="caption">
Figure 4.21: Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the second period
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDRev2nd">4.21</a> shows that DID does not work well in this example.
Indeed, the true treatment effect among switchers after the treatment is equal to 0.3 in the sample, while the DID estimator is equal to -0.11.
The <span class="math inline">\(DID^r\)</span> estimator is of the wrong sign.
Why is that?
Note that the <span class="math inline">\(DID^r\)</span> estimator uses the change in outcomes among the <em>always treated</em> to approximate the change in outcome that would have occurred for the <em>switchers</em> if they have stayed outside of the treatment.
The problem is that this approximation does not work at all: the increases in outcome for the <em>always treated</em> is much steeper than the increase in outcomes that would have happened to the <em>switchers</em> had they stayed outside of the treatment (0.44 <span class="math inline">\(&gt;\)</span> 0.33).
As a consequence, the <span class="math inline">\(DID^r\)</span> estimator overestimates the counterfactual level that would have been reached by the <em>switchers</em> in the second period in the absence of the treatment.
Ultimately, the <span class="math inline">\(DID^r\)</span> estimator underestimates severely the effect of the treatment.
Note that the usual assumption of parallel trends does hold in this example.
The problem comes form somewhere else.
One way to understand the problems with the <span class="math inline">\(DID^r\)</span> estimator is to see that the change in treatment effects over time and between groups over time confounds the effect of the treatment.
The only way to make the <span class="math inline">\(DID^r\)</span> estimator work is to assume these confounders away.</p>
<p>In order to clarify the conditions under which the <span class="math inline">\(DID^r\)</span> estimator is valid, let us state the following assumption:</p>
<div class="hypothesis">
<p><span id="hyp:ParallelTrendsy1" class="hypothesis"><strong>Hypothesis 4.19  (Parallel Trends in the presence of the treatment) </strong></span>We assume that the trends in the potential outcomes in the presence the treatment are the same for the treated and the untreated units:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^1_{i,A}|D_i=1} - \esp{Y^1_{i,B}|D_i=1} &amp; = \esp{Y^1_{i,A}|D_i=0} - \esp{Y^1_{i,B}|D_i=0}.
\end{align*}\]</span></p>
</div>
<p>Under Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>, we can show that the <span class="math inline">\(DID^r\)</span> estimator identifies the effect of the treatment on the <em>switchers</em> in the first period:</p>
<div class="theorem">
<p><span id="thm:IdentDIDr" class="theorem"><strong>Theorem 4.13  (DIDr identifies TUT in the first period) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>, the <span class="math inline">\(DID^r\)</span> estimator identifies the average effect of the Treatment on the switchers before the treatment:</p>
<p><span class="math display">\[\begin{align*}
    \Delta_{DID^r}^{Y} &amp; =  \Delta^{Y_B}_{TUT},
\end{align*}\]</span></p>
</div>
<p>with:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^{Y_B}_{TUT} &amp; = \esp{Y^1_{i,B}-Y^0_{i,B}|D_{i}=0}.
\end{align*}\]</span></p>
<div class="proof">
<p><span id="unlabeled-div-105" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
  \Delta^Y_{DID^r} &amp; = \esp{Y_{i,A}|D_i=0}-\esp{Y_{i,B}|D_i=0}-(\esp{Y_{i,A}|D_i=1}-\esp{Y_{i,B}|D_i=1}) \\
                &amp; = \esp{Y^1_{i,A}|D_i=0}-\esp{Y^0_{i,B}|D_i=0}-(\esp{Y^1_{i,A}|D_i=1}-\esp{Y^1_{i,B}|D_i=1})\\
                &amp; = \esp{Y^1_{i,A}|D_i=0} - \esp{Y^0_{i,B}|D_i=0}-(\esp{Y^1_{i,A}|D_i=0}-\esp{Y^1_{i,B}|D_i=0})\\
                &amp; = \esp{Y^1_{i,B}-Y^0_{i,B}|D_i=0}
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a> and <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and the switching equation, and the third equality follows from Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>.</p>
</div>
<p>Theorem <a href="NE.html#thm:IdentDIDr">4.13</a> shows that under an alternative assumption of parallel trends (that they hold for potential outcomes when units are in the treatment), the <span class="math inline">\(DID^r\)</span> estimator identifies the causal effect of the treatment on the <em>switchers</em> <strong>before</strong> the treatment takes place.</p>
<div class="remark">
<p><span id="unlabeled-div-106" class="remark"><em>Remark</em>. </span>Note that it makes intuitive sense: the only true change is that of the <em>switchers</em> entering the treatment.
Using the <em>always takers</em>, we can only learn about the changes in potential outcomes when in the treatment.
Under Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>, the <em>switchers</em> would have experimented the same change in outcomes than the <em>always takers</em> if they have been constantly treated.
As a consequence, we can use the change in outcomes among the <em>always takers</em> to project back what would have been the outcomes of the <em>switchers</em> in the first period had they been exposed to the treatment.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-107" class="remark"><em>Remark</em>. </span>Note as well that Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>, when paired with Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>, is actually restrictive in terms of how the treatment effects might change over time and between groups, as the following lemma shows:</p>
</div>
<div class="lemma">
<p><span id="lem:ParallelTrendsCstTreatmentEffectsTime" class="lemma"><strong>Lemma 4.4  (Parallel Trends Restricts the Way Treatment Effects Change Over Time) </strong></span>Assumptions <a href="NE.html#hyp:ParallelTrends">4.14</a> and <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> imply that <em>always takers</em> and <em>switchers</em> experience the same changes in treatment effects over time:</p>
<p><span class="math display">\[\begin{align*}
   \Delta^{Y_A}_{TUT}- \Delta^{Y_B}_{TUT} &amp; = \Delta^{Y_A}_{TT}- \Delta^{Y_B}_{TT}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-108" class="proof"><em>Proof</em>. </span>Substracting the parallel trends condition in Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a> from the parallel trends condition in Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^1_{i,A}|D_i=1} - \esp{Y^1_{i,B}|D_i=1}-(\esp{Y^0_{i,A}|D_i=1} - \esp{Y^0_{i,B}|D_i=1}) &amp; = \esp{Y^1_{i,A}|D_i=0} - \esp{Y^1_{i,B}|D_i=0}-(\esp{Y^0_{i,A}|D_i=0} - \esp{Y^0_{i,B}|D_i=0}).
\end{align*}\]</span></p>
<p>After some manipulation, we get:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=1} - \esp{Y^1_{i,B}-Y^0_{i,B}|D_i=1}&amp; = \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=0} - \esp{Y^1_{i,B}-Y^0_{i,B}|D_i=0},.
\end{align*}\]</span></p>
<p>which proves the result.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-109" class="remark"><em>Remark</em>. </span>There remains a final question: are there any conditions under which we could use the <span class="math inline">\(DID^r\)</span> estimator to identify the effect of the treatment on the <em>switchers</em> after the treatment takes place?
In practice, that means that we need to recover the trends the <em>switchers</em> would have experienced had they not entered the treatment.
This puts a stark requirement on the available data because we have no information on what outcomes in the absence of the treatment would be in the second period.
One natural but also super strong assumption is to assume that the change in outcomes among the <em>always takers</em> in the presence of the treatment is the same as the one that the <em>switchers</em> would have experienced in the absence of the treatment:</p>
</div>
<div class="hypothesis">
<p><span id="hyp:ParallelTrendsy1y0" class="hypothesis"><strong>Hypothesis 4.20  (Parallel Trends for Always Takers in the Presence of the Treatment and Switchers in the Absence of the Treatment) </strong></span>We assume that the trends in the potential outcomes in the presence the treatment for the <em>always takers</em> are the same as the trends in potential outcomes in the absence of the treatment for the <em>switchers</em> :</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^1_{i,A}|D_i=1} - \esp{Y^1_{i,B}|D_i=1} &amp; = \esp{Y^0_{i,A}|D_i=0} - \esp{Y^0_{i,B}|D_i=0}.
\end{align*}\]</span></p>
</div>
<p>Under Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a>, we can recover the treatment effect on teh switchers in the second period:</p>
<div class="theorem">
<p><span id="thm:IdentDIDry1y0" class="theorem"><strong>Theorem 4.14  (DIDr identifies TUT in the second period) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a>, the <span class="math inline">\(DID^r\)</span> estimator identifies the average effect of the Treatment on the switchers after the treatment:</p>
<p><span class="math display">\[\begin{align*}
    \Delta_{DID^r}^{Y} &amp; =  \Delta^{Y_A}_{TUT},
\end{align*}\]</span></p>
</div>
<p>with:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^{Y_A}_{TUT} &amp; = \esp{Y^1_{i,A}-Y^0_{i,A}|D_{i}=0}.
\end{align*}\]</span></p>
<div class="proof">
<p><span id="unlabeled-div-110" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
  \Delta^Y_{DID^r} &amp; = \esp{Y_{i,A}|D_i=0}-\esp{Y_{i,B}|D_i=0}-(\esp{Y_{i,A}|D_i=1}-\esp{Y_{i,B}|D_i=1}) \\
                &amp; = \esp{Y^1_{i,A}|D_i=0}-\esp{Y^0_{i,B}|D_i=0}-(\esp{Y^1_{i,A}|D_i=1}-\esp{Y^1_{i,B}|D_i=1})\\
                &amp; = \esp{Y^1_{i,A}|D_i=0} - \esp{Y^0_{i,B}|D_i=0}-(\esp{Y^0_{i,A}|D_i=0}-\esp{Y^0_{i,B}|D_i=0})\\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=0}
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a> and <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and the switching equation, and the third equality follows from Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-111" class="remark"><em>Remark</em>. </span>What does Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a> really mean?
It is unusual, but is it highly restrictive?
The following lemma helps to make sense of it:</p>
</div>
<div class="lemma">
<p><span id="lem:ParallelTrendsCstTreatmentEffects" class="lemma"><strong>Lemma 4.5  (Parallel Trends and Treatment Effects) </strong></span>The parallel trends assumptions restrict the way treatment effects might change over time: <em>(i)</em> Assumptions <a href="NE.html#hyp:ParallelTrends">4.14</a> and <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a> together imply the effect of the treatment is constant over time among <em>always takers</em>: <span class="math inline">\(\Delta^{Y_A}_{TT} = \Delta^{Y_B}_{TT}\)</span>; <em>(ii)</em> Assumptions <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> and <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a> together imply the effect of the treatment is constant over time among <em>switchers</em>: <span class="math inline">\(\Delta^{Y_A}_{TUT} = \Delta^{Y_B}_{TUT}\)</span>; <em>(iii)</em> Assumptions <a href="NE.html#hyp:ParallelTrends">4.14</a>, <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> and <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a> together imply the effect of the treatment is constant over time among <em>switchers</em> and <em>always takers</em>: <span class="math inline">\(\Delta^{Y_A}_{TUT} = \Delta^{Y_B}_{TUT}\)</span> and <span class="math inline">\(\Delta^{Y_A}_{TT} = \Delta^{Y_B}_{TT}\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-112" class="proof"><em>Proof</em>. </span>Substracting the parallel trends condition in Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a> from the parallel trends condition in Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^1_{i,A}|D_i=1} - \esp{Y^1_{i,B}|D_i=1}-(\esp{Y^0_{i,A}|D_i=1} - \esp{Y^0_{i,B}|D_i=1}) &amp; = \esp{Y^0_{i,A}|D_i=0} - \esp{Y^0_{i,B}|D_i=0}-(\esp{Y^0_{i,A}|D_i=0} - \esp{Y^0_{i,B}|D_i=0}).
\end{align*}\]</span></p>
<p>After some manipulation, we get:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=1}&amp; = \esp{Y^1_{i,B}-Y^0_{i,B}|D_i=1}.
\end{align*}\]</span></p>
<p>which proves the first result.</p>
<p>Substracting the parallel trends condition in Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> from the parallel trends condition in Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^1_{i,A}|D_i=1} - \esp{Y^1_{i,B}|D_i=1}-(\esp{Y^1_{i,A}|D_i=1} - \esp{Y^1_{i,B}|D_i=1}) &amp; = \esp{Y^1_{i,A}|D_i=0} - \esp{Y^1_{i,B}|D_i=0}-(\esp{Y^0_{i,A}|D_i=0} - \esp{Y^0_{i,B}|D_i=0}).
\end{align*}\]</span></p>
<p>After some manipulation, we get:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=0}&amp; = \esp{Y^1_{i,B}-Y^0_{i,B}|D_i=0}.
\end{align*}\]</span></p>
<p>which proves the second result.</p>
<p>The first two results imply the last one.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-113" class="remark"><em>Remark</em>. </span>It is noteworthy that combining the three assumptions together does not imply anything more than when combining them separately.
The key is that Assumptions <a href="NE.html#hyp:ParallelTrends">4.14</a> and <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> together already imply that treatment effects change in the same way over time in both groups.
Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a> together with Assumptions <a href="NE.html#hyp:ParallelTrends">4.14</a> and <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> implies also that all potential outcomes have to change in the same way over time in both groups.
The only way for these two properties to be true at the same time is for treatment effects in noth groups to be constant over time.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-114" class="remark"><em>Remark</em>. </span>Note that Lemma <a href="NE.html#lem:ParallelTrendsCstTreatmentEffects">4.5</a> does not imply that treatment effects are the same in both groups.
They do not have to be.
Assumptions <a href="NE.html#hyp:ParallelTrends">4.14</a>, <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> and <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a> allow for the treatment effects among <em>switchers</em> and always takers to be different.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-115" class="remark"><em>Remark</em>. </span>A useful result is also to express the bias of the <span class="math inline">\(DID^r\)</span> estimator when only Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a> holds.
The following lemma does the job:</p>
</div>
<div class="theorem">
<p><span id="thm:BiasDIDr" class="theorem"><strong>Theorem 4.15  (Bias of the DIDr estimator) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and <a href="NE.html#hyp:ParallelTrends">4.14</a>, the <span class="math inline">\(DID^r\)</span> estimator is biased for the average effect of the Treatment on the switchers before and after the treatment:</p>
<p><span class="math display">\[\begin{align*}
    \Delta_{DID^r}^{Y} &amp; =  \Delta^{Y_B}_{TUT}+B^{Y_B}_{DID^r} \\
    \Delta_{DID^r}^{Y} &amp; =  \Delta^{Y_A}_{TUT}+B^{Y_A}_{DID^r}
\end{align*}\]</span></p>
<p>with:</p>
<p><span class="math display">\[\begin{align*}
    B^{Y_B}_{DID^r} &amp; =  \Delta^{Y_A}_{TUT}-\Delta^{Y_B}_{TUT}-(\Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT})\\
    B^{Y_A}_{DID^r} &amp; = -(\Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT}).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-116" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
  \Delta^Y_{DID^r} &amp; = \esp{Y_{i,A}-Y_{i,B}|D_i=0}-\esp{Y_{i,A}-Y_{i,B}|D_i=1} \\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,B}|D_i=0}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}\\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,B}|D_i=0}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=0}+\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=0}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1} \\
                &amp; = \esp{Y^1_{i,B}-Y^0_{i,B}|D_i=0}+\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=0}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1} \\
                &amp; = \Delta^{Y_B}_{TUT}+\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=0}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}\\
                &amp; \phantom{=}-(\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=0}-\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=1})\\
                &amp; = \Delta^{Y_B}_{TUT}+\Delta^{Y_A}_{TUT}-\Delta^{Y_B}_{TUT}-(\Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT})
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a> and <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and the switching equation, and the fifth equality follows from Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>.</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{DID^r} &amp; = \esp{Y_{i,A}-Y_{i,B}|D_i=0}-\esp{Y_{i,A}-Y_{i,B}|D_i=1} \\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,B}|D_i=0}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}\\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,B}|D_i=0}-\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=0}+\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=0}\\
                &amp; \phantom{=}-\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=1}+\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=1}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1} \\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=0}+\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=1}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1} \\
                &amp; = \Delta^{Y_A}_{TUT}-(\esp{Y^1_{i,A}-Y^0_{i,A}|D_i=1}-\esp{Y^1_{i,B}-Y^0_{i,B}|D_i=1}) \\
                &amp; = \Delta^{Y_A}_{TUT}-(\Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT})
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a> and <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> and the switching equation, and the fourth equality follows from Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>.</p>
</div>
<p>Theorem <a href="NE.html#thm:BiasDIDr">4.15</a> helps to make sense of Figure <a href="NE.html#fig:PlotDIDRev2nd">4.21</a>.
The bias of the <span class="math inline">\(DID^r\)</span> estimator for the average effect of the treatment on the <em>switchers</em> in the second period is equal to the opposite of the change in treatment effects for the <em>always treated</em> between the first and the second period.
This means that if the effect of the treatment increases over time for the <em>always takers</em>, the <span class="math inline">\(DID^r\)</span> estimator will be biased negatively.
If this negative bias is sufficiently large, it can make an altogether positive treatment effect (both on <em>switchers</em> and <em>always takers</em> at every period) look negative.
This is a very serious problem and the main reason why you want to be very careful when using the <span class="math inline">\(DID^r\)</span> estimator.
This is actually what happens in Figure <a href="NE.html#fig:PlotDIDRev2nd">4.21</a>: the change in treatment effect over time among the <em>always treated</em> is very large (it is equal to 0.37) while the treatment effect is only equal to 0.3.
As a consequence, the <span class="math inline">\(DID^r\)</span> estimator is equal to -0.11 whereas every average treatment effect is positive: <span class="math inline">\(\hat{\Delta}^{y_A}_{TT}=\)</span> 0.54 <span class="math inline">\(\hat{\Delta}^{y_B}_{TT}=\)</span> 0.17, <span class="math inline">\(\hat{\Delta}^{y_A}_{TUT}=\)</span> 0.3 and <span class="math inline">\(\hat{\Delta}^{y_B}_{TUT}=\)</span> 0.17.</p>
<p>Theorem <a href="NE.html#thm:BiasDIDr">4.15</a> also explains why the <span class="math inline">\(DID^r\)</span> estimator is biased for the effect of the treatment in the first period.
This is because the effect of the treatment changes differently over time among <em>switchers</em> and among <em>always takers</em>.
On Figure <a href="NE.html#fig:PlotDIDRev2nd">4.21</a>, the average treatment effect on <em>switchers</em> increases by 0.12, and it is not approximated well by the change in treatment effect among the <em>always takers</em> (0.37).
As a consequence, the <span class="math inline">\(DID^r\)</span> estimator is equal to -0.11 while the average effect of the treatment on the <em>switchers</em> in the first period is equal to: <span class="math inline">\(\hat{\Delta}^{y_B}_{TUT}=\)</span> 0.17.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-217" class="example"><strong>Example 4.38  </strong></span>Let us now explore how the way Theorem <a href="NE.html#thm:BiasDIDr">4.15</a> plays out in our data.
For that, we are going to first switch off the change in treatment effects that is specific to the <em>always takers</em> in the second period.
As a case in point, we are going to set <span class="math inline">\(\bar{\alpha}_{AT}=0\)</span>.</p>
</div>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="NE.html#cb188-1" tabindex="-1"></a>param[<span class="st">&quot;baralphaAT&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span></code></pre></div>
<p>Let’s now simulate a dataset according to these new equations.</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="NE.html#cb189-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb189-2"><a href="NE.html#cb189-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb189-3"><a href="NE.html#cb189-3" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],<span class="dv">0</span>,param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb189-4"><a href="NE.html#cb189-4" tabindex="-1"></a>                          <span class="dv">0</span>,param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb189-5"><a href="NE.html#cb189-5" tabindex="-1"></a>                          param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">byrow=</span>T)</span>
<span id="cb189-6"><a href="NE.html#cb189-6" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb189-7"><a href="NE.html#cb189-7" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;etaA&#39;</span>,<span class="st">&#39;etaB&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb189-8"><a href="NE.html#cb189-8" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb189-9"><a href="NE.html#cb189-9" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb189-10"><a href="NE.html#cb189-10" tabindex="-1"></a>y0B <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb189-11"><a href="NE.html#cb189-11" tabindex="-1"></a>Y0B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0B)</span>
<span id="cb189-12"><a href="NE.html#cb189-12" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb189-13"><a href="NE.html#cb189-13" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb189-14"><a href="NE.html#cb189-14" tabindex="-1"></a>Ds[y0B<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb189-15"><a href="NE.html#cb189-15" tabindex="-1"></a>alphaB <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaB&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;thetaB&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaB</span>
<span id="cb189-16"><a href="NE.html#cb189-16" tabindex="-1"></a>y1B <span class="ot">&lt;-</span> y0B<span class="sc">+</span>alphaB</span>
<span id="cb189-17"><a href="NE.html#cb189-17" tabindex="-1"></a>Y1B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1B)</span>
<span id="cb189-18"><a href="NE.html#cb189-18" tabindex="-1"></a>epsilonA <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb189-19"><a href="NE.html#cb189-19" tabindex="-1"></a>U0A <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilonA</span>
<span id="cb189-20"><a href="NE.html#cb189-20" tabindex="-1"></a>y0A <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0A <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb189-21"><a href="NE.html#cb189-21" tabindex="-1"></a>alphaA <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaA&quot;</span>]<span class="sc">+</span> param[<span class="st">&quot;baralphaAT&quot;</span>]<span class="sc">*</span>Ds<span class="sc">+</span> param[<span class="st">&quot;thetaA&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaA</span>
<span id="cb189-22"><a href="NE.html#cb189-22" tabindex="-1"></a>y1A <span class="ot">&lt;-</span> y0A<span class="sc">+</span>alphaA</span>
<span id="cb189-23"><a href="NE.html#cb189-23" tabindex="-1"></a>Y0A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0A)</span>
<span id="cb189-24"><a href="NE.html#cb189-24" tabindex="-1"></a>Y1A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1A)</span>
<span id="cb189-25"><a href="NE.html#cb189-25" tabindex="-1"></a>yB <span class="ot">&lt;-</span> y1B<span class="sc">*</span>Ds<span class="sc">+</span>y0B<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb189-26"><a href="NE.html#cb189-26" tabindex="-1"></a>YB <span class="ot">&lt;-</span> Y1B<span class="sc">*</span>Ds<span class="sc">+</span>Y0B<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb189-27"><a href="NE.html#cb189-27" tabindex="-1"></a>yA <span class="ot">&lt;-</span> y1A</span>
<span id="cb189-28"><a href="NE.html#cb189-28" tabindex="-1"></a>YA <span class="ot">&lt;-</span> Y1A</span></code></pre></div>
<p>Let’s see how DID works on this data.</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="NE.html#cb190-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>)</span>
<span id="cb190-2"><a href="NE.html#cb190-2" tabindex="-1"></a>y.AT <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb190-3"><a href="NE.html#cb190-3" tabindex="-1"></a>y.AT.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb190-4"><a href="NE.html#cb190-4" tabindex="-1"></a>y.Switchers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb190-5"><a href="NE.html#cb190-5" tabindex="-1"></a>y.Switchers.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb190-6"><a href="NE.html#cb190-6" tabindex="-1"></a>y.Switchers.counterfactual<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y1B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y1A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb190-7"><a href="NE.html#cb190-7" tabindex="-1"></a>y.Switchers.DID <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb190-8"><a href="NE.html#cb190-8" tabindex="-1"></a>y.Switchers.DID<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb190-9"><a href="NE.html#cb190-9" tabindex="-1"></a>data.DID.plot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">c</span>(y.AT,y.AT.counterfactual,y.Switchers,y.Switchers.counterfactual,y.Switchers.counterfactual<span class="fl">.1</span>,y.Switchers.DID,y.Switchers.DID<span class="fl">.1</span>))</span>
<span id="cb190-10"><a href="NE.html#cb190-10" tabindex="-1"></a><span class="fu">colnames</span>(data.DID.plot) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Outcome&quot;</span>) </span>
<span id="cb190-11"><a href="NE.html#cb190-11" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Period <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(x,<span class="dv">7</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>))</span>
<span id="cb190-12"><a href="NE.html#cb190-12" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>))</span>
<span id="cb190-13"><a href="NE.html#cb190-13" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Observed <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>))</span>
<span id="cb190-14"><a href="NE.html#cb190-14" tabindex="-1"></a></span>
<span id="cb190-15"><a href="NE.html#cb190-15" tabindex="-1"></a>WW.before <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb190-16"><a href="NE.html#cb190-16" tabindex="-1"></a>WW.after <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb190-17"><a href="NE.html#cb190-17" tabindex="-1"></a>BA.AT <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb190-18"><a href="NE.html#cb190-18" tabindex="-1"></a>BA.Switchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb190-19"><a href="NE.html#cb190-19" tabindex="-1"></a>Counterfactual.after <span class="ot">&lt;-</span> <span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span>BA.AT</span>
<span id="cb190-20"><a href="NE.html#cb190-20" tabindex="-1"></a>DIDr <span class="ot">&lt;-</span> BA.Switchers <span class="sc">-</span> BA.AT </span>
<span id="cb190-21"><a href="NE.html#cb190-21" tabindex="-1"></a>TTASwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb190-22"><a href="NE.html#cb190-22" tabindex="-1"></a>TTBSwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb190-23"><a href="NE.html#cb190-23" tabindex="-1"></a>TTAAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb190-24"><a href="NE.html#cb190-24" tabindex="-1"></a>TTBAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb190-25"><a href="NE.html#cb190-25" tabindex="-1"></a></span>
<span id="cb190-26"><a href="NE.html#cb190-26" tabindex="-1"></a><span class="fu">ggplot</span>(data.DID.plot,<span class="fu">aes</span>(<span class="at">x=</span>Period,<span class="at">y=</span>Outcome,<span class="at">group=</span>Group,<span class="at">color=</span>Group,<span class="at">shape=</span>Group,<span class="at">linetype=</span>Observed))<span class="sc">+</span></span>
<span id="cb190-27"><a href="NE.html#cb190-27" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb190-28"><a href="NE.html#cb190-28" tabindex="-1"></a>    <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb190-29"><a href="NE.html#cb190-29" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">guide=</span><span class="st">&#39;none&#39;</span>) <span class="sc">+</span></span>
<span id="cb190-30"><a href="NE.html#cb190-30" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDRev2ndbaralphaAT0"></span>
<img src="STCI_files/figure-html/PlotDIDRev2ndbaralphaAT0-1.png" alt="Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the second period and $\bar{\alpha}_{AT}=0$" width="50%" />
<p class="caption">
Figure 4.22: Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the second period and <span class="math inline">\(\bar{\alpha}_{AT}=0\)</span>
</p>
</div>
<p>What is happening on Figure <a href="NE.html#fig:PlotDIDRev2ndbaralphaAT0">4.22</a>?
First, the <span class="math inline">\(DID^r\)</span> estimator is equal to 0.19, while the effect of the treatment on <em>switchers</em> is equal to 0.3 in the second period and to 0.17 in the first period.
So now, the bias of the <span class="math inline">\(DID^r\)</span> is not so large as to make it reverse signs with respect to the true effect of the treatment.
It is actually almost zero for the effect on the <em>switchers</em> in the first period (<span class="math inline">\(\hat{B}^{Y_B}_{DID^r}=\)</span> 0.01).
This is because the condition for <span class="math inline">\(DID^r\)</span> to capture the effect of the treatment on <em>switchers</em> in the first period is almost fulfilled in the data.
Theorem <a href="NE.html#thm:BiasDIDr">4.15</a> shows that this bias is equal to the difference in the change in teatment effect over time between the <em>switchers</em> and the <em>always takers</em>.
The change in treatment effect for the <em>switchers</em> is equal to <span class="math inline">\(\hat{\Delta}^{Y_A}_{TUT}-\hat\Delta^{Y_B}_{TUT}=\)</span> 0.12 and the change in treatment effect for the <em>always takers</em> is equal to <span class="math inline">\(\hat{\Delta}^{Y_A}_{TT}-\hat\Delta^{Y_B}_{TT}=\)</span> 0.07.
They are almost equal which makes <span class="math inline">\(DID^r\)</span> almost unbiased for the effect of the treatment on <em>switchers</em> in the first period.</p>
<p>On the contrary, the condition for <span class="math inline">\(DID^r\)</span> to capture the effect of the treatment on the <em>switchers</em> in the second period is not fulfilled in the data, not even almost.
Theorem <a href="NE.html#thm:BiasDIDr">4.15</a> shows that the condition for <span class="math inline">\(DID^r\)</span> to capture the effect of the treatment on the <em>switchers</em> in the second period is that the treatment effect on <em>always takers</em> be constant over time.
This is unfortunately not the case in this data, since <span class="math inline">\(\hat{\Delta}^{Y_A}_{TT}-\hat\Delta^{Y_B}_{TT}=\)</span> 0.07.
The bias of the <span class="math inline">\(DID^r\)</span> estimator is thus large (and negative) for <span class="math inline">\(\hat{\Delta}^{Y_A}_{TUT}\)</span>: <span class="math inline">\(\hat{B}^{Y_A}_{DID^r}=\)</span> -0.11.</p>
<div class="remark">
<p><span id="unlabeled-div-117" class="remark"><em>Remark</em>. </span>Note that in this model, the <span class="math inline">\(DID^r\)</span> estimator is still biased for <span class="math inline">\(\Delta^{Y_B}_{TUT}\)</span>.
The reasons why are left as an exercise.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-219" class="example"><strong>Example 4.39  </strong></span>Let us finally explore the last condition in Theorem <a href="NE.html#thm:BiasDIDr">4.15</a> that makes <span class="math inline">\(DID^r\)</span> unbiased for <span class="math inline">\(\Delta^{Y_A}_{TUT}\)</span>, the effect of the treatment on <em>switchers</em> in the second period.
We are going to switch off the change in treatment effects that occurs over time in both groups: we are going to set <span class="math inline">\(\bar{\alpha}_{A}=\bar{\alpha}_{B}=0.1\)</span>.</p>
</div>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="NE.html#cb191-1" tabindex="-1"></a>param[<span class="st">&quot;baralphaA&quot;</span>] <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb191-2"><a href="NE.html#cb191-2" tabindex="-1"></a>param[<span class="st">&quot;baralphaB&quot;</span>] <span class="ot">&lt;-</span> <span class="fl">0.1</span></span></code></pre></div>
<p>Let’s now simulate a dataset according to these new equations.</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="NE.html#cb192-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb192-2"><a href="NE.html#cb192-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb192-3"><a href="NE.html#cb192-3" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],<span class="dv">0</span>,param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb192-4"><a href="NE.html#cb192-4" tabindex="-1"></a>                          <span class="dv">0</span>,param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb192-5"><a href="NE.html#cb192-5" tabindex="-1"></a>                          param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">byrow=</span>T)</span>
<span id="cb192-6"><a href="NE.html#cb192-6" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb192-7"><a href="NE.html#cb192-7" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;etaA&#39;</span>,<span class="st">&#39;etaB&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb192-8"><a href="NE.html#cb192-8" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb192-9"><a href="NE.html#cb192-9" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb192-10"><a href="NE.html#cb192-10" tabindex="-1"></a>y0B <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb192-11"><a href="NE.html#cb192-11" tabindex="-1"></a>Y0B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0B)</span>
<span id="cb192-12"><a href="NE.html#cb192-12" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb192-13"><a href="NE.html#cb192-13" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb192-14"><a href="NE.html#cb192-14" tabindex="-1"></a>Ds[y0B<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb192-15"><a href="NE.html#cb192-15" tabindex="-1"></a>alphaB <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaB&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;thetaB&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaB</span>
<span id="cb192-16"><a href="NE.html#cb192-16" tabindex="-1"></a>y1B <span class="ot">&lt;-</span> y0B<span class="sc">+</span>alphaB</span>
<span id="cb192-17"><a href="NE.html#cb192-17" tabindex="-1"></a>Y1B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1B)</span>
<span id="cb192-18"><a href="NE.html#cb192-18" tabindex="-1"></a>epsilonA <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb192-19"><a href="NE.html#cb192-19" tabindex="-1"></a>U0A <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilonA</span>
<span id="cb192-20"><a href="NE.html#cb192-20" tabindex="-1"></a>y0A <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0A <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb192-21"><a href="NE.html#cb192-21" tabindex="-1"></a>alphaA <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaA&quot;</span>]<span class="sc">+</span> param[<span class="st">&quot;baralphaAT&quot;</span>]<span class="sc">*</span>Ds<span class="sc">+</span> param[<span class="st">&quot;thetaA&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaA</span>
<span id="cb192-22"><a href="NE.html#cb192-22" tabindex="-1"></a>y1A <span class="ot">&lt;-</span> y0A<span class="sc">+</span>alphaA</span>
<span id="cb192-23"><a href="NE.html#cb192-23" tabindex="-1"></a>Y0A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0A)</span>
<span id="cb192-24"><a href="NE.html#cb192-24" tabindex="-1"></a>Y1A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1A)</span>
<span id="cb192-25"><a href="NE.html#cb192-25" tabindex="-1"></a>yB <span class="ot">&lt;-</span> y1B<span class="sc">*</span>Ds<span class="sc">+</span>y0B<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb192-26"><a href="NE.html#cb192-26" tabindex="-1"></a>YB <span class="ot">&lt;-</span> Y1B<span class="sc">*</span>Ds<span class="sc">+</span>Y0B<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb192-27"><a href="NE.html#cb192-27" tabindex="-1"></a>yA <span class="ot">&lt;-</span> y1A</span>
<span id="cb192-28"><a href="NE.html#cb192-28" tabindex="-1"></a>YA <span class="ot">&lt;-</span> Y1A</span></code></pre></div>
<p>Let’s see how DID works on this data.</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="NE.html#cb193-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>)</span>
<span id="cb193-2"><a href="NE.html#cb193-2" tabindex="-1"></a>y.AT <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb193-3"><a href="NE.html#cb193-3" tabindex="-1"></a>y.AT.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb193-4"><a href="NE.html#cb193-4" tabindex="-1"></a>y.Switchers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb193-5"><a href="NE.html#cb193-5" tabindex="-1"></a>y.Switchers.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb193-6"><a href="NE.html#cb193-6" tabindex="-1"></a>y.Switchers.counterfactual<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y1B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y1A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb193-7"><a href="NE.html#cb193-7" tabindex="-1"></a>y.Switchers.DID <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb193-8"><a href="NE.html#cb193-8" tabindex="-1"></a>y.Switchers.DID<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb193-9"><a href="NE.html#cb193-9" tabindex="-1"></a>data.DID.plot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">c</span>(y.AT,y.AT.counterfactual,y.Switchers,y.Switchers.counterfactual,y.Switchers.counterfactual<span class="fl">.1</span>,y.Switchers.DID,y.Switchers.DID<span class="fl">.1</span>))</span>
<span id="cb193-10"><a href="NE.html#cb193-10" tabindex="-1"></a><span class="fu">colnames</span>(data.DID.plot) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Outcome&quot;</span>) </span>
<span id="cb193-11"><a href="NE.html#cb193-11" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Period <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(x,<span class="dv">7</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>))</span>
<span id="cb193-12"><a href="NE.html#cb193-12" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>))</span>
<span id="cb193-13"><a href="NE.html#cb193-13" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Observed <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>))</span>
<span id="cb193-14"><a href="NE.html#cb193-14" tabindex="-1"></a></span>
<span id="cb193-15"><a href="NE.html#cb193-15" tabindex="-1"></a>WW.before <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb193-16"><a href="NE.html#cb193-16" tabindex="-1"></a>WW.after <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb193-17"><a href="NE.html#cb193-17" tabindex="-1"></a>BA.AT <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb193-18"><a href="NE.html#cb193-18" tabindex="-1"></a>BA.Switchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb193-19"><a href="NE.html#cb193-19" tabindex="-1"></a>Counterfactual.after <span class="ot">&lt;-</span> <span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span>BA.AT</span>
<span id="cb193-20"><a href="NE.html#cb193-20" tabindex="-1"></a>DIDr <span class="ot">&lt;-</span> BA.Switchers <span class="sc">-</span> BA.AT </span>
<span id="cb193-21"><a href="NE.html#cb193-21" tabindex="-1"></a>TTASwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb193-22"><a href="NE.html#cb193-22" tabindex="-1"></a>TTBSwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb193-23"><a href="NE.html#cb193-23" tabindex="-1"></a>TTAAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb193-24"><a href="NE.html#cb193-24" tabindex="-1"></a>TTBAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb193-25"><a href="NE.html#cb193-25" tabindex="-1"></a></span>
<span id="cb193-26"><a href="NE.html#cb193-26" tabindex="-1"></a><span class="fu">ggplot</span>(data.DID.plot,<span class="fu">aes</span>(<span class="at">x=</span>Period,<span class="at">y=</span>Outcome,<span class="at">group=</span>Group,<span class="at">color=</span>Group,<span class="at">shape=</span>Group,<span class="at">linetype=</span>Observed))<span class="sc">+</span></span>
<span id="cb193-27"><a href="NE.html#cb193-27" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb193-28"><a href="NE.html#cb193-28" tabindex="-1"></a>    <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb193-29"><a href="NE.html#cb193-29" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">guide=</span><span class="st">&#39;none&#39;</span>) <span class="sc">+</span></span>
<span id="cb193-30"><a href="NE.html#cb193-30" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDRev2ndbaralphaAB0"></span>
<img src="STCI_files/figure-html/PlotDIDRev2ndbaralphaAB0-1.png" alt="Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the second period and $\bar{\alpha}_{A}=\bar{\alpha}_{B}=0$" width="50%" />
<p class="caption">
Figure 4.23: Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the second period and <span class="math inline">\(\bar{\alpha}_{A}=\bar{\alpha}_{B}=0\)</span>
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDRev2ndbaralphaAB0">4.23</a> shows that the <span class="math inline">\(DID^r\)</span> estimator is almost OK in our setting.
The <span class="math inline">\(DID^r\)</span> estimator is equal to 0.19 while the treatment effect on the <em>switchers</em> is equal to <span class="math inline">\(\hat\Delta^{Y_A}_{TUT}=\)</span> 0.2 in the second period and <span class="math inline">\(\hat\Delta^{Y_B}_{TUT}=\)</span> 0.17 in the first period.
There still is a difference between the estimator and the treatment effect of interest, but the difference is small enough that it might be attributed to sampling noise.
Remember that the condition for <span class="math inline">\(DID^r\)</span> to identify <span class="math inline">\(\Delta^{Y_A}_{TUT}\)</span> is Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a> that the trends in potential outcomes in the absence of the treatment among <em>switchers</em> is the same as the trend in potential outcomes in the presence of the treatment among <em>always takers</em>.
This is almost what we see, since the change in potential outcomes absent the treatment among switchers is equal to 0.03 while the change in potential outcomes under the treatment regime among <em>always takers</em> is equal to 0.04.
The fact that these two quantities differ slightly is what biases the <span class="math inline">\(DID^r\)</span> estimator in the sample that we have generated.
Note finally that Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a> together with Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a> implies that the effect of the treatment is constant over time among <em>always takers</em>, as Lemma <a href="NE.html#lem:ParallelTrendsCstTreatmentEffects">4.5</a> shows.
This is also the condition for the <span class="math inline">\(DID^r\)</span> estimator to identify <span class="math inline">\(\Delta^{Y_A}_{TUT}\)</span> under Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>, as Lemma <a href="NE.html#lem:ParallelTrendsCstTreatmentEffects">4.5</a> shows.
Here, the effect of the treatment among always takers is equal to 0.17 in the first period and to 0.14 in the second period.</p>
<div class="remark">
<p><span id="unlabeled-div-118" class="remark"><em>Remark</em>. </span>Actually, the conditions for <span class="math inline">\(DID^r\)</span> to indentify any treatment effect are not fulfilled in our model.
That reasons why are left as an exercise.</p>
</div>
</div>
<div id="did-designs-where-everyone-is-in-the-treatment-at-the-first-period" class="section level4 hasAnchor" number="4.3.2.2">
<h4><span class="header-section-number">4.3.2.2</span> DID designs where everyone is in the treatment at the first period<a href="NE.html#did-designs-where-everyone-is-in-the-treatment-at-the-first-period" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Compared to the setting in the previous section, the main change is to Assumption <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>:</p>
<div class="hypothesis">
<p><span id="hyp:AllTreatmentFirst" class="hypothesis"><strong>Hypothesis 4.21  (Everyone Receives Treatment in the First Period) </strong></span>We assume that every unit in the population receives the treatment in the first period: <span class="math inline">\(D_{i,B}=1\)</span>, <span class="math inline">\(\forall i\)</span>.</p>
</div>
<p>Under Assumption <a href="NE.html#hyp:AllTreatmentFirst">4.21</a>, and without loss of generality, we can still write <span class="math inline">\(D_i=D_{i,A}\)</span>.
In order for the <span class="math inline">\(DID\)</span> estimator to identify a fully-fledged treatment effect, we are going to need a pretty stark assumption:</p>
<div class="hypothesis">
<p><span id="hyp:NoEffectsAfterExit" class="hypothesis"><strong>Hypothesis 4.22  (No Effect After Exiting the Treatment) </strong></span>We assume that, after exiting the treatment, agents experience the same outcomes as if they had never entered the treatment: <span class="math inline">\(Y_{i,A}=Y^0_{i,A}\)</span>, <span class="math inline">\(\forall i\)</span> such that <span class="math inline">\(D_{i,A}=0\)</span>.</p>
</div>
<p>A consequence of Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a> and <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> is that we can write observed outcomes as a function of treatment and potential outcomes using the usual switching equation.</p>
<div class="remark">
<p><span id="unlabeled-div-119" class="remark"><em>Remark</em>. </span>Note that Assumption <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> is extremely restrictive: units return immediately to their outcomes in the absence of the treatment right after exiting the treatment state.
We are going to relax that assumption later.</p>
</div>
<p>The following theorem shows that <span class="math inline">\(DID\)</span> identifies a fully-fledged treatment effect under (arguably strong) assumptions:</p>
<div class="theorem">
<p><span id="thm:DIDExit" class="theorem"><strong>Theorem 4.16  (DID identifies TUT in the second period) </strong></span>Under Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a>, <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> and <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>, the <span class="math inline">\(DID\)</span> estimator identifies the effect of the treatment on the <em>switchers</em> in the second period:</p>
<p><span class="math display">\[\begin{align*}
    \Delta_{DID}^{Y} &amp; =  \Delta^{Y_A}_{TUT},
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-120" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
  \Delta^Y_{DID} &amp; = \esp{Y_{i,A}|D_i=1}-\esp{Y_{i,B}|D_i=1}-(\esp{Y_{i,A}|D_i=0}-\esp{Y_{i,B}|D_i=0}) \\
                &amp; = \esp{Y^1_{i,A}|D_i=1}-\esp{Y^1_{i,B}|D_i=1}-(\esp{Y^0_{i,A}|D_i=0}-\esp{Y^1_{i,B}|D_i=0})\\
                &amp; = \esp{Y^1_{i,A}|D_i=0}-\esp{Y^1_{i,B}|D_i=0}-(\esp{Y^0_{i,A}|D_i=0}-\esp{Y^1_{i,B}|D_i=0})\\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=0}
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a> and <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> and the switching equation, and the third equality follows from Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>.</p>
</div>
<p>Invoking another (even stronger) assumption, DID identifies the effect of the treatment on <em>switchers</em> in the first period:</p>
<div class="theorem">
<p><span id="thm:DIDExitFirst" class="theorem"><strong>Theorem 4.17  (DID identifies TUT in the first period) </strong></span>Under Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a>, <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> and <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a>, the <span class="math inline">\(DID\)</span> estimator identifies the effect of the treatment on the <em>switchers</em> in the first period:</p>
<p><span class="math display">\[\begin{align*}
    \Delta_{DID}^{Y} &amp; =  \Delta^{Y_B}_{TUT},
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-121" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
  \Delta^Y_{DID} &amp; = \esp{Y_{i,A}|D_i=1}-\esp{Y_{i,B}|D_i=1}-(\esp{Y_{i,A}|D_i=0}-\esp{Y_{i,B}|D_i=0}) \\
                &amp; = \esp{Y^1_{i,A}|D_i=1}-\esp{Y^1_{i,B}|D_i=1}-(\esp{Y^0_{i,A}|D_i=0}-\esp{Y^1_{i,B}|D_i=0})\\
                &amp; = \esp{Y^0_{i,A}|D_i=0}-\esp{Y^0_{i,B}|D_i=0}-(\esp{Y^0_{i,A}|D_i=0}-\esp{Y^1_{i,B}|D_i=0})\\
                &amp; = \esp{Y^1_{i,B}-Y^0_{i,B}|D_i=0}
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a> and <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> and the switching equation, and the third equality follows from Assumption <a href="NE.html#hyp:ParallelTrendsy1y0">4.20</a>.</p>
</div>
<p>We can also study the bias of the DID estimator under the classical parallel trends assumption (Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>):</p>
<div class="lemma">
<p><span id="lem:BiasDID" class="lemma"><strong>Lemma 4.6  (Bias of the DID estimator) </strong></span>Under Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a>, <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> and <a href="NE.html#hyp:ParallelTrends">4.14</a>, the <span class="math inline">\(DID\)</span> estimator is biased for the average effect of the Treatment on the switchers before and after the treatment:</p>
<p><span class="math display">\[\begin{align*}
    \Delta_{DID}^{Y} &amp; =  \Delta^{Y_B}_{TUT}+B^{Y_B}_{DID} \\
    \Delta_{DID}^{Y} &amp; =  \Delta^{Y_A}_{TUT}+B^{Y_A}_{DID}
\end{align*}\]</span></p>
</div>
<p>with:</p>
<p><span class="math display">\[\begin{align*}
    B^{Y_B}_{DID} &amp; = \Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT}\\
    B^{Y_A}_{DID} &amp; = \Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT}-(\Delta^{Y_A}_{TUT}-\Delta^{Y_B}_{TUT}).
\end{align*}\]</span></p>
<div class="proof">
<p><span id="unlabeled-div-122" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
  \Delta^Y_{DID} &amp; = \esp{Y_{i,A}-Y_{i,B}|D_i=1}-\esp{Y_{i,A}-Y_{i,B}|D_i=0} \\
                &amp; = \esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}-\esp{Y^0_{i,A}-Y^1_{i,B}|D_i=0}\\
                &amp; = \esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}-\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=1}+\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=0}-\esp{Y^0_{i,A}-Y^1_{i,B}|D_i=0} \\
                &amp; = \esp{Y^1_{i,B}-Y^0_{i,B}|D_i=0}+ \esp{Y^1_{i,A}-Y^1_{i,B}-(Y^0_{i,A}-Y^0_{i,B})|D_i=1}
                &amp; = \Delta^{Y_B}_{TUT}+\Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT},
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a>, <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> and the switching equation, and the third equality follows from Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>.</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{DID} &amp; = \esp{Y_{i,A}-Y_{i,B}|D_i=1}-\esp{Y_{i,A}-Y_{i,B}|D_i=0} \\
                &amp; = \esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}-\esp{Y^0_{i,A}-Y^1_{i,B}|D_i=0}\\
                &amp; = \esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=0}+\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=0}-\esp{Y^0_{i,A}-Y^1_{i,B}|D_i=0}\\
                &amp; = \esp{Y^1_{i,A}-Y^0_{i,A}|D_i=0}+\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=0} \\
                &amp; = \Delta^{Y_A}_{TUT}+\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=1}-\esp{Y^1_{i,A}-Y^1_{i,B}|D_i=0}\\
                &amp; \phantom{=} -\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=1}+\esp{Y^0_{i,A}-Y^0_{i,B}|D_i=0} \\
                &amp; = \Delta^{Y_A}_{TUT}+\Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT}-(\Delta^{Y_A}_{TUT}-\Delta^{Y_B}_{TUT}),
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a>, <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> and the switching equation, and the fifth equality follows from Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-225" class="example"><strong>Example 4.40  </strong></span>Let us generate data in our example model that complies with Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a> and <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a>.</p>
</div>
<p><span class="math display">\[\begin{align*}
y_{i,A}^1 &amp; = y_{i,A}^0+\bar{\alpha}_A+\bar{\alpha}_{AT}D_{i,A}+\theta_A\mu_i+\eta_{i,A} \\
y_{i,A}^0 &amp; = \mu_i+\delta+U_{i,A}^0 \\
U_{i,A}^0 &amp; = \rho U_{i,B}+\epsilon_{i,A} \\
y^1_{i,B} &amp; =y^0_{i,B} + \bar{\alpha}_B+\theta_B\mu_i+\eta_{i,B} \\
y^0_{i,B} &amp; =\mu_i+U_{i,B} \\
U_{i,B} &amp; \sim\mathcal{N}(0,\sigma^2_{U}) \\
D_{i,A}   &amp; = \uns{y^0_{i,B}+ V_i\leq\bar{y}} \\
V_i   &amp; = \gamma(\mu_i-\bar{\mu}) + \omega_i \\
(\eta_{i,A},\eta_{i,B},\omega_i) &amp; \sim\mathcal{N}(0,0,0,\sigma^2_{\eta},\sigma^2_{\eta},\sigma^2_{\omega},0,\rho_{\eta,\omega})
\end{align*}\]</span></p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="NE.html#cb194-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,<span class="fl">0.01</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.2</span>,<span class="fl">0.1</span>,<span class="fl">0.3</span>,<span class="fl">0.1</span>,<span class="fl">0.28</span>,<span class="dv">0</span>)</span>
<span id="cb194-2"><a href="NE.html#cb194-2" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,<span class="st">&quot;thetaA&quot;</span>,<span class="st">&quot;thetaB&quot;</span>,<span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;baralphaA&quot;</span>,<span class="st">&quot;baralphaB&quot;</span>,<span class="st">&quot;baralphaAT&quot;</span>,<span class="st">&quot;gamma&quot;</span>,<span class="st">&quot;sigma2omega&quot;</span>,<span class="st">&quot;rhoetaomega&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="NE.html#cb195-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb195-2"><a href="NE.html#cb195-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb195-3"><a href="NE.html#cb195-3" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],<span class="dv">0</span>,param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb195-4"><a href="NE.html#cb195-4" tabindex="-1"></a>                          <span class="dv">0</span>,param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb195-5"><a href="NE.html#cb195-5" tabindex="-1"></a>                          param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">byrow=</span>T)</span>
<span id="cb195-6"><a href="NE.html#cb195-6" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb195-7"><a href="NE.html#cb195-7" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;etaA&#39;</span>,<span class="st">&#39;etaB&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb195-8"><a href="NE.html#cb195-8" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb195-9"><a href="NE.html#cb195-9" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb195-10"><a href="NE.html#cb195-10" tabindex="-1"></a>y0B <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb195-11"><a href="NE.html#cb195-11" tabindex="-1"></a>Y0B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0B)</span>
<span id="cb195-12"><a href="NE.html#cb195-12" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb195-13"><a href="NE.html#cb195-13" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb195-14"><a href="NE.html#cb195-14" tabindex="-1"></a>Ds[y0B<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb195-15"><a href="NE.html#cb195-15" tabindex="-1"></a>alphaB <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaB&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;thetaB&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaB</span>
<span id="cb195-16"><a href="NE.html#cb195-16" tabindex="-1"></a>y1B <span class="ot">&lt;-</span> y0B<span class="sc">+</span>alphaB</span>
<span id="cb195-17"><a href="NE.html#cb195-17" tabindex="-1"></a>Y1B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1B)</span>
<span id="cb195-18"><a href="NE.html#cb195-18" tabindex="-1"></a>epsilonA <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb195-19"><a href="NE.html#cb195-19" tabindex="-1"></a>U0A <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilonA</span>
<span id="cb195-20"><a href="NE.html#cb195-20" tabindex="-1"></a>y0A <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0A <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb195-21"><a href="NE.html#cb195-21" tabindex="-1"></a>alphaA <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaA&quot;</span>]<span class="sc">+</span> param[<span class="st">&quot;baralphaAT&quot;</span>]<span class="sc">*</span>Ds<span class="sc">+</span> param[<span class="st">&quot;thetaA&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaA</span>
<span id="cb195-22"><a href="NE.html#cb195-22" tabindex="-1"></a>y1A <span class="ot">&lt;-</span> y0A<span class="sc">+</span>alphaA</span>
<span id="cb195-23"><a href="NE.html#cb195-23" tabindex="-1"></a>Y0A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0A)</span>
<span id="cb195-24"><a href="NE.html#cb195-24" tabindex="-1"></a>Y1A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1A)</span>
<span id="cb195-25"><a href="NE.html#cb195-25" tabindex="-1"></a>yA <span class="ot">&lt;-</span> y1A<span class="sc">*</span>Ds<span class="sc">+</span>y0A<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb195-26"><a href="NE.html#cb195-26" tabindex="-1"></a>YA <span class="ot">&lt;-</span> Y1A<span class="sc">*</span>Ds<span class="sc">+</span>Y0A<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb195-27"><a href="NE.html#cb195-27" tabindex="-1"></a>yB <span class="ot">&lt;-</span> y1B</span>
<span id="cb195-28"><a href="NE.html#cb195-28" tabindex="-1"></a>YB <span class="ot">&lt;-</span> Y1B</span></code></pre></div>
<p>Let’s see how DID works on this data.</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="NE.html#cb196-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>)</span>
<span id="cb196-2"><a href="NE.html#cb196-2" tabindex="-1"></a>y.AT <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb196-3"><a href="NE.html#cb196-3" tabindex="-1"></a>y.AT.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb196-4"><a href="NE.html#cb196-4" tabindex="-1"></a>y.Switchers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb196-5"><a href="NE.html#cb196-5" tabindex="-1"></a>y.Switchers.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb196-6"><a href="NE.html#cb196-6" tabindex="-1"></a>y.Switchers.counterfactual<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y1B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y1A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb196-7"><a href="NE.html#cb196-7" tabindex="-1"></a>y.Switchers.DID <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb196-8"><a href="NE.html#cb196-8" tabindex="-1"></a>y.Switchers.DID<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb196-9"><a href="NE.html#cb196-9" tabindex="-1"></a>data.DID.plot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">c</span>(y.AT,y.AT.counterfactual,y.Switchers,y.Switchers.counterfactual,y.Switchers.counterfactual<span class="fl">.1</span>,y.Switchers.DID,y.Switchers.DID<span class="fl">.1</span>))</span>
<span id="cb196-10"><a href="NE.html#cb196-10" tabindex="-1"></a><span class="fu">colnames</span>(data.DID.plot) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Outcome&quot;</span>) </span>
<span id="cb196-11"><a href="NE.html#cb196-11" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Period <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(x,<span class="dv">7</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>))</span>
<span id="cb196-12"><a href="NE.html#cb196-12" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>))</span>
<span id="cb196-13"><a href="NE.html#cb196-13" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Observed <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>))</span>
<span id="cb196-14"><a href="NE.html#cb196-14" tabindex="-1"></a></span>
<span id="cb196-15"><a href="NE.html#cb196-15" tabindex="-1"></a>WW.before <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb196-16"><a href="NE.html#cb196-16" tabindex="-1"></a>WW.after <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb196-17"><a href="NE.html#cb196-17" tabindex="-1"></a>BA.AT <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb196-18"><a href="NE.html#cb196-18" tabindex="-1"></a>BA.Switchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb196-19"><a href="NE.html#cb196-19" tabindex="-1"></a>Counterfactual.after <span class="ot">&lt;-</span> <span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span>BA.AT</span>
<span id="cb196-20"><a href="NE.html#cb196-20" tabindex="-1"></a>DID <span class="ot">&lt;-</span> BA.AT  <span class="sc">-</span> BA.Switchers</span>
<span id="cb196-21"><a href="NE.html#cb196-21" tabindex="-1"></a>TTASwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb196-22"><a href="NE.html#cb196-22" tabindex="-1"></a>TTBSwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb196-23"><a href="NE.html#cb196-23" tabindex="-1"></a>TTAAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb196-24"><a href="NE.html#cb196-24" tabindex="-1"></a>TTBAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb196-25"><a href="NE.html#cb196-25" tabindex="-1"></a></span>
<span id="cb196-26"><a href="NE.html#cb196-26" tabindex="-1"></a><span class="fu">ggplot</span>(data.DID.plot,<span class="fu">aes</span>(<span class="at">x=</span>Period,<span class="at">y=</span>Outcome,<span class="at">group=</span>Group,<span class="at">color=</span>Group,<span class="at">shape=</span>Group,<span class="at">linetype=</span>Observed))<span class="sc">+</span></span>
<span id="cb196-27"><a href="NE.html#cb196-27" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb196-28"><a href="NE.html#cb196-28" tabindex="-1"></a>    <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb196-29"><a href="NE.html#cb196-29" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">guide=</span><span class="st">&#39;none&#39;</span>) <span class="sc">+</span></span>
<span id="cb196-30"><a href="NE.html#cb196-30" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDRev"></span>
<img src="STCI_files/figure-html/PlotDIDRev-1.png" alt="Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the first period" width="50%" />
<p class="caption">
Figure 4.24: Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the first period
</p>
</div>
<p>In Figure <a href="NE.html#fig:PlotDIDRev">4.24</a>, the effect of the treatment on the <em>switchers</em> is equal to <span class="math inline">\(\hat\Delta^{y_A}_{TUT}=\)</span> 0.3 in the second period and to <span class="math inline">\(\hat\Delta^{y_B}_{TUT}=\)</span> 0.17 in the first period.
The <span class="math inline">\(DID\)</span> estimator is equal to <span class="math inline">\(\hat\Delta^{y}_{DID}=\)</span> 0.58 which is of the correct sign but much too big for both treatment effects.
The problem is that the change in the outcomes of the <em>always treated</em> (0.44) overestimates the change in outcomes the <em>switchers</em> would have experienced had they stayed in the treatment (0.16).
As a consequence, Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> is not valid and the DID estimator is biased.
Following Lemma <a href="NE.html#lem:BiasDID">4.6</a>, the bias of the DID estimator for the effect on the <em>switchers</em> in the second period is equal to the difference in the change of treatment effect over time between <em>always treated</em> (<span class="math inline">\(\hat\Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT}=\)</span> 0.54 <span class="math inline">\(-\)</span> 0.17 <span class="math inline">\(=\)</span> 0.37) and <em>switchers</em> (<span class="math inline">\(\hat\Delta^{Y_A}_{TUT}-\hat\Delta^{Y_B}_{TUT}=\)</span> 0.3 <span class="math inline">\(-\)</span> 0.17 <span class="math inline">\(=\)</span> 0.12).
The bias of the DID estimator for the effect of the treatment on the <em>switchers</em> in the first period is even larger (<span class="math inline">\(\hat B^{y_B}_{DID}=\)</span> 0.41).
Following Lemma <a href="NE.html#lem:BiasDID">4.6</a>, it is close to the change in treatment effect over time among the <em>switchers</em> (<span class="math inline">\(\hat\Delta^{Y_A}_{TT}-\hat\Delta^{Y_B}_{TT}=\)</span> 0.54 <span class="math inline">\(-\)</span> 0.17 <span class="math inline">\(=\)</span> 0.37).</p>
<div class="example">
<p><span id="exm:unnamed-chunk-226" class="example"><strong>Example 4.41  </strong></span>What happens if we enforce the fact that treatment effects vary in the same way among <em>always takers</em> and <em>switchers</em>.
Let’s find out.</p>
</div>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="NE.html#cb197-1" tabindex="-1"></a>param[<span class="st">&quot;baralphaAT&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span></code></pre></div>
<p>Let’s simulate the new data:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="NE.html#cb198-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb198-2"><a href="NE.html#cb198-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb198-3"><a href="NE.html#cb198-3" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],<span class="dv">0</span>,param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb198-4"><a href="NE.html#cb198-4" tabindex="-1"></a>                          <span class="dv">0</span>,param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),</span>
<span id="cb198-5"><a href="NE.html#cb198-5" tabindex="-1"></a>                          param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">3</span>,<span class="at">nrow=</span><span class="dv">3</span>,<span class="at">byrow=</span>T)</span>
<span id="cb198-6"><a href="NE.html#cb198-6" tabindex="-1"></a>eta.omega <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb198-7"><a href="NE.html#cb198-7" tabindex="-1"></a><span class="fu">colnames</span>(eta.omega) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;etaA&#39;</span>,<span class="st">&#39;etaB&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb198-8"><a href="NE.html#cb198-8" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]))</span>
<span id="cb198-9"><a href="NE.html#cb198-9" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb198-10"><a href="NE.html#cb198-10" tabindex="-1"></a>y0B <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb198-11"><a href="NE.html#cb198-11" tabindex="-1"></a>Y0B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0B)</span>
<span id="cb198-12"><a href="NE.html#cb198-12" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,N)</span>
<span id="cb198-13"><a href="NE.html#cb198-13" tabindex="-1"></a>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>eta.omega<span class="sc">$</span>omega</span>
<span id="cb198-14"><a href="NE.html#cb198-14" tabindex="-1"></a>Ds[y0B<span class="sc">+</span>V<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb198-15"><a href="NE.html#cb198-15" tabindex="-1"></a>alphaB <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaB&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;thetaB&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaB</span>
<span id="cb198-16"><a href="NE.html#cb198-16" tabindex="-1"></a>y1B <span class="ot">&lt;-</span> y0B<span class="sc">+</span>alphaB</span>
<span id="cb198-17"><a href="NE.html#cb198-17" tabindex="-1"></a>Y1B <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1B)</span>
<span id="cb198-18"><a href="NE.html#cb198-18" tabindex="-1"></a>epsilonA <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb198-19"><a href="NE.html#cb198-19" tabindex="-1"></a>U0A <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilonA</span>
<span id="cb198-20"><a href="NE.html#cb198-20" tabindex="-1"></a>y0A <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0A <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb198-21"><a href="NE.html#cb198-21" tabindex="-1"></a>alphaA <span class="ot">&lt;-</span> param[<span class="st">&quot;baralphaA&quot;</span>]<span class="sc">+</span> param[<span class="st">&quot;baralphaAT&quot;</span>]<span class="sc">*</span>Ds<span class="sc">+</span> param[<span class="st">&quot;thetaA&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta.omega<span class="sc">$</span>etaA</span>
<span id="cb198-22"><a href="NE.html#cb198-22" tabindex="-1"></a>y1A <span class="ot">&lt;-</span> y0A<span class="sc">+</span>alphaA</span>
<span id="cb198-23"><a href="NE.html#cb198-23" tabindex="-1"></a>Y0A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0A)</span>
<span id="cb198-24"><a href="NE.html#cb198-24" tabindex="-1"></a>Y1A <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1A)</span>
<span id="cb198-25"><a href="NE.html#cb198-25" tabindex="-1"></a>yA <span class="ot">&lt;-</span> y1A<span class="sc">*</span>Ds<span class="sc">+</span>y0A<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb198-26"><a href="NE.html#cb198-26" tabindex="-1"></a>YA <span class="ot">&lt;-</span> Y1A<span class="sc">*</span>Ds<span class="sc">+</span>Y0A<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb198-27"><a href="NE.html#cb198-27" tabindex="-1"></a>yB <span class="ot">&lt;-</span> y1B</span>
<span id="cb198-28"><a href="NE.html#cb198-28" tabindex="-1"></a>YB <span class="ot">&lt;-</span> Y1B</span></code></pre></div>
<p>Let’s see how DID works on this data.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="NE.html#cb199-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>)</span>
<span id="cb199-2"><a href="NE.html#cb199-2" tabindex="-1"></a>y.AT <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb199-3"><a href="NE.html#cb199-3" tabindex="-1"></a>y.AT.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb199-4"><a href="NE.html#cb199-4" tabindex="-1"></a>y.Switchers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb199-5"><a href="NE.html#cb199-5" tabindex="-1"></a>y.Switchers.counterfactual <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y0B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y0A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb199-6"><a href="NE.html#cb199-6" tabindex="-1"></a>y.Switchers.counterfactual<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y1B[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y1A[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb199-7"><a href="NE.html#cb199-7" tabindex="-1"></a>y.Switchers.DID <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>]))</span>
<span id="cb199-8"><a href="NE.html#cb199-8" tabindex="-1"></a>y.Switchers.DID<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])),<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb199-9"><a href="NE.html#cb199-9" tabindex="-1"></a>data.DID.plot <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">c</span>(y.AT,y.AT.counterfactual,y.Switchers,y.Switchers.counterfactual,y.Switchers.counterfactual<span class="fl">.1</span>,y.Switchers.DID,y.Switchers.DID<span class="fl">.1</span>))</span>
<span id="cb199-10"><a href="NE.html#cb199-10" tabindex="-1"></a><span class="fu">colnames</span>(data.DID.plot) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Outcome&quot;</span>) </span>
<span id="cb199-11"><a href="NE.html#cb199-11" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Period <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(x,<span class="dv">7</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Before&quot;</span>,<span class="st">&quot;After&quot;</span>))</span>
<span id="cb199-12"><a href="NE.html#cb199-12" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Switchers&quot;</span>,<span class="st">&quot;Switchers counterfactual y1&quot;</span>,<span class="st">&quot;Switchers counterfactual y0&quot;</span>,<span class="st">&quot;Switchers DIDr&quot;</span>,<span class="st">&quot;Switchers DIDr1&quot;</span>,<span class="st">&quot;Always Treated&quot;</span>,<span class="st">&quot;Always Treated counterfactual y0&quot;</span>))</span>
<span id="cb199-13"><a href="NE.html#cb199-13" tabindex="-1"></a>data.DID.plot<span class="sc">$</span>Observed <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>,<span class="st">&quot;Generated&quot;</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span>,<span class="st">&quot;Unobserved&quot;</span>,<span class="st">&quot;Generated&quot;</span>))</span>
<span id="cb199-14"><a href="NE.html#cb199-14" tabindex="-1"></a></span>
<span id="cb199-15"><a href="NE.html#cb199-15" tabindex="-1"></a>WW.before <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb199-16"><a href="NE.html#cb199-16" tabindex="-1"></a>WW.after <span class="ot">&lt;-</span> (<span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>]))</span>
<span id="cb199-17"><a href="NE.html#cb199-17" tabindex="-1"></a>BA.AT <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb199-18"><a href="NE.html#cb199-18" tabindex="-1"></a>BA.Switchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(yA[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb199-19"><a href="NE.html#cb199-19" tabindex="-1"></a>Counterfactual.after <span class="ot">&lt;-</span> <span class="fu">mean</span>(yB[Ds<span class="sc">==</span><span class="dv">0</span>])<span class="sc">+</span>BA.AT</span>
<span id="cb199-20"><a href="NE.html#cb199-20" tabindex="-1"></a>DID <span class="ot">&lt;-</span> BA.AT  <span class="sc">-</span> BA.Switchers</span>
<span id="cb199-21"><a href="NE.html#cb199-21" tabindex="-1"></a>TTASwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb199-22"><a href="NE.html#cb199-22" tabindex="-1"></a>TTBSwitchers <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb199-23"><a href="NE.html#cb199-23" tabindex="-1"></a>TTAAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaA[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb199-24"><a href="NE.html#cb199-24" tabindex="-1"></a>TTBAT <span class="ot">&lt;-</span> <span class="fu">mean</span>(alphaB[Ds<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb199-25"><a href="NE.html#cb199-25" tabindex="-1"></a></span>
<span id="cb199-26"><a href="NE.html#cb199-26" tabindex="-1"></a><span class="fu">ggplot</span>(data.DID.plot,<span class="fu">aes</span>(<span class="at">x=</span>Period,<span class="at">y=</span>Outcome,<span class="at">group=</span>Group,<span class="at">color=</span>Group,<span class="at">shape=</span>Group,<span class="at">linetype=</span>Observed))<span class="sc">+</span></span>
<span id="cb199-27"><a href="NE.html#cb199-27" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb199-28"><a href="NE.html#cb199-28" tabindex="-1"></a>    <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb199-29"><a href="NE.html#cb199-29" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">guide=</span><span class="st">&#39;none&#39;</span>) <span class="sc">+</span></span>
<span id="cb199-30"><a href="NE.html#cb199-30" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDRevShutDown"></span>
<img src="STCI_files/figure-html/PlotDIDRevShutDown-1.png" alt="Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the first period and treatment effects that vary in the same way among switchers and always takers" width="50%" />
<p class="caption">
Figure 4.25: Evolution of average outcomes in the always treated and switchers group in the reverse DID design where everyone is treated in the first period and treatment effects that vary in the same way among switchers and always takers
</p>
</div>
<p>As expected from Theorem <a href="NE.html#thm:DIDExit">4.16</a>, Figure <a href="NE.html#fig:PlotDIDRevShutDown">4.25</a> shows that DID almost estimates the effect of the treatment on the <em>switchers</em> in the second period.
This makes sense, since the change in outcomes for the <em>switchers</em> in the presence of the treatment (0.16) is well approximated by the observed change in outcomes for the <em>always treated</em> (0.14).
According to Lemma <a href="NE.html#lem:BiasDID">4.6</a>, this is because the change in treatment effect over time for the <em>always treated</em> (<span class="math inline">\(\hat\Delta^{Y_A}_{TT}-\Delta^{Y_B}_{TT}=\)</span> 0.24 <span class="math inline">\(-\)</span> 0.17 <span class="math inline">\(=\)</span> 0.07) is close to the change in treatment effect over time for the <em>switchers</em> (<span class="math inline">\(\hat\Delta^{Y_A}_{TUT}-\hat\Delta^{Y_B}_{TUT}=\)</span> 0.3 <span class="math inline">\(-\)</span> 0.17 <span class="math inline">\(=\)</span> 0.12).
Note that the DID estimator is still biased for the effect of the treatment on the <em>switchers</em> in the first period, because the treatment effect on the <em>always takers</em> changes over time (Lemma <a href="NE.html#lem:BiasDID">4.6</a>).</p>
<div class="remark">
<p><span id="unlabeled-div-123" class="remark"><em>Remark</em>. </span>Note that in this model, DID does not identify <span class="math inline">\(\Delta^{Y_A}_{TUT}\)</span>.
The reasons why are left as an exercise.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-124" class="remark"><em>Remark</em>. </span>We can relax Assumption <a href="NE.html#hyp:NoEffectsAfterExit">4.22</a> by redefining the potential outcomes observed after the <em>switchers</em> exit from the treatment as the potential outcomes observed when the treatment stops after having been experienced.
One way to parameterize this potential outcome is to make it a function of the time elapsed since exiting the treatment: <span class="math inline">\(Y^0_{i,t}(\tau)\)</span>, where <span class="math inline">\(\tau\)</span> denotes the number of periods after exiting the treatment.
For the <em>switchers</em>, in period <span class="math inline">\(A\)</span>, <span class="math inline">\(\tau=1\)</span>, for example.
One can then show that the DID estimator identifies the effect of the treatment relative to exiting the treatment: <span class="math inline">\(\Delta^Y_{DID}=\esp{Y^1_{i,A}-Y^0_{i,A}(1)|D_i=0}\)</span> under Assumptions <a href="NE.html#hyp:AllTreatmentFirst">4.21</a> and <a href="NE.html#hyp:ParallelTrendsy1">4.19</a>.
The proof is left as an exercise.</p>
</div>
</div>
</div>
<div id="DIDStaggered" class="section level3 hasAnchor" number="4.3.3">
<h3><span class="header-section-number">4.3.3</span> Difference In Differences with multiple time periods<a href="NE.html#DIDStaggered" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In real life, we generally have access to several time periods before and after the treatment date.
What happens to DID in that case?
Well, several things actually happen:</p>
<ol style="list-style-type: decimal">
<li>We now have several pre-treatment observations for each unit.
Which one should we choose to form our DID estimator?
If we use all of them, should we combine them?
If yes, how?</li>
<li>We also have several post-treatment observations.
Which one should we choose to form our DID estimator?
If we use all of them, should we combine them?
If yes, how?</li>
<li>We also have some units that will be treated for several periods in a row.
Should we use them to form a <span class="math inline">\(DID^r\)</span> estimator?
If yes, should we combine them with the DID estimates?
If yes, how?</li>
<li>We also might have some units that exit the treatment after some time.
Should we use them to form a DID estimator?
Should we combine this estimate with the others?
If yes, how?</li>
</ol>
<p>There is a lot of questions.
In order to be able to answer them, I am for the moment going to abstract from the last one.
I am going to assume that once a unit has entered the treatment, it cannot exit it.
DID designs such as these are called <em>staggered designs</em>.
This is obviously a very strong assumption, but we will relax it at some point.
Let’s go now.</p>
<div id="identification-8" class="section level4 hasAnchor" number="4.3.3.1">
<h4><span class="header-section-number">4.3.3.1</span> Identification<a href="NE.html#identification-8" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In this section, we are going to define rigorously the setting that we have in front of us and the several treatment effects that we might want to estimate.
This will be the most important part of the identification exercise.
Once the definitions are in place, identification will be mostly straightforward.</p>
<p>In a DID design with multiple time periods, time flows from <span class="math inline">\(t=1\)</span> to <span class="math inline">\(t=T\)</span>.
<span class="math inline">\(D_{i,t}\)</span> takes value one when unit <span class="math inline">\(i\)</span> is treated at period <span class="math inline">\(t\)</span> and zero otherwise.
In a staggered design, once treated, a unit is treated forever (the treatment is said to be an absorbing state).
As a consequence, we can characterize units by the date at which they start to be treated.
We are going to call this variable <span class="math inline">\(D_{i}\)</span> and it takes values in the set <span class="math inline">\(\left\{1,2,\dots,T,\infty\right\}\)</span>.
Units treated at period <span class="math inline">\(1\)</span> (or even before, we cannot say for sure) are <em>always treated</em> in a staggered design.
Then, units enter at successive periods until the last one.
Finally, some units may never receive the treatment (<em>never takers</em>).
By convention, we denote them with <span class="math inline">\(D_{i}=\infty\)</span>.</p>
<p>We can define a separate treatment effect for each of the treatment groups and for each time period: <span class="math inline">\(\Delta^{Y_{\tau}}_{TT_d}=\esp{Y^1_{i,d+\tau}-Y^0_{i,d+\tau}|D_i=d}\)</span>, for <span class="math inline">\(\tau,d\in\left\{1,2,\dots,T\right\}\)</span>.</p>
<p>We can also form a very large bunch of DID estimators:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;) &amp; = \esp{Y_{i,d+\tau}|D_i=d}-\esp{Y_{i,d-\tau&#39;}|D_i=d}-(\esp{Y_{i,d+\tau}|D_i=d&#39;}-\esp{Y_{i,d-\tau&#39;}|D_i=d&#39;}),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\tau,\tau&#39;&gt;0\)</span> and <span class="math inline">\(d&#39;&gt;d+\tau\)</span>.
<span class="math inline">\(\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span> tries to estimate the effect of the treatment on units that first entered the treatment at period <span class="math inline">\(t=d\)</span> (the treated group here) using the units that received the treatment at period <span class="math inline">\(d&#39;&gt;d\)</span> as a benchmark.
<span class="math inline">\(\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span> compares how outcomes have changed between <span class="math inline">\(\tau\)</span> periods after the treatment and <span class="math inline">\(\tau&#39;\)</span> periods before the treatment.</p>
<p>Imposing <span class="math inline">\(d&#39;&gt;d+\tau\)</span> ensures that <span class="math inline">\(\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span> is a proper DID estimator.
If <span class="math inline">\(d-\tau&#39;&lt;d&#39;&lt;d+\tau\)</span>, <span class="math inline">\(\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span> is not a proper DID estimator since units in group <span class="math inline">\(d&#39;\)</span> also receive the treatment between the two dates at which outcomes are measured.
When <span class="math inline">\(d&#39;&lt;d-\tau&#39;\)</span>, <span class="math inline">\(\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span> compares the change in outcomes in the group entering the treatment at date <span class="math inline">\(d\)</span> with the changes in outcomes occurring in a group that has already entered the treatment at a date <span class="math inline">\(d&#39;\)</span> that is prior the starting date of the DID.
Since this estimator is a <span class="math inline">\(DID^r\)</span> estimator, I am going to denote it as such in the future.
<span class="math inline">\(\Delta^{Y}_{DID^r}(d,d&#39;,\tau,\tau&#39;)\)</span> is well-defined only when <span class="math inline">\(d&#39;&lt;d-\tau&#39;\)</span>.</p>
<p>Before stating our first identification result, let us make some assumptions that will mirror the simpler ones we made in the previous section.
First, we are going to assume that at least some units are untreated at some period:</p>
<div class="hypothesis">
<p><span id="hyp:NoTreatmentTime" class="hypothesis"><strong>Hypothesis 4.23  (Some Units are Not Treated) </strong></span>We assume that not all units in the population are treated in the first period: <span class="math inline">\(\Pr(D_i=1)&lt;1\)</span>.</p>
</div>
<p>Next, we assume that agents cannot anticipate the treatment:</p>
<div class="hypothesis">
<p><span id="hyp:NoAnticipationEffectsTime" class="hypothesis"><strong>Hypothesis 4.24  (No Anticipation Effects over Time) </strong></span>We assume that agents cannot anticipate that the program will happen and that they do not change their behavior as a consequence: <span class="math inline">\(Y_{i,t}=Y^0_{i,t}\)</span>, <span class="math inline">\(\forall i\in \left\{i:D_i=d\right\}\)</span>, <span class="math inline">\(\forall t&lt;d\)</span>.</p>
</div>
<p>As a consequence of Assumptions <a href="NE.html#hyp:NoTreatmentTime">4.23</a> and <a href="NE.html#hyp:NoAnticipationEffectsTime">4.24</a>, we can write observed outcomes as a function of treatment and potential outcomes using the usual switching equation.</p>
<p>The final very important assumption that we can make is to assume that the trends in the potential outcomes in the absence the treatment are the same for the treated and the untreated units:</p>
<div class="hypothesis">
<p><span id="hyp:ParallelTrendsTime" class="hypothesis"><strong>Hypothesis 4.25  (Parallel Trends for All Groups) </strong></span>We assume that the trends in the potential outcomes in the absence the treatment are the same for all the treatment groups:</p>
<p><span class="math display">\[\begin{align*}
   \forall d,t,t&#39;\in\left\{1,2,\dots,T\right\}, &amp; \esp{Y^0_{i,t}|D_i=d} - \esp{Y^0_{i,t&#39;}|D_i=d} =   \esp{Y^0_{i,t}|D_i=\infty} - \esp{Y^0_{i,t&#39;}|D_i=\infty}.
\end{align*}\]</span></p>
</div>
<p>We are now ready to state our main identification result:</p>
<div class="theorem">
<p><span id="thm:IdentDIDTime" class="theorem"><strong>Theorem 4.18  (DID identifies TT at Each Point in Time) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentTime">4.23</a>, <a href="NE.html#hyp:NoAnticipationEffectsTime">4.24</a> and <a href="NE.html#hyp:ParallelTrendsTime">4.25</a>, the DID estimator identifies the average effect of the Treatment on the Treated in each time period:</p>
<p><span class="math display">\[\begin{align*}
    \Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;) &amp; =  \Delta^{Y_{\tau}}_{TT_d},
\end{align*}\]</span>
where <span class="math inline">\(\tau,\tau&#39;&gt;0\)</span> and <span class="math inline">\(d&#39;&gt;d+\tau\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-125" class="proof"><em>Proof</em>. </span><span class="math display">\[\begin{align*}
  \Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;) &amp; = \esp{Y_{i,d+\tau}-Y_{i,d-\tau&#39;}|D_i=d}-\esp{Y_{i,d+\tau}-Y_{i,d-\tau&#39;}|D_i=d&#39;}\\
                                    &amp; = \esp{Y^1_{i,d+\tau}-Y^0_{i,d-\tau&#39;}|D_i=d}-\esp{Y^0_{i,d+\tau}-Y^0_{i,d-\tau&#39;}|D_i=d&#39;}\\
                                    &amp; = \esp{Y^1_{i,d+\tau}-Y^0_{i,d-\tau&#39;}|D_i=d}-\esp{Y^0_{i,d+\tau}-Y^0_{i,d-\tau&#39;}|D_i=d}\\
                                    &amp; = \esp{Y^1_{i,d+\tau}-Y^0_{i,d+\tau}|D_i=d}
\end{align*}\]</span></p>
<p>where the second equality follows from Assumptions <a href="NE.html#hyp:NoTreatmentTime">4.23</a> and <a href="NE.html#hyp:NoAnticipationEffectsTime">4.24</a> and the fact that <span class="math inline">\(d&#39;&gt;d+\tau\)</span>.
The third equality follows from Assumption <a href="NE.html#hyp:ParallelTrendsTime">4.25</a>.
This proves the result.</p>
</div>
<p>Theorem <a href="NE.html#thm:IdentDIDTime">4.18</a> shows that the basic mechanics of the DID estimator extends to multiple periods.
The problem with Theorem <a href="NE.html#thm:IdentDIDTime">4.18</a> is that we now have multiple ATT estimates for various groups and time periods, using various time periods and groups as reference.
How do we reconcile all of these estimates in a unique parameter, or at least a vector of parameters that makes some sense?
Let’s define sets of positive weights <span class="math inline">\(w^k(d,d&#39;,\tau,\tau&#39;)\)</span> that sum to one.
We can then define a set of DID estimators:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^{Y}_{DID}(k)=\sum w^k(d,d&#39;,\tau,\tau&#39;)\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;),
\end{align*}\]</span></p>
<p>where the sum is taken in coherence with the weights.
These DID estimators are going to identify various features of the effects of the treatment, using various types of reference groups and time periods.
Let us be more precise:</p>
<ol style="list-style-type: decimal">
<li>A first set of weights combines the various estimates of the same treatment effect on the outcomes of group <span class="math inline">\(d\)</span> observed at period <span class="math inline">\(d=\tau\)</span>.
These weights, which we denote <span class="math inline">\(w^s_{d,\tau}(d&#39;,\tau&#39;)\)</span>, are such that they take value zero for estimates <span class="math inline">\(\Delta^{Y}_{DID}(d&#39;&#39;,d&#39;,\tau&#39;&#39;,\tau&#39;)\)</span> that are such <span class="math inline">\(d&#39;&#39;\neq d\)</span> and <span class="math inline">\(\tau&#39;&#39;\neq\tau\)</span> and they have: <span class="math inline">\(\sum_{\tau&#39;,d&#39;&gt;d+\tau}w^s_{d,\tau}(d&#39;,\tau&#39;)=1\)</span>.
One way to define these weights is to make them proportional to the proportion of <span class="math inline">\((d&#39;,\tau&#39;)\)</span> groups of observations in the population.</li>
<li>A second set of weights is going to combine the treatment effects themselves.
For example, one might want to measure the average effect of the treatment <span class="math inline">\(\tau\)</span> periods after entering it.
This type of dynamic treatment effect is useful to measure how the effect of the treatment varies over time.
There are two versions of this set of weights: one unconditional and one conditional on at least reaching a certain number of periods in the treatment (let’s say <span class="math inline">\(\tau&#39;&#39;&gt;\tau\)</span> periods after the treatment).
With the second version, all the estimates of the dynamic effects of the treatment are going to be taken over the same set of groups.
With the first version, changes in treatment effects over time might be confounded by changes in group composition.
Let’s denote the first type of weights <span class="math inline">\(w^u_{\tau}(d,d&#39;,\tau&#39;)\)</span> and the second <span class="math inline">\(w^c_{\tau,\tau&#39;&#39;}(d,d&#39;,\tau&#39;)\)</span> , with <span class="math inline">\(\tau&#39;&#39;&gt;\tau\)</span>.
We then have <span class="math inline">\(\Delta^{Y_u}_{DID}(\tau)=\sum_{d,d&#39;&gt;d+\tau,\tau&#39;} w^u_{\tau}(d,d&#39;,\tau&#39;)\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span> and <span class="math inline">\(\Delta^{Y_c}_{DID}(\tau,\tau&#39;&#39;)=\sum_{d,d&#39;&gt;d+\tau,\tau&#39;} w^c_{\tau,\tau&#39;&#39;}(d,d&#39;,\tau&#39;)\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span>.
These effects can also be restricted to versions using a single reference period <span class="math inline">\(\tau&#39;\)</span> to build the DID estimator: <span class="math inline">\(\Delta^{Y_u}_{DID}(\tau,\tau&#39;)\)</span> and <span class="math inline">\(\Delta^{Y_c}_{DID}(\tau,\tau&#39;,\tau&#39;&#39;)\)</span>.</li>
<li>A third set of effects is simply taking the average of all the treatment effects at a given time period.
Let’s denote these set of weights <span class="math inline">\(w^t(d,d&#39;,\tau,\tau&#39;)\)</span> for the effect observed at period <span class="math inline">\(t\)</span>.
Then, we have <span class="math inline">\(\Delta^{Y_t}_{DID}=\sum_{\tau+d=t,d&#39;&gt;d+\tau,\tau&#39;} w^t(d,d&#39;,\tau,\tau&#39;)\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span>.
Another version again uses only estimates taken with period <span class="math inline">\(d-\tau&#39;\)</span> as a reference: <span class="math inline">\(\Delta^{Y_t}_{DID}(\tau&#39;)=\sum_{\tau+d=t,d&#39;&gt;d+\tau} w^t_{\tau&#39;}(d,d&#39;,\tau)\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span>.</li>
<li>Finally, one can simply define the overall effect of the treatment on the treated as the sum of all relevant treatment effects estimated in the sample.
Let’s define the set of weights <span class="math inline">\(w^a(d,d&#39;,\tau,\tau&#39;)\)</span> and the estimate of the average treatment effect on the treated as <span class="math inline">\(\Delta^{Y}_{DID}=\sum_{\tau,d,d&#39;&gt;d+\tau,\tau&#39;} w^a(d,d&#39;,\tau,\tau&#39;)\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span>.
Again, some authors restrict this estimate to be specific to a given reference period: <span class="math inline">\(\Delta^{Y}_{DID}(\tau&#39;)=\sum_{\tau,d,d&#39;&gt;d+\tau} w^a_{\tau&#39;}(d,d&#39;,\tau)\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span>.</li>
</ol>
<p>As a consequence of Theorem <a href="NE.html#thm:IdentDIDTime">4.18</a>, all the aggregate treatment effects are identified, as long as each of their separate components are identified.
The following corollary makes that clear:</p>
<div class="corollary">
<p><span id="cor:IdentDIDAgg" class="corollary"><strong>Corollary 4.3  (DID identifies Weighted TT) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentTime">4.23</a>, <a href="NE.html#hyp:NoAnticipationEffectsTime">4.24</a> and <a href="NE.html#hyp:ParallelTrendsTime">4.25</a>, assuming that <span class="math inline">\(\Pr(D_i=d)&gt;0\)</span> and <span class="math inline">\(\Pr(D_i=d&#39;)&gt;0\)</span>, <span class="math inline">\(\forall (d,d&#39;)\in \left\{1,2,\dots,T,\infty\right\}\)</span> such that <span class="math inline">\(w^k(d,d&#39;,\tau,\tau&#39;)&gt;0\)</span> and assuming that <span class="math inline">\(\forall d,d&#39;,\tau,\tau&#39;\)</span> such that <span class="math inline">\(w^k(d,d&#39;,\tau,\tau&#39;)&gt;0\)</span>, <span class="math inline">\((d+\tau,d&#39;-\tau&#39;)\in\left\{1,2,\dots,T,\infty\right\}^2\)</span>, the weighted DID estimator identifies the corresponding weigthed average of Treatment on the Treated:</p>
<p><span class="math display">\[\begin{align*}
    \Delta^{Y}_{DID}(k) &amp; =  \Delta^{Y}_{TT}(k),
\end{align*}\]</span>
with
<span class="math display">\[\begin{align*}
    \Delta^{Y}_{TT}(k) &amp; = \sum w^k(d,d&#39;,\tau,\tau&#39;)\Delta^{Y_{\tau}}_{TT_d}
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-126" class="proof"><em>Proof</em>. </span>The proof follows from Theorem <a href="NE.html#thm:IdentDIDTime">4.18</a>: as long as the groups for which the weights are non null exist, and the time periods for which the weights are non null also exist in the data, Theorem <a href="NE.html#thm:IdentDIDTime">4.18</a> ensures that each of the components of the weighted average is identifed and thus the weighted average is identified as well.</p>
</div>
<p>Before going through an example to illustrate all of these notions, let me introduce one estimator.</p>
</div>
<div id="estimation-3" class="section level4 hasAnchor" number="4.3.3.2">
<h4><span class="header-section-number">4.3.3.2</span> Estimation<a href="NE.html#estimation-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Estimation of the various DID estimators that we have defined in the previous section can take several forms.
The simplest form estimates the separate individual DID components using the methods seen in Section <a href="NE.html#sec:DIDbasic">4.3.1</a>, and then manually computes their weighted averages.
I will detail this approach first.
A very similar approach uses the estimates obtained with one reference period (in general <span class="math inline">\(\tau&#39;=1\)</span>) and combines them to obtain one treatment effect or a series of treatment effects around the treatment date.
This approach has been proposed by <a href="https://www.sciencedirect.com/science/article/pii/S030440762030378X">Sun and Abraham (2021)</a> and by <a href="https://www.sciencedirect.com/science/article/pii/S0304407620303948">Callaway and Sant’Anna (2021)</a>.
A more intricate approach uses an imputation model to derive the predicted counterfactual values for all treated observations and then averages them.
This approach has been proposed by <a href="http://arxiv.org/abs/2108.12419">Borusyak, Jaravel and Speiss (2021)</a>, <a href="http://arxiv.org/abs/2107.00856">Liu, Wang and Xu (2021)</a> and <a href="https://jrgcmu.github.io/2sdd_current.pdf">Gardner (2021)</a>.
<a href="https://www.aeaweb.org/articles?id=10.1257/aer.20181169">de Chaisemartin and d’Haultfoeuille (2020)</a> propose to only use changes that occur around the treatment date.
Finally, one could use the Two Way Fixed Effects model presented in Section <a href="NE.html#sec:DIDbasic">4.3.1</a>, combining all the time periods in a single estimator.
Recent work by <a href="https://www.sciencedirect.com/science/article/pii/S0304407621001445">Goodman-Bacon (2021)</a> has shown that this approach is only valid under much more restrictive assumptions than the ones stated in Corollary <a href="NE.html#cor:IdentDIDAgg">4.3</a>.
The main reason for why it is so is that the Two Way Fixed Effects estimator combines individual DID and <span class="math inline">\(DID^r\)</span> estimates, thereby generating strong biases if the assumptions that ensure the validity of <span class="math inline">\(DID^r\)</span> are not valid.
An extension to the Two Way Fixed Effects estimator, the stacked DID estimator, restores its good properties.
It has been proposed by <a href="https://academic.oup.com/qje/article/134/3/1405/5484905">Cengiz, Dube, Lindner and Zipperer (2019)</a> and extended by <a href="https://jrgcmu.github.io/2sdd_current.pdf">Gardner (2021)</a>.
The <code>R</code> packages required to implement all of these estimators are listed on <a href="https://asjadnaqvi.github.io/DiD/docs/02_R/">Asjad Naqvi’s DID webpage</a>.
We are going to see how they perform on our data.</p>
<div id="IndivDID" class="section level5 hasAnchor" number="4.3.3.2.1">
<h5><span class="header-section-number">4.3.3.2.1</span> Using weighted averages of individual DID estimators<a href="NE.html#IndivDID" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>This estimator is pretty simple to define.
Simply take all the possible <span class="math inline">\(2\times2\)</span> possible DID estimators <span class="math inline">\(\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span>, with <span class="math inline">\(\tau,\tau&#39;&gt;0\)</span> and <span class="math inline">\(d&#39;&gt;d+\tau\)</span>, and then average them using the pre-defined weights <span class="math inline">\(w^k(d,d&#39;,\tau,\tau&#39;)\)</span> of your choice.
The key to this section is to illustrate how to operationalize this approach in practice with an example.
Let’s go.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-231" class="example"><strong>Example 4.42  </strong></span>The key here is first to generate some data.</p>
</div>
<p>We are going to have four successive time periods, <span class="math inline">\(1\)</span>, <span class="math inline">\(2\)</span>, <span class="math inline">\(3\)</span>, and <span class="math inline">\(4\)</span>.
At each of these time periods, some units start receiving the treatment, generating four treatment groups: <span class="math inline">\(D_i\in\{1,2,3,4\}\)</span>.
Let us write a model compatible with this setting, choose a parameterization and generate the data.</p>
<p><span class="math display">\[\begin{align*}
y^1_{i,t} &amp; = y_{i,t}^0+\bar{\alpha}_t+\sum_{d}(\bar{\alpha}_{t,d}+\theta_d\mu_i)\uns{D_{i,d}=1}+\eta_{i,t} \\
y^0_{i,t} &amp; = \mu_i+\delta_t+U^0_{i,t} \\
U^0_{i,t} &amp; = \rho U^0_{i,t-1}+\epsilon_{i,t} \\
D_{i,t}   &amp; = \uns{y^0_{i,1} + \xi_t+ V_i\leq\bar{y}} \\
V_i   &amp; = \gamma(\mu_i-\bar{\mu}) + \omega_{i,1} \\
U^0_{i,1} &amp; \sim\mathcal{N}(0,\sigma^2_{U}) \\
\mu_i &amp; \sim\mathcal{N}(\bar{\mu},\sigma^2_{\mu}) \\
(\eta_{i,t},\omega_{i,t}) &amp; \sim\mathcal{N}(0,0,\sigma^2_{\eta},\sigma^2_{\omega},\rho_{\eta,\omega})\\
\epsilon_{i,t} &amp; \sim\mathcal{N}(0,\sigma^2_{\epsilon}).
\end{align*}\]</span></p>
<p>I am going to parameterize the <span class="math inline">\(\bar{\alpha}_{t,d}\)</span> process in order to avoid having to specify the 14 parameters that it otherwise would require.
The parameterization I am choosing is <span class="math inline">\(\bar{\alpha}_{t,d}=\bar\chi_d+\kappa_d(t-d)\uns{t\geq d}\)</span>, so that treatment effects increase linearly as time into the treatment increases.
Let us now choose some parameter values:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="NE.html#cb200-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,</span>
<span id="cb200-2"><a href="NE.html#cb200-2" tabindex="-1"></a>           <span class="fl">0.01</span>,<span class="fl">0.01</span>,<span class="fl">0.01</span>,<span class="fl">0.01</span>,</span>
<span id="cb200-3"><a href="NE.html#cb200-3" tabindex="-1"></a>           <span class="fl">0.05</span>,<span class="fl">0.05</span>,</span>
<span id="cb200-4"><a href="NE.html#cb200-4" tabindex="-1"></a>           <span class="dv">0</span>,<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>,</span>
<span id="cb200-5"><a href="NE.html#cb200-5" tabindex="-1"></a>           <span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.15</span>,<span class="fl">0.2</span>,</span>
<span id="cb200-6"><a href="NE.html#cb200-6" tabindex="-1"></a>           <span class="fl">0.25</span>,<span class="fl">0.1</span>,<span class="fl">0.05</span>,<span class="dv">0</span>,</span>
<span id="cb200-7"><a href="NE.html#cb200-7" tabindex="-1"></a>           <span class="fl">1.5</span>,<span class="fl">1.25</span>,<span class="dv">1</span>,<span class="fl">0.75</span>,</span>
<span id="cb200-8"><a href="NE.html#cb200-8" tabindex="-1"></a>           <span class="fl">0.5</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="fl">0.5</span>,<span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb200-9"><a href="NE.html#cb200-9" tabindex="-1"></a>           <span class="fl">0.1</span>,<span class="fl">0.28</span>,<span class="dv">0</span>)</span>
<span id="cb200-10"><a href="NE.html#cb200-10" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,</span>
<span id="cb200-11"><a href="NE.html#cb200-11" tabindex="-1"></a>                  <span class="st">&quot;theta1&quot;</span>,<span class="st">&quot;theta2&quot;</span>,<span class="st">&quot;theta3&quot;</span>,<span class="st">&quot;theta4&quot;</span>,</span>
<span id="cb200-12"><a href="NE.html#cb200-12" tabindex="-1"></a>                  <span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,</span>
<span id="cb200-13"><a href="NE.html#cb200-13" tabindex="-1"></a>                  <span class="st">&quot;delta1&quot;</span>,<span class="st">&quot;delta2&quot;</span>,<span class="st">&quot;delta3&quot;</span>,<span class="st">&quot;delta4&quot;</span>,</span>
<span id="cb200-14"><a href="NE.html#cb200-14" tabindex="-1"></a>                  <span class="st">&quot;baralpha1&quot;</span>,<span class="st">&quot;baralpha2&quot;</span>,<span class="st">&quot;baralpha3&quot;</span>,<span class="st">&quot;baralpha4&quot;</span>,</span>
<span id="cb200-15"><a href="NE.html#cb200-15" tabindex="-1"></a>                  <span class="st">&quot;barchi1&quot;</span>,<span class="st">&quot;barchi2&quot;</span>,<span class="st">&quot;barchi3&quot;</span>,<span class="st">&quot;barchi4&quot;</span>,</span>
<span id="cb200-16"><a href="NE.html#cb200-16" tabindex="-1"></a>                  <span class="st">&quot;kappa1&quot;</span>,<span class="st">&quot;kappa2&quot;</span>,<span class="st">&quot;kappa3&quot;</span>,<span class="st">&quot;kappa4&quot;</span>,</span>
<span id="cb200-17"><a href="NE.html#cb200-17" tabindex="-1"></a>                  <span class="st">&quot;xi1&quot;</span>,<span class="st">&quot;xi2&quot;</span>,<span class="st">&quot;xi3&quot;</span>,<span class="st">&quot;xi4&quot;</span>,</span>
<span id="cb200-18"><a href="NE.html#cb200-18" tabindex="-1"></a>                  <span class="st">&quot;gamma&quot;</span>,<span class="st">&quot;sigma2omega&quot;</span>,<span class="st">&quot;rhoetaomega&quot;</span>)</span></code></pre></div>
<p>Let us now generate the corresponding data (in long format):</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="NE.html#cb201-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb201-2"><a href="NE.html#cb201-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb201-3"><a href="NE.html#cb201-3" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb201-4"><a href="NE.html#cb201-4" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb201-5"><a href="NE.html#cb201-5" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N<span class="sc">*</span>T,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb201-6"><a href="NE.html#cb201-6" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;eta&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb201-7"><a href="NE.html#cb201-7" tabindex="-1"></a><span class="co"># time and individual identifiers</span></span>
<span id="cb201-8"><a href="NE.html#cb201-8" tabindex="-1"></a>data<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,N),<span class="fu">rep</span>(<span class="dv">2</span>,N),<span class="fu">rep</span>(<span class="dv">3</span>,N),<span class="fu">rep</span>(<span class="dv">4</span>,N))</span>
<span id="cb201-9"><a href="NE.html#cb201-9" tabindex="-1"></a>data<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>((<span class="dv">1</span><span class="sc">:</span>N),T)</span>
<span id="cb201-10"><a href="NE.html#cb201-10" tabindex="-1"></a><span class="co"># unit fixed effects</span></span>
<span id="cb201-11"><a href="NE.html#cb201-11" tabindex="-1"></a>data<span class="sc">$</span>mu <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>])),T)</span>
<span id="cb201-12"><a href="NE.html#cb201-12" tabindex="-1"></a><span class="co"># time fixed effects</span></span>
<span id="cb201-13"><a href="NE.html#cb201-13" tabindex="-1"></a>data<span class="sc">$</span>delta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(param[<span class="st">&quot;delta1&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta2&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta3&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta4&quot;</span>],N))</span>
<span id="cb201-14"><a href="NE.html#cb201-14" tabindex="-1"></a>data<span class="sc">$</span>baralphat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(param[<span class="st">&quot;baralpha1&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha2&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha3&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha4&quot;</span>],N))</span>
<span id="cb201-15"><a href="NE.html#cb201-15" tabindex="-1"></a></span>
<span id="cb201-16"><a href="NE.html#cb201-16" tabindex="-1"></a><span class="co"># building autocorrelated error terms</span></span>
<span id="cb201-17"><a href="NE.html#cb201-17" tabindex="-1"></a>data<span class="sc">$</span>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N<span class="sc">*</span>T,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb201-18"><a href="NE.html#cb201-18" tabindex="-1"></a>data<span class="sc">$</span>U[<span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb201-19"><a href="NE.html#cb201-19" tabindex="-1"></a>data<span class="sc">$</span>U[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)]</span>
<span id="cb201-20"><a href="NE.html#cb201-20" tabindex="-1"></a>data<span class="sc">$</span>U[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)]</span>
<span id="cb201-21"><a href="NE.html#cb201-21" tabindex="-1"></a>data<span class="sc">$</span>U[(<span class="dv">3</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(<span class="dv">3</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">*</span>N)]</span>
<span id="cb201-22"><a href="NE.html#cb201-22" tabindex="-1"></a><span class="co"># potential outcomes in the absence of the treatment</span></span>
<span id="cb201-23"><a href="NE.html#cb201-23" tabindex="-1"></a>data<span class="sc">$</span>y0 <span class="ot">&lt;-</span> data<span class="sc">$</span>mu <span class="sc">+</span> data<span class="sc">$</span>delta <span class="sc">+</span> data<span class="sc">$</span>U </span>
<span id="cb201-24"><a href="NE.html#cb201-24" tabindex="-1"></a>data<span class="sc">$</span>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(data<span class="sc">$</span>y0)</span>
<span id="cb201-25"><a href="NE.html#cb201-25" tabindex="-1"></a><span class="co"># treatment timing</span></span>
<span id="cb201-26"><a href="NE.html#cb201-26" tabindex="-1"></a><span class="co"># error term</span></span>
<span id="cb201-27"><a href="NE.html#cb201-27" tabindex="-1"></a>data<span class="sc">$</span>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(data<span class="sc">$</span>mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>data<span class="sc">$</span>omega</span>
<span id="cb201-28"><a href="NE.html#cb201-28" tabindex="-1"></a><span class="co"># treatment group, with 99 for the never treated instead of infinity</span></span>
<span id="cb201-29"><a href="NE.html#cb201-29" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi1&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">1</span>,</span>
<span id="cb201-30"><a href="NE.html#cb201-30" tabindex="-1"></a>              <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi2&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">2</span>,</span>
<span id="cb201-31"><a href="NE.html#cb201-31" tabindex="-1"></a>                      <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi3&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">3</span>,</span>
<span id="cb201-32"><a href="NE.html#cb201-32" tabindex="-1"></a>                              <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi4&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">4</span>,<span class="dv">99</span>))))</span>
<span id="cb201-33"><a href="NE.html#cb201-33" tabindex="-1"></a>data<span class="sc">$</span>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(Ds,T)</span>
<span id="cb201-34"><a href="NE.html#cb201-34" tabindex="-1"></a><span class="co"># Treatment status</span></span>
<span id="cb201-35"><a href="NE.html#cb201-35" tabindex="-1"></a>data<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">&gt;</span>data<span class="sc">$</span>time,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb201-36"><a href="NE.html#cb201-36" tabindex="-1"></a><span class="co"># potential outcomes with the treatment</span></span>
<span id="cb201-37"><a href="NE.html#cb201-37" tabindex="-1"></a><span class="co"># effect of the treatment by group</span></span>
<span id="cb201-38"><a href="NE.html#cb201-38" tabindex="-1"></a>data<span class="sc">$</span>baralphatd <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;barchi1&quot;</span>],</span>
<span id="cb201-39"><a href="NE.html#cb201-39" tabindex="-1"></a>                           <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;barchi2&quot;</span>],</span>
<span id="cb201-40"><a href="NE.html#cb201-40" tabindex="-1"></a>                                   <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;barchi3&quot;</span>],</span>
<span id="cb201-41"><a href="NE.html#cb201-41" tabindex="-1"></a>                                           <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">4</span>,param[<span class="st">&quot;barchi4&quot;</span>],<span class="dv">0</span>))))<span class="sc">+</span></span>
<span id="cb201-42"><a href="NE.html#cb201-42" tabindex="-1"></a>                  <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;kappa1&quot;</span>],</span>
<span id="cb201-43"><a href="NE.html#cb201-43" tabindex="-1"></a>                           <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;kappa2&quot;</span>],</span>
<span id="cb201-44"><a href="NE.html#cb201-44" tabindex="-1"></a>                                   <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;kappa3&quot;</span>],</span>
<span id="cb201-45"><a href="NE.html#cb201-45" tabindex="-1"></a>                                           <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">4</span>,param[<span class="st">&quot;kappa4&quot;</span>],<span class="dv">0</span>))))<span class="sc">*</span>(data<span class="sc">$</span>time<span class="sc">-</span>data<span class="sc">$</span>Ds)<span class="sc">*</span><span class="fu">if_else</span>(data<span class="sc">$</span>time<span class="sc">&gt;=</span>data<span class="sc">$</span>Ds,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb201-46"><a href="NE.html#cb201-46" tabindex="-1"></a>data<span class="sc">$</span>y1 <span class="ot">&lt;-</span> data<span class="sc">$</span>y0 <span class="sc">+</span> data<span class="sc">$</span>baralphat <span class="sc">+</span> data<span class="sc">$</span>baralphatd <span class="sc">+</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;theta1&quot;</span>],<span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;theta2&quot;</span>],<span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;theta3&quot;</span>],param[<span class="st">&quot;theta4&quot;</span>])))<span class="sc">*</span>data<span class="sc">$</span>mu <span class="sc">+</span> data<span class="sc">$</span>eta</span>
<span id="cb201-47"><a href="NE.html#cb201-47" tabindex="-1"></a>data<span class="sc">$</span>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(data<span class="sc">$</span>y1)</span>
<span id="cb201-48"><a href="NE.html#cb201-48" tabindex="-1"></a>data<span class="sc">$</span>y <span class="ot">&lt;-</span> data<span class="sc">$</span>y1<span class="sc">*</span>data<span class="sc">$</span>D<span class="sc">+</span>data<span class="sc">$</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>data<span class="sc">$</span>D)</span>
<span id="cb201-49"><a href="NE.html#cb201-49" tabindex="-1"></a>data<span class="sc">$</span>Y <span class="ot">&lt;-</span> data<span class="sc">$</span>Y1<span class="sc">*</span>data<span class="sc">$</span>D<span class="sc">+</span>data<span class="sc">$</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>data<span class="sc">$</span>D)</span></code></pre></div>
<p>Let us now plot the data, especially the potential outcomes for each group.</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="NE.html#cb202-1" tabindex="-1"></a>dataplotDIDStaggered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb202-2"><a href="NE.html#cb202-2" tabindex="-1"></a>                          <span class="fu">group_by</span>(Ds,time) <span class="sc">%&gt;%</span></span>
<span id="cb202-3"><a href="NE.html#cb202-3" tabindex="-1"></a>                          <span class="fu">summarize</span>(</span>
<span id="cb202-4"><a href="NE.html#cb202-4" tabindex="-1"></a>                            <span class="at">y1=</span><span class="fu">mean</span>(y1),</span>
<span id="cb202-5"><a href="NE.html#cb202-5" tabindex="-1"></a>                            <span class="at">y0=</span><span class="fu">mean</span>(y0)</span>
<span id="cb202-6"><a href="NE.html#cb202-6" tabindex="-1"></a>                          ) <span class="sc">%&gt;%</span></span>
<span id="cb202-7"><a href="NE.html#cb202-7" tabindex="-1"></a>                          <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">&quot;y1&quot;</span>,<span class="st">&quot;y0&quot;</span>),<span class="at">values_to=</span><span class="st">&quot;Outcome&quot;</span>,<span class="at">names_to=</span><span class="st">&quot;PotentialOutcome&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb202-8"><a href="NE.html#cb202-8" tabindex="-1"></a>                          <span class="fu">mutate</span>(</span>
<span id="cb202-9"><a href="NE.html#cb202-9" tabindex="-1"></a>                            <span class="at">TreatmentDate =</span> <span class="fu">factor</span>(Ds,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;99&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;1&quot;</span>))</span>
<span id="cb202-10"><a href="NE.html#cb202-10" tabindex="-1"></a>                          )</span>
<span id="cb202-11"><a href="NE.html#cb202-11" tabindex="-1"></a></span>
<span id="cb202-12"><a href="NE.html#cb202-12" tabindex="-1"></a><span class="fu">ggplot</span>(dataplotDIDStaggered,<span class="fu">aes</span>(<span class="at">x=</span>time,<span class="at">y=</span>Outcome,<span class="at">color=</span>TreatmentDate,<span class="at">shape=</span>TreatmentDate,<span class="at">linetype=</span>PotentialOutcome))<span class="sc">+</span></span>
<span id="cb202-13"><a href="NE.html#cb202-13" tabindex="-1"></a>      <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb202-14"><a href="NE.html#cb202-14" tabindex="-1"></a>      <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb202-15"><a href="NE.html#cb202-15" tabindex="-1"></a><span class="co">#    scale_linetype_discrete(guide=&#39;none&#39;) +</span></span>
<span id="cb202-16"><a href="NE.html#cb202-16" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggered"></span>
<img src="STCI_files/figure-html/PlotDIDStaggered-1.png" alt="Evolution of average outcomes in the various treatment groups defined by their date of entry into the treatment" width="50%" />
<p class="caption">
Figure 4.26: Evolution of average outcomes in the various treatment groups defined by their date of entry into the treatment
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDStaggered">4.26</a> shows that the first units to be treated have the lowest potential outcomes in the absence of the treatment (<span class="math inline">\(y^0\)</span>, in full line), and that each successive cohort entering the treatment over time has increasingly large potential outcomes.
Assumption <a href="NE.html#hyp:ParallelTrendsTime">4.25</a> seems to hold in this dataset, at least visually: the trends in potential outcomes in the absence of the treatment seem to be rather parallel to each other in each group.
Once a group of unit has entered the treatment, it experiences an increase in outcomes that grows over time.
Finally, note that we will be unable to estimate the impact on the group with <span class="math inline">\(D_i=1\)</span> since they enter the treatment at the first period.</p>
<p>Let us now compute each possible DID estimator on this dataset.
In order to save some space and time, we will start by focusing on group 2.
Group 2 starts treatment at period 2, and thus only period 1 can be used for building a DID estimator.
But several comparison groups exist: the never treated (note that we have used <span class="math inline">\(D_i=99\)</span> instead of <span class="math inline">\(D_i=\infty\)</span> to characterize this group, in order to make it simpler to manipulate it in <code>R</code>) but also group 3, that can serve as an untreated benchmark between periods 1 and 2, and group 4, which can be used as an untreated benchmark in periods 1, 2 and 3.
Let’s compute all these effects.
In order to make our lives simpler, we are going to generate a function to generate <span class="math inline">\(\hat\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span>.</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="NE.html#cb203-1" tabindex="-1"></a><span class="co"># StaggeredDID22 is a function that takes as inputs:</span></span>
<span id="cb203-2"><a href="NE.html#cb203-2" tabindex="-1"></a><span class="co"># y: name of outcome variable (character)</span></span>
<span id="cb203-3"><a href="NE.html#cb203-3" tabindex="-1"></a><span class="co"># D: name of treatment group variable (character)</span></span>
<span id="cb203-4"><a href="NE.html#cb203-4" tabindex="-1"></a><span class="co"># d: treatment group defined by date of entry into the treatment</span></span>
<span id="cb203-5"><a href="NE.html#cb203-5" tabindex="-1"></a><span class="co"># dprime: comparison group</span></span>
<span id="cb203-6"><a href="NE.html#cb203-6" tabindex="-1"></a><span class="co"># tau: number of periods after treatment date at which we estimate the effect of the treatment</span></span>
<span id="cb203-7"><a href="NE.html#cb203-7" tabindex="-1"></a><span class="co"># tauprime: number of periods before the treatment date that we use a baseline period (defaults to one)</span></span>
<span id="cb203-8"><a href="NE.html#cb203-8" tabindex="-1"></a><span class="co"># t: time indicator (character)</span></span>
<span id="cb203-9"><a href="NE.html#cb203-9" tabindex="-1"></a><span class="co"># i: individual unit indicator (character)</span></span>
<span id="cb203-10"><a href="NE.html#cb203-10" tabindex="-1"></a><span class="co"># data: dataset containing the outcomes and treatments and time and unit indicators</span></span>
<span id="cb203-11"><a href="NE.html#cb203-11" tabindex="-1"></a>StaggeredDID22 <span class="ot">&lt;-</span> <span class="cf">function</span>(tau,y,D,d,dprime,<span class="at">tauprime=</span><span class="dv">1</span>,t,i,data){</span>
<span id="cb203-12"><a href="NE.html#cb203-12" tabindex="-1"></a>  <span class="co"># taking out the irrelevant groups and time periods and generating a useful treatment variable</span></span>
<span id="cb203-13"><a href="NE.html#cb203-13" tabindex="-1"></a>  data.DID <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb203-14"><a href="NE.html#cb203-14" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(D)<span class="sc">==</span>d <span class="sc">|</span> <span class="sc">!!</span><span class="fu">sym</span>(D)<span class="sc">==</span>dprime) <span class="sc">%&gt;%</span> </span>
<span id="cb203-15"><a href="NE.html#cb203-15" tabindex="-1"></a>            <span class="fu">filter</span>(time<span class="sc">==</span>d<span class="sc">+</span>tau <span class="sc">|</span> time<span class="sc">==</span>d<span class="sc">-</span>tauprime) <span class="sc">%&gt;%</span></span>
<span id="cb203-16"><a href="NE.html#cb203-16" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb203-17"><a href="NE.html#cb203-17" tabindex="-1"></a>              <span class="at">Dit =</span> <span class="fu">if_else</span>(<span class="sc">!!</span><span class="fu">sym</span>(D)<span class="sc">==</span>d <span class="sc">&amp;</span> time<span class="sc">==</span>d<span class="sc">+</span>tau,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb203-18"><a href="NE.html#cb203-18" tabindex="-1"></a>            )</span>
<span id="cb203-19"><a href="NE.html#cb203-19" tabindex="-1"></a>  <span class="co"># running the within estimator (fixest)</span></span>
<span id="cb203-20"><a href="NE.html#cb203-20" tabindex="-1"></a>  <span class="co"># regression formula</span></span>
<span id="cb203-21"><a href="NE.html#cb203-21" tabindex="-1"></a>  DID.form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="fu">paste</span>(y,<span class="fu">paste</span>(<span class="st">&quot;Dit&quot;</span>,t,<span class="at">sep=</span><span class="st">&quot;+&quot;</span>),<span class="at">sep=</span><span class="st">&quot;~&quot;</span>),i,<span class="at">sep=</span><span class="st">&quot;|&quot;</span>))</span>
<span id="cb203-22"><a href="NE.html#cb203-22" tabindex="-1"></a>  reg.W.fixest <span class="ot">&lt;-</span> <span class="fu">feols</span>(DID.form, <span class="at">data =</span> data.DID)</span>
<span id="cb203-23"><a href="NE.html#cb203-23" tabindex="-1"></a>  <span class="co"># result vector</span></span>
<span id="cb203-24"><a href="NE.html#cb203-24" tabindex="-1"></a>  DID.est.W.fixest <span class="ot">&lt;-</span> <span class="fu">c</span>(d,dprime,tau,tauprime,<span class="fu">coef</span>(reg.W.fixest)[[<span class="dv">1</span>]],<span class="fu">sqrt</span>(<span class="fu">vcov</span>(reg.W.fixest)[[<span class="dv">1</span>,<span class="dv">1</span>]]))</span>
<span id="cb203-25"><a href="NE.html#cb203-25" tabindex="-1"></a>  <span class="fu">names</span>(DID.est.W.fixest) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;d&quot;</span>,<span class="st">&quot;dprime&quot;</span>,<span class="st">&quot;tau&quot;</span>,<span class="st">&quot;tauprime&quot;</span>,<span class="st">&quot;DIDest&quot;</span>,<span class="st">&quot;DIDse&quot;</span>)</span>
<span id="cb203-26"><a href="NE.html#cb203-26" tabindex="-1"></a>  <span class="fu">return</span>(DID.est.W.fixest)</span>
<span id="cb203-27"><a href="NE.html#cb203-27" tabindex="-1"></a>}</span>
<span id="cb203-28"><a href="NE.html#cb203-28" tabindex="-1"></a></span>
<span id="cb203-29"><a href="NE.html#cb203-29" tabindex="-1"></a><span class="co"># Run the regression and keep results</span></span>
<span id="cb203-30"><a href="NE.html#cb203-30" tabindex="-1"></a><span class="co"># D=99 as benchmark</span></span>
<span id="cb203-31"><a href="NE.html#cb203-31" tabindex="-1"></a><span class="co"># list of tau for d=2 and dprime=99 and tauprime=1</span></span>
<span id="cb203-32"><a href="NE.html#cb203-32" tabindex="-1"></a>tau.<span class="fl">2.99</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb203-33"><a href="NE.html#cb203-33" tabindex="-1"></a>DID.<span class="dv">2</span>.<span class="fl">99.1</span> <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(tau.<span class="fl">2.99</span>,StaggeredDID22,<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">d=</span><span class="dv">2</span>,<span class="at">dprime=</span><span class="dv">99</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">data=</span>data) </span>
<span id="cb203-34"><a href="NE.html#cb203-34" tabindex="-1"></a><span class="co"># D=3 </span></span>
<span id="cb203-35"><a href="NE.html#cb203-35" tabindex="-1"></a><span class="co"># list of tau for d=2 and dprime=3 and tauprime=1</span></span>
<span id="cb203-36"><a href="NE.html#cb203-36" tabindex="-1"></a>tau.<span class="fl">2.3</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>)</span>
<span id="cb203-37"><a href="NE.html#cb203-37" tabindex="-1"></a>DID.<span class="dv">2</span>.<span class="fl">3.1</span> <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(tau.<span class="fl">2.3</span>,StaggeredDID22,<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">d=</span><span class="dv">2</span>,<span class="at">dprime=</span><span class="dv">3</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">data=</span>data) </span>
<span id="cb203-38"><a href="NE.html#cb203-38" tabindex="-1"></a><span class="co"># D=4 </span></span>
<span id="cb203-39"><a href="NE.html#cb203-39" tabindex="-1"></a><span class="co"># list of tau for d=2 and dprime=4 and tauprime=1</span></span>
<span id="cb203-40"><a href="NE.html#cb203-40" tabindex="-1"></a>tau.<span class="fl">2.4</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb203-41"><a href="NE.html#cb203-41" tabindex="-1"></a>DID.<span class="dv">2</span>.<span class="fl">4.1</span> <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(tau.<span class="fl">2.4</span>,StaggeredDID22,<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">d=</span><span class="dv">2</span>,<span class="at">dprime=</span><span class="dv">4</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">data=</span>data) </span>
<span id="cb203-42"><a href="NE.html#cb203-42" tabindex="-1"></a></span>
<span id="cb203-43"><a href="NE.html#cb203-43" tabindex="-1"></a><span class="co"># regroup results</span></span>
<span id="cb203-44"><a href="NE.html#cb203-44" tabindex="-1"></a>DID.<span class="fl">2.1</span> <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.<span class="dv">2</span>.<span class="fl">99.1</span>,DID.<span class="dv">2</span>.<span class="fl">3.1</span>,DID.<span class="dv">2</span>.<span class="fl">4.1</span>)</span>
<span id="cb203-45"><a href="NE.html#cb203-45" tabindex="-1"></a></span>
<span id="cb203-46"><a href="NE.html#cb203-46" tabindex="-1"></a><span class="co"># true effects (in the sample)</span></span>
<span id="cb203-47"><a href="NE.html#cb203-47" tabindex="-1"></a>ATT.<span class="fl">2.0</span> <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>y1[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">2</span>])<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>y0[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">2</span>])</span>
<span id="cb203-48"><a href="NE.html#cb203-48" tabindex="-1"></a>ATT.<span class="fl">2.1</span> <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>y1[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">3</span>])<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>y0[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">3</span>])</span>
<span id="cb203-49"><a href="NE.html#cb203-49" tabindex="-1"></a>ATT.<span class="fl">2.2</span> <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>y1[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">4</span>])<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>y0[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">4</span>])</span></code></pre></div>
<p>Let us now plot the results for the DID estimates on group <span class="math inline">\(2\)</span> using <span class="math inline">\(\tau&#39;=1\)</span> as a benchmark pre-treatment period.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="NE.html#cb204-1" tabindex="-1"></a><span class="co"># preparing data</span></span>
<span id="cb204-2"><a href="NE.html#cb204-2" tabindex="-1"></a>DID.<span class="fl">2.1</span> <span class="ot">&lt;-</span> DID.<span class="fl">2.1</span> <span class="sc">%&gt;%</span></span>
<span id="cb204-3"><a href="NE.html#cb204-3" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb204-4"><a href="NE.html#cb204-4" tabindex="-1"></a>              <span class="at">dprime=</span><span class="fu">factor</span>(dprime,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;99&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;1&quot;</span>))</span>
<span id="cb204-5"><a href="NE.html#cb204-5" tabindex="-1"></a>            )</span>
<span id="cb204-6"><a href="NE.html#cb204-6" tabindex="-1"></a></span>
<span id="cb204-7"><a href="NE.html#cb204-7" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb204-8"><a href="NE.html#cb204-8" tabindex="-1"></a><span class="fu">ggplot</span>(DID.<span class="fl">2.1</span>,<span class="fu">aes</span>(<span class="at">x=</span>tau,<span class="at">y=</span>DIDest,<span class="at">colour=</span>dprime,<span class="at">linetype=</span>dprime))<span class="sc">+</span></span>
<span id="cb204-9"><a href="NE.html#cb204-9" tabindex="-1"></a>      <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb204-10"><a href="NE.html#cb204-10" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>DIDest<span class="fl">-1.96</span><span class="sc">*</span>DIDse,<span class="at">ymax=</span>DIDest<span class="fl">+1.96</span><span class="sc">*</span>DIDse))<span class="sc">+</span></span>
<span id="cb204-11"><a href="NE.html#cb204-11" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb204-12"><a href="NE.html#cb204-12" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time after treatment (tau)&quot;</span>) <span class="sc">+</span></span>
<span id="cb204-13"><a href="NE.html#cb204-13" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb204-14"><a href="NE.html#cb204-14" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb204-15"><a href="NE.html#cb204-15" tabindex="-1"></a>    <span class="fu">scale_colour_discrete</span>(<span class="at">name=</span><span class="st">&quot;Comparison</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb204-16"><a href="NE.html#cb204-16" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">name=</span><span class="st">&quot;Comparison</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb204-17"><a href="NE.html#cb204-17" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredGroup2"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredGroup2-1.png" alt="DID estimates for Group 2 at various time periods after the treament and with various comparison groups and with the reference period $\tau'=1$" width="50%" />
<p class="caption">
Figure 4.27: DID estimates for Group 2 at various time periods after the treament and with various comparison groups and with the reference period <span class="math inline">\(\tau&#39;=1\)</span>
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDStaggeredGroup2">4.27</a> shows the <span class="math inline">\(\hat\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span> estimates for <span class="math inline">\(d=2\)</span> and <span class="math inline">\(\tau&#39;=1\)</span>, varying both <span class="math inline">\(\tau\)</span> and <span class="math inline">\(d&#39;\)</span>.
The treatment effects estimated using different reference groups are similar to each other when we can compare them.
Moreover, the treatment effect grows with time, as expected from Figure <a href="NE.html#fig:PlotDIDStaggered">4.26</a>.
The true effects of the treatment on group 2 are, in our sample: <span class="math inline">\(\hat\Delta^{Y_{0}}_{TT_2}=\)</span> 0.31, <span class="math inline">\(\hat\Delta^{Y_{1}}_{TT_2}=\)</span> 1.56 and <span class="math inline">\(\hat\Delta^{Y_{2}}_{TT_2}=\)</span> 2.86.
These are very close to our DID estimates.
For example, <span class="math inline">\(\hat\Delta^{Y}_{DID}(2,99,0,1)=\)</span> 0.37, while <span class="math inline">\(\hat\Delta^{Y}_{DID}(2,4,0,1)=\)</span> 0.31 and <span class="math inline">\(\hat\Delta^{Y}_{DID}(2,3,0,1)=\)</span> 0.3, which are all pretty close to <span class="math inline">\(\hat\Delta^{Y_{0}}_{TT_2}=\)</span> 0.31.
<span class="math inline">\(\hat\Delta^{Y}_{DID}(2,99,1,1)=\)</span> 1.65, while <span class="math inline">\(\hat\Delta^{Y}_{DID}(2,4,1,1)=\)</span> 1.57, which are also all pretty close to <span class="math inline">\(\hat\Delta^{Y_{1}}_{TT_2}=\)</span> 1.56.
Finally, <span class="math inline">\(\hat\Delta^{Y}_{DID}(2,99,2,1)=\)</span> 2.99, while <span class="math inline">\(\hat\Delta^{Y_{2}}_{TT_2}=\)</span> 2.86.</p>
<p>In order to aggregate the estimates presented in Figure <a href="NE.html#fig:PlotDIDStaggeredGroup2">4.27</a>, we could for example use the proportion of each comparison group in the sample and average the treatment effects for each post treatment period <span class="math inline">\(\tau\)</span> with these weights.
We can do the same thing with groups 3 and 4 and see what happens.
Note that with these two groups, I can also estimate a placebo test: that is the effect of the treatment before the treatment takes place.
Such event study estimates have become standard in the DID literature.
I will expand on these tests in Section <a href="#sec:placebo"><strong>??</strong></a>.
For group 3, I can estimate the effect for <span class="math inline">\(\tau\in\{-2,0,1\}\)</span> and for group 4, for <span class="math inline">\(\tau\in\{-3,-2,0\}\)</span>, when the benchmark group is the <em>never treated</em> group.</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="NE.html#cb205-1" tabindex="-1"></a><span class="co"># do the DID22 estimates for d=3</span></span>
<span id="cb205-2"><a href="NE.html#cb205-2" tabindex="-1"></a><span class="co"># Run the regression and keep results</span></span>
<span id="cb205-3"><a href="NE.html#cb205-3" tabindex="-1"></a><span class="co"># D=99 as benchmark</span></span>
<span id="cb205-4"><a href="NE.html#cb205-4" tabindex="-1"></a><span class="co"># list of tau for d=3 and dprime=99 and tauprime=1</span></span>
<span id="cb205-5"><a href="NE.html#cb205-5" tabindex="-1"></a>tau.<span class="fl">3.99</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb205-6"><a href="NE.html#cb205-6" tabindex="-1"></a>DID.<span class="dv">3</span>.<span class="fl">99.1</span> <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(tau.<span class="fl">3.99</span>,StaggeredDID22,<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">d=</span><span class="dv">3</span>,<span class="at">dprime=</span><span class="dv">99</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">data=</span>data) </span>
<span id="cb205-7"><a href="NE.html#cb205-7" tabindex="-1"></a><span class="co"># D=4 as a benchmark </span></span>
<span id="cb205-8"><a href="NE.html#cb205-8" tabindex="-1"></a><span class="co"># list of tau for d=3 and dprime=4 and tauprime=1</span></span>
<span id="cb205-9"><a href="NE.html#cb205-9" tabindex="-1"></a>tau.<span class="fl">3.4</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>)</span>
<span id="cb205-10"><a href="NE.html#cb205-10" tabindex="-1"></a>DID.<span class="dv">3</span>.<span class="fl">4.1</span> <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(tau.<span class="fl">3.4</span>,StaggeredDID22,<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">d=</span><span class="dv">3</span>,<span class="at">dprime=</span><span class="dv">4</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">data=</span>data) </span>
<span id="cb205-11"><a href="NE.html#cb205-11" tabindex="-1"></a></span>
<span id="cb205-12"><a href="NE.html#cb205-12" tabindex="-1"></a><span class="co"># regroup results</span></span>
<span id="cb205-13"><a href="NE.html#cb205-13" tabindex="-1"></a>DID.<span class="fl">3.1</span> <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.<span class="dv">3</span>.<span class="fl">99.1</span>,DID.<span class="dv">3</span>.<span class="fl">4.1</span>)</span>
<span id="cb205-14"><a href="NE.html#cb205-14" tabindex="-1"></a></span>
<span id="cb205-15"><a href="NE.html#cb205-15" tabindex="-1"></a><span class="co"># true effects (in the sample)</span></span>
<span id="cb205-16"><a href="NE.html#cb205-16" tabindex="-1"></a>ATT.<span class="fl">3.0</span> <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>y1[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">3</span>])<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>y0[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">3</span>])</span>
<span id="cb205-17"><a href="NE.html#cb205-17" tabindex="-1"></a>ATT.<span class="fl">3.1</span> <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>y1[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">4</span>])<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>y0[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">4</span>])</span>
<span id="cb205-18"><a href="NE.html#cb205-18" tabindex="-1"></a></span>
<span id="cb205-19"><a href="NE.html#cb205-19" tabindex="-1"></a><span class="co"># do the DID22 estimates for d=4</span></span>
<span id="cb205-20"><a href="NE.html#cb205-20" tabindex="-1"></a><span class="co"># Run the regression and keep results</span></span>
<span id="cb205-21"><a href="NE.html#cb205-21" tabindex="-1"></a><span class="co"># D=99 as benchmark</span></span>
<span id="cb205-22"><a href="NE.html#cb205-22" tabindex="-1"></a><span class="co"># list of tau for d=4 and dprime=99 and tauprime=1</span></span>
<span id="cb205-23"><a href="NE.html#cb205-23" tabindex="-1"></a>tau.<span class="fl">4.99</span> <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>)</span>
<span id="cb205-24"><a href="NE.html#cb205-24" tabindex="-1"></a>DID.<span class="dv">4</span>.<span class="fl">99.1</span> <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(tau.<span class="fl">4.99</span>,StaggeredDID22,<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">d=</span><span class="dv">4</span>,<span class="at">dprime=</span><span class="dv">99</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">data=</span>data) </span>
<span id="cb205-25"><a href="NE.html#cb205-25" tabindex="-1"></a></span>
<span id="cb205-26"><a href="NE.html#cb205-26" tabindex="-1"></a><span class="co"># true effects (in the sample)</span></span>
<span id="cb205-27"><a href="NE.html#cb205-27" tabindex="-1"></a>ATT.<span class="fl">4.0</span> <span class="ot">&lt;-</span> <span class="fu">mean</span>(data<span class="sc">$</span>y1[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">4</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">4</span>])<span class="sc">-</span><span class="fu">mean</span>(data<span class="sc">$</span>y0[data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">4</span> <span class="sc">&amp;</span> data<span class="sc">$</span>time<span class="sc">==</span><span class="dv">4</span>])</span>
<span id="cb205-28"><a href="NE.html#cb205-28" tabindex="-1"></a></span>
<span id="cb205-29"><a href="NE.html#cb205-29" tabindex="-1"></a><span class="co"># regrouping all effects</span></span>
<span id="cb205-30"><a href="NE.html#cb205-30" tabindex="-1"></a>DID<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.<span class="fl">2.1</span>,DID.<span class="fl">3.1</span>,DID.<span class="dv">4</span>.<span class="fl">99.1</span>)</span>
<span id="cb205-31"><a href="NE.html#cb205-31" tabindex="-1"></a></span>
<span id="cb205-32"><a href="NE.html#cb205-32" tabindex="-1"></a><span class="co"># computing the weights</span></span>
<span id="cb205-33"><a href="NE.html#cb205-33" tabindex="-1"></a>prop.groups.DID <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb205-34"><a href="NE.html#cb205-34" tabindex="-1"></a>                    <span class="fu">filter</span>(time<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb205-35"><a href="NE.html#cb205-35" tabindex="-1"></a>                    <span class="fu">group_by</span>(Ds) <span class="sc">%&gt;%</span></span>
<span id="cb205-36"><a href="NE.html#cb205-36" tabindex="-1"></a>                    <span class="fu">summarize</span>(</span>
<span id="cb205-37"><a href="NE.html#cb205-37" tabindex="-1"></a>                      <span class="at">prop.group =</span> <span class="fu">n</span>()<span class="sc">/</span>N</span>
<span id="cb205-38"><a href="NE.html#cb205-38" tabindex="-1"></a>                    ) <span class="sc">%&gt;%</span></span>
<span id="cb205-39"><a href="NE.html#cb205-39" tabindex="-1"></a>                    <span class="fu">rename</span>(</span>
<span id="cb205-40"><a href="NE.html#cb205-40" tabindex="-1"></a>                      <span class="at">dprime=</span>Ds</span>
<span id="cb205-41"><a href="NE.html#cb205-41" tabindex="-1"></a>                    )<span class="sc">%&gt;%</span></span>
<span id="cb205-42"><a href="NE.html#cb205-42" tabindex="-1"></a>                    <span class="fu">mutate</span>(</span>
<span id="cb205-43"><a href="NE.html#cb205-43" tabindex="-1"></a>                      <span class="at">dprime=</span><span class="fu">factor</span>(dprime,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;99&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;1&quot;</span>))</span>
<span id="cb205-44"><a href="NE.html#cb205-44" tabindex="-1"></a>                    )</span>
<span id="cb205-45"><a href="NE.html#cb205-45" tabindex="-1"></a></span>
<span id="cb205-46"><a href="NE.html#cb205-46" tabindex="-1"></a><span class="co"># joining the weights to the results</span></span>
<span id="cb205-47"><a href="NE.html#cb205-47" tabindex="-1"></a>DID<span class="fl">.1</span> <span class="ot">&lt;-</span> DID<span class="fl">.1</span> <span class="sc">%&gt;%</span></span>
<span id="cb205-48"><a href="NE.html#cb205-48" tabindex="-1"></a>          <span class="fu">left_join</span>(prop.groups.DID,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;dprime&quot;</span>))</span>
<span id="cb205-49"><a href="NE.html#cb205-49" tabindex="-1"></a></span>
<span id="cb205-50"><a href="NE.html#cb205-50" tabindex="-1"></a><span class="co"># generating the weighted averages by tau </span></span>
<span id="cb205-51"><a href="NE.html#cb205-51" tabindex="-1"></a>DID.tau <span class="ot">&lt;-</span> DID<span class="fl">.1</span> <span class="sc">%&gt;%</span></span>
<span id="cb205-52"><a href="NE.html#cb205-52" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb205-53"><a href="NE.html#cb205-53" tabindex="-1"></a>              <span class="at">w.ATT =</span> prop.group<span class="sc">*</span>DIDest</span>
<span id="cb205-54"><a href="NE.html#cb205-54" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb205-55"><a href="NE.html#cb205-55" tabindex="-1"></a>            <span class="fu">group_by</span>(tau,d) <span class="sc">%&gt;%</span></span>
<span id="cb205-56"><a href="NE.html#cb205-56" tabindex="-1"></a>            <span class="fu">summarize</span>(</span>
<span id="cb205-57"><a href="NE.html#cb205-57" tabindex="-1"></a>              <span class="at">sum.w.ATT =</span> <span class="fu">sum</span>(w.ATT),</span>
<span id="cb205-58"><a href="NE.html#cb205-58" tabindex="-1"></a>              <span class="at">sum.w =</span> <span class="fu">sum</span>(prop.group)</span>
<span id="cb205-59"><a href="NE.html#cb205-59" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb205-60"><a href="NE.html#cb205-60" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb205-61"><a href="NE.html#cb205-61" tabindex="-1"></a>              <span class="at">ATT.tau =</span> sum.w.ATT<span class="sc">/</span>sum.w</span>
<span id="cb205-62"><a href="NE.html#cb205-62" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb205-63"><a href="NE.html#cb205-63" tabindex="-1"></a>            <span class="fu">select</span>(d,tau,ATT.tau) <span class="sc">%&gt;%</span></span>
<span id="cb205-64"><a href="NE.html#cb205-64" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb205-65"><a href="NE.html#cb205-65" tabindex="-1"></a>              <span class="at">d=</span><span class="fu">factor</span>(d,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;2&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;4&quot;</span>))</span>
<span id="cb205-66"><a href="NE.html#cb205-66" tabindex="-1"></a>            ) </span>
<span id="cb205-67"><a href="NE.html#cb205-67" tabindex="-1"></a></span>
<span id="cb205-68"><a href="NE.html#cb205-68" tabindex="-1"></a><span class="co"># adding the reference period</span></span>
<span id="cb205-69"><a href="NE.html#cb205-69" tabindex="-1"></a>DID.ref <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">3</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">4</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>)))</span>
<span id="cb205-70"><a href="NE.html#cb205-70" tabindex="-1"></a><span class="fu">colnames</span>(DID.ref) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(DID.tau)</span>
<span id="cb205-71"><a href="NE.html#cb205-71" tabindex="-1"></a>DID.ref<span class="sc">$</span>d <span class="ot">&lt;-</span> <span class="fu">factor</span>(DID.ref<span class="sc">$</span>d,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;2&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;4&quot;</span>))</span>
<span id="cb205-72"><a href="NE.html#cb205-72" tabindex="-1"></a></span>
<span id="cb205-73"><a href="NE.html#cb205-73" tabindex="-1"></a>DID.tau <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.tau,DID.ref)</span></code></pre></div>
<p>Let us now plot the results for the DID estimates in groups <span class="math inline">\(2\)</span>, <span class="math inline">\(3\)</span> and <span class="math inline">\(4\)</span> using <span class="math inline">\(\tau&#39;=1\)</span> as a benchmark pre-treatment period and aggregating the estimates using every possible valid control group:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="NE.html#cb206-1" tabindex="-1"></a><span class="fu">ggplot</span>(DID.tau,<span class="fu">aes</span>(<span class="at">x=</span>tau,<span class="at">y=</span>ATT.tau,<span class="at">colour=</span>d,<span class="at">linetype=</span>d))<span class="sc">+</span></span>
<span id="cb206-2"><a href="NE.html#cb206-2" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb206-3"><a href="NE.html#cb206-3" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb206-4"><a href="NE.html#cb206-4" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb206-5"><a href="NE.html#cb206-5" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time after treatment (tau)&quot;</span>) <span class="sc">+</span></span>
<span id="cb206-6"><a href="NE.html#cb206-6" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb206-7"><a href="NE.html#cb206-7" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb206-8"><a href="NE.html#cb206-8" tabindex="-1"></a>    <span class="fu">scale_colour_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb206-9"><a href="NE.html#cb206-9" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb206-10"><a href="NE.html#cb206-10" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredGroups"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredGroups-1.png" alt="DID estimates for all groups at various time periods after the treament aggregated across all comparison groups and with the reference period $\tau'=1$" width="50%" />
<p class="caption">
Figure 4.28: DID estimates for all groups at various time periods after the treament aggregated across all comparison groups and with the reference period <span class="math inline">\(\tau&#39;=1\)</span>
</p>
</div>
<p>On Figure <a href="NE.html#fig:PlotDIDStaggeredGroups">4.28</a>, we can see that all the estimators are comparable for each other at each time period <span class="math inline">\(\tau\)</span>, no matter the treatment group.
We thus can aggregate the impacts at each period <span class="math inline">\(\tau\)</span> across all treatment groups.
There are two ways to do that: one is to use all the groups for which we observe the effect of the treatment at period <span class="math inline">\(\tau\)</span>.
The drawback of this approach is that group composition changes with <span class="math inline">\(\tau\)</span>.
For example, on Figure <a href="NE.html#fig:PlotDIDStaggeredGroups">4.28</a>, we can see that the treatment group treated in the last period (for which <span class="math inline">\(D_i=4\)</span>) contributes only to the computation of the effect of the treatment at period <span class="math inline">\(\tau=0\)</span>.
This is because we cannot observe what happens to this group in later periods with our dataset.
As a consequence, in period <span class="math inline">\(\tau=0\)</span>, all three groups–<span class="math inline">\(D_i=2\)</span>, <span class="math inline">\(D_i=3\)</span> and <span class="math inline">\(D_i=4\)</span>–contribute to the estimation of the effect of the treatment, whereas only groups with <span class="math inline">\(D_i=2\)</span> and <span class="math inline">\(D_i=3\)</span> contribute to the estimation of the effect at <span class="math inline">\(\tau=1\)</span>, and only <span class="math inline">\(D_i=2\)</span> contributes to estimating the effect at <span class="math inline">\(\tau=2\)</span>.
If treatment effects were heterogeneous across treatment groups, this change in group composition would confound actual changes in the magnitude of treatment effects.
Since the effect of the treatment is rather homogenous across groups, this group comopsition problem will not matter in our application.
Nevertheless, we are still going to estimate the effect of the treatment at <span class="math inline">\(\tau=0\)</span> and <span class="math inline">\(\tau=1\)</span> maintaining group composition constant (<span class="math inline">\(D_i=2\)</span> and <span class="math inline">\(D_i=3\)</span>).
In our application, both approaches will yield very similar results.
The weights we are going to use for our aggregation are the proportions of units belonging to each group.</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="NE.html#cb207-1" tabindex="-1"></a><span class="co"># joining the weights to the results</span></span>
<span id="cb207-2"><a href="NE.html#cb207-2" tabindex="-1"></a>DID.tau <span class="ot">&lt;-</span> DID.tau <span class="sc">%&gt;%</span></span>
<span id="cb207-3"><a href="NE.html#cb207-3" tabindex="-1"></a>          <span class="fu">left_join</span>(prop.groups.DID,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;d&quot;</span><span class="ot">=</span><span class="st">&quot;dprime&quot;</span>))</span>
<span id="cb207-4"><a href="NE.html#cb207-4" tabindex="-1"></a></span>
<span id="cb207-5"><a href="NE.html#cb207-5" tabindex="-1"></a><span class="co"># generating the weighted averages by tau (varying group composition)</span></span>
<span id="cb207-6"><a href="NE.html#cb207-6" tabindex="-1"></a>DID.tau.agg <span class="ot">&lt;-</span> DID.tau <span class="sc">%&gt;%</span></span>
<span id="cb207-7"><a href="NE.html#cb207-7" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb207-8"><a href="NE.html#cb207-8" tabindex="-1"></a>              <span class="at">w.ATT =</span> prop.group<span class="sc">*</span>ATT.tau</span>
<span id="cb207-9"><a href="NE.html#cb207-9" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb207-10"><a href="NE.html#cb207-10" tabindex="-1"></a>            <span class="fu">group_by</span>(tau) <span class="sc">%&gt;%</span></span>
<span id="cb207-11"><a href="NE.html#cb207-11" tabindex="-1"></a>            <span class="fu">summarize</span>(</span>
<span id="cb207-12"><a href="NE.html#cb207-12" tabindex="-1"></a>              <span class="at">sum.w.ATT =</span> <span class="fu">sum</span>(w.ATT),</span>
<span id="cb207-13"><a href="NE.html#cb207-13" tabindex="-1"></a>              <span class="at">sum.w =</span> <span class="fu">sum</span>(prop.group)</span>
<span id="cb207-14"><a href="NE.html#cb207-14" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-15"><a href="NE.html#cb207-15" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb207-16"><a href="NE.html#cb207-16" tabindex="-1"></a>              <span class="at">ATT.tau.agg =</span> sum.w.ATT<span class="sc">/</span>sum.w</span>
<span id="cb207-17"><a href="NE.html#cb207-17" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb207-18"><a href="NE.html#cb207-18" tabindex="-1"></a>            <span class="fu">select</span>(tau,ATT.tau.agg) <span class="sc">%&gt;%</span></span>
<span id="cb207-19"><a href="NE.html#cb207-19" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb207-20"><a href="NE.html#cb207-20" tabindex="-1"></a>              <span class="at">Composition=</span><span class="st">&quot;Varying&quot;</span></span>
<span id="cb207-21"><a href="NE.html#cb207-21" tabindex="-1"></a>            )</span>
<span id="cb207-22"><a href="NE.html#cb207-22" tabindex="-1"></a></span>
<span id="cb207-23"><a href="NE.html#cb207-23" tabindex="-1"></a><span class="co"># generating the weighted averages by tau (constant group composition)</span></span>
<span id="cb207-24"><a href="NE.html#cb207-24" tabindex="-1"></a>DID.tau.agg.cst <span class="ot">&lt;-</span> DID.tau <span class="sc">%&gt;%</span></span>
<span id="cb207-25"><a href="NE.html#cb207-25" tabindex="-1"></a>            <span class="fu">filter</span>(d<span class="sc">==</span><span class="dv">2</span> <span class="sc">|</span> d<span class="sc">==</span><span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb207-26"><a href="NE.html#cb207-26" tabindex="-1"></a>            <span class="fu">filter</span>(tau<span class="sc">==</span><span class="dv">0</span> <span class="sc">|</span> tau<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb207-27"><a href="NE.html#cb207-27" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb207-28"><a href="NE.html#cb207-28" tabindex="-1"></a>              <span class="at">w.ATT =</span> prop.group<span class="sc">*</span>ATT.tau</span>
<span id="cb207-29"><a href="NE.html#cb207-29" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb207-30"><a href="NE.html#cb207-30" tabindex="-1"></a>            <span class="fu">group_by</span>(tau) <span class="sc">%&gt;%</span></span>
<span id="cb207-31"><a href="NE.html#cb207-31" tabindex="-1"></a>            <span class="fu">summarize</span>(</span>
<span id="cb207-32"><a href="NE.html#cb207-32" tabindex="-1"></a>              <span class="at">sum.w.ATT =</span> <span class="fu">sum</span>(w.ATT),</span>
<span id="cb207-33"><a href="NE.html#cb207-33" tabindex="-1"></a>              <span class="at">sum.w =</span> <span class="fu">sum</span>(prop.group)</span>
<span id="cb207-34"><a href="NE.html#cb207-34" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb207-35"><a href="NE.html#cb207-35" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb207-36"><a href="NE.html#cb207-36" tabindex="-1"></a>              <span class="at">ATT.tau.agg =</span> sum.w.ATT<span class="sc">/</span>sum.w</span>
<span id="cb207-37"><a href="NE.html#cb207-37" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb207-38"><a href="NE.html#cb207-38" tabindex="-1"></a>            <span class="fu">select</span>(tau,ATT.tau.agg) <span class="sc">%&gt;%</span></span>
<span id="cb207-39"><a href="NE.html#cb207-39" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb207-40"><a href="NE.html#cb207-40" tabindex="-1"></a>              <span class="at">Composition=</span><span class="st">&quot;Constant&quot;</span></span>
<span id="cb207-41"><a href="NE.html#cb207-41" tabindex="-1"></a>            )</span>
<span id="cb207-42"><a href="NE.html#cb207-42" tabindex="-1"></a></span>
<span id="cb207-43"><a href="NE.html#cb207-43" tabindex="-1"></a><span class="co">#regrouping estimates</span></span>
<span id="cb207-44"><a href="NE.html#cb207-44" tabindex="-1"></a>DID.tau.agg.tot <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.tau.agg,DID.tau.agg.cst) <span class="sc">%&gt;%</span></span>
<span id="cb207-45"><a href="NE.html#cb207-45" tabindex="-1"></a>                    <span class="fu">mutate</span>(</span>
<span id="cb207-46"><a href="NE.html#cb207-46" tabindex="-1"></a>                      <span class="at">Composition =</span> <span class="fu">factor</span>(Composition,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Constant&quot;</span>,<span class="st">&quot;Varying&quot;</span>))</span>
<span id="cb207-47"><a href="NE.html#cb207-47" tabindex="-1"></a>                    )</span></code></pre></div>
<p>Let’s plot the resulting estimates.</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="NE.html#cb208-1" tabindex="-1"></a><span class="fu">ggplot</span>(DID.tau.agg.tot,<span class="fu">aes</span>(<span class="at">x=</span>tau,<span class="at">y=</span>ATT.tau.agg,<span class="at">colour=</span>Composition,<span class="at">linetype=</span>Composition))<span class="sc">+</span></span>
<span id="cb208-2"><a href="NE.html#cb208-2" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb208-3"><a href="NE.html#cb208-3" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb208-4"><a href="NE.html#cb208-4" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb208-5"><a href="NE.html#cb208-5" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time after treatment (tau)&quot;</span>) <span class="sc">+</span></span>
<span id="cb208-6"><a href="NE.html#cb208-6" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb208-7"><a href="NE.html#cb208-7" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb208-8"><a href="NE.html#cb208-8" tabindex="-1"></a>    <span class="fu">scale_colour_discrete</span>(<span class="at">name=</span><span class="st">&quot;Group</span><span class="sc">\n</span><span class="st">composition&quot;</span>)<span class="sc">+</span></span>
<span id="cb208-9"><a href="NE.html#cb208-9" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">name=</span><span class="st">&quot;Group</span><span class="sc">\n</span><span class="st">composition&quot;</span>)<span class="sc">+</span></span>
<span id="cb208-10"><a href="NE.html#cb208-10" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredAgg"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredAgg-1.png" alt="DID estimates at various time periods after the treament aggregated across all treatment groups and maintaining treatment group composition constant (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.29: DID estimates at various time periods after the treament aggregated across all treatment groups and maintaining treatment group composition constant (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>As expected, Figure <a href="NE.html#fig:PlotDIDStaggeredAgg">4.29</a> confirms that group composition does not play an important role in treatment effect heterogeneity: there actually is a true heterogeneity along the time dimension: the treatment effect seems to increase linearly over time (as we suspected it would, since we parameterized our model just like it).</p>
<p>Another plot that might prove very helpful is the one combining the aggregated estimates obtained in Figure <a href="NE.html#fig:PlotDIDStaggeredAgg">4.29</a> with the estimates obtained on each subgroup.
This plot helps understand the source of heterogeneity in the profile of the aggregated treatment effects by attributing it to true treatment effect heterogeneity or to changes in group composition.
Let’s go:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="NE.html#cb209-1" tabindex="-1"></a><span class="co"># building the dataset</span></span>
<span id="cb209-2"><a href="NE.html#cb209-2" tabindex="-1"></a>DID.tau.agg.tot.inter <span class="ot">&lt;-</span> DID.tau.agg.tot <span class="sc">%&gt;%</span></span>
<span id="cb209-3"><a href="NE.html#cb209-3" tabindex="-1"></a>                    <span class="fu">filter</span>(Composition<span class="sc">==</span><span class="st">&quot;Varying&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb209-4"><a href="NE.html#cb209-4" tabindex="-1"></a>                    <span class="fu">select</span>(tau,ATT.tau.agg) <span class="sc">%&gt;%</span></span>
<span id="cb209-5"><a href="NE.html#cb209-5" tabindex="-1"></a>                    <span class="fu">rename</span>(</span>
<span id="cb209-6"><a href="NE.html#cb209-6" tabindex="-1"></a>                      <span class="at">ATT.tau=</span>ATT.tau.agg</span>
<span id="cb209-7"><a href="NE.html#cb209-7" tabindex="-1"></a>                    ) <span class="sc">%&gt;%</span></span>
<span id="cb209-8"><a href="NE.html#cb209-8" tabindex="-1"></a>                    <span class="fu">mutate</span>(</span>
<span id="cb209-9"><a href="NE.html#cb209-9" tabindex="-1"></a>                      <span class="at">d =</span> <span class="st">&quot;Aggregate&quot;</span>,</span>
<span id="cb209-10"><a href="NE.html#cb209-10" tabindex="-1"></a>                      <span class="at">prop.group=</span><span class="dv">0</span></span>
<span id="cb209-11"><a href="NE.html#cb209-11" tabindex="-1"></a>                    )</span>
<span id="cb209-12"><a href="NE.html#cb209-12" tabindex="-1"></a></span>
<span id="cb209-13"><a href="NE.html#cb209-13" tabindex="-1"></a>DID.tau <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.tau,DID.tau.agg.tot.inter) <span class="sc">%&gt;%</span></span>
<span id="cb209-14"><a href="NE.html#cb209-14" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb209-15"><a href="NE.html#cb209-15" tabindex="-1"></a>              <span class="at">d=</span><span class="fu">factor</span>(d,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;2&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;Aggregate&quot;</span>))</span>
<span id="cb209-16"><a href="NE.html#cb209-16" tabindex="-1"></a>            )</span>
<span id="cb209-17"><a href="NE.html#cb209-17" tabindex="-1"></a></span>
<span id="cb209-18"><a href="NE.html#cb209-18" tabindex="-1"></a><span class="co"># plotting the result</span></span>
<span id="cb209-19"><a href="NE.html#cb209-19" tabindex="-1"></a><span class="fu">ggplot</span>(DID.tau,<span class="fu">aes</span>(<span class="at">x=</span>tau,<span class="at">y=</span>ATT.tau,<span class="at">colour=</span>d,<span class="at">linetype=</span>d))<span class="sc">+</span></span>
<span id="cb209-20"><a href="NE.html#cb209-20" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb209-21"><a href="NE.html#cb209-21" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb209-22"><a href="NE.html#cb209-22" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb209-23"><a href="NE.html#cb209-23" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time after treatment (tau)&quot;</span>) <span class="sc">+</span></span>
<span id="cb209-24"><a href="NE.html#cb209-24" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb209-25"><a href="NE.html#cb209-25" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb209-26"><a href="NE.html#cb209-26" tabindex="-1"></a>    <span class="fu">scale_colour_discrete</span>(<span class="at">name=</span><span class="st">&quot;Group</span><span class="sc">\n</span><span class="st">composition&quot;</span>)<span class="sc">+</span></span>
<span id="cb209-27"><a href="NE.html#cb209-27" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">name=</span><span class="st">&quot;Group</span><span class="sc">\n</span><span class="st">composition&quot;</span>)<span class="sc">+</span></span>
<span id="cb209-28"><a href="NE.html#cb209-28" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredAll"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredAll-1.png" alt="DID estimates at various time periods after the treament aggregated across all treatment groups (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.30: DID estimates at various time periods after the treament aggregated across all treatment groups (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Finally, let us aggregate all treatment effects from all periods into one unique estimate.
It is not an easy feat, especially in our current example which exhibits lots of treatment effect heterogeneity over <span class="math inline">\(\tau\)</span>.
Should we simply aggregate all treatment effect estimates using equal weights for each period <span class="math inline">\(\tau\)</span> or, rather, should we try to reflect the actual composition of treated groups and time periods in the sample?
The choice of the mode of aggregation might make a huge difference to the eventual result, since giving more weights to higher <span class="math inline">\(\tau\)</span> will result in a much higher overall treatment effect.
Let’s see what happens with both approaches.</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="NE.html#cb210-1" tabindex="-1"></a><span class="co"># aggregating by weighing equally each time period tau</span></span>
<span id="cb210-2"><a href="NE.html#cb210-2" tabindex="-1"></a>ATT.equal <span class="ot">&lt;-</span> DID.tau.agg.tot <span class="sc">%&gt;%</span></span>
<span id="cb210-3"><a href="NE.html#cb210-3" tabindex="-1"></a>                <span class="fu">filter</span>(Composition<span class="sc">==</span><span class="st">&quot;Varying&quot;</span>,tau<span class="sc">&gt;=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb210-4"><a href="NE.html#cb210-4" tabindex="-1"></a>                <span class="fu">summarize</span>(</span>
<span id="cb210-5"><a href="NE.html#cb210-5" tabindex="-1"></a>                  <span class="at">ATT.equal =</span> <span class="fu">mean</span>(ATT.tau.agg)</span>
<span id="cb210-6"><a href="NE.html#cb210-6" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb210-7"><a href="NE.html#cb210-7" tabindex="-1"></a>                <span class="fu">pull</span>(ATT.equal)</span>
<span id="cb210-8"><a href="NE.html#cb210-8" tabindex="-1"></a></span>
<span id="cb210-9"><a href="NE.html#cb210-9" tabindex="-1"></a><span class="co"># aggregating by weighing as a proportion of time spent by each group in the treatment state </span></span>
<span id="cb210-10"><a href="NE.html#cb210-10" tabindex="-1"></a>ATT.varying <span class="ot">&lt;-</span> DID.tau <span class="sc">%&gt;%</span></span>
<span id="cb210-11"><a href="NE.html#cb210-11" tabindex="-1"></a>            <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb210-12"><a href="NE.html#cb210-12" tabindex="-1"></a>            <span class="fu">filter</span>(d<span class="sc">!=</span><span class="st">&quot;Aggregate&quot;</span>,tau<span class="sc">&gt;=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb210-13"><a href="NE.html#cb210-13" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb210-14"><a href="NE.html#cb210-14" tabindex="-1"></a>              <span class="at">w.ATT =</span> prop.group<span class="sc">*</span>ATT.tau</span>
<span id="cb210-15"><a href="NE.html#cb210-15" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb210-16"><a href="NE.html#cb210-16" tabindex="-1"></a>            <span class="fu">summarize</span>(</span>
<span id="cb210-17"><a href="NE.html#cb210-17" tabindex="-1"></a>              <span class="at">sum.w.ATT =</span> <span class="fu">sum</span>(w.ATT),</span>
<span id="cb210-18"><a href="NE.html#cb210-18" tabindex="-1"></a>              <span class="at">sum.w =</span> <span class="fu">sum</span>(prop.group)</span>
<span id="cb210-19"><a href="NE.html#cb210-19" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span> </span>
<span id="cb210-20"><a href="NE.html#cb210-20" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb210-21"><a href="NE.html#cb210-21" tabindex="-1"></a>              <span class="at">ATT.varying =</span> sum.w.ATT<span class="sc">/</span>sum.w</span>
<span id="cb210-22"><a href="NE.html#cb210-22" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb210-23"><a href="NE.html#cb210-23" tabindex="-1"></a>            <span class="fu">pull</span>(ATT.varying)</span></code></pre></div>
<p>The average effect of the treatment, giving equal weight to each time period <span class="math inline">\(\tau\in\{0,1,2\}\)</span>, is equal to <span class="math inline">\(\hat\Delta^{Y}_{TT}(e)=\)</span> 1.59, where <span class="math inline">\(e\)</span> stands for “equal” weights.
The average effect of the treatment, giving weights proportional to group composition and time spent in the treatment is equal to <span class="math inline">\(\hat\Delta^{Y}_{TT}(v)=\)</span> 1.06, where <span class="math inline">\(v\)</span> stands for “varying” weights.</p>
</div>
<div id="direct-weighting-using-one-reference-period-and-one-reference-group-sun-and-abraham" class="section level5 hasAnchor" number="4.3.3.2.2">
<h5><span class="header-section-number">4.3.3.2.2</span> Direct weighting using one reference period and one reference group (Sun and Abraham)<a href="NE.html#direct-weighting-using-one-reference-period-and-one-reference-group-sun-and-abraham" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>OK, so now, we know how to compute the various DID estimators by hand and how to aggregate them.
Is there a way to obtain directly an aggregated estimate with an R package?
Yes, actually, plenty of such estimator exist.
They are listed on <a href="https://asjadnaqvi.github.io/DiD/docs/02_R/">Asjad Naqvi’s DID webpage</a>.
Let’s start with the ones implementing the <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">Sun and Abraham (2021)</a> estimator.
<a href="https://doi.org/10.1016/j.jeconom.2020.09.006">Sun and Abraham (2021)</a>’s estimator start with estimating a Two Way Fixed Effect model with a rich dynamic specification:</p>
<p><span class="math display">\[\begin{align*}
    Y_{i,t} &amp;  = \mu_i + \delta_t + \sum_{d=2}^T\sum_{\tau\neq-1}\beta_{d,\tau}^{SA}\uns{D_{i}=d \land t=d+\tau}  + \epsilon^{SA}_{i,t},
\end{align*}\]</span></p>
<p>on the sample excluding the always treated individuals (<span class="math inline">\(D_i=1\)</span>).
In order to be consistent with previous estimators, we are going to start using the <code>fixest</code> package to obtain our estimator.
In order to be able to estimate <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">Sun and Abraham (2021)</a>’s estimator with <code>fixest</code>, we simply are going to add a <code>sunab(d,t)</code> term to the <code>feols</code> command, with the first term giving the treatment group and the second term the time fixed effect.
We then can aggregate the estimated terms using <code>regexp</code> in order to detect the string patterns.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-232" class="example"><strong>Example 4.43  </strong></span>Let’s go:</p>
</div>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="NE.html#cb211-1" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb211-2"><a href="NE.html#cb211-2" tabindex="-1"></a>reg.fixest.SA.Agg <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> <span class="fu">sunab</span>(Ds,time)<span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">&gt;</span><span class="dv">1</span>))</span>
<span id="cb211-3"><a href="NE.html#cb211-3" tabindex="-1"></a></span>
<span id="cb211-4"><a href="NE.html#cb211-4" tabindex="-1"></a><span class="co"># aggregate estimate (this is a command specific to fixest that aggregates various coefficients where an i. specification was used)</span></span>
<span id="cb211-5"><a href="NE.html#cb211-5" tabindex="-1"></a><span class="co"># The selection of coefficients to aggregate uses a string detection pattern language</span></span>
<span id="cb211-6"><a href="NE.html#cb211-6" tabindex="-1"></a><span class="co"># varying composition</span></span>
<span id="cb211-7"><a href="NE.html#cb211-7" tabindex="-1"></a>aggregate.SA.varying <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(reg.fixest.SA.Agg, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span> <span class="ot">=</span> <span class="st">&quot;time::([[:digit:]]+)&quot;</span>))</span>
<span id="cb211-8"><a href="NE.html#cb211-8" tabindex="-1"></a></span>
<span id="cb211-9"><a href="NE.html#cb211-9" tabindex="-1"></a><span class="co"># another approach using the i function: not run, but works</span></span>
<span id="cb211-10"><a href="NE.html#cb211-10" tabindex="-1"></a><span class="co"># creating a time to treatment variable:</span></span>
<span id="cb211-11"><a href="NE.html#cb211-11" tabindex="-1"></a><span class="co"># data &lt;- data %&gt;%</span></span>
<span id="cb211-12"><a href="NE.html#cb211-12" tabindex="-1"></a><span class="co">#           mutate(</span></span>
<span id="cb211-13"><a href="NE.html#cb211-13" tabindex="-1"></a><span class="co">#             tau=time-Ds</span></span>
<span id="cb211-14"><a href="NE.html#cb211-14" tabindex="-1"></a><span class="co">#           ) %&gt;%</span></span>
<span id="cb211-15"><a href="NE.html#cb211-15" tabindex="-1"></a><span class="co">#           mutate( </span></span>
<span id="cb211-16"><a href="NE.html#cb211-16" tabindex="-1"></a><span class="co">#             tau = replace(tau,tau&lt;=-90,-99)</span></span>
<span id="cb211-17"><a href="NE.html#cb211-17" tabindex="-1"></a><span class="co">#           )</span></span>
<span id="cb211-18"><a href="NE.html#cb211-18" tabindex="-1"></a></span>
<span id="cb211-19"><a href="NE.html#cb211-19" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb211-20"><a href="NE.html#cb211-20" tabindex="-1"></a><span class="co"># reg.fixest.SA.nonAgg &lt;- feols(y ~ i(tau,i.Ds,ref=c(-1,-99))| id + time, data=filter(data,Ds&gt;1))</span></span>
<span id="cb211-21"><a href="NE.html#cb211-21" tabindex="-1"></a><span class="co"># aggregate estimate (this is a command specific to fixest that aggregates various coefficients where an i. specification was used)</span></span>
<span id="cb211-22"><a href="NE.html#cb211-22" tabindex="-1"></a><span class="co"># The selection of coefficients to aggregate uses a string detection pattern language</span></span>
<span id="cb211-23"><a href="NE.html#cb211-23" tabindex="-1"></a><span class="co"># varying composition</span></span>
<span id="cb211-24"><a href="NE.html#cb211-24" tabindex="-1"></a><span class="co"># aggregate.SA.nonAgg.varying &lt;- aggregate(reg.fixest.SA.nonAgg, c(&quot;tau&quot; = &quot;tau::([[:digit:]]+)&quot;))</span></span></code></pre></div>
<p>Let’s plot the results:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="NE.html#cb212-1" tabindex="-1"></a><span class="co"># preparation</span></span>
<span id="cb212-2"><a href="NE.html#cb212-2" tabindex="-1"></a><span class="fu">colnames</span>(aggregate.SA.varying) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ATT&quot;</span>,<span class="st">&quot;Se&quot;</span>,<span class="st">&quot;t&quot;</span>,<span class="st">&quot;pval&quot;</span>)</span>
<span id="cb212-3"><a href="NE.html#cb212-3" tabindex="-1"></a>aggregate.SA.varying <span class="ot">&lt;-</span> aggregate.SA.varying <span class="sc">%&gt;%</span></span>
<span id="cb212-4"><a href="NE.html#cb212-4" tabindex="-1"></a>                  <span class="fu">as.data.frame</span>(.)  <span class="sc">%&gt;%</span></span>
<span id="cb212-5"><a href="NE.html#cb212-5" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">tau =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>) </span>
<span id="cb212-6"><a href="NE.html#cb212-6" tabindex="-1"></a></span>
<span id="cb212-7"><a href="NE.html#cb212-7" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb212-8"><a href="NE.html#cb212-8" tabindex="-1"></a><span class="fu">ggplot</span>(aggregate.SA.varying,<span class="fu">aes</span>(<span class="at">x=</span>tau,<span class="at">y=</span>ATT))<span class="sc">+</span></span>
<span id="cb212-9"><a href="NE.html#cb212-9" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb212-10"><a href="NE.html#cb212-10" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>ATT<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>ATT<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb212-11"><a href="NE.html#cb212-11" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb212-12"><a href="NE.html#cb212-12" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time after treatment (tau)&quot;</span>) <span class="sc">+</span></span>
<span id="cb212-13"><a href="NE.html#cb212-13" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb212-14"><a href="NE.html#cb212-14" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb212-15"><a href="NE.html#cb212-15" tabindex="-1"></a>    <span class="fu">scale_colour_discrete</span>(<span class="at">name=</span><span class="st">&quot;Group</span><span class="sc">\n</span><span class="st">composition&quot;</span>)<span class="sc">+</span></span>
<span id="cb212-16"><a href="NE.html#cb212-16" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">name=</span><span class="st">&quot;Group</span><span class="sc">\n</span><span class="st">composition&quot;</span>)<span class="sc">+</span></span>
<span id="cb212-17"><a href="NE.html#cb212-17" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredAggSA"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredAggSA-1.png" alt="DID estimates at various time periods after the treament using Sun and Abraham's estimator implemented by fixest (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.31: DID estimates at various time periods after the treament using Sun and Abraham’s estimator implemented by fixest (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Again, as we have seen before, the change in group composition makes it look like there is a trend break in the treatment effect.
What we would need is to aggregate treatment effects with a constant group composition.
One way to do that would be to use the full disaggregated results of the Sun and Abraham decomposition and to reaggregate them in another way.
In order to access the disaggregated results of the Sun and Abraham regression, we need to use the option <code>agg=FALSE</code> in the <code>coef</code> and <code>se</code> commands.
Let’s see how this works.</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="NE.html#cb213-1" tabindex="-1"></a><span class="co"># Disaggregate estimates</span></span>
<span id="cb213-2"><a href="NE.html#cb213-2" tabindex="-1"></a>disaggregate.SA <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="fu">coef</span>(reg.fixest.SA.Agg,<span class="at">agg=</span><span class="cn">FALSE</span>),<span class="fu">se</span>(reg.fixest.SA.Agg,<span class="at">agg=</span><span class="cn">FALSE</span>)))</span>
<span id="cb213-3"><a href="NE.html#cb213-3" tabindex="-1"></a><span class="fu">colnames</span>(disaggregate.SA) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Coef&#39;</span>,<span class="st">&#39;Se&#39;</span>)</span>
<span id="cb213-4"><a href="NE.html#cb213-4" tabindex="-1"></a><span class="co"># adding treatment groups and time to treatment</span></span>
<span id="cb213-5"><a href="NE.html#cb213-5" tabindex="-1"></a>disaggregate.SA <span class="ot">&lt;-</span> disaggregate.SA <span class="sc">%&gt;%</span></span>
<span id="cb213-6"><a href="NE.html#cb213-6" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">test =</span>  <span class="fu">names</span>(<span class="fu">coef</span>(reg.fixest.SA.Agg,<span class="at">agg=</span><span class="cn">FALSE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb213-7"><a href="NE.html#cb213-7" tabindex="-1"></a>                    <span class="fu">mutate</span>(</span>
<span id="cb213-8"><a href="NE.html#cb213-8" tabindex="-1"></a>                      <span class="at">Group =</span> <span class="fu">factor</span>(<span class="fu">str_sub</span>(test,<span class="sc">-</span><span class="dv">1</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>,<span class="st">&#39;Aggregate&#39;</span>)),</span>
<span id="cb213-9"><a href="NE.html#cb213-9" tabindex="-1"></a>                      <span class="at">TimeToTreatment =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(<span class="fu">str_detect</span>(test,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">-&quot;</span>),<span class="fu">str_extract</span>(test,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">-[[:digit:]]&quot;</span>),<span class="fu">str_extract</span>(test,<span class="st">&quot;[[:digit:]]&quot;</span>)),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;-3&#39;</span>,<span class="st">&#39;-2&#39;</span>,<span class="st">&#39;-1&#39;</span>,<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>))</span>
<span id="cb213-10"><a href="NE.html#cb213-10" tabindex="-1"></a>                    ) <span class="sc">%&gt;%</span></span>
<span id="cb213-11"><a href="NE.html#cb213-11" tabindex="-1"></a>                  <span class="fu">select</span>(<span class="sc">-</span>test)</span>
<span id="cb213-12"><a href="NE.html#cb213-12" tabindex="-1"></a></span>
<span id="cb213-13"><a href="NE.html#cb213-13" tabindex="-1"></a><span class="co"># adding reference period</span></span>
<span id="cb213-14"><a href="NE.html#cb213-14" tabindex="-1"></a>Group <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>)</span>
<span id="cb213-15"><a href="NE.html#cb213-15" tabindex="-1"></a>TimeToTreatment <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&#39;-1&#39;</span>,<span class="dv">3</span>)</span>
<span id="cb213-16"><a href="NE.html#cb213-16" tabindex="-1"></a>ref.dis <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(Group,TimeToTreatment)) <span class="sc">%&gt;%</span></span>
<span id="cb213-17"><a href="NE.html#cb213-17" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb213-18"><a href="NE.html#cb213-18" tabindex="-1"></a>          <span class="at">Coef =</span> <span class="dv">0</span>,</span>
<span id="cb213-19"><a href="NE.html#cb213-19" tabindex="-1"></a>          <span class="at">Se =</span> <span class="dv">0</span>,</span>
<span id="cb213-20"><a href="NE.html#cb213-20" tabindex="-1"></a>          <span class="at">Group =</span> <span class="fu">factor</span>(Group,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>,<span class="st">&#39;Aggregate&#39;</span>)),</span>
<span id="cb213-21"><a href="NE.html#cb213-21" tabindex="-1"></a>          <span class="at">TimeToTreatment =</span> <span class="fu">factor</span>(TimeToTreatment,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;-3&#39;</span>,<span class="st">&#39;-2&#39;</span>,<span class="st">&#39;-1&#39;</span>,<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>))</span>
<span id="cb213-22"><a href="NE.html#cb213-22" tabindex="-1"></a>          )</span>
<span id="cb213-23"><a href="NE.html#cb213-23" tabindex="-1"></a>disaggregate.SA <span class="ot">&lt;-</span> <span class="fu">rbind</span>(disaggregate.SA,ref.dis) </span>
<span id="cb213-24"><a href="NE.html#cb213-24" tabindex="-1"></a></span>
<span id="cb213-25"><a href="NE.html#cb213-25" tabindex="-1"></a><span class="co"># adding aggregate results</span></span>
<span id="cb213-26"><a href="NE.html#cb213-26" tabindex="-1"></a><span class="co"># aggregate estimates</span></span>
<span id="cb213-27"><a href="NE.html#cb213-27" tabindex="-1"></a>aggregate.SA <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="fu">coef</span>(reg.fixest.SA.Agg),<span class="fu">se</span>(reg.fixest.SA.Agg)))</span>
<span id="cb213-28"><a href="NE.html#cb213-28" tabindex="-1"></a><span class="fu">colnames</span>(aggregate.SA) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Coef&#39;</span>,<span class="st">&#39;Se&#39;</span>)</span>
<span id="cb213-29"><a href="NE.html#cb213-29" tabindex="-1"></a><span class="co"># adding treatment groups and time to treatment</span></span>
<span id="cb213-30"><a href="NE.html#cb213-30" tabindex="-1"></a>aggregate.SA <span class="ot">&lt;-</span> aggregate.SA <span class="sc">%&gt;%</span></span>
<span id="cb213-31"><a href="NE.html#cb213-31" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">test =</span>  <span class="fu">names</span>(<span class="fu">coef</span>(reg.fixest.SA.Agg))) <span class="sc">%&gt;%</span></span>
<span id="cb213-32"><a href="NE.html#cb213-32" tabindex="-1"></a>                    <span class="fu">mutate</span>(</span>
<span id="cb213-33"><a href="NE.html#cb213-33" tabindex="-1"></a>                      <span class="at">Group =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="st">&quot;Aggregate&quot;</span>,<span class="dv">5</span>),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>,<span class="st">&#39;Aggregate&#39;</span>)),</span>
<span id="cb213-34"><a href="NE.html#cb213-34" tabindex="-1"></a>                      <span class="at">TimeToTreatment =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(<span class="fu">str_detect</span>(test,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">-&quot;</span>),<span class="fu">str_extract</span>(test,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">-[[:digit:]]&quot;</span>),<span class="fu">str_extract</span>(test,<span class="st">&quot;[[:digit:]]&quot;</span>)),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;-3&#39;</span>,<span class="st">&#39;-2&#39;</span>,<span class="st">&#39;-1&#39;</span>,<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>))</span>
<span id="cb213-35"><a href="NE.html#cb213-35" tabindex="-1"></a>                    ) <span class="sc">%&gt;%</span></span>
<span id="cb213-36"><a href="NE.html#cb213-36" tabindex="-1"></a>                  <span class="fu">select</span>(<span class="sc">-</span>test)</span>
<span id="cb213-37"><a href="NE.html#cb213-37" tabindex="-1"></a></span>
<span id="cb213-38"><a href="NE.html#cb213-38" tabindex="-1"></a><span class="co"># adding reference period</span></span>
<span id="cb213-39"><a href="NE.html#cb213-39" tabindex="-1"></a>Group <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Aggregate&quot;</span>)</span>
<span id="cb213-40"><a href="NE.html#cb213-40" tabindex="-1"></a>TimeToTreatment <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">&#39;-1&#39;</span>,<span class="dv">1</span>)</span>
<span id="cb213-41"><a href="NE.html#cb213-41" tabindex="-1"></a>ref <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(Group,TimeToTreatment)) <span class="sc">%&gt;%</span></span>
<span id="cb213-42"><a href="NE.html#cb213-42" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb213-43"><a href="NE.html#cb213-43" tabindex="-1"></a>          <span class="at">Coef =</span> <span class="dv">0</span>,</span>
<span id="cb213-44"><a href="NE.html#cb213-44" tabindex="-1"></a>          <span class="at">Se =</span> <span class="dv">0</span>,</span>
<span id="cb213-45"><a href="NE.html#cb213-45" tabindex="-1"></a>          <span class="at">Group =</span> <span class="fu">factor</span>(Group,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>,<span class="st">&#39;Aggregate&#39;</span>)),</span>
<span id="cb213-46"><a href="NE.html#cb213-46" tabindex="-1"></a>          <span class="at">TimeToTreatment =</span> <span class="fu">factor</span>(TimeToTreatment,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;-3&#39;</span>,<span class="st">&#39;-2&#39;</span>,<span class="st">&#39;-1&#39;</span>,<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>))</span>
<span id="cb213-47"><a href="NE.html#cb213-47" tabindex="-1"></a>          )</span>
<span id="cb213-48"><a href="NE.html#cb213-48" tabindex="-1"></a>disaggregate.SA <span class="ot">&lt;-</span> <span class="fu">rbind</span>(disaggregate.SA,aggregate.SA,ref) <span class="sc">%&gt;%</span></span>
<span id="cb213-49"><a href="NE.html#cb213-49" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">TimeToTreatment =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(TimeToTreatment)))</span></code></pre></div>
<p>Let’s plot the result:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="NE.html#cb214-1" tabindex="-1"></a><span class="fu">ggplot</span>(disaggregate.SA,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef,<span class="at">colour=</span>Group,<span class="at">linetype=</span>Group))<span class="sc">+</span></span>
<span id="cb214-2"><a href="NE.html#cb214-2" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb214-3"><a href="NE.html#cb214-3" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb214-4"><a href="NE.html#cb214-4" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb214-5"><a href="NE.html#cb214-5" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb214-6"><a href="NE.html#cb214-6" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb214-7"><a href="NE.html#cb214-7" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb214-8"><a href="NE.html#cb214-8" tabindex="-1"></a>    <span class="fu">scale_colour_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb214-9"><a href="NE.html#cb214-9" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb214-10"><a href="NE.html#cb214-10" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredDisAgg"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredDisAgg-1.png" alt="Disaggregated DID estimates around the treatment date estimated using the Sun and Abraham procedure in fixest (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.32: Disaggregated DID estimates around the treatment date estimated using the Sun and Abraham procedure in fixest (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDStaggeredDisAgg">4.32</a> shows very well how the Sun and Abraham estimator works: it aggregates each group specific treatment effect (relative to the reference period <span class="math inline">\(\tau&#39;=-1\)</span> and to the reference group (<span class="math inline">\(D_i=\infty\)</span>)) with period-specific weights which depend on the proportion of each treated group among the treated at this period.
As a result, some dynamic changes in treatment effects might be driven by changes in group composition and not by genuine changes in the effect of the treatment.
This is the case in Figure <a href="NE.html#fig:PlotDIDStaggeredDisAgg">4.32</a> between periods 1 and 2 where the acceleration in the growth of the aggregated treatment effect is due to the disappearance of group 3, which has a lower speed of increase of its average treatment effect, at period 2.
As it is always tricky to interpret the aggregated result, I suggest to always plot the disaggregated results on the same graph, as in Figure <a href="NE.html#fig:PlotDIDStaggeredDisAgg">4.32</a>.</p>
<p>Let us finally compute the aggregated effect:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="NE.html#cb215-1" tabindex="-1"></a>ATT.agg.SA <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(reg.fixest.SA.Agg, <span class="fu">c</span>(<span class="st">&quot;ATT&quot;</span> <span class="ot">=</span> <span class="st">&quot;time::[^-]&quot;</span>))</span></code></pre></div>
<p>The aggregated effect estimated using the Sun and Abraham approach as implemented in <code>fixest</code> is equal to 1.07 <span class="math inline">\(\pm\)</span> 0.04.</p>
<div class="remark">
<p><span id="unlabeled-div-127" class="remark"><em>Remark</em>. </span>Sun and Abraham’s estimator can also be formulated in repeated cross sections by estimating the following model by OLS:</p>
</div>
<p><span class="math display">\[\begin{align*}
    Y_{i,t} &amp;  = \alpha + \sum_{d=2}^T\mu_d\uns{D_{i}=d} + \sum_{\tau=2}^{T}\delta_{\tau}\uns{t=\tau} + \sum_{d=2}^T\sum_{\tau\neq-1}\beta_{d,\tau}^{SA}\uns{D_{i}=d \land t=d+\tau}  + \epsilon^{SA}_{i,t}.
\end{align*}\]</span></p>
<div class="remark">
<p><span id="unlabeled-div-128" class="remark"><em>Remark</em>. </span>We can also show that Sun and Abraham’s estimator is equal to our individual DID estimators in the population:</p>
</div>
<div class="theorem">
<p><span id="thm:EquivDIDSApop" class="theorem"><strong>Theorem 4.19  (Sun and Abraham estimator is equivalent to individual DID in the population) </strong></span>In the population, Sun and Abraham’s estimator (formulated in a panel and in a repeated cross section) is equal to the individual DID estimators using the never treated as the comparison group and the period just before receiving the treatment as the reference period: <span class="math inline">\(\forall d\in\left\{2,\dots,T\right\}\)</span>, <span class="math inline">\(\forall\tau\in\left\{-(T-1),\dots,T-2\right\}\setminus\left\{-1\right\}\)</span>,</p>
<p><span class="math display">\[\begin{align*}
  \beta_{d,\tau}^{SA} &amp; = \Delta^{Y}_{DID}(d,\infty,\tau,d-1).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-129" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofEquivDIDSApop">A.3.3</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-130" class="remark"><em>Remark</em>. </span>We can also show that Sun and Abraham’s estimator is equal to our individual DID estimators in the sample:</p>
</div>
<div class="theorem">
<p><span id="thm:EquivDIDSAsamp" class="theorem"><strong>Theorem 4.20  (Sun and Abraham estimator is equivalent to individual DID in the sample) </strong></span>In the sample, Sun and Abraham’s estimator (estimated by OLS in repeated cross sections or in panel data or by OLS using the Least Squares Dummy Variables model, the Within transformation or the First Difference transformation relative to <span class="math inline">\(d-1\)</span> in panel data) is equal to the individual DID estimators using the never treated as the comparison group and the period just before receiving the treatment as the reference period: <span class="math inline">\(\forall d\in\left\{2,\dots,T\right\}\)</span>, <span class="math inline">\(\forall\tau\in\left\{-(T-1),\dots,T-2\right\}\setminus\left\{-1\right\}\)</span>,</p>
<p><span class="math display">\[\begin{align*}
  \hat{\beta}_{d,\tau}^{SA} &amp; = \frac{\sum_{i=1}^{N_{d+\tau}}Y_{i,d+\tau}\uns{D_i=d}}{\sum_{i=1}^{N_{d+\tau}}\uns{D_i=d}}
                                -\frac{\sum_{i=1}^{N_{d-1}}Y_{i,d-1}\uns{D_i=d}}{\sum_{i=1}^{N_{d-1}}\uns{D_i=d}} \\
                            &amp; \phantom{=}
                                  - \left(\frac{\sum_{i=1}^{N_{d+\tau}}Y_{i,d+\tau}\uns{D_i=\infty}}{\sum_{i=1}^{N_{d+\tau}}\uns{D_i=\infty}}
                                  -\frac{\sum_{i=1}^{N_{d-1}}Y_{i,d-1}\uns{D_i=\infty}}{\sum_{i=1}^{N_{d-1}}\uns{D_i=\infty}}\right)
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-131" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofEquivDIDSAsamp">A.3.4</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-132" class="remark"><em>Remark</em>. </span>The First Difference transformation of the Sun and Abraham model that is equivalent to the individual DID estimator is not a standard first difference where observations observed at date <span class="math inline">\(t-1\)</span> are subtracted from observations at <span class="math inline">\(t\)</span>.
The correct First Difference transformation is relative to <span class="math inline">\(d-1\)</span>: the OLS regression is performed on the following model, restricted to the sample where <span class="math inline">\(D_i=d\)</span> or <span class="math inline">\(D_i=\infty\)</span> and <span class="math inline">\(T_i=t\)</span> or <span class="math inline">\(T_i=d-1\)</span>:</p>
</div>
<p><span class="math display">\[\begin{align*}
  D_j^{d,\tau}(Y_{j,d+\tau} - Y_{j,d-1}) &amp; = \alpha_{d,\tau}^{FD}D_j^{d,\tau} + \beta_{d,\tau}^{FD}\uns{D_j=d}D_j^{d,\tau} + \epsilon^{FD}_{j,t}D_j^{d,\tau},
\end{align*}\]</span></p>
<p>where <span class="math inline">\(D_j^{d,\tau}\)</span> takes value one when observation <span class="math inline">\(j\)</span> is used to estimate <span class="math inline">\(\hat\beta^{SA}_{d,\tau}\)</span>.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-239" class="example"><strong>Example 4.44  </strong></span>In order to see how Theorem <a href="NE.html#thm:EquivDIDSAsamp">4.20</a> works in practice, let us collect all the estimated effects obtained thanks to our separate individual DID estimators and compare them with the coefficients of Sun and Abraham’s model.</p>
</div>
<p>We are going to compare the coefficients in the Sun and Abraham model to the DID estimates that compare each treated group to the never treated group, since the Sun and Abraham estimator do not use the observations belonging to groups that eventually get treated as controls when they are not yet treated.</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="NE.html#cb216-1" tabindex="-1"></a><span class="co"># reorganize the DID estimator</span></span>
<span id="cb216-2"><a href="NE.html#cb216-2" tabindex="-1"></a>DID.<span class="fl">1.</span>mod <span class="ot">&lt;-</span> DID<span class="fl">.1</span> <span class="sc">%&gt;%</span></span>
<span id="cb216-3"><a href="NE.html#cb216-3" tabindex="-1"></a>          <span class="fu">filter</span>(dprime<span class="sc">==</span><span class="st">&quot;99&quot;</span>) <span class="sc">%&gt;%</span> <span class="co"># keep only never treated as counterfactuals</span></span>
<span id="cb216-4"><a href="NE.html#cb216-4" tabindex="-1"></a>          <span class="fu">rename</span>(</span>
<span id="cb216-5"><a href="NE.html#cb216-5" tabindex="-1"></a>            <span class="at">TimeToTreatment=</span>tau,</span>
<span id="cb216-6"><a href="NE.html#cb216-6" tabindex="-1"></a>             <span class="at">Group=</span>d</span>
<span id="cb216-7"><a href="NE.html#cb216-7" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb216-8"><a href="NE.html#cb216-8" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb216-9"><a href="NE.html#cb216-9" tabindex="-1"></a>            <span class="at">Group=</span><span class="fu">factor</span>(Group,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;1&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;Aggregate&quot;</span>)),</span>
<span id="cb216-10"><a href="NE.html#cb216-10" tabindex="-1"></a>            <span class="at">TimeToTreatment=</span><span class="fu">as.numeric</span>(TimeToTreatment)</span>
<span id="cb216-11"><a href="NE.html#cb216-11" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb216-12"><a href="NE.html#cb216-12" tabindex="-1"></a>          <span class="fu">select</span>(DIDest,DIDse,Group,TimeToTreatment)</span>
<span id="cb216-13"><a href="NE.html#cb216-13" tabindex="-1"></a></span>
<span id="cb216-14"><a href="NE.html#cb216-14" tabindex="-1"></a><span class="co"># add reference period to DID estimator</span></span>
<span id="cb216-15"><a href="NE.html#cb216-15" tabindex="-1"></a>DID.<span class="fl">1.</span>mod <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.<span class="fl">1.</span>mod,ref.dis <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">DIDest=</span>Coef,<span class="at">DIDse=</span>Se)) <span class="sc">%&gt;%</span></span>
<span id="cb216-16"><a href="NE.html#cb216-16" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb216-17"><a href="NE.html#cb216-17" tabindex="-1"></a>            <span class="at">TimeToTreatment=</span><span class="fu">as.numeric</span>(TimeToTreatment)</span>
<span id="cb216-18"><a href="NE.html#cb216-18" tabindex="-1"></a>          )</span>
<span id="cb216-19"><a href="NE.html#cb216-19" tabindex="-1"></a></span>
<span id="cb216-20"><a href="NE.html#cb216-20" tabindex="-1"></a><span class="co"># joining DID and SA estimates</span></span>
<span id="cb216-21"><a href="NE.html#cb216-21" tabindex="-1"></a>CompDIDSA <span class="ot">&lt;-</span> DID.<span class="fl">1.</span>mod <span class="sc">%&gt;%</span></span>
<span id="cb216-22"><a href="NE.html#cb216-22" tabindex="-1"></a>              <span class="fu">left_join</span>(disaggregate.SA,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Group&#39;</span>,<span class="st">&#39;TimeToTreatment&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb216-23"><a href="NE.html#cb216-23" tabindex="-1"></a>                 <span class="fu">mutate</span>(</span>
<span id="cb216-24"><a href="NE.html#cb216-24" tabindex="-1"></a>                     <span class="at">TimeToTreatment =</span> <span class="fu">factor</span>(TimeToTreatment,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;-3&#39;</span>,<span class="st">&#39;-2&#39;</span>,<span class="st">&#39;-1&#39;</span>,<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>))</span>
<span id="cb216-25"><a href="NE.html#cb216-25" tabindex="-1"></a>                 )</span></code></pre></div>
<p>Let’s now plot the results:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="NE.html#cb217-1" tabindex="-1"></a><span class="fu">ggplot</span>(CompDIDSA,<span class="fu">aes</span>(<span class="at">x=</span>DIDest,<span class="at">y=</span>Coef,<span class="at">shape=</span>Group,<span class="at">color=</span>TimeToTreatment))<span class="sc">+</span></span>
<span id="cb217-2"><a href="NE.html#cb217-2" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb217-3"><a href="NE.html#cb217-3" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope=</span><span class="dv">1</span>,<span class="at">intercept=</span><span class="dv">0</span>,<span class="at">linetype=</span><span class="st">&quot;dotted&quot;</span>,<span class="at">color=</span><span class="st">&quot;red&quot;</span>)<span class="sc">+</span></span>
<span id="cb217-4"><a href="NE.html#cb217-4" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Sun and Abraham estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb217-5"><a href="NE.html#cb217-5" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb217-6"><a href="NE.html#cb217-6" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDSA"></span>
<img src="STCI_files/figure-html/PlotDIDSA-1.png" alt="Comparison of treatment effects estimated using DID and Sun and Abraham estimator (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.33: Comparison of treatment effects estimated using DID and Sun and Abraham estimator (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>As Figure <a href="NE.html#fig:PlotDIDSA">4.33</a> shows, the coefficients estimated through DID are identical to the coefficients estimated using Sun and Abraham approach (they all lone up on the 45 degree line).
This is an illustration of the main result of Theorem <a href="NE.html#thm:EquivDIDSAsamp">4.20</a>.</p>
<p>Note that the estimated aggregated effect using DID with weights proportional to group composition and time spent in the treatment is equal to <span class="math inline">\(\hat\Delta^{Y}_{TT}(v)=\)</span> 1.06.
The corresponding estimate using Sun and Abraham estimator is equal to 1.07 <span class="math inline">\(\pm\)</span> 0.04.
The two estimator are slightly different.
This is because Sun and Abraham aggregate effects estimated using exclusively the never treated group as the control group while the DID estimator aggregates the same and effects estimated using the other treated groups before they receive the treatment.
It should be the case that if we aggregate the DID estimates using only the never treated as the control group, we should obtain the same result as with Sun and Abraham estimator.
Let’s check.</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="NE.html#cb218-1" tabindex="-1"></a><span class="co"># joining the weights to the results</span></span>
<span id="cb218-2"><a href="NE.html#cb218-2" tabindex="-1"></a>DID.<span class="fl">1.</span>agg.SA <span class="ot">&lt;-</span> DID<span class="fl">.1</span> <span class="sc">%&gt;%</span></span>
<span id="cb218-3"><a href="NE.html#cb218-3" tabindex="-1"></a>                  <span class="fu">filter</span>(dprime<span class="sc">==</span><span class="st">&quot;99&quot;</span>,tau<span class="sc">&gt;=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb218-4"><a href="NE.html#cb218-4" tabindex="-1"></a>                  <span class="fu">select</span>(<span class="sc">-</span>prop.group) <span class="sc">%&gt;%</span></span>
<span id="cb218-5"><a href="NE.html#cb218-5" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb218-6"><a href="NE.html#cb218-6" tabindex="-1"></a>                    <span class="at">d=</span> <span class="fu">factor</span>(d,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;99&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;1&quot;</span>))</span>
<span id="cb218-7"><a href="NE.html#cb218-7" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb218-8"><a href="NE.html#cb218-8" tabindex="-1"></a>                  <span class="fu">left_join</span>(prop.groups.DID,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;d&quot;</span><span class="ot">=</span><span class="st">&quot;dprime&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb218-9"><a href="NE.html#cb218-9" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb218-10"><a href="NE.html#cb218-10" tabindex="-1"></a>                    <span class="at">w.ATT =</span> prop.group<span class="sc">*</span>DIDest</span>
<span id="cb218-11"><a href="NE.html#cb218-11" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb218-12"><a href="NE.html#cb218-12" tabindex="-1"></a>                  <span class="fu">summarize</span>(</span>
<span id="cb218-13"><a href="NE.html#cb218-13" tabindex="-1"></a>                    <span class="at">sum.w.ATT =</span> <span class="fu">sum</span>(w.ATT),</span>
<span id="cb218-14"><a href="NE.html#cb218-14" tabindex="-1"></a>                    <span class="at">sum.w =</span> <span class="fu">sum</span>(prop.group)</span>
<span id="cb218-15"><a href="NE.html#cb218-15" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span> </span>
<span id="cb218-16"><a href="NE.html#cb218-16" tabindex="-1"></a>                  <span class="fu">mutate</span>(</span>
<span id="cb218-17"><a href="NE.html#cb218-17" tabindex="-1"></a>                    <span class="at">ATT.varying.DID =</span> sum.w.ATT<span class="sc">/</span>sum.w</span>
<span id="cb218-18"><a href="NE.html#cb218-18" tabindex="-1"></a>                  ) <span class="sc">%&gt;%</span></span>
<span id="cb218-19"><a href="NE.html#cb218-19" tabindex="-1"></a>                  <span class="fu">pull</span>(ATT.varying.DID)</span></code></pre></div>
<p>The estimated aggregated effect using DID with weights proportional to group composition and time spent in the treatment, restricting the estimates to the ones obtained using the never treated as the control group is equal to <span class="math inline">\(\hat\Delta^{Y}_{TT}(v)=\)</span> 1.07, which is indeed equal to the aggregate estimate computed by the Sun and Abraham estimator in <code>fixest</code>.</p>
<div class="remark">
<p><span id="unlabeled-div-133" class="remark"><em>Remark</em>. </span>What to do in pratice?
Use only the never treated as controls?<br />
It seems that using more groups as controls (if they are valid) should increase efficiency.</p>
</div>
</div>
<div id="direct-weighting-using-one-reference-period-and-one-reference-group-callaway-and-santanna" class="section level5 hasAnchor" number="4.3.3.2.3">
<h5><span class="header-section-number">4.3.3.2.3</span> Direct weighting using one reference period and one reference group (Callaway and Sant’Anna)<a href="NE.html#direct-weighting-using-one-reference-period-and-one-reference-group-callaway-and-santanna" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><a href="https://www.sciencedirect.com/science/article/pii/S0304407620303948">Callaway and Sant’Anna (2021)</a> propose an alternative estimator to the one proposed by Sun and Abraham.
They suggest using a doubly robust matching estimator to condition on observed covariates.
We are only going to encouter these estimators in Section <a href="#sec:OM"><strong>??</strong></a>.
In the absence of covariates, Callaway and Sant’Anna’s estimator is equivalent to the Sun and Abraham estimator.
Callaway and Sant’Anna have proposed the <code>did</code> package to implement their estimator.
The main command is <code>att_gt</code>, which computes all the estimates for each treatment group <span class="math inline">\(D_i=g\)</span> and each time period <span class="math inline">\(t\)</span>.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-241" class="example"><strong>Example 4.45  </strong></span>Let’s see if we can make it work.</p>
</div>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="NE.html#cb219-1" tabindex="-1"></a><span class="co"># preparing the data</span></span>
<span id="cb219-2"><a href="NE.html#cb219-2" tabindex="-1"></a><span class="co"># The Group variable has to take value 0 for the never treated (instead of infty or 99)</span></span>
<span id="cb219-3"><a href="NE.html#cb219-3" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb219-4"><a href="NE.html#cb219-4" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb219-5"><a href="NE.html#cb219-5" tabindex="-1"></a>            <span class="at">Group =</span> <span class="fu">if_else</span>(Ds<span class="sc">&lt;</span><span class="dv">99</span>,Ds,<span class="dv">0</span>)</span>
<span id="cb219-6"><a href="NE.html#cb219-6" tabindex="-1"></a>          )</span>
<span id="cb219-7"><a href="NE.html#cb219-7" tabindex="-1"></a></span>
<span id="cb219-8"><a href="NE.html#cb219-8" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb219-9"><a href="NE.html#cb219-9" tabindex="-1"></a>reg.CSA <span class="ot">&lt;-</span> <span class="fu">att_gt</span>(<span class="at">yname=</span><span class="st">&quot;y&quot;</span>,<span class="at">tname=</span><span class="st">&quot;time&quot;</span>,<span class="at">idname=</span><span class="st">&quot;id&quot;</span>,<span class="at">gname=</span><span class="st">&quot;Group&quot;</span>,<span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>),<span class="at">base_period=</span><span class="st">&quot;universal&quot;</span>)</span>
<span id="cb219-10"><a href="NE.html#cb219-10" tabindex="-1"></a></span>
<span id="cb219-11"><a href="NE.html#cb219-11" tabindex="-1"></a><span class="co"># dynamic treatment effects (event-study graph)</span></span>
<span id="cb219-12"><a href="NE.html#cb219-12" tabindex="-1"></a>reg.CSA.Agg <span class="ot">&lt;-</span> <span class="fu">aggte</span>(reg.CSA,<span class="at">type=</span><span class="st">&quot;dynamic&quot;</span>)   </span></code></pre></div>
<p>Let’s plot the result:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="NE.html#cb220-1" tabindex="-1"></a><span class="co"># preparing the results for the plot  </span></span>
<span id="cb220-2"><a href="NE.html#cb220-2" tabindex="-1"></a>DID.CSA <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(reg.CSA<span class="sc">$</span>group)</span>
<span id="cb220-3"><a href="NE.html#cb220-3" tabindex="-1"></a><span class="fu">colnames</span>(DID.CSA) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Group&quot;</span>)</span>
<span id="cb220-4"><a href="NE.html#cb220-4" tabindex="-1"></a>DID.CSA <span class="ot">&lt;-</span> DID.CSA <span class="sc">%&gt;%</span></span>
<span id="cb220-5"><a href="NE.html#cb220-5" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb220-6"><a href="NE.html#cb220-6" tabindex="-1"></a>              <span class="at">time =</span> reg.CSA<span class="sc">$</span>t,</span>
<span id="cb220-7"><a href="NE.html#cb220-7" tabindex="-1"></a>              <span class="at">Coef =</span> reg.CSA<span class="sc">$</span>att,</span>
<span id="cb220-8"><a href="NE.html#cb220-8" tabindex="-1"></a>              <span class="at">Se =</span> reg.CSA<span class="sc">$</span>se</span>
<span id="cb220-9"><a href="NE.html#cb220-9" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb220-10"><a href="NE.html#cb220-10" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb220-11"><a href="NE.html#cb220-11" tabindex="-1"></a>              <span class="at">TimeToTreatment =</span> time<span class="sc">-</span>Group,</span>
<span id="cb220-12"><a href="NE.html#cb220-12" tabindex="-1"></a>              <span class="at">Group =</span> <span class="fu">factor</span>(Group,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>,<span class="st">&#39;Aggregate&#39;</span>)),</span>
<span id="cb220-13"><a href="NE.html#cb220-13" tabindex="-1"></a>            )</span>
<span id="cb220-14"><a href="NE.html#cb220-14" tabindex="-1"></a></span>
<span id="cb220-15"><a href="NE.html#cb220-15" tabindex="-1"></a><span class="co"># add aggregate effect</span></span>
<span id="cb220-16"><a href="NE.html#cb220-16" tabindex="-1"></a>DID.CSA.Agg <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(reg.CSA.Agg<span class="sc">$</span>egt,reg.CSA.Agg<span class="sc">$</span>att.egt,reg.CSA.Agg<span class="sc">$</span>se.egt))</span>
<span id="cb220-17"><a href="NE.html#cb220-17" tabindex="-1"></a><span class="fu">colnames</span>(DID.CSA.Agg) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;TimeToTreatment&#39;</span>,<span class="st">&#39;Coef&#39;</span>,<span class="st">&#39;Se&#39;</span>)</span>
<span id="cb220-18"><a href="NE.html#cb220-18" tabindex="-1"></a>DID.CSA.Agg <span class="ot">&lt;-</span> DID.CSA.Agg <span class="sc">%&gt;%</span></span>
<span id="cb220-19"><a href="NE.html#cb220-19" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb220-20"><a href="NE.html#cb220-20" tabindex="-1"></a>                  <span class="at">Group =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="st">&quot;Aggregate&quot;</span>,<span class="fu">nrow</span>(DID.CSA.Agg)),<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;2&#39;</span>,<span class="st">&#39;3&#39;</span>,<span class="st">&#39;4&#39;</span>,<span class="st">&#39;Aggregate&#39;</span>))</span>
<span id="cb220-21"><a href="NE.html#cb220-21" tabindex="-1"></a>                )</span>
<span id="cb220-22"><a href="NE.html#cb220-22" tabindex="-1"></a></span>
<span id="cb220-23"><a href="NE.html#cb220-23" tabindex="-1"></a><span class="co"># merge all results</span></span>
<span id="cb220-24"><a href="NE.html#cb220-24" tabindex="-1"></a>DID.CSA <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">select</span>(DID.CSA,<span class="sc">-</span>time),DID.CSA.Agg)</span>
<span id="cb220-25"><a href="NE.html#cb220-25" tabindex="-1"></a></span>
<span id="cb220-26"><a href="NE.html#cb220-26" tabindex="-1"></a><span class="fu">ggplot</span>(DID.CSA,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef,<span class="at">colour=</span>Group,<span class="at">linetype=</span>Group))<span class="sc">+</span></span>
<span id="cb220-27"><a href="NE.html#cb220-27" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb220-28"><a href="NE.html#cb220-28" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb220-29"><a href="NE.html#cb220-29" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-30"><a href="NE.html#cb220-30" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb220-31"><a href="NE.html#cb220-31" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb220-32"><a href="NE.html#cb220-32" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb220-33"><a href="NE.html#cb220-33" tabindex="-1"></a>    <span class="fu">scale_colour_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb220-34"><a href="NE.html#cb220-34" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb220-35"><a href="NE.html#cb220-35" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredDisAggCSA"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredDisAggCSA-1.png" alt="Disaggregated DID estimates around the treatment date estimated using the Callaway and Sant'Anna procedure in did (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.34: Disaggregated DID estimates around the treatment date estimated using the Callaway and Sant’Anna procedure in did (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDStaggeredDisAggCSA">4.34</a> shows a result that is very similar to the one obtained in Figure <a href="NE.html#fig:PlotDIDStaggeredDisAgg">4.32</a> using Sun and Abraham’s approch as implemented in <code>fixest</code>.
The two approaches are indeed equivalent with the options that we have chosen.</p>
<p>Let us finally compute the aggregated treatment effect:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="NE.html#cb221-1" tabindex="-1"></a>ATT.agg.CSA <span class="ot">&lt;-</span> <span class="fu">aggte</span>(reg.CSA,<span class="at">type=</span><span class="st">&quot;simple&quot;</span>)</span></code></pre></div>
<p>The aggregated effect estimated using the Callaway and Sant’Anna approach as implemented in <code>did</code> is equal to 1.07 <span class="math inline">\(\pm\)</span> 0.06.</p>
</div>
<div id="de-chaisemartin-and-dhaultfoeuille" class="section level5 hasAnchor" number="4.3.3.2.4">
<h5><span class="header-section-number">4.3.3.2.4</span> De Chaisemartin and d’Haultfoeuille<a href="NE.html#de-chaisemartin-and-dhaultfoeuille" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>de Chaisemartin et d’Haultfoeuille propose two ways to deal with DID with differences in treatment timing.
In <a href="https://www.aeaweb.org/articles?id=10.1257/aer.20181169">de Chaisemartin and d’Haultfoeuille (2020)</a>, they propose to estimate the effect of the treatment using only the periods where a change in treatment status occurs, by comparing the treated to the not yet treated at the same time periods.
In <a href="https://arxiv.org/abs/2007.04267">de Chaisemartin et d’Haultfoeuille (2021)</a>, they propose to estimate the dynamic effect of the treatment using a discounted sum of treatment effects over time.
In its simplest form, with staggered designs, a discrete treatment and no covariates, <a href="https://arxiv.org/abs/2007.04267">de Chaisemartin et d’Haultfoeuille (2021)</a>’s estimator is equivalent to that of Sun and Abraham or Callaway and Sant’Anna.
Both estimators have been implemented in the <code>DIDmutiplegt</code> package with the <code>did_multiplegt</code> function.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-242" class="example"><strong>Example 4.46  </strong></span>Let’s see how it works.</p>
</div>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="NE.html#cb222-1" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb222-2"><a href="NE.html#cb222-2" tabindex="-1"></a>reg.dCdH <span class="ot">&lt;-</span> <span class="fu">did_multiplegt_old</span>(<span class="at">Y=</span><span class="st">&quot;y&quot;</span>,<span class="at">T=</span><span class="st">&quot;time&quot;</span>,<span class="at">G=</span><span class="st">&quot;id&quot;</span>,<span class="at">D=</span><span class="st">&quot;D&quot;</span>,<span class="at">df=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>),<span class="at">placebo=</span><span class="dv">3</span>,<span class="at">dynamic=</span><span class="dv">3</span>,<span class="at">average_effect=</span><span class="st">&quot;prop_number_switchers&quot;</span>)</span></code></pre></div>
<p>Let us now pot the results:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="NE.html#cb223-1" tabindex="-1"></a><span class="co"># preparing the results for the plot  </span></span>
<span id="cb223-2"><a href="NE.html#cb223-2" tabindex="-1"></a>DID.dCdH <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">c</span>(reg.dCdH<span class="sc">$</span>placebo_2,reg.dCdH<span class="sc">$</span>placebo_1,<span class="dv">0</span>,reg.dCdH<span class="sc">$</span>effect,reg.dCdH<span class="sc">$</span>dynamic_1,reg.dCdH<span class="sc">$</span>dynamic_2))</span>
<span id="cb223-3"><a href="NE.html#cb223-3" tabindex="-1"></a><span class="fu">colnames</span>(DID.dCdH) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Coef&quot;</span>)</span>
<span id="cb223-4"><a href="NE.html#cb223-4" tabindex="-1"></a>DID.dCdH <span class="ot">&lt;-</span> DID.dCdH <span class="sc">%&gt;%</span></span>
<span id="cb223-5"><a href="NE.html#cb223-5" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb223-6"><a href="NE.html#cb223-6" tabindex="-1"></a>              <span class="at">TimeToTreatment =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb223-7"><a href="NE.html#cb223-7" tabindex="-1"></a>              <span class="at">Se =</span> <span class="fu">c</span>(reg.dCdH<span class="sc">$</span>se_placebo_2,reg.dCdH<span class="sc">$</span>se_placebo_1,<span class="dv">0</span>,reg.dCdH<span class="sc">$</span>se_effect,reg.dCdH<span class="sc">$</span>se_dynamic_1,reg.dCdH<span class="sc">$</span>se_dynamic_2)</span>
<span id="cb223-8"><a href="NE.html#cb223-8" tabindex="-1"></a>            ) </span>
<span id="cb223-9"><a href="NE.html#cb223-9" tabindex="-1"></a></span>
<span id="cb223-10"><a href="NE.html#cb223-10" tabindex="-1"></a><span class="fu">ggplot</span>(DID.dCdH,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef))<span class="sc">+</span></span>
<span id="cb223-11"><a href="NE.html#cb223-11" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb223-12"><a href="NE.html#cb223-12" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb223-13"><a href="NE.html#cb223-13" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb223-14"><a href="NE.html#cb223-14" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb223-15"><a href="NE.html#cb223-15" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb223-16"><a href="NE.html#cb223-16" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb223-17"><a href="NE.html#cb223-17" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredDisAggdCdH"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredDisAggdCdH-1.png" alt="DID estimates around the treatment date estimated using the de Chaisemartin and d'Haultfoeuille procedure (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.35: DID estimates around the treatment date estimated using the de Chaisemartin and d’Haultfoeuille procedure (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDStaggeredDisAggdCdH">4.35</a> shows that the profile estimated using de Chaisemartin and d’Haultfoeuille’s aprproach is similar but distinct from the one estimated by the other authors.
Why is still to be determined.</p>
<p>Finally, the aggregate efect of the treatment as estimated by the <a href="https://www.aeaweb.org/articles?id=10.1257/aer.20181169">de Chaisemartin and d’Haultfoeuille (2020)</a> approach is equal to 0.3.
I have been unable to obtain standard errors for this estimator for now.</p>
</div>
<div id="imputation-methods-borusyak-jaravel-and-speiss" class="section level5 hasAnchor" number="4.3.3.2.5">
<h5><span class="header-section-number">4.3.3.2.5</span> Imputation methods: Borusyak, Jaravel and Speiss<a href="NE.html#imputation-methods-borusyak-jaravel-and-speiss" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><a href="http://arxiv.org/abs/2108.12419">Borusyak, Jaravel and Speiss (2021)</a> adopt a very different framework from the previous ones.
They do not build from the individual DID estimators <span class="math inline">\(\Delta^{Y}_{DID}(d,d&#39;,\tau,\tau&#39;)\)</span>, but instead propose to estimate the individual level treatment effects <span class="math inline">\(\hat\Delta^Y_{i,t}\)</span> and then to aggregate them as one wishes to.
In order to build an estimate of the individual level treatment effects <span class="math inline">\(\hat\Delta^Y_{i,t}\)</span>, <a href="http://arxiv.org/abs/2108.12419">Borusyak, Jaravel and Speiss (2021)</a> propose to use an imputation estimator, <span class="math inline">\(\hat Y^0_{i,t}\)</span>, which predicts the value of <span class="math inline">\(Y^0_{i,t}\)</span> for each treated unit.
<a href="http://arxiv.org/abs/2108.12419">Borusyak, Jaravel and Speiss (2021)</a>’s imputation estimator works as follows:</p>
<ol style="list-style-type: decimal">
<li>Within the never treated and not-yet-treated observations only, estimate <span class="math inline">\(\hat\mu_i^{OLS}\)</span> and <span class="math inline">\(\hat\delta_t^{OLS}\)</span> using the following OLS regression:</li>
</ol>
<p><span class="math display">\[\begin{align*}
  Y^0_{i,t} &amp; = \mu_i + \delta_t + U^0_{i,t}
\end{align*}\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li>For each treated observation, set <span class="math inline">\(\hat Y^0_{i,t} = \hat\mu_i^{OLS}+\hat\delta_t^{OLS}\)</span> and <span class="math inline">\(\hat\Delta^Y_{i,t}=Y^1_{i,t}-\hat Y^0_{i,t}\)</span>.</li>
</ol>
<p>Finally, Borusyak, Jaravel and Speiss (2021) propose to aggregate the estimates for each treatment effect using weights <span class="math inline">\(w^{BJS_k}_{i,t}\)</span> in order to form <span class="math inline">\(\hat\Delta^{Y}_{TT}(BJS_k)=\sum w^{BJS_k}_{i,t}\hat\Delta^Y_{i,t}\)</span>.</p>
<p>In the absence of covariates, or group-specific time trends, the main assumption of Borusyak, Jaravel and Speiss (2021)’s framework is that the potential outcomes in the absence of the treatment can be decomposed in two separate influences:</p>
<div class="hypothesis">
<p><span id="hyp:AdditiveSeparabilityFE" class="hypothesis"><strong>Hypothesis 4.26  (Additive Separability of Potential Outcomes in the Absence of the Treatment) </strong></span>We assume that the potential outcomes in the absence of the treatment are additively separable between time and individual fixed effects:</p>
<p><span class="math display">\[\begin{align*}
   Y^0_{i,t} &amp; = \mu_i + \delta_t + U^0_{i,t},
\end{align*}\]</span></p>
<p>with <span class="math inline">\(\esp{U^0_{i,t}|D_i}=0\)</span>, <span class="math inline">\(\forall t\in\{1,\dots,T\}\)</span>.</p>
</div>
<p>Assumption <a href="NE.html#hyp:AdditiveSeparabilityFE">4.26</a> assumes that all the time and individual-level influences on potential outcomes that are potentially correlated with treatment intake are additively separable.</p>
<div class="remark">
<p><span id="unlabeled-div-134" class="remark"><em>Remark</em>. </span>Borusyak, Jaravel and Speiss (2021) claim that Assumption <a href="NE.html#hyp:AdditiveSeparabilityFE">4.26</a> is equivalent to Assumption <a href="NE.html#hyp:ParallelTrendsTime">4.25</a> of parallel trends.
I think we still need a formal proof of that claim.</p>
</div>
<p>Borusyak, Jaravel and Speiss (2021) add another assumption, namely that error terms are homoskedastic:</p>
<div class="hypothesis">
<p><span id="hyp:HomoskedasticityFE" class="hypothesis"><strong>Hypothesis 4.27  (Homoskedasticity) </strong></span>We assume that the error terms are homoskedastic and mutually uncorrelated:</p>
<p><span class="math display">\[\begin{align*}
   \esp{U_0U_0&#39;} &amp; = \sigma^2\mathbf{I},
\end{align*}\]</span></p>
<p>with <span class="math inline">\(U_0\)</span> the vector of error terms and <span class="math inline">\(\mathbf{I}\)</span> the identity matrix of the coresponding dimension.</p>
</div>
<p>Under these assumptions, and the no-anticipation condition, Borusyak, Jaravel and Speiss (2021) prove a very powerful result:</p>
<div class="theorem">
<p><span id="thm:IdentDIDAggBJS" class="theorem"><strong>Theorem 4.21  (Imputation identifies Weighted TT) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentTime">4.23</a>, <a href="NE.html#hyp:NoAnticipationEffectsTime">4.24</a> and <a href="NE.html#hyp:AdditiveSeparabilityFE">4.26</a>, the imputation estimator is the unique efficient linear unbiased estimator of the corresponding weighted average of Treatment on the Treated:</p>
<p><span class="math display">\[\begin{align*}
    \sum w^{BJS_k}_{i,t}\hat\Delta^Y_{i,t} &amp; =  \Delta^{Y}_{TT}(BJS_k).
\end{align*}\]</span>
with
<span class="math display">\[\begin{align*}
    \Delta^{Y}_{TT}(BJS_k) &amp; = \sum w^k_{i,t}\Delta^Y_{i,t}
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-135" class="proof"><em>Proof</em>. </span>See Borusyak, Jaravel and Speiss (2021) Theorems 1 and 2.</p>
</div>
<p>Theorem <a href="NE.html#thm:IdentDIDAggBJS">4.21</a> is a pretty cool result.
It shows that, under the assumptions made so far, the imputation estimator is the most efficient way to combine observations in order to obtain DID estimates of the effect of the treatment.</p>
<div class="remark">
<p><span id="unlabeled-div-136" class="remark"><em>Remark</em>. </span>The “trick” that makes the Borusyak, Jaravel and Speiss (2021)’s imputation estimator more efficient than Sun and Abraham or Callaway and Sant’Anna’s estimators is that it combines all pre-treatment observations when generating the treatment effect estimate.
An open question is whether a weigthed average of the individual DID estimates, including all the ones formed using all pre-treatment observations as reference periods, is as efficient as Borusyak, Jaravel and Speiss (2021)’s imputation estimator.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-137" class="remark"><em>Remark</em>. </span>Borusyak, Jaravel and Speiss (2021) claim that Assumption <a href="NE.html#hyp:HomoskedasticityFE">4.27</a> can be relaxed to any known form of heteroskedasticity or autocorrelation and that Theorem <a href="NE.html#thm:IdentDIDAggBJS">4.21</a> would still hold.</p>
</div>
<p>How does Borusyak, Jaravel and Speiss (2021)’s imputation estimator work in practice?
Thanks to the amazing <a href="https://kylebutts.com/">Kyle Butts</a>, we have a package that computes Borusyak, Jaravel and Speiss (2021)’s imputation estimator, <code>didimputation</code>.
The command is <code>did_imputation</code>.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-247" class="example"><strong>Example 4.47  </strong></span>Let’s see how it works.</p>
</div>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="NE.html#cb224-1" tabindex="-1"></a><span class="co"># there is a tiny bug in the did_imputation code if you use &quot;y&quot; as the name of the outcome variable</span></span>
<span id="cb224-2"><a href="NE.html#cb224-2" tabindex="-1"></a><span class="co"># this is because it generates a bug in this line of code: yvars %&gt;% purrr::set_names(yvars) %&gt;% purrr::map(function(y) {data[, `:=`(zz000adj, .SD[[paste(&quot;zz000adj&quot;, y, sep = &quot;_&quot;)]])][zz000treat == 1, purrr::map(.SD, ~sum(. * zz000adj)), .SDcols = wtr]}) </span></span>
<span id="cb224-3"><a href="NE.html#cb224-3" tabindex="-1"></a><span class="co"># I therefore rename y as something else</span></span>
<span id="cb224-4"><a href="NE.html#cb224-4" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb224-5"><a href="NE.html#cb224-5" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb224-6"><a href="NE.html#cb224-6" tabindex="-1"></a>          <span class="at">yBJS =</span> y</span>
<span id="cb224-7"><a href="NE.html#cb224-7" tabindex="-1"></a>        )</span>
<span id="cb224-8"><a href="NE.html#cb224-8" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb224-9"><a href="NE.html#cb224-9" tabindex="-1"></a>reg.BJS <span class="ot">&lt;-</span> <span class="fu">did_imputation</span>(<span class="at">yname=</span><span class="st">&quot;yBJS&quot;</span>,<span class="at">tname=</span><span class="st">&quot;time&quot;</span>,<span class="at">idname=</span><span class="st">&quot;id&quot;</span>,<span class="at">gname=</span><span class="st">&quot;Group&quot;</span>,<span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>),<span class="at">horizon=</span><span class="cn">TRUE</span>,<span class="at">pretrends=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>Let us now plot the results:</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="NE.html#cb225-1" tabindex="-1"></a><span class="co"># preparing the results for the plot  </span></span>
<span id="cb225-2"><a href="NE.html#cb225-2" tabindex="-1"></a>DID.BJS <span class="ot">&lt;-</span> reg.BJS <span class="sc">%&gt;%</span></span>
<span id="cb225-3"><a href="NE.html#cb225-3" tabindex="-1"></a>            <span class="fu">rename</span>(</span>
<span id="cb225-4"><a href="NE.html#cb225-4" tabindex="-1"></a>              <span class="at">TimeToTreatment=</span>term,</span>
<span id="cb225-5"><a href="NE.html#cb225-5" tabindex="-1"></a>              <span class="at">Coef=</span>estimate,</span>
<span id="cb225-6"><a href="NE.html#cb225-6" tabindex="-1"></a>              <span class="at">Se=</span>std.error</span>
<span id="cb225-7"><a href="NE.html#cb225-7" tabindex="-1"></a>            ) <span class="sc">%&gt;%</span></span>
<span id="cb225-8"><a href="NE.html#cb225-8" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb225-9"><a href="NE.html#cb225-9" tabindex="-1"></a>              <span class="at">TimeToTreatment=</span><span class="fu">as.numeric</span>(TimeToTreatment)</span>
<span id="cb225-10"><a href="NE.html#cb225-10" tabindex="-1"></a>            )</span>
<span id="cb225-11"><a href="NE.html#cb225-11" tabindex="-1"></a><span class="co"># adding reference period</span></span>
<span id="cb225-12"><a href="NE.html#cb225-12" tabindex="-1"></a>DID.BJS[<span class="fu">nrow</span>(DID.BJS)<span class="sc">+</span><span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;yBJS&quot;</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb225-13"><a href="NE.html#cb225-13" tabindex="-1"></a></span>
<span id="cb225-14"><a href="NE.html#cb225-14" tabindex="-1"></a><span class="co">#plot</span></span>
<span id="cb225-15"><a href="NE.html#cb225-15" tabindex="-1"></a><span class="fu">ggplot</span>(DID.BJS,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef))<span class="sc">+</span></span>
<span id="cb225-16"><a href="NE.html#cb225-16" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb225-17"><a href="NE.html#cb225-17" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb225-18"><a href="NE.html#cb225-18" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb225-19"><a href="NE.html#cb225-19" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb225-20"><a href="NE.html#cb225-20" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb225-21"><a href="NE.html#cb225-21" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb225-22"><a href="NE.html#cb225-22" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredDisAggdBJS"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredDisAggdBJS-1.png" alt="DID estimates around the treatment date estimated using Borusyak, Jaravel and Speiss's procedure (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.36: DID estimates around the treatment date estimated using Borusyak, Jaravel and Speiss’s procedure (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>As Figure <a href="NE.html#fig:PlotDIDStaggeredDisAggdBJS">4.36</a> shows, the dynamic profile of the treatment effect estimated using Borusyak, Jaravel and Speiss’s procedure is very similar to the one obtained using Sun and Abraham and Callaway and Sant’Anna.</p>
<p>Let us finally estimate the average treatment effect on the treated using Borusyak, Jaravel and Speiss’s procedure:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="NE.html#cb226-1" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb226-2"><a href="NE.html#cb226-2" tabindex="-1"></a>reg.BJS.Agg <span class="ot">&lt;-</span> <span class="fu">did_imputation</span>(<span class="at">yname=</span><span class="st">&quot;yBJS&quot;</span>,<span class="at">tname=</span><span class="st">&quot;time&quot;</span>,<span class="at">idname=</span><span class="st">&quot;id&quot;</span>,<span class="at">gname=</span><span class="st">&quot;Group&quot;</span>,<span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>))</span></code></pre></div>
<p>The treatment effect estimated using Borusyak, Jaravel and Speiss’s estimator is equal to 1.08 <span class="math inline">\(\pm\)</span> 0.04.</p>
</div>
<div id="imputation-methods-gardner" class="section level5 hasAnchor" number="4.3.3.2.6">
<h5><span class="header-section-number">4.3.3.2.6</span> Imputation methods: Gardner<a href="NE.html#imputation-methods-gardner" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><a href="https://jrgcmu.github.io/">Gardner (2021)</a> proposes a two stage estimator very similar to the one by Borusyak, Jaravel and Speiss (2021).
Gardner writes outcomes for individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> as follows, with group and time fixed effects:</p>
<p><span class="math display">\[\begin{align*}
    Y_{i,t} &amp;  = \sum_{d=1}^{\infty}\lambda_d\uns{D_i=d} + \sum_{l=1}^T\delta_l\uns{l=t} + \sum_{d=1}^{\infty}\sum_{l=1}^T\beta^G_{d,l}\uns{D_i=d}\uns{l=t} + \epsilon^{G}_{i,t},
\end{align*}\]</span></p>
<p>where the groups are defined by the date at which they start receiving the treatment.
In practice, Gardner’s estimator works as follows:</p>
<ol style="list-style-type: decimal">
<li>Estimate the following model using OLS on the sample of observations for which <span class="math inline">\(D_{i,t}=0\)</span> (which excludes all the currently treated):</li>
</ol>
<p><span class="math display">\[\begin{align*}
    Y_{i,t} &amp;  = \sum_{d=2}^{\infty}\lambda_d\uns{D_i=d} + \sum_{l=1}^T\delta_l\uns{l=t} + \epsilon^{G}_{i,t}
\end{align*}\]</span></p>
<ol start="2" style="list-style-type: decimal">
<li>Regress the adjusted outcomes <span class="math inline">\(Y_{i,t}-\sum_{d=2}^{\infty}\hat\lambda_d\uns{D_i=d}-\sum_{l=1}^T\hat\delta_l\uns{l=t}\)</span> on <span class="math inline">\(D_{i,t}\)</span> and retain the coefficient <span class="math inline">\(\hat\beta^G\)</span>.
Note as well that one can also estimate the average effect of the treatment around each treatment date by regressing the adjusted outcomes on a set of dummies taking value one when observation <span class="math inline">\(i\)</span> at period <span class="math inline">\(t\)</span> is <span class="math inline">\(\tau\)</span> periods from the treatment (here, we omit the dummy for the never treated group and for one reference period, in general <span class="math inline">\(\tau=-1\)</span>).</li>
</ol>
<p>Gardner shows that the coefficient on <span class="math inline">\(D_{i,t}\)</span> in the second stage of this procedure (<span class="math inline">\(\hat\beta^G\)</span>) identifies the average effect of the treatment on the treated under the usual parallel trends assumptions: <span class="math inline">\(\beta^G=\esp{\Delta^Y_{i,t}|D_{i,t}=1}\)</span>, where <span class="math inline">\(\Delta^Y_{i,t}=Y^1_{i,t}-Y^0_{i,t}\)</span>.
What is pretty great is that Gardner, together with Kyle Butts, have provided an <code>R</code> package in order to perform the estimation: <code>did2s</code>.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-248" class="example"><strong>Example 4.48  </strong></span>Let’s see how it works in our example.</p>
</div>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="NE.html#cb227-1" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb227-2"><a href="NE.html#cb227-2" tabindex="-1"></a>reg.Gardner <span class="ot">&lt;-</span> <span class="fu">did2s</span>(<span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>),<span class="at">yname =</span> <span class="st">&quot;y&quot;</span>, <span class="at">first_stage =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">|</span> id <span class="sc">+</span> time,<span class="at">second_stage =</span> <span class="sc">~</span><span class="fu">i</span>(D, <span class="at">ref=</span><span class="cn">FALSE</span>), <span class="at">treatment =</span> <span class="st">&quot;D&quot;</span>,<span class="at">cluster_var =</span> <span class="st">&quot;id&quot;</span>)</span></code></pre></div>
<p>The overall estimated treatment effect is 1.08 <span class="math inline">\(\pm\)</span> 0.06.
This seems valid enough.
Now, <code>did2s</code> also provides a way to estimate the effect at each time period relative the treatment date (<em>a.k.a.</em> the event study estimates).</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="NE.html#cb228-1" tabindex="-1"></a><span class="co"># generating a TimeToTreatment variable</span></span>
<span id="cb228-2"><a href="NE.html#cb228-2" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb228-3"><a href="NE.html#cb228-3" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb228-4"><a href="NE.html#cb228-4" tabindex="-1"></a>            <span class="at">TimeToTreatment =</span> <span class="fu">if_else</span>(<span class="fu">abs</span>(time<span class="sc">-</span>Ds)<span class="sc">&lt;</span><span class="dv">90</span>,time<span class="sc">-</span>Ds,<span class="sc">-</span><span class="dv">99</span>)</span>
<span id="cb228-5"><a href="NE.html#cb228-5" tabindex="-1"></a>          )</span>
<span id="cb228-6"><a href="NE.html#cb228-6" tabindex="-1"></a></span>
<span id="cb228-7"><a href="NE.html#cb228-7" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb228-8"><a href="NE.html#cb228-8" tabindex="-1"></a>reg.Gardner.event.study <span class="ot">&lt;-</span> <span class="fu">did2s</span>(<span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>),<span class="at">yname =</span> <span class="st">&quot;y&quot;</span>, <span class="at">first_stage =</span> <span class="sc">~</span> <span class="dv">0</span> <span class="sc">|</span> id <span class="sc">+</span> time,<span class="at">second_stage =</span> <span class="sc">~</span><span class="fu">i</span>(TimeToTreatment, <span class="at">ref=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">99</span>)), <span class="at">treatment =</span> <span class="st">&quot;D&quot;</span>,<span class="at">cluster_var =</span> <span class="st">&quot;id&quot;</span>)</span></code></pre></div>
<p>Let us now plot the results:</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="NE.html#cb229-1" tabindex="-1"></a><span class="co"># putting results into a dataframe</span></span>
<span id="cb229-2"><a href="NE.html#cb229-2" tabindex="-1"></a>resultsGardnerEventStudy <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="fu">coef</span>(reg.Gardner.event.study),<span class="fu">se</span>(reg.Gardner.event.study)))</span>
<span id="cb229-3"><a href="NE.html#cb229-3" tabindex="-1"></a><span class="fu">colnames</span>(resultsGardnerEventStudy) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Coef&#39;</span>,<span class="st">&#39;Se&#39;</span>)</span>
<span id="cb229-4"><a href="NE.html#cb229-4" tabindex="-1"></a><span class="co"># adding the time to treatment variable</span></span>
<span id="cb229-5"><a href="NE.html#cb229-5" tabindex="-1"></a>resultsGardnerEventStudy <span class="ot">&lt;-</span> resultsGardnerEventStudy <span class="sc">%&gt;%</span></span>
<span id="cb229-6"><a href="NE.html#cb229-6" tabindex="-1"></a>                              <span class="fu">mutate</span>(</span>
<span id="cb229-7"><a href="NE.html#cb229-7" tabindex="-1"></a>                                <span class="at">TimeToTreatment =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb229-8"><a href="NE.html#cb229-8" tabindex="-1"></a>                              )</span>
<span id="cb229-9"><a href="NE.html#cb229-9" tabindex="-1"></a><span class="co"># adding the reference period</span></span>
<span id="cb229-10"><a href="NE.html#cb229-10" tabindex="-1"></a>resultsGardnerEventStudy <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsGardnerEventStudy,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb229-11"><a href="NE.html#cb229-11" tabindex="-1"></a></span>
<span id="cb229-12"><a href="NE.html#cb229-12" tabindex="-1"></a><span class="co">#plot</span></span>
<span id="cb229-13"><a href="NE.html#cb229-13" tabindex="-1"></a><span class="fu">ggplot</span>(resultsGardnerEventStudy,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef))<span class="sc">+</span></span>
<span id="cb229-14"><a href="NE.html#cb229-14" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb229-15"><a href="NE.html#cb229-15" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb229-16"><a href="NE.html#cb229-16" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb229-17"><a href="NE.html#cb229-17" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb229-18"><a href="NE.html#cb229-18" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb229-19"><a href="NE.html#cb229-19" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb229-20"><a href="NE.html#cb229-20" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDID2SEventStudy"></span>
<img src="STCI_files/figure-html/PlotDID2SEventStudy-1.png" alt="DID estimates around the treatment date estimated using Gardner's procedure (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.37: DID estimates around the treatment date estimated using Gardner’s procedure (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
</div>
<div id="imputation-methods-liu-wang-and-xu" class="section level5 hasAnchor" number="4.3.3.2.7">
<h5><span class="header-section-number">4.3.3.2.7</span> Imputation methods: Liu, Wang and Xu<a href="NE.html#imputation-methods-liu-wang-and-xu" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><a href="http://arxiv.org/abs/2107.00856">Liu, Wang and Xu (2021)</a> also propose a series of imputation estimators, with some very similar to the ones proposed by Borusyak, Jaravel and Speiss and by Gardner.
Their Proposition 1 is very close to Theorem <a href="NE.html#thm:IdentDIDAggBJS">4.21</a>, albeit they do not prove that their estimator is the most efficient among linear estimators.
They also propose an <code>R</code> package to estimate their estimators, <code>fect</code>.
I will come back to this package later, in Section <a href="#sec:OM"><strong>??</strong></a>, since most of the estimators they propose try to relax the parallel trends assumption.</p>
</div>
<div id="stacked-did" class="section level5 hasAnchor" number="4.3.3.2.8">
<h5><span class="header-section-number">4.3.3.2.8</span> Stacked DID<a href="NE.html#stacked-did" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The stacked DID approach has been proposed by <a href="https://academic.oup.com/qje/article/134/3/1405/5484905">Cengiz, Dube, Lindner and Zipperer (2019)</a> and extended by <a href="https://jrgcmu.github.io/2sdd_current.pdf">Gardner (2021)</a>.
For stacked DID, one creates a dataset for each group defined by its date of treatment, with all observations treated at that date and the ones that are not yet treated, one then stacks all these datasets together, and estimates a two-way fixed effects model with time <span class="math inline">\(\times\)</span> dataset specific fixed effects and individual fixed effects.
Gardner’s Appendix A show that this procedure yields a weighted average of group and time specific treatment effects, with weights that do not generally correspond to the ones of the ATT estimate, but that are positive and sum to one.
One issue I have with this approach is that it focuses only on cases where there are no <em>never treated</em> observations.
If we keep <em>never treated</em> observations in the stacked DID approach, they are going to be used multiple times and one certainly needs to account for that when estimating precision.</p>
<p>The way I’m choosing to implement this approach is by adding specific group <span class="math inline">\(\times\)</span> time dummies for all the members of a given group defined by its date of first treatment and all the not-yet-treated observations at that same date.
We are going to run a two-way fixed effects model on these fixed effects and on individual fixed effects as well as on treatment dummies.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-249" class="example"><strong>Example 4.49  </strong></span>Let’s see how it goes.</p>
</div>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="NE.html#cb230-1" tabindex="-1"></a><span class="co"># generating the groups x time dummies</span></span>
<span id="cb230-2"><a href="NE.html#cb230-2" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb230-3"><a href="NE.html#cb230-3" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb230-4"><a href="NE.html#cb230-4" tabindex="-1"></a>            <span class="at">FE.1.1 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-5"><a href="NE.html#cb230-5" tabindex="-1"></a>            <span class="at">FE.1.2 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-6"><a href="NE.html#cb230-6" tabindex="-1"></a>            <span class="at">FE.1.3 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-7"><a href="NE.html#cb230-7" tabindex="-1"></a>            <span class="at">FE.1.4 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">4</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-8"><a href="NE.html#cb230-8" tabindex="-1"></a>            <span class="at">FE.2.1 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-9"><a href="NE.html#cb230-9" tabindex="-1"></a>            <span class="at">FE.2.2 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-10"><a href="NE.html#cb230-10" tabindex="-1"></a>            <span class="at">FE.2.3 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-11"><a href="NE.html#cb230-11" tabindex="-1"></a>            <span class="at">FE.2.4 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">4</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">2</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-12"><a href="NE.html#cb230-12" tabindex="-1"></a>            <span class="at">FE.3.1 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">3</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-13"><a href="NE.html#cb230-13" tabindex="-1"></a>            <span class="at">FE.3.2 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">3</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-14"><a href="NE.html#cb230-14" tabindex="-1"></a>            <span class="at">FE.3.3 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">3</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-15"><a href="NE.html#cb230-15" tabindex="-1"></a>            <span class="at">FE.3.4 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">4</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">3</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-16"><a href="NE.html#cb230-16" tabindex="-1"></a>            <span class="at">FE.4.1 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">4</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-17"><a href="NE.html#cb230-17" tabindex="-1"></a>            <span class="at">FE.4.2 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">4</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-18"><a href="NE.html#cb230-18" tabindex="-1"></a>            <span class="at">FE.4.3 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">3</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">4</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb230-19"><a href="NE.html#cb230-19" tabindex="-1"></a>            <span class="at">FE.4.4 =</span> <span class="fu">if_else</span>(time <span class="sc">==</span><span class="dv">4</span> <span class="sc">&amp;</span> (Ds<span class="sc">==</span><span class="dv">4</span> <span class="sc">|</span> D<span class="sc">==</span><span class="dv">0</span>),<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb230-20"><a href="NE.html#cb230-20" tabindex="-1"></a>          )</span>
<span id="cb230-21"><a href="NE.html#cb230-21" tabindex="-1"></a></span>
<span id="cb230-22"><a href="NE.html#cb230-22" tabindex="-1"></a><span class="co"># regression for individual parameter</span></span>
<span id="cb230-23"><a href="NE.html#cb230-23" tabindex="-1"></a>reg.stacked.aggregate <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> D </span>
<span id="cb230-24"><a href="NE.html#cb230-24" tabindex="-1"></a>                                  <span class="sc">+</span> FE.<span class="fl">1.1</span> <span class="sc">+</span> FE.<span class="fl">1.2</span> <span class="sc">+</span> FE.<span class="fl">1.3</span> <span class="sc">+</span> FE.<span class="fl">1.4</span></span>
<span id="cb230-25"><a href="NE.html#cb230-25" tabindex="-1"></a>                                  <span class="sc">+</span> FE.<span class="fl">2.1</span> <span class="sc">+</span> FE.<span class="fl">2.2</span> <span class="sc">+</span> FE.<span class="fl">2.3</span> <span class="sc">+</span> FE.<span class="fl">2.4</span></span>
<span id="cb230-26"><a href="NE.html#cb230-26" tabindex="-1"></a>                                  <span class="sc">+</span> FE.<span class="fl">3.1</span> <span class="sc">+</span> FE.<span class="fl">3.2</span> <span class="sc">+</span> FE.<span class="fl">4.3</span> <span class="sc">+</span> FE.<span class="fl">4.4</span></span>
<span id="cb230-27"><a href="NE.html#cb230-27" tabindex="-1"></a>                               <span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>))</span>
<span id="cb230-28"><a href="NE.html#cb230-28" tabindex="-1"></a></span>
<span id="cb230-29"><a href="NE.html#cb230-29" tabindex="-1"></a><span class="co"># event study regression</span></span>
<span id="cb230-30"><a href="NE.html#cb230-30" tabindex="-1"></a>reg.stacked.event.study <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> <span class="fu">i</span>(TimeToTreatment,<span class="at">ref=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">99</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb230-31"><a href="NE.html#cb230-31" tabindex="-1"></a>                                  <span class="sc">+</span> FE.<span class="fl">1.1</span> <span class="sc">+</span> FE.<span class="fl">1.2</span> <span class="sc">+</span> FE.<span class="fl">1.3</span> <span class="sc">+</span> FE.<span class="fl">1.4</span></span>
<span id="cb230-32"><a href="NE.html#cb230-32" tabindex="-1"></a>                                  <span class="sc">+</span> FE.<span class="fl">2.1</span> <span class="sc">+</span> FE.<span class="fl">2.2</span> <span class="sc">+</span> FE.<span class="fl">2.3</span> <span class="sc">+</span> FE.<span class="fl">2.4</span></span>
<span id="cb230-33"><a href="NE.html#cb230-33" tabindex="-1"></a>                                  <span class="sc">+</span> FE.<span class="fl">3.1</span> <span class="sc">+</span> FE.<span class="fl">3.2</span> <span class="sc">+</span> FE.<span class="fl">4.3</span> <span class="sc">+</span> FE.<span class="fl">4.4</span></span>
<span id="cb230-34"><a href="NE.html#cb230-34" tabindex="-1"></a>                               <span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>))</span></code></pre></div>
<p>The total estimate given by the stacked regression is of 1.86, which seems pretty large compared to the other estimators.
Remember that the average effect of the treatment, giving equal weight to each time period <span class="math inline">\(\tau\in\{0,1,2\}\)</span>, is equal to <span class="math inline">\(\hat\Delta^{Y}_{TT}(e)=\)</span> 1.59 while the average effect of the treatment, giving weights proportional to group composition and time spent in the treatment is equal to <span class="math inline">\(\hat\Delta^{Y}_{TT}(v)=\)</span> 1.06.
Let us plot the corresponding results of the event study regression.</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="NE.html#cb231-1" tabindex="-1"></a><span class="co"># putting results into a dataframe</span></span>
<span id="cb231-2"><a href="NE.html#cb231-2" tabindex="-1"></a>resultsStackedDIDEventStudy <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(reg.stacked.event.study<span class="sc">$</span>coefficients[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],reg.stacked.event.study<span class="sc">$</span>se[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]))</span>
<span id="cb231-3"><a href="NE.html#cb231-3" tabindex="-1"></a><span class="fu">colnames</span>(resultsStackedDIDEventStudy) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Coef&#39;</span>,<span class="st">&#39;Se&#39;</span>)</span>
<span id="cb231-4"><a href="NE.html#cb231-4" tabindex="-1"></a><span class="co"># adding the time to treatment variable</span></span>
<span id="cb231-5"><a href="NE.html#cb231-5" tabindex="-1"></a>resultsStackedDIDEventStudy <span class="ot">&lt;-</span> resultsStackedDIDEventStudy <span class="sc">%&gt;%</span></span>
<span id="cb231-6"><a href="NE.html#cb231-6" tabindex="-1"></a>                              <span class="fu">mutate</span>(</span>
<span id="cb231-7"><a href="NE.html#cb231-7" tabindex="-1"></a>                                <span class="at">TimeToTreatment =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb231-8"><a href="NE.html#cb231-8" tabindex="-1"></a>                              )</span>
<span id="cb231-9"><a href="NE.html#cb231-9" tabindex="-1"></a><span class="co"># adding the reference period</span></span>
<span id="cb231-10"><a href="NE.html#cb231-10" tabindex="-1"></a>resultsStackedDIDEventStudy <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsStackedDIDEventStudy,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb231-11"><a href="NE.html#cb231-11" tabindex="-1"></a></span>
<span id="cb231-12"><a href="NE.html#cb231-12" tabindex="-1"></a><span class="co">#plot</span></span>
<span id="cb231-13"><a href="NE.html#cb231-13" tabindex="-1"></a><span class="fu">ggplot</span>(resultsStackedDIDEventStudy,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef))<span class="sc">+</span></span>
<span id="cb231-14"><a href="NE.html#cb231-14" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb231-15"><a href="NE.html#cb231-15" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb231-16"><a href="NE.html#cb231-16" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb231-17"><a href="NE.html#cb231-17" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb231-18"><a href="NE.html#cb231-18" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb231-19"><a href="NE.html#cb231-19" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb231-20"><a href="NE.html#cb231-20" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStackedEventStudy"></span>
<img src="STCI_files/figure-html/PlotDIDStackedEventStudy-1.png" alt="DID estimates around the treatment date estimated using Stacked DID (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.38: DID estimates around the treatment date estimated using Stacked DID (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>The results seem pretty nice and close to what we have obtained so far with the other methods we have used.</p>
</div>
<div id="two-way-fixed-effects" class="section level5 hasAnchor" number="4.3.3.2.9">
<h5><span class="header-section-number">4.3.3.2.9</span> Two-Way Fixed Effects<a href="NE.html#two-way-fixed-effects" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Before we conclude, there is one last set of methods that we might have wanted to use: the methods based on the standard Two Way Fixed Effects model with time and unit-specific fixed effects that we have introduced in Sections <a href="NE.html#sec:LSDV">4.3.1.2.4</a>, <a href="NE.html#sec:Within">4.3.1.2.5</a> and <a href="NE.html#sec:FastTWFE">4.3.1.2.6</a>, and which can be estimated using various types of methods (Least Squares Dummy Variables, Within regression or other fast methods).
Methods based on the Two Way Fixed Effects model were actually the most used ones to estimate treatment effects and event study regressions in staggered designs before a string of results showed that they had severe issues.
In this section, we will cover the basic issues that methods based on the Two Way Fixed Effects model face in a staggered design and we will state conditions under which they can be correct.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-250" class="example"><strong>Example 4.50  </strong></span>Before that, let us simply look at how the Two Way Fixed Effects model performs in our example.</p>
</div>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="NE.html#cb232-1" tabindex="-1"></a><span class="co"># regression for individual parameter</span></span>
<span id="cb232-2"><a href="NE.html#cb232-2" tabindex="-1"></a>reg.TWFE.aggregate <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> D <span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data=</span>data)</span>
<span id="cb232-3"><a href="NE.html#cb232-3" tabindex="-1"></a></span>
<span id="cb232-4"><a href="NE.html#cb232-4" tabindex="-1"></a><span class="co"># event study regression</span></span>
<span id="cb232-5"><a href="NE.html#cb232-5" tabindex="-1"></a>reg.TWFE.event.study <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> <span class="fu">i</span>(TimeToTreatment,<span class="at">ref=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">99</span>,<span class="sc">-</span><span class="dv">1</span>)) <span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data=</span>data)</span></code></pre></div>
<p>The Two Way Fixed Effects-based estimate of the aggregate treatment effect on the treated is equal to -0.08 <span class="math inline">\(\pm\)</span> 0.1, while the effect estimated the correct weighting of basic DID estimators giving weights proportional to group composition and time spent in the treatment is equal to <span class="math inline">\(\hat\Delta^{Y}_{TT}(v)=\)</span> 1.06.
Let us now plot the event study estimates obtained using Two Way Fixed Effects-based methods:</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="NE.html#cb233-1" tabindex="-1"></a><span class="co"># putting results into a dataframe</span></span>
<span id="cb233-2"><a href="NE.html#cb233-2" tabindex="-1"></a>resultsTWFEEventStudy <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(reg.TWFE.event.study<span class="sc">$</span>coefficients[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],reg.TWFE.event.study<span class="sc">$</span>se[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]))</span>
<span id="cb233-3"><a href="NE.html#cb233-3" tabindex="-1"></a><span class="fu">colnames</span>(resultsTWFEEventStudy) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Coef&#39;</span>,<span class="st">&#39;Se&#39;</span>)</span>
<span id="cb233-4"><a href="NE.html#cb233-4" tabindex="-1"></a><span class="co"># adding the time to treatment variable</span></span>
<span id="cb233-5"><a href="NE.html#cb233-5" tabindex="-1"></a>resultsTWFEEventStudy <span class="ot">&lt;-</span> resultsTWFEEventStudy <span class="sc">%&gt;%</span></span>
<span id="cb233-6"><a href="NE.html#cb233-6" tabindex="-1"></a>                              <span class="fu">mutate</span>(</span>
<span id="cb233-7"><a href="NE.html#cb233-7" tabindex="-1"></a>                                <span class="at">TimeToTreatment =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb233-8"><a href="NE.html#cb233-8" tabindex="-1"></a>                              )</span>
<span id="cb233-9"><a href="NE.html#cb233-9" tabindex="-1"></a><span class="co"># adding the reference period</span></span>
<span id="cb233-10"><a href="NE.html#cb233-10" tabindex="-1"></a>resultsTWFEEventStudy <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsTWFEEventStudy,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb233-11"><a href="NE.html#cb233-11" tabindex="-1"></a></span>
<span id="cb233-12"><a href="NE.html#cb233-12" tabindex="-1"></a><span class="co">#plot</span></span>
<span id="cb233-13"><a href="NE.html#cb233-13" tabindex="-1"></a><span class="fu">ggplot</span>(resultsTWFEEventStudy,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef))<span class="sc">+</span></span>
<span id="cb233-14"><a href="NE.html#cb233-14" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb233-15"><a href="NE.html#cb233-15" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb233-16"><a href="NE.html#cb233-16" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-17"><a href="NE.html#cb233-17" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-18"><a href="NE.html#cb233-18" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb233-19"><a href="NE.html#cb233-19" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb233-20"><a href="NE.html#cb233-20" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDTWFEEventStudy"></span>
<img src="STCI_files/figure-html/PlotDIDTWFEEventStudy-1.png" alt="DID estimates around the treatment date estimated using TWFE (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.39: DID estimates around the treatment date estimated using TWFE (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Surprisingly, the profile of the event-study estimates does not seem to be too different from the ones we have estimated before.
What has happened?
Why would the aggregate estimate be so wrong and the event-study estimate correct?
Let us dig into the technical properties of the Two Way Fixed Effects-based estimators in order to understand why.
We are first going to look at the properties of the Two Way Fixed Effects-based estimators for the average effect of the treatment on the treated and then we will look at the properties of the event study estimates.</p>
<div id="bias-of-the-two-way-fixed-effects-based-estimators-for-the-average-treatment-effect-on-the-treated" class="section level6 hasAnchor" number="4.3.3.2.9.1">
<h6><span class="header-section-number">4.3.3.2.9.1</span> Bias of the Two Way Fixed Effects-based estimators for the Average Treatment Effect on the Treated<a href="NE.html#bias-of-the-two-way-fixed-effects-based-estimators-for-the-average-treatment-effect-on-the-treated" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The properties of the Two Way Fixed Effects-based estimators have been studied in detail by <a href="https://doi.org/10.1016/j.jeconom.2021.03.014">Goodman-Bacon (2021)</a>.
In order to state Goodman-Bacon’s main result, we are going to consider that there are only three time periods in the data: a <span class="math inline">\(t=pre\)</span> time period, where no one is treated, a <span class="math inline">\(t=mid\)</span> time period, where only early adopters are treated (those with <span class="math inline">\(D_i=mid\)</span>) and finally a <span class="math inline">\(t=last\)</span> time period, where a second group receives the treatment.
We also allow for some units to be never treated, and we denote them with <span class="math inline">\(D_i=u\)</span>.
We denote <span class="math inline">\(n_d=\frac{\sum_i\uns{D_i=d}}{N}\)</span>, with <span class="math inline">\(d\in\{u,mid,last\}\)</span> the share of each treatment group in the sample and <span class="math inline">\(\bar{D}_d\)</span> the share of time each group spends in the treament state.
In this setting, <a href="https://doi.org/10.1016/j.jeconom.2021.03.014">Goodman-Bacon (2021)</a> proves the following theorem:</p>
<div class="theorem">
<p><span id="thm:GBDecomp" class="theorem"><strong>Theorem 4.22  (Goodman-Bacon Decomposition of Two Way Fixed Effects-based estimators) </strong></span>The parameter <span class="math inline">\(\hat\beta^{TWFE}\)</span> estimated by Two Way Fixed Effects-based estimators can be written as follows:
<span class="math display">\[\begin{align*}
  \hat\beta^{TWFE} &amp; =            w^{TWFE}_u(mid)\Delta^Y_{DID}(mid,u,mid,pre) \\
                  &amp; \phantom{=} + w^{TWFE}_u(mid)\Delta^Y_{DID}(mid,u,last,pre) \\
                  &amp; \phantom{=} + w^{TWFE}_u(last)\Delta^Y_{DID}(last,u,last,pre) \\
                  &amp; \phantom{=} + w^{TWFE}_u(last)\Delta^Y_{DID}(last,u,last,mid) \\
                  &amp; \phantom{=} + w^{TWFE}_{last}(mid)\Delta^Y_{DID}(mid,last,mid,pre)\\
                  &amp; \phantom{=} + w^{TWFE}_r(last,mid)\Delta^Y_{DID^r}(last,mid,last,mid)
\end{align*}\]</span>
with
<span class="math display">\[\begin{align*}
  \Delta^Y_{DID}(d,d&#39;,\tau,\tau&#39;)  &amp; = \esp{Y_{i,\tau}-Y_{i,\tau&#39;}|D_i=d}-\esp{Y_{i,\tau}-Y_{i,\tau&#39;}|D_i=d&#39;}\\
  w^{TWFE}_u(d) &amp; = (n_{d}+n_{u})^2\frac{\hat V^{D}_{d,u}}{\hat V^{D}}\text{, }d\in\{mid,last\}\\
  w^{TWFE}_{last}(mid) &amp; = ((n_{last}+n_{mid})(1-\bar{D}_{last}))^2\frac{\hat V^{D}_{mid,last}}{\hat V^{D}}\\
  w^{TWFE}_{r}(last,mid) &amp; = ((n_{last}+n_{mid})\bar{D}_{mid}^2\frac{\hat V^{D}_{last,mid}}{\hat V^{D}}\\
  \hat V^{D}_{d,u} &amp; = n_{d,u}(1-n_{d,u})\bar{D}_{d}(1-\bar{D}_{d})\text{, }d\in\{mid,last\} \\
  \hat V^{D}_{mid,last} &amp; = n_{mid,last}(1-n_{mid,last})\frac{\bar{D}_{mid}-\bar{D}_{last}}{1-\bar{D}_{last}}\frac{1-\bar{D}_{mid}}{1-\bar{D}_{last}}\\
  \hat V^{D}_{last,mid} &amp; = n_{mid,last}(1-n_{mid,last})\frac{\bar{D}_{last}}{\bar{D}_{mid}}\frac{\bar{D}_{mid}-\bar{D}_{last}}{\bar{D}_{mid}}\\
    n_{d,d&#39;} &amp; = \frac{n_d}{n_d+n_d&#39;}
\end{align*}\]</span>
and <span class="math inline">\(\sum_{d,d&#39;}w^{TWFE}(d,d&#39;)=1\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-138" class="proof"><em>Proof</em>. </span>See <a href="https://doi.org/10.1016/j.jeconom.2021.03.014">Goodman-Bacon (2021)</a> Theorem 1.</p>
</div>
<p>The beauty of Goodman-Bacon’s theorem is that it relates directly the Two Way Fixed Effects-based estimators to the individual two-period DID estimators we have studied in Section <a href="NE.html#sec:DIDbasic">4.3.1</a>.
The key to understand the bias of the Two Way Fixed Effects-based estimators is that the <span class="math inline">\(DID^r\)</span> estimator we studied in Section <a href="NE.html#sec:DIDr">4.3.2</a> appears in Goodman-Bacon’s decomposition.
This is because units with <span class="math inline">\(D_i=mid\)</span> become always treated observations for the last two periods.
They are used as counterfactuals by the Two Way Fixed Effects-based estimators for the observations that enter in the last period.
We have shown with Theorem <a href="NE.html#thm:BiasDIDr">4.15</a> that, under the classical parallel trends assumption, the <span class="math inline">\(DID^r\)</span> estimator is biased for the treatment effect on the treated after the treatment takes place.
The bias is equal to minus the change over time in treatment effect on the treated.
It means that if treatment effects increase over time, the <span class="math inline">\(DID^r\)</span> estimator will introduce a negative bias in the Two Way Fixed Effects-based estimators.
In our example, this bias is made even more severe by the fact that we have an always treated group, which is used at every period as a counterfactual.
Since the effect for the always treated group increases very fast over time, the bias of the <span class="math inline">\(DID^r\)</span> estimator becomes large and negative.</p>
<div class="remark">
<p><span id="unlabeled-div-139" class="remark"><em>Remark</em>. </span>If the treatment effects are constant over time (but possibly heterogeneous across groups), then the bias due to the <span class="math inline">\(DID^r\)</span> disappears, as Lemma <a href="NE.html#lem:ParallelTrendsCstTreatmentEffects">4.5</a> shows, and the Two Way Fixed Effects-based estimators recover a weighted average of treatment effects, with positive weights summing to one.
The problem with the Two Way Fixed Effects-based estimators is still that the weights used to combine the various treatment effects are not easy to interpret.
One probably prefers using tailor-made weights as in the estimators we have studied previously.</p>
</div>
<p><strong>Add corollary showing that TWFE is consistent under constant treatment effects over time</strong></p>
</div>
<div id="sec:BiasTWFEevent" class="section level6 hasAnchor" number="4.3.3.2.9.2">
<h6><span class="header-section-number">4.3.3.2.9.2</span> Bias of the Two Way Fixed Effects-based estimators for the event study estimates<a href="NE.html#sec:BiasTWFEevent" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The properties of the Two Way Fixed Effects-based estimators for event study parameters have been studied in detail by <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">Sun and Abraham (2021)</a>.
They focus on the following Two Way Fixed Effects model of an event-study analysis:</p>
<p><span class="math display">\[\begin{align*}
    Y_{i,t} &amp;  = \mu_i + \delta_t + \sum_{g\in\mathcal{G}}\beta_{\mathcal{g}}^{TWFE}\uns{t-D_{i}\in g} + \epsilon^{TWFE}_{i,t},
\end{align*}\]</span></p>
<p>where the set <span class="math inline">\(\mathcal{G}\)</span> collects disjoint sets <span class="math inline">\(g\)</span> of relative time periods <span class="math inline">\(\tau\in\{-T,\dots,T\}\)</span>, and excludes some of them.
The excluded sets of time periods are collected in a set <span class="math inline">\(g_{excl}\)</span>.
The most classical specification corresponding to the general case above uses as sets <span class="math inline">\(g\)</span>:</p>
<ul>
<li>Observations that are such that <span class="math inline">\(-K\leq t-D_i \leq-2\)</span>, with one specific indicator for each of the individual relative time periods <span class="math inline">\(\tau=t-D_i\)</span>,</li>
<li>Observations that are such that <span class="math inline">\(0\leq t-D_i \leq L\)</span>, with one specific indicator for each of the individual relative time periods,</li>
<li>All the observations that will be treated more than <span class="math inline">\(K\)</span> periods in the future (<span class="math inline">\(t-D_{i}&lt;-K\)</span>),</li>
<li>All the observations that are such that <span class="math inline">\(t-D_i&gt;L\)</span>.</li>
</ul>
<p>In general, <span class="math inline">\(g_{excl}=\{-1,-\infty\}\)</span>, so that the reference period with respect to which all treatment effects are estimated is the period just before the treatment.
By convention, <span class="math inline">\(\uns{t-D_{i}=-\infty}=0\)</span>.
Note that this is the specification we have adopted in most of our numerical examples so far, without using the strategy of binning together far away observations on both sides of the treatment date.</p>
<p>In this setting, Sun and Abraham prove the following result:</p>
<div class="theorem">
<p><span id="thm:SADecomp" class="theorem"><strong>Theorem 4.23  (Sun and Abraham Decomposition of Two Way Fixed Effects-based event-study estimators) </strong></span>The parameter <span class="math inline">\(\beta_{g}^{TWFE}\)</span> estimated by Two Way Fixed Effects-based event-study estimators can be written as follows:
<span class="math display">\[\begin{align*}
  \beta_{g}^{TWFE} &amp; = \sum_{\tau\in g}\sum_dw^{g}_{d,\tau}\Delta^Y_{DID}(d,\infty,\tau,-d+1) \\
                             &amp; \phantom{=} + \sum_{g&#39;\neq g,g&#39;\in g}\sum_{\tau\in g&#39;}\sum_d w^{g}_{d,\tau}\Delta^Y_{DID}(d,\infty,\tau,-d+1) \\
                             &amp; \phantom{=} + \sum_{\tau\in g_{excl}}\sum_d w^{g}_{d,\tau}\Delta^Y_{DID}(d,\infty,\tau,-d+1),
\end{align*}\]</span>
where the weights <span class="math inline">\(w^{g}_{d,\tau}\)</span> are equal to the population regression coefficients on <span class="math inline">\(\uns{t-D_{i}\in g}\)</span> from regressing <span class="math inline">\(\uns{t-D_{i}=\tau}\uns{D_{i}=d}\)</span> on time and individual fixed effects and all bin indicators <span class="math inline">\(\{\uns{t-D_{i}\in g}\}_{g\in g}\)</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-140" class="proof"><em>Proof</em>. </span>See <a href="https://doi.org/10.1016/j.jeconom.2020.09.006">Sun and Abraham (2021)</a> Proposition 1.</p>
</div>
<p>Theorem <a href="NE.html#thm:SADecomp">4.23</a> shows that the coefficient <span class="math inline">\(\beta_{g}^{TWFE}\)</span> in the TWFE event-study regression does not only capture the DID estimate at that period, but also the DID estimates at other periods <span class="math inline">\(g&#39;\)</span> and at the reference periods <span class="math inline">\(g_{excl}\)</span>.
This is potentially a severe problem.
For example, estimates of the effect pre-treatment can appear large and positive whereas the effect at these dates is actually zero.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-254" class="example"><strong>Example 4.51  </strong></span>In our numerical example, we have already seen that the TWFE event-study estimator is not severely biased for the event study coefficients.
We are going to use an example from <a href="https://andrewcbaker.netlify.app/2020/06/27/how-to-create-relative-time-indicators/">Andrew Baker</a> in order to illustrate the bias of the TWFE event-study estimator and try to understand its sources.</p>
</div>
<p>The data-generating process is:</p>
<p><span class="math display">\[\begin{align*}
  y_{i,t} &amp; = \mu_i + \delta_t + \tau_{i,t} + \epsilon_{i,t},
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\mu_i\sim\mathcal{N}(0,1)\)</span>, <span class="math inline">\(\delta_t\sim\mathcal{N}(0,1)\)</span> and <span class="math inline">\(\epsilon_{i,t}\sim\mathcal{N}(0,0.25)\)</span>.</p>
<p>The <span class="math inline">\(N=1000\)</span> inits (firms) are randomly allocated to 40 states <span class="math inline">\(g\)</span>, and each state is randommly allocated to one of four treatment groups depending on the year in which it is treated (<span class="math inline">\(\tau_g\in\{1986,1992,1998,2004\}\)</span>).
For every unit incorporated in a treated state, we draw a unit specific treatment effect <span class="math inline">\(\tau_i\sim\mathcal{N}(0.3,(1/5)^2)\)</span>, and the cumulated treatment effect for unit <span class="math inline">\(i\)</span> is <span class="math inline">\(\tau_{i,t}=\tau_i(t-\tau_g+1)\)</span>.</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="NE.html#cb234-1" tabindex="-1"></a><span class="co"># set seed</span></span>
<span id="cb234-2"><a href="NE.html#cb234-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20200403</span>)</span>
<span id="cb234-3"><a href="NE.html#cb234-3" tabindex="-1"></a><span class="co"># Fixed Effects ------------------------------------------------</span></span>
<span id="cb234-4"><a href="NE.html#cb234-4" tabindex="-1"></a><span class="co"># unit fixed effects</span></span>
<span id="cb234-5"><a href="NE.html#cb234-5" tabindex="-1"></a>unit <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb234-6"><a href="NE.html#cb234-6" tabindex="-1"></a><span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, </span>
<span id="cb234-7"><a href="NE.html#cb234-7" tabindex="-1"></a><span class="at">unit_fe =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb234-8"><a href="NE.html#cb234-8" tabindex="-1"></a><span class="co"># generate state</span></span>
<span id="cb234-9"><a href="NE.html#cb234-9" tabindex="-1"></a><span class="at">state =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">40</span>, <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb234-10"><a href="NE.html#cb234-10" tabindex="-1"></a><span class="co"># generate treatment effect</span></span>
<span id="cb234-11"><a href="NE.html#cb234-11" tabindex="-1"></a><span class="at">mu =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>))</span>
<span id="cb234-12"><a href="NE.html#cb234-12" tabindex="-1"></a></span>
<span id="cb234-13"><a href="NE.html#cb234-13" tabindex="-1"></a><span class="co"># year fixed effects </span></span>
<span id="cb234-14"><a href="NE.html#cb234-14" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb234-15"><a href="NE.html#cb234-15" tabindex="-1"></a><span class="at">year =</span> <span class="dv">1980</span><span class="sc">:</span><span class="dv">2010</span>,</span>
<span id="cb234-16"><a href="NE.html#cb234-16" tabindex="-1"></a><span class="at">year_fe =</span> <span class="fu">rnorm</span>(<span class="dv">31</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb234-17"><a href="NE.html#cb234-17" tabindex="-1"></a></span>
<span id="cb234-18"><a href="NE.html#cb234-18" tabindex="-1"></a><span class="co"># Trend Break -------------------------------------------------------------</span></span>
<span id="cb234-19"><a href="NE.html#cb234-19" tabindex="-1"></a><span class="co"># Put the states into treatment groups</span></span>
<span id="cb234-20"><a href="NE.html#cb234-20" tabindex="-1"></a>treat_taus <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb234-21"><a href="NE.html#cb234-21" tabindex="-1"></a>  <span class="co"># sample the states randomly</span></span>
<span id="cb234-22"><a href="NE.html#cb234-22" tabindex="-1"></a>  <span class="at">state =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">40</span>, <span class="dv">40</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>),</span>
<span id="cb234-23"><a href="NE.html#cb234-23" tabindex="-1"></a>  <span class="co"># place the randomly sampled states into five treatment groups G_g</span></span>
<span id="cb234-24"><a href="NE.html#cb234-24" tabindex="-1"></a>  <span class="at">cohort_year =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1986</span>, <span class="dv">1992</span>, <span class="dv">1998</span>, <span class="dv">2004</span>), <span class="dv">10</span>)))</span>
<span id="cb234-25"><a href="NE.html#cb234-25" tabindex="-1"></a></span>
<span id="cb234-26"><a href="NE.html#cb234-26" tabindex="-1"></a><span class="co"># make main dataset</span></span>
<span id="cb234-27"><a href="NE.html#cb234-27" tabindex="-1"></a><span class="co"># full interaction of unit X year </span></span>
<span id="cb234-28"><a href="NE.html#cb234-28" tabindex="-1"></a>data.baker <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="at">year =</span> <span class="dv">1980</span><span class="sc">:</span><span class="dv">2010</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb234-29"><a href="NE.html#cb234-29" tabindex="-1"></a>  <span class="fu">left_join</span>(., unit) <span class="sc">%&gt;%</span> </span>
<span id="cb234-30"><a href="NE.html#cb234-30" tabindex="-1"></a>  <span class="fu">left_join</span>(., year) <span class="sc">%&gt;%</span> </span>
<span id="cb234-31"><a href="NE.html#cb234-31" tabindex="-1"></a>  <span class="fu">left_join</span>(., treat_taus) <span class="sc">%&gt;%</span> </span>
<span id="cb234-32"><a href="NE.html#cb234-32" tabindex="-1"></a>  <span class="co"># make error term and get treatment indicators and treatment effects</span></span>
<span id="cb234-33"><a href="NE.html#cb234-33" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error =</span> <span class="fu">rnorm</span>(<span class="dv">31000</span>, <span class="dv">0</span>, <span class="fl">0.5</span>),</span>
<span id="cb234-34"><a href="NE.html#cb234-34" tabindex="-1"></a>         <span class="at">treat =</span> <span class="fu">ifelse</span>(year <span class="sc">&gt;=</span> cohort_year, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb234-35"><a href="NE.html#cb234-35" tabindex="-1"></a>         <span class="at">tau =</span> <span class="fu">ifelse</span>(treat <span class="sc">==</span> <span class="dv">1</span>, mu, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb234-36"><a href="NE.html#cb234-36" tabindex="-1"></a>  <span class="co"># calculate cumulative treatment effects</span></span>
<span id="cb234-37"><a href="NE.html#cb234-37" tabindex="-1"></a>  <span class="fu">group_by</span>(unit) <span class="sc">%&gt;%</span> </span>
<span id="cb234-38"><a href="NE.html#cb234-38" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tau_cum =</span> <span class="fu">cumsum</span>(tau)) <span class="sc">%&gt;%</span> </span>
<span id="cb234-39"><a href="NE.html#cb234-39" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb234-40"><a href="NE.html#cb234-40" tabindex="-1"></a>  <span class="co"># calculate the dep variable</span></span>
<span id="cb234-41"><a href="NE.html#cb234-41" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dep_var =</span> unit_fe <span class="sc">+</span> year_fe <span class="sc">+</span> tau_cum <span class="sc">+</span> error)</span></code></pre></div>
<p>Let’s plot the data now:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="NE.html#cb235-1" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb235-2"><a href="NE.html#cb235-2" tabindex="-1"></a>plot <span class="ot">&lt;-</span> data.baker <span class="sc">%&gt;%</span> </span>
<span id="cb235-3"><a href="NE.html#cb235-3" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> dep_var, <span class="at">group =</span> unit)) <span class="sc">+</span> </span>
<span id="cb235-4"><a href="NE.html#cb235-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">8</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span> </span>
<span id="cb235-5"><a href="NE.html#cb235-5" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> data.baker <span class="sc">%&gt;%</span> </span>
<span id="cb235-6"><a href="NE.html#cb235-6" tabindex="-1"></a>              <span class="fu">group_by</span>(cohort_year, year) <span class="sc">%&gt;%</span> </span>
<span id="cb235-7"><a href="NE.html#cb235-7" tabindex="-1"></a>              <span class="fu">summarize</span>(<span class="at">dep_var =</span> <span class="fu">mean</span>(dep_var)),</span>
<span id="cb235-8"><a href="NE.html#cb235-8" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> dep_var, <span class="at">group =</span> <span class="fu">factor</span>(cohort_year),</span>
<span id="cb235-9"><a href="NE.html#cb235-9" tabindex="-1"></a>                <span class="at">color =</span> <span class="fu">factor</span>(cohort_year)),</span>
<span id="cb235-10"><a href="NE.html#cb235-10" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb235-11"><a href="NE.html#cb235-11" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Value&quot;</span>) <span class="sc">+</span> </span>
<span id="cb235-12"><a href="NE.html#cb235-12" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1986</span>, <span class="at">color =</span> <span class="st">&#39;#E41A1C&#39;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb235-13"><a href="NE.html#cb235-13" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1992</span>, <span class="at">color =</span> <span class="st">&#39;#377EB8&#39;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb235-14"><a href="NE.html#cb235-14" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1998</span>, <span class="at">color =</span> <span class="st">&#39;#4DAF4A&#39;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb235-15"><a href="NE.html#cb235-15" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">2004</span>, <span class="at">color =</span> <span class="st">&#39;#984EA3&#39;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb235-16"><a href="NE.html#cb235-16" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">&#39;Set1&#39;</span>) <span class="sc">+</span> </span>
<span id="cb235-17"><a href="NE.html#cb235-17" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&#39;bottom&#39;</span>,</span>
<span id="cb235-18"><a href="NE.html#cb235-18" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb235-19"><a href="NE.html#cb235-19" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb235-20"><a href="NE.html#cb235-20" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>))</span>
<span id="cb235-21"><a href="NE.html#cb235-21" tabindex="-1"></a></span>
<span id="cb235-22"><a href="NE.html#cb235-22" tabindex="-1"></a>plot</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDBaker"></span>
<img src="STCI_files/figure-html/PlotDIDBaker-1.png" alt="Average outcomes in Baker's dataset" width="50%" />
<p class="caption">
Figure 4.40: Average outcomes in Baker’s dataset
</p>
</div>
<p>Let’s estimate an event-study regression on this data:</p>
<p><span class="math display">\[\begin{align*}
  y_{i,t} &amp; = \mu_i + \delta_t + \sum_{k\neq -1}\beta_k1\{D^k_{i,t}=k\} + \epsilon_{i,t},
\end{align*}\]</span></p>
<p>where <span class="math inline">\(D^k_{i,t}\)</span> measures the time to treatment.
In practice, we bin together all the treated observations that are treated more than 5 time periods ahead and, in a separate dummy, all the observations that have been treated more than 5 time periods before.
Let’s run the regression (note that Andrew Baker uses the <code>felm</code> function of the <code>lfe</code> package instead of the <code>feols</code> function of the <code>fixest</code> package that we have prefentially used):</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="NE.html#cb236-1" tabindex="-1"></a><span class="co"># variables we will use</span></span>
<span id="cb236-2"><a href="NE.html#cb236-2" tabindex="-1"></a>keepvars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;`rel_year_-5`&quot;</span>,  <span class="st">&quot;`rel_year_-4`&quot;</span>,  <span class="st">&quot;`rel_year_-3`&quot;</span>,  <span class="st">&quot;`rel_year_-2`&quot;</span>,</span>
<span id="cb236-3"><a href="NE.html#cb236-3" tabindex="-1"></a>               <span class="st">&quot;rel_year_0&quot;</span>, <span class="st">&quot;rel_year_1&quot;</span>, <span class="st">&quot;rel_year_2&quot;</span>, <span class="st">&quot;rel_year_3&quot;</span>, <span class="st">&quot;rel_year_4&quot;</span>, <span class="st">&quot;rel_year_5&quot;</span>)</span>
<span id="cb236-4"><a href="NE.html#cb236-4" tabindex="-1"></a></span>
<span id="cb236-5"><a href="NE.html#cb236-5" tabindex="-1"></a><span class="co"># make dummy columns</span></span>
<span id="cb236-6"><a href="NE.html#cb236-6" tabindex="-1"></a>data.baker <span class="ot">&lt;-</span> data.baker <span class="sc">%&gt;%</span> </span>
<span id="cb236-7"><a href="NE.html#cb236-7" tabindex="-1"></a>    <span class="co"># make dummies</span></span>
<span id="cb236-8"><a href="NE.html#cb236-8" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rel_year =</span> year <span class="sc">-</span> cohort_year) <span class="sc">%&gt;%</span> </span>
<span id="cb236-9"><a href="NE.html#cb236-9" tabindex="-1"></a>    <span class="fu">dummy_cols</span>(<span class="at">select_columns =</span> <span class="st">&quot;rel_year&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb236-10"><a href="NE.html#cb236-10" tabindex="-1"></a>    <span class="co"># generate pre and post dummies</span></span>
<span id="cb236-11"><a href="NE.html#cb236-11" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">Pre =</span> <span class="fu">ifelse</span>(rel_year <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb236-12"><a href="NE.html#cb236-12" tabindex="-1"></a>            <span class="at">Post =</span> <span class="fu">ifelse</span>(rel_year <span class="sc">&gt;</span> <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb236-13"><a href="NE.html#cb236-13" tabindex="-1"></a>  </span>
<span id="cb236-14"><a href="NE.html#cb236-14" tabindex="-1"></a><span class="co"># estimate the model</span></span>
<span id="cb236-15"><a href="NE.html#cb236-15" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">felm</span>(dep_var <span class="sc">~</span> Pre <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_-5</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_-4</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_-3</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_-2</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb236-16"><a href="NE.html#cb236-16" tabindex="-1"></a>                <span class="st">`</span><span class="at">rel_year_0</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_1</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_2</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_3</span><span class="st">`</span> <span class="sc">+</span> <span class="st">`</span><span class="at">rel_year_4</span><span class="st">`</span> <span class="sc">+</span> </span>
<span id="cb236-17"><a href="NE.html#cb236-17" tabindex="-1"></a>                <span class="st">`</span><span class="at">rel_year_5</span><span class="st">`</span> <span class="sc">+</span> Post <span class="sc">|</span> unit <span class="sc">+</span> year <span class="sc">|</span> <span class="dv">0</span> <span class="sc">|</span> state, <span class="at">data =</span> data.baker, <span class="at">exactDOF =</span> <span class="cn">TRUE</span>)</span>
<span id="cb236-18"><a href="NE.html#cb236-18" tabindex="-1"></a>  </span>
<span id="cb236-19"><a href="NE.html#cb236-19" tabindex="-1"></a><span class="co"># grab the obs we need</span></span>
<span id="cb236-20"><a href="NE.html#cb236-20" tabindex="-1"></a>DIDBakerEstimTWFEBinned <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(mod) <span class="sc">%&gt;%</span> </span>
<span id="cb236-21"><a href="NE.html#cb236-21" tabindex="-1"></a>    <span class="fu">filter</span>(term <span class="sc">%in%</span> keepvars) <span class="sc">%&gt;%</span> </span>
<span id="cb236-22"><a href="NE.html#cb236-22" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:-</span><span class="dv">2</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb236-23"><a href="NE.html#cb236-23" tabindex="-1"></a>    <span class="fu">select</span>(t, estimate,std.error) <span class="sc">%&gt;%</span></span>
<span id="cb236-24"><a href="NE.html#cb236-24" tabindex="-1"></a>    <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">t =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">estimate =</span> <span class="dv">0</span>, <span class="at">std.error =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb236-25"><a href="NE.html#cb236-25" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">true_tau =</span> <span class="fu">ifelse</span>(t <span class="sc">&gt;=</span> <span class="dv">0</span>, (t <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">*</span>.<span class="dv">3</span>, <span class="dv">0</span>))</span></code></pre></div>
<p>Let us now plot the results estimates:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="NE.html#cb237-1" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> estimate),<span class="at">data=</span>DIDBakerEstimTWFEBinned) <span class="sc">+</span> </span>
<span id="cb237-2"><a href="NE.html#cb237-2" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> estimate<span class="fl">-1.96</span><span class="sc">*</span>std.error, <span class="at">ymax =</span> estimate<span class="fl">+1.96</span><span class="sc">*</span>std.error), <span class="at">color =</span> <span class="st">&#39;darkgrey&#39;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb237-3"><a href="NE.html#cb237-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">&#39;blue&#39;</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb237-4"><a href="NE.html#cb237-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> true_tau), <span class="at">color =</span> <span class="st">&#39;red&#39;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb237-5"><a href="NE.html#cb237-5" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb237-6"><a href="NE.html#cb237-6" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb237-7"><a href="NE.html#cb237-7" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Relative Time&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Estimate&quot;</span>) <span class="sc">+</span> </span>
<span id="cb237-8"><a href="NE.html#cb237-8" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb237-9"><a href="NE.html#cb237-9" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDBakerEstimTWFEBinned"></span>
<img src="STCI_files/figure-html/PlotDIDBakerEstimTWFEBinned-1.png" alt="Binned Two Way Fixed Effects estimator in Baker's dataset" width="50%" />
<p class="caption">
Figure 4.41: Binned Two Way Fixed Effects estimator in Baker’s dataset
</p>
</div>
<p>The true estimates (in red) appear to have been severely misestimated by the TWFE binned estimator.
The pre-trends, which are parallel in the generated data, appear to be affected by a downward slope with the Two Way Fixed Effects estimator.
The treatment effects do not increase continuously over time, as they should, and they are most of the time biased downwards.</p>
<p>There are two main problems with the event-study model estimated with the TWFE estimator on the data plotted in Figure <a href="NE.html#fig:PlotDIDBaker">4.40</a>:</p>
<ol style="list-style-type: decimal">
<li>The binned treatment groups, especially the post treatment group, that regroups all observations that have been in the treatment for more than 5 years, does not move after once has entered it.
It thus serves as a control group for the more recently treated, which generates a reverse DID estimator, which is biased when treatment effects grow over time.</li>
<li>Post 2003, all groups are treated and there thus are no untreated observations to serve as a control group, except for the post treatment binned group.
This exacerbates the first problem.</li>
</ol>
<p>The cures for this issues seem to:</p>
<ol style="list-style-type: decimal">
<li>Never bin observations post-treatment, so that they are never used in a reverse DID design.</li>
<li>Never include time periods without any control group in the data.</li>
</ol>
<p>Let’s see what happens when we stop binning our post-treatment observations, we drop all treatment years for which there are no controls and we replace the time-to-treatment indicator by a constant for the never treated group (so that it is not used to build the time to treatment indicators, but only as a control group, to estimate the time fixed effects).</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="NE.html#cb238-1" tabindex="-1"></a>data.baker <span class="ot">&lt;-</span> data.baker <span class="sc">%&gt;%</span></span>
<span id="cb238-2"><a href="NE.html#cb238-2" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">&lt;=</span> <span class="dv">2003</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb238-3"><a href="NE.html#cb238-3" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cohort_year =</span> <span class="fu">ifelse</span>(cohort_year <span class="sc">==</span> <span class="dv">2004</span>, <span class="dv">0</span>, cohort_year)) <span class="sc">%&gt;%</span> </span>
<span id="cb238-4"><a href="NE.html#cb238-4" tabindex="-1"></a>    <span class="co"># make relative year indicator</span></span>
<span id="cb238-5"><a href="NE.html#cb238-5" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rel_year =</span> year <span class="sc">-</span> cohort_year)</span>
<span id="cb238-6"><a href="NE.html#cb238-6" tabindex="-1"></a>  </span>
<span id="cb238-7"><a href="NE.html#cb238-7" tabindex="-1"></a><span class="co"># get the minimum relative year - we need this to reindex</span></span>
<span id="cb238-8"><a href="NE.html#cb238-8" tabindex="-1"></a>min_year <span class="ot">&lt;-</span> <span class="fu">min</span>(data.baker <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cohort_year <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(rel_year))</span>
<span id="cb238-9"><a href="NE.html#cb238-9" tabindex="-1"></a>  </span>
<span id="cb238-10"><a href="NE.html#cb238-10" tabindex="-1"></a><span class="co"># reindex the relative years</span></span>
<span id="cb238-11"><a href="NE.html#cb238-11" tabindex="-1"></a>data.baker <span class="ot">&lt;-</span> data.baker <span class="sc">%&gt;%</span> </span>
<span id="cb238-12"><a href="NE.html#cb238-12" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">rel_year =</span> rel_year <span class="sc">-</span> min_year) <span class="sc">%&gt;%</span> </span>
<span id="cb238-13"><a href="NE.html#cb238-13" tabindex="-1"></a>    <span class="fu">dummy_cols</span>(<span class="at">select_columns =</span> <span class="st">&quot;rel_year&quot;</span>)</span>
<span id="cb238-14"><a href="NE.html#cb238-14" tabindex="-1"></a>  </span>
<span id="cb238-15"><a href="NE.html#cb238-15" tabindex="-1"></a><span class="co"># make regression formula </span></span>
<span id="cb238-16"><a href="NE.html#cb238-16" tabindex="-1"></a>indics <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;rel_year&quot;</span>, (<span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(data.baker <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cohort_year <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(rel_year)))[<span class="sc">-</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">-</span> min_year)], <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>, <span class="at">collapse =</span> <span class="st">&quot; + &quot;</span>)</span>
<span id="cb238-17"><a href="NE.html#cb238-17" tabindex="-1"></a>keepvars <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;rel_year&quot;</span>, <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:-</span><span class="dv">2</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">-</span> min_year, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)  </span>
<span id="cb238-18"><a href="NE.html#cb238-18" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">&quot;dep_var ~&quot;</span>, indics, <span class="st">&quot;| unit + year | 0 | state&quot;</span>))</span>
<span id="cb238-19"><a href="NE.html#cb238-19" tabindex="-1"></a>  </span>
<span id="cb238-20"><a href="NE.html#cb238-20" tabindex="-1"></a><span class="co"># run mod</span></span>
<span id="cb238-21"><a href="NE.html#cb238-21" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">felm</span>(formula, <span class="at">data =</span> data.baker, <span class="at">exactDOF =</span> <span class="cn">TRUE</span>)</span>
<span id="cb238-22"><a href="NE.html#cb238-22" tabindex="-1"></a>  </span>
<span id="cb238-23"><a href="NE.html#cb238-23" tabindex="-1"></a><span class="co"># grab the obs we need</span></span>
<span id="cb238-24"><a href="NE.html#cb238-24" tabindex="-1"></a>DIDBakerEstimTWFECorrect <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(mod) <span class="sc">%&gt;%</span> </span>
<span id="cb238-25"><a href="NE.html#cb238-25" tabindex="-1"></a>    <span class="fu">filter</span>(term <span class="sc">%in%</span> keepvars) <span class="sc">%&gt;%</span> </span>
<span id="cb238-26"><a href="NE.html#cb238-26" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:-</span><span class="dv">2</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb238-27"><a href="NE.html#cb238-27" tabindex="-1"></a>    <span class="fu">select</span>(t, estimate, std.error) <span class="sc">%&gt;%</span></span>
<span id="cb238-28"><a href="NE.html#cb238-28" tabindex="-1"></a>    <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">t =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">estimate =</span> <span class="dv">0</span>, <span class="at">std.error=</span><span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb238-29"><a href="NE.html#cb238-29" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">true_tau =</span> <span class="fu">ifelse</span>(t <span class="sc">&gt;=</span> <span class="dv">0</span>, (t <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">*</span>.<span class="dv">3</span>, <span class="dv">0</span>)) </span></code></pre></div>
<p>Let us now plot the data:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="NE.html#cb239-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> estimate),<span class="at">data=</span>DIDBakerEstimTWFECorrect) <span class="sc">+</span> </span>
<span id="cb239-2"><a href="NE.html#cb239-2" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> estimate<span class="fl">-1.96</span><span class="sc">*</span>std.error, <span class="at">ymax =</span> estimate<span class="fl">+1.96</span><span class="sc">*</span>std.error), <span class="at">color =</span> <span class="st">&#39;darkgrey&#39;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb239-3"><a href="NE.html#cb239-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">&#39;blue&#39;</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb239-4"><a href="NE.html#cb239-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> true_tau), <span class="at">color =</span> <span class="st">&#39;red&#39;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb239-5"><a href="NE.html#cb239-5" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb239-6"><a href="NE.html#cb239-6" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb239-7"><a href="NE.html#cb239-7" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Relative Time&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Estimate&quot;</span>) <span class="sc">+</span> </span>
<span id="cb239-8"><a href="NE.html#cb239-8" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb239-9"><a href="NE.html#cb239-9" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDBakerEstimTWFECorrect"></span>
<img src="STCI_files/figure-html/PlotDIDBakerEstimTWFECorrect-1.png" alt="Corrected Two Way Fixed Effects estimator in Baker's dataset" width="50%" />
<p class="caption">
Figure 4.42: Corrected Two Way Fixed Effects estimator in Baker’s dataset
</p>
</div>
<p>So, in general, Sun and Abraham bias seems to come from a misleading binning of treated observations post treatment and the absence of a never treated group.
Let us check whether this would generate weird results for the Two-Way Fixed Effects estimator in our dataset as well.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-255" class="example"><strong>Example 4.52  </strong></span>Let us check whether binning the post-treatment observations together (let’s say the last two) generates bias for the event study estimator in our original dataset.
We distinguish between an estimator using the data from the always takers and an estimator not using these observations.</p>
</div>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="NE.html#cb240-1" tabindex="-1"></a><span class="co"># generating the binned indicator</span></span>
<span id="cb240-2"><a href="NE.html#cb240-2" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb240-3"><a href="NE.html#cb240-3" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb240-4"><a href="NE.html#cb240-4" tabindex="-1"></a>            <span class="at">TimeToTreatmentBinned =</span> <span class="fu">if_else</span>(TimeToTreatment<span class="sc">&lt;=</span><span class="dv">0</span>,TimeToTreatment,<span class="dv">1</span>)</span>
<span id="cb240-5"><a href="NE.html#cb240-5" tabindex="-1"></a>          )</span>
<span id="cb240-6"><a href="NE.html#cb240-6" tabindex="-1"></a></span>
<span id="cb240-7"><a href="NE.html#cb240-7" tabindex="-1"></a><span class="co"># event study regression</span></span>
<span id="cb240-8"><a href="NE.html#cb240-8" tabindex="-1"></a><span class="co"># without the always treated</span></span>
<span id="cb240-9"><a href="NE.html#cb240-9" tabindex="-1"></a>reg.TWFE.event.study.binned.No1 <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> <span class="fu">i</span>(TimeToTreatmentBinned,<span class="at">ref=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">99</span>,<span class="sc">-</span><span class="dv">1</span>)) <span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">&gt;</span><span class="dv">1</span>))</span>
<span id="cb240-10"><a href="NE.html#cb240-10" tabindex="-1"></a><span class="co"># with the always treated</span></span>
<span id="cb240-11"><a href="NE.html#cb240-11" tabindex="-1"></a>reg.TWFE.event.study.binned<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> <span class="fu">i</span>(TimeToTreatmentBinned,<span class="at">ref=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">99</span>,<span class="sc">-</span><span class="dv">1</span>)) <span class="sc">|</span> id <span class="sc">+</span> time, <span class="at">data=</span>data)</span></code></pre></div>
<p>Let us now plot the event study estimates obtained using Two Way Fixed Effects-based methods with binned data:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="NE.html#cb241-1" tabindex="-1"></a><span class="co"># putting results into a dataframe</span></span>
<span id="cb241-2"><a href="NE.html#cb241-2" tabindex="-1"></a>resultsTWFEEventStudyBinned <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(<span class="fu">cbind</span>(reg.TWFE.event.study.binned.No1<span class="sc">$</span>coefficients[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>],reg.TWFE.event.study.binned.No1<span class="sc">$</span>se[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]),</span>
<span id="cb241-3"><a href="NE.html#cb241-3" tabindex="-1"></a>                                                  <span class="fu">cbind</span>(reg.TWFE.event.study.binned<span class="fl">.1</span><span class="sc">$</span>coefficients[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>],reg.TWFE.event.study.binned<span class="fl">.1</span><span class="sc">$</span>se[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>])))</span>
<span id="cb241-4"><a href="NE.html#cb241-4" tabindex="-1"></a><span class="fu">colnames</span>(resultsTWFEEventStudyBinned) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Coef&#39;</span>,<span class="st">&#39;Se&#39;</span>)</span>
<span id="cb241-5"><a href="NE.html#cb241-5" tabindex="-1"></a><span class="co"># adding the time to treatment variable</span></span>
<span id="cb241-6"><a href="NE.html#cb241-6" tabindex="-1"></a>resultsTWFEEventStudyBinned <span class="ot">&lt;-</span> resultsTWFEEventStudyBinned <span class="sc">%&gt;%</span></span>
<span id="cb241-7"><a href="NE.html#cb241-7" tabindex="-1"></a>                              <span class="fu">mutate</span>(</span>
<span id="cb241-8"><a href="NE.html#cb241-8" tabindex="-1"></a>                                <span class="at">TimeToTreatment =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="dv">2</span>)</span>
<span id="cb241-9"><a href="NE.html#cb241-9" tabindex="-1"></a>                              )</span>
<span id="cb241-10"><a href="NE.html#cb241-10" tabindex="-1"></a><span class="co"># adding the reference periods</span></span>
<span id="cb241-11"><a href="NE.html#cb241-11" tabindex="-1"></a>resultsTWFEEventStudyBinned <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsTWFEEventStudyBinned,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb241-12"><a href="NE.html#cb241-12" tabindex="-1"></a>resultsTWFEEventStudyBinned <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsTWFEEventStudyBinned,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb241-13"><a href="NE.html#cb241-13" tabindex="-1"></a></span>
<span id="cb241-14"><a href="NE.html#cb241-14" tabindex="-1"></a><span class="co"># adding the method dummy</span></span>
<span id="cb241-15"><a href="NE.html#cb241-15" tabindex="-1"></a>resultsTWFEEventStudyBinned <span class="ot">&lt;-</span> resultsTWFEEventStudyBinned <span class="sc">%&gt;%</span></span>
<span id="cb241-16"><a href="NE.html#cb241-16" tabindex="-1"></a>                              <span class="fu">mutate</span>(</span>
<span id="cb241-17"><a href="NE.html#cb241-17" tabindex="-1"></a>                                <span class="at">Method =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;Without Always Treated&quot;</span>,<span class="dv">4</span>),<span class="fu">rep</span>(<span class="st">&quot;With Always Treated&quot;</span>,<span class="dv">4</span>),<span class="fu">c</span>(<span class="st">&quot;Without Always Treated&quot;</span>,<span class="st">&quot;With Always Treated&quot;</span>))</span>
<span id="cb241-18"><a href="NE.html#cb241-18" tabindex="-1"></a>                              )</span>
<span id="cb241-19"><a href="NE.html#cb241-19" tabindex="-1"></a></span>
<span id="cb241-20"><a href="NE.html#cb241-20" tabindex="-1"></a><span class="co">#plot</span></span>
<span id="cb241-21"><a href="NE.html#cb241-21" tabindex="-1"></a><span class="fu">ggplot</span>(resultsTWFEEventStudyBinned,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef,<span class="at">color=</span>Method,<span class="at">linetype=</span>Method))<span class="sc">+</span></span>
<span id="cb241-22"><a href="NE.html#cb241-22" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb241-23"><a href="NE.html#cb241-23" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb241-24"><a href="NE.html#cb241-24" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb241-25"><a href="NE.html#cb241-25" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb241-26"><a href="NE.html#cb241-26" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb241-27"><a href="NE.html#cb241-27" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb241-28"><a href="NE.html#cb241-28" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDTWFEEventStudyBinned"></span>
<img src="STCI_files/figure-html/PlotDIDTWFEEventStudyBinned-1.png" alt="DID estimates around the treatment date estimated using the Binned TWFE estimator (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.43: DID estimates around the treatment date estimated using the Binned TWFE estimator (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDTWFEEventStudyBinned">4.43</a> confirms the analysis based on <a href="https://andrewcbaker.netlify.app/2020/06/27/how-to-create-relative-time-indicators/">Andrew Baker</a>’s data presented in Figure <a href="NE.html#fig:PlotDIDBakerEstimTWFEBinned">4.41</a>.
Binning the data post-treatment severely biases the event study graph estimated using a Two-Way Fixed Effects estimator, especially if one keeps the <em>always treated</em> observations in the dataset.</p>
</div>
</div>
<div id="summary" class="section level5 hasAnchor" number="4.3.3.2.10">
<h5><span class="header-section-number">4.3.3.2.10</span> Summary<a href="NE.html#summary" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Let us regroup all the event study estimates and all the aggregated estimates of the TT together in order to compare them with the true estimator.
Let us start with the event study estimates first.</p>
<div id="event-study-estimates" class="section level6 hasAnchor" number="4.3.3.2.10.1">
<h6><span class="header-section-number">4.3.3.2.10.1</span> Event study estimates<a href="NE.html#event-study-estimates" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="NE.html#cb242-1" tabindex="-1"></a><span class="co"># let us first combine all the estimators together</span></span>
<span id="cb242-2"><a href="NE.html#cb242-2" tabindex="-1"></a>DID.event.study.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb242-3"><a href="NE.html#cb242-3" tabindex="-1"></a>                          DID.tau <span class="sc">%&gt;%</span> <span class="fu">filter</span>(d<span class="sc">==</span><span class="st">&quot;Aggregate&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(tau,ATT.tau) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Weighted DID&quot;</span>,<span class="at">Se=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">TimeToTreatment=</span>tau,<span class="at">Coef=</span>ATT.tau),</span>
<span id="cb242-4"><a href="NE.html#cb242-4" tabindex="-1"></a>                          disaggregate.SA <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Group<span class="sc">==</span><span class="st">&quot;Aggregate&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(TimeToTreatment,Coef,Se) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Sun &amp; Abraham&quot;</span>),</span>
<span id="cb242-5"><a href="NE.html#cb242-5" tabindex="-1"></a>                          DID.CSA <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Group<span class="sc">==</span><span class="st">&quot;Aggregate&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(TimeToTreatment,Coef,Se) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Callaway &amp; SantAnna&quot;</span>),</span>
<span id="cb242-6"><a href="NE.html#cb242-6" tabindex="-1"></a>                          DID.dCdH <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;de Chaisemartin &amp; d&#39;Haultfoeuille&quot;</span>),</span>
<span id="cb242-7"><a href="NE.html#cb242-7" tabindex="-1"></a>                          DID.BJS <span class="sc">%&gt;%</span> <span class="fu">select</span>(TimeToTreatment,Coef,Se) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Borusyak, Jaravel &amp; Speiss&quot;</span>),</span>
<span id="cb242-8"><a href="NE.html#cb242-8" tabindex="-1"></a>                          resultsGardnerEventStudy <span class="sc">%&gt;%</span> <span class="fu">select</span>(TimeToTreatment,Coef,Se) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Gardner&quot;</span>),</span>
<span id="cb242-9"><a href="NE.html#cb242-9" tabindex="-1"></a>                          resultsStackedDIDEventStudy <span class="sc">%&gt;%</span> <span class="fu">select</span>(TimeToTreatment,Coef,Se) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Stacked DID&quot;</span>),</span>
<span id="cb242-10"><a href="NE.html#cb242-10" tabindex="-1"></a>                          resultsTWFEEventStudy <span class="sc">%&gt;%</span> <span class="fu">select</span>(TimeToTreatment,Coef,Se) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;TWFE&quot;</span>)</span>
<span id="cb242-11"><a href="NE.html#cb242-11" tabindex="-1"></a>                        ) </span>
<span id="cb242-12"><a href="NE.html#cb242-12" tabindex="-1"></a></span>
<span id="cb242-13"><a href="NE.html#cb242-13" tabindex="-1"></a><span class="co"># Let us now add the true value of the treatment effect in the sample.</span></span>
<span id="cb242-14"><a href="NE.html#cb242-14" tabindex="-1"></a><span class="co"># it is not easy to estimate </span></span>
<span id="cb242-15"><a href="NE.html#cb242-15" tabindex="-1"></a><span class="co"># we are going to use variable weights and the meriod -1 as reference (taking its treatment effect our of all treatment effect estimates)</span></span>
<span id="cb242-16"><a href="NE.html#cb242-16" tabindex="-1"></a>DID.truth <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb242-17"><a href="NE.html#cb242-17" tabindex="-1"></a>              <span class="fu">mutate</span>(</span>
<span id="cb242-18"><a href="NE.html#cb242-18" tabindex="-1"></a>                <span class="at">alpha =</span> <span class="fu">if_else</span>(D<span class="sc">==</span><span class="dv">1</span>,y1<span class="sc">-</span>y0,<span class="dv">0</span>)</span>
<span id="cb242-19"><a href="NE.html#cb242-19" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span></span>
<span id="cb242-20"><a href="NE.html#cb242-20" tabindex="-1"></a>              <span class="fu">filter</span>(Group<span class="sc">&gt;</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb242-21"><a href="NE.html#cb242-21" tabindex="-1"></a>              <span class="fu">group_by</span>(TimeToTreatment) <span class="sc">%&gt;%</span></span>
<span id="cb242-22"><a href="NE.html#cb242-22" tabindex="-1"></a>              <span class="fu">summarize</span>(</span>
<span id="cb242-23"><a href="NE.html#cb242-23" tabindex="-1"></a>                <span class="at">Coef=</span><span class="fu">if_else</span>(TimeToTreatment<span class="sc">&gt;=</span><span class="dv">0</span>,<span class="fu">mean</span>(alpha),<span class="dv">0</span>)</span>
<span id="cb242-24"><a href="NE.html#cb242-24" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span></span>
<span id="cb242-25"><a href="NE.html#cb242-25" tabindex="-1"></a>              <span class="fu">mutate</span>(</span>
<span id="cb242-26"><a href="NE.html#cb242-26" tabindex="-1"></a>                <span class="at">Method=</span><span class="st">&quot;Truth&quot;</span>,</span>
<span id="cb242-27"><a href="NE.html#cb242-27" tabindex="-1"></a>                <span class="at">Se=</span><span class="dv">0</span></span>
<span id="cb242-28"><a href="NE.html#cb242-28" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span></span>
<span id="cb242-29"><a href="NE.html#cb242-29" tabindex="-1"></a>              <span class="fu">filter</span>(TimeToTreatment<span class="sc">&lt;</span><span class="dv">3</span>) </span>
<span id="cb242-30"><a href="NE.html#cb242-30" tabindex="-1"></a></span>
<span id="cb242-31"><a href="NE.html#cb242-31" tabindex="-1"></a><span class="co"># regrouping</span></span>
<span id="cb242-32"><a href="NE.html#cb242-32" tabindex="-1"></a>DID.event.study.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.event.study.all,DID.truth) <span class="sc">%&gt;%</span></span>
<span id="cb242-33"><a href="NE.html#cb242-33" tabindex="-1"></a>                        <span class="fu">mutate</span>(</span>
<span id="cb242-34"><a href="NE.html#cb242-34" tabindex="-1"></a>                          <span class="at">Method=</span><span class="fu">factor</span>(Method,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Truth&quot;</span>,<span class="st">&quot;Weighted DID&quot;</span>,<span class="st">&quot;Sun &amp; Abraham&quot;</span>,<span class="st">&quot;Callaway &amp; SantAnna&quot;</span>,<span class="st">&quot;de Chaisemartin &amp; d&#39;Haultfoeuille&quot;</span>,<span class="st">&quot;Borusyak, Jaravel &amp; Speiss&quot;</span>,<span class="st">&quot;Gardner&quot;</span>,<span class="st">&quot;Stacked DID&quot;</span>,<span class="st">&quot;TWFE&quot;</span>))</span>
<span id="cb242-35"><a href="NE.html#cb242-35" tabindex="-1"></a>                        )</span></code></pre></div>
<p>Let us now plot the data:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="NE.html#cb243-1" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb243-2"><a href="NE.html#cb243-2" tabindex="-1"></a><span class="fu">ggplot</span>(DID.event.study.all,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef,<span class="at">colour=</span>Method,<span class="at">linetype=</span>Method,<span class="at">shape=</span>Method))<span class="sc">+</span></span>
<span id="cb243-3"><a href="NE.html#cb243-3" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb243-4"><a href="NE.html#cb243-4" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb243-5"><a href="NE.html#cb243-5" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb243-6"><a href="NE.html#cb243-6" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb243-7"><a href="NE.html#cb243-7" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb243-8"><a href="NE.html#cb243-8" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb243-9"><a href="NE.html#cb243-9" tabindex="-1"></a>    <span class="fu">scale_colour_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb243-10"><a href="NE.html#cb243-10" tabindex="-1"></a>    <span class="fu">scale_linetype_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb243-11"><a href="NE.html#cb243-11" tabindex="-1"></a>    <span class="fu">scale_shape_discrete</span>(<span class="at">name=</span><span class="st">&quot;Treatment</span><span class="sc">\n</span><span class="st">group&quot;</span>)<span class="sc">+</span></span>
<span id="cb243-12"><a href="NE.html#cb243-12" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDEventStudyAll"></span>
<img src="STCI_files/figure-html/PlotDIDEventStudyAll-1.png" alt="Event study estimates around the treatment date with various methods (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.44: Event study estimates around the treatment date with various methods (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Note that all estimators are pretty similar.
There is a dip 3 periods before treatment for some estimators.
It is actually a true dip due to time varying selection bias at the first period which is embedded in the model.</p>
<div class="remark">
<p><span id="unlabeled-div-141" class="remark"><em>Remark</em>. </span>Another approach to compare all estimators would be to use directly the <code>did2s</code> package.
The command <code>event_study</code> uses almost all the commands already presented and integrates them into one unique analysis.
Let’s see how this works.</p>
</div>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="NE.html#cb244-1" tabindex="-1"></a><span class="co"># modifying the name of the control group variable to 0</span></span>
<span id="cb244-2"><a href="NE.html#cb244-2" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb244-3"><a href="NE.html#cb244-3" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb244-4"><a href="NE.html#cb244-4" tabindex="-1"></a>            <span class="at">Ds=</span><span class="fu">if_else</span>(Ds<span class="sc">==</span><span class="dv">99</span>,<span class="dv">0</span>,Ds)</span>
<span id="cb244-5"><a href="NE.html#cb244-5" tabindex="-1"></a>          )</span>
<span id="cb244-6"><a href="NE.html#cb244-6" tabindex="-1"></a><span class="co"># regression</span></span>
<span id="cb244-7"><a href="NE.html#cb244-7" tabindex="-1"></a>reg.event.study.all <span class="ot">&lt;-</span> <span class="fu">event_study</span>(<span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">!=</span><span class="dv">1</span>),<span class="at">yname =</span> <span class="st">&quot;y&quot;</span>, <span class="at">idname=</span><span class="st">&quot;id&quot;</span>, <span class="at">tname =</span> <span class="st">&quot;time&quot;</span>,<span class="at">gname=</span><span class="st">&quot;Ds&quot;</span>)</span></code></pre></div>
<pre><code>## Error in purrr::map(., function(y) { : ℹ In index: 1.
## ℹ With name: y.
## Caused by error in `.subset2()`:
## ! no such index at level 1</code></pre>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="NE.html#cb246-1" tabindex="-1"></a><span class="co"># modifying the name of the control group variable back to 99</span></span>
<span id="cb246-2"><a href="NE.html#cb246-2" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb246-3"><a href="NE.html#cb246-3" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb246-4"><a href="NE.html#cb246-4" tabindex="-1"></a>            <span class="at">Ds=</span><span class="fu">if_else</span>(Ds<span class="sc">==</span><span class="dv">0</span>,<span class="dv">99</span>,Ds)</span>
<span id="cb246-5"><a href="NE.html#cb246-5" tabindex="-1"></a>          )</span></code></pre></div>
<p>Let’s now plot the results.
It is made super easy by the command <code>plot_event_study</code> but we could also use the same <code>ggplot</code> command that we have used so far.</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="NE.html#cb247-1" tabindex="-1"></a><span class="co"># using the plot_event_study command (not super nice, so not shown)</span></span>
<span id="cb247-2"><a href="NE.html#cb247-2" tabindex="-1"></a><span class="co"># plot_event_study(reg.event.study.all,seperate = F)</span></span>
<span id="cb247-3"><a href="NE.html#cb247-3" tabindex="-1"></a></span>
<span id="cb247-4"><a href="NE.html#cb247-4" tabindex="-1"></a><span class="co"># preparing data </span></span>
<span id="cb247-5"><a href="NE.html#cb247-5" tabindex="-1"></a>reg.event.study.all <span class="ot">&lt;-</span> reg.event.study.all <span class="sc">%&gt;%</span></span>
<span id="cb247-6"><a href="NE.html#cb247-6" tabindex="-1"></a>                        <span class="fu">mutate</span>(</span>
<span id="cb247-7"><a href="NE.html#cb247-7" tabindex="-1"></a>                          <span class="at">estimator=</span><span class="fu">factor</span>(estimator,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Sun and Abraham (2020)&quot;</span>,<span class="st">&quot;Callaway and Sant&#39;Anna (2020)&quot;</span>,<span class="st">&quot;Borusyak, Jaravel, Spiess (2021)&quot;</span>,<span class="st">&quot;Gardner (2021)&quot;</span>,<span class="st">&quot;TWFE&quot;</span>,<span class="st">&quot;Roth and Sant&#39;Anna (2021)&quot;</span>))</span>
<span id="cb247-8"><a href="NE.html#cb247-8" tabindex="-1"></a>                        ) <span class="sc">%&gt;%</span></span>
<span id="cb247-9"><a href="NE.html#cb247-9" tabindex="-1"></a>                        <span class="fu">rename</span>(</span>
<span id="cb247-10"><a href="NE.html#cb247-10" tabindex="-1"></a>                          <span class="at">Method=</span>estimator,</span>
<span id="cb247-11"><a href="NE.html#cb247-11" tabindex="-1"></a>                          <span class="at">Coef=</span>estimate,</span>
<span id="cb247-12"><a href="NE.html#cb247-12" tabindex="-1"></a>                          <span class="at">Se=</span>std.error,</span>
<span id="cb247-13"><a href="NE.html#cb247-13" tabindex="-1"></a>                          <span class="at">TimeToTreatment=</span>term</span>
<span id="cb247-14"><a href="NE.html#cb247-14" tabindex="-1"></a>                        )</span>
<span id="cb247-15"><a href="NE.html#cb247-15" tabindex="-1"></a></span>
<span id="cb247-16"><a href="NE.html#cb247-16" tabindex="-1"></a><span class="co"># using classical ggplot</span></span>
<span id="cb247-17"><a href="NE.html#cb247-17" tabindex="-1"></a><span class="fu">ggplot</span>(reg.event.study.all,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>Coef,<span class="at">group=</span>Method,<span class="at">color=</span>Method))<span class="sc">+</span></span>
<span id="cb247-18"><a href="NE.html#cb247-18" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb247-19"><a href="NE.html#cb247-19" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb247-20"><a href="NE.html#cb247-20" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb247-21"><a href="NE.html#cb247-21" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Time relative to treatment&quot;</span>) <span class="sc">+</span></span>
<span id="cb247-22"><a href="NE.html#cb247-22" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb247-23"><a href="NE.html#cb247-23" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb247-24"><a href="NE.html#cb247-24" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDID2SEventStudyAll"></span>
<img src="STCI_files/figure-html/PlotDID2SEventStudyAll-1.png" alt="DID estimates around the treatment date estimated using various procedures (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.45: DID estimates around the treatment date estimated using various procedures (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>There is a problem here, let’s hope we can find a way to solve it.</p>
</div>
<div id="aggregate-treatment-on-the-treated-estimates" class="section level6 hasAnchor" number="4.3.3.2.10.2">
<h6><span class="header-section-number">4.3.3.2.10.2</span> Aggregate Treatment on the Treated Estimates<a href="NE.html#aggregate-treatment-on-the-treated-estimates" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>Let us now see what happens to the average effect of the treatment on the treated.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="NE.html#cb248-1" tabindex="-1"></a><span class="co"># let us first combine all the estimators together</span></span>
<span id="cb248-2"><a href="NE.html#cb248-2" tabindex="-1"></a>DID.TT.all <span class="ot">&lt;-</span> DID.event.study.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb248-3"><a href="NE.html#cb248-3" tabindex="-1"></a>                          <span class="fu">data.frame</span>(<span class="at">Coef=</span><span class="fu">c</span>(ATT.equal),<span class="at">Se=</span><span class="fu">c</span>(<span class="dv">0</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Weighted DID Equal&quot;</span>,<span class="at">Se=</span><span class="dv">0</span>),</span>
<span id="cb248-4"><a href="NE.html#cb248-4" tabindex="-1"></a>                          <span class="fu">data.frame</span>(<span class="at">Coef=</span><span class="fu">c</span>(ATT.varying),<span class="at">Se=</span><span class="fu">c</span>(<span class="dv">0</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Weighted DID Varying&quot;</span>,<span class="at">Se=</span><span class="dv">0</span>),</span>
<span id="cb248-5"><a href="NE.html#cb248-5" tabindex="-1"></a>                          <span class="fu">as.data.frame</span>(ATT.agg.SA) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Coef=</span>Estimate,<span class="at">Se=</span><span class="fu">colnames</span>(ATT.agg.SA)[[<span class="dv">2</span>]]) <span class="sc">%&gt;%</span> <span class="fu">select</span>(Coef,Se) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Sun &amp; Abraham&quot;</span>),</span>
<span id="cb248-6"><a href="NE.html#cb248-6" tabindex="-1"></a>                          <span class="fu">as.data.frame</span>(ATT.agg.CSA[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Coef=</span>overall.att,<span class="at">Se=</span>overall.se) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Callaway &amp; SantAnna&quot;</span>),</span>
<span id="cb248-7"><a href="NE.html#cb248-7" tabindex="-1"></a>                          <span class="fu">data.frame</span>(<span class="at">Coef=</span><span class="fu">c</span>(reg.dCdH<span class="sc">$</span>effect),<span class="at">Se=</span><span class="fu">c</span>(<span class="dv">0</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;de Chaisemartin &amp; d&#39;Haultfoeuille&quot;</span>),</span>
<span id="cb248-8"><a href="NE.html#cb248-8" tabindex="-1"></a>                          reg.BJS.Agg[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>] <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Coef=</span>estimate,<span class="at">Se=</span>std.error) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Borusyak, Jaravel &amp; Speiss&quot;</span>),</span>
<span id="cb248-9"><a href="NE.html#cb248-9" tabindex="-1"></a>                          <span class="fu">data.frame</span>(<span class="at">Coef=</span><span class="fu">coef</span>(reg.Gardner)[[<span class="dv">1</span>]],<span class="at">Se=</span><span class="fu">se</span>(reg.Gardner)[[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Gardner&quot;</span>),</span>
<span id="cb248-10"><a href="NE.html#cb248-10" tabindex="-1"></a>                          <span class="fu">data.frame</span>(<span class="at">Coef=</span><span class="fu">coef</span>(reg.stacked.aggregate)[[<span class="dv">1</span>]],<span class="at">Se=</span><span class="fu">se</span>(reg.stacked.aggregate)[[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;Stacked DID&quot;</span>),</span>
<span id="cb248-11"><a href="NE.html#cb248-11" tabindex="-1"></a>                          <span class="fu">data.frame</span>(<span class="at">Coef=</span>reg.TWFE.aggregate<span class="sc">$</span>coefficients[[<span class="dv">1</span>]],<span class="at">Se=</span>reg.TWFE.aggregate<span class="sc">$</span>se[[<span class="dv">1</span>]]) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method=</span><span class="st">&quot;TWFE&quot;</span>)</span>
<span id="cb248-12"><a href="NE.html#cb248-12" tabindex="-1"></a>                        ) </span>
<span id="cb248-13"><a href="NE.html#cb248-13" tabindex="-1"></a></span>
<span id="cb248-14"><a href="NE.html#cb248-14" tabindex="-1"></a><span class="co"># Let us now add the true value of the treatment effect in the sample.</span></span>
<span id="cb248-15"><a href="NE.html#cb248-15" tabindex="-1"></a>ATT.truth <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb248-16"><a href="NE.html#cb248-16" tabindex="-1"></a>              <span class="fu">filter</span>(Group<span class="sc">&gt;</span><span class="dv">1</span>,D<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb248-17"><a href="NE.html#cb248-17" tabindex="-1"></a>              <span class="fu">mutate</span>(</span>
<span id="cb248-18"><a href="NE.html#cb248-18" tabindex="-1"></a>                 <span class="at">alpha =</span> y1<span class="sc">-</span>y0</span>
<span id="cb248-19"><a href="NE.html#cb248-19" tabindex="-1"></a>               ) <span class="sc">%&gt;%</span></span>
<span id="cb248-20"><a href="NE.html#cb248-20" tabindex="-1"></a>              <span class="fu">summarize</span>(</span>
<span id="cb248-21"><a href="NE.html#cb248-21" tabindex="-1"></a>                <span class="at">Coef=</span><span class="fu">mean</span>(alpha)</span>
<span id="cb248-22"><a href="NE.html#cb248-22" tabindex="-1"></a>              ) <span class="sc">%&gt;%</span></span>
<span id="cb248-23"><a href="NE.html#cb248-23" tabindex="-1"></a>              <span class="fu">mutate</span>(</span>
<span id="cb248-24"><a href="NE.html#cb248-24" tabindex="-1"></a>                <span class="at">Method=</span><span class="st">&quot;Truth&quot;</span>,</span>
<span id="cb248-25"><a href="NE.html#cb248-25" tabindex="-1"></a>                <span class="at">Se=</span><span class="dv">0</span></span>
<span id="cb248-26"><a href="NE.html#cb248-26" tabindex="-1"></a>              ) </span>
<span id="cb248-27"><a href="NE.html#cb248-27" tabindex="-1"></a></span>
<span id="cb248-28"><a href="NE.html#cb248-28" tabindex="-1"></a><span class="co"># regrouping</span></span>
<span id="cb248-29"><a href="NE.html#cb248-29" tabindex="-1"></a>DID.TT.all <span class="ot">&lt;-</span> <span class="fu">rbind</span>(DID.TT.all,ATT.truth) <span class="sc">%&gt;%</span></span>
<span id="cb248-30"><a href="NE.html#cb248-30" tabindex="-1"></a>                        <span class="fu">mutate</span>(</span>
<span id="cb248-31"><a href="NE.html#cb248-31" tabindex="-1"></a>                          <span class="at">Method=</span><span class="fu">factor</span>(Method,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Truth&quot;</span>,<span class="st">&quot;Weighted DID Equal&quot;</span>,<span class="st">&quot;Weighted DID Varying&quot;</span>,<span class="st">&quot;Sun &amp; Abraham&quot;</span>,<span class="st">&quot;Callaway &amp; SantAnna&quot;</span>,<span class="st">&quot;de Chaisemartin &amp; d&#39;Haultfoeuille&quot;</span>,<span class="st">&quot;Borusyak, Jaravel &amp; Speiss&quot;</span>,<span class="st">&quot;Gardner&quot;</span>,<span class="st">&quot;Stacked DID&quot;</span>,<span class="st">&quot;TWFE&quot;</span>))</span>
<span id="cb248-32"><a href="NE.html#cb248-32" tabindex="-1"></a>                        )</span></code></pre></div>
<p>Let us now plot the results:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="NE.html#cb249-1" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb249-2"><a href="NE.html#cb249-2" tabindex="-1"></a><span class="fu">ggplot</span>(DID.TT.all,<span class="fu">aes</span>(<span class="at">x=</span>Method,<span class="at">y=</span>Coef))<span class="sc">+</span></span>
<span id="cb249-3"><a href="NE.html#cb249-3" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>Coef<span class="fl">-1.96</span><span class="sc">*</span>Se,<span class="at">ymax=</span>Coef<span class="fl">+1.96</span><span class="sc">*</span>Se)) <span class="sc">+</span></span>
<span id="cb249-4"><a href="NE.html#cb249-4" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;DID estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb249-5"><a href="NE.html#cb249-5" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Method&quot;</span>) <span class="sc">+</span></span>
<span id="cb249-6"><a href="NE.html#cb249-6" tabindex="-1"></a>    <span class="fu">expand_limits</span>(<span class="at">y=</span><span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb249-7"><a href="NE.html#cb249-7" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb249-8"><a href="NE.html#cb249-8" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDATTAll"></span>
<img src="STCI_files/figure-html/PlotDIDATTAll-1.png" alt="Average treatment effect on the treated estimates with various methods (reference period $\tau'=1$)" width="50%" />
<p class="caption">
Figure 4.46: Average treatment effect on the treated estimates with various methods (reference period <span class="math inline">\(\tau&#39;=1\)</span>)
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotDIDATTAll">4.46</a> shows that the true effect of the treatment in the sample (with weights proportional to actual exposure to the treatment) is correctly estimated by the Weighted DID estimator using weights varying with exposure, but also by the correct estimators of Sun and Abraham, Callaway and Sant’Anna, Borusyak, Jaravel and Speiss and Gardner.
The Two-Way fixed Effect estimator finds a negative treatment effect whereas all treatment effects are positive.
The Stacked DID estimator finds too large a treatment effect, probably because it gives too much weight to later treatment periods.
The de Chaisemartin and d’Haultfoeuille estimator used here only aims at estimating the effect of the treatment in the first time period, for which it is consistent.</p>
<div class="remark">
<p><span id="unlabeled-div-142" class="remark"><em>Remark</em>. </span>Several open questions remain after this section.
They are mostly cosmetic since thay are questions about properties of the Two-Way Fixed Effects estimator, and thus do not affect the properties of the correct estimators that we have studied:</p>
</div>
<ol style="list-style-type: decimal">
<li>Does the Two Way Fixed Effect estimator recover a correct treatment effect (that is only with positive weights) when the equivalent to Assumption <a href="NE.html#hyp:ParallelTrendsy1">4.19</a> holds?</li>
<li>Does the event-study Two Way Fixed Effect estimator recover the correct dynamics of treatment effects when there is no binning of the treated observations past some date, and there is a never treated group that is used to estimate the time fixed effects?
Our example in Section <a href="NE.html#sec:BiasTWFEevent">4.3.3.2.9.2</a> seems to suggest that it is so, while the slightly different results of that estimator with respect to the correct ones in the summary of results above seems to suggest otherwise.
An example where the event-study Two Way Fixed Effect estimator fails but these conditions hold would be very useful to understand the scope of Theorem <a href="NE.html#thm:SADecomp">4.23</a> better.</li>
<li>Does the gain in efficiency obtained by the imputation estimator is still present when combining all the DID estimates from all the possible comparison groups, as in the weigthed DID estimator we have proposed?</li>
</ol>
</div>
</div>
</div>
<div id="estimation-of-sampling-noise-3" class="section level4 hasAnchor" number="4.3.3.3">
<h4><span class="header-section-number">4.3.3.3</span> Estimation of sampling noise<a href="NE.html#estimation-of-sampling-noise-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We now need to derive the asymptotic distribution of our estimators in a staggered DID design.
We are going to do that for the Sun and Abraham estimator, which is the simplest estimator that is estimated by OLS, Within, LSDV, First Difference or faster TWFE estimators and extends the simple DID estimators to staggered designs.
There are two sets of parameters for which we might want to know their distribution: the parameter specific to each treated group and relative time to treatment <span class="math inline">\(\hat\beta^{SA}_{d,\tau}\)</span> and the aggregated treatment effect <span class="math inline">\(\hat\Delta^{Y}_{TT}(k)\)</span> for some set of weights <span class="math inline">\(w^k(d,d&#39;,\tau,\tau&#39;)\)</span>.
Let’s look at these parameters in turn.</p>
<div id="estimation-of-sampling-noise-for-the-effect-of-the-treatment-on-each-group-and-at-each-time-period" class="section level5 hasAnchor" number="4.3.3.3.1">
<h5><span class="header-section-number">4.3.3.3.1</span> Estimation of sampling noise for the effect of the treatment on each group and at each time period<a href="NE.html#estimation-of-sampling-noise-for-the-effect-of-the-treatment-on-each-group-and-at-each-time-period" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We can estimate the <span class="math inline">\(\hat\beta^{SA}_{d,\tau}\)</span> with either repeated cross section data or panel data.
Let us start with studying what happens with repeated cross sections before moving to panel data.</p>
<div id="estimation-of-sampling-noise-for-the-effect-of-the-treatment-on-each-group-and-at-each-time-period-with-repeated-cross-sections" class="section level6 hasAnchor" number="4.3.3.3.1.1">
<h6><span class="header-section-number">4.3.3.3.1.1</span> Estimation of sampling noise for the effect of the treatment on each group and at each time period with repeated cross sections<a href="NE.html#estimation-of-sampling-noise-for-the-effect-of-the-treatment-on-each-group-and-at-each-time-period-with-repeated-cross-sections" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>With repeated cross sections, we can only use the OLS DID estimator of the Sun and Abraham model.
The following theorem derives its distribution:</p>
<div class="theorem">
<p><span id="thm:asympnoiseSACross" class="theorem"><strong>Theorem 4.24  (Asymptotic Distribution of Sun and Abraham Estimator in Repeated Cross Sections) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrends">4.14</a>, <a href="NE.html#hyp:iidDIDCross">4.17</a> and <a href="FPSI.html#hyp:finitevar">2.3</a>, and with repeated cross sections of total size <span class="math inline">\(N\)</span>, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}(\hat\beta^{SA}_{d,\tau}-\beta^{SA}_{d,\tau}) &amp; \stackrel{d}{\rightarrow}
                             \mathcal{N}\left(0,\frac{1}{p^{d,\tau}}
                             \left[\frac{\var{Y^0_{i,d-1}|D_i=\infty}}{(1-p^{d,\tau}_D)(1-p^{d,\tau}_A)}
                            +\frac{\var{Y^0_{i,d-1}|D_i=d}}{p^{d,\tau}_D(1-p^{d,\tau}_A)}\right.\right. \\
            &amp; \phantom{\stackrel{d}{\rightarrow}\mathcal{N}\left(0,\frac{1}{p^{d,\tau}}\right.}\left.\left.
                            +\frac{\var{Y^0_{i,d+\tau}|D_i=\infty}}{(1-p^{d,\tau}_D)p^{d,\tau}_A}
                            +\frac{\var{Y^1_{i,d+\tau}|D_i=\infty}}{p^{d,\tau}_Dp^{d,\tau}_A}
                            \right]\right)
\end{align*}\]</span></p>
<p>where <span class="math inline">\(p^{d,\tau}=\Pr((D_i=d\cup D_i=\infty)\cap(T_i=d-1\cup T_i=d+\tau))\)</span>, <span class="math inline">\(p^{d,\tau}_D=\Pr(D_i=d|(D_i=d\cup D_i=\infty)\cap(T_i=d-1\cup T_i=d+\tau))\)</span> and <span class="math inline">\(p^{d,\tau}_A=\Pr(T_i=d+\tau|(D_i=d\cup D_i=\infty)\cap(T_i=d-1\cup T_i=d+\tau))\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-143" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofasympnoiseSACross">A.3.5</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-144" class="remark"><em>Remark</em>. </span>Note that Theorem <a href="NE.html#thm:asympnoiseSACross">4.24</a> is very close to Theorem <a href="NE.html#thm:asympnoiseDIDCross">4.12</a>.
The only difference is the additional <span class="math inline">\(p^{d,\tau}\)</span> term which adjusts the sample size by the actual number of observations used in the estimation of <span class="math inline">\(\hat\beta^{SA}_{d,\tau}\)</span>.</p>
</div>
</div>
<div id="estimation-of-sampling-noise-for-the-effect-of-the-treatment-on-each-group-and-at-each-time-period-with-panel-data" class="section level6 hasAnchor" number="4.3.3.3.1.2">
<h6><span class="header-section-number">4.3.3.3.1.2</span> Estimation of sampling noise for the effect of the treatment on each group and at each time period with panel data<a href="NE.html#estimation-of-sampling-noise-for-the-effect-of-the-treatment-on-each-group-and-at-each-time-period-with-panel-data" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>With panel data, we can estimate <span class="math inline">\(\hat\beta^{SA}_{d,\tau}\)</span> using various sets of estimators: the OLS DID model, the within transformation of the Sun and Abraham model with individual dummies, the Least Squares Dummy Variables model estimated by OLS, the First Difference model and the enhanced estimators (Alternating Projections and Likelihood Concentration).
Theorem <a href="NE.html#thm:EquivDIDSAsamp">4.20</a> implies that all these estiamtors are similar and identical to the individual DID estimators.
We can thus use Theorem <a href="NE.html#thm:asympnoiseDID">4.11</a> in order to provide a CLT-based estimate the sampling noise of the Sun and Abraham estimator of the individual treatment effects in panel data.
The following theorem derives its distribution:</p>
<div class="theorem">
<p><span id="thm:asympnoiseSAPanel" class="theorem"><strong>Theorem 4.25  (Asymptotic Distribution of Sun and Abraham Estimator in Panel Data) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrends">4.14</a>, <a href="NE.html#hyp:iidDID">4.15</a> and <a href="NE.html#hyp:finitevarDID">4.16</a>, and with panel data with <span class="math inline">\(N\)</span> units observed over <span class="math inline">\(T\)</span> periods, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}(\hat\beta^{SA}_{d,\tau}-\beta^{SA}_{d,\tau}) &amp; \stackrel{d}{\rightarrow}
                             \mathcal{N}\left(0,\frac{1}{p^{d,\infty}}\left(\frac{\var{Y_{i,d+\tau}^1-Y_{i,d-1}^0|D_i=d}}{p^{d,\infty}_D}+\frac{\var{Y_{i,d+\infty}^0-Y_{i,d-1}^0|D_i=\infty}}{1-p^{d,\infty}_D}\right)\right),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(p^{d,\infty}=\Pr(D_i=d\cup D_i=\infty)\)</span> and <span class="math inline">\(p^{d,\infty}_D=\Pr(D_i=d|D_i=d\cup D_i=\infty)\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-145" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofasympnoiseSAPanel">A.3.7</a>.</p>
</div>
</div>
</div>
<div id="estimation-of-sampling-noise-for-aggregate-treatment-effects" class="section level5 hasAnchor" number="4.3.3.3.2">
<h5><span class="header-section-number">4.3.3.3.2</span> Estimation of sampling noise for aggregate treatment effects<a href="NE.html#estimation-of-sampling-noise-for-aggregate-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The key now is to derive the distribution of the event study parameters and of the average treatment effect on the treated.
We are going to use the Delta Method in order to do so, but that requires determining the covariance matrix of the <span class="math inline">\(\hat\beta_{d,\tau}^{SA}\)</span> parameters.
Under Assumption <a href="NE.html#hyp:iidDID">4.15</a> for panel data or <a href="NE.html#hyp:iidDIDCross">4.17</a> in repeated cross sections, most of the <span class="math inline">\(\hat\beta_{d,\tau}^{SA}\)</span> parameters are independent from each other, except for the ones which make use of the same parts of the data.</p>
<div id="estimation-of-sampling-noise-for-aggregate-treatment-effects-with-repeated-cross-sections" class="section level6 hasAnchor" number="4.3.3.3.2.1">
<h6><span class="header-section-number">4.3.3.3.2.1</span> Estimation of sampling noise for aggregate treatment effects with repeated cross sections<a href="NE.html#estimation-of-sampling-noise-for-aggregate-treatment-effects-with-repeated-cross-sections" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The following theorem derives the asymptotic distribution of the aggregated treatment on the treated parameter based on the individual DID estimates stemming from Sun and Abraham’s estimator, in repeated cross sections.</p>
<div class="theorem">
<p><span id="thm:asympnoiseSATTCross" class="theorem"><strong>Theorem 4.26  (Asymptotic Distribution of Treatment of the Treated Estimated Using Sun and Abraham Estimator in Repeated Cross Sections) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrends">4.14</a>, <a href="NE.html#hyp:iidDIDCross">4.17</a> and <a href="FPSI.html#hyp:finitevar">2.3</a>, and with repeated cross sections of total size <span class="math inline">\(N\)</span>, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}(\hat\Delta^{Y}_{TT_{SA}}(k)-\Delta^{Y}_{TT_{SA}}(k)) &amp; \stackrel{d}{\rightarrow}
  \mathcal{N}\left(0,\sum_d\sum_{\tau}V(\hat\beta^{SA}_{d,\tau})(w^k(d,d-1,\tau,\infty))^2 \right.\\
        &amp; \phantom{\stackrel{d}{\rightarrow}}\left.+\sum_{d}\sum_{d&#39;}\sum_{\tau}\sum_{\tau&#39;\neq\tau}
        \text{Cov}(\hat\beta^{SA}_{d,\tau},\hat\beta^{SA}_{d&#39;,\tau&#39;})w^k(d,d-1,\tau,\infty)w^k(d&#39;,d&#39;-1,\tau&#39;,\infty)\right),
\end{align*}\]</span></p>
<p>where:</p>
<p><span class="math display">\[\begin{align*}
V(\hat\beta^{SA}_{d,\tau}) &amp; =\frac{1}{p^{d,\tau}}\left[\frac{\var{Y^0_{i,d-1}|D_i=\infty}}{(1-p^{d,\tau}_D)(1-p^{d,\tau}_A)}
                            +\frac{\var{Y^0_{i,d-1}|D_i=d}}{p^{d,\tau}_D(1-p^{d,\tau}_A)}\right. \\
                          &amp; \phantom{=}
                            \left.+\frac{\var{Y^0_{i,d+\tau}|D_i=\infty}}{(1-p^{d,\tau}_D)p^{d,\tau}_A}
                            +\frac{\var{Y^1_{i,d+\tau}|D_i=\infty}}{p^{d,\tau}_Dp^{d,\tau}_A}\right]\\
\text{Cov}(\hat\beta^{SA}_{d,\tau},\hat\beta^{SA}_{d&#39;,\tau&#39;}) &amp; = \frac{p^{d,\tau,d&#39;,\tau&#39;}p_{d-1}^{d,\tau,d&#39;,\tau&#39;}}{p^{d,\tau}p^{d&#39;,\tau&#39;}}
            \left[\frac{\var{Y^0_{i,d-1}|D_i=\infty}(1-p_D^{d,\tau,d&#39;,\tau&#39;})}{(1-p_A^{d,\tau})(1-p_A^{d&#39;,\tau&#39;})(1-p_D^{d,\tau})(1-p_D^{d&#39;,\tau&#39;})} \right.\\
                &amp; \phantom{=\frac{p^{d,\tau,d&#39;,\tau&#39;}p_{d-1}^{d,\tau,d&#39;,\tau&#39;}}{p^{d,\tau}p^{d&#39;,\tau&#39;}}}\left.
                +\frac{\var{Y^0_{i,d-1}|D_i=d}p_D^{d,\tau,d&#39;,\tau&#39;}}{(1-p_A^{d,\tau})(1-p_A^{d&#39;,\tau&#39;})p_D^{d,\tau}p_D^{d&#39;,\tau&#39;}}\right] \text{ when } d=d&#39;\\
          &amp; = \frac{p^{d,\tau,d&#39;,\tau&#39;}p_{d+\tau}^{d,\tau,d&#39;,\tau&#39;}\var{Y^0_{i,d+\tau}|D_i=\infty}(1-p_D^{d,\tau,d&#39;,\tau&#39;})}{p^{d,\tau}p^{d&#39;,\tau&#39;}p_A^{d,\tau}p_A^{d&#39;,\tau&#39;}(1-p_D^{d,\tau})(1-p_D^{d&#39;,\tau&#39;})}\text{ when } d+\tau=d&#39;+\tau&#39; \\
          &amp; = -\frac{p^{d,\tau,d&#39;,\tau&#39;}p_{d-1}^{d,\tau,d&#39;,\tau&#39;}\var{Y^0_{i,d-1}|D_i=\infty}(1-p_D^{d,\tau,d&#39;,\tau&#39;})}{p^{d,\tau}p^{d&#39;,\tau&#39;}(1-p_A^{d,\tau})p_A^{d&#39;,\tau&#39;}(1-p_D^{d,\tau})(1-p_D^{d&#39;,\tau&#39;})} \text{ when } d-1=d&#39;+\tau&#39;\\
          &amp; = -\frac{p^{d,\tau,d&#39;,\tau&#39;}p_{d&#39;-1}^{d,\tau,d&#39;,\tau&#39;}\var{Y^0_{i,d&#39;-1}|D_i=\infty}(1-p_D^{d,\tau,d&#39;,\tau&#39;})}{p^{d,\tau}p^{d&#39;,\tau&#39;}p_A^{d,\tau}(1-p_A^{d&#39;,\tau&#39;})(1-p_D^{d,\tau})(1-p_D^{d&#39;,\tau&#39;})} \text{ when } d+\tau=d&#39;-1\\
          &amp; = 0 \text{ otherwise}.
\end{align*}\]</span></p>
<p>with <span class="math inline">\(p^{d,\tau}=\Pr((D_i=d\cup D_i=\infty)\cap(T_i=d-1\cup T_i=d+\tau))\)</span>, <span class="math inline">\(p^{d,\tau}_D=\Pr(D_i=d|(D_i=d\cup D_i=\infty)\cap(T_i=d-1\cup T_i=d+\tau))\)</span>, <span class="math inline">\(p^{d,\tau}_A=\Pr(T_i=d+\tau|(D_i=d\cup D_i=\infty)\cap(T_i=d-1\cup T_i=d+\tau))\)</span>, <span class="math inline">\(p^{d,\tau,d&#39;,\tau&#39;}=\Pr(D_j^{d&#39;,\tau&#39;}D_j^{d,\tau}=1)\)</span>, <span class="math inline">\(p_{d+\tau}^{d,\tau,d&#39;,\tau&#39;}=\Pr(T_j=d+\tau|D_j^{d&#39;,\tau&#39;}D_j^{d,\tau}=1)\)</span> and <span class="math inline">\(p_D^{d,\tau,d&#39;,\tau&#39;}=\Pr(D_j^{d&#39;}=1\cup D_j^{d}=1|D_j^{d&#39;,\tau&#39;}D_j^{d,\tau}=1)\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-146" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofasympnoiseSATTCross">A.3.6</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-147" class="remark"><em>Remark</em>. </span>Note that the covariance terms in Theorem <a href="NE.html#thm:asympnoiseSATTCross">4.26</a> make a lot of sense.
First, the proportions used to normalize the variance terms correspond exactly to the proportion of observations in the relevant groups.
Second, the signs of the covariances are consistent with common sense.
When <span class="math inline">\(d=d&#39;\)</span>, the individual components <span class="math inline">\(\hat\beta^{SA}_{d,\tau}\)</span> and <span class="math inline">\(\hat\beta^{SA}_{d&#39;,\tau&#39;}\)</span> estimate the impact for the same treatment group.
They thus share their baseline means (both for the treated and control group observed at period <span class="math inline">\(d-1\)</span>).
As a consequence, they are positively correlated.
When <span class="math inline">\(d+\tau=d&#39;+\tau&#39;\)</span>, both groups share the same post-treatment period, and thus use the same observations from the control group to build the After period, thereby generating a positive correlation again.
When <span class="math inline">\(d-1=d&#39;+\tau&#39;\)</span> or <span class="math inline">\(d&#39;-1=d+\tau\)</span>, both estimators share the same group of observations from the control group.
One uses them as a reference period, while the other uses the same observations as the after treatment period.
As a consequence, the estimators are negatively correlated in that case.</p>
</div>
</div>
<div id="estimation-of-sampling-noise-for-aggregate-treatment-effects-with-panel-data" class="section level6 hasAnchor" number="4.3.3.3.2.2">
<h6><span class="header-section-number">4.3.3.3.2.2</span> Estimation of sampling noise for aggregate treatment effects with panel data<a href="NE.html#estimation-of-sampling-noise-for-aggregate-treatment-effects-with-panel-data" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>Finally, we need to determine the asymptotic distribution of the aggregate average treatment effect on the treated <span class="math inline">\(\Delta^Y_{TT}(k)\)</span> in panel data.
Panel data are a very different animal from repeated cross sections in that we follow the same individuals over time.
We thus need to be extra careful on what we assume on the correlation of the outcomes of each individual over time.
In this section, we are going to rule out any autocorrelation between error terms in levels.
We will relax this assumption later.</p>
<p>We encode our main assumption on autocorrelation of outcomes over time as follows:</p>
<div class="hypothesis">
<p><span id="hyp:iidDIDPanel" class="hypothesis"><strong>Hypothesis 4.28  (i.i.d. sampling in panel data) </strong></span>We assume that potential outcomes are geenrated as follows:</p>
<p><span class="math display">\[\begin{align*}
  Y^0_{i,t} &amp; = \mu_i + \delta_t + U^0_{i,t}\\
  Y^1_{i,t} &amp; = \mu_i + \delta_t + \bar{\alpha} +\eta_{i,t} + U^0_{i,t},
\end{align*}\]</span></p>
<p>with <span class="math inline">\(\esp{U^0_{i,t}}=\esp{\eta_{i,t}}=0\)</span>, <span class="math inline">\(\forall t\)</span>, <span class="math inline">\(\esp{U^0_{i,t}|D_i}=0\)</span>, <span class="math inline">\(\forall t\)</span> and:</p>
<p><span class="math display">\[\begin{align*}
\forall i,j\leq N\text{, }\forall t,t&#39;\leq T\text{, with either }i\neq j \text{ or } t\neq t&#39; &amp; (U^0_{i,t},\eta_{i,t},D_i)\Ind(U^0_{j,t&#39;},\eta_{j,t&#39;},D_j),\\
                                           &amp; (U^0_{i,t},\eta_{i,t},D_i)\&amp;(U^0_{j,t&#39;},\eta_{j,t&#39;},D_j)\sim F_{U^0,\eta,D} .
\end{align*}\]</span></p>
</div>
<div class="remark">
<p><span id="unlabeled-div-148" class="remark"><em>Remark</em>. </span>Assumption <a href="NE.html#hyp:iidDIDPanel">4.28</a> is restrictive.
For example, it prevents error terms to be correlated over time for each unit <span class="math inline">\(i\)</span>, which requires <span class="math inline">\(\rho=0\)</span> in our toy model.
It also requires that individual treatment effects are not autocorrelated over time, which for example requires that <span class="math inline">\(\theta_d=0\)</span> in our model and that <span class="math inline">\(\eta_{i,t}\)</span> is not autocorrelated over time.
It means that treatment effects cannot be correlated with fixed effects, a huge assumption, and that agents with high treatment effects at one period are not more likely to have high treatment effects the next period.
These assumptions are obviously too strong.
We will see how to relax them in Chapter <a href="cluster.html#cluster">9</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-149" class="remark"><em>Remark</em>. </span>Note that Assumption <a href="NE.html#hyp:iidDIDPanel">4.28</a> implies Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a>.
The proof is left as an exercise.</p>
</div>
<div class="theorem">
<p><span id="thm:asympnoiseSATTPanel" class="theorem"><strong>Theorem 4.27  (Asymptotic Distribution of Treatment of the Treated Estimated Using Sun and Abraham Estimator in Panel Data) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrends">4.14</a>, <a href="NE.html#hyp:iidDIDPanel">4.28</a> and <a href="NE.html#hyp:finitevarDID">4.16</a>, and with panel data containing a total of <span class="math inline">\(N\)</span> units observed over <span class="math inline">\(T\)</span> time periods, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}(\hat\Delta^{Y}_{TT_{SA}}(k)-\Delta^{Y}_{TT_{SA}}(k)) &amp; \stackrel{d}{\rightarrow}
  \mathcal{N}\left(0,\sum_d\sum_{\tau}V_P(\hat\beta^{SA}_{d,\tau})(w^k(d,d-1,\tau,\infty))^2\right.\\
      &amp; \phantom{\stackrel{d}{\rightarrow}}\left.+\sum_{d}\sum_{d&#39;}\sum_{\tau}\sum_{\tau&#39;\neq\tau}
        \text{Cov}_P(\hat\beta^{SA}_{d,\tau},\hat\beta^{SA}_{d&#39;,\tau&#39;})w^k(d,d-1,\tau,\infty)w^k(d&#39;,d&#39;-1,\tau&#39;,\infty)\right),
\end{align*}\]</span></p>
<p>where:</p>
<p><span class="math display">\[\begin{align*}
V_P(\hat\beta^{SA}_{d,\tau}) &amp; =\frac{1}{p^{d,\infty}}\left(\frac{\var{Y_{i,d+\tau}^1-Y_{i,d-1}^0|D_i=d}}{p^{d,\infty}_D}+\frac{\var{Y_{i,d+\tau}^0-Y_{i,d-1}^0|D_i=\infty}}{1-p^{d,\infty}_D}\right)\\
\text{Cov}_P(\hat\beta^{SA}_{d,\tau},\hat\beta^{SA}_{d&#39;,\tau&#39;})
&amp; = \frac{1}{p^{d,\infty}}\left[\frac{\var{U^0_{i,d-1}|D_i=\infty}}{1-p^{d,\infty}_D}+\frac{\var{U^0_{i,d-1}|D_i=d}}{p^{d,\infty}_D}\right] \text{ when } d=d&#39;\\
&amp; = \frac{1}{p^{d&#39;,\infty}}\frac{\var{U^0_{i,d&#39;+\tau&#39;}|D_i=\infty}}{1-p^{d&#39;,\infty}_D}  \text{ when } d+\tau=d&#39;+\tau&#39; \\
&amp; = -\frac{1}{p^{d&#39;,\infty}}\frac{\var{U^0_{i,d&#39;+\tau&#39;}|D_i=\infty}}{1-p^{d&#39;,\infty}_D}   \text{ when } d-1=d&#39;+\tau&#39; \\
&amp; = -\frac{1}{p^{d,\infty}}\frac{\var{U^0_{i,d+\tau}|D_i=\infty}}{1-p^{d,\infty}_D}    \text{ when } d+\tau=d&#39;-1\\
&amp; = 0 \text{ otherwise},
\end{align*}\]</span></p>
<p>with <span class="math inline">\(p^{d,\infty}=\Pr(D_i=d\cup D_i=\infty)\)</span> and <span class="math inline">\(p^{d,\infty}_D=\Pr(D_i=d|D_i=d\cup D_i=\infty)\)</span>.</p>
</div>
<div class="proof">
<p><span id="unlabeled-div-150" class="proof"><em>Proof</em>. </span>See Section <a href="proofs.html#proofasympnoiseSATTPanel">A.3.8</a>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-151" class="remark"><em>Remark</em>. </span>The result in Theorem <a href="NE.html#thm:asympnoiseSATTPanel">4.27</a> makes intuitive sense.
Under Assumption <a href="NE.html#hyp:iidDIDPanel">4.28</a>, the only source of correlation between individual treatment effects <span class="math inline">\(\hat\beta^{SA}_{d,\tau}\)</span> and <span class="math inline">\(\hat\beta^{SA}_{d&#39;,\tau&#39;}\)</span> is when they share part of the data that yields to their estimation.
When <span class="math inline">\(d=d&#39;\)</span>, they share the same reference period for both the treated and the untreated groups.
When <span class="math inline">\(d+\tau=d&#39;+\tau&#39;\)</span>, they share the same end period for the untreated group.
It means that in both of these cases, the two estimators are positively correlated.
When <span class="math inline">\(d-1=d&#39;+\tau&#39;\)</span> or when <span class="math inline">\(d+\tau=d&#39;-1\)</span>, the reference period of one serves as the ending period for the other, both for the untreated group.
In these two cases, the two estimators are negatively correlated.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-152" class="remark"><em>Remark</em>. </span>Note also that the result in Theorem <a href="NE.html#thm:asympnoiseSATTPanel">4.27</a> suggests that, in some cases, the treatment on the treated parameter is going to be more precise than the individual level estimates.
Let’s assume for simplicity one treatment group, <span class="math inline">\(\frac{T}{2}\)</span> treatment periods, the same variance for all individual level estimates, the same weigths for combining them in the ATT (<span class="math inline">\(\frac{2}{T}\)</span>) and no correlation between each individual estimator, then we have <span class="math inline">\(V_P(\hat\Delta^{Y}_{TT_{SA}}(k))=\frac{2}{T}V_P(\hat\beta^{SA})\)</span>, which is smaller than <span class="math inline">\(V_P(\hat\beta^{SA})\)</span> as soon as <span class="math inline">\(T\geq 3\)</span>.
Intuitively, under the assumptions in this remark, each individual estimate is an independent estimate of the same parameter, and thus, according to the CLT, precision increases with the square root of the number of additional observations, which is proportional to <span class="math inline">\(\sqrt{\frac{2}{T}}\)</span>.
Under more general conditions, this simple relationship might not hold.
It might be the case for example that some treatment effects might be less precisely estimated than others, and thus that the precision of the resulting average treatment effect might be intermediate between the precision of the two individual estimates.
The existence of covariance terms between the individual treatment estimates might also increase (or decrease) the eventual precision of the average treatment effect estimate.</p>
</div>
</div>
</div>
<div id="stackedFD" class="section level5 hasAnchor" number="4.3.3.3.3">
<h5><span class="header-section-number">4.3.3.3.3</span> Estimation of sampling noise in practice<a href="NE.html#stackedFD" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Until now, we have looked at sampling noise in a theoretical way.
Let’s see in practice how to estimate sampling noise in a staggered DID design in practice.
There are several ways to estimate sampling noise for the Sunn and Abraham estimator that we have studied in detail.
We could either use the plug-in formulas we have derived in Theorems <a href="NE.html#thm:asympnoiseSACross">4.24</a>, <a href="NE.html#thm:asympnoiseSAPanel">4.25</a>, <a href="NE.html#thm:asympnoiseSATTCross">4.26</a> and <a href="NE.html#thm:asympnoiseSATTPanel">4.27</a>.
We could also use the heteroskedasticity-robust standard errors that the <code>fixest</code> package spits out when using <code>feols</code> with the <code>sunab</code> option.
We could also use only the <span class="math inline">\(2\times 2\)</span> DID estimators with a first difference estimator using OLS and heteroskedasticity-robust standard errors.
We could also use the stacked First Difference estimator that we have use in the proof of Theorem <a href="NE.html#thm:EquivDIDSAsamp">4.20</a> (we know it is identical to the Sun and Abraham estimator) and use a heteroskedasticity-robust covariance matrix estimator.</p>
<p>For now, we are going to compare the estimates of sampling noise stemming from <span class="math inline">\(2\times 2\)</span> DID estimators and the stacked First Difference estimator to the ones stemming from the <code>fixest</code> implementation of Sun and Abraham estimator, and to the true level of sampling noise stemming from Monte Carlo simulations.
We are also going to compare the estimates of sampling noise for the TT parameter using the <code>fixest</code> implementation of Sun and Abraham estimator and the stacked First Difference estimator and compare them to the Monte Carlo estimates.
Let’s go.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-268" class="example"><strong>Example 4.53  </strong></span>Let’s see how <span class="math inline">\(2\times 2\)</span> DID estimators, the stacked First Difference estimator and the <code>fixest</code> implementation of Sun and Abraham estimator perform in our example.</p>
</div>
<p>In order to do so, we are first going to write a function implementing our <span class="math inline">\(2\times 2\)</span> DID estimators automatically.</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="NE.html#cb250-1" tabindex="-1"></a><span class="co"># function estimating 2x2 DID and heteroskedasticity-robust standard error with within and first difference estimators</span></span>
<span id="cb250-2"><a href="NE.html#cb250-2" tabindex="-1"></a><span class="co"># StaggeredDID22 is a function that takes as inputs:</span></span>
<span id="cb250-3"><a href="NE.html#cb250-3" tabindex="-1"></a><span class="co"># y: name of outcome variable (character)</span></span>
<span id="cb250-4"><a href="NE.html#cb250-4" tabindex="-1"></a><span class="co"># D: name of treatment group variable (character)</span></span>
<span id="cb250-5"><a href="NE.html#cb250-5" tabindex="-1"></a><span class="co"># d: treatment group defined by date of entry into the treatment</span></span>
<span id="cb250-6"><a href="NE.html#cb250-6" tabindex="-1"></a><span class="co"># dprime: comparison group</span></span>
<span id="cb250-7"><a href="NE.html#cb250-7" tabindex="-1"></a><span class="co"># tau: number of periods after treatment date at which we estimate the effect of the treatment</span></span>
<span id="cb250-8"><a href="NE.html#cb250-8" tabindex="-1"></a><span class="co"># tauprime: number of periods before the treatment date that we use a baseline period (defaults to one)</span></span>
<span id="cb250-9"><a href="NE.html#cb250-9" tabindex="-1"></a><span class="co"># t: time indicator (character)</span></span>
<span id="cb250-10"><a href="NE.html#cb250-10" tabindex="-1"></a><span class="co"># i: individual unit indicator (character)</span></span>
<span id="cb250-11"><a href="NE.html#cb250-11" tabindex="-1"></a><span class="co"># data: dataset containing the outcomes and treatments and time and unit indicators</span></span>
<span id="cb250-12"><a href="NE.html#cb250-12" tabindex="-1"></a>StaggeredDID22 <span class="ot">&lt;-</span> <span class="cf">function</span>(tau,d,y,D,dprime,<span class="at">tauprime=</span><span class="dv">1</span>,t,i,data){</span>
<span id="cb250-13"><a href="NE.html#cb250-13" tabindex="-1"></a>  <span class="co"># taking out the irrelevant groups and time periods and generating a useful treatment variable</span></span>
<span id="cb250-14"><a href="NE.html#cb250-14" tabindex="-1"></a>  data.DID <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb250-15"><a href="NE.html#cb250-15" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(D) <span class="sc">==</span> d <span class="sc">|</span> <span class="sc">!!</span><span class="fu">sym</span>(D) <span class="sc">==</span> dprime) <span class="sc">%&gt;%</span> </span>
<span id="cb250-16"><a href="NE.html#cb250-16" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(t) <span class="sc">==</span> d<span class="sc">+</span>tau <span class="sc">|</span> <span class="sc">!!</span><span class="fu">sym</span>(t)<span class="sc">==</span>d<span class="sc">-</span>tauprime) <span class="sc">%&gt;%</span></span>
<span id="cb250-17"><a href="NE.html#cb250-17" tabindex="-1"></a>            <span class="fu">mutate</span>(</span>
<span id="cb250-18"><a href="NE.html#cb250-18" tabindex="-1"></a>              <span class="at">Dit =</span> <span class="fu">if_else</span>(<span class="sc">!!</span><span class="fu">sym</span>(D) <span class="sc">==</span> d <span class="sc">&amp;</span> <span class="sc">!!</span><span class="fu">sym</span>(t) <span class="sc">==</span> d<span class="sc">+</span>tau,<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb250-19"><a href="NE.html#cb250-19" tabindex="-1"></a>              <span class="at">time =</span> <span class="fu">case_when</span>(</span>
<span id="cb250-20"><a href="NE.html#cb250-20" tabindex="-1"></a>                        <span class="sc">!!</span><span class="fu">sym</span>(t) <span class="sc">==</span> d<span class="sc">+</span>tau <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb250-21"><a href="NE.html#cb250-21" tabindex="-1"></a>                        <span class="sc">!!</span><span class="fu">sym</span>(t) <span class="sc">==</span> d<span class="sc">-</span>tauprime <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb250-22"><a href="NE.html#cb250-22" tabindex="-1"></a>                        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">9999</span></span>
<span id="cb250-23"><a href="NE.html#cb250-23" tabindex="-1"></a>              )</span>
<span id="cb250-24"><a href="NE.html#cb250-24" tabindex="-1"></a>            )</span>
<span id="cb250-25"><a href="NE.html#cb250-25" tabindex="-1"></a>  <span class="co"># running the within estimator (fixest)</span></span>
<span id="cb250-26"><a href="NE.html#cb250-26" tabindex="-1"></a>  <span class="co"># regression formula for the within estimator</span></span>
<span id="cb250-27"><a href="NE.html#cb250-27" tabindex="-1"></a>  DID.form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="fu">paste</span>(y,<span class="fu">paste</span>(<span class="st">&quot;Dit&quot;</span>,t,<span class="at">sep=</span><span class="st">&quot;+&quot;</span>),<span class="at">sep=</span><span class="st">&quot;~&quot;</span>),i,<span class="at">sep=</span><span class="st">&quot;|&quot;</span>))</span>
<span id="cb250-28"><a href="NE.html#cb250-28" tabindex="-1"></a>  reg.W.fixest <span class="ot">&lt;-</span> <span class="fu">feols</span>(DID.form,<span class="at">vcov=</span><span class="st">&#39;HC1&#39;</span>,<span class="at">data =</span> data.DID)</span>
<span id="cb250-29"><a href="NE.html#cb250-29" tabindex="-1"></a>  <span class="co"># regression for the first difference estimator</span></span>
<span id="cb250-30"><a href="NE.html#cb250-30" tabindex="-1"></a>  data.DID <span class="ot">&lt;-</span> data.DID <span class="sc">%&gt;%</span></span>
<span id="cb250-31"><a href="NE.html#cb250-31" tabindex="-1"></a>                <span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="sc">!!</span><span class="fu">sym</span>(i),<span class="at">names_from=</span>time,<span class="at">values_from=</span><span class="fu">c</span>(<span class="st">&#39;Dit&#39;</span>,y),<span class="at">names_sep=</span><span class="st">&#39;_&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb250-32"><a href="NE.html#cb250-32" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb250-33"><a href="NE.html#cb250-33" tabindex="-1"></a>                  <span class="at">DeltaY =</span> <span class="sc">!!</span><span class="fu">sym</span>(<span class="fu">paste</span>(y,<span class="dv">1</span>,<span class="at">sep=</span><span class="st">&#39;_&#39;</span>))<span class="sc">-!!</span><span class="fu">sym</span>(<span class="fu">paste</span>(y,<span class="dv">0</span>,<span class="at">sep=</span><span class="st">&#39;_&#39;</span>)),</span>
<span id="cb250-34"><a href="NE.html#cb250-34" tabindex="-1"></a>                  <span class="at">DeltaD =</span> <span class="sc">!!</span><span class="fu">sym</span>(<span class="fu">paste</span>(<span class="st">&#39;Dit&#39;</span>,<span class="dv">1</span>,<span class="at">sep=</span><span class="st">&#39;_&#39;</span>))<span class="sc">-!!</span><span class="fu">sym</span>(<span class="fu">paste</span>(<span class="st">&#39;Dit&#39;</span>,<span class="dv">0</span>,<span class="at">sep=</span><span class="st">&#39;_&#39;</span>))</span>
<span id="cb250-35"><a href="NE.html#cb250-35" tabindex="-1"></a>                )</span>
<span id="cb250-36"><a href="NE.html#cb250-36" tabindex="-1"></a>  DID.FD.form <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="fu">paste</span>(<span class="st">&quot;DeltaY&quot;</span>,<span class="st">&quot;DeltaD&quot;</span>,<span class="at">sep=</span><span class="st">&quot;~&quot;</span>),<span class="dv">1</span>,<span class="at">sep=</span><span class="st">&quot;|&quot;</span>))</span>
<span id="cb250-37"><a href="NE.html#cb250-37" tabindex="-1"></a>  reg.FD.fixest <span class="ot">&lt;-</span> <span class="fu">feols</span>(DID.FD.form,<span class="at">vcov=</span><span class="st">&#39;HC1&#39;</span>,<span class="at">data =</span> data.DID)</span>
<span id="cb250-38"><a href="NE.html#cb250-38" tabindex="-1"></a>  <span class="co"># result vector</span></span>
<span id="cb250-39"><a href="NE.html#cb250-39" tabindex="-1"></a>  DID.est.W.fixest <span class="ot">&lt;-</span> <span class="fu">c</span>(d,dprime,tau,tauprime,<span class="fu">coef</span>(reg.W.fixest)[[<span class="dv">1</span>]],<span class="fu">sqrt</span>(<span class="fu">vcov</span>(reg.W.fixest)[[<span class="dv">1</span>,<span class="dv">1</span>]]),<span class="fu">coef</span>(reg.FD.fixest)[[<span class="dv">2</span>]],<span class="fu">sqrt</span>(<span class="fu">vcov</span>(reg.FD.fixest)[[<span class="dv">2</span>,<span class="dv">2</span>]]))</span>
<span id="cb250-40"><a href="NE.html#cb250-40" tabindex="-1"></a>  <span class="fu">names</span>(DID.est.W.fixest) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;d&quot;</span>,<span class="st">&quot;dprime&quot;</span>,<span class="st">&quot;tau&quot;</span>,<span class="st">&quot;tauprime&quot;</span>,<span class="st">&quot;WithinEst&quot;</span>,<span class="st">&quot;WithinSe&quot;</span>,<span class="st">&quot;FDEst&quot;</span>,<span class="st">&quot;FDSe&quot;</span>)</span>
<span id="cb250-41"><a href="NE.html#cb250-41" tabindex="-1"></a>  <span class="fu">return</span>(DID.est.W.fixest)</span>
<span id="cb250-42"><a href="NE.html#cb250-42" tabindex="-1"></a>}</span>
<span id="cb250-43"><a href="NE.html#cb250-43" tabindex="-1"></a><span class="co">#test &lt;- StaggeredDID22(tau=1,d=2,y=&#39;y&#39;,D=&#39;Ds&#39;,dprime=99,tauprime=1,t=&quot;time&quot;,i=&quot;id&quot;,data=data) </span></span></code></pre></div>
<p>Let’s now write a function implementing the stacked First Difference estimator automatically.</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="NE.html#cb251-1" tabindex="-1"></a><span class="co"># function estimating 2x2 DID and heteroskedasticity-robust standard error and covariance matrix with stacked first difference</span></span>
<span id="cb251-2"><a href="NE.html#cb251-2" tabindex="-1"></a><span class="co"># StackedDIDFD is a function that takes as inputs:</span></span>
<span id="cb251-3"><a href="NE.html#cb251-3" tabindex="-1"></a><span class="co"># y: name of outcome variable (character)</span></span>
<span id="cb251-4"><a href="NE.html#cb251-4" tabindex="-1"></a><span class="co"># D: name of treatment group variable (character)</span></span>
<span id="cb251-5"><a href="NE.html#cb251-5" tabindex="-1"></a><span class="co"># dprime: comparison group</span></span>
<span id="cb251-6"><a href="NE.html#cb251-6" tabindex="-1"></a><span class="co"># tauprime: number of periods before the treatment date that we use a baseline period (defaults to one)</span></span>
<span id="cb251-7"><a href="NE.html#cb251-7" tabindex="-1"></a><span class="co"># t: time indicator (character)</span></span>
<span id="cb251-8"><a href="NE.html#cb251-8" tabindex="-1"></a><span class="co"># i: individual unit indicator (character)</span></span>
<span id="cb251-9"><a href="NE.html#cb251-9" tabindex="-1"></a><span class="co"># Leung: whether we use a Leung-robust covariance matrix for time</span></span>
<span id="cb251-10"><a href="NE.html#cb251-10" tabindex="-1"></a><span class="co"># data: dataset containing the outcomes and treatments and time and unit indicators</span></span>
<span id="cb251-11"><a href="NE.html#cb251-11" tabindex="-1"></a>StackedDIDFD <span class="ot">&lt;-</span> <span class="cf">function</span>(y,D,dprime.ref,<span class="at">tauprime.ref=</span><span class="dv">1</span>,t,i,<span class="at">Leung=</span><span class="st">&quot;None&quot;</span>,data){</span>
<span id="cb251-12"><a href="NE.html#cb251-12" tabindex="-1"></a>  <span class="co"># levels of the treatment (without never treated)</span></span>
<span id="cb251-13"><a href="NE.html#cb251-13" tabindex="-1"></a>  d <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">test =</span> <span class="fu">as.factor</span>(<span class="sc">!!</span><span class="fu">sym</span>(D))) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(test) <span class="sc">%&gt;%</span> <span class="fu">levels</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.character</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>(.) </span>
<span id="cb251-14"><a href="NE.html#cb251-14" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d[d<span class="sc">!=</span>dprime.ref]</span>
<span id="cb251-15"><a href="NE.html#cb251-15" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d[<span class="fu">order</span>(d)]</span>
<span id="cb251-16"><a href="NE.html#cb251-16" tabindex="-1"></a>  <span class="co"># list of possible treatment periods for each treatment group</span></span>
<span id="cb251-17"><a href="NE.html#cb251-17" tabindex="-1"></a>  <span class="co"># first, list of time periods</span></span>
<span id="cb251-18"><a href="NE.html#cb251-18" tabindex="-1"></a>  time <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">test =</span> <span class="fu">as.factor</span>(<span class="sc">!!</span><span class="fu">sym</span>(t))) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(test) <span class="sc">%&gt;%</span> <span class="fu">levels</span>(.) <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>(.) </span>
<span id="cb251-19"><a href="NE.html#cb251-19" tabindex="-1"></a>  time <span class="ot">&lt;-</span> time[<span class="fu">order</span>(time)]</span>
<span id="cb251-20"><a href="NE.html#cb251-20" tabindex="-1"></a>  <span class="co"># dataset of all treatment groups and all time periods</span></span>
<span id="cb251-21"><a href="NE.html#cb251-21" tabindex="-1"></a>  d.expand <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(d,rep,<span class="fu">length</span>(time)))</span>
<span id="cb251-22"><a href="NE.html#cb251-22" tabindex="-1"></a>  time.expand <span class="ot">&lt;-</span> <span class="fu">rep</span>(time,<span class="fu">length</span>(d))</span>
<span id="cb251-23"><a href="NE.html#cb251-23" tabindex="-1"></a>  data.structure <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">d=</span>d.expand,<span class="at">time=</span>time.expand) <span class="sc">%&gt;%</span></span>
<span id="cb251-24"><a href="NE.html#cb251-24" tabindex="-1"></a>    <span class="co"># time in relative periods for each d</span></span>
<span id="cb251-25"><a href="NE.html#cb251-25" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb251-26"><a href="NE.html#cb251-26" tabindex="-1"></a>      <span class="at">TimeToTreatment =</span> time<span class="sc">-</span>d</span>
<span id="cb251-27"><a href="NE.html#cb251-27" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb251-28"><a href="NE.html#cb251-28" tabindex="-1"></a>  <span class="co"># detection of treatment groups without any reference period</span></span>
<span id="cb251-29"><a href="NE.html#cb251-29" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb251-30"><a href="NE.html#cb251-30" tabindex="-1"></a>      <span class="at">ReferencePeriod =</span> <span class="fu">case_when</span>(</span>
<span id="cb251-31"><a href="NE.html#cb251-31" tabindex="-1"></a>        TimeToTreatment <span class="sc">==</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb251-32"><a href="NE.html#cb251-32" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb251-33"><a href="NE.html#cb251-33" tabindex="-1"></a>      )</span>
<span id="cb251-34"><a href="NE.html#cb251-34" tabindex="-1"></a>    ) </span>
<span id="cb251-35"><a href="NE.html#cb251-35" tabindex="-1"></a>  <span class="co"># Treatment groups without reference period (for whom estimation is impossible)</span></span>
<span id="cb251-36"><a href="NE.html#cb251-36" tabindex="-1"></a>  Groups.impossible <span class="ot">&lt;-</span> data.structure <span class="sc">%&gt;%</span></span>
<span id="cb251-37"><a href="NE.html#cb251-37" tabindex="-1"></a>                        <span class="fu">group_by</span>(d) <span class="sc">%&gt;%</span></span>
<span id="cb251-38"><a href="NE.html#cb251-38" tabindex="-1"></a>                        <span class="fu">summarize</span>(</span>
<span id="cb251-39"><a href="NE.html#cb251-39" tabindex="-1"></a>                          <span class="at">MaxReferencePeriod =</span> <span class="fu">max</span>(ReferencePeriod)</span>
<span id="cb251-40"><a href="NE.html#cb251-40" tabindex="-1"></a>                        ) <span class="sc">%&gt;%</span></span>
<span id="cb251-41"><a href="NE.html#cb251-41" tabindex="-1"></a>                        <span class="fu">filter</span>(MaxReferencePeriod<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb251-42"><a href="NE.html#cb251-42" tabindex="-1"></a>                        <span class="fu">pull</span>(d) <span class="sc">%&gt;%</span></span>
<span id="cb251-43"><a href="NE.html#cb251-43" tabindex="-1"></a>                        <span class="fu">unique</span>(.) </span>
<span id="cb251-44"><a href="NE.html#cb251-44" tabindex="-1"></a>  <span class="co"># Treatment groups with a reference period (for whom estimation is possible)</span></span>
<span id="cb251-45"><a href="NE.html#cb251-45" tabindex="-1"></a>  Groups.possible <span class="ot">&lt;-</span> data.structure <span class="sc">%&gt;%</span> </span>
<span id="cb251-46"><a href="NE.html#cb251-46" tabindex="-1"></a>                      <span class="fu">group_by</span>(d) <span class="sc">%&gt;%</span></span>
<span id="cb251-47"><a href="NE.html#cb251-47" tabindex="-1"></a>                      <span class="fu">mutate</span>(</span>
<span id="cb251-48"><a href="NE.html#cb251-48" tabindex="-1"></a>                        <span class="at">MaxReferencePeriod =</span> <span class="fu">max</span>(ReferencePeriod)</span>
<span id="cb251-49"><a href="NE.html#cb251-49" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb251-50"><a href="NE.html#cb251-50" tabindex="-1"></a>                      <span class="fu">filter</span>(MaxReferencePeriod<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb251-51"><a href="NE.html#cb251-51" tabindex="-1"></a>                      <span class="fu">pull</span>(d) <span class="sc">%&gt;%</span></span>
<span id="cb251-52"><a href="NE.html#cb251-52" tabindex="-1"></a>                      <span class="fu">unique</span>(.)</span>
<span id="cb251-53"><a href="NE.html#cb251-53" tabindex="-1"></a>  <span class="co"># data for which estimation if feasible</span></span>
<span id="cb251-54"><a href="NE.html#cb251-54" tabindex="-1"></a>  data.structure <span class="ot">&lt;-</span> data.structure <span class="sc">%&gt;%</span> </span>
<span id="cb251-55"><a href="NE.html#cb251-55" tabindex="-1"></a>                      <span class="fu">group_by</span>(d) <span class="sc">%&gt;%</span></span>
<span id="cb251-56"><a href="NE.html#cb251-56" tabindex="-1"></a>                      <span class="fu">mutate</span>(</span>
<span id="cb251-57"><a href="NE.html#cb251-57" tabindex="-1"></a>                        <span class="at">MaxReferencePeriod =</span> <span class="fu">max</span>(ReferencePeriod)</span>
<span id="cb251-58"><a href="NE.html#cb251-58" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb251-59"><a href="NE.html#cb251-59" tabindex="-1"></a>                      <span class="fu">filter</span>(MaxReferencePeriod<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb251-60"><a href="NE.html#cb251-60" tabindex="-1"></a>                      <span class="fu">select</span>(<span class="sc">-</span>MaxReferencePeriod)</span>
<span id="cb251-61"><a href="NE.html#cb251-61" tabindex="-1"></a>  <span class="co"># Adding one line for each time we need the reference period</span></span>
<span id="cb251-62"><a href="NE.html#cb251-62" tabindex="-1"></a>  data.ref <span class="ot">&lt;-</span> data.structure <span class="sc">%&gt;%</span></span>
<span id="cb251-63"><a href="NE.html#cb251-63" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb251-64"><a href="NE.html#cb251-64" tabindex="-1"></a>                  <span class="at">ReferencePeriodName =</span> d<span class="sc">-</span><span class="fu">as.numeric</span>(tauprime.ref)</span>
<span id="cb251-65"><a href="NE.html#cb251-65" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb251-66"><a href="NE.html#cb251-66" tabindex="-1"></a>                <span class="fu">filter</span>(ReferencePeriod<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb251-67"><a href="NE.html#cb251-67" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb251-68"><a href="NE.html#cb251-68" tabindex="-1"></a>                  <span class="at">ReferencePeriod=</span><span class="dv">1</span></span>
<span id="cb251-69"><a href="NE.html#cb251-69" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb251-70"><a href="NE.html#cb251-70" tabindex="-1"></a>                <span class="fu">rename</span>(</span>
<span id="cb251-71"><a href="NE.html#cb251-71" tabindex="-1"></a>                  <span class="at">TimeToTreatmentStar=</span>TimeToTreatment,</span>
<span id="cb251-72"><a href="NE.html#cb251-72" tabindex="-1"></a>                  <span class="at">timestar=</span>time </span>
<span id="cb251-73"><a href="NE.html#cb251-73" tabindex="-1"></a>                ) </span>
<span id="cb251-74"><a href="NE.html#cb251-74" tabindex="-1"></a>  data.structure <span class="ot">&lt;-</span> data.structure <span class="sc">%&gt;%</span></span>
<span id="cb251-75"><a href="NE.html#cb251-75" tabindex="-1"></a>                      <span class="fu">mutate</span>(</span>
<span id="cb251-76"><a href="NE.html#cb251-76" tabindex="-1"></a>                        <span class="at">ReferencePeriodName =</span> d<span class="sc">-</span><span class="fu">as.numeric</span>(tauprime.ref)</span>
<span id="cb251-77"><a href="NE.html#cb251-77" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb251-78"><a href="NE.html#cb251-78" tabindex="-1"></a>                      <span class="fu">left_join</span>(data.ref,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;d&#39;</span>,<span class="st">&#39;ReferencePeriod&#39;</span>,<span class="st">&#39;ReferencePeriodName&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb251-79"><a href="NE.html#cb251-79" tabindex="-1"></a>                      <span class="fu">mutate</span>(</span>
<span id="cb251-80"><a href="NE.html#cb251-80" tabindex="-1"></a>                        <span class="at">TargetPeriod=</span><span class="fu">case_when</span>(</span>
<span id="cb251-81"><a href="NE.html#cb251-81" tabindex="-1"></a>                          <span class="sc">!</span><span class="fu">is.na</span>(timestar) <span class="sc">~</span> timestar,</span>
<span id="cb251-82"><a href="NE.html#cb251-82" tabindex="-1"></a>                          <span class="fu">is.na</span>(timestar) <span class="sc">~</span> time,</span>
<span id="cb251-83"><a href="NE.html#cb251-83" tabindex="-1"></a>                          <span class="cn">TRUE</span><span class="sc">~</span><span class="dv">999999</span></span>
<span id="cb251-84"><a href="NE.html#cb251-84" tabindex="-1"></a>                        ),</span>
<span id="cb251-85"><a href="NE.html#cb251-85" tabindex="-1"></a>                        <span class="at">TargetTimeToTreatment=</span><span class="fu">case_when</span>(</span>
<span id="cb251-86"><a href="NE.html#cb251-86" tabindex="-1"></a>                          <span class="sc">!</span><span class="fu">is.na</span>(TimeToTreatmentStar) <span class="sc">~</span> TimeToTreatmentStar,</span>
<span id="cb251-87"><a href="NE.html#cb251-87" tabindex="-1"></a>                          <span class="fu">is.na</span>(TimeToTreatmentStar) <span class="sc">~</span> TimeToTreatment,</span>
<span id="cb251-88"><a href="NE.html#cb251-88" tabindex="-1"></a>                          <span class="cn">TRUE</span><span class="sc">~</span><span class="dv">999999</span></span>
<span id="cb251-89"><a href="NE.html#cb251-89" tabindex="-1"></a>                        )</span>
<span id="cb251-90"><a href="NE.html#cb251-90" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb251-91"><a href="NE.html#cb251-91" tabindex="-1"></a>                      <span class="fu">select</span>(<span class="sc">-</span>timestar,<span class="sc">-</span>TimeToTreatmentStar) </span>
<span id="cb251-92"><a href="NE.html#cb251-92" tabindex="-1"></a>  </span>
<span id="cb251-93"><a href="NE.html#cb251-93" tabindex="-1"></a>  <span class="co"># building the stacked DID dataset</span></span>
<span id="cb251-94"><a href="NE.html#cb251-94" tabindex="-1"></a>  data.structure <span class="ot">&lt;-</span> data.structure <span class="sc">%&gt;%</span></span>
<span id="cb251-95"><a href="NE.html#cb251-95" tabindex="-1"></a>                      <span class="fu">mutate</span>(</span>
<span id="cb251-96"><a href="NE.html#cb251-96" tabindex="-1"></a>                        <span class="at">dstar =</span> d</span>
<span id="cb251-97"><a href="NE.html#cb251-97" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb251-98"><a href="NE.html#cb251-98" tabindex="-1"></a>                      <span class="fu">rename</span>(</span>
<span id="cb251-99"><a href="NE.html#cb251-99" tabindex="-1"></a>                        <span class="at">TimeToTreatmentStructure =</span> TimeToTreatment</span>
<span id="cb251-100"><a href="NE.html#cb251-100" tabindex="-1"></a>                      )</span>
<span id="cb251-101"><a href="NE.html#cb251-101" tabindex="-1"></a>  </span>
<span id="cb251-102"><a href="NE.html#cb251-102" tabindex="-1"></a>  data.structure.control <span class="ot">&lt;-</span> data.structure <span class="sc">%&gt;%</span></span>
<span id="cb251-103"><a href="NE.html#cb251-103" tabindex="-1"></a>                      <span class="fu">mutate</span>(</span>
<span id="cb251-104"><a href="NE.html#cb251-104" tabindex="-1"></a>                        <span class="at">dstar =</span> <span class="fu">as.numeric</span>(dprime.ref)</span>
<span id="cb251-105"><a href="NE.html#cb251-105" tabindex="-1"></a>                      )</span>
<span id="cb251-106"><a href="NE.html#cb251-106" tabindex="-1"></a>  data.structure <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data.structure,data.structure.control)</span>
<span id="cb251-107"><a href="NE.html#cb251-107" tabindex="-1"></a>  Stacked.DID.Data <span class="ot">&lt;-</span> data.structure <span class="sc">%&gt;%</span></span>
<span id="cb251-108"><a href="NE.html#cb251-108" tabindex="-1"></a>                        <span class="fu">left_join</span>(data,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;time&#39;</span><span class="ot">=</span>t,<span class="st">&#39;dstar&#39;</span><span class="ot">=</span>D)) <span class="sc">%&gt;%</span> </span>
<span id="cb251-109"><a href="NE.html#cb251-109" tabindex="-1"></a>                        <span class="fu">select</span>(id,time,d,dstar,TimeToTreatmentStructure,ReferencePeriod,ReferencePeriodName,TargetPeriod,TargetTimeToTreatment,<span class="sc">!!</span><span class="fu">sym</span>(y)) <span class="sc">%&gt;%</span></span>
<span id="cb251-110"><a href="NE.html#cb251-110" tabindex="-1"></a>                        <span class="fu">arrange</span>(id,d,TargetPeriod,ReferencePeriod) <span class="sc">%&gt;%</span></span>
<span id="cb251-111"><a href="NE.html#cb251-111" tabindex="-1"></a>                        <span class="fu">pivot_wider</span>(<span class="at">id_cols=</span><span class="fu">c</span>(<span class="st">&#39;id&#39;</span>,<span class="st">&#39;d&#39;</span>,<span class="st">&#39;TargetPeriod&#39;</span>,<span class="st">&#39;TargetTimeToTreatment&#39;</span>,<span class="st">&#39;dstar&#39;</span>),<span class="at">names_from=</span><span class="st">&quot;ReferencePeriod&quot;</span>,<span class="at">names_prefix =</span> y,<span class="at">values_from=</span><span class="fu">c</span>(y)) <span class="sc">%&gt;%</span></span>
<span id="cb251-112"><a href="NE.html#cb251-112" tabindex="-1"></a>                        <span class="fu">mutate</span>(</span>
<span id="cb251-113"><a href="NE.html#cb251-113" tabindex="-1"></a>                          <span class="at">DeltaY =</span> <span class="sc">!!</span><span class="fu">sym</span>(<span class="fu">paste</span>(y,<span class="st">&#39;0&#39;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))<span class="sc">-!!</span><span class="fu">sym</span>(<span class="fu">paste</span>(y,<span class="st">&#39;1&#39;</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>)),</span>
<span id="cb251-114"><a href="NE.html#cb251-114" tabindex="-1"></a>                          <span class="at">D =</span> <span class="fu">case_when</span>(</span>
<span id="cb251-115"><a href="NE.html#cb251-115" tabindex="-1"></a>                            dstar <span class="sc">==</span> <span class="fu">as.numeric</span>(dprime.ref) <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb251-116"><a href="NE.html#cb251-116" tabindex="-1"></a>                            <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb251-117"><a href="NE.html#cb251-117" tabindex="-1"></a>                          ),</span>
<span id="cb251-118"><a href="NE.html#cb251-118" tabindex="-1"></a>                          <span class="at">D =</span> <span class="fu">factor</span>(D,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;0&#39;</span>,<span class="st">&#39;1&#39;</span>)),</span>
<span id="cb251-119"><a href="NE.html#cb251-119" tabindex="-1"></a>                          <span class="at">Ddtau =</span> <span class="fu">paste</span>(d,TargetTimeToTreatment,<span class="at">sep=</span><span class="st">&#39;,&#39;</span>)</span>
<span id="cb251-120"><a href="NE.html#cb251-120" tabindex="-1"></a>                        ) <span class="sc">%&gt;%</span></span>
<span id="cb251-121"><a href="NE.html#cb251-121" tabindex="-1"></a>                        <span class="fu">arrange</span>(Ddtau,D,id) <span class="sc">%&gt;%</span></span>
<span id="cb251-122"><a href="NE.html#cb251-122" tabindex="-1"></a>                        <span class="fu">ungroup</span>(.)</span>
<span id="cb251-123"><a href="NE.html#cb251-123" tabindex="-1"></a>   </span>
<span id="cb251-124"><a href="NE.html#cb251-124" tabindex="-1"></a>  <span class="co"># generating the covariates matrix (using the recipes package)</span></span>
<span id="cb251-125"><a href="NE.html#cb251-125" tabindex="-1"></a>   DeltaX <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span> Ddtau<span class="sc">+</span>D,<span class="at">data=</span>Stacked.DID.Data)  <span class="sc">%&gt;%</span> </span>
<span id="cb251-126"><a href="NE.html#cb251-126" tabindex="-1"></a>    <span class="fu">step_dummy</span>(Ddtau,<span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb251-127"><a href="NE.html#cb251-127" tabindex="-1"></a>    <span class="fu">step_dummy</span>(D) <span class="sc">%&gt;%</span> </span>
<span id="cb251-128"><a href="NE.html#cb251-128" tabindex="-1"></a>    <span class="fu">step_interact</span>(<span class="at">terms=</span><span class="sc">~</span><span class="fu">starts_with</span>(<span class="st">&quot;Ddtau&quot;</span>)<span class="sc">:</span>D_X1) <span class="sc">%&gt;%</span> </span>
<span id="cb251-129"><a href="NE.html#cb251-129" tabindex="-1"></a>    <span class="fu">prep</span>(<span class="at">training=</span>Stacked.DID.Data) <span class="sc">%&gt;%</span> </span>
<span id="cb251-130"><a href="NE.html#cb251-130" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data=</span><span class="cn">NULL</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb251-131"><a href="NE.html#cb251-131" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>D_X1) </span>
<span id="cb251-132"><a href="NE.html#cb251-132" tabindex="-1"></a>   <span class="co"># order the variables and make DeltaX a matrix</span></span>
<span id="cb251-133"><a href="NE.html#cb251-133" tabindex="-1"></a>   DeltaX <span class="ot">&lt;-</span> DeltaX <span class="sc">%&gt;%</span></span>
<span id="cb251-134"><a href="NE.html#cb251-134" tabindex="-1"></a>    <span class="fu">relocate</span>(<span class="fu">colnames</span>(DeltaX)[<span class="fu">order</span>(<span class="fu">colnames</span>(DeltaX))]) <span class="sc">%&gt;%</span></span>
<span id="cb251-135"><a href="NE.html#cb251-135" tabindex="-1"></a>    <span class="fu">as.matrix</span>(.) <span class="co"># make it Sparse</span></span>
<span id="cb251-136"><a href="NE.html#cb251-136" tabindex="-1"></a>  <span class="co"># generating the outcomes matrix</span></span>
<span id="cb251-137"><a href="NE.html#cb251-137" tabindex="-1"></a>   DeltaY <span class="ot">&lt;-</span> Stacked.DID.Data <span class="sc">%&gt;%</span></span>
<span id="cb251-138"><a href="NE.html#cb251-138" tabindex="-1"></a>              <span class="fu">select</span>(DeltaY) <span class="sc">%&gt;%</span></span>
<span id="cb251-139"><a href="NE.html#cb251-139" tabindex="-1"></a>              <span class="fu">as.matrix</span>(.)</span>
<span id="cb251-140"><a href="NE.html#cb251-140" tabindex="-1"></a>  <span class="co"># inverting the covariance matrix</span></span>
<span id="cb251-141"><a href="NE.html#cb251-141" tabindex="-1"></a>  DeltaXDeltaXm1 <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">t</span>(DeltaX)<span class="sc">%*%</span>DeltaX)</span>
<span id="cb251-142"><a href="NE.html#cb251-142" tabindex="-1"></a>  <span class="co"># Esimating the coefficients of the stacked DID model using OLS</span></span>
<span id="cb251-143"><a href="NE.html#cb251-143" tabindex="-1"></a>  Stacked.DID.OLS.Theta <span class="ot">&lt;-</span> DeltaXDeltaXm1<span class="sc">%*%</span><span class="fu">t</span>(DeltaX)<span class="sc">%*%</span>DeltaY</span>
<span id="cb251-144"><a href="NE.html#cb251-144" tabindex="-1"></a>  <span class="co"># recovering the coefficients</span></span>
<span id="cb251-145"><a href="NE.html#cb251-145" tabindex="-1"></a>  Coefs.Stacked.DID.FD <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(Stacked.DID.OLS.Theta) </span>
<span id="cb251-146"><a href="NE.html#cb251-146" tabindex="-1"></a>  </span>
<span id="cb251-147"><a href="NE.html#cb251-147" tabindex="-1"></a>  Coefs.Stacked.DID.FD <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(Stacked.DID.OLS.Theta) <span class="sc">%&gt;%</span></span>
<span id="cb251-148"><a href="NE.html#cb251-148" tabindex="-1"></a>                            <span class="fu">mutate</span>(</span>
<span id="cb251-149"><a href="NE.html#cb251-149" tabindex="-1"></a>                              <span class="at">Groups=</span><span class="fu">rownames</span>(Coefs.Stacked.DID.FD),</span>
<span id="cb251-150"><a href="NE.html#cb251-150" tabindex="-1"></a>                              <span class="at">Beta0 =</span> <span class="fu">str_split_fixed</span>(Groups,<span class="st">&#39;x&#39;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">2</span>],</span>
<span id="cb251-151"><a href="NE.html#cb251-151" tabindex="-1"></a>                              <span class="at">Beta1 =</span> <span class="fu">str_split_fixed</span>(Groups,<span class="st">&#39;x&#39;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">1</span>],</span>
<span id="cb251-152"><a href="NE.html#cb251-152" tabindex="-1"></a>                              <span class="at">Beta2 =</span> <span class="fu">str_split_fixed</span>(Beta1,<span class="st">&#39;X&#39;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">2</span>],</span>
<span id="cb251-153"><a href="NE.html#cb251-153" tabindex="-1"></a>                              <span class="at">minus.tau =</span> <span class="fu">str_detect</span>(Beta2,<span class="st">&#39;</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">.&#39;</span>),</span>
<span id="cb251-154"><a href="NE.html#cb251-154" tabindex="-1"></a>                              <span class="at">d =</span> <span class="fu">str_split_fixed</span>(Beta2,<span class="st">&#39;</span><span class="sc">\\</span><span class="st">.&#39;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">1</span>],</span>
<span id="cb251-155"><a href="NE.html#cb251-155" tabindex="-1"></a>                              <span class="at">tau =</span> <span class="fu">str_split_fixed</span>(Beta2,<span class="st">&#39;</span><span class="sc">\\</span><span class="st">.&#39;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">2</span>],</span>
<span id="cb251-156"><a href="NE.html#cb251-156" tabindex="-1"></a>                              <span class="at">tau =</span> <span class="fu">str_extract</span>(tau,<span class="st">&quot;.?</span><span class="sc">\\</span><span class="st">d*&quot;</span>),</span>
<span id="cb251-157"><a href="NE.html#cb251-157" tabindex="-1"></a>                              <span class="at">tau =</span> <span class="fu">case_when</span>(</span>
<span id="cb251-158"><a href="NE.html#cb251-158" tabindex="-1"></a>                                minus.tau<span class="sc">==</span><span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">str_split_fixed</span>(tau,<span class="st">&#39;</span><span class="sc">\\</span><span class="st">.&#39;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">2</span>],</span>
<span id="cb251-159"><a href="NE.html#cb251-159" tabindex="-1"></a>                                <span class="cn">TRUE</span><span class="sc">~</span>tau</span>
<span id="cb251-160"><a href="NE.html#cb251-160" tabindex="-1"></a>                              ),</span>
<span id="cb251-161"><a href="NE.html#cb251-161" tabindex="-1"></a>                              <span class="at">tau =</span> <span class="fu">case_when</span>(</span>
<span id="cb251-162"><a href="NE.html#cb251-162" tabindex="-1"></a>                                minus.tau <span class="sc">~</span> <span class="sc">-</span><span class="fu">as.numeric</span>(tau),</span>
<span id="cb251-163"><a href="NE.html#cb251-163" tabindex="-1"></a>                                <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">as.numeric</span>(tau)</span>
<span id="cb251-164"><a href="NE.html#cb251-164" tabindex="-1"></a>                              ),</span>
<span id="cb251-165"><a href="NE.html#cb251-165" tabindex="-1"></a>                              <span class="at">Ddtau =</span> <span class="fu">paste</span>(d,tau,<span class="at">sep=</span><span class="st">&#39;,&#39;</span>)</span>
<span id="cb251-166"><a href="NE.html#cb251-166" tabindex="-1"></a>                            ) <span class="sc">%&gt;%</span></span>
<span id="cb251-167"><a href="NE.html#cb251-167" tabindex="-1"></a>                            <span class="fu">rename</span>(<span class="at">TE =</span> DeltaY) <span class="sc">%&gt;%</span></span>
<span id="cb251-168"><a href="NE.html#cb251-168" tabindex="-1"></a>                            <span class="fu">filter</span>(Beta0<span class="sc">!=</span><span class="st">&quot;&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb251-169"><a href="NE.html#cb251-169" tabindex="-1"></a>                            <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">&quot;Beta&quot;</span>),<span class="sc">-</span>Groups,<span class="sc">-</span>minus.tau) <span class="sc">%&gt;%</span></span>
<span id="cb251-170"><a href="NE.html#cb251-170" tabindex="-1"></a>                            <span class="fu">relocate</span>(TE,<span class="at">.after=</span><span class="st">&quot;tau&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb251-171"><a href="NE.html#cb251-171" tabindex="-1"></a>                            <span class="fu">relocate</span>(Ddtau) </span>
<span id="cb251-172"><a href="NE.html#cb251-172" tabindex="-1"></a>  </span>
<span id="cb251-173"><a href="NE.html#cb251-173" tabindex="-1"></a>  <span class="co"># estimating standard errors for the BetaSAdtau parameters using Theorem 4.25</span></span>
<span id="cb251-174"><a href="NE.html#cb251-174" tabindex="-1"></a>  VarBetaSA.d.tau <span class="ot">&lt;-</span> Stacked.DID.Data <span class="sc">%&gt;%</span></span>
<span id="cb251-175"><a href="NE.html#cb251-175" tabindex="-1"></a>                        <span class="fu">group_by</span>(Ddtau,D) <span class="sc">%&gt;%</span></span>
<span id="cb251-176"><a href="NE.html#cb251-176" tabindex="-1"></a>                        <span class="fu">summarize</span>(</span>
<span id="cb251-177"><a href="NE.html#cb251-177" tabindex="-1"></a>                          <span class="at">VarDeltaYdtau =</span> <span class="fu">var</span>(DeltaY),</span>
<span id="cb251-178"><a href="NE.html#cb251-178" tabindex="-1"></a>                          <span class="at">Nd =</span> <span class="fu">n</span>() </span>
<span id="cb251-179"><a href="NE.html#cb251-179" tabindex="-1"></a>                        ) <span class="sc">%&gt;%</span></span>
<span id="cb251-180"><a href="NE.html#cb251-180" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">VarDeltaYdtau.N =</span> VarDeltaYdtau<span class="sc">/</span>Nd) <span class="sc">%&gt;%</span></span>
<span id="cb251-181"><a href="NE.html#cb251-181" tabindex="-1"></a>                        <span class="fu">group_by</span>(Ddtau) <span class="sc">%&gt;%</span></span>
<span id="cb251-182"><a href="NE.html#cb251-182" tabindex="-1"></a>                        <span class="fu">summarize</span>(</span>
<span id="cb251-183"><a href="NE.html#cb251-183" tabindex="-1"></a>                          <span class="at">VarDeltaYdtau.N =</span> <span class="fu">sum</span>(VarDeltaYdtau.N)</span>
<span id="cb251-184"><a href="NE.html#cb251-184" tabindex="-1"></a>                        ) <span class="sc">%&gt;%</span></span>
<span id="cb251-185"><a href="NE.html#cb251-185" tabindex="-1"></a>                       <span class="fu">mutate</span>(</span>
<span id="cb251-186"><a href="NE.html#cb251-186" tabindex="-1"></a>                          <span class="at">d =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(Ddtau,<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">1</span>]),</span>
<span id="cb251-187"><a href="NE.html#cb251-187" tabindex="-1"></a>                          <span class="at">tau =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(Ddtau,<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">2</span>])</span>
<span id="cb251-188"><a href="NE.html#cb251-188" tabindex="-1"></a>                       ) <span class="sc">%&gt;%</span></span>
<span id="cb251-189"><a href="NE.html#cb251-189" tabindex="-1"></a>                      <span class="fu">arrange</span>(d,tau)</span>
<span id="cb251-190"><a href="NE.html#cb251-190" tabindex="-1"></a></span>
<span id="cb251-191"><a href="NE.html#cb251-191" tabindex="-1"></a>  <span class="co"># estimating covariances between treatment effect parameters using Theorem 4.27</span></span>
<span id="cb251-192"><a href="NE.html#cb251-192" tabindex="-1"></a>  <span class="co"># First, I need estimates of the Us, which come out of the feols estimator</span></span>
<span id="cb251-193"><a href="NE.html#cb251-193" tabindex="-1"></a>  <span class="co"># I can only run it on a data set with only observations used for estimation</span></span>
<span id="cb251-194"><a href="NE.html#cb251-194" tabindex="-1"></a>  data.res <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb251-195"><a href="NE.html#cb251-195" tabindex="-1"></a>                <span class="fu">filter</span>(<span class="sc">!</span>(<span class="sc">!!</span><span class="fu">sym</span>(D) <span class="sc">%in%</span> Groups.impossible))</span>
<span id="cb251-196"><a href="NE.html#cb251-196" tabindex="-1"></a>  reg.DID.SA <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="fu">paste</span>(y,<span class="fu">paste</span>(<span class="st">&#39;sunab(&#39;</span>,<span class="fu">paste</span>(D,t,<span class="at">sep=</span><span class="st">&#39;,&#39;</span>),<span class="st">&#39;)&#39;</span>,<span class="at">sep=</span><span class="st">&#39;&#39;</span>),<span class="at">sep=</span><span class="st">&#39;~&#39;</span>),<span class="fu">paste</span>(i,t,<span class="at">sep=</span><span class="st">&#39;+&#39;</span>),<span class="at">sep=</span><span class="st">&#39;|&#39;</span>)),<span class="at">vcov=</span><span class="st">&#39;HC1&#39;</span>,<span class="at">data=</span>data.res)</span>
<span id="cb251-197"><a href="NE.html#cb251-197" tabindex="-1"></a>  data.res<span class="sc">$</span>residuals <span class="ot">&lt;-</span> reg.DID.SA<span class="sc">$</span>residuals</span>
<span id="cb251-198"><a href="NE.html#cb251-198" tabindex="-1"></a>  <span class="co"># Form all possible combinations of d,tau and d&#39;,tau&#39;</span></span>
<span id="cb251-199"><a href="NE.html#cb251-199" tabindex="-1"></a>  Ddtau.dprime.tauprime <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">combn</span>(VarBetaSA.d.tau<span class="sc">$</span>Ddtau,<span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb251-200"><a href="NE.html#cb251-200" tabindex="-1"></a>                            <span class="fu">as.data.frame</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb251-201"><a href="NE.html#cb251-201" tabindex="-1"></a>                            <span class="fu">rename</span>(</span>
<span id="cb251-202"><a href="NE.html#cb251-202" tabindex="-1"></a>                              <span class="at">Ddtau =</span> V1,</span>
<span id="cb251-203"><a href="NE.html#cb251-203" tabindex="-1"></a>                              <span class="at">D.dprime.tauprime =</span> V2</span>
<span id="cb251-204"><a href="NE.html#cb251-204" tabindex="-1"></a>                            ) <span class="sc">%&gt;%</span></span>
<span id="cb251-205"><a href="NE.html#cb251-205" tabindex="-1"></a>                            <span class="co"># generate d, tau, dprime and tauprime</span></span>
<span id="cb251-206"><a href="NE.html#cb251-206" tabindex="-1"></a>                            <span class="fu">mutate</span>(</span>
<span id="cb251-207"><a href="NE.html#cb251-207" tabindex="-1"></a>                              <span class="at">d =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(Ddtau,<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">1</span>]),</span>
<span id="cb251-208"><a href="NE.html#cb251-208" tabindex="-1"></a>                              <span class="at">tau =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(Ddtau,<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">2</span>]),</span>
<span id="cb251-209"><a href="NE.html#cb251-209" tabindex="-1"></a>                              <span class="at">dprime =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(D.dprime.tauprime,<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">1</span>]),</span>
<span id="cb251-210"><a href="NE.html#cb251-210" tabindex="-1"></a>                              <span class="at">tauprime =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(D.dprime.tauprime,<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>,<span class="at">n=</span><span class="dv">2</span>)[,<span class="dv">2</span>])</span>
<span id="cb251-211"><a href="NE.html#cb251-211" tabindex="-1"></a>                            ) <span class="sc">%&gt;%</span></span>
<span id="cb251-212"><a href="NE.html#cb251-212" tabindex="-1"></a>                            <span class="co"># generate the cases of Theorem 4.27, with both the time period at which the variance has to be computed and for which group</span></span>
<span id="cb251-213"><a href="NE.html#cb251-213" tabindex="-1"></a>                            <span class="fu">mutate</span>(</span>
<span id="cb251-214"><a href="NE.html#cb251-214" tabindex="-1"></a>                              <span class="at">Cases =</span> <span class="fu">case_when</span>(</span>
<span id="cb251-215"><a href="NE.html#cb251-215" tabindex="-1"></a>                                          d<span class="sc">==</span>dprime <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb251-216"><a href="NE.html#cb251-216" tabindex="-1"></a>                                          d<span class="sc">+</span>tau<span class="sc">==</span>dprime<span class="sc">+</span>tauprime <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb251-217"><a href="NE.html#cb251-217" tabindex="-1"></a>                                          d<span class="sc">-</span>tauprime.ref<span class="sc">==</span>dprime<span class="sc">+</span>tauprime <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb251-218"><a href="NE.html#cb251-218" tabindex="-1"></a>                                          d<span class="sc">+</span>tau<span class="sc">==</span>dprime<span class="sc">-</span>tauprime.ref <span class="sc">~</span> <span class="dv">4</span>,</span>
<span id="cb251-219"><a href="NE.html#cb251-219" tabindex="-1"></a>                                          <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb251-220"><a href="NE.html#cb251-220" tabindex="-1"></a>                                        ),</span>
<span id="cb251-221"><a href="NE.html#cb251-221" tabindex="-1"></a>                              <span class="at">Period =</span> <span class="fu">case_when</span>(</span>
<span id="cb251-222"><a href="NE.html#cb251-222" tabindex="-1"></a>                                          Cases<span class="sc">==</span><span class="dv">1</span> <span class="sc">~</span> d<span class="sc">-</span>tauprime.ref,</span>
<span id="cb251-223"><a href="NE.html#cb251-223" tabindex="-1"></a>                                          Cases<span class="sc">==</span><span class="dv">2</span> <span class="sc">~</span> d<span class="sc">+</span>tau,</span>
<span id="cb251-224"><a href="NE.html#cb251-224" tabindex="-1"></a>                                          Cases<span class="sc">==</span><span class="dv">3</span> <span class="sc">~</span> d<span class="sc">-</span>tauprime.ref,</span>
<span id="cb251-225"><a href="NE.html#cb251-225" tabindex="-1"></a>                                          Cases<span class="sc">==</span><span class="dv">4</span> <span class="sc">~</span> dprime<span class="sc">-</span>tauprime.ref,</span>
<span id="cb251-226"><a href="NE.html#cb251-226" tabindex="-1"></a>                                          <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb251-227"><a href="NE.html#cb251-227" tabindex="-1"></a>                                        ),</span>
<span id="cb251-228"><a href="NE.html#cb251-228" tabindex="-1"></a>                              <span class="at">Group =</span> <span class="fu">case_when</span>(</span>
<span id="cb251-229"><a href="NE.html#cb251-229" tabindex="-1"></a>                                        Cases<span class="sc">==</span><span class="dv">1</span> <span class="sc">~</span> <span class="st">&quot;All&quot;</span>,</span>
<span id="cb251-230"><a href="NE.html#cb251-230" tabindex="-1"></a>                                        Cases <span class="sc">&gt;</span><span class="dv">1</span> <span class="sc">~</span> <span class="st">&quot;0&quot;</span>,</span>
<span id="cb251-231"><a href="NE.html#cb251-231" tabindex="-1"></a>                                        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">&quot;None&quot;</span></span>
<span id="cb251-232"><a href="NE.html#cb251-232" tabindex="-1"></a>                                      )</span>
<span id="cb251-233"><a href="NE.html#cb251-233" tabindex="-1"></a>                            )</span>
<span id="cb251-234"><a href="NE.html#cb251-234" tabindex="-1"></a>  <span class="co"># Generating the variance terms</span></span>
<span id="cb251-235"><a href="NE.html#cb251-235" tabindex="-1"></a>  Var.residuals <span class="ot">&lt;-</span> data.res <span class="sc">%&gt;%</span></span>
<span id="cb251-236"><a href="NE.html#cb251-236" tabindex="-1"></a>                        <span class="fu">group_by</span>(<span class="sc">!!</span><span class="fu">sym</span>(t),<span class="sc">!!</span><span class="fu">sym</span>(D)) <span class="sc">%&gt;%</span></span>
<span id="cb251-237"><a href="NE.html#cb251-237" tabindex="-1"></a>                        <span class="fu">summarize</span>(</span>
<span id="cb251-238"><a href="NE.html#cb251-238" tabindex="-1"></a>                          <span class="at">VarUdt =</span> <span class="fu">var</span>(residuals),</span>
<span id="cb251-239"><a href="NE.html#cb251-239" tabindex="-1"></a>                          <span class="at">Ndt =</span> <span class="fu">n</span>() </span>
<span id="cb251-240"><a href="NE.html#cb251-240" tabindex="-1"></a>                        ) <span class="sc">%&gt;%</span></span>
<span id="cb251-241"><a href="NE.html#cb251-241" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">VarUdt.N =</span> VarUdt<span class="sc">/</span>Ndt) <span class="sc">%&gt;%</span></span>
<span id="cb251-242"><a href="NE.html#cb251-242" tabindex="-1"></a>                        <span class="fu">ungroup</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb251-243"><a href="NE.html#cb251-243" tabindex="-1"></a>                        <span class="fu">select</span>(<span class="sc">-</span>VarUdt,<span class="sc">-</span>Ndt) <span class="sc">%&gt;%</span></span>
<span id="cb251-244"><a href="NE.html#cb251-244" tabindex="-1"></a>                        <span class="fu">rename</span>(<span class="at">d=</span><span class="sc">!!</span><span class="fu">sym</span>(D))</span>
<span id="cb251-245"><a href="NE.html#cb251-245" tabindex="-1"></a>  <span class="co"># Separating the variance terms for the treated, the controls and summing them as well</span></span>
<span id="cb251-246"><a href="NE.html#cb251-246" tabindex="-1"></a>  <span class="co"># treated</span></span>
<span id="cb251-247"><a href="NE.html#cb251-247" tabindex="-1"></a>  Var.residuals<span class="fl">.1</span> <span class="ot">&lt;-</span> Var.residuals <span class="sc">%&gt;%</span></span>
<span id="cb251-248"><a href="NE.html#cb251-248" tabindex="-1"></a>                        <span class="fu">filter</span>(d<span class="sc">!=</span>dprime.ref) <span class="sc">%&gt;%</span></span>
<span id="cb251-249"><a href="NE.html#cb251-249" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">Group=</span><span class="st">&quot;All&quot;</span>)</span>
<span id="cb251-250"><a href="NE.html#cb251-250" tabindex="-1"></a>  <span class="co"># untreated</span></span>
<span id="cb251-251"><a href="NE.html#cb251-251" tabindex="-1"></a>  Var.residuals<span class="fl">.0</span> <span class="ot">&lt;-</span> Var.residuals <span class="sc">%&gt;%</span></span>
<span id="cb251-252"><a href="NE.html#cb251-252" tabindex="-1"></a>                        <span class="fu">filter</span>(d<span class="sc">==</span>dprime.ref) <span class="sc">%&gt;%</span></span>
<span id="cb251-253"><a href="NE.html#cb251-253" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">Group=</span><span class="st">&quot;0&quot;</span>)</span>
<span id="cb251-254"><a href="NE.html#cb251-254" tabindex="-1"></a>  <span class="co"># creating the covariances</span></span>
<span id="cb251-255"><a href="NE.html#cb251-255" tabindex="-1"></a>  <span class="co"># joining the variances of the untreated for cases 2 to 4</span></span>
<span id="cb251-256"><a href="NE.html#cb251-256" tabindex="-1"></a>  Ddtau.dprime.tauprime <span class="ot">&lt;-</span> Ddtau.dprime.tauprime <span class="sc">%&gt;%</span></span>
<span id="cb251-257"><a href="NE.html#cb251-257" tabindex="-1"></a>                            <span class="fu">left_join</span>(Var.residuals<span class="fl">.0</span> <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>d),<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Period&#39;</span><span class="ot">=</span>t,<span class="st">&#39;Group&#39;</span><span class="ot">=</span><span class="st">&#39;Group&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb251-258"><a href="NE.html#cb251-258" tabindex="-1"></a>                            <span class="fu">rename</span>(<span class="at">VarUdt.N.0=</span>VarUdt.N)</span>
<span id="cb251-259"><a href="NE.html#cb251-259" tabindex="-1"></a>  <span class="co"># preparing data of non treated for joining in case 1</span></span>
<span id="cb251-260"><a href="NE.html#cb251-260" tabindex="-1"></a>  Var.residuals<span class="fl">.0</span> <span class="ot">&lt;-</span> Var.residuals<span class="fl">.0</span> <span class="sc">%&gt;%</span></span>
<span id="cb251-261"><a href="NE.html#cb251-261" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">Group=</span><span class="st">&quot;All&quot;</span>)</span>
<span id="cb251-262"><a href="NE.html#cb251-262" tabindex="-1"></a>  Ddtau.dprime.tauprime <span class="ot">&lt;-</span> Ddtau.dprime.tauprime <span class="sc">%&gt;%</span></span>
<span id="cb251-263"><a href="NE.html#cb251-263" tabindex="-1"></a>                            <span class="fu">left_join</span>(Var.residuals<span class="fl">.0</span> <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>d),<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Period&#39;</span><span class="ot">=</span>t,<span class="st">&#39;Group&#39;</span><span class="ot">=</span><span class="st">&#39;Group&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb251-264"><a href="NE.html#cb251-264" tabindex="-1"></a>                            <span class="fu">rename</span>(<span class="at">VarUdt.N.0.All=</span>VarUdt.N) <span class="sc">%&gt;%</span></span>
<span id="cb251-265"><a href="NE.html#cb251-265" tabindex="-1"></a>                            <span class="fu">left_join</span>(Var.residuals<span class="fl">.1</span>,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Period&#39;</span><span class="ot">=</span>t,<span class="st">&#39;Group&#39;</span><span class="ot">=</span><span class="st">&#39;Group&#39;</span>,<span class="st">&#39;d&#39;</span><span class="ot">=</span><span class="st">&#39;d&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb251-266"><a href="NE.html#cb251-266" tabindex="-1"></a>                            <span class="fu">rename</span>(<span class="at">VarUdt.N.1.All=</span>VarUdt.N) <span class="sc">%&gt;%</span></span>
<span id="cb251-267"><a href="NE.html#cb251-267" tabindex="-1"></a>                            <span class="fu">mutate</span>(</span>
<span id="cb251-268"><a href="NE.html#cb251-268" tabindex="-1"></a>                              <span class="at">Cov.dtau.dprime.tauprime =</span> <span class="fu">case_when</span>(</span>
<span id="cb251-269"><a href="NE.html#cb251-269" tabindex="-1"></a>                                                            Cases<span class="sc">==</span><span class="dv">1</span> <span class="sc">~</span> VarUdt.N.<span class="fl">0.</span>All<span class="sc">+</span>VarUdt.N.<span class="fl">1.</span>All,</span>
<span id="cb251-270"><a href="NE.html#cb251-270" tabindex="-1"></a>                                                            Cases<span class="sc">==</span><span class="dv">2</span> <span class="sc">~</span> VarUdt.N<span class="fl">.0</span>,</span>
<span id="cb251-271"><a href="NE.html#cb251-271" tabindex="-1"></a>                                                            Cases<span class="sc">==</span><span class="dv">3</span> <span class="sc">~</span> <span class="sc">-</span>VarUdt.N<span class="fl">.0</span>,</span>
<span id="cb251-272"><a href="NE.html#cb251-272" tabindex="-1"></a>                                                            Cases<span class="sc">==</span><span class="dv">4</span> <span class="sc">~</span> <span class="sc">-</span>VarUdt.N<span class="fl">.0</span>,</span>
<span id="cb251-273"><a href="NE.html#cb251-273" tabindex="-1"></a>                                                            <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb251-274"><a href="NE.html#cb251-274" tabindex="-1"></a>                                                          )</span>
<span id="cb251-275"><a href="NE.html#cb251-275" tabindex="-1"></a>                            ) <span class="sc">%&gt;%</span></span>
<span id="cb251-276"><a href="NE.html#cb251-276" tabindex="-1"></a>                            <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">&#39;VarUdt.N&#39;</span>))</span>
<span id="cb251-277"><a href="NE.html#cb251-277" tabindex="-1"></a></span>
<span id="cb251-278"><a href="NE.html#cb251-278" tabindex="-1"></a>  <span class="cf">if</span> (Leung<span class="sc">==</span><span class="st">&quot;Temporal&quot;</span>){</span>
<span id="cb251-279"><a href="NE.html#cb251-279" tabindex="-1"></a>    <span class="co"># estimating the residuals</span></span>
<span id="cb251-280"><a href="NE.html#cb251-280" tabindex="-1"></a>    Stacked.DID.OLS.res <span class="ot">&lt;-</span> DeltaY<span class="sc">-</span>DeltaX<span class="sc">%*%</span>Stacked.DID.OLS.Theta</span>
<span id="cb251-281"><a href="NE.html#cb251-281" tabindex="-1"></a>    <span class="co"># estimating the Leung covariance matrix</span></span>
<span id="cb251-282"><a href="NE.html#cb251-282" tabindex="-1"></a>    <span class="co"># product of the matrix of covariates times the residuals</span></span>
<span id="cb251-283"><a href="NE.html#cb251-283" tabindex="-1"></a>    M <span class="ot">&lt;-</span> DeltaX<span class="sc">*</span><span class="fu">as.numeric</span>(Stacked.DID.OLS.res) <span class="co"># only use it in teh computation</span></span>
<span id="cb251-284"><a href="NE.html#cb251-284" tabindex="-1"></a>    <span class="co"># generating a matrix of &quot;connexions&quot; between observations: under the absence of autocorrelation assumption, identifies the observations that are used several times</span></span>
<span id="cb251-285"><a href="NE.html#cb251-285" tabindex="-1"></a>    <span class="co"># make it sparse using the Matrix package</span></span>
<span id="cb251-286"><a href="NE.html#cb251-286" tabindex="-1"></a>    <span class="co"># for that: generate a unique identifier for each line in the dataset and match it back to find all the lines that correspond</span></span>
<span id="cb251-287"><a href="NE.html#cb251-287" tabindex="-1"></a>    Stacked.DID.Data <span class="ot">&lt;-</span> Stacked.DID.Data <span class="sc">%&gt;%</span></span>
<span id="cb251-288"><a href="NE.html#cb251-288" tabindex="-1"></a>                         <span class="fu">arrange</span>(Ddtau,D,id) <span class="sc">%&gt;%</span></span>
<span id="cb251-289"><a href="NE.html#cb251-289" tabindex="-1"></a>                         <span class="fu">mutate</span>(</span>
<span id="cb251-290"><a href="NE.html#cb251-290" tabindex="-1"></a>                           <span class="at">column.id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Stacked.DID.Data)</span>
<span id="cb251-291"><a href="NE.html#cb251-291" tabindex="-1"></a>                         ) <span class="sc">%&gt;%</span></span>
<span id="cb251-292"><a href="NE.html#cb251-292" tabindex="-1"></a>                         <span class="fu">relocate</span>(column.id)</span>
<span id="cb251-293"><a href="NE.html#cb251-293" tabindex="-1"></a>    Merged.Stacked.DID.Data <span class="ot">&lt;-</span> Stacked.DID.Data <span class="sc">%&gt;%</span></span>
<span id="cb251-294"><a href="NE.html#cb251-294" tabindex="-1"></a>                               <span class="fu">left_join</span>(Stacked.DID.Data,<span class="at">by=</span><span class="st">&#39;id&#39;</span>)</span>
<span id="cb251-295"><a href="NE.html#cb251-295" tabindex="-1"></a>    G <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">sparseMatrix</span>(Merged.Stacked.DID.Data<span class="sc">$</span>column.id.x,Merged.Stacked.DID.Data<span class="sc">$</span>column.id.y,<span class="at">dims =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(Stacked.DID.Data),<span class="fu">nrow</span>(Stacked.DID.Data))) </span>
<span id="cb251-296"><a href="NE.html#cb251-296" tabindex="-1"></a>    <span class="co">#SparseM::image(G)</span></span>
<span id="cb251-297"><a href="NE.html#cb251-297" tabindex="-1"></a>    Vcov.Stacked.DID.OLS.Theta.Leung <span class="ot">&lt;-</span> DeltaXDeltaXm1<span class="sc">%*%</span><span class="fu">t</span>(DeltaX<span class="sc">*</span><span class="fu">as.numeric</span>(Stacked.DID.OLS.res))<span class="sc">%*%</span>G<span class="sc">%*%</span>(DeltaX<span class="sc">*</span><span class="fu">as.numeric</span>(Stacked.DID.OLS.res))<span class="sc">%*%</span>DeltaXDeltaXm1</span>
<span id="cb251-298"><a href="NE.html#cb251-298" tabindex="-1"></a>    <span class="co"># recovering vcov matrix of the coeffcients (the 2x2 DID coefficients are the even elements of the coefficient vector)                        </span></span>
<span id="cb251-299"><a href="NE.html#cb251-299" tabindex="-1"></a>    Vcov.Coefs.Stacked.DID.FD.Leung <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(Vcov.Stacked.DID.OLS.Theta.Leung[<span class="fu">c</span>(<span class="cn">FALSE</span>,<span class="cn">TRUE</span>),<span class="fu">c</span>(<span class="cn">FALSE</span>,<span class="cn">TRUE</span>)])</span>
<span id="cb251-300"><a href="NE.html#cb251-300" tabindex="-1"></a>  }</span>
<span id="cb251-301"><a href="NE.html#cb251-301" tabindex="-1"></a>  <span class="co"># recovering stadnard error of the coefficients</span></span>
<span id="cb251-302"><a href="NE.html#cb251-302" tabindex="-1"></a>  Coefs.Stacked.DID.FD <span class="ot">&lt;-</span> Coefs.Stacked.DID.FD <span class="sc">%&gt;%</span></span>
<span id="cb251-303"><a href="NE.html#cb251-303" tabindex="-1"></a>                            <span class="fu">left_join</span>(VarBetaSA.d.tau <span class="sc">%&gt;%</span> <span class="fu">select</span>(Ddtau,VarDeltaYdtau.N),<span class="at">by=</span><span class="st">&#39;Ddtau&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb251-304"><a href="NE.html#cb251-304" tabindex="-1"></a>                            <span class="fu">mutate</span>(</span>
<span id="cb251-305"><a href="NE.html#cb251-305" tabindex="-1"></a>                              <span class="at">SeTE =</span> <span class="fu">sqrt</span>(VarDeltaYdtau.N)</span>
<span id="cb251-306"><a href="NE.html#cb251-306" tabindex="-1"></a>                            ) <span class="sc">%&gt;%</span></span>
<span id="cb251-307"><a href="NE.html#cb251-307" tabindex="-1"></a>                            <span class="fu">select</span>(<span class="sc">-</span>VarDeltaYdtau.N)</span>
<span id="cb251-308"><a href="NE.html#cb251-308" tabindex="-1"></a>  <span class="co"># adding reference periods</span></span>
<span id="cb251-309"><a href="NE.html#cb251-309" tabindex="-1"></a>  <span class="co"># groups used for estimation</span></span>
<span id="cb251-310"><a href="NE.html#cb251-310" tabindex="-1"></a>  d.ref <span class="ot">&lt;-</span> Groups.possible</span>
<span id="cb251-311"><a href="NE.html#cb251-311" tabindex="-1"></a>  DID.ref <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">d=</span>d.ref,<span class="at">tau=</span><span class="sc">-</span><span class="dv">1</span>,<span class="at">TE=</span><span class="dv">0</span>,<span class="at">SeTE=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb251-312"><a href="NE.html#cb251-312" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">Ddtau =</span> <span class="fu">paste</span>(d,tau,<span class="at">sep=</span><span class="st">&#39;,&#39;</span>))</span>
<span id="cb251-313"><a href="NE.html#cb251-313" tabindex="-1"></a>  Coefs.Stacked.DID.FD <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Coefs.Stacked.DID.FD,DID.ref) <span class="sc">%&gt;%</span></span>
<span id="cb251-314"><a href="NE.html#cb251-314" tabindex="-1"></a>                        <span class="fu">arrange</span>(d,tau)</span>
<span id="cb251-315"><a href="NE.html#cb251-315" tabindex="-1"></a></span>
<span id="cb251-316"><a href="NE.html#cb251-316" tabindex="-1"></a>  <span class="co"># generating the covariance matrix</span></span>
<span id="cb251-317"><a href="NE.html#cb251-317" tabindex="-1"></a>  columns.cov.matrix <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Ddtau=</span>Coefs.Stacked.DID.FD<span class="sc">$</span>Ddtau,<span class="at">Ddtau.id=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Coefs.Stacked.DID.FD<span class="sc">$</span>Ddtau))</span>
<span id="cb251-318"><a href="NE.html#cb251-318" tabindex="-1"></a>  Ddtau.dprime.tauprime <span class="ot">&lt;-</span> Ddtau.dprime.tauprime <span class="sc">%&gt;%</span></span>
<span id="cb251-319"><a href="NE.html#cb251-319" tabindex="-1"></a>                            <span class="fu">left_join</span>(columns.cov.matrix,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Ddtau&#39;</span><span class="ot">=</span><span class="st">&#39;Ddtau&#39;</span>))   <span class="sc">%&gt;%</span></span>
<span id="cb251-320"><a href="NE.html#cb251-320" tabindex="-1"></a>                            <span class="fu">left_join</span>(columns.cov.matrix,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;D.dprime.tauprime&#39;</span><span class="ot">=</span><span class="st">&#39;Ddtau&#39;</span>))</span>
<span id="cb251-321"><a href="NE.html#cb251-321" tabindex="-1"></a>  Vcov.Coefs.Stacked.DID.FD <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">sparseMatrix</span>(<span class="at">i=</span>Ddtau.dprime.tauprime<span class="sc">$</span>Ddtau.id.x,<span class="at">j=</span>Ddtau.dprime.tauprime<span class="sc">$</span>Ddtau.id.y,<span class="at">x=</span>Ddtau.dprime.tauprime<span class="sc">$</span>Cov.dtau.dprime.tauprime,<span class="at">dims=</span><span class="fu">c</span>(<span class="fu">length</span>(Coefs.Stacked.DID.FD<span class="sc">$</span>Ddtau),<span class="fu">length</span>(Coefs.Stacked.DID.FD<span class="sc">$</span>Ddtau))) </span>
<span id="cb251-322"><a href="NE.html#cb251-322" tabindex="-1"></a>  <span class="co"># symmetrize matrix and add diagonal</span></span>
<span id="cb251-323"><a href="NE.html#cb251-323" tabindex="-1"></a>  Vcov.Coefs.Stacked.DID.FD <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(Vcov.Coefs.Stacked.DID.FD<span class="sc">+</span><span class="fu">t</span>(Vcov.Coefs.Stacked.DID.FD)<span class="sc">+</span><span class="fu">diag</span>(Coefs.Stacked.DID.FD<span class="sc">$</span>SeTE<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb251-324"><a href="NE.html#cb251-324" tabindex="-1"></a>  <span class="fu">colnames</span>(Vcov.Coefs.Stacked.DID.FD) <span class="ot">&lt;-</span> Coefs.Stacked.DID.FD<span class="sc">$</span>Ddtau</span>
<span id="cb251-325"><a href="NE.html#cb251-325" tabindex="-1"></a>  <span class="fu">rownames</span>(Vcov.Coefs.Stacked.DID.FD) <span class="ot">&lt;-</span> Coefs.Stacked.DID.FD<span class="sc">$</span>Ddtau</span>
<span id="cb251-326"><a href="NE.html#cb251-326" tabindex="-1"></a>  </span>
<span id="cb251-327"><a href="NE.html#cb251-327" tabindex="-1"></a>  <span class="co"># estimating ATT (varying weights) and its standard error</span></span>
<span id="cb251-328"><a href="NE.html#cb251-328" tabindex="-1"></a>  <span class="co"># estimating the weights: each treated period has a weight, which depends on its proportion in the total number of treated observations</span></span>
<span id="cb251-329"><a href="NE.html#cb251-329" tabindex="-1"></a>  <span class="co"># keeping all observations that are part of the treated groups used for estimation</span></span>
<span id="cb251-330"><a href="NE.html#cb251-330" tabindex="-1"></a>  ATT.DID.weights <span class="ot">&lt;-</span> DID.ref <span class="sc">%&gt;%</span></span>
<span id="cb251-331"><a href="NE.html#cb251-331" tabindex="-1"></a>                      <span class="fu">select</span>(d) <span class="sc">%&gt;%</span></span>
<span id="cb251-332"><a href="NE.html#cb251-332" tabindex="-1"></a>                      <span class="fu">left_join</span>(data,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;d&#39;</span><span class="ot">=</span>D)) <span class="sc">%&gt;%</span></span>
<span id="cb251-333"><a href="NE.html#cb251-333" tabindex="-1"></a>                      <span class="fu">rename</span>(<span class="at">Period=</span><span class="sc">!!</span><span class="fu">sym</span>(t)) <span class="sc">%&gt;%</span></span>
<span id="cb251-334"><a href="NE.html#cb251-334" tabindex="-1"></a>                      <span class="fu">group_by</span>(d,Period) <span class="sc">%&gt;%</span></span>
<span id="cb251-335"><a href="NE.html#cb251-335" tabindex="-1"></a>                      <span class="fu">summarize</span>(</span>
<span id="cb251-336"><a href="NE.html#cb251-336" tabindex="-1"></a>                        <span class="at">Ntreated =</span> <span class="fu">n</span>()</span>
<span id="cb251-337"><a href="NE.html#cb251-337" tabindex="-1"></a>                      )<span class="sc">%&gt;%</span></span>
<span id="cb251-338"><a href="NE.html#cb251-338" tabindex="-1"></a>                      <span class="fu">ungroup</span>(.)   <span class="sc">%&gt;%</span></span>
<span id="cb251-339"><a href="NE.html#cb251-339" tabindex="-1"></a>                      <span class="co"># keep only treated periods</span></span>
<span id="cb251-340"><a href="NE.html#cb251-340" tabindex="-1"></a>                      <span class="fu">mutate</span>(</span>
<span id="cb251-341"><a href="NE.html#cb251-341" tabindex="-1"></a>                        <span class="at">TimeToTreatment =</span> Period<span class="sc">-</span>d,</span>
<span id="cb251-342"><a href="NE.html#cb251-342" tabindex="-1"></a>                        <span class="at">Ntreated =</span> <span class="fu">if_else</span>(TimeToTreatment <span class="sc">&lt;</span> <span class="dv">0</span>,<span class="dv">0</span>,<span class="fu">as.numeric</span>(Ntreated)), </span>
<span id="cb251-343"><a href="NE.html#cb251-343" tabindex="-1"></a>                        <span class="at">N =</span> <span class="fu">sum</span>(Ntreated),</span>
<span id="cb251-344"><a href="NE.html#cb251-344" tabindex="-1"></a>                        <span class="at">weights=</span>Ntreated<span class="sc">/</span>N,</span>
<span id="cb251-345"><a href="NE.html#cb251-345" tabindex="-1"></a>                        <span class="at">TimeToTreatment=</span><span class="sc">!!</span><span class="fu">sym</span>(t)<span class="sc">-</span>d</span>
<span id="cb251-346"><a href="NE.html#cb251-346" tabindex="-1"></a>                      ) <span class="sc">%&gt;%</span></span>
<span id="cb251-347"><a href="NE.html#cb251-347" tabindex="-1"></a>                      <span class="fu">arrange</span>(d,Period)</span>
<span id="cb251-348"><a href="NE.html#cb251-348" tabindex="-1"></a>  <span class="co"># ATT</span></span>
<span id="cb251-349"><a href="NE.html#cb251-349" tabindex="-1"></a>  ATT <span class="ot">&lt;-</span> <span class="fu">t</span>(ATT.DID.weights[,<span class="st">&quot;weights&quot;</span>])<span class="sc">%*%</span>Coefs.Stacked.DID.FD[,<span class="st">&quot;TE&quot;</span>]</span>
<span id="cb251-350"><a href="NE.html#cb251-350" tabindex="-1"></a>  ATTSe <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">t</span>(ATT.DID.weights[,<span class="st">&quot;weights&quot;</span>])<span class="sc">%*%</span>Vcov.Coefs.Stacked.DID.FD<span class="sc">%*%</span><span class="fu">as.matrix</span>(ATT.DID.weights[,<span class="st">&quot;weights&quot;</span>]))</span>
<span id="cb251-351"><a href="NE.html#cb251-351" tabindex="-1"></a>  </span>
<span id="cb251-352"><a href="NE.html#cb251-352" tabindex="-1"></a>  <span class="co"># results</span></span>
<span id="cb251-353"><a href="NE.html#cb251-353" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">list</span>(Coefs.Stacked.DID.FD,Vcov.Coefs.Stacked.DID.FD,ATT,ATTSe)</span>
<span id="cb251-354"><a href="NE.html#cb251-354" tabindex="-1"></a>  <span class="fu">names</span>(result) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;BetaSA&quot;</span>,<span class="st">&quot;VcovBetaSA&quot;</span>,<span class="st">&quot;ATT&quot;</span>,<span class="st">&quot;ATTSe&quot;</span>)</span>
<span id="cb251-355"><a href="NE.html#cb251-355" tabindex="-1"></a>  </span>
<span id="cb251-356"><a href="NE.html#cb251-356" tabindex="-1"></a>  <span class="co"># add Leung estimates if needed</span></span>
<span id="cb251-357"><a href="NE.html#cb251-357" tabindex="-1"></a>  <span class="cf">if</span> (Leung<span class="sc">==</span><span class="st">&quot;Temporal&quot;</span>){</span>
<span id="cb251-358"><a href="NE.html#cb251-358" tabindex="-1"></a>    <span class="co"># ATT</span></span>
<span id="cb251-359"><a href="NE.html#cb251-359" tabindex="-1"></a>    ATTSe.Leung <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">t</span>(ATT.DID.weights <span class="sc">%&gt;%</span> <span class="fu">filter</span>(weights<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="st">&quot;weights&quot;</span>))<span class="sc">%*%</span>Vcov.Coefs.Stacked.DID.FD.Leung[<span class="fu">str_detect</span>(<span class="fu">colnames</span>(Vcov.Coefs.Stacked.DID.FD.Leung),<span class="st">&#39;</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">.&#39;</span>,<span class="at">negate=</span><span class="cn">TRUE</span>),<span class="fu">str_detect</span>(<span class="fu">colnames</span>(Vcov.Coefs.Stacked.DID.FD.Leung),<span class="st">&#39;</span><span class="sc">\\</span><span class="st">.</span><span class="sc">\\</span><span class="st">.&#39;</span>,<span class="at">negate=</span><span class="cn">TRUE</span>)]<span class="sc">%*%</span><span class="fu">as.matrix</span>(ATT.DID.weights <span class="sc">%&gt;%</span> <span class="fu">filter</span>(weights<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="st">&quot;weights&quot;</span>)))</span>
<span id="cb251-360"><a href="NE.html#cb251-360" tabindex="-1"></a>    <span class="co"># results</span></span>
<span id="cb251-361"><a href="NE.html#cb251-361" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">list</span>(Coefs.Stacked.DID.FD,Vcov.Coefs.Stacked.DID.FD,ATT,ATTSe,ATTSe.Leung,Vcov.Coefs.Stacked.DID.FD.Leung)</span>
<span id="cb251-362"><a href="NE.html#cb251-362" tabindex="-1"></a>    <span class="fu">names</span>(result) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;BetaSA&quot;</span>,<span class="st">&quot;VcovBetaSA&quot;</span>,<span class="st">&quot;ATT&quot;</span>,<span class="st">&quot;ATTSe&quot;</span>,<span class="st">&quot;ATTSeLeung&quot;</span>,<span class="st">&quot;VcovBetaSALeung&quot;</span>)</span>
<span id="cb251-363"><a href="NE.html#cb251-363" tabindex="-1"></a>  }</span>
<span id="cb251-364"><a href="NE.html#cb251-364" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb251-365"><a href="NE.html#cb251-365" tabindex="-1"></a>}</span>
<span id="cb251-366"><a href="NE.html#cb251-366" tabindex="-1"></a></span>
<span id="cb251-367"><a href="NE.html#cb251-367" tabindex="-1"></a><span class="co"># test </span></span>
<span id="cb251-368"><a href="NE.html#cb251-368" tabindex="-1"></a>test.stacked.DID.FD <span class="ot">&lt;-</span> <span class="fu">StackedDIDFD</span>(<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">dprime=</span><span class="dv">99</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">Leung=</span><span class="st">&#39;Temporal&#39;</span>,<span class="at">data=</span>data) </span></code></pre></div>
<p>We now are going to write a function taking a set of parameter values and a sample size and spitting out <span class="math inline">\(2\times 2\)</span> DID estimates with their standard errors and the <code>fixest</code> implementation of Sun and Abraham estimator, both for individual level estimates and for the aggregate treatment effect.</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="NE.html#cb252-1" tabindex="-1"></a><span class="co"># function generating a sample with N sample size and spitting out DID estimates (both event study and TT, with both Sunab and 2x2 DID)</span></span>
<span id="cb252-2"><a href="NE.html#cb252-2" tabindex="-1"></a><span class="co"># seed: seed setting the PRNG</span></span>
<span id="cb252-3"><a href="NE.html#cb252-3" tabindex="-1"></a><span class="co"># N: number of units in the panel</span></span>
<span id="cb252-4"><a href="NE.html#cb252-4" tabindex="-1"></a><span class="co"># T: number of periods in the panel (cannot be different from 4 in this instance ;)</span></span>
<span id="cb252-5"><a href="NE.html#cb252-5" tabindex="-1"></a><span class="co"># param: basic parameters</span></span>
<span id="cb252-6"><a href="NE.html#cb252-6" tabindex="-1"></a>Outcome.Sample.DID <span class="ot">&lt;-</span> <span class="cf">function</span>(seed,N,<span class="at">T=</span><span class="dv">4</span>,param){</span>
<span id="cb252-7"><a href="NE.html#cb252-7" tabindex="-1"></a>  <span class="co"># simulating a sample</span></span>
<span id="cb252-8"><a href="NE.html#cb252-8" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb252-9"><a href="NE.html#cb252-9" tabindex="-1"></a>  cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb252-10"><a href="NE.html#cb252-10" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rmvnorm</span>(N<span class="sc">*</span>T,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb252-11"><a href="NE.html#cb252-11" tabindex="-1"></a>  <span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;eta&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb252-12"><a href="NE.html#cb252-12" tabindex="-1"></a>  <span class="co"># time and individual identifiers</span></span>
<span id="cb252-13"><a href="NE.html#cb252-13" tabindex="-1"></a>  data<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,N),<span class="fu">rep</span>(<span class="dv">2</span>,N),<span class="fu">rep</span>(<span class="dv">3</span>,N),<span class="fu">rep</span>(<span class="dv">4</span>,N))</span>
<span id="cb252-14"><a href="NE.html#cb252-14" tabindex="-1"></a>  data<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>((<span class="dv">1</span><span class="sc">:</span>N),T)</span>
<span id="cb252-15"><a href="NE.html#cb252-15" tabindex="-1"></a>  <span class="co"># unit fixed effects</span></span>
<span id="cb252-16"><a href="NE.html#cb252-16" tabindex="-1"></a>  data<span class="sc">$</span>mu <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>])),T)</span>
<span id="cb252-17"><a href="NE.html#cb252-17" tabindex="-1"></a>  <span class="co"># time fixed effects</span></span>
<span id="cb252-18"><a href="NE.html#cb252-18" tabindex="-1"></a>  data<span class="sc">$</span>delta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(param[<span class="st">&quot;delta1&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta2&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta3&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta4&quot;</span>],N))</span>
<span id="cb252-19"><a href="NE.html#cb252-19" tabindex="-1"></a>  data<span class="sc">$</span>baralphat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(param[<span class="st">&quot;baralpha1&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha2&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha3&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha4&quot;</span>],N))</span>
<span id="cb252-20"><a href="NE.html#cb252-20" tabindex="-1"></a>  </span>
<span id="cb252-21"><a href="NE.html#cb252-21" tabindex="-1"></a>  <span class="co"># building autocorrelated error terms</span></span>
<span id="cb252-22"><a href="NE.html#cb252-22" tabindex="-1"></a>  data<span class="sc">$</span>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N<span class="sc">*</span>T,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb252-23"><a href="NE.html#cb252-23" tabindex="-1"></a>  data<span class="sc">$</span>U[<span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb252-24"><a href="NE.html#cb252-24" tabindex="-1"></a>  data<span class="sc">$</span>U[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)]</span>
<span id="cb252-25"><a href="NE.html#cb252-25" tabindex="-1"></a>  data<span class="sc">$</span>U[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)]</span>
<span id="cb252-26"><a href="NE.html#cb252-26" tabindex="-1"></a>  data<span class="sc">$</span>U[(<span class="dv">3</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(<span class="dv">3</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">*</span>N)]</span>
<span id="cb252-27"><a href="NE.html#cb252-27" tabindex="-1"></a>  <span class="co"># potential outcomes in the absence of the treatment</span></span>
<span id="cb252-28"><a href="NE.html#cb252-28" tabindex="-1"></a>  data<span class="sc">$</span>y0 <span class="ot">&lt;-</span> data<span class="sc">$</span>mu <span class="sc">+</span> data<span class="sc">$</span>delta <span class="sc">+</span> data<span class="sc">$</span>U </span>
<span id="cb252-29"><a href="NE.html#cb252-29" tabindex="-1"></a>  data<span class="sc">$</span>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(data<span class="sc">$</span>y0)</span>
<span id="cb252-30"><a href="NE.html#cb252-30" tabindex="-1"></a>  <span class="co"># treatment timing</span></span>
<span id="cb252-31"><a href="NE.html#cb252-31" tabindex="-1"></a>  <span class="co"># error term</span></span>
<span id="cb252-32"><a href="NE.html#cb252-32" tabindex="-1"></a>  data<span class="sc">$</span>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(data<span class="sc">$</span>mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>data<span class="sc">$</span>omega</span>
<span id="cb252-33"><a href="NE.html#cb252-33" tabindex="-1"></a>  <span class="co"># treatment group, with 99 for the never treated instead of infinity</span></span>
<span id="cb252-34"><a href="NE.html#cb252-34" tabindex="-1"></a>  Ds <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi1&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">1</span>,</span>
<span id="cb252-35"><a href="NE.html#cb252-35" tabindex="-1"></a>                <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi2&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">2</span>,</span>
<span id="cb252-36"><a href="NE.html#cb252-36" tabindex="-1"></a>                        <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi3&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">3</span>,</span>
<span id="cb252-37"><a href="NE.html#cb252-37" tabindex="-1"></a>                                <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi4&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">4</span>,<span class="dv">99</span>))))</span>
<span id="cb252-38"><a href="NE.html#cb252-38" tabindex="-1"></a>  data<span class="sc">$</span>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(Ds,T)</span>
<span id="cb252-39"><a href="NE.html#cb252-39" tabindex="-1"></a>  <span class="co"># Treatment status</span></span>
<span id="cb252-40"><a href="NE.html#cb252-40" tabindex="-1"></a>  data<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">&gt;</span>data<span class="sc">$</span>time,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb252-41"><a href="NE.html#cb252-41" tabindex="-1"></a>  <span class="co"># potential outcomes with the treatment</span></span>
<span id="cb252-42"><a href="NE.html#cb252-42" tabindex="-1"></a>  <span class="co"># effect of the treatment by group</span></span>
<span id="cb252-43"><a href="NE.html#cb252-43" tabindex="-1"></a>  data<span class="sc">$</span>baralphatd <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;barchi1&quot;</span>],</span>
<span id="cb252-44"><a href="NE.html#cb252-44" tabindex="-1"></a>                             <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;barchi2&quot;</span>],</span>
<span id="cb252-45"><a href="NE.html#cb252-45" tabindex="-1"></a>                                     <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;barchi3&quot;</span>],</span>
<span id="cb252-46"><a href="NE.html#cb252-46" tabindex="-1"></a>                                             <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">4</span>,param[<span class="st">&quot;barchi4&quot;</span>],<span class="dv">0</span>))))<span class="sc">+</span></span>
<span id="cb252-47"><a href="NE.html#cb252-47" tabindex="-1"></a>                    <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;kappa1&quot;</span>],</span>
<span id="cb252-48"><a href="NE.html#cb252-48" tabindex="-1"></a>                             <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;kappa2&quot;</span>],</span>
<span id="cb252-49"><a href="NE.html#cb252-49" tabindex="-1"></a>                                     <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;kappa3&quot;</span>],</span>
<span id="cb252-50"><a href="NE.html#cb252-50" tabindex="-1"></a>                                             <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">4</span>,param[<span class="st">&quot;kappa4&quot;</span>],<span class="dv">0</span>))))<span class="sc">*</span>(data<span class="sc">$</span>t<span class="sc">-</span>data<span class="sc">$</span>Ds)<span class="sc">*</span><span class="fu">if_else</span>(data<span class="sc">$</span>time<span class="sc">&gt;=</span>data<span class="sc">$</span>Ds,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb252-51"><a href="NE.html#cb252-51" tabindex="-1"></a>  data<span class="sc">$</span>y1 <span class="ot">&lt;-</span> data<span class="sc">$</span>y0 <span class="sc">+</span> data<span class="sc">$</span>baralphat <span class="sc">+</span> data<span class="sc">$</span>baralphatd <span class="sc">+</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;theta1&quot;</span>],<span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;theta2&quot;</span>],<span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;theta3&quot;</span>],param[<span class="st">&quot;theta4&quot;</span>])))<span class="sc">*</span>data<span class="sc">$</span>mu <span class="sc">+</span> data<span class="sc">$</span>eta</span>
<span id="cb252-52"><a href="NE.html#cb252-52" tabindex="-1"></a>  data<span class="sc">$</span>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(data<span class="sc">$</span>y1)</span>
<span id="cb252-53"><a href="NE.html#cb252-53" tabindex="-1"></a>  data<span class="sc">$</span>y <span class="ot">&lt;-</span> data<span class="sc">$</span>y1<span class="sc">*</span>data<span class="sc">$</span>D<span class="sc">+</span>data<span class="sc">$</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>data<span class="sc">$</span>D)</span>
<span id="cb252-54"><a href="NE.html#cb252-54" tabindex="-1"></a>  data<span class="sc">$</span>Y <span class="ot">&lt;-</span> data<span class="sc">$</span>Y1<span class="sc">*</span>data<span class="sc">$</span>D<span class="sc">+</span>data<span class="sc">$</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>data<span class="sc">$</span>D)</span>
<span id="cb252-55"><a href="NE.html#cb252-55" tabindex="-1"></a>  </span>
<span id="cb252-56"><a href="NE.html#cb252-56" tabindex="-1"></a>  <span class="co"># estimating DID model with Sun and Abraham estimator</span></span>
<span id="cb252-57"><a href="NE.html#cb252-57" tabindex="-1"></a>  reg.DID.SA <span class="ot">&lt;-</span> <span class="fu">feols</span>(y <span class="sc">~</span> <span class="fu">sunab</span>(Ds,time) <span class="sc">|</span> id <span class="sc">+</span> time,<span class="at">vcov=</span><span class="st">&#39;HC1&#39;</span>,<span class="at">data=</span><span class="fu">filter</span>(data,Ds<span class="sc">&gt;</span><span class="dv">1</span>))</span>
<span id="cb252-58"><a href="NE.html#cb252-58" tabindex="-1"></a>  resultsDID.SA <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Coef=</span>reg.DID.SA<span class="sc">$</span>coefficients,<span class="at">Se=</span>reg.DID.SA<span class="sc">$</span>se,<span class="at">Name=</span><span class="fu">names</span>(reg.DID.SA<span class="sc">$</span>coefficients)) <span class="sc">%&gt;%</span></span>
<span id="cb252-59"><a href="NE.html#cb252-59" tabindex="-1"></a>                <span class="fu">mutate</span>(</span>
<span id="cb252-60"><a href="NE.html#cb252-60" tabindex="-1"></a>                  <span class="co">#TimeToTreatment = as.numeric(str_split_fixed(Name,&#39;::&#39;,n=2)[,2])</span></span>
<span id="cb252-61"><a href="NE.html#cb252-61" tabindex="-1"></a>                  <span class="at">TimeToTreatment =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(Name,<span class="st">&#39;:&#39;</span>,<span class="at">n=</span><span class="dv">4</span>)[,<span class="dv">3</span>]),</span>
<span id="cb252-62"><a href="NE.html#cb252-62" tabindex="-1"></a>                  <span class="at">Group =</span> <span class="fu">as.numeric</span>(<span class="fu">str_split_fixed</span>(Name,<span class="st">&#39;:&#39;</span>,<span class="at">n=</span><span class="dv">6</span>)[,<span class="dv">6</span>])</span>
<span id="cb252-63"><a href="NE.html#cb252-63" tabindex="-1"></a>                ) <span class="sc">%&gt;%</span></span>
<span id="cb252-64"><a href="NE.html#cb252-64" tabindex="-1"></a>                <span class="fu">select</span>(<span class="sc">-</span>Name) <span class="sc">%&gt;%</span></span>
<span id="cb252-65"><a href="NE.html#cb252-65" tabindex="-1"></a>                <span class="fu">relocate</span>(TimeToTreatment,<span class="at">.before=</span>Coef) <span class="sc">%&gt;%</span></span>
<span id="cb252-66"><a href="NE.html#cb252-66" tabindex="-1"></a>                <span class="fu">relocate</span>(Group,<span class="at">.before=</span>TimeToTreatment)</span>
<span id="cb252-67"><a href="NE.html#cb252-67" tabindex="-1"></a>  <span class="co"># adding reference period</span></span>
<span id="cb252-68"><a href="NE.html#cb252-68" tabindex="-1"></a>  resultsDID.SA <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsDID.SA,<span class="fu">c</span>(<span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">3</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">4</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb252-69"><a href="NE.html#cb252-69" tabindex="-1"></a>  <span class="co"># TT</span></span>
<span id="cb252-70"><a href="NE.html#cb252-70" tabindex="-1"></a>  <span class="co"># ATT &lt;- aggregate(reg.DID, c(&quot;ATT&quot; = &quot;TimeToTreatment::[^-]&quot;))   </span></span>
<span id="cb252-71"><a href="NE.html#cb252-71" tabindex="-1"></a>  ATT.SA <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(reg.DID.SA, <span class="fu">c</span>(<span class="st">&quot;ATT&quot;</span> <span class="ot">=</span> <span class="st">&quot;time::[^-]&quot;</span>))   </span>
<span id="cb252-72"><a href="NE.html#cb252-72" tabindex="-1"></a>  ATT.SA <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Group=</span><span class="st">&quot;All&quot;</span>,<span class="at">TimeToTreatment=</span><span class="dv">99</span>,<span class="at">Coef=</span>ATT.SA[[<span class="dv">1</span>]],<span class="at">Se=</span>ATT.SA[[<span class="dv">2</span>]])</span>
<span id="cb252-73"><a href="NE.html#cb252-73" tabindex="-1"></a>  <span class="co"># joining results SA</span></span>
<span id="cb252-74"><a href="NE.html#cb252-74" tabindex="-1"></a>  resultsDID.SA <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsDID.SA,ATT.SA)</span>
<span id="cb252-75"><a href="NE.html#cb252-75" tabindex="-1"></a>  </span>
<span id="cb252-76"><a href="NE.html#cb252-76" tabindex="-1"></a>  <span class="co"># estimating DID model with 2x2 FD estimators</span></span>
<span id="cb252-77"><a href="NE.html#cb252-77" tabindex="-1"></a>  <span class="co"># generating list of final time periods specific to each treatment group</span></span>
<span id="cb252-78"><a href="NE.html#cb252-78" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="sc">-</span><span class="dv">3</span><span class="sc">:-</span><span class="dv">2</span>,<span class="dv">0</span>)</span>
<span id="cb252-79"><a href="NE.html#cb252-79" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">2</span>,<span class="dv">3</span>),<span class="fu">rep</span>(<span class="dv">3</span>,<span class="dv">3</span>),<span class="fu">rep</span>(<span class="dv">4</span>,<span class="dv">3</span>))</span>
<span id="cb252-80"><a href="NE.html#cb252-80" tabindex="-1"></a>  resultsDID.FD <span class="ot">&lt;-</span> <span class="fu">pmap_dfr</span>(<span class="fu">list</span>(tau,d),StaggeredDID22,<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">dprime=</span><span class="dv">99</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">data=</span>data) <span class="sc">%&gt;%</span></span>
<span id="cb252-81"><a href="NE.html#cb252-81" tabindex="-1"></a>                    <span class="fu">select</span>(d,tau,FDEst,FDSe) <span class="sc">%&gt;%</span></span>
<span id="cb252-82"><a href="NE.html#cb252-82" tabindex="-1"></a>                    <span class="fu">rename</span>(<span class="at">Group=</span>d,</span>
<span id="cb252-83"><a href="NE.html#cb252-83" tabindex="-1"></a>                           <span class="at">TimeToTreatment =</span> tau,</span>
<span id="cb252-84"><a href="NE.html#cb252-84" tabindex="-1"></a>                           <span class="at">Coef=</span>FDEst,</span>
<span id="cb252-85"><a href="NE.html#cb252-85" tabindex="-1"></a>                           <span class="at">Se=</span>FDSe) </span>
<span id="cb252-86"><a href="NE.html#cb252-86" tabindex="-1"></a>  <span class="co"># adding reference period</span></span>
<span id="cb252-87"><a href="NE.html#cb252-87" tabindex="-1"></a>  resultsDID.FD <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsDID.FD,<span class="fu">c</span>(<span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">3</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">4</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb252-88"><a href="NE.html#cb252-88" tabindex="-1"></a>  </span>
<span id="cb252-89"><a href="NE.html#cb252-89" tabindex="-1"></a>  <span class="co"># estimating the DID model with stacked FD</span></span>
<span id="cb252-90"><a href="NE.html#cb252-90" tabindex="-1"></a>  results.Stacked.DID.FD.Full <span class="ot">&lt;-</span> <span class="fu">StackedDIDFD</span>(<span class="at">y=</span><span class="st">&#39;y&#39;</span>,<span class="at">D=</span><span class="st">&#39;Ds&#39;</span>,<span class="at">dprime=</span><span class="dv">99</span>,<span class="at">tauprime=</span><span class="dv">1</span>,<span class="at">t=</span><span class="st">&quot;time&quot;</span>,<span class="at">i=</span><span class="st">&quot;id&quot;</span>,<span class="at">data=</span>data) </span>
<span id="cb252-91"><a href="NE.html#cb252-91" tabindex="-1"></a>  results.Stacked.DID.FD <span class="ot">&lt;-</span> results.Stacked.DID.FD.Full[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb252-92"><a href="NE.html#cb252-92" tabindex="-1"></a>                              <span class="fu">rename</span>(<span class="at">Group=</span>d,</span>
<span id="cb252-93"><a href="NE.html#cb252-93" tabindex="-1"></a>                                     <span class="at">TimeToTreatment =</span> tau,</span>
<span id="cb252-94"><a href="NE.html#cb252-94" tabindex="-1"></a>                                     <span class="at">Coef=</span>TE,</span>
<span id="cb252-95"><a href="NE.html#cb252-95" tabindex="-1"></a>                                     <span class="at">Se=</span>SeTE) <span class="sc">%&gt;%</span></span>
<span id="cb252-96"><a href="NE.html#cb252-96" tabindex="-1"></a>                              <span class="fu">select</span>(<span class="sc">-</span>Ddtau)</span>
<span id="cb252-97"><a href="NE.html#cb252-97" tabindex="-1"></a>  <span class="co"># adding the ATT</span></span>
<span id="cb252-98"><a href="NE.html#cb252-98" tabindex="-1"></a>  ATT.Stacked.DID.FD <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Group=</span><span class="st">&quot;All&quot;</span>,<span class="at">TimeToTreatment=</span><span class="dv">99</span>,<span class="at">Coef=</span>results.Stacked.DID.FD.Full[[<span class="st">&quot;ATT&quot;</span>]],<span class="at">Se=</span>results.Stacked.DID.FD.Full[[<span class="st">&quot;ATTSe&quot;</span>]]) <span class="sc">%&gt;%</span></span>
<span id="cb252-99"><a href="NE.html#cb252-99" tabindex="-1"></a>                          <span class="fu">rename</span>(<span class="at">Se=</span>weights)</span>
<span id="cb252-100"><a href="NE.html#cb252-100" tabindex="-1"></a>  results.Stacked.DID.FD <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results.Stacked.DID.FD,ATT.Stacked.DID.FD)</span>
<span id="cb252-101"><a href="NE.html#cb252-101" tabindex="-1"></a></span>
<span id="cb252-102"><a href="NE.html#cb252-102" tabindex="-1"></a>  <span class="co"># joining all results</span></span>
<span id="cb252-103"><a href="NE.html#cb252-103" tabindex="-1"></a>  resultsDID.SA <span class="ot">&lt;-</span> resultsDID.SA <span class="sc">%&gt;%</span></span>
<span id="cb252-104"><a href="NE.html#cb252-104" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">&quot;SA&quot;</span>)</span>
<span id="cb252-105"><a href="NE.html#cb252-105" tabindex="-1"></a>  resultsDID.FD <span class="ot">&lt;-</span> resultsDID.FD <span class="sc">%&gt;%</span></span>
<span id="cb252-106"><a href="NE.html#cb252-106" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">&quot;FD&quot;</span>)</span>
<span id="cb252-107"><a href="NE.html#cb252-107" tabindex="-1"></a>  results.Stacked.DID.FD <span class="ot">&lt;-</span> results.Stacked.DID.FD <span class="sc">%&gt;%</span></span>
<span id="cb252-108"><a href="NE.html#cb252-108" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">&quot;StackedFD&quot;</span>)</span>
<span id="cb252-109"><a href="NE.html#cb252-109" tabindex="-1"></a>  resultsDID <span class="ot">&lt;-</span> <span class="fu">rbind</span>(resultsDID.SA,resultsDID.FD,results.Stacked.DID.FD) <span class="sc">%&gt;%</span></span>
<span id="cb252-110"><a href="NE.html#cb252-110" tabindex="-1"></a>                  <span class="fu">relocate</span>(Method) <span class="sc">%&gt;%</span></span>
<span id="cb252-111"><a href="NE.html#cb252-111" tabindex="-1"></a>                  <span class="fu">arrange</span>(Method,Group,TimeToTreatment) <span class="sc">%&gt;%</span></span>
<span id="cb252-112"><a href="NE.html#cb252-112" tabindex="-1"></a>                  <span class="fu">as_tibble</span>(.)</span>
<span id="cb252-113"><a href="NE.html#cb252-113" tabindex="-1"></a>  <span class="co"># return results</span></span>
<span id="cb252-114"><a href="NE.html#cb252-114" tabindex="-1"></a>  <span class="fu">return</span>(resultsDID)</span>
<span id="cb252-115"><a href="NE.html#cb252-115" tabindex="-1"></a>}</span>
<span id="cb252-116"><a href="NE.html#cb252-116" tabindex="-1"></a></span>
<span id="cb252-117"><a href="NE.html#cb252-117" tabindex="-1"></a><span class="co"># test</span></span>
<span id="cb252-118"><a href="NE.html#cb252-118" tabindex="-1"></a>testDIDMC <span class="ot">&lt;-</span> <span class="fu">Outcome.Sample.DID</span>(<span class="at">seed=</span><span class="dv">1</span>,<span class="at">N=</span><span class="dv">1000</span>,<span class="at">T=</span><span class="dv">4</span>,<span class="at">param=</span>param)</span></code></pre></div>
<p>Let us now parallelize this function.</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="NE.html#cb253-1" tabindex="-1"></a><span class="co"># programming to run in parallel</span></span>
<span id="cb253-2"><a href="NE.html#cb253-2" tabindex="-1"></a><span class="co"># Nsim: number of simulations</span></span>
<span id="cb253-3"><a href="NE.html#cb253-3" tabindex="-1"></a><span class="co"># N: number of units in the panel</span></span>
<span id="cb253-4"><a href="NE.html#cb253-4" tabindex="-1"></a><span class="co"># T: number of periods in the panel</span></span>
<span id="cb253-5"><a href="NE.html#cb253-5" tabindex="-1"></a><span class="co"># param: parameters</span></span>
<span id="cb253-6"><a href="NE.html#cb253-6" tabindex="-1"></a>sf.MonteCarlo.DID <span class="ot">&lt;-</span> <span class="cf">function</span>(Nsim,N,T,param){</span>
<span id="cb253-7"><a href="NE.html#cb253-7" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span><span class="dv">8</span>)</span>
<span id="cb253-8"><a href="NE.html#cb253-8" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(tidyverse)</span>
<span id="cb253-9"><a href="NE.html#cb253-9" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(fixest)</span>
<span id="cb253-10"><a href="NE.html#cb253-10" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(recipes)</span>
<span id="cb253-11"><a href="NE.html#cb253-11" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(mvtnorm)</span>
<span id="cb253-12"><a href="NE.html#cb253-12" tabindex="-1"></a>  <span class="fu">sfLibrary</span>(Matrix)</span>
<span id="cb253-13"><a href="NE.html#cb253-13" tabindex="-1"></a>  <span class="fu">sfExport</span>(<span class="st">&#39;StaggeredDID22&#39;</span>)</span>
<span id="cb253-14"><a href="NE.html#cb253-14" tabindex="-1"></a>  <span class="fu">sfExport</span>(<span class="st">&#39;StackedDIDFD&#39;</span>)</span>
<span id="cb253-15"><a href="NE.html#cb253-15" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,Outcome.Sample.DID,<span class="at">N=</span>N,<span class="at">T=</span>T,<span class="at">param=</span>param) </span>
<span id="cb253-16"><a href="NE.html#cb253-16" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb253-17"><a href="NE.html#cb253-17" tabindex="-1"></a>  <span class="co"># generate mean and standard error</span></span>
<span id="cb253-18"><a href="NE.html#cb253-18" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> sim <span class="sc">%&gt;%</span> </span>
<span id="cb253-19"><a href="NE.html#cb253-19" tabindex="-1"></a>          <span class="fu">bind_rows</span>(.) <span class="sc">%&gt;%</span></span>
<span id="cb253-20"><a href="NE.html#cb253-20" tabindex="-1"></a>          <span class="fu">group_by</span>(TimeToTreatment,Group,Method) <span class="sc">%&gt;%</span></span>
<span id="cb253-21"><a href="NE.html#cb253-21" tabindex="-1"></a>          <span class="fu">summarize</span>(</span>
<span id="cb253-22"><a href="NE.html#cb253-22" tabindex="-1"></a>            <span class="at">TE =</span> <span class="fu">mean</span>(Coef),</span>
<span id="cb253-23"><a href="NE.html#cb253-23" tabindex="-1"></a>            <span class="at">SdTE =</span> <span class="fu">sd</span>(Coef),</span>
<span id="cb253-24"><a href="NE.html#cb253-24" tabindex="-1"></a>            <span class="at">MeanSeTE =</span> <span class="fu">mean</span>(Se)</span>
<span id="cb253-25"><a href="NE.html#cb253-25" tabindex="-1"></a>          ) <span class="sc">%&gt;%</span></span>
<span id="cb253-26"><a href="NE.html#cb253-26" tabindex="-1"></a>          <span class="fu">ungroup</span>(.) </span>
<span id="cb253-27"><a href="NE.html#cb253-27" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb253-28"><a href="NE.html#cb253-28" tabindex="-1"></a>}</span>
<span id="cb253-29"><a href="NE.html#cb253-29" tabindex="-1"></a><span class="co"># testing</span></span>
<span id="cb253-30"><a href="NE.html#cb253-30" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb253-31"><a href="NE.html#cb253-31" tabindex="-1"></a><span class="co">#sf.test.MonteCarlo.DID &lt;- sf.MonteCarlo.DID(Nsim=Nsim,N=1000,T=4,param=param)</span></span>
<span id="cb253-32"><a href="NE.html#cb253-32" tabindex="-1"></a></span>
<span id="cb253-33"><a href="NE.html#cb253-33" tabindex="-1"></a><span class="co"># true simulations</span></span>
<span id="cb253-34"><a href="NE.html#cb253-34" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb253-35"><a href="NE.html#cb253-35" tabindex="-1"></a>sf.simuls.MonteCarlo.DID <span class="ot">&lt;-</span> <span class="fu">sf.MonteCarlo.DID</span>(<span class="at">Nsim=</span>Nsim,<span class="at">N=</span><span class="dv">1000</span>,<span class="at">T=</span><span class="dv">4</span>,<span class="at">param=</span>param)</span></code></pre></div>
<p>Let us now plot the resulting estimates.
For simplicity, I center treatment effect estimates at their mean, so that we can focus on sampling noise and precision.
If we did not center treatment effect estimates, variation in the size of treatment effects over time would dwarf variations in sampling noise.</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="NE.html#cb254-1" tabindex="-1"></a><span class="co"># prepapring data</span></span>
<span id="cb254-2"><a href="NE.html#cb254-2" tabindex="-1"></a>sf.simuls.MonteCarlo.DID <span class="ot">&lt;-</span> sf.simuls.MonteCarlo.DID <span class="sc">%&gt;%</span></span>
<span id="cb254-3"><a href="NE.html#cb254-3" tabindex="-1"></a>                                    <span class="fu">mutate</span>(</span>
<span id="cb254-4"><a href="NE.html#cb254-4" tabindex="-1"></a>                                      <span class="at">TimeToTreatment =</span> <span class="fu">case_when</span>(</span>
<span id="cb254-5"><a href="NE.html#cb254-5" tabindex="-1"></a>                                        TimeToTreatment <span class="sc">==</span> <span class="st">&quot;99&quot;</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb254-6"><a href="NE.html#cb254-6" tabindex="-1"></a>                                        <span class="cn">TRUE</span> <span class="sc">~</span> TimeToTreatment</span>
<span id="cb254-7"><a href="NE.html#cb254-7" tabindex="-1"></a>                                      ),</span>
<span id="cb254-8"><a href="NE.html#cb254-8" tabindex="-1"></a>                                      <span class="at">NetTE=</span><span class="dv">0</span></span>
<span id="cb254-9"><a href="NE.html#cb254-9" tabindex="-1"></a>                                    ) <span class="sc">%&gt;%</span></span>
<span id="cb254-10"><a href="NE.html#cb254-10" tabindex="-1"></a>                                    <span class="fu">pivot_longer</span>(<span class="at">cols=</span>SdTE<span class="sc">:</span>MeanSeTE,<span class="at">names_to =</span> <span class="st">&quot;Type&quot;</span>,<span class="at">values_to=</span><span class="st">&quot;SeEstim&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb254-11"><a href="NE.html#cb254-11" tabindex="-1"></a>                                    <span class="fu">mutate</span>(</span>
<span id="cb254-12"><a href="NE.html#cb254-12" tabindex="-1"></a>                                      <span class="at">Type =</span> <span class="fu">case_when</span>(</span>
<span id="cb254-13"><a href="NE.html#cb254-13" tabindex="-1"></a>                                        Type <span class="sc">==</span> <span class="st">&quot;MeanSeTE&quot;</span> <span class="sc">~</span> <span class="st">&quot;Estimated&quot;</span>,</span>
<span id="cb254-14"><a href="NE.html#cb254-14" tabindex="-1"></a>                                        Type <span class="sc">==</span> <span class="st">&quot;SdTE&quot;</span> <span class="sc">~</span> <span class="st">&quot;Truth&quot;</span>,</span>
<span id="cb254-15"><a href="NE.html#cb254-15" tabindex="-1"></a>                                        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">&quot;&quot;</span></span>
<span id="cb254-16"><a href="NE.html#cb254-16" tabindex="-1"></a>                                      ),</span>
<span id="cb254-17"><a href="NE.html#cb254-17" tabindex="-1"></a>                                      <span class="at">Type =</span> <span class="fu">factor</span>(Type,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;Truth&quot;</span>,<span class="st">&quot;Estimated&quot;</span>))</span>
<span id="cb254-18"><a href="NE.html#cb254-18" tabindex="-1"></a>                                    )</span>
<span id="cb254-19"><a href="NE.html#cb254-19" tabindex="-1"></a></span>
<span id="cb254-20"><a href="NE.html#cb254-20" tabindex="-1"></a><span class="fu">ggplot</span>(sf.simuls.MonteCarlo.DID,<span class="fu">aes</span>(<span class="at">x=</span>TimeToTreatment,<span class="at">y=</span>NetTE,<span class="at">group=</span>Type,<span class="at">color=</span>Type,<span class="at">linetype=</span>Type))<span class="sc">+</span></span>
<span id="cb254-21"><a href="NE.html#cb254-21" tabindex="-1"></a><span class="co">#  geom_pointrange(aes(ymin=TE-1.96*SeEstim,ymax=TE+1.96*SeEstim),position=position_dodge(1))+</span></span>
<span id="cb254-22"><a href="NE.html#cb254-22" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color=</span><span class="st">&#39;red&#39;</span>) <span class="sc">+</span></span>
<span id="cb254-23"><a href="NE.html#cb254-23" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin=</span>NetTE<span class="fl">-1.96</span><span class="sc">*</span>SeEstim,<span class="at">ymax=</span>NetTE<span class="fl">+1.96</span><span class="sc">*</span>SeEstim,<span class="at">color=</span>Type,<span class="at">group=</span>Type,<span class="at">linetype=</span>Type),<span class="at">position=</span><span class="fu">position_dodge</span>(<span class="fl">0.9</span>),<span class="at">width=</span><span class="fl">0.3</span>)<span class="sc">+</span></span>
<span id="cb254-24"><a href="NE.html#cb254-24" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb254-25"><a href="NE.html#cb254-25" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb254-26"><a href="NE.html#cb254-26" tabindex="-1"></a>  <span class="fu">facet_grid</span>(Group<span class="sc">~</span>Method)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:MonteCarloDIDParPlot"></span>
<img src="STCI_files/figure-html/MonteCarloDIDParPlot-1.png" alt="Comparison of estimates of sampling noise in staggered designs" width="75%" />
<p class="caption">
Figure 4.47: Comparison of estimates of sampling noise in staggered designs
</p>
</div>
<p>It seems that the <code>fixest</code> implementation of the Sun and Abraham estimator overestimates sampling noise for some individual treatment effects (for example <span class="math inline">\(d=2\)</span> and <span class="math inline">\(\tau=0\)</span>), while it underestimates sampling noise for the aggregated treatment effect.
The <span class="math inline">\(2\times 2\)</span> DID estimator seems to provide much more consistent estimates of the precision of the individual level treatment effects.
Both the <code>fixest</code> implementation of the Sun and Abraham estimator and our Stacked DID estimator seem to underestimate the sampling noise of the ATT parameter.
We are going to study whether this is the case and what to do about it in Chapter <a href="cluster.html#cluster">9</a>.</p>
</div>
</div>
</div>
<div id="difference-in-differences-with-instrumental-variables" class="section level3 hasAnchor" number="4.3.4">
<h3><span class="header-section-number">4.3.4</span> Difference In Differences with Instrumental Variables<a href="NE.html#difference-in-differences-with-instrumental-variables" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Sometimes, the Parallel Trends Assumption (Assumption <a href="NE.html#hyp:ParallelTrends">4.14</a> or Assumption <a href="NE.html#hyp:ParallelTrendsTime">4.25</a> with staggered designs) does not hold.
This might be because individuals select into the treatment based on unobservables correlated with the dynamics of outcomes in the absence of the treatment.
One of the most famous cases in point is <a href="https://www.jstor.org/stable/2565708">the dip in earnings that future participants experience before entering a Job Training Program</a>.
In that case, one might be able to reframe the Parallel Trends Assumption to hold not with respect to treatment participation, but with respect to an instrumental variable that affects participation in the treatment.
In such a case, we say that we have a Difference In Differences design with Instrumental Variables or DID-IV for short.
In this section, we are going to study how to identify treatment effects in this design and how to estimate them and their precision.</p>
<p>In DID-IV designs, a key distinction is between a strong first stage and a weak first stage.
In a strong first stage, observations with a low level of the instrumental variable do not access the program, while in a weak first stage, they can.
In a world of heterogeneous treatment effects, this distinction turns out to be crucial.
We will first delineate identification and estimation in the case of a strong first stage, and then move on to what happens in the more complex case of a weak first stage.</p>
<div id="did-iv-with-a-strong-first-stage" class="section level4 hasAnchor" number="4.3.4.1">
<h4><span class="header-section-number">4.3.4.1</span> DID-IV with a strong first stage<a href="NE.html#did-iv-with-a-strong-first-stage" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Let us first examine what is happening with DID-IV under a strong first stage.
We are going to consider identification, estimation and estimation of sampling noise.</p>
<div id="identification-under-strong-first-stage-did-iv" class="section level5 hasAnchor" number="4.3.4.1.1">
<h5><span class="header-section-number">4.3.4.1.1</span> Identification under strong first stage DID-IV<a href="NE.html#identification-under-strong-first-stage-did-iv" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We need some assumptions first.
We are going to go back to the case where there are only two time periods, one before (<span class="math inline">\(t=B\)</span>) and one after (<span class="math inline">\(t=A\)</span>).
We are going to keep making Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a> and <a href="NE.html#hyp:NoAnticipationEffects">4.13</a> of absence of treatment in period <span class="math inline">\(t=B\)</span> and of absence of anticipation effects.
On top of these assumptions, we are first going to assume that there is a random variable <span class="math inline">\(Z_i\)</span> taking two values (<span class="math inline">\(Z_i=1\)</span> and <span class="math inline">\(Z_i=0\)</span>) such that the parallel trends assumption holds for this variable:</p>
<div class="hypothesis">
<p><span id="hyp:ParallelTrendsIV" class="hypothesis"><strong>Hypothesis 4.29  (Parallel Trends with Instrumental Variables) </strong></span>We assume that the trends in the potential outcomes in the absence the treatment are the same, independent of the value of the instrumental variable:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^0_{i,A}|Z_i=1} - \esp{Y^0_{i,B}|Z_i=1} &amp; =   \esp{Y^0_{i,A}|Z_i=0} - \esp{Y^0_{i,B}|Z_i=0}.
\end{align*}\]</span></p>
</div>
<p>We also assume that the instrumental variables alters the probability that a unit receives the treatment:</p>
<div class="hypothesis">
<p><span id="hyp:StrongFirstStageDIDIV" class="hypothesis"><strong>Hypothesis 4.30  (Strong First Stage) </strong></span>The probability of receiving the treatment is strictly positive when <span class="math inline">\(Z_i=1\)</span> and is zero when <span class="math inline">\(Z_i=0\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\Pr(D_i=1|Z_i=1)&gt;\Pr(D_i=1|Z_i=0)=0.
\end{align*}\]</span></p>
</div>
<div class="remark">
<p><span id="unlabeled-div-153" class="remark"><em>Remark</em>. </span>Assumption <a href="NE.html#hyp:StrongFirstStageDIDIV">4.30</a> is really strong.
Combined with Assumption <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, it implies that the only group which is able to receive the treament is the group with <span class="math inline">\(Z_i=1\)</span> in the After period.</p>
</div>
<p>Equipped with these assumptions, we can now prove the following theorem:</p>
<div class="theorem">
<p><span id="thm:IdentTTDIDIVStrongFS" class="theorem"><strong>Theorem 4.28  (Indentification of TT with DID-IV and a Strong First Stage) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a> and <a href="NE.html#hyp:StrongFirstStageDIDIV">4.30</a>, TT is identified by the Wald-DID estimator:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{WaldDID} &amp; = \Delta^{Y_A}_{TT},
\end{align*}\]</span></p>
<p>with:
<span class="math display">\[\begin{align*}
  \Delta^Y_{WaldDID} &amp; = \frac{\esp{Y_{i,A}|Z_i=1}-\esp{Y_{i,A}|Z_i=0}-(\esp{Y_{i,B}|Z_i=1}-\esp{Y_{i,B}|Z_i=0})}{\Pr(D_{i,A}=1|Z_i=1)-\Pr(D_{i,A}=1|Z_i=0)-(\Pr(D_{i,B}=1|Z_i=1)-\Pr(D_{i,B}=1|Z_i=0))}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-154" class="proof"><em>Proof</em>. </span>Under Assumption <a href="NE.html#hyp:ParallelTrendsIV">4.29</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
  \esp{Y^0_{i,A}|Z_i=1} &amp; = \esp{Y^0_{i,A}|Z_i=0} + (\esp{Y^0_{i,B}|Z_i=1}-\esp{Y^0_{i,B}|Z_i=0})
\end{align*}\]</span></p>
<p>As a consequence, the numerator of the Wald-DID estimator is:</p>
<p><span class="math display">\[\begin{align*}
\esp{Y_{i,A}|Z_i=1} &amp; -\esp{Y_{i,A}|Z_i=0}-(\esp{Y_{i,B}|Z_i=1}-\esp{Y_{i,B}|Z_i=0}) \\
                    &amp; = \esp{Y_{i,A}|Z_i=1} - \esp{Y^0_{i,A}|Z_i=1} \\
                    &amp; = \esp{Y^1_{i,A}|D_i=1,Z_i=1}\Pr(D_i=1|Z_i=1)+\esp{Y^0_{i,A}|D_i=0,Z_i=1}\Pr(D_i=0|Z_i=1)\\
                    &amp;\phantom{=}-\esp{Y^0_{i,A}|D_i=1,Z_i=1}\Pr(D_i=1|Z_i=1)+\esp{Y^0_{i,A}|D_i=0,Z_i=1}\Pr(D_i=0|Z_i=1)\\
                    &amp; = \left(\esp{Y^1_{i,A}|D_i=1,Z_i=1}-\esp{Y^0_{i,A}|D_i=1,Z_i=1}\right)\Pr(D_i=1|Z_i=1)\\
                    &amp; = \Delta^{Y_A}_{TT}\Pr(D_i=1|Z_i=1),
\end{align*}\]</span></p>
<p>where the last equality uses the fact that <span class="math inline">\(D_i=1\)</span> is a subset of <span class="math inline">\(Z_i=1\)</span>.
Using Assumption <a href="NE.html#hyp:StrongFirstStageDIDIV">4.30</a> proves that the denominator of the Wald-DID estimator is equal to <span class="math inline">\(\Pr(D_i=1|Z_i=1)\)</span>, which proves the result.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-271" class="example"><strong>Example 4.54  </strong></span>Let’s see how this approach works in our example.
We are going to assume that there are 50 states and that the treatment is only available in half of them.
This state indicator is going to be our instrumental variable.
In our model, states fixed effects are going to be correlated with treatment intake (and even with <span class="math inline">\(Z_i\)</span>) but <span class="math inline">\(Z_i\)</span> wil not be correlated with indiosyncratic shocks to outcomes that make people enter the treatment.</p>
</div>
<p><span class="math display">\[\begin{align*}
  \mu_i &amp; = \mu^S_i + \mu^U_i + \bar{\mu} \\
  \mu^S_i &amp; \sim\mathcal{N}(0,\frac{1}{3}\sigma_{\mu}^2)\\
  \mu^U_i &amp; \sim\mathcal{N}(0,\frac{2}{3}\sigma_{\mu}^2)\\
  Z _i &amp; =
    \begin{cases}
      1 &amp; \text{ if } \mu^S_i\leq 0 \\
      0 &amp; \text{ if } \mu^S_i&gt; 0
    \end{cases}\\
  D_i &amp; = \uns{y_i^B\leq\bar{y} \land Z_i=1}.
\end{align*}\]</span></p>
<p>Let us first respecify the parameter vector:</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="NE.html#cb255-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">7.98</span>)</span>
<span id="cb255-2"><a href="NE.html#cb255-2" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,<span class="st">&quot;theta&quot;</span>,<span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;baralpha&quot;</span>,<span class="st">&quot;gamma&quot;</span>,<span class="st">&quot;baryB&quot;</span>)</span></code></pre></div>
<p>Let’s simulate that dataset.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="NE.html#cb256-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb256-2"><a href="NE.html#cb256-2" tabindex="-1"></a>N <span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb256-3"><a href="NE.html#cb256-3" tabindex="-1"></a>param[<span class="st">&quot;rho&quot;</span>] <span class="ot">&lt;-</span> <span class="fl">0.9</span></span>
<span id="cb256-4"><a href="NE.html#cb256-4" tabindex="-1"></a><span class="co"># I am going to draw a state fixed effect for 50 states with variance 1/3 of the total variance of mu</span></span>
<span id="cb256-5"><a href="NE.html#cb256-5" tabindex="-1"></a>Nstates <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb256-6"><a href="NE.html#cb256-6" tabindex="-1"></a>muS <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(Nstates,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb256-7"><a href="NE.html#cb256-7" tabindex="-1"></a>muS <span class="ot">&lt;-</span> <span class="fu">rep</span>(muS,<span class="at">each=</span>N<span class="sc">/</span>Nstates)</span>
<span id="cb256-8"><a href="NE.html#cb256-8" tabindex="-1"></a><span class="co"># I draw an individual fixed effect with the remaining variance</span></span>
<span id="cb256-9"><a href="NE.html#cb256-9" tabindex="-1"></a>muU <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">*</span><span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb256-10"><a href="NE.html#cb256-10" tabindex="-1"></a>mu <span class="ot">&lt;-</span> param[<span class="st">&quot;barmu&quot;</span>] <span class="sc">+</span> muS <span class="sc">+</span> muU </span>
<span id="cb256-11"><a href="NE.html#cb256-11" tabindex="-1"></a>UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb256-12"><a href="NE.html#cb256-12" tabindex="-1"></a>yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb256-13"><a href="NE.html#cb256-13" tabindex="-1"></a>YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb256-14"><a href="NE.html#cb256-14" tabindex="-1"></a>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb256-15"><a href="NE.html#cb256-15" tabindex="-1"></a>eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb256-16"><a href="NE.html#cb256-16" tabindex="-1"></a>U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb256-17"><a href="NE.html#cb256-17" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb256-18"><a href="NE.html#cb256-18" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb256-19"><a href="NE.html#cb256-19" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb256-20"><a href="NE.html#cb256-20" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb256-21"><a href="NE.html#cb256-21" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb256-22"><a href="NE.html#cb256-22" tabindex="-1"></a></span>
<span id="cb256-23"><a href="NE.html#cb256-23" tabindex="-1"></a><span class="co"># Z=1 if states have lower muS than 0</span></span>
<span id="cb256-24"><a href="NE.html#cb256-24" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(muS<span class="sc">&lt;=</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb256-25"><a href="NE.html#cb256-25" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>] <span class="sc">&amp;</span> Z<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb256-26"><a href="NE.html#cb256-26" tabindex="-1"></a>y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb256-27"><a href="NE.html#cb256-27" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span></code></pre></div>
<p>Let us know look at how Assumption <a href="NE.html#hyp:StrongFirstStageDIDIV">4.30</a> holds:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="NE.html#cb257-1" tabindex="-1"></a><span class="co"># preparing the means of participants proportions</span></span>
<span id="cb257-2"><a href="NE.html#cb257-2" tabindex="-1"></a>means.did.iv <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y0[Z<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y0[Z<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">1</span>]),<span class="fu">mean</span>(yB[Z<span class="sc">==</span><span class="dv">0</span>]),<span class="fu">mean</span>(yB[Z<span class="sc">==</span><span class="dv">1</span>]),<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb257-3"><a href="NE.html#cb257-3" tabindex="-1"></a>means.did.iv <span class="ot">&lt;-</span> <span class="fu">matrix</span>(means.did.iv,<span class="at">nrow=</span><span class="dv">2</span>,<span class="at">ncol=</span><span class="dv">5</span>,<span class="at">byrow=</span><span class="cn">FALSE</span>,<span class="at">dimnames=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;Z=0&#39;</span>,<span class="st">&#39;Z=1&#39;</span>),<span class="fu">c</span>(<span class="st">&#39;D&#39;</span>,<span class="st">&#39;y0&#39;</span>,<span class="st">&#39;y&#39;</span>,<span class="st">&#39;yB&#39;</span>,<span class="st">&#39;Z&#39;</span>)))</span>
<span id="cb257-4"><a href="NE.html#cb257-4" tabindex="-1"></a>means.did.iv <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(means.did.iv)</span>
<span id="cb257-5"><a href="NE.html#cb257-5" tabindex="-1"></a><span class="co"># plotting the result</span></span>
<span id="cb257-6"><a href="NE.html#cb257-6" tabindex="-1"></a><span class="fu">ggplot</span>(means.did.iv, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.factor</span>(Z), <span class="at">y=</span>D)) <span class="sc">+</span></span>
<span id="cb257-7"><a href="NE.html#cb257-7" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">position=</span><span class="fu">position_dodge</span>(), <span class="at">stat=</span><span class="st">&quot;identity&quot;</span>, <span class="at">colour=</span><span class="st">&#39;black&#39;</span>)<span class="sc">+</span></span>
<span id="cb257-8"><a href="NE.html#cb257-8" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;Z&#39;</span>)<span class="sc">+</span></span>
<span id="cb257-9"><a href="NE.html#cb257-9" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;Pr(D=1|Z)&#39;</span>)<span class="sc">+</span></span>
<span id="cb257-10"><a href="NE.html#cb257-10" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotSimulDIDIVStrong"></span>
<img src="STCI_files/figure-html/PlotSimulDIDIVStrong-1.png" alt="Illustration of the DID-IV assumptions: Strong First Stage" width="50%" />
<p class="caption">
Figure 4.48: Illustration of the DID-IV assumptions: Strong First Stage
</p>
</div>
<p>Figure <a href="NE.html#fig:PlotSimulDIDIVStrong">4.48</a> shows that no unit with <span class="math inline">\(Z_i=0\)</span> receives the treatment.
We also have that <span class="math inline">\(\hat{\Pr}(D_i=1|Z_i=1)=\)</span> 0.36.</p>
<p>A key feature of the simulated dataset is that the parallel trends assumption does not hold for <span class="math inline">\(D_i\)</span> but it does for <span class="math inline">\(Z_i\)</span>.
Let’s check.
We indeed have that <span class="math inline">\(\hatesp{y^0_{i}|D_i=1}-\hatesp{y^B_{i}|D_i=1}=\)</span> 0.12 and <span class="math inline">\(\hatesp{y^0_{i}|D_i=0}-\hatesp{y^B_{i}|D_i=0}=\)</span> 0.04.
We also have <span class="math inline">\(\hatesp{y^0_{i}|Z_i=1}-\hatesp{y^B_{i}|Z_i=1}=\)</span> 0.06 and <span class="math inline">\(\hatesp{y^0_{i}|Z_i=0}-\hatesp{y^B_{i}|Z_i=0}=\)</span> 0.05.</p>
<p>The true effect of the treatment in our model is:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^y_{TT} &amp; = \bar{\alpha}+ \theta\esp{\mu_i|\mu_i+U_i^B\leq\bar{y} \land \mu_i^S\leq0}
\end{align*}\]</span></p>
<p>To compute the expectation of a this censored normal, I use the package <code>tmvtnorm</code>:</p>
<p>The value of <span class="math inline">\(\Delta^y_{TT}\)</span> in the population is thus 0.17 and in the sample 0.17.
Simple DID would not be a correct estimate of <span class="math inline">\(TT\)</span>.
Indeed, the value of the DID estimator in the sample is 0.24.
The Wald DID estimator should be closer to the truth.
In the sample, it is equal to 0.2.</p>
</div>
<div id="estimation-4" class="section level5 hasAnchor" number="4.3.4.1.2">
<h5><span class="header-section-number">4.3.4.1.2</span> Estimation<a href="NE.html#estimation-4" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Estimation of the DID-IV estimator can be conducted using several approaches.
Let’s review them in turn.</p>
<div id="using-the-direct-wald-estimator" class="section level6 hasAnchor" number="4.3.4.1.2.1">
<h6><span class="header-section-number">4.3.4.1.2.1</span> Using the direct Wald estimator<a href="NE.html#using-the-direct-wald-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The most direct way to compute the DID-IV estimator in a sample is simply to compute its sample equivalent:</p>
<p><span class="math display">\[\begin{gather*}
  \hat{\Delta}^Y_{WaldDID}=  \\
  \frac{\frac{1}{\sum_{i=1}^{N}Z_i}\sum_{i=1}^{N}Y_{i,A}Z_i - \frac{1}{\sum_{i=1}^{N}(1-Z_i)}\sum_{i=1}^{N}Y_{i,A}(1-Z_i)
  -\left(\frac{1}{\sum_{i=1}^{N}Z_i}\sum_{i=1}^{N}Y_{i,B}Z_i - \frac{1}{\sum_{i=1}^{N}(1-Z_i)}\sum_{i=1}^{N}Y_{i,B}(1-Z_i)\right)}
  {\frac{1}{\sum_{i=1}^{N}Z_i}\sum_{i=1}^{N}D_{i,A}Z_i - \frac{1}{\sum_{i=1}^{N}(1-Z_i)}\sum_{i=1}^{N}D_{i,A}(1-Z_i)
  -\left(\frac{1}{\sum_{i=1}^{N}Z_i}\sum_{i=1}^{N}D_{i,B}Z_i - \frac{1}{\sum_{i=1}^{N}(1-Z_i)}\sum_{i=1}^{N}D_{i,B}(1-Z_i)\right)}.
\end{gather*}\]</span></p>
<div class="remark">
<p><span id="unlabeled-div-155" class="remark"><em>Remark</em>. </span>Under Assumption <a href="NE.html#hyp:StrongFirstStageDIDIV">4.30</a>, the denominator simplifies to <span class="math inline">\(\frac{1}{\sum_{i=1}^{N}Z_i}\sum_{i=1}^{N}D_{i}Z_i\)</span>.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-273" class="example"><strong>Example 4.55  </strong></span>Let’s see how this estimator works in our example.</p>
</div>
<p>As we have already seen, in our example, the Wald DID estimator is equal to 0.2.
Remember that the value of <span class="math inline">\(\Delta^y_{TT}\)</span> in the population is 0.17 and in the sample 0.17.</p>
</div>
<div id="using-the-pooled-2sls-did-estimator" class="section level6 hasAnchor" number="4.3.4.1.2.2">
<h6><span class="header-section-number">4.3.4.1.2.2</span> Using the pooled 2SLS DID estimator<a href="NE.html#using-the-pooled-2sls-did-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>In repeated cross-sections, one can estimate the Wald estimator estimating the following model with the 2SLS estimator:</p>
<p><span class="math display">\[\begin{align*}
Y_i &amp; = \alpha + \delta t_i + \gamma D_i + \beta t_iD_i + U_i,
\end{align*}\]</span></p>
<p>with <span class="math inline">\(t_iZ_i\)</span> as an instrument for <span class="math inline">\(t_iD_i\)</span> and <span class="math inline">\(Z_i\)</span> as an instrument for <span class="math inline">\(D_i\)</span>.
<span class="math inline">\(\hat{\beta}_{2SLS}\)</span> in the previous regression is the Pooled 2SLS DID estimator.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-274" class="example"><strong>Example 4.56  </strong></span>Let’s estimate that model in our example.</p>
</div>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="NE.html#cb258-1" tabindex="-1"></a><span class="co"># regrouping data</span></span>
<span id="cb258-2"><a href="NE.html#cb258-2" tabindex="-1"></a>y.pool <span class="ot">&lt;-</span> <span class="fu">c</span>(y,yB)</span>
<span id="cb258-3"><a href="NE.html#cb258-3" tabindex="-1"></a>Ds.pool <span class="ot">&lt;-</span> <span class="fu">c</span>(Ds,Ds)</span>
<span id="cb258-4"><a href="NE.html#cb258-4" tabindex="-1"></a>Z.pool <span class="ot">&lt;-</span> <span class="fu">c</span>(Z,Z)</span>
<span id="cb258-5"><a href="NE.html#cb258-5" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,N),<span class="fu">rep</span>(<span class="dv">0</span>,N))</span>
<span id="cb258-6"><a href="NE.html#cb258-6" tabindex="-1"></a>t.D <span class="ot">&lt;-</span> t<span class="sc">*</span>Ds.pool</span>
<span id="cb258-7"><a href="NE.html#cb258-7" tabindex="-1"></a>t.Z <span class="ot">&lt;-</span> t<span class="sc">*</span>Z.pool</span>
<span id="cb258-8"><a href="NE.html#cb258-8" tabindex="-1"></a></span>
<span id="cb258-9"><a href="NE.html#cb258-9" tabindex="-1"></a><span class="co"># IV regression</span></span>
<span id="cb258-10"><a href="NE.html#cb258-10" tabindex="-1"></a>reg.iv.did.pooled<span class="fl">.2</span>sls <span class="ot">&lt;-</span> <span class="fu">ivreg</span>(y.pool <span class="sc">~</span> t <span class="sc">+</span> Ds.pool <span class="sc">+</span> t.D <span class="sc">|</span> t <span class="sc">+</span> Z.pool <span class="sc">+</span> t.Z)</span></code></pre></div>
<p>In our example, <span class="math inline">\(\hat{\beta}_{2SLS}=\)</span> 0.2.</p>
</div>
<div id="using-the-within-2sls-did-estimator" class="section level6 hasAnchor" number="4.3.4.1.2.3">
<h6><span class="header-section-number">4.3.4.1.2.3</span> Using the within 2SLS DID estimator<a href="NE.html#using-the-within-2sls-did-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>Estimating the following equation with <span class="math inline">\(t_iZ_i\)</span> as an instrument for <span class="math inline">\(t_iD_i\)</span>:</p>
<p><span class="math display">\[\begin{align*}
Y_{i,t} &amp; = \mu_i + \delta_t + \beta t_iD_i + U_i
\end{align*}\]</span></p>
<p><span class="math inline">\(\hat{\beta}_{IVFE}\)</span> in the previous regression is the Fixed Effects DID-IV estimator.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-275" class="example"><strong>Example 4.57  </strong></span>Let’s estimate this model in our example.</p>
</div>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="NE.html#cb259-1" tabindex="-1"></a>data.panel <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">1</span>,N),<span class="fu">seq</span>(<span class="dv">1</span>,N)),t,y.pool,Ds.pool,t.D,t.Z,Z.pool)</span>
<span id="cb259-2"><a href="NE.html#cb259-2" tabindex="-1"></a><span class="fu">colnames</span>(data.panel) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Individual&#39;</span>,<span class="st">&#39;time&#39;</span>,<span class="st">&#39;y&#39;</span>,<span class="st">&#39;Ds&#39;</span>,<span class="st">&#39;t.D&#39;</span>,<span class="st">&#39;t.Z&#39;</span>,<span class="st">&#39;Z&#39;</span>)</span>
<span id="cb259-3"><a href="NE.html#cb259-3" tabindex="-1"></a>data.panel <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(data.panel)</span>
<span id="cb259-4"><a href="NE.html#cb259-4" tabindex="-1"></a>reg.iv.did.fe <span class="ot">&lt;-</span> <span class="fu">plm</span>(y <span class="sc">~</span> time <span class="sc">+</span> t.D <span class="sc">|</span> time <span class="sc">+</span> t.Z,<span class="at">data=</span>data.panel,<span class="at">index=</span><span class="fu">c</span>(<span class="st">&#39;Individual&#39;</span>,<span class="st">&#39;time&#39;</span>),<span class="at">model=</span><span class="st">&#39;within&#39;</span>)</span></code></pre></div>
<p>In our illustration, <span class="math inline">\(\hat{\beta}_{IVFE}=\)</span> 0.2.</p>
</div>
<div id="using-the-first-differenced-2sls-did-estimator" class="section level6 hasAnchor" number="4.3.4.1.2.4">
<h6><span class="header-section-number">4.3.4.1.2.4</span> Using the first-differenced 2SLS DID estimator<a href="NE.html#using-the-first-differenced-2sls-did-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>Estimate the following equation with <span class="math inline">\(Z_i\)</span> as an instrument for <span class="math inline">\(D_i\)</span>:</p>
<p><span class="math display">\[\begin{align*}
Y_{i,A}-Y_{i,B} &amp; = \delta + \beta D_i + U_i
\end{align*}\]</span></p>
<p><span class="math inline">\(\hat{\beta}_{IVFD}\)</span> in the previous regression estimated by 2SLS is the First Difference DID estimator.</p>
<div class="example">
<p><span id="exm:unnamed-chunk-276" class="example"><strong>Example 4.58  </strong></span>Let’s see how this works in our example.</p>
</div>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="NE.html#cb260-1" tabindex="-1"></a>reg.iv.did.fd <span class="ot">&lt;-</span> <span class="fu">plm</span>(y <span class="sc">~</span> time <span class="sc">+</span> t.D <span class="sc">|</span> time <span class="sc">+</span> t.Z,<span class="at">data=</span>data.panel,<span class="at">index=</span><span class="fu">c</span>(<span class="st">&#39;Individual&#39;</span>,<span class="st">&#39;time&#39;</span>),<span class="at">model=</span><span class="st">&#39;fd&#39;</span>)</span></code></pre></div>
<p>In our illustration, <span class="math inline">\(\hat{\beta}_{IVFD}=\)</span> 0.2.</p>
</div>
<div id="equivalence-result" class="section level6 hasAnchor" number="4.3.4.1.2.5">
<h6><span class="header-section-number">4.3.4.1.2.5</span> Equivalence result<a href="NE.html#equivalence-result" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="theorem">
<p><span id="thm:DIDIVEq" class="theorem"><strong>Theorem 4.29  (Equivalence of DID-IV Estimators) </strong></span>With panel data and two periods of observation, we have:</p>
<p><span class="math display">\[\begin{align*}
  \hat{\Delta}^{Y}_{WaldDID} &amp; = \hat{\beta}_{2SLS} = \hat{\beta}_{IVFE} = \hat{\beta}_{IVFD}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-156" class="proof"><em>Proof</em>. </span>To do.
Seems pretty straightforward for <span class="math inline">\(IVFD\)</span>.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-278" class="example"><strong>Example 4.59  </strong></span>Let’s finally see how our estimators perform over sampling repetitions.</p>
</div>
<p>Let us study panel data first.</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="NE.html#cb261-1" tabindex="-1"></a>monte.carlo.iv.did.panel <span class="ot">&lt;-</span> <span class="cf">function</span>(s,N,Nstates,param){</span>
<span id="cb261-2"><a href="NE.html#cb261-2" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb261-3"><a href="NE.html#cb261-3" tabindex="-1"></a>  muS <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(Nstates,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb261-4"><a href="NE.html#cb261-4" tabindex="-1"></a>  muS <span class="ot">&lt;-</span> <span class="fu">rep</span>(muS,<span class="at">each=</span>N<span class="sc">/</span>Nstates)</span>
<span id="cb261-5"><a href="NE.html#cb261-5" tabindex="-1"></a>  <span class="co"># I draw an individual fixed effect with the remaining variance</span></span>
<span id="cb261-6"><a href="NE.html#cb261-6" tabindex="-1"></a>  muU <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">*</span><span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb261-7"><a href="NE.html#cb261-7" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> param[<span class="st">&quot;barmu&quot;</span>] <span class="sc">+</span> muS <span class="sc">+</span> muU </span>
<span id="cb261-8"><a href="NE.html#cb261-8" tabindex="-1"></a>  UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb261-9"><a href="NE.html#cb261-9" tabindex="-1"></a>  yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb261-10"><a href="NE.html#cb261-10" tabindex="-1"></a>  YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb261-11"><a href="NE.html#cb261-11" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb261-12"><a href="NE.html#cb261-12" tabindex="-1"></a>  eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb261-13"><a href="NE.html#cb261-13" tabindex="-1"></a>  U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb261-14"><a href="NE.html#cb261-14" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb261-15"><a href="NE.html#cb261-15" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb261-16"><a href="NE.html#cb261-16" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb261-17"><a href="NE.html#cb261-17" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb261-18"><a href="NE.html#cb261-18" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb261-19"><a href="NE.html#cb261-19" tabindex="-1"></a>  <span class="co"># Z=1 if states have lower muS than 0</span></span>
<span id="cb261-20"><a href="NE.html#cb261-20" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(muS<span class="sc">&lt;=</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb261-21"><a href="NE.html#cb261-21" tabindex="-1"></a>  Ds <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>] <span class="sc">&amp;</span> Z<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb261-22"><a href="NE.html#cb261-22" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb261-23"><a href="NE.html#cb261-23" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb261-24"><a href="NE.html#cb261-24" tabindex="-1"></a>  delta.y.iv.did <span class="ot">&lt;-</span> (<span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yB[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Z<span class="sc">==</span><span class="dv">0</span>])))<span class="sc">/</span><span class="fu">mean</span>(Ds[Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb261-25"><a href="NE.html#cb261-25" tabindex="-1"></a>  <span class="fu">return</span>(delta.y.iv.did)</span>
<span id="cb261-26"><a href="NE.html#cb261-26" tabindex="-1"></a>}</span>
<span id="cb261-27"><a href="NE.html#cb261-27" tabindex="-1"></a></span>
<span id="cb261-28"><a href="NE.html#cb261-28" tabindex="-1"></a>simuls.iv.did.panel.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nstates,Nsim,param){</span>
<span id="cb261-29"><a href="NE.html#cb261-29" tabindex="-1"></a>  simuls.iv.did.panel <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.iv.did.panel,<span class="at">N=</span>N,<span class="at">Nstates=</span>Nstates,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb261-30"><a href="NE.html#cb261-30" tabindex="-1"></a>  <span class="fu">colnames</span>(simuls.iv.did.panel) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;DID-IV&#39;</span>)</span>
<span id="cb261-31"><a href="NE.html#cb261-31" tabindex="-1"></a>  <span class="fu">return</span>(simuls.iv.did.panel)</span>
<span id="cb261-32"><a href="NE.html#cb261-32" tabindex="-1"></a>}</span>
<span id="cb261-33"><a href="NE.html#cb261-33" tabindex="-1"></a></span>
<span id="cb261-34"><a href="NE.html#cb261-34" tabindex="-1"></a>sf.simuls.iv.did.panel.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nstates,Nsim,param){</span>
<span id="cb261-35"><a href="NE.html#cb261-35" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span><span class="dv">8</span>)</span>
<span id="cb261-36"><a href="NE.html#cb261-36" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.iv.did.panel,<span class="at">N=</span>N,<span class="at">Nstates=</span>Nstates,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb261-37"><a href="NE.html#cb261-37" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb261-38"><a href="NE.html#cb261-38" tabindex="-1"></a>  <span class="fu">colnames</span>(sim) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;DID-IV&#39;</span>)</span>
<span id="cb261-39"><a href="NE.html#cb261-39" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb261-40"><a href="NE.html#cb261-40" tabindex="-1"></a>}</span>
<span id="cb261-41"><a href="NE.html#cb261-41" tabindex="-1"></a></span>
<span id="cb261-42"><a href="NE.html#cb261-42" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb261-43"><a href="NE.html#cb261-43" tabindex="-1"></a><span class="co">#Nsim &lt;- 10</span></span>
<span id="cb261-44"><a href="NE.html#cb261-44" tabindex="-1"></a>N.sample <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">1000</span>,<span class="dv">10000</span>,<span class="dv">100000</span>)</span>
<span id="cb261-45"><a href="NE.html#cb261-45" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000)</span></span>
<span id="cb261-46"><a href="NE.html#cb261-46" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000)</span></span>
<span id="cb261-47"><a href="NE.html#cb261-47" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100)</span></span>
<span id="cb261-48"><a href="NE.html#cb261-48" tabindex="-1"></a></span>
<span id="cb261-49"><a href="NE.html#cb261-49" tabindex="-1"></a>simuls.iv.did.panel <span class="ot">&lt;-</span> <span class="fu">lapply</span>(N.sample,sf.simuls.iv.did.panel.N,<span class="at">Nstates=</span>Nstates,<span class="at">Nsim=</span>Nsim,<span class="at">param=</span>param)</span>
<span id="cb261-50"><a href="NE.html#cb261-50" tabindex="-1"></a><span class="fu">names</span>(simuls.iv.did.panel) <span class="ot">&lt;-</span> N.sample</span></code></pre></div>
<p>Let us now plot the resulting estimates:</p>
<div class="figure" style="text-align: center">
<img src="STCI_files/figure-html/monte.carlo.hist.iv.did.panel-1.png" alt="Distribution of the DID-IV estimator over replications of panels of different sizes" width="50%" />
<p class="caption">
(#fig:monte.carlo.hist.iv.did.panel)Distribution of the DID-IV estimator over replications of panels of different sizes
</p>
</div>
<p>Let us now look at repeated cross sections data</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="NE.html#cb262-1" tabindex="-1"></a>monte.carlo.iv.did.cross <span class="ot">&lt;-</span> <span class="cf">function</span>(s,N,Nstates,param){</span>
<span id="cb262-2"><a href="NE.html#cb262-2" tabindex="-1"></a>  <span class="fu">set.seed</span>(s)</span>
<span id="cb262-3"><a href="NE.html#cb262-3" tabindex="-1"></a>  N.tot <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>N</span>
<span id="cb262-4"><a href="NE.html#cb262-4" tabindex="-1"></a>  muS <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(Nstates,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb262-5"><a href="NE.html#cb262-5" tabindex="-1"></a>  muS <span class="ot">&lt;-</span> <span class="fu">rep</span>(muS,<span class="at">each=</span>N<span class="sc">/</span>Nstates)</span>
<span id="cb262-6"><a href="NE.html#cb262-6" tabindex="-1"></a>  muS <span class="ot">&lt;-</span> <span class="fu">c</span>(muS,muS)</span>
<span id="cb262-7"><a href="NE.html#cb262-7" tabindex="-1"></a>  <span class="co"># I draw an individual fixed effect with the remaining variance</span></span>
<span id="cb262-8"><a href="NE.html#cb262-8" tabindex="-1"></a>  muU <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N.tot,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>]<span class="sc">*</span><span class="dv">2</span><span class="sc">/</span><span class="dv">3</span>))</span>
<span id="cb262-9"><a href="NE.html#cb262-9" tabindex="-1"></a>  mu <span class="ot">&lt;-</span> param[<span class="st">&quot;barmu&quot;</span>] <span class="sc">+</span> muS <span class="sc">+</span> muU </span>
<span id="cb262-10"><a href="NE.html#cb262-10" tabindex="-1"></a>  UB <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N.tot,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb262-11"><a href="NE.html#cb262-11" tabindex="-1"></a>  yB <span class="ot">&lt;-</span> mu <span class="sc">+</span> UB </span>
<span id="cb262-12"><a href="NE.html#cb262-12" tabindex="-1"></a>  YB <span class="ot">&lt;-</span> <span class="fu">exp</span>(yB)</span>
<span id="cb262-13"><a href="NE.html#cb262-13" tabindex="-1"></a>  epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N.tot,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb262-14"><a href="NE.html#cb262-14" tabindex="-1"></a>  eta<span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N.tot,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]))</span>
<span id="cb262-15"><a href="NE.html#cb262-15" tabindex="-1"></a>  U0 <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>UB <span class="sc">+</span> epsilon</span>
<span id="cb262-16"><a href="NE.html#cb262-16" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> mu <span class="sc">+</span>  U0 <span class="sc">+</span> param[<span class="st">&quot;delta&quot;</span>]</span>
<span id="cb262-17"><a href="NE.html#cb262-17" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> param[<span class="st">&quot;baralpha&quot;</span>]<span class="sc">+</span>  param[<span class="st">&quot;theta&quot;</span>]<span class="sc">*</span>mu <span class="sc">+</span> eta</span>
<span id="cb262-18"><a href="NE.html#cb262-18" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y0<span class="sc">+</span>alpha</span>
<span id="cb262-19"><a href="NE.html#cb262-19" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y0)</span>
<span id="cb262-20"><a href="NE.html#cb262-20" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(y1)</span>
<span id="cb262-21"><a href="NE.html#cb262-21" tabindex="-1"></a>  <span class="co"># Z=1 if states have lower muS than 0</span></span>
<span id="cb262-22"><a href="NE.html#cb262-22" tabindex="-1"></a>  Z <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(muS<span class="sc">&lt;=</span><span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb262-23"><a href="NE.html#cb262-23" tabindex="-1"></a>  Ds <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(YB<span class="sc">&lt;=</span>param[<span class="st">&quot;barY&quot;</span>] <span class="sc">&amp;</span> Z<span class="sc">==</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb262-24"><a href="NE.html#cb262-24" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y1<span class="sc">*</span>Ds<span class="sc">+</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb262-25"><a href="NE.html#cb262-25" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> Y1<span class="sc">*</span>Ds<span class="sc">+</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Ds)</span>
<span id="cb262-26"><a href="NE.html#cb262-26" tabindex="-1"></a>  <span class="co"># first cross section: 1-N</span></span>
<span id="cb262-27"><a href="NE.html#cb262-27" tabindex="-1"></a>  first <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>,N)</span>
<span id="cb262-28"><a href="NE.html#cb262-28" tabindex="-1"></a>  <span class="co"># second cross section: 1001-2000</span></span>
<span id="cb262-29"><a href="NE.html#cb262-29" tabindex="-1"></a>  second <span class="ot">&lt;-</span> <span class="fu">seq</span>(N<span class="sc">+</span><span class="dv">1</span>,N.tot)</span>
<span id="cb262-30"><a href="NE.html#cb262-30" tabindex="-1"></a>  <span class="co"># repeated cross section DID-IV</span></span>
<span id="cb262-31"><a href="NE.html#cb262-31" tabindex="-1"></a>  delta.y.iv.did.cross <span class="ot">&lt;-</span> (<span class="fu">mean</span>(y[second][Z[second]<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y[second][Z[second]<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span>(<span class="fu">mean</span>(yB[first][Z[first]<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[first][Z[first]<span class="sc">==</span><span class="dv">0</span>])))<span class="sc">/</span><span class="fu">mean</span>(Ds[second][Z[second]<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb262-32"><a href="NE.html#cb262-32" tabindex="-1"></a>  <span class="fu">return</span>(delta.y.iv.did.cross)</span>
<span id="cb262-33"><a href="NE.html#cb262-33" tabindex="-1"></a>}</span>
<span id="cb262-34"><a href="NE.html#cb262-34" tabindex="-1"></a></span>
<span id="cb262-35"><a href="NE.html#cb262-35" tabindex="-1"></a>simuls.iv.did.cross.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nstates,Nsim,param){</span>
<span id="cb262-36"><a href="NE.html#cb262-36" tabindex="-1"></a>  simuls.iv.did.cross <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.iv.did.cross,<span class="at">N=</span>N,<span class="at">Nstates=</span>Nstates,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb262-37"><a href="NE.html#cb262-37" tabindex="-1"></a>  <span class="fu">colnames</span>(simuls.iv.did.cross) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;DID-IV&#39;</span>)</span>
<span id="cb262-38"><a href="NE.html#cb262-38" tabindex="-1"></a>  <span class="fu">return</span>(simuls.iv.did.cross)</span>
<span id="cb262-39"><a href="NE.html#cb262-39" tabindex="-1"></a>}</span>
<span id="cb262-40"><a href="NE.html#cb262-40" tabindex="-1"></a></span>
<span id="cb262-41"><a href="NE.html#cb262-41" tabindex="-1"></a>sf.simuls.iv.did.cross.N <span class="ot">&lt;-</span> <span class="cf">function</span>(N,Nstates,Nsim,param){</span>
<span id="cb262-42"><a href="NE.html#cb262-42" tabindex="-1"></a>  <span class="fu">sfInit</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>,<span class="at">cpus=</span><span class="dv">8</span>)</span>
<span id="cb262-43"><a href="NE.html#cb262-43" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">unlist</span>(<span class="fu">sfLapply</span>(<span class="dv">1</span><span class="sc">:</span>Nsim,monte.carlo.iv.did.cross,<span class="at">N=</span>N,<span class="at">Nstates=</span>Nstates,<span class="at">param=</span>param)),<span class="at">nrow=</span>Nsim,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb262-44"><a href="NE.html#cb262-44" tabindex="-1"></a>  <span class="fu">sfStop</span>()</span>
<span id="cb262-45"><a href="NE.html#cb262-45" tabindex="-1"></a>  <span class="fu">colnames</span>(sim) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;DID-IV&#39;</span>)</span>
<span id="cb262-46"><a href="NE.html#cb262-46" tabindex="-1"></a>  <span class="fu">return</span>(sim)</span>
<span id="cb262-47"><a href="NE.html#cb262-47" tabindex="-1"></a>}</span>
<span id="cb262-48"><a href="NE.html#cb262-48" tabindex="-1"></a></span>
<span id="cb262-49"><a href="NE.html#cb262-49" tabindex="-1"></a>Nsim <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb262-50"><a href="NE.html#cb262-50" tabindex="-1"></a><span class="co">#Nsim &lt;- 10</span></span>
<span id="cb262-51"><a href="NE.html#cb262-51" tabindex="-1"></a>N.sample <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">1000</span>,<span class="dv">10000</span>,<span class="dv">100000</span>)</span>
<span id="cb262-52"><a href="NE.html#cb262-52" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000,10000)</span></span>
<span id="cb262-53"><a href="NE.html#cb262-53" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100,1000)</span></span>
<span id="cb262-54"><a href="NE.html#cb262-54" tabindex="-1"></a><span class="co">#N.sample &lt;- c(100)</span></span>
<span id="cb262-55"><a href="NE.html#cb262-55" tabindex="-1"></a></span>
<span id="cb262-56"><a href="NE.html#cb262-56" tabindex="-1"></a>simuls.iv.did.cross <span class="ot">&lt;-</span> <span class="fu">lapply</span>(N.sample,sf.simuls.iv.did.cross.N,<span class="at">Nstates=</span>Nstates,<span class="at">Nsim=</span>Nsim,<span class="at">param=</span>param)</span>
<span id="cb262-57"><a href="NE.html#cb262-57" tabindex="-1"></a><span class="fu">names</span>(simuls.iv.did.cross) <span class="ot">&lt;-</span> N.sample</span></code></pre></div>
Let us now plot the result:
<div class="figure" style="text-align: center">
<img src="STCI_files/figure-html/monte.carlo.hist.iv.did.cross.sections-1.png" alt="Distribution of the DID-IV estimator over replications of repeated cross sections of different sizes" width="50%" />
<p class="caption">
(#fig:monte.carlo.hist.iv.did.cross.sections)Distribution of the DID-IV estimator over replications of repeated cross sections of different sizes
</p>
</div>
</div>
</div>
<div id="estimation-of-sampling-noise-4" class="section level5 hasAnchor" number="4.3.4.1.3">
<h5><span class="header-section-number">4.3.4.1.3</span> Estimation of sampling noise<a href="NE.html#estimation-of-sampling-noise-4" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>What we need is to derive an estimator for the asymptotic variance of the DID-IV estimator in repeated cross sections and in panel data.</p>
<div id="estimating-sampling-noise-with-did-iv-in-repeated-cross-sections" class="section level6 hasAnchor" number="4.3.4.1.3.1">
<h6><span class="header-section-number">4.3.4.1.3.1</span> Estimating sampling noise with DID-IV in repeated cross sections<a href="NE.html#estimating-sampling-noise-with-did-iv-in-repeated-cross-sections" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="theorem">
<p><span id="thm:asympnoiseDIDIVCross" class="theorem"><strong>Theorem 4.30  (Asymptotic Distribution of DID-IV in Repeated Cross Sections) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a>, <a href="NE.html#hyp:iidDIDCross">4.17</a> and <a href="#hyp:finitevarDIDCross"><strong>??</strong></a>, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}(\hat\Delta^Y_{DIDIV}-\Delta^Y_TT) &amp; \stackrel{d}{\rightarrow}
                             \mathcal{N}\left(0,\right).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-157" class="proof"><em>Proof</em>. </span>To do.</p>
</div>
</div>
<div id="estimating-sampling-noise-with-did-iv-in-panel-data" class="section level6 hasAnchor" number="4.3.4.1.3.2">
<h6><span class="header-section-number">4.3.4.1.3.2</span> Estimating sampling noise with DID-IV in panel data<a href="NE.html#estimating-sampling-noise-with-did-iv-in-panel-data" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<div class="theorem">
<p><span id="thm:asympnoiseDIDIVPanel" class="theorem"><strong>Theorem 4.31  (Asymptotic Distribution of DID-IV in Panel Data) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a>, <a href="NE.html#hyp:iidDID">4.15</a> and <a href="NE.html#hyp:finitevarDID">4.16</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
\sqrt{N}(\hat\Delta^Y_{DIDIV}-\Delta^Y_TT) &amp; \stackrel{d}{\rightarrow}
                             \mathcal{N}\left(0,\right).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-158" class="proof"><em>Proof</em>. </span>To do.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-281" class="example"><strong>Example 4.60  </strong></span>Let’s see how estimators of sampling noise perform in practice.</p>
</div>
<p>In panel data, true 99% sampling noise (from the simulations) is 0.25.
99% sampling noise estimated using default FE standard errors is 0.22`.
99% sampling noise estimated using heteroskedasticity robust FE standard errors is 0.22.</p>
<p>In repeated cross sections, true 99% sampling noise (from the simulations) is 1.16.
99% sampling noise estimated using default OLS standard errors is 0.24.
99% sampling noise estimated using heteroskedasticity robust OLS standard errors is 0.25.</p>
</div>
</div>
</div>
<div id="did-iv-with-a-weak-first-stage" class="section level4 hasAnchor" number="4.3.4.2">
<h4><span class="header-section-number">4.3.4.2</span> DID-IV with a weak first stage<a href="NE.html#did-iv-with-a-weak-first-stage" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>With a weak first stage, DID-IV has positive probability of receiving the treatment in the Before period and in the group with <span class="math inline">\(Z_i=0\)</span>.
The main requirement of the weak first stage DID-IV is that the probability of receiving the treatment increases more over time in the group with <span class="math inline">\(Z_i=1\)</span> compared to what happens in the group with <span class="math inline">\(Z_i=0\)</span>.
We are going to codify this assumption next and see which effects can be identified under which supplementary assumptions, then talk about estimation and estimation of sampling noise.</p>
<div id="identification-9" class="section level5 hasAnchor" number="4.3.4.2.1">
<h5><span class="header-section-number">4.3.4.2.1</span> Identification<a href="NE.html#identification-9" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We are going to examine several sets of assumptions under which we can try to recover some average treatment effect of the treatment in a DID-IV design with a weak first stage.
As you’ll see, there is not much hope unfortunately.</p>
<div id="identification-under-weak-first-stage-did-iv" class="section level6 hasAnchor" number="4.3.4.2.1.1">
<h6><span class="header-section-number">4.3.4.2.1.1</span> Identification under weak first stage DID-IV<a href="NE.html#identification-under-weak-first-stage-did-iv" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The main assumption on a weak first stage DID-IV is as follows:</p>
<div class="hypothesis">
<p><span id="hyp:WeakFirstStageDIDIV" class="hypothesis"><strong>Hypothesis 4.31  (Weak First Stage) </strong></span>The treatment is available in both periods <span class="math inline">\(B\)</span> and <span class="math inline">\(A\)</span>, but its takeover increases disproportionately among those with <span class="math inline">\(Z_i=1\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\Pr(D_{i,A}=1|Z_i=1)&amp; -\Pr(D_{i,B}=1|Z_i=1)\\
&amp; &gt;\Pr(D_{i,A}=1|Z_i=0)-\Pr(D_{i,B}=1|Z_i=0).
\end{align*}\]</span></p>
</div>
<div class="remark">
<p><span id="unlabeled-div-159" class="remark"><em>Remark</em>. </span>A great example of Assumption <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a> is <a href="https://www.jstor.org/stable/2677813">Esther Duflo’s paper in education expansion in Indonesia</a>.
In this paper, the states that invest in education are the ones for which education levels were the lowest initially.
And the states with lower investments in education (<span class="math inline">\(Z_i=0\)</span>) nevertheless saw some progress in education levels over time.
But, the states with higher investments (<span class="math inline">\(Z_i=1\)</span>) saw stronger improvements and caught up.
Also, all states had some education in the baseline period.
This is characteristic of a weak first stage DID-IV design.</p>
</div>
<div class="example">
<p><span id="exm:unnamed-chunk-283" class="example"><strong>Example 4.61  </strong></span>Let us now see how we can model this in our example.</p>
</div>
<p>We are going to introduce an eligibility rule that changes over time as a function of state and district fixed effects:</p>
<p><span class="math display">\[\begin{align*}
  \mu_i &amp; = \mu^S_i + \mu^d_i + \mu^U_i + \bar{\mu} \\
  \mu^S_i &amp; \sim\mathcal{N}(0,\frac{1}{3}\sigma_{\mu}^2)\\
  \mu^d_i &amp; \sim\mathcal{N}(0,\frac{1}{3}\sigma_{\mu}^2)\\
  \mu^U_i &amp; \sim\mathcal{N}(0,\frac{1}{3}\sigma_{\mu}^2)\\
  E_{i,B} &amp; =
    \begin{cases}
      1 &amp; \text{ if } \mu^d_i\leq -0.5 \land Z_i=1 \\
      1 &amp; \text{ if } \mu^d_i\leq 0.25\land Z_i=0
    \end{cases}\\
  E_{i,A} &amp; =
    \begin{cases}
      1 &amp; \text{ if } \mu^d_i\leq 0 \land Z_i=1 \\
      1 &amp; \text{ if } \mu^d_i\leq 0.85\land Z_i=0
    \end{cases}\\
  D_{i,t} &amp; = \uns{y_{i,BB}\leq\bar{y} \land E_{i,t}=1}.
\end{align*}\]</span></p>
<p>The rest of the model is as follows, with a third period <span class="math inline">\(BB\)</span> that is Before Before:</p>
<p><span class="math display">\[\begin{align*}
y^0_{i,A} &amp; =\mu_i+\delta+U_{i,A}^0 \\
y_{i,A}^1 &amp; =\mu_i(1+\theta)+\bar{\alpha}+\delta+U_{i,A}^0+\eta_i \\
y_{i,BB} &amp; =\mu_i+U_{i,BB} \\
U_{i,B}^0 &amp; =\rho U_{i,BB}+\epsilon_{i,B} \\
U_{i,A}^0 &amp; =\rho U_{i,B}+\epsilon_{i,A} \\
U_{i,BB} &amp; \sim\mathcal{N}(0,\sigma^2_{U})\\
\epsilon_{i,t} &amp; \sim\mathcal{N}(0,\sigma^2_{\epsilon})\\
\eta_i &amp; \sim\mathcal{N}(0,\sigma^2_{\eta})
\end{align*}\]</span></p>
<p>Here is the simulation:</p>
<p>Let us now see how the model generates a time varying proportion of participants:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:GraphIllusDIDIIVWeak"></span>
<img src="STCI_files/figure-html/GraphIllusDIDIIVWeak-1.png" alt="Illustration of the DID-IV assumptions: Weak First Stage" width="50%" />
<p class="caption">
Figure 4.49: Illustration of the DID-IV assumptions: Weak First Stage
</p>
</div>
<p>We thus see that the change over time in treatment uptake is equal to 0.16 when <span class="math inline">\(Z_i=1\)</span> and to 0.02 when <span class="math inline">\(Z_i=0\)</span>.</p>
</div>
<div id="identification-with-independent-treatment-effects" class="section level6 hasAnchor" number="4.3.4.2.1.2">
<h6><span class="header-section-number">4.3.4.2.1.2</span> Identification with independent treatment effects<a href="NE.html#identification-with-independent-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>Under constant treatment effects, the classical Wald DID estimator still identifies the effect of the treatment on the treated:</p>
<div class="hypothesis">
<p><span id="hyp:IndTE" class="hypothesis"><strong>Hypothesis 4.32  (Independent Treatment Effects) </strong></span>The average effect of the treatment on the treated is independent of <span class="math inline">\(Z_i\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\esp{Y_{i,t}^1-Y_{i,t}^0|D_i=1,Z_i=1} &amp; = \esp{Y_{i,t}^1-Y_{i,t}^0|D_i=1,Z_i=0}.
\end{align*}\]</span></p>
</div>
<p>Under Assumption <a href="NE.html#hyp:IndTE">4.32</a>, we can show that the Wald DID estimator recovers the average effect of the treatment on the treated:</p>
<div class="theorem">
<p><span id="thm:IdentTTDIDIVWeakFSIndTE" class="theorem"><strong>Theorem 4.32  (Indentification of TT with DID-IV, a Weak First Stage and Independent Treatment Effects) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a>, <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a> and <a href="NE.html#hyp:IndTE">4.32</a>, TT is identified by the Wald-DID estimator:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{WaldDID} &amp; = \Delta^{Y_A}_{TT}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-160" class="proof"><em>Proof</em>. </span>We have, for <span class="math inline">\(t\in\left\{ A,B \right\}\)</span> and <span class="math inline">\(d\in\left\{ 0,1 \right\}\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\esp{Y_{i,t}|Z_i=d} &amp; = \esp{Y^0_{i,t}|Z_i=d} + \esp{Y^1_{i,t}-Y^0_{i,t}|D_{i,t}=1,Z_i=d}\Pr(D_{i,t}=1|Z_i=d)
\end{align*}\]</span></p>
<p>Under Assumption <a href="NE.html#hyp:IndTE">4.32</a>, <span class="math inline">\(\esp{Y^1_{i,t}-Y^0_{i,t}|D_{i,t}=1,Z_i=d}=\Delta^Y_{TT}\)</span>.
As a consequence, the numerator of the Wald-DID estimator writes as follows:</p>
<p><span class="math display">\[\begin{align*}
\esp{Y_{i,A}|Z_i=1} &amp; -\esp{Y_{i,A}|Z_i=0}-(\esp{Y_{i,B}|Z_i=1}-\esp{Y_{i,B}|Z_i=0}) \\
                    &amp; = \esp{Y^0_{i,A}-Y^0_{i,B}|Z_i=1}+ \Delta^Y_{TT}\left(\Pr(D_{i,A}=1|Z_i=1)-\Pr(D_{i,B}=1|Z_i=1)\right)\\
                    &amp; \phantom{=} -\esp{Y^0_{i,A}-Y^0_{i,B}|Z_i=0}-\Delta^Y_{TT}\left(\Pr(D_{i,A}=1|Z_i=0)-\Pr(D_{i,B}=1|Z_i=0)\right).
\end{align*}\]</span></p>
<p>Using the Assumption <a href="NE.html#hyp:ParallelTrendsIV">4.29</a> and dividing by the denominator of the Wald-DID estimator (which is non null under Assumption <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a>) yields the result.</p>
</div>
</div>
<div id="identification-under-constant-treatment-effects-over-time" class="section level6 hasAnchor" number="4.3.4.2.1.3">
<h6><span class="header-section-number">4.3.4.2.1.3</span> Identification under constant treatment effects over time<a href="NE.html#identification-under-constant-treatment-effects-over-time" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p>The problem with DID-IV stems when treatment effects are not independent from <span class="math inline">\(Z_i\)</span> conditional on <span class="math inline">\(D_i=1\)</span>.
We can get an inkling of the problem at hand by deriving the Wald estimator without Assumption <a href="NE.html#hyp:IndTE">4.32</a>, but under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a> and <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a>.
Let’s get some notation first.
We denote <span class="math inline">\(\Delta^D_{DID}=\Pr(D_{i,A}=1|Z_i=1)-\Pr(D_{i,B}=1|Z_i=1)-(\Pr(D_{i,A}=1|Z_i=0)-\Pr(D_{i,B}=1|Z_i=0))\)</span>, the denominator of the Wald estimator.
We also denote <span class="math inline">\(p^{AB}_{11}=\Pr(D_{i,A}=1|Z_i=1)-\Pr(D_{i,B}=1|Z_i=1)\)</span> and <span class="math inline">\(p^{AB}_{10}=\Pr(D_{i,A}=1|Z_i=0)-\Pr(D_{i,B}=1|Z_i=0)\)</span>.
We finally denote <span class="math inline">\(\Delta^{Y_A}_{TT_1}=\esp{Y_{i,t}^1-Y_{i,t}^0|D_i=1,Z_i=1}\)</span> and <span class="math inline">\(\Delta^{Y_A}_{TT_0}=\esp{Y_{i,t}^1-Y_{i,t}^0|D_i=1,Z_i=0}\)</span>.
We can now prove the following corollary to Theorem <a href="NE.html#thm:IdentTTDIDIVWeakFSIndTE">4.32</a>:</p>
<div class="corollary">
<p><span id="cor:IdentTTDIDIVWeakFS" class="corollary"><strong>Corollary 4.4  (DID-Wald Estimator Without Independent Treatment Effects) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a> and <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a>, the DID-Wald estimator is a weighted average of treatment effects with possibly negative weights:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{WaldDID} &amp; = \Delta^{Y_A}_{TT_1}\frac{p^{AB}_{11}}{\Delta^D_{DID}}-\Delta^{Y_A}_{TT_0}\frac{p^{AB}_{10}}{\Delta^D_{DID}}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-161" class="proof"><em>Proof</em>. </span>Using the proof of Theorem <a href="NE.html#thm:IdentTTDIDIVWeakFSIndTE">4.32</a> proves the result.</p>
</div>
<p>Corollary <a href="NE.html#cor:IdentTTDIDIVWeakFS">4.4</a> shows that, when the proportion of treated in the group with <span class="math inline">\(Z_i=0\)</span> increases over time, the impact of the treatment on those with <span class="math inline">\(Z_i=0\)</span> enters negatively in the Wald-DID estimator.
It is thus possible that positive treatment effects for every unit in the population generates a negative Wald-DID estimator.</p>
<p>We can even get a deeper understanding of what’s going on with the DID-IV estimator if we follow the classic treatment of this issue by <a href="https://academic.oup.com/restud/article-abstract/85/2/999/4096388?redirectedFrom=fulltext">de Chaisemartin and d’Haultfoeuille (2015)</a>.
Let us first define four types of individuals:</p>
<ul>
<li><em>always takers</em>: the individuals which have <span class="math inline">\(D_{i,A}=D_{i,B}=1\)</span>, which we denote <span class="math inline">\(T_i=at\)</span>,</li>
<li><em>never takers</em>: the individuals which have <span class="math inline">\(D_{i,A}=D_{i,B}=0\)</span>, which we denote <span class="math inline">\(T_i=nt\)</span>,</li>
<li><em>switchers</em>: the individuals which have <span class="math inline">\(D_{i,A}=1\)</span> and <span class="math inline">\(D_{i,B}=0\)</span>, which we denote <span class="math inline">\(T_i=s\)</span>,</li>
<li><em>anti-switchers</em>: the individuals which have <span class="math inline">\(D_{i,A}=0\)</span> and <span class="math inline">\(D_{i,B}=1\)</span>, which we denote <span class="math inline">\(T_i=as\)</span>.</li>
</ul>
<p>For now, we are going to assume away anti-switchers for simplicity.<br />
Assumption <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a> amounts to assuming that <span class="math inline">\(\Pr(T_i=s|Z_i=1) &gt; \Pr(T_i=s|Z_i=0)\)</span>.
We can now prove the following theorem:</p>
<div class="theorem">
<p><span id="thm:IdentTTDIDIVWeakFSDecomp" class="theorem"><strong>Theorem 4.33  (Numerator of the DID-Wald Estimator Without Independent Treatment Effects and Without Anti-Switchers) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a> and <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a>, and in the absence of anti-switchers (<span class="math inline">\(\Pr(T_i=as)=0\)</span>), the numerator of the DID-Wald estimator can be written as follows:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{WaldDID}\Delta^D_{DID} &amp; = \esp{Y^1_{i,A}-Y^1_{i,B}|T_i=at,Z_i=1}\Pr(T_i=at|Z_i=1)\\
                                  &amp; \phantom{=} +\esp{Y^0_{i,A}-Y^0_{i,B}|T_i=nt,Z_i=1}\Pr(T_i=nt|Z_i=1)\\
                                  &amp; \phantom{=} +\esp{Y^1_{i,A}-Y^0_{i,B}|T_i=s,Z_i=1}\Pr(T_i=s|Z_i=1)\\
                                  &amp; \phantom{=} -(\esp{Y^1_{i,A}-Y^1_{i,B}|T_i=at,Z_i=0}\Pr(T_i=at|Z_i=0))\\
                                  &amp; \phantom{=} -(\esp{Y^0_{i,A}-Y^0_{i,B}|T_i=nt,Z_i=0}\Pr(T_i=nt|Z_i=0))\\
                                  &amp; \phantom{=} -(\esp{Y^1_{i,A}-Y^0_{i,B}|T_i=s,Z_i=0}\Pr(T_i=s|Z_i=0)).
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-162" class="proof"><em>Proof</em>. </span>The result follows from the formula for the DID-Wald estimator and the fact that <span class="math inline">\(T_i\)</span> is a partition of the population.</p>
</div>
<p>So, the numerator of the Wald-DID estimator is a combination of the changes in outcomes over time of each type in the group with <span class="math inline">\(Z_i=1\)</span> minus the changes the outcomes of each type in the group with <span class="math inline">\(Z_i=0\)</span>.
The units with the same type are not the same in each group defined by <span class="math inline">\(Z_i\)</span> so that their proportions differ and their changes in outcome differ as well.
One useful simplification can still happen using Assumption <a href="NE.html#hyp:ParallelTrendsIV">4.29</a>.
Let <span class="math inline">\(\Delta^{Y_A}_{\text{type},z}=\esp{Y_{i,t}^1-Y_{i,t}^0|T_i=\text{type},Z_i=z}\)</span>, for <span class="math inline">\(\text{type}\in\left\{at,nt,s\right\}\)</span> and <span class="math inline">\(z\in\left\{0,1\right\}\)</span>.
Let also <span class="math inline">\(p_{\text{type},z}=\Pr(T_i=\text{type}|Z_i=z)\)</span>.
The following corollary proves that:</p>
<div class="corollary">
<p><span id="cor:IdentTTDIDIVWeakFSDecompGeneral" class="corollary"><strong>Corollary 4.5  (DID-Wald Estimator Without Independent Treatment Effects) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a> and <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a>, the DID-Wald estimator can be decomposed as follows:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{WaldDID}\Delta^D_{DID} &amp; = \Delta^{Y_A}_{s,1}p_{s,1}-\Delta^{Y_A}_{s,0}p_{s,0}+(\Delta^{Y_A}_{at,1}-\Delta^{Y_B}_{at,1})p_{at,1}-(\Delta^{Y_A}_{at,0}-\Delta^{Y_B}_{at,0})p_{at,0}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-163" class="proof"><em>Proof</em>. </span>Using Theorem <a href="NE.html#thm:IdentTTDIDIVWeakFSDecomp">4.33</a>, we can now add and subtract <span class="math inline">\(\esp{Y^0_{i,A}-Y^0_{i,B}|T_i=at,Z_i=1}\Pr(T_i=at|Z_i=1)\)</span>, <span class="math inline">\(\esp{Y^0_{i,A}-Y^0_{i,B}|T_i=at,Z_i=0}\Pr(T_i=at|Z_i=0)\)</span>, <span class="math inline">\(\esp{Y^0_{i,A}|T_i=s,Z_i=1}\Pr(T_i=s|Z_i=1)\)</span> and <span class="math inline">\(\esp{Y^0_{i,A}|T_i=s,Z_i=0}\Pr(T_i=s|Z_i=0)\)</span> to the right hand side of the expression, and use the fact that <span class="math inline">\(T_i\)</span> is a partition and then invoke Assumption <a href="NE.html#hyp:ParallelTrendsIV">4.29</a> to obtain the result.</p>
</div>
<p>Corollary <a href="NE.html#cor:IdentTTDIDIVWeakFSDecompGeneral">4.5</a> shows that the Wald-DID estimator is a weighted average of the effect of the treatment on the switchers in the group with <span class="math inline">\(Z_i=1\)</span>, minus the effect of the treatment on the switchers in the group with <span class="math inline">\(Z_i=0\)</span>, and the change in the treatment effect over time among always takers in the group with <span class="math inline">\(Z_i=1\)</span> minus the change in treatment effect over time among always takers in the group with <span class="math inline">\(Z_i=0\)</span>.
So, one way to get rid of the issue is to assume constant treatment effects over time for both groups of always takers.
Let’s make this assumption and see where it takes us:</p>
<div class="hypothesis">
<p><span id="hyp:ConsdTETime" class="hypothesis"><strong>Hypothesis 4.33  (Constant Treatment Effects Over Time) </strong></span>We assume that average effect of the treatment on the always takers is independent of time, conditional on <span class="math inline">\(Z_i\)</span>: <span class="math inline">\(\forall z \in \left\{0,1\right\}\)</span>:</p>
<p><span class="math display">\[\begin{align*}
\Delta^{Y_A}_{at,z}&amp; = \Delta^{Y_B}_{at,z}
\end{align*}\]</span></p>
</div>
<p>We can now prove the following Theorem:</p>
<div class="theorem">
<p><span id="thm:IdentTTDIDIVWeakFSCstTETime" class="theorem"><strong>Theorem 4.34  (DID-Wald Estimator With Constant Treatment Effects Over Time) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:ParallelTrendsIV">4.29</a>, <a href="NE.html#hyp:WeakFirstStageDIDIV">4.31</a> and <a href="NE.html#hyp:ConsdTETime">4.33</a>, the DID-Wald estimator can be decomposed as follows:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{WaldDID} &amp; =
  \begin{cases}
  \Delta^{Y_A}_{s,1} \text{ if }p_{s,0}=0\\
  \alpha\Delta^{Y_A}_{s,1}-(1-\alpha)\Delta^{Y_A}_{s,0}\text{, }0&lt;\alpha&lt;1 \text{ if } p_{s,0}&lt;0\\
  \alpha\Delta^{Y_A}_{s,1}-(1-\alpha)\Delta^{Y_A}_{s,0}\text{, }\alpha&gt;1 \text{ if } p_{s,0}&gt;0.
  \end{cases}
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-164" class="proof"><em>Proof</em>. </span>Using Corollary <a href="NE.html#cor:IdentTTDIDIVWeakFSDecompGeneral">4.5</a> and the fact that <span class="math inline">\(\Delta^D_{DID}=p_{s,1}-p_{s,0}\)</span> proves the result.</p>
</div>
<p>Note that Theorem <a href="NE.html#thm:IdentTTDIDIVWeakFSCstTETime">4.34</a> still does not get rid of the issue of negative weights in the case when the proportion of treated units increases in the control group.</p>
</div>
<div id="identification-under-parallel-trends-by-type" class="section level6 hasAnchor" number="4.3.4.2.1.4">
<h6><span class="header-section-number">4.3.4.2.1.4</span> Identification under parallel trends by type<a href="NE.html#identification-under-parallel-trends-by-type" class="anchor-section" aria-label="Anchor link to header"></a></h6>
<p><a href="https://academic.oup.com/restud/article-abstract/85/2/999/4096388?redirectedFrom=fulltext">de Chaisemartin and d’Haultfoeuille (2015)</a> propose an alternative to Assumption <a href="NE.html#hyp:ConsdTETime">4.33</a>.
This approach requires that there are no shifters in the group with <span class="math inline">\(Z_i=0\)</span>, and thus that the proportion of treated units does not change over time in this group.
This is thus very close to a DID-IV design with Strong First Stage.
Finally, their approach requires an alternative parallel trends assumption over groups.
Let is state all of these assumptions:</p>
<div class="hypothesis">
<p><span id="hyp:StrongWeakFirstStageDIDIV" class="hypothesis"><strong>Hypothesis 4.34  (Strong Weak First Stage) </strong></span>We assume that the proportion of treated stays constant in the group with <span class="math inline">\(Z_i=0\)</span>: <span class="math inline">\(p_{s,0}=0\)</span>.</p>
</div>
<div class="hypothesis">
<p><span id="hyp:StrongParallelTrends" class="hypothesis"><strong>Hypothesis 4.35  (Conditional Parallel Trends) </strong></span>We assume that the trends in potential outcomes among groups defined by <span class="math inline">\(D_{i,B}\)</span> does not depend on <span class="math inline">\(Z_i\)</span>:</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y^d_{i,A}-Y^d_{i,B}|D_{i,B}=d,Z_i=1} &amp; = \esp{Y^d_{i,A}-Y^d_{i,B}|D_{i,B}=d,Z_i=0}.
\end{align*}\]</span></p>
</div>
<div class="remark">
<p><span id="unlabeled-div-165" class="remark"><em>Remark</em>. </span>Assumption <a href="NE.html#hyp:StrongParallelTrends">4.35</a> is very strong.
It assumes away part of the time-varying selection bias that the instrumental variable procedure is trying to undo.</p>
</div>
<p><a href="https://academic.oup.com/restud/article-abstract/85/2/999/4096388?redirectedFrom=fulltext">de Chaisemartin and d’Haultfoeuille (2015)</a> prove that a <span class="math inline">\(Wald_{TC}\)</span>, a <em>time-corrected</em> Wald estimator, is able to recover the average effect of the treatment on the shifters under these assumptions:</p>
<div class="theorem">
<p><span id="thm:IdentTTTCWald" class="theorem"><strong>Theorem 4.35  (Time-corrected Wald Estimator With Conditional Parallel Trends) </strong></span>Under Assumptions <a href="NE.html#hyp:NoTreatmentFirst">4.12</a>, <a href="NE.html#hyp:NoAnticipationEffects">4.13</a>, <a href="NE.html#hyp:StrongWeakFirstStageDIDIV">4.34</a> and <a href="NE.html#hyp:StrongParallelTrends">4.35</a>, the <em>time-corrected</em> Wald estimator identifies the average effect of the treatment on the shifters:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{Wald_{TC}} &amp; = \Delta^{Y_A}_{s,1},
\end{align*}\]</span></p>
<p>with:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{Wald_{TC}} &amp; = \frac{\esp{Y_{i,A}|Z_i=1}-\esp{Y_{i,B}+D_{i,B}\delta_1+(1-D_{i,B})\delta_0|Z_i=1}}{\Pr(D_{i,A}=1|Z_i=1)-\Pr(D_{i,B}=1|Z_i=1)}\\
  \delta_1 &amp; = \esp{Y_{i,A}-Y_{i,B}|D_{i,B}=1,Z_i=0}\\
  \delta_0 &amp; = \esp{Y_{i,A}-Y_{i,B}|D_{i,B}=0,Z_i=0}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-166" class="proof"><em>Proof</em>. </span>Note that:</p>
<p><span class="math display">\[\begin{align*}
\esp{Y_{i,A}|Z_i=1} &amp; = \esp{Y_{i,A}|D_{i,B}=1,Z_i=1}\Pr(D_{i,B}=1|Z_i=1)\\
                    &amp; \phantom{=}+\esp{Y_{i,A}|D_{i,B}=0,Z_i=1}\Pr(D_{i,B}=0|Z_i=1)\\
\esp{Y_{i,B}|Z_i=1} &amp; = \esp{Y_{i,B}|D_{i,B}=1,Z_i=1}\Pr(D_{i,B}=1|Z_i=1)\\
                    &amp; \phantom{=}+\esp{Y_{i,B}|D_{i,B}=0,Z_i=1}\Pr(D_{i,B}=0|Z_i=1)\\
\esp{D_{i,B}\delta_1|Z_i=1} &amp; = \esp{Y_{i,A}-Y_{i,B}|D_{i,B}=1,Z_i=0}\Pr(D_{i,B}=1|Z_i=1)\\
\esp{(1-D_{i,B})\delta_0|Z_i=1} &amp; = \esp{Y_{i,A}-Y_{i,B}|D_{i,B}=0,Z_i=0}\Pr(D_{i,B}=0|Z_i=1).
\end{align*}\]</span></p>
<p>With <span class="math inline">\(D_{i,B}=1\)</span>, we know that <span class="math inline">\(Y_{i,A}=Y^1_{i,A}\)</span> and <span class="math inline">\(Y_{i,B}=Y^1_{i,B}\)</span>.
As a consequence, using Assumption <a href="NE.html#hyp:StrongParallelTrends">4.35</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{Wald_{TC}} &amp; = \frac{(\esp{Y_{i,A}-Y_{i,B}|D_{i,B}=0,Z_i=1}-\esp{Y_{i,A}-Y_{i,B}|D_{i,B}=0,Z_i=0})\Pr(D_{i,B}=0|Z_i=1)}{\Pr(D_{i,A}=1|Z_i=1)-\Pr(D_{i,B}=1|Z_i=1)}.
\end{align*}\]</span></p>
<p>Using the fact that, conditional on <span class="math inline">\(Z_i=1\)</span>, the population with <span class="math inline">\(D_{i,B}=0\)</span> can be split totally into <span class="math inline">\(T_i=s\)</span> and <span class="math inline">\(T_i=nt\)</span>, we can write the following equality (after adding and subtracting <span class="math inline">\(\esp{Y^0_{i,A}|T_i=s,Z_i=1}\)</span>):</p>
<p><span class="math display">\[\begin{align*}
  \esp{Y_{i,A}-Y_{i,B}|D_{i,B}=0,Z_i=1} &amp; = \Delta^{Y_A}_{s,1}\Pr(T_i=s|D_{i,B}=0,Z_i=1)+\esp{Y^0_{i,A}-Y^0_{i,B}|D_{i,B}=0,Z_i=1}.
\end{align*}\]</span></p>
<p>Using Assumption <a href="NE.html#hyp:StrongWeakFirstStageDIDIV">4.34</a>, with <span class="math inline">\(D_{i,B}=0\)</span> and <span class="math inline">\(Z_i=0\)</span>, we know that <span class="math inline">\(Y_{i,A}=Y^0_{i,A}\)</span> and <span class="math inline">\(Y_{i,B}=Y^0_{i,B}\)</span>.
Using Assumption <a href="NE.html#hyp:StrongParallelTrends">4.35</a> again, we have:</p>
<p><span class="math display">\[\begin{align*}
  \Delta^Y_{Wald_{TC}} &amp; = \frac{\Delta^{Y_A}_{s,1}\Pr(T_i=s|D_{i,B}=0,Z_i=1)\Pr(D_{i,B}=0|Z_i=1)}{\Pr(D_{i,A}=1|Z_i=1)-\Pr(D_{i,B}=1|Z_i=1)}.
\end{align*}\]</span></p>
<p>Note that <span class="math inline">\(T_i=s\Rightarrow D_{i,B}=0|Z_i=1\)</span>, so that <span class="math inline">\(\Pr(T_i=s|D_{i,B}=0,Z_i=1)\Pr(D_{i,B}=0|Z_i=1)=\Pr(T_i=s|Z_i=1)\)</span>.
Under Assumption <a href="NE.html#hyp:StrongWeakFirstStageDIDIV">4.34</a>, <span class="math inline">\(\Pr(T_i=s|Z_i=1)=\Pr(D_{i,A}=1|Z_i=1)-\Pr(D_{i,B}=1|Z_i=1)\)</span>, which proves the result.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-167" class="remark"><em>Remark</em>. </span>The problem with Theorem <a href="NE.html#thm:IdentTTDIDIVWeakFSCstTETime">4.34</a> is that it relies on Assumption <a href="NE.html#hyp:StrongWeakFirstStageDIDIV">4.34</a>: there are no changes in the proportion of units receiving the treatment in the group with <span class="math inline">\(Z_i=0\)</span>.
This assumption might very often be untrue.
Fortunately, <a href="https://academic.oup.com/restud/article-abstract/85/2/999/4096388?redirectedFrom=fulltext">de Chaisemartin and d’Haultfoeuille (2015)</a> show that you can relax that assumption and still bound the treatment effect if your outcome is bounded.
We will present this estimator in Section <a href="#bounds"><strong>??</strong></a>.</p>
</div>
</div>
</div>
<div id="estimation-5" class="section level5 hasAnchor" number="4.3.4.2.2">
<h5><span class="header-section-number">4.3.4.2.2</span> Estimation<a href="NE.html#estimation-5" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We are going to look at how to estimate the Time-Corrected Wald estimator of <a href="https://academic.oup.com/restud/article-abstract/85/2/999/4096388?redirectedFrom=fulltext">de Chaisemartin and d’Haultfoeuille (2015)</a>.
The formula for the estimator is pretty straightforward:</p>
<p><span class="math display">\[\begin{align*}
  \hat\Delta^Y_{Wald_{TC}} &amp; = \frac{\frac{\sum_{i=1}^NY_{i,A}Z_i}{\sum_{i=1}^NZ_i}-\frac{\sum_{i=1}^NY_{i,B}Z_i}{\sum_{i=1}^NZ_i}-\hat\delta_1\frac{\sum_{i=1}^ND_{i,B}(1-Z_i)}{\sum_{i=1}^N(1-Z_i)}-\hat\delta_0\frac{\sum_{i=1}^N(1-D_{i,B})(1-Z_i)}{\sum_{i=1}^N(1-Z_i)}}{\frac{\sum_{i=1}^ND_{i,A}Z_i}{\sum_{i=1}^NZ_i}-\frac{\sum_{i=1}^ND_{i,B}Z_i}{\sum_{i=1}^NZ_i}}\\
  \hat\delta_1 &amp; = \frac{\sum_{i=1}^NY_{i,A}D_{i,B}(1-Z_i)}{\sum_{i=1}^ND_{i,B}(1-Z_i)}-\frac{\sum_{i=1}^NY_{i,B}D_{i,B}(1-Z_i)}{\sum_{i=1}^ND_{i,B}(1-Z_i)}\\
  \hat\delta_0 &amp; = \frac{\sum_{i=1}^NY_{i,A}(1-D_{i,B})(1-Z_i)}{\sum_{i=1}^N(1-D_{i,B})(1-Z_i)}-\frac{\sum_{i=1}^NY_{i,B}(1-D_{i,B})(1-Z_i)}{\sum_{i=1}^N(1-D_{i,B})(1-Z_i)}.
\end{align*}\]</span></p>
<div class="example">
<p><span id="exm:unnamed-chunk-292" class="example"><strong>Example 4.62  </strong></span>Let us now look at how the Wald-TC estimator and the more traditional Wald-DID estimator work in our example.
Let’s compute them both:</p>
</div>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="NE.html#cb263-1" tabindex="-1"></a><span class="co"># Wald DID estimator</span></span>
<span id="cb263-2"><a href="NE.html#cb263-2" tabindex="-1"></a><span class="co"># changes in mean outcomes over time</span></span>
<span id="cb263-3"><a href="NE.html#cb263-3" tabindex="-1"></a>DeltaYZ1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb263-4"><a href="NE.html#cb263-4" tabindex="-1"></a>DeltaYZ0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y[Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-5"><a href="NE.html#cb263-5" tabindex="-1"></a>DeltaDZ1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(DsA[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(DsB[Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb263-6"><a href="NE.html#cb263-6" tabindex="-1"></a>DeltaDZ0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(DsA[Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(DsB[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-7"><a href="NE.html#cb263-7" tabindex="-1"></a>WaldDID <span class="ot">&lt;-</span> (DeltaYZ1<span class="sc">-</span>DeltaYZ0)<span class="sc">/</span>(DeltaDZ1<span class="sc">-</span>DeltaDZ0)</span>
<span id="cb263-8"><a href="NE.html#cb263-8" tabindex="-1"></a></span>
<span id="cb263-9"><a href="NE.html#cb263-9" tabindex="-1"></a><span class="co"># Wald TC estimator</span></span>
<span id="cb263-10"><a href="NE.html#cb263-10" tabindex="-1"></a>DeltaYDZ10 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-11"><a href="NE.html#cb263-11" tabindex="-1"></a>DeltaYDZ00 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(yB[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-12"><a href="NE.html#cb263-12" tabindex="-1"></a>MeanDBZ0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(DsB[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-13"><a href="NE.html#cb263-13" tabindex="-1"></a>WaldTC <span class="ot">&lt;-</span> (DeltaYZ1<span class="sc">-</span>MeanDBZ0<span class="sc">*</span>DeltaYDZ10<span class="sc">-</span>(<span class="dv">1</span><span class="sc">-</span>MeanDBZ0)<span class="sc">*</span>DeltaYDZ00)<span class="sc">/</span>(DeltaDZ1)</span>
<span id="cb263-14"><a href="NE.html#cb263-14" tabindex="-1"></a></span>
<span id="cb263-15"><a href="NE.html#cb263-15" tabindex="-1"></a><span class="co"># true effect on switchers in the sample</span></span>
<span id="cb263-16"><a href="NE.html#cb263-16" tabindex="-1"></a>DeltaYAs1Sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1A[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y0A[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb263-17"><a href="NE.html#cb263-17" tabindex="-1"></a>DeltaYAs0Sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1A[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(y0A[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-18"><a href="NE.html#cb263-18" tabindex="-1"></a>DeltaYBs1Sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1B[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y0B[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb263-19"><a href="NE.html#cb263-19" tabindex="-1"></a>DeltaYBs0Sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1B[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(y0B[DsB<span class="sc">==</span><span class="dv">0</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-20"><a href="NE.html#cb263-20" tabindex="-1"></a>DeltaYAat1Sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1A[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y0A[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb263-21"><a href="NE.html#cb263-21" tabindex="-1"></a>DeltaYAat0Sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1A[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(y0A[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-22"><a href="NE.html#cb263-22" tabindex="-1"></a>DeltaYBat1Sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1B[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y0B[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb263-23"><a href="NE.html#cb263-23" tabindex="-1"></a>DeltaYBat0Sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1B[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(y0B[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-24"><a href="NE.html#cb263-24" tabindex="-1"></a></span>
<span id="cb263-25"><a href="NE.html#cb263-25" tabindex="-1"></a><span class="co"># checking PTA</span></span>
<span id="cb263-26"><a href="NE.html#cb263-26" tabindex="-1"></a>DeltaY0BAZ1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y0A[Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y0B[Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb263-27"><a href="NE.html#cb263-27" tabindex="-1"></a>DeltaY0BAZ0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y0A[Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(y0B[Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-28"><a href="NE.html#cb263-28" tabindex="-1"></a>DeltaY1atBAZ1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1A[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])<span class="sc">-</span><span class="fu">mean</span>(y1B[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">1</span>])</span>
<span id="cb263-29"><a href="NE.html#cb263-29" tabindex="-1"></a>DeltaY1atBAZ0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y1A[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])<span class="sc">-</span><span class="fu">mean</span>(y1B[DsB<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>DsA<span class="sc">==</span><span class="dv">1</span><span class="sc">&amp;</span>Z<span class="sc">==</span><span class="dv">0</span>])</span>
<span id="cb263-30"><a href="NE.html#cb263-30" tabindex="-1"></a></span>
<span id="cb263-31"><a href="NE.html#cb263-31" tabindex="-1"></a><span class="co"># alpha</span></span>
<span id="cb263-32"><a href="NE.html#cb263-32" tabindex="-1"></a>alpha.shifters <span class="ot">&lt;-</span> DeltaDZ1<span class="sc">/</span>(DeltaDZ1<span class="sc">-</span>DeltaDZ0)</span>
<span id="cb263-33"><a href="NE.html#cb263-33" tabindex="-1"></a></span>
<span id="cb263-34"><a href="NE.html#cb263-34" tabindex="-1"></a><span class="co"># weighted average of shifters impacts</span></span>
<span id="cb263-35"><a href="NE.html#cb263-35" tabindex="-1"></a>DeltaYAsSample <span class="ot">&lt;-</span> DeltaYAs1Sample<span class="sc">*</span>alpha.shifters<span class="sc">+</span>(<span class="dv">1</span><span class="sc">-</span>alpha.shifters)<span class="sc">*</span>DeltaYAs0Sample</span></code></pre></div>
<p>The Wald-DID estimator in our example is equal to 0.47 while the true average effect of the treatment on the shifters in the group with <span class="math inline">\(Z_i=1\)</span> is equal to 0.2 in the sample.
The Time-corrected Wald estimator is equal to 0.4.
It is hard to say why these estimators are too big in our example.
The Wald-DID estimator should not be too biased since Assumption <a href="NE.html#hyp:ConsdTETime">4.33</a> holds in our dataset, and the bias stemming from the failure of Assumption <a href="NE.html#hyp:StrongWeakFirstStageDIDIV">4.34</a> is not too severe.
Indeed, using Theorem <a href="NE.html#thm:IdentTTDIDIVWeakFSCstTETime">4.34</a>, we know that Wald-DID estimator should converge to the weighted average of the effect on shifters, which is equal to 0.22 in the sample.
As always with Wald estimators, I suspect that the denominator is slightly too small, and that the proportion of switchers is underestimated.</p>
</div>
</div>
</div>
<div id="difference-in-differences-with-continuous-treatment-variables-and-staggered-adoption" class="section level3 hasAnchor" number="4.3.5">
<h3><span class="header-section-number">4.3.5</span> Difference In Differences with Continuous Treatment Variables and Staggered Adoption<a href="NE.html#difference-in-differences-with-continuous-treatment-variables-and-staggered-adoption" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Another case that might appear is when the treatment variable is continuous (for example a share between zero and one) and its changes are staggered over time.
In that case, a <a href="https://ssrn.com/abstract=3731856">recent contribution by Clement de Chaisemartin and Xavier d’Haultfoeuille</a> clarifies what can be estimated and under which assumptions.
In this section, we are going to look at the identification abd estimation of these effects as proposed by <a href="https://ssrn.com/abstract=3731856">de Chaisemartin and d’Haultfoeuille</a>.</p>
<div id="identification-10" class="section level4 hasAnchor" number="4.3.5.1">
<h4><span class="header-section-number">4.3.5.1</span> Identification<a href="NE.html#identification-10" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Maybe the toughest part of addressing the issue of continuous treatments with staggered adoption is the definition of the treatment parameters.
Indeed, we now have a potentially infinite set of treatment levels, compounded by a large set of treatment dates.
Much of the contribution of Clement and Xavier is to get the definition of the parameter of interest right.
They actually propose two sets of definitions: a normalized and a non-normalized average treatment effect.
Let us start with the normalized one.</p>
<p>Before defining what the treatment parameters are, we need to define our setup, which is going to be richer than the ones we have used so far.
The whole setup in Xavier and Clement’s approach is predicated on having access to a panel of <span class="math inline">\(G\)</span> groups observed over <span class="math inline">\(T\)</span> periods of time.
The groups can be built by aggregating a set of individual level panel data or repeated cross-section observations at some more aggregate level (like municipality or state).
Each individual unit can also form its own group, as long as it observed in a panel.
<span class="math inline">\(D_{g,t}\)</span> denotes the continuous level of treatment of group <span class="math inline">\(g\)</span> at period <span class="math inline">\(t\)</span>.
The treatment is assumed to be nonnegative for simplicity.
Let <span class="math inline">\(\mathbf{D}_g=\left(D_{g,1},\dots,D_{g,T}\right)\)</span> be the set of treatments that group <span class="math inline">\(g\)</span> experiences over time, and <span class="math inline">\(\mathbf{D}=\left(\mathbf{D}_{1},\dots,\mathbf{D}_{G}\right)\)</span> the vector of all treatment paths for each group over time.
<span class="math inline">\(\mathcal{D}\)</span> is the support of <span class="math inline">\(\mathbf{D}_g\)</span>.
Potential outcomes are going to depend on the whole vector of past and future treatments: <span class="math inline">\(Y_{g,t}(d_1,\dots,d_T)\)</span> is the potential outcome observed for group <span class="math inline">\(g\)</span> at time <span class="math inline">\(t\)</span> if <span class="math inline">\(\mathbf{D}_g=(d_1,\dots,d_T)\)</span>.
The observed outcome for group <span class="math inline">\(g\)</span> at time <span class="math inline">\(t\)</span> is <span class="math inline">\(Y_{g,t}=Y_{g,t}(\mathbf{D}_g)\)</span>.</p>
<p>Xavier and Clement require several assmptions on the design.
To define the first one, we need to define <span class="math inline">\(F_g=\min\left\{ t:t\geq 2, D_{g,t}\neq D_{g,t-1}\right\}\)</span>, the the first date at which treatment changes.
The convention is that <span class="math inline">\(F_{g}=T+1\)</span> for the group for which treatment status never changes.</p>
<div class="hypothesis">
<p><span id="hyp:Variation" class="hypothesis"><strong>Hypothesis 4.36  (Variation in treatment exposure) </strong></span>We assume that the design is such that: <span class="math inline">\(\exists (g,g&#39;)\)</span> such that <span class="math inline">\(D_{g,1}=D_{g&#39;,1}\)</span> and <span class="math inline">\(F_g\neq F_{g&#39;}\)</span>.</p>
</div>
<p>Assumption <a href="NE.html#hyp:Variation">4.36</a> imposes that there exists groups with similar levels of first period treatment intensity, but which get treated at different periods.
To this assumption, the authors add two main ones:</p>
<div class="hypothesis">
<p><span id="hyp:NoAnticipationContinuous" class="hypothesis"><strong>Hypothesis 4.37  (No Anticipation with Continuous and Staggered Treatments) </strong></span>We assume that <span class="math inline">\(\forall g\)</span>, <span class="math inline">\(\forall (d_1,\dots,d_T)\in\mathcal{D}\)</span>, <span class="math inline">\(Y_{g,t}(d_1,\dots,d_T)=Y_{g,t}(d_1,\dots,d_t)\)</span>.</p>
</div>
<p>For the last assumption, let <span class="math inline">\(\mathcal{D}_1^r=\left\{d:\exists(g,g&#39;)\in\left\{1,\dots,G\right\}^2:D_{g,1}=D_{g&#39;,1}, F_g\neq F_{g&#39;}\right\}\)</span> be the set of first period treatment levels for which there are at least two groups having that value and different fates of treatment intake.
Let also <span class="math inline">\(\mathbf{D}_{g,1,k}\)</span> be the <span class="math inline">\(1\times k\)</span> vector repeating <span class="math inline">\(D_{g,1}\)</span>.
Finally, let <span class="math inline">\(Y_{g,t}(\mathbf{D}_{g,1,t})\)</span> be the potential outcome of group <span class="math inline">\(g\)</span> at time <span class="math inline">\(t\)</span> had it kept its initial treatment level at all periods, or ``status quo’’ outcome.</p>
<div class="hypothesis">
<p><span id="hyp:PTAContinuous" class="hypothesis"><strong>Hypothesis 4.38  (Parallel Trends with Continuous and Staggered Treatments) </strong></span>We assume that <span class="math inline">\(\forall g,g&#39;\)</span>, if <span class="math inline">\(D_{g,1}=D_{g&#39;,1}\in\mathcal{D}_1^r\)</span>, then, <span class="math inline">\(\forall t\geq 2\)</span>,</p>
<p><span class="math display">\[\begin{align*}
    \esp{Y_{g,t}(\mathbf{D}_{g,1,t})-Y_{g,t-1}(\mathbf{D}_{g&#39;,1,t-1})|\mathbf{D}} &amp; =  \esp{Y_{g&#39;,t}(\mathbf{D}_{g&#39;,1,t})-Y_{g,t-1}(\mathbf{D}_{g&#39;,1,t-1})|\mathbf{D}}.
\end{align*}\]</span></p>
</div>
<p>Following Assumption <a href="NE.html#hyp:PTAContinuous">4.38</a>, the status quo outcomes of groups with the same period 1 treatment level would have followed parallel trends.</p>
<div id="identifying-non-normalized-treatment-effects" class="section level5 hasAnchor" number="4.3.5.1.1">
<h5><span class="header-section-number">4.3.5.1.1</span> Identifying non normalized treatment effects<a href="NE.html#identifying-non-normalized-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We are now equipped to define some target treatment parameters.
Let us define <span class="math inline">\(T_g=\max_{g&#39;:D_{g&#39;,1}=D_{g,1}}F_{g&#39;}-1\)</span>, the last period in the dataset where a group with the same initial treatment intensity as <span class="math inline">\(g\)</span> remains at the status quo treatment level.
For any <span class="math inline">\(g\)</span> such that <span class="math inline">\(F_g\leq T_g\)</span>, and for any <span class="math inline">\(l\in\left\{1,\dots,T_g-F_g+1\right\}\)</span>, the average treatment effect of the treatment sequence on group <span class="math inline">\(g\)</span> after <span class="math inline">\(l\)</span> periods under treatment is equal to:</p>
<p><span class="math display">\[\begin{align*}
    \delta_{g,l} &amp; = \esp{Y_{g,F_g-1+l}-Y_{g,F_g-1+l}(\mathbf{D}_{g,1,F_g-1+l})|\mathbf{D}}.
\end{align*}\]</span></p>
<p>We are going to identify this target parameter <span class="math inline">\(\delta_{g,l}\)</span> using a generalized DID estimator based on the <span class="math inline">\(N^g_{F_g-1+l}\)</span> groups that stayed in the status quo treatment until <span class="math inline">\(F_g-1+l\)</span> (with <span class="math inline">\(N^g_t=\#\left\{g&#39;:D_{g&#39;,1}=D_{g,1},F_{g&#39;,t}&gt;t\right\}\)</span>, and <span class="math inline">\(\#\left\{A\right\}\)</span> the cardinal of <span class="math inline">\(A\)</span>):</p>
<p><span class="math display">\[\begin{align*}
    DID_{g,l} &amp; = Y_{g,F_g-1+l}-Y_{g,F_g-1}-\frac{1}{N^g_{F_g-1+l}}\sum_{g&#39;:D_{g&#39;,1}=D_{g,1},F_{g&#39;}&gt;F_g-1+l}\left(Y_{g&#39;,F_g&#39;-1+l}-Y_{g&#39;,F_g-1}\right).
\end{align*}\]</span></p>
<p>We are now able to state the first identification result:</p>
<div class="theorem">
<p><span id="thm:IdentContinuousOne" class="theorem"><strong>Theorem 4.36  (Identification in DID with Continuous and Staggered Treatments (one group)) </strong></span>Under Assumptions <a href="NE.html#hyp:Variation">4.36</a>, <a href="NE.html#hyp:NoAnticipationContinuous">4.37</a> and <a href="NE.html#hyp:PTAContinuous">4.38</a>, we have, <span class="math inline">\(\forall (g,l)\)</span> such that <span class="math inline">\(1\leq l \leq T_g-F_g+1\)</span>:</p>
<p><span class="math display">\[\begin{align*}
    \delta_{g,l} &amp; = \esp{DID_{g,l}|\mathbf{D}}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-168" class="proof"><em>Proof</em>. </span>See <a href="https://ssrn.com/abstract=3731856">de Chaisemartin and d’Haultfoeuille</a>.</p>
</div>
<p>What remains to be done is to aggregate over all possible groups.
In order to do that, we need to distinguish between groups for which treatment increases and those for which treatment decreases, and we need to assume away groups for which treatment increases at some date and then decreases later on:</p>
<div class="hypothesis">
<p><span id="hyp:NoCrossing" class="hypothesis"><strong>Hypothesis 4.39  (No Crossing Condition) </strong></span>We assume that the design is such that: <span class="math inline">\(\forall g\in\left\{1,\dots,G\right\}\)</span>, either <span class="math inline">\(D_{g,t}\geq D_{g,1}\)</span> <span class="math inline">\(\forall t\)</span> or <span class="math inline">\(D_{g,t}\leq D_{g,1}\)</span> <span class="math inline">\(\forall t\)</span>.</p>
</div>
<p>We also denote <span class="math inline">\(L=\max{g}(T_g-F_g+1)\)</span> the maximum number of periods for which we can estimate the treatment effect; <span class="math inline">\(N_l=\#\left\{g:F_g-1+l\leq T_g\right\}\)</span> the number of groups for which the effect of being <span class="math inline">\(l\)</span> periods under treatment can be estimated; and <span class="math inline">\(S_g=\uns{D_{g,F_g}&gt;D_{g,1}}-\uns{D_{g,F_g}&lt;D_{g,1}}\)</span> taking value <span class="math inline">\(1\)</span> when treatment increases over time and <span class="math inline">\(-1\)</span> when treatment decreases over time, we can define the weighted average effect after <span class="math inline">\(l\)</span> periods under treatment as:</p>
<p><span class="math display">\[\begin{align*}
    \delta_{l} &amp; = \frac{1}{N_{l}}\sum_{g:F_g-1+l\leq T_g}S_g\delta_{g,l}.
\end{align*}\]</span></p>
<p>We can now prove the following theorem:</p>
<div class="theorem">
<p><span id="thm:IdentContinuousl" class="theorem"><strong>Theorem 4.37  (Identification in DID with Continuous and Staggered Treatments) </strong></span>Under Assumptions <a href="NE.html#hyp:Variation">4.36</a>, <a href="NE.html#hyp:NoAnticipationContinuous">4.37</a>, <a href="NE.html#hyp:PTAContinuous">4.38</a> and <a href="NE.html#hyp:NoCrossing">4.39</a>, we have, <span class="math inline">\(\forall l\)</span> such that <span class="math inline">\(1\leq l \leq L\)</span>:</p>
<p><span class="math display">\[\begin{align*}
    \delta_{l} &amp; = \frac{1}{N_{l}}\sum_{g:F_g-1+l\leq T_g}S_gDID_{g,l}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-169" class="proof"><em>Proof</em>. </span>The result follows directly from the application of Theorem <a href="NE.html#thm:IdentContinuousOne">4.36</a>.</p>
</div>
</div>
<div id="identifying-normalized-treatment-effects" class="section level5 hasAnchor" number="4.3.5.1.2">
<h5><span class="header-section-number">4.3.5.1.2</span> Identifying normalized treatment effects<a href="NE.html#identifying-normalized-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Theorems <a href="NE.html#thm:IdentContinuousOne">4.36</a> and <a href="NE.html#thm:IdentContinuousl">4.37</a> identify the average actual vs status quo effect across groups.
Their event study profile is going to depend on the precise distribution of treatment sequences among treated groups.
One way to try to normalize that average treatment effect estimate is by combining all estimates as a proportion of the cumulative treatment intensity they have received.
One way to achieve that is to define the following cumulative treatment intensity variable, for any <span class="math inline">\(g\)</span> such that <span class="math inline">\(F_g\leq T_g\)</span> and any <span class="math inline">\(l\in\left\{1,\dots,T_g-F_g+1\right\}\)</span>:</p>
<p><span class="math display">\[\begin{align*}
    \delta^D_{g,l} &amp; = \sum_{k=1}^{l}\left(D_{g,F_{g+k-1}}-D_{g,1}\right).
\end{align*}\]</span></p>
<p>We can then define the normalized treatment effect for group <span class="math inline">\(g\)</span> after <span class="math inline">\(l\)</span> periods under the treatment as follows:</p>
<p><span class="math display">\[\begin{align*}
    \delta^n_{g,l} &amp; = \frac{\delta_{g,l}}{\delta^D_{g,l}}.
\end{align*}\]</span></p>
<p>This effect is identified:</p>
<div class="theorem">
<p><span id="thm:IdentContinuousOneNormalized" class="theorem"><strong>Theorem 4.38  (Identification of Normalized Effects in DID with Continuous and Staggered Treatments (one group)) </strong></span>Under Assumptions <a href="NE.html#hyp:Variation">4.36</a>, <a href="NE.html#hyp:NoAnticipationContinuous">4.37</a> and <a href="NE.html#hyp:PTAContinuous">4.38</a>, we have, <span class="math inline">\(\forall (g,l)\)</span> such that <span class="math inline">\(1\leq l \leq T_g-F_g+1\)</span>:</p>
<p><span class="math display">\[\begin{align*}
    \delta^n_{g,l} &amp; = \esp{\frac{DID_{g,l}}{\delta^D_{g,l}}|\mathbf{D}}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-170" class="proof"><em>Proof</em>. </span>The result follows directly from the application of Theorem <a href="NE.html#thm:IdentContinuousOne">4.36</a>, and from the fact that <span class="math inline">\(\delta^D_{g,l}\)</span> is a constant conditional on <span class="math inline">\(\mathbf{D}\)</span>.</p>
</div>
<p>Now, we would like to aggregate all of the effects on each group together to obtain one normalized effect after <span class="math inline">\(l\)</span> periods under treatment.
We are going to weigh all groups by their share of the total change treatment intensity at date <span class="math inline">\(l\)</span>: <span class="math inline">\(\delta^D_l=\frac{1}{N_l}\sum_{g:F_g-1+l\leq T_g}\left|\delta^D_{g,l}\right|\)</span>.
As a consequence, we use as normalized treatment effect after <span class="math inline">\(l\)</span> periods under treatment:</p>
<p><span class="math display">\[\begin{align*}
    \delta^n_{l} &amp; =\frac{1}{N_l}\sum_{g:F_g-1+l\leq T_g}\frac{\left|\delta^D_{g,l}\right|}{\delta^D_{l}}\delta^n_{g,l}.
\end{align*}\]</span></p>
<p>Following all the results from this section, we have the folowing theorem:</p>
<div class="theorem">
<p><span id="thm:IdentContinuouslNormalized" class="theorem"><strong>Theorem 4.39  (Identification of Normalized Effects in DID with Continuous and Staggered Treatments) </strong></span>Under Assumptions <a href="NE.html#hyp:Variation">4.36</a>, <a href="NE.html#hyp:NoAnticipationContinuous">4.37</a>, <a href="NE.html#hyp:PTAContinuous">4.38</a> and <a href="NE.html#hyp:NoCrossing">4.39</a>, we have, <span class="math inline">\(\forall l\)</span> such that <span class="math inline">\(1\leq l \leq L\)</span>:</p>
<p><span class="math display">\[\begin{align*}
    \delta^n_{l} &amp; = \esp{\frac{1}{N_{l}}\sum_{g:F_g-1+l\leq T_g}\frac{\left|\delta^D_{g,l}\right|}{\delta^D_{l}}\frac{DID_{g,l}}{\delta^D_{g,l}}|\mathbf{D}}= \esp{DID^n_l|\mathbf{D}}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-171" class="proof"><em>Proof</em>. </span>The result follows directly from the application of Theorem <a href="NE.html#thm:IdentContinuousOne">4.36</a>, and from the fact that <span class="math inline">\(\delta^D_{g,l}\)</span> and <span class="math inline">\(\delta^D_{l}\)</span> are constant conditional on <span class="math inline">\(\mathbf{D}\)</span>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-172" class="remark"><em>Remark</em>. </span>Note that <span class="math inline">\(\delta^n_l=\frac{\delta_l}{\delta^D_l}\)</span> and <span class="math inline">\(DID^n_l=\frac{DID_l}{\delta^D_l}\)</span>.</p>
</div>
</div>
<div id="identifying-aggregate-treatment-effects" class="section level5 hasAnchor" number="4.3.5.1.3">
<h5><span class="header-section-number">4.3.5.1.3</span> Identifying aggregate treatment effects<a href="NE.html#identifying-aggregate-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>One way to summarize all the effects of the cumulated treatments is to add all the effects on all the treatment groups at every time periods, and to divide the result by the cumulated treatment intensity, in order to obtain an average effect per unit of treatment intensity:</p>
<p><span class="math display">\[\begin{align*}
  \delta &amp; = \frac{\sum_{g:F_g\leq T_g}\sum_{l=1}^{T_g-F_g+1}\delta_{g,l}}{\sum_{g:F_g\leq T_g}\sum_{l=1}^{T_g-F_g+1}(D_{g,F_g-l+1}-D_{g,1})}.
\end{align*}\]</span></p>
<p>We can easily show that this parameter is identified under our usual conditions:</p>
<div class="theorem">
<p><span id="thm:IdentContinuouslAggregated" class="theorem"><strong>Theorem 4.40  (Identification of the Aggregated Treatment Effect in DID with Continuous and Staggered Treatments) </strong></span>Under Assumptions <a href="NE.html#hyp:Variation">4.36</a>, <a href="NE.html#hyp:NoAnticipationContinuous">4.37</a>, <a href="NE.html#hyp:PTAContinuous">4.38</a> and <a href="NE.html#hyp:NoCrossing">4.39</a>, we have:</p>
<p><span class="math display">\[\begin{align*}
    \delta &amp; = \esp{\frac{\sum_{g:F_g\leq T_g}\sum_{l=1}^{T_g-F_g+1}DID_{g,l}}{\sum_{g:F_g\leq T_g}\sum_{l=1}^{T_g-F_g+1}(D_{g,F_g-l+1}-D_{g,1})}|\mathbf{D}}= \esp{\hat{\delta}|\mathbf{D}}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-173" class="proof"><em>Proof</em>. </span>The result follows directly from the application of Theorem <a href="NE.html#thm:IdentContinuousOne">4.36</a>, and from the fact that <span class="math inline">\(\delta^D_{g,l}\)</span> and <span class="math inline">\(\delta^D_{l}\)</span> are constant conditional on <span class="math inline">\(\mathbf{D}\)</span>.</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-174" class="remark"><em>Remark</em>. </span><a href="https://ssrn.com/abstract=3731856">de Chaisemartin and d’Haultfoeuille</a> give an interpretation of this parameter in a cost-benefit framework.</p>
</div>
</div>
</div>
<div id="estimation-6" class="section level4 hasAnchor" number="4.3.5.2">
<h4><span class="header-section-number">4.3.5.2</span> Estimation<a href="NE.html#estimation-6" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We could estimate the treatment effect directly using the formula for <span class="math inline">\(DID_{g,l}\)</span> used in Theorem <a href="NE.html#thm:IdentContinuousOne">4.36</a>.
One difficulty is that it can become cumbersome to compute one at a time.
It also does not enable us to estimate all cross sectional correlations between coefficients, and therefore does not enable a simple estimation of the precision of the combined set of parameter values.
One way to solve this problem is to use the <strong>stacked first difference</strong> estimator we have used in Section <a href="NE.html#stackedFD">4.3.3.3.3</a>.
The advantage of this approach is that it gives immediately rise to the whole set of coefficients which can be estimated using the classical <span class="math inline">\(2\times 2\)</span> DID comparisons, across with an estimate of their covariance matrix, thanks to the use of the <strong>Leung</strong> estimator (but this is for next section).
Finally, one can also use the packages created by <a href="https://ssrn.com/abstract=3731856">de Chaisemartin and d’Haultfoeuille</a>, <code>DIDmultiplegt</code> and <code>DIDmultiplegtDYN</code>.
Let’s see how this works, by first generating some data with continuous treatment levels.</p>
<p>Let us write a model compatible with this setting, choose a parameterization and generate the data.</p>
<p><span class="math display">\[\begin{align*}
y^1_{i,t} &amp; = y_{i,t}^0+\bar{\alpha}_t+\sum_{d}(\bar{\alpha}_{t,d}+\theta_d\mu_i)\uns{D_{i,d}=1}I_{i,t}+\eta_{i,t} \\
y^0_{i,t} &amp; = \mu_i+\delta_t+U^0_{i,t} \\
U^0_{i,t} &amp; = \rho U^0_{i,t-1}+\epsilon_{i,t} \\
D_{i,t}   &amp; = \uns{y^0_{i,1} + \xi_t+ V_i\leq\bar{y}} \\
I_{i,t}   &amp; = F_{\nu}(\bar{y}-y^0_{i,t} - \xi_t- V_i-\iota)\\
V_i   &amp; = \gamma(\mu_i-\bar{\mu}) + \omega_{i,1} \\
U^0_{i,1} &amp; \sim\mathcal{N}(0,\sigma^2_{U}) \\
\epsilon_{i,t} &amp; \sim\mathcal{N}(0,\sigma^2_{\epsilon})\\
\nu_{i,t} &amp; \sim\mathcal{N}(0,\sigma^2_{\nu})
(\eta_{i,t},\omega_{i,t}) &amp; \sim\mathcal{N}(0,0,\sigma^2_{\eta},\sigma^2_{\omega},\rho_{\eta,\omega})\\
\end{align*}\]</span></p>
<p>I am going to parameterize the <span class="math inline">\(\bar{\alpha}_{t,d}\)</span> process as in Section <a href="NE.html#DIDStaggered">4.3.3</a>: <span class="math inline">\(\bar{\alpha}_{t,d}=\bar\chi_d+\kappa_d(t-d)\uns{t\geq d}\)</span>.
<span class="math inline">\(I_{i,t}\)</span> is treatment intensity.
Let us now choose some parameter values:</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="NE.html#cb264-1" tabindex="-1"></a>param <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">8</span>,.<span class="dv">5</span>,.<span class="dv">28</span>,<span class="dv">1500</span>,<span class="fl">0.9</span>,</span>
<span id="cb264-2"><a href="NE.html#cb264-2" tabindex="-1"></a>           <span class="fl">0.01</span>,<span class="fl">0.01</span>,<span class="fl">0.01</span>,<span class="fl">0.01</span>,</span>
<span id="cb264-3"><a href="NE.html#cb264-3" tabindex="-1"></a>           <span class="fl">0.05</span>,<span class="fl">0.05</span>,</span>
<span id="cb264-4"><a href="NE.html#cb264-4" tabindex="-1"></a>           <span class="dv">0</span>,<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span>,</span>
<span id="cb264-5"><a href="NE.html#cb264-5" tabindex="-1"></a>           <span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.15</span>,<span class="fl">0.2</span>,</span>
<span id="cb264-6"><a href="NE.html#cb264-6" tabindex="-1"></a>           <span class="fl">0.25</span>,<span class="fl">0.1</span>,<span class="fl">0.05</span>,<span class="dv">0</span>,</span>
<span id="cb264-7"><a href="NE.html#cb264-7" tabindex="-1"></a>           <span class="fl">1.5</span>,<span class="fl">1.25</span>,<span class="dv">1</span>,<span class="fl">0.75</span>,</span>
<span id="cb264-8"><a href="NE.html#cb264-8" tabindex="-1"></a>           <span class="fl">0.5</span>,<span class="dv">0</span>,<span class="sc">-</span><span class="fl">0.5</span>,<span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb264-9"><a href="NE.html#cb264-9" tabindex="-1"></a>           <span class="fl">0.1</span>,<span class="fl">0.28</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.75</span>)</span>
<span id="cb264-10"><a href="NE.html#cb264-10" tabindex="-1"></a><span class="fu">names</span>(param) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;barmu&quot;</span>,<span class="st">&quot;sigma2mu&quot;</span>,<span class="st">&quot;sigma2U&quot;</span>,<span class="st">&quot;barY&quot;</span>,<span class="st">&quot;rho&quot;</span>,</span>
<span id="cb264-11"><a href="NE.html#cb264-11" tabindex="-1"></a>                  <span class="st">&quot;theta1&quot;</span>,<span class="st">&quot;theta2&quot;</span>,<span class="st">&quot;theta3&quot;</span>,<span class="st">&quot;theta4&quot;</span>,</span>
<span id="cb264-12"><a href="NE.html#cb264-12" tabindex="-1"></a>                  <span class="st">&quot;sigma2epsilon&quot;</span>,<span class="st">&quot;sigma2eta&quot;</span>,</span>
<span id="cb264-13"><a href="NE.html#cb264-13" tabindex="-1"></a>                  <span class="st">&quot;delta1&quot;</span>,<span class="st">&quot;delta2&quot;</span>,<span class="st">&quot;delta3&quot;</span>,<span class="st">&quot;delta4&quot;</span>,</span>
<span id="cb264-14"><a href="NE.html#cb264-14" tabindex="-1"></a>                  <span class="st">&quot;baralpha1&quot;</span>,<span class="st">&quot;baralpha2&quot;</span>,<span class="st">&quot;baralpha3&quot;</span>,<span class="st">&quot;baralpha4&quot;</span>,</span>
<span id="cb264-15"><a href="NE.html#cb264-15" tabindex="-1"></a>                  <span class="st">&quot;barchi1&quot;</span>,<span class="st">&quot;barchi2&quot;</span>,<span class="st">&quot;barchi3&quot;</span>,<span class="st">&quot;barchi4&quot;</span>,</span>
<span id="cb264-16"><a href="NE.html#cb264-16" tabindex="-1"></a>                  <span class="st">&quot;kappa1&quot;</span>,<span class="st">&quot;kappa2&quot;</span>,<span class="st">&quot;kappa3&quot;</span>,<span class="st">&quot;kappa4&quot;</span>,</span>
<span id="cb264-17"><a href="NE.html#cb264-17" tabindex="-1"></a>                  <span class="st">&quot;xi1&quot;</span>,<span class="st">&quot;xi2&quot;</span>,<span class="st">&quot;xi3&quot;</span>,<span class="st">&quot;xi4&quot;</span>,</span>
<span id="cb264-18"><a href="NE.html#cb264-18" tabindex="-1"></a>                  <span class="st">&quot;gamma&quot;</span>,<span class="st">&quot;sigma2omega&quot;</span>,<span class="st">&quot;rhoetaomega&quot;</span>,<span class="st">&quot;sigma2nu&quot;</span>,<span class="st">&quot;iota&quot;</span>)</span></code></pre></div>
<p>Let us now generate the corresponding data (in long format):</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="NE.html#cb265-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb265-2"><a href="NE.html#cb265-2" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb265-3"><a href="NE.html#cb265-3" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb265-4"><a href="NE.html#cb265-4" tabindex="-1"></a>cov.eta.omega <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(param[<span class="st">&quot;sigma2eta&quot;</span>],param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;rhoetaomega&quot;</span>]<span class="sc">*</span><span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2eta&quot;</span>]<span class="sc">*</span>param[<span class="st">&quot;sigma2omega&quot;</span>]),param[<span class="st">&quot;sigma2omega&quot;</span>]),<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>)</span>
<span id="cb265-5"><a href="NE.html#cb265-5" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">mvrnorm</span>(N<span class="sc">*</span>T,<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),cov.eta.omega))</span>
<span id="cb265-6"><a href="NE.html#cb265-6" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;eta&#39;</span>,<span class="st">&#39;omega&#39;</span>)</span>
<span id="cb265-7"><a href="NE.html#cb265-7" tabindex="-1"></a><span class="co"># time and individual identifiers</span></span>
<span id="cb265-8"><a href="NE.html#cb265-8" tabindex="-1"></a>data<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>,N),<span class="fu">rep</span>(<span class="dv">2</span>,N),<span class="fu">rep</span>(<span class="dv">3</span>,N),<span class="fu">rep</span>(<span class="dv">4</span>,N))</span>
<span id="cb265-9"><a href="NE.html#cb265-9" tabindex="-1"></a>data<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">rep</span>((<span class="dv">1</span><span class="sc">:</span>N),T)</span>
<span id="cb265-10"><a href="NE.html#cb265-10" tabindex="-1"></a><span class="co"># unit fixed effects</span></span>
<span id="cb265-11"><a href="NE.html#cb265-11" tabindex="-1"></a>data<span class="sc">$</span>mu <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">rnorm</span>(N,param[<span class="st">&quot;barmu&quot;</span>],<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2mu&quot;</span>])),T)</span>
<span id="cb265-12"><a href="NE.html#cb265-12" tabindex="-1"></a><span class="co"># time fixed effects</span></span>
<span id="cb265-13"><a href="NE.html#cb265-13" tabindex="-1"></a>data<span class="sc">$</span>delta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(param[<span class="st">&quot;delta1&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta2&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta3&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;delta4&quot;</span>],N))</span>
<span id="cb265-14"><a href="NE.html#cb265-14" tabindex="-1"></a>data<span class="sc">$</span>baralphat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(param[<span class="st">&quot;baralpha1&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha2&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha3&quot;</span>],N),<span class="fu">rep</span>(param[<span class="st">&quot;baralpha4&quot;</span>],N))</span>
<span id="cb265-15"><a href="NE.html#cb265-15" tabindex="-1"></a></span>
<span id="cb265-16"><a href="NE.html#cb265-16" tabindex="-1"></a><span class="co"># building autocorrelated error terms</span></span>
<span id="cb265-17"><a href="NE.html#cb265-17" tabindex="-1"></a>data<span class="sc">$</span>epsilon <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N<span class="sc">*</span>T,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2epsilon&quot;</span>]))</span>
<span id="cb265-18"><a href="NE.html#cb265-18" tabindex="-1"></a>data<span class="sc">$</span>U[<span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fu">sqrt</span>(param[<span class="st">&quot;sigma2U&quot;</span>]))</span>
<span id="cb265-19"><a href="NE.html#cb265-19" tabindex="-1"></a>data<span class="sc">$</span>U[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)]</span>
<span id="cb265-20"><a href="NE.html#cb265-20" tabindex="-1"></a>data<span class="sc">$</span>U[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)]</span>
<span id="cb265-21"><a href="NE.html#cb265-21" tabindex="-1"></a>data<span class="sc">$</span>U[(<span class="dv">3</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">*</span>N)] <span class="ot">&lt;-</span> param[<span class="st">&quot;rho&quot;</span>]<span class="sc">*</span>data<span class="sc">$</span>U[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)] <span class="sc">+</span> data<span class="sc">$</span>epsilon[(<span class="dv">3</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">*</span>N)]</span>
<span id="cb265-22"><a href="NE.html#cb265-22" tabindex="-1"></a><span class="co"># potential outcomes in the absence of the treatment</span></span>
<span id="cb265-23"><a href="NE.html#cb265-23" tabindex="-1"></a>data<span class="sc">$</span>y0 <span class="ot">&lt;-</span> data<span class="sc">$</span>mu <span class="sc">+</span> data<span class="sc">$</span>delta <span class="sc">+</span> data<span class="sc">$</span>U </span>
<span id="cb265-24"><a href="NE.html#cb265-24" tabindex="-1"></a>data<span class="sc">$</span>Y0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(data<span class="sc">$</span>y0)</span>
<span id="cb265-25"><a href="NE.html#cb265-25" tabindex="-1"></a><span class="co"># treatment timing</span></span>
<span id="cb265-26"><a href="NE.html#cb265-26" tabindex="-1"></a><span class="co"># error term</span></span>
<span id="cb265-27"><a href="NE.html#cb265-27" tabindex="-1"></a>data<span class="sc">$</span>V <span class="ot">&lt;-</span> param[<span class="st">&quot;gamma&quot;</span>]<span class="sc">*</span>(data<span class="sc">$</span>mu<span class="sc">-</span>param[<span class="st">&quot;barmu&quot;</span>])<span class="sc">+</span>data<span class="sc">$</span>omega</span>
<span id="cb265-28"><a href="NE.html#cb265-28" tabindex="-1"></a><span class="co"># treatment group, with 99 for the never treated instead of infinity</span></span>
<span id="cb265-29"><a href="NE.html#cb265-29" tabindex="-1"></a>Ds <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi1&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">1</span>,</span>
<span id="cb265-30"><a href="NE.html#cb265-30" tabindex="-1"></a>              <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi2&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">2</span>,</span>
<span id="cb265-31"><a href="NE.html#cb265-31" tabindex="-1"></a>                      <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi3&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">3</span>,</span>
<span id="cb265-32"><a href="NE.html#cb265-32" tabindex="-1"></a>                              <span class="fu">if_else</span>(data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">+</span>param[<span class="st">&quot;xi4&quot;</span>]<span class="sc">+</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">&lt;=</span><span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>]),<span class="dv">4</span>,<span class="dv">99</span>))))</span>
<span id="cb265-33"><a href="NE.html#cb265-33" tabindex="-1"></a>data<span class="sc">$</span>Ds <span class="ot">&lt;-</span> <span class="fu">rep</span>(Ds,T)</span>
<span id="cb265-34"><a href="NE.html#cb265-34" tabindex="-1"></a><span class="co"># Treatment status</span></span>
<span id="cb265-35"><a href="NE.html#cb265-35" tabindex="-1"></a>data<span class="sc">$</span>D <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">&gt;</span>data<span class="sc">$</span>time,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb265-36"><a href="NE.html#cb265-36" tabindex="-1"></a><span class="co"># Treatment intensity</span></span>
<span id="cb265-37"><a href="NE.html#cb265-37" tabindex="-1"></a>data<span class="sc">$</span>I[<span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">-</span>param[<span class="st">&quot;xi1&quot;</span>]<span class="sc">-</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">-</span>param[<span class="st">&quot;iota&quot;</span>])<span class="sc">/</span>param[<span class="st">&quot;sigma2nu&quot;</span>])</span>
<span id="cb265-38"><a href="NE.html#cb265-38" tabindex="-1"></a>data<span class="sc">$</span>I[(N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>N)] <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">-</span>param[<span class="st">&quot;xi2&quot;</span>]<span class="sc">-</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">-</span>param[<span class="st">&quot;iota&quot;</span>])<span class="sc">/</span>param[<span class="st">&quot;sigma2nu&quot;</span>])</span>
<span id="cb265-39"><a href="NE.html#cb265-39" tabindex="-1"></a>data<span class="sc">$</span>I[(<span class="dv">2</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(<span class="dv">3</span><span class="sc">*</span>N)] <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">-</span>param[<span class="st">&quot;xi3&quot;</span>]<span class="sc">-</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">-</span>param[<span class="st">&quot;iota&quot;</span>])<span class="sc">/</span>param[<span class="st">&quot;sigma2nu&quot;</span>])</span>
<span id="cb265-40"><a href="NE.html#cb265-40" tabindex="-1"></a>data<span class="sc">$</span>I[(<span class="dv">3</span><span class="sc">*</span>N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(T<span class="sc">*</span>N)] <span class="ot">&lt;-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(param[<span class="st">&quot;barY&quot;</span>])<span class="sc">-</span>data<span class="sc">$</span>y0[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">-</span>param[<span class="st">&quot;xi4&quot;</span>]<span class="sc">-</span>data<span class="sc">$</span>V[<span class="dv">1</span><span class="sc">:</span>N]<span class="sc">-</span>param[<span class="st">&quot;iota&quot;</span>])<span class="sc">/</span>param[<span class="st">&quot;sigma2nu&quot;</span>])</span>
<span id="cb265-41"><a href="NE.html#cb265-41" tabindex="-1"></a><span class="co"># Treatment</span></span>
<span id="cb265-42"><a href="NE.html#cb265-42" tabindex="-1"></a>data<span class="sc">$</span>treatment <span class="ot">&lt;-</span> data<span class="sc">$</span>I<span class="sc">*</span>data<span class="sc">$</span>D</span>
<span id="cb265-43"><a href="NE.html#cb265-43" tabindex="-1"></a><span class="co"># potential outcomes with the treatment</span></span>
<span id="cb265-44"><a href="NE.html#cb265-44" tabindex="-1"></a><span class="co"># effect of the treatment by group</span></span>
<span id="cb265-45"><a href="NE.html#cb265-45" tabindex="-1"></a>data<span class="sc">$</span>baralphatd <span class="ot">&lt;-</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;barchi1&quot;</span>],</span>
<span id="cb265-46"><a href="NE.html#cb265-46" tabindex="-1"></a>                           <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;barchi2&quot;</span>],</span>
<span id="cb265-47"><a href="NE.html#cb265-47" tabindex="-1"></a>                                   <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;barchi3&quot;</span>],</span>
<span id="cb265-48"><a href="NE.html#cb265-48" tabindex="-1"></a>                                           <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">4</span>,param[<span class="st">&quot;barchi4&quot;</span>],<span class="dv">0</span>))))<span class="sc">+</span></span>
<span id="cb265-49"><a href="NE.html#cb265-49" tabindex="-1"></a>                  <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;kappa1&quot;</span>],</span>
<span id="cb265-50"><a href="NE.html#cb265-50" tabindex="-1"></a>                           <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;kappa2&quot;</span>],</span>
<span id="cb265-51"><a href="NE.html#cb265-51" tabindex="-1"></a>                                   <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;kappa3&quot;</span>],</span>
<span id="cb265-52"><a href="NE.html#cb265-52" tabindex="-1"></a>                                           <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">4</span>,param[<span class="st">&quot;kappa4&quot;</span>],<span class="dv">0</span>))))<span class="sc">*</span>(data<span class="sc">$</span>time<span class="sc">-</span>data<span class="sc">$</span>Ds)<span class="sc">*</span><span class="fu">if_else</span>(data<span class="sc">$</span>time<span class="sc">&gt;=</span>data<span class="sc">$</span>Ds,<span class="dv">1</span>,<span class="dv">0</span>)</span>
<span id="cb265-53"><a href="NE.html#cb265-53" tabindex="-1"></a>data<span class="sc">$</span>y1 <span class="ot">&lt;-</span> data<span class="sc">$</span>y0 <span class="sc">+</span> (data<span class="sc">$</span>baralphat <span class="sc">+</span> data<span class="sc">$</span>baralphatd <span class="sc">+</span> <span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">1</span>,param[<span class="st">&quot;theta1&quot;</span>],<span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">2</span>,param[<span class="st">&quot;theta2&quot;</span>],<span class="fu">if_else</span>(data<span class="sc">$</span>Ds<span class="sc">==</span><span class="dv">3</span>,param[<span class="st">&quot;theta3&quot;</span>],param[<span class="st">&quot;theta4&quot;</span>])))<span class="sc">*</span>data<span class="sc">$</span>mu)<span class="sc">*</span>data<span class="sc">$</span>I <span class="sc">+</span> data<span class="sc">$</span>eta</span>
<span id="cb265-54"><a href="NE.html#cb265-54" tabindex="-1"></a>data<span class="sc">$</span>Y1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(data<span class="sc">$</span>y1)</span>
<span id="cb265-55"><a href="NE.html#cb265-55" tabindex="-1"></a>data<span class="sc">$</span>y <span class="ot">&lt;-</span> data<span class="sc">$</span>y1<span class="sc">*</span>data<span class="sc">$</span>D<span class="sc">+</span>data<span class="sc">$</span>y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>data<span class="sc">$</span>D)</span>
<span id="cb265-56"><a href="NE.html#cb265-56" tabindex="-1"></a>data<span class="sc">$</span>Y <span class="ot">&lt;-</span> data<span class="sc">$</span>Y1<span class="sc">*</span>data<span class="sc">$</span>D<span class="sc">+</span>data<span class="sc">$</span>Y0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>data<span class="sc">$</span>D)</span></code></pre></div>
<p>Let us now plot the data, especially the potential outcomes for each group and their average treatment intensity.</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="NE.html#cb266-1" tabindex="-1"></a>dataplotDIDStaggeredContinuous <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb266-2"><a href="NE.html#cb266-2" tabindex="-1"></a>                          <span class="fu">group_by</span>(Ds,time) <span class="sc">%&gt;%</span></span>
<span id="cb266-3"><a href="NE.html#cb266-3" tabindex="-1"></a>                          <span class="fu">summarize</span>(</span>
<span id="cb266-4"><a href="NE.html#cb266-4" tabindex="-1"></a>                            <span class="at">y1=</span><span class="fu">mean</span>(y1),</span>
<span id="cb266-5"><a href="NE.html#cb266-5" tabindex="-1"></a>                            <span class="at">y0=</span><span class="fu">mean</span>(y0),</span>
<span id="cb266-6"><a href="NE.html#cb266-6" tabindex="-1"></a>                            <span class="at">Intensity=</span><span class="fu">mean</span>(treatment)</span>
<span id="cb266-7"><a href="NE.html#cb266-7" tabindex="-1"></a>                          ) <span class="sc">%&gt;%</span></span>
<span id="cb266-8"><a href="NE.html#cb266-8" tabindex="-1"></a>                          <span class="fu">pivot_longer</span>(<span class="at">cols=</span><span class="fu">c</span>(<span class="st">&quot;y1&quot;</span>,<span class="st">&quot;y0&quot;</span>,<span class="st">&quot;Intensity&quot;</span>),<span class="at">values_to=</span><span class="st">&quot;Outcome&quot;</span>,<span class="at">names_to=</span><span class="st">&quot;PotentialOutcome&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb266-9"><a href="NE.html#cb266-9" tabindex="-1"></a>                          <span class="fu">mutate</span>(</span>
<span id="cb266-10"><a href="NE.html#cb266-10" tabindex="-1"></a>                            <span class="at">TreatmentDate =</span> <span class="fu">factor</span>(Ds,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;99&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;3&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;1&quot;</span>))</span>
<span id="cb266-11"><a href="NE.html#cb266-11" tabindex="-1"></a>                          )</span>
<span id="cb266-12"><a href="NE.html#cb266-12" tabindex="-1"></a></span>
<span id="cb266-13"><a href="NE.html#cb266-13" tabindex="-1"></a><span class="fu">ggplot</span>(dataplotDIDStaggeredContinuous <span class="sc">%&gt;%</span> <span class="fu">filter</span>(PotentialOutcome<span class="sc">!=</span><span class="st">&quot;Intensity&quot;</span>),<span class="fu">aes</span>(<span class="at">x=</span>time,<span class="at">y=</span>Outcome,<span class="at">color=</span>TreatmentDate,<span class="at">shape=</span>TreatmentDate,<span class="at">linetype=</span>PotentialOutcome))<span class="sc">+</span></span>
<span id="cb266-14"><a href="NE.html#cb266-14" tabindex="-1"></a>      <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb266-15"><a href="NE.html#cb266-15" tabindex="-1"></a>      <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb266-16"><a href="NE.html#cb266-16" tabindex="-1"></a><span class="co">#    scale_linetype_discrete(guide=&#39;none&#39;) +</span></span>
<span id="cb266-17"><a href="NE.html#cb266-17" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb266-18"><a href="NE.html#cb266-18" tabindex="-1"></a></span>
<span id="cb266-19"><a href="NE.html#cb266-19" tabindex="-1"></a><span class="fu">ggplot</span>(dataplotDIDStaggeredContinuous <span class="sc">%&gt;%</span> <span class="fu">filter</span>(PotentialOutcome<span class="sc">==</span><span class="st">&quot;Intensity&quot;</span>),<span class="fu">aes</span>(<span class="at">x=</span>time,<span class="at">y=</span>Outcome,<span class="at">color=</span>TreatmentDate,<span class="at">shape=</span>TreatmentDate,<span class="at">linetype=</span>TreatmentDate))<span class="sc">+</span></span>
<span id="cb266-20"><a href="NE.html#cb266-20" tabindex="-1"></a>      <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb266-21"><a href="NE.html#cb266-21" tabindex="-1"></a>      <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb266-22"><a href="NE.html#cb266-22" tabindex="-1"></a><span class="co">#    scale_linetype_discrete(guide=&#39;none&#39;) +</span></span>
<span id="cb266-23"><a href="NE.html#cb266-23" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredContinuous"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredContinuous-1.png" alt="Evolution of average outcomes and treatment intensity in the various treatment groups defined by their date of entry into the treatment" width="50%" /><img src="STCI_files/figure-html/PlotDIDStaggeredContinuous-2.png" alt="Evolution of average outcomes and treatment intensity in the various treatment groups defined by their date of entry into the treatment" width="50%" />
<p class="caption">
Figure 4.50: Evolution of average outcomes and treatment intensity in the various treatment groups defined by their date of entry into the treatment
</p>
</div>
<p>One final dimension of the data is how much treatment intensity varies across time and by cohort:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="NE.html#cb267-1" tabindex="-1"></a><span class="fu">ggplot</span>(data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(D<span class="sc">&gt;</span><span class="dv">0</span>),<span class="fu">aes</span>(<span class="at">x=</span>treatment,<span class="at">color=</span><span class="fu">as.factor</span>(Ds)))<span class="sc">+</span></span>
<span id="cb267-2"><a href="NE.html#cb267-2" tabindex="-1"></a>      <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb267-3"><a href="NE.html#cb267-3" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb267-4"><a href="NE.html#cb267-4" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;TreatmentIntensity&#39;</span>)<span class="sc">+</span></span>
<span id="cb267-5"><a href="NE.html#cb267-5" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name=</span><span class="st">&quot;TreatmentDate&quot;</span>)<span class="sc">+</span></span>
<span id="cb267-6"><a href="NE.html#cb267-6" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.<span class="sc">~</span>time)</span>
<span id="cb267-7"><a href="NE.html#cb267-7" tabindex="-1"></a></span>
<span id="cb267-8"><a href="NE.html#cb267-8" tabindex="-1"></a><span class="fu">ggplot</span>(data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(D<span class="sc">&gt;</span><span class="dv">0</span>,id<span class="sc">&lt;=</span><span class="dv">30</span>),<span class="fu">aes</span>(<span class="at">x=</span>time,<span class="at">y=</span>treatment,<span class="at">color=</span><span class="fu">as.factor</span>(id)))<span class="sc">+</span></span>
<span id="cb267-9"><a href="NE.html#cb267-9" tabindex="-1"></a>      <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb267-10"><a href="NE.html#cb267-10" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb267-11"><a href="NE.html#cb267-11" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;TreatmentIntensity&#39;</span>)</span>
<span id="cb267-12"><a href="NE.html#cb267-12" tabindex="-1"></a>  <span class="co">#scale_color_discrete(name=&quot;TreatmentDate&quot;)+</span></span>
<span id="cb267-13"><a href="NE.html#cb267-13" tabindex="-1"></a>  <span class="co">#facet_wrap(.~time)</span></span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredContinuousHist"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredContinuousHist-1.png" alt="Distribution of treatment intensity in the various treatment groups over time" width="50%" /><img src="STCI_files/figure-html/PlotDIDStaggeredContinuousHist-2.png" alt="Distribution of treatment intensity in the various treatment groups over time" width="50%" />
<p class="caption">
Figure 4.51: Distribution of treatment intensity in the various treatment groups over time
</p>
</div>
<p>As we can see on Figure <a href="NE.html#fig:PlotDIDStaggeredContinuousHist">4.51</a>, the model imposes that treatment intensity increases over time, which is compatible with Assumption <a href="NE.html#hyp:NoCrossing">4.39</a>.
In practice, <a href="https://ssrn.com/abstract=3731856">de Chaisemartin and d’Haultfoeuille</a> suggest to discard observation with crossing treatment intensities over time.</p>
<div id="estimation-using-de-chaisemartin-and-dhaultfoeuille-package" class="section level5 hasAnchor" number="4.3.5.2.1">
<h5><span class="header-section-number">4.3.5.2.1</span> Estimation using de Chaisemartin and d’Haultfoeuille package<a href="NE.html#estimation-using-de-chaisemartin-and-dhaultfoeuille-package" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Let us now try to use <a href="https://ssrn.com/abstract=3731856">de Chaisemartin and d’Haultfoeuille</a>’s <code>did_multiplegt_dyn</code> to estimate our treatment effects.</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="NE.html#cb268-1" tabindex="-1"></a>reg.Continuous.Staggered.DID <span class="ot">&lt;-</span> <span class="fu">did_multiplegt_dyn</span>(<span class="at">df=</span>data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Ds<span class="sc">&gt;</span><span class="dv">1</span>),<span class="at">outcome=</span><span class="st">&quot;y&quot;</span>,<span class="at">group=</span><span class="st">&quot;id&quot;</span>,<span class="at">time=</span><span class="st">&quot;time&quot;</span>,<span class="at">treatment=</span><span class="st">&quot;treatment&quot;</span>,<span class="at">effects=</span><span class="dv">3</span>,<span class="at">placebo=</span><span class="dv">2</span>,<span class="at">graph_off=</span><span class="cn">TRUE</span>)</span>
<span id="cb268-2"><a href="NE.html#cb268-2" tabindex="-1"></a>reg.Continuous.Staggered.DID.normalized <span class="ot">&lt;-</span> <span class="fu">did_multiplegt_dyn</span>(<span class="at">df=</span>data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Ds<span class="sc">&gt;</span><span class="dv">1</span>),<span class="at">outcome=</span><span class="st">&quot;y&quot;</span>,<span class="at">group=</span><span class="st">&quot;id&quot;</span>,<span class="at">time=</span><span class="st">&quot;time&quot;</span>,<span class="at">treatment=</span><span class="st">&quot;treatment&quot;</span>,<span class="at">effects=</span><span class="dv">3</span>,<span class="at">placebo=</span><span class="dv">2</span>,<span class="at">graph_off=</span><span class="cn">TRUE</span>,<span class="at">normalized=</span><span class="cn">TRUE</span>)</span></code></pre></div>
<p>We can now plot the result of the estimation of the non normalized and normalized coefficients:</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="NE.html#cb269-1" tabindex="-1"></a>reg.Continuous.Staggered.DID.normalized<span class="sc">$</span>plot</span>
<span id="cb269-2"><a href="NE.html#cb269-2" tabindex="-1"></a>reg.Continuous.Staggered.DID<span class="sc">$</span>plot</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:PlotDIDStaggeredContinuousEstdCdH"></span>
<img src="STCI_files/figure-html/PlotDIDStaggeredContinuousEstdCdH-1.png" alt="Estimated normalized and non-normalized treatment effects using de Chaisemartin and dHaultfoeuille estimator" width="50%" /><img src="STCI_files/figure-html/PlotDIDStaggeredContinuousEstdCdH-2.png" alt="Estimated normalized and non-normalized treatment effects using de Chaisemartin and dHaultfoeuille estimator" width="50%" />
<p class="caption">
Figure 4.52: Estimated normalized and non-normalized treatment effects using de Chaisemartin and dHaultfoeuille estimator
</p>
</div>
<div class="remark">
<p><span id="unlabeled-div-175" class="remark"><em>Remark</em>. </span>Note that the estimation procedure refuses to give more than one placebo estimate, whereas two are actually feasible with this dataset.</p>
</div>
</div>
<div id="estimation-using-a-grouped-stacked-first-difference-estimator" class="section level5 hasAnchor" number="4.3.5.2.2">
<h5><span class="header-section-number">4.3.5.2.2</span> Estimation using a grouped stacked first difference estimator<a href="NE.html#estimation-using-a-grouped-stacked-first-difference-estimator" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>An alternative approach would be to identify similar treatment trajectories and estimate the treatment effects separately for each of them.
One way to do that would be to use a stacked first difference estimator with groups.
One way to build the groups would be to use <span class="math inline">\(k\)</span>-means clustering to select sets of individuals that have very similar trajectories, enforcing for example that they have the same treatment date.</p>
</div>
</div>
<div id="estimation-of-sampling-noise-5" class="section level4 hasAnchor" number="4.3.5.3">
<h4><span class="header-section-number">4.3.5.3</span> Estimation of sampling noise<a href="NE.html#estimation-of-sampling-noise-5" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One final difficulty appears when estimating the precision of the <span class="math inline">\(DID_{g,l}\)</span> estimator used in Theorem <a href="NE.html#thm:IdentContinuousOne">4.36</a>.
If there is only one observation per treatment group <span class="math inline">\(g\)</span>, then it is impossible to estimate heteroskedasticity robust standard errors, since the residual of the treated observation is always going to be zero.
One way around this is to use the <strong>stacked first difference</strong> estimator with several observations per treatment group.
But this solution requires that we assume independence between the observations in the same treatment group, which we generally are not willing to do, especially when, like here, the treatment is clustered at the group level.
An alternative approach, explored by <a href="https://ssrn.com/abstract=3731856">de Chaisemartin and d’Haultfoeuille</a>, is to identify groups with similar values of the treatment dynamics, and to assume that they have very similar variances, and are mutually independent from each other.
This categorization of the treatment histories is simply a way to specify the shape of heteroskedasticity in the model.</p>
<div id="estimating-sampling-noise-using-de-chaisemartin-and-dhaultfoeuilles-approach" class="section level5 hasAnchor" number="4.3.5.3.1">
<h5><span class="header-section-number">4.3.5.3.1</span> Estimating sampling noise using de Chaisemartin and d’Haultfoeuille’s approach<a href="NE.html#estimating-sampling-noise-using-de-chaisemartin-and-dhaultfoeuilles-approach" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The key element in <a href="https://ssrn.com/abstract=3731856">de Chaisemartin and d’Haultfoeuille</a>’s approach to estimating sampling noise allowing for heteroskedasticity is to model heteroskedasticity as being a function of cohort membership.
They define cohorts as being the set of groups that start with the same initial treatment level, experience their first change in treatment intensity at the same time and in the same direction.
More formally, they index the set of cohorts by <span class="math inline">\(k\)</span>, where <span class="math inline">\(k\)</span> maps all the possible values of these three parameters:</p>

</div>
</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="RCT.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="OM.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/chabefer/STCI/blob/master/04_NE.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["STCI.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"toc_depth": 1
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
